var Wb={4242:(se,Ee,G)=>{G.d(Ee,{G1:()=>C,YR:()=>fe,y6:()=>F});var _=G(8796);/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var F=(ye=>(ye[ye.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",ye[ye.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",ye[ye.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",ye[ye.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED",ye))(F||{});function fe(ye){return!(ye.high>>>31)}const C=new _.R(4294967295,4294967295)},3206:(se,Ee,G)=>{G.d(Ee,{B0:()=>C,DN:()=>ye,DY:()=>J,Kk:()=>We,Uq:()=>Ie,W1:()=>R,XZ:()=>ne,_Y:()=>ze,aM:()=>q,no:()=>Be,ol:()=>ge,pz:()=>me,rG:()=>B,wP:()=>tt,ww:()=>Dt});var _=G(5716),F=G(2596),fe=G(4038);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class C{constructor(M){this.value_=M,this.changed=new fe.IY}get value(){return this.value_}set value(M){M!==this.value_&&(this.value_=M,this.changed.dispatch())}}class ye extends C{constructor(M,T,U=M){super(M),this.validator=T,this.defaultValue=U}toJSON(){const{value_:M}=this;if(M!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(M){if(M!==void 0){const{validator:T}=this;try{this.value=T(M);return}catch{}}this.value=this.defaultValue}}class Le extends F.O8{constructor(M,T){super(),this.changed=new fe.IY,this.f=M,this.ws=T;for(const U of T)this.registerDisposer(U.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(M=>M.value))}}function We($,...M){return new Le($,M)}class Ve extends F.O8{constructor(M,T){super(),this.changed=new fe.IY,this.valueGeneration=-1,this.f=M,this.ws=T;for(const U of T)this.registerDisposer(U.changed.add(this.changed.dispatch))}get value(){const M=this.changed.count;return M!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(T=>T.value)),this.valueGeneration=M),this.value_}}function ge($,...M){return new Ve($,M)}class me extends F.O8{constructor(M,T=(U,ee)=>U===ee){super(),this.changed=new fe.HN,this.value=M.value,this.registerDisposer(M.changed.add(()=>{const U=M.value;T(this.value,U)||(this.value=U,this.changed.dispatch())}))}}function Ie($,M,T){const U=new Le($,M),ee=new me(U,T);return ee.registerDisposer(U),ee}class tt extends F.O8{constructor(M){super(),this.changed=new fe.IY;const T=M(this),U=Object.keys(T),ee=()=>{const te=Array.isArray(T)?[]:{};for(const ve of U)te[ve]=T[ve].value;this.value=te,this.changed.dispatch()};ee();for(const te of U){const ve=T[te];this.registerDisposer(ve.changed.add(()=>ee()))}}}class Dt extends F.O8{constructor(M,...T){super(),this.f=M,this.changed=new fe.IY;for(const U of T)this.registerDisposer(U.add(this.changed.dispatch))}get value(){return this.f()}}class Ge extends F.O8{constructor(){super(...arguments),this.changed=new fe.IY}get value(){return this.value_}set value(M){const{value_:T}=this;if(this.value_=M,T!==void 0&&(T.dispose(),T.unregisterDisposer(this.valueHandler),this.valueHandler=void 0),M!==void 0){const U=this.valueHandler=()=>{this.value_===M&&(this.value_=void 0,this.changed.dispatch())};M.registerDisposer(U)}M!==T&&this.changed.dispatch()}reset(){this.value=void 0}disposed(){this.value_!==void 0&&(this.value_.unregisterDisposer(this.valueHandler),this.value_.dispose()),this.value_=void 0,super.disposed()}}class It extends Ge{constructor(M,T){super(),this.validator=M,this.jsonConverter=T}toJSON(){const{value:M}=this;return M&&this.jsonConverter(M)}restoreState(M){this.value=this.validator(M)}}class ze{constructor(M){this.changed=new fe.HN,M===void 0?this.values=new Set:this.values=new Set(M)}add(M){const{values:T}=this;return T.has(M)||(T.add(M),this.changed.dispatch(M,!0)),this}delete(M){const{values:T}=this;return T.delete(M)?(this.changed.dispatch(M,!1),!0):!1}has(M){return this.values.has(M)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){const{values:M}=this;M.size>0&&(M.clear(),this.changed.dispatch(null,!1))}}function Be($,...M){const T=M.map(Xe=>Xe.value),U=M.length;let ee=new F.O8,te=$(ee,...T);const ve=(0,_.A)(()=>{let Xe=!1;for(let He=0;He<U;++He){const Qt=M[He].value;T[He]!==Qt&&(T[He]=Qt,Xe=!0)}Xe&&(ee.dispose(),ee=new F.O8,te=$(ee,...T))},0),qe=M.map(Xe=>Xe.changed.add(ve));return{flush(){ve.flush()},dispose(){ve.cancel(),(0,F.$F)(qe),ee.dispose()},get value(){return ve.flush(),te}}}function q($,...M){const T=M.map(Xe=>Xe.value),U=M.length;let ee=new F.O8,te=$(ee,...T);const ve=()=>{let Xe=!1;for(let He=0;He<U;++He){const Qt=M[He].value;T[He]!==Qt&&(T[He]=Qt,Xe=!0)}Xe&&(ee.dispose(),ee=new F.O8,te=$(ee,...T))},qe=M.map(Xe=>Xe.changed.add(ve));return{dispose(){(0,F.$F)(qe),ee.dispose()},get value(){return te}}}function ne($){return{changed:fe.$$,value:$}}function R($,M){return $(M.value),M.changed.add(()=>$(M.value))}function ae($,M){return M.value=$.value,$.changed.add(()=>{M.value=$.value})}class B{constructor(M,T){this.outer=M,this.getInner=T,this.changed=new fe.IY,this.update=()=>{const{disposer:U,outer:ee}=this;U!==void 0&&U();const te=this.inner=this.getInner(ee.value);this.disposer=te.changed.add(this.changed.dispatch),this.changed.dispatch()},M.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(M){this.inner.value=M}}class J extends B{reset(){this.inner.reset()}restoreState(M){this.inner.restoreState(M)}toJSON(){return this.inner.toJSON()}}},4037:(se,Ee,G)=>{G.d(Ee,{CS:()=>Le,El:()=>We,Lp:()=>Ve,NT:()=>ae,RO:()=>Be,U8:()=>F,ak:()=>R,b8:()=>ze,eL:()=>q,eN:()=>me,ep:()=>Ge,jx:()=>fe,lX:()=>ge,r1:()=>tt,wm:()=>Dt});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _(B,J,$,M){for(;J<$;){const T=B[J];if(M(T)){++J;continue}--$,B[J]=B[$],B[$]=T}return $}function F(B,J){const $=B.length;let M=0;for(let T=0;T<$;++T)J(B[T],T,B)&&(B[M]=B[T],++M);B.length=M}function fe(B,J){if(B.length===J)return B;const $=new B.constructor(J);return $.set(B),$}function C(B,J=1){const $=B.length,M=new Array($);let T=M[0]=J;for(let U=1;U<$;++U)T*=B[U-1],M[U]=T;return M}function ye(B,J,$){const M=new B.constructor(B.length);for(let T=0;T<J*$;T+=$)for(let U=0;U<$;U++){const ee=T/$;M[U*J+ee]=B[T+U]}return M}function Le(B,J,$,M){const T=B.length/J,U=B.length*$*M,ee=new B.constructor(U),te=B.length*M,ve=J,qe=J*M;for(let Xe=0;Xe<T;++Xe)for(let He=0;He<J;++He){const Vn=B[Xe*J+He],Qt=Xe*qe+He;for(let ii=0;ii<$;++ii)for(let f=0;f<M;++f)ee[ii*te+f*ve+Qt]=Vn}return ee}function We(B,J,$,M=0,T=B.length){for(;M<T;){const U=M+T-1>>1,ee=$(J,B[U]);if(ee>0)M=U+1;else if(ee<0)T=U;else return U}return~M}function Ve(B,J,$,M=0,T=B.length){let U=-1,ee=1/0;for(;M<T;){const te=M+T-1>>1,ve=$(J,B[te]);if(ve>0)M=te+1;else if(ve<0)T=te;else return te;const qe=Math.abs(ve);qe<ee&&(ee=qe,U=te)}return U}function ge(B,J,$){let M=J-B;for(;M>0;){const T=Math.floor(M/2),U=B+T;$(U)?M=T:(B=U+1,M-=T+1)}return B}function me(B,J){const $=[];for(let M=0,T=B.length;M<T;++M)B[M]===J&&$.push(M);return $}function Ie(B,J){const $=[];$.length=J;for(const M of B)$[M]=!0;return me($,void 0)}function tt(B,J){const $=B.length;if(J.length!==$)return!1;for(let M=0;M<$;++M)if(B[M]!==J[M])return!1;return!0}function Dt(B,J,$=(M,T)=>M===T){const M=B.length;if(J.length!==M)return!1;for(let T=0;T<M;++T)if(!$(B[T],J[T]))return!1;return!0}function Ge(B,J,$){const M=[];if($===J){for(let T=0;T<B;++T)M[T]=T;return M}M[$]=J;for(let T=0,U=0;T<B;){if(T===J){++T;continue}U===$&&++U,M[U++]=T++}return M}function It(B,J,$){for(let M=0,T=$.length;M<T;++M){const U=$[M];U!==-1&&(B[U]=J[M])}return B}function ze(B,J,$){for(let M=0,T=$.length;M<T;++M){const U=$[M];U!==-1&&(B[M]=J[U])}return B}function Be(B){const J=[];for(let $=0,M=B.length;$<M;++$){const T=B[$];for(let U=0,ee=T.length;U<ee;++U){let te=J[U];te===void 0&&(te=J[U]=[]),te.push(T[U])}}return J}function q(B,J){const $=[];let M=0;for(let U=0,ee=J.length;U<ee;++U){const{retainCount:te,deleteCount:ve,insertCount:qe}=J[U];te!==0&&($.push(B.slice(M,M+te)),M+=te),M+=ve,qe!==0&&$.push(new Array(qe))}const T=B.length;return M!==T&&$.push(B.slice(M)),new Array(0).concat(...$)}function ne(B,J,$){const M=[];let T=0,U=0;const ee=B.length,te=J.length;for(;T<ee&&U<te;){let ve;const qe=B[T],Xe=J[U];if(ve=$(qe,Xe),ve===0){let He=1;for(++T,++U;T<ee&&U<te&&(ve=$(B[T],J[U]))===0;)++He,++T,++U;M.push({retainCount:He,deleteCount:0,insertCount:0});continue}if(ve<0){let He=1;for(;++T<ee&&(ve=$(B[T],Xe))<0;)++He;M.push({retainCount:0,deleteCount:He,insertCount:0});continue}if(ve>0){let He=1;for(;++U<te&&(ve=$(qe,J[U]))>0;)++He;M.push({retainCount:0,deleteCount:0,insertCount:He})}}return(T<ee||U<te)&&M.push({retainCount:0,deleteCount:ee-T,insertCount:te-U}),M}function R(B,J,$){const M=[];let T=0,U=0;const ee=B.length,te=J.length;for(;T<ee;){let ve=0;for(;T<ee&&U<te&&$(B[T],J[U]);)++ve,++T,++U;ve!==0&&M.push({retainCount:ve,deleteCount:0,insertCount:0});let qe=0;for(;T<ee&&(U===te||!$(B[T],J[U]));)++qe,++T;qe!==0&&M.push({retainCount:0,deleteCount:qe,insertCount:0})}return U!==te&&M.push({retainCount:0,deleteCount:0,insertCount:te-U}),M}function ae(B,J,$,M,T,U){let ee=0,te=0;if(B!==0&&J!==0)for(;;){const ve=$(ee,te);if(ve<0){if(M(ee),++ee===B)break}else if(ve>0){if(T(te),++te===J)break}else if(U(ee,te),++ee,++te,ee===B||te===J)break}for(;ee<B;)M(ee),++ee;for(;te<J;)T(te),++te}},4509:(se,Ee,G)=>{G.d(Ee,{Dq:()=>fe,Qi:()=>Le,fx:()=>ye,gI:()=>Ve,wS:()=>F,y3:()=>We});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _ extends Error{constructor(){super(...arguments),this.name="CancellationError",this.message="CANCELED"}toString(){return"CANCELED"}}const F=new _;function fe(ge){if(ge.isCanceled===!0)throw F}const C=()=>{},ye={isCanceled:!1,add:()=>C,remove:C};class Le{cancel(){const{handlers:me}=this;if(me!==null&&(this.handlers=null,me!==void 0))for(const Ie of me)Ie()}get isCanceled(){return this.handlers===null}add(me){let{handlers:Ie}=this;return Ie===null?(me(),C):(Ie===void 0&&(Ie=this.handlers=new Set),Ie.add(me),()=>{this.remove(me)})}remove(me){const{handlers:Ie}=this;Ie?.delete(me)}}class We extends Le{constructor(){super(...arguments),this.consumers=new Set}addConsumer(me=ye){const{consumers:Ie}=this;Ie.has(me)||me.isCanceled||(Ie.add(me),me.add(()=>{Ie.delete(me),Ie.size===0&&this.cancel()}))}}function Ve(ge,me){return new Promise((Ie,tt)=>{if(ge===ye){me(Ie,tt,ye);return}const Dt=new Le,Ge=ge.add(()=>{Dt.cancel()});me(It=>{Ge(),Ie(It)},It=>{Ge(),tt(It)},Dt)})}},2596:(se,Ee,G)=>{G.d(Ee,{$F:()=>fe,K6:()=>C,K9:()=>We,O8:()=>ye,fL:()=>Le});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _=!1;function F(Ve){typeof Ve=="object"?Ve.dispose():Ve()}function fe(Ve){for(let ge=Ve.length;ge>0;--ge)F(Ve[ge-1])}function C(Ve,ge,me,Ie){return Ve.addEventListener(ge,me,Ie),()=>Ve.removeEventListener(ge,me,Ie)}class ye{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){_&&(this.disposedStacks=this.disposedStacks||[]).push(new Error().stack),--this.refCount===0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();const{disposers:ge}=this;ge!==void 0&&(fe(ge),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(ge){const{disposers:me}=this;return me==null?this.disposers=[ge]:me.push(ge),ge}unregisterDisposer(ge){const{disposers:me}=this;if(me!=null){const Ie=me.indexOf(ge);Ie!==-1&&me.splice(Ie,1)}return ge}registerEventListener(ge,me,Ie,tt){this.registerDisposer(C(ge,me,Ie,tt))}registerCancellable(ge){return this.registerDisposer(()=>{ge.cancel()}),ge}}class Le extends ye{constructor(ge){super(),this.value=ge}}function We(Ve){return()=>{if(Ve!==void 0){const ge=Ve;Ve=void 0,F(ge)}}}},3038:(se,Ee,G)=>{G.d(Ee,{I1:()=>Vn,Jh:()=>He,Oi:()=>Dt,PC:()=>qe,Qi:()=>ii,T2:()=>me,T_:()=>te,Yu:()=>C,Zc:()=>We,_A:()=>U,_S:()=>ee,_q:()=>T,bS:()=>cs,eR:()=>F,ln:()=>fe,nL:()=>q,p9:()=>ge,pB:()=>_,qp:()=>ve,r3:()=>Ve,sJ:()=>Qt,uD:()=>J,vs:()=>B,w0:()=>Le,xK:()=>ze,yb:()=>tt});var _=G(7684),F=G(329),fe=G(4796),C=G(2221),ye=G(4037),Le=G(1409),We=G(842);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ve=_.create(),ge=["x","y","z"],me=[F.fromValues(1,0,0),F.fromValues(0,1,0),F.fromValues(0,0,1)],Ie=F.fromValues(0,0,0),tt=fe.fromValues(0,0,0,0),Dt=F.fromValues(1,1,1),Ge=F.fromValues(1/0,1/0,1/0),It=C.create();function ze(W){return W[0]*W[1]*W[2]}function Be(W){return W[0]*W[1]*W[2]*W[3]}function q(W){return`${W[0]},${W[1]},${W[2]}`}function ne(W,K){const ue=K[0],P=K[1],he=K[2],re=K[3];W[0]=re,W[1]=he,W[2]=-P,W[3]=-ue}function R(W,K){const ue=K[0],P=K[1],he=K[2],re=K[3];W[0]=-he,W[1]=re,W[2]=ue,W[3]=-P}function ae(W,K){const ue=K[0],P=K[1],he=K[2],re=K[3];W[0]=P,W[1]=-ue,W[2]=re,W[3]=-he}function B(W,K,ue){const P=K[0],he=K[1],re=K[2];return W[0]=ue[0]*P+ue[4]*he+ue[8]*re,W[1]=ue[1]*P+ue[5]*he+ue[9]*re,W[2]=ue[2]*P+ue[6]*he+ue[10]*re,W}function J(W,K,ue){const P=K[0],he=K[1],re=K[2];return W[0]=ue[0]*P+ue[1]*he+ue[2]*re,W[1]=ue[4]*P+ue[5]*he+ue[6]*re,W[2]=ue[8]*P+ue[9]*he+ue[10]*re,W}function $(W,K,ue,P,he){const re=W;return W[0]=P[0],W[1]=P[1],W[2]=P[2]*he,mat4.fromRotationTranslationScale(W,ue,K,re)}function M(W,K,ue){const P=ue.length;let he=0;for(let de=0;de<P;++de)he+=(W[de]-K[de])**2;let re=0;for(let de=0;de<P;++de){const Pe=W[de];re-=(Pe-ue[de])*(K[de]-Pe)}return re/Math.max(he,1e-6)}function T(W,K,ue,P){const he=W.length;let re=M(K,ue,P);re=Math.max(0,Math.min(1,re));for(let de=0;de<he;++de){const Pe=K[de];W[de]=Pe+re*(ue[de]-Pe)}return W}function U(W,K){const ue=K[0],P=K[1],he=K[2],re=K[4],de=K[5],Pe=K[6],Ze=K[8],et=K[9],st=K[10];return W[0]=ue,W[1]=P,W[2]=he,W[3]=re,W[4]=de,W[5]=Pe,W[6]=Ze,W[7]=et,W[8]=st,W}function ee(W,K){const ue=K[0],P=K[1],he=K[2],re=K[3],de=K[4],Pe=K[5],Ze=K[6],et=K[7],st=K[8],rt=K[9],ht=K[10],Kt=K[11],Bn=K[12],qt=K[13],ds=K[14],Lt=K[15];W[0]=re+ue,W[1]=et+de,W[2]=Kt+st,W[3]=Lt+Bn,W[4]=re-ue,W[5]=et-de,W[6]=Kt-st,W[7]=Lt-Bn,W[8]=re+P,W[9]=et+Pe,W[10]=Kt+rt,W[11]=Lt+qt,W[12]=re-P,W[13]=et-Pe,W[14]=Kt-rt,W[15]=Lt-qt;const Ii=re+he,Bt=et+Ze,A=Kt+ht,H=Lt+ds,ie=re-he,le=et-Ze,Ce=Kt-ht,Te=Lt-ds,ot=Math.sqrt(Ii**2+Bt**2+A**2);W[16]=Ii/ot,W[17]=Bt/ot,W[18]=A/ot,W[19]=H/ot;const ut=Math.sqrt(ie**2+le**2+Ce**2);return W[20]=ie/ut,W[21]=le/ut,W[22]=Ce/ut,W[23]=Te/ut,W}function te(W,K,ue,P,he,re,de){for(let Pe=0;Pe<6;++Pe){const Ze=de[Pe*4],et=de[Pe*4+1],st=de[Pe*4+2],rt=de[Pe*4+3];if(Math.max(Ze*W,Ze*P)+Math.max(et*K,et*he)+Math.max(st*ue,st*re)+rt<0)return!1}return!0}function ve(W,K,ue,P,he,re,de){for(let Pe=0;Pe<4;++Pe){const Ze=de[Pe*4],et=de[Pe*4+1],st=de[Pe*4+2],rt=de[Pe*4+3];if(Math.max(Ze*W,Ze*P)+Math.max(et*K,et*he)+Math.max(st*ue,st*re)+rt<0)return!1}{const Ze=de[20],et=de[5*4+1],st=de[5*4+2],rt=de[5*4+3],ht=Math.max(Ze*W,Ze*P)+Math.max(et*K,et*he)+Math.max(st*ue,st*re),Kt=Math.min(Ze*W,Ze*P)+Math.min(et*K,et*he)+Math.min(st*ue,st*re),Bn=Math.abs(rt)*1e-6;if(Kt>-rt+Bn||ht<-rt-Bn)return!1}return!0}function qe(W,K,ue,P=!1){const he=ue.length,re=[],de=P?1:K+1,Pe=P?K+1:1;for(let Ze=0;Ze<he;++Ze){const et=ue[Ze];for(let st=0;st<K;++st)W[st*de+et*Pe]!==0&&(re[st]=!0)}return(0,ye.eN)(re,!0)}function Xe(W,K,ue){for(let P=0;P<3;++P){const he=ue[P];for(let re=0;re<3;++re)W[re+P*3]=he*K[re+P*3]}return W}function He(W,K,ue){for(let P=0;P<3;++P){const he=ue[P];for(let re=0;re<3;++re)W[P+re*3]=he*K[P+re*3]}return W}function Vn(W){if(W[15]===1){const de=2/Math.abs(W[10]),Pe=2/Math.abs(W[0]),Ze=2/Math.abs(W[5]);return Pe*Ze*de}const K=W[10],P=2*W[14]/(2*K-2),he=(K-1)*P/(K+1);return 4/(W[0]*W[5])/3*(Math.abs(he)**3-Math.abs(P)**3)}function Qt(W){if(W[15]===1)return 2/Math.abs(W[10]);const K=W[10],P=2*W[14]/(2*K-2),he=(K-1)*P/(K+1);return Math.abs(he-P)}function ii(W){return W[2]=0,W[6]=0,W[10]=0,W[14]=0,W}const f=F.create();function cs(W,K){K[0]=K[1]=K[2]=Number.POSITIVE_INFINITY,K[3]=K[4]=K[5]=Number.NEGATIVE_INFINITY;for(let ue=0;ue<8;++ue){f[0]=2*(ue&1)-1,f[1]=2*(ue>>>1&1)-1,f[2]=2*(ue>>>2&1)-1,F.transformMat4(f,f,W);for(let P=0;P<3;++P){const he=f[P];K[P]=Math.min(K[P],he),K[P+3]=Math.max(K[P+3],he)}}}},8626:()=>{if(typeof NEUROGLANCER_GOOGLE_TAG_MANAGER<"u"){const se="dataLayer",Ee=NEUROGLANCER_GOOGLE_TAG_MANAGER;window[se]=window[se]||[],window[se].push({"gtm.start":new Date().getTime(),event:"gtm.js"});const G=document.createElement("script");G.async=!0,G.src=`https://www.googletagmanager.com/gtm.js?id=${Ee}`,document.head.appendChild(G)}},9808:(se,Ee,G)=>{G.d(Ee,{Bk:()=>Ie,Dl:()=>Ge,El:()=>It,JZ:()=>We,Rc:()=>ge,cj:()=>me,j$:()=>fe,vd:()=>Ve});var _=G(4509),F=G(8796);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fe extends Error{constructor(Be,q,ne,R){let ae=`Fetching ${JSON.stringify(Be)} resulted in HTTP error ${q}`;ne&&(ae+=`: ${ne}`),ae+=".",super(ae),this.name="HttpError",this.message=ae,this.url=Be,this.status=q,this.statusText=ne,R&&(this.response=R)}static fromResponse(Be){return new fe(Be.url,Be.status,Be.statusText,Be)}static fromRequestError(Be,q){if(q instanceof TypeError){let ne;return typeof Be=="string"?ne=Be:ne=Be.url,new fe(ne,0,"Network or CORS error")}return q}}const C=32,ye=500,Le=1e4;function We(ze){return Math.min(2**ze*ye,Le/2)*(1+Math.random())}async function Ve(ze,Be){for(let q=0;;){if(Be?.signal?.aborted)throw _.wS;let ne;try{ne=await fetch(ze,Be)}catch(R){throw fe.fromRequestError(ze,R)}if(!ne.ok){const{status:R}=ne;if((R===429||R===503||R===504)&&++q!==C){await new Promise(ae=>setTimeout(ae,We(q-1)));continue}throw fe.fromResponse(ne)}return ne}}function ge(ze){return ze.arrayBuffer()}function me(ze){return ze.json()}async function Ie(ze,Be,q,ne=_.fx){if(ne===_.fx){const B=await Ve(ze,Be);return await q(B)}const R=new AbortController,ae=ne.add(()=>R.abort());try{const B=await Ve(ze,{...Be,signal:R.signal});return await q(B)}finally{ae()}}const tt=new F.R;function Dt(ze,Be){let q;return typeof Be=="number"?q=`${Be-1}`:(Uint64.decrement(tt,Be),q=tt.toString()),{Range:`bytes=${ze}-${q}`}}function Ge(ze){const Be=/^([^:/]+):\/\/([^/]+)((?:\/.*)?)$/,q=ze.match(Be);if(q===null)throw new Error(`Invalid URL: ${JSON.stringify(ze)}`);return{protocol:q[1],host:q[2],path:q[3]}}function It(ze){return ze instanceof fe?ze.status===0||ze.status===403||ze.status===404:!1}},7900:(se,Ee,G)=>{G.d(Ee,{$v:()=>ve,B8:()=>Qt,DW:()=>We,J6:()=>te,JB:()=>me,JY:()=>Le,MM:()=>he,Mo:()=>ye,Rf:()=>Xe,Sf:()=>T,VH:()=>Bn,Vr:()=>Ve,We:()=>Vn,Xu:()=>qe,ZD:()=>Bt,Zu:()=>Lt,Zw:()=>C,_D:()=>F,aO:()=>ds,bL:()=>Pe,bX:()=>He,by:()=>rt,cQ:()=>P,f4:()=>st,gG:()=>ht,j3:()=>ii,pf:()=>qt,qi:()=>Ii,si:()=>Kt,sl:()=>et,uS:()=>K,uz:()=>Ze,vS:()=>re,vp:()=>ge,xU:()=>de,z$:()=>cs,zB:()=>W,zo:()=>fe,zr:()=>f});var _=G(3038);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function F(A){const H=typeof A;if(H==="number"||H==="string"){const ie=parseFloat(""+A);if(!Number.isNaN(ie))return ie}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(A)}.`)}function fe(A){const H=F(A);if(Number.isFinite(H))return H;throw new Error(`Expected finite floating-point number, but received: ${H}.`)}function C(A){const H=F(A);if(Number.isFinite(H)&&H>=0)return H;throw new Error(`Expected finite non-negative floating-point number, but received: ${H}.`)}function ye(A){const H=fe(A);if(H>0)return H;throw new Error(`Expected positive finite floating-point number, but received: ${H}.`)}function Le(A,H){return ie=>{const le=F(ie);if(le>=A&&le<=H)return le;throw new Error(`Expected floating-point number in range [${A}, ${H}], but received: ${le}.`)}}function We(A,H,ie=F){Xe(H),A[0]=A[1]=A[2]=0;for(const le of Object.keys(H))switch(le){case"x":A[0]=ie(H[le]);break;case"y":A[1]=ie(H[le]);break;case"z":A[2]=ie(H[le]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(H)}.`)}return A}function Ve(A,H){const ie=A.length;if(!Array.isArray(H)||H.length!==ie)throw new Error("Incompatible sizes");for(let le=0;le<ie;++le)if(!Number.isFinite(parseFloat(H[le])))throw new Error("Non-finite value.");for(let le=0;le<ie;++le)A[le]=parseFloat(H[le]);return A}function ge(A,H){const ie=A.length;if(!Array.isArray(H)||H.length!==ie)throw new Error("Incompatible sizes.");for(let le=0;le<ie;++le){const Ce=parseInt(H[le],void 0);if(!Number.isInteger(Ce))throw new Error("Non-integer value.")}for(let le=0;le<ie;++le)A[le]=parseInt(H[le],void 0);return A}function me(A){if(typeof A=="object"){if(A===null)return"null";if(Array.isArray(A)){let Te="[";const ot=A.length;let ut=0;if(ut<ot)for(Te+=me(A[ut]);++ut<ot;)Te+=",",Te+=me(A[ut]);return Te+="]",Te}let H="{";const ie=Object.keys(A).sort();let le=0;const Ce=ie.length;if(le<Ce){let Te=ie[le];for(H+=JSON.stringify(Te),H+=":",H+=me(A[Te]);++le<Ce;)H+=",",Te=ie[le],H+=JSON.stringify(Te),H+=":",H+=me(A[Te])}return H+="}",H}return JSON.stringify(A)}function Ie(A){return A.replace(/['"]/g,H=>H==='"'?"'":'"')}function tt(A){return Ie(JSON.stringify(Ie(A)))}const Dt="_";function Ge(A){if(typeof A=="object"){if(A===null)return"null";const H=A.toJSON;if(typeof H=="function")return Ge(H.call(A));if(Array.isArray(A)){let Te="[";const ot=A.length;let ut=0;if(ut<ot)for(Te+=Ge(A[ut]);++ut<ot;)Te+=Dt,Te+=Ge(A[ut]);return Te+="]",Te}let ie="{";const le=Object.keys(A);let Ce=!0;for(const Te of le){const ot=A[Te];if(ot===void 0)continue;const ut=Ge(ot);ut&&(Ce?Ce=!1:ie+=Dt,ie+=tt(Te),ie+=":",ie+=ut)}return ie+="}",ie}return typeof A=="string"?tt(A):JSON.stringify(A)}const It=/('(?:[^'\\]|(?:\\.))*')/,ze=/("(?:[^"\\]|(?:\\.))*")/,Be=new RegExp(`${It.source}|${ze.source}`),q=new RegExp(`${ze.source}|${It.source}`),ne=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,R=/^((?:[^"'\\]|(?:\\.))*)'/;function ae(A,H,ie,le){if(A.length>=2&&A.charAt(0)===H&&A.charAt(A.length-1)===H){let Ce=A.substr(1,A.length-2),Te=ie;for(;Ce.length>0;){const ot=Ce.match(le);if(ot===null){Te+=Ce;break}Te+=ot[1],ot[2]===ie?(Te+="\\",Te+=ie):Te+=H,Ce=Ce.substr(ot.index+ot[0].length)}return Te+=ie,Te}return A}function B(A){return ae(A,"'",'"',ne)}function J(A,H,ie){const le=/[&_,]/g;let Ce,Te,ot;ie==='"'?(Ce="'",Te=ne,ot=Be):(Ce='"',Te=R,ot=q);let ut="";for(;A.length>0;){const j=A.match(ot);let Li,Re;if(j===null)Li=A,A="",Re="";else{Li=A.substr(0,j.index),A=A.substr(j.index+j[0].length);const Xt=j[1];Xt!==void 0?Re=ae(Xt,Ce,ie,Te):Re=j[2]}ut+=Li.replace(le,H),ut+=Re}return ut}function $(A){return J(A,",",'"')}function M(A){return J(A,"_","'")}function T(A){return JSON.parse($(A))}function U(A){let H="";for(;A.length>0;){const ie=A.match(Be);let le,Ce;if(ie===null)le=A,A="",Ce="";else{le=A.substr(0,ie.index),A=A.substr(ie.index+ie[0].length);const Te=ie[1];Te!==void 0?Ce=B(Te):Ce=ie[2]}H+=le.replace(/\(/g,"[").replace(/\)/g,"]").replace("True","true").replace("False","false").replace(/,\s*([}\]])/g,"$1"),H+=Ce}return H}function ee(A){return JSON.parse(U(A))}function te(A,H){if(!Array.isArray(A))throw new Error(`Expected array, but received: ${JSON.stringify(A)}.`);if(H!==void 0&&A.length!==H)throw new Error(`Expected array of length ${H}, but received: ${JSON.stringify(A)}.`);return A}function ve(A,H){if(!Array.isArray(A))throw new Error(`Expected array, but received: ${JSON.stringify(A)}.`);return A.map(H)}function qe(A,H,ie){const le=A.length;if(!Array.isArray(H)||H.length!==le)throw new Error(`Expected length ${le} array, but received: ${JSON.stringify(H)}.`);for(let Ce=0;Ce<le;++Ce)A[Ce]=ie(H[Ce],Ce);return A}function Xe(A){if(typeof A!="object"||A==null||Array.isArray(A))throw new Error(`Expected JSON object, but received: ${JSON.stringify(A)}.`);return A}function He(A){const H=parseInt(A,10);if(!Number.isInteger(H))throw new Error(`Expected integer, but received: ${JSON.stringify(A)}.`);return H}function Vn(A){const H=He(A);if(H<=0)throw new Error(`Expected positive integer, but received: ${H}.`);return H}function Qt(A){const H=He(A);if(H<0)throw new Error(`Expected non-negative integer, but received: ${H}.`);return H}function ii(A,H){const ie=H.get(A);if(ie===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(H.keys()))}, but received: ${JSON.stringify(A)}.`);return ie}function f(A){if(typeof A!="string")throw new Error(`Expected string, but received: ${JSON.stringify(A)}.`);return A}function cs(A){if(A!==void 0)return f(A)}function W(A){if(A!==void 0)return He(A)}function K(A){if(A!==void 0){if(typeof A=="boolean")return A;if(A==="true")return!0;if(A==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(A)}`)}}function ue(A,H){return A===void 0?H:A}function P(A,H,ie){const le=Object.prototype.hasOwnProperty.call(A,H)?A[H]:void 0;try{return ie(le)}catch(Ce){throw new Error(`Error parsing ${JSON.stringify(H)} property: ${Ce.message}`)}}function he(A,H,ie,le){return P(A,H,Ce=>Ce===void 0?le:ie(Ce))}function re(A,H){Xe(A);const ie=new Map;for(const le of Object.keys(A))try{ie.set(le,H(A[le]))}catch(Ce){throw new Error(`Error parsing value associated with key ${JSON.stringify(le)}: ${Ce.message}`)}return ie}function de(A){if(typeof A!="number"||!Number.isFinite(A)||A<0||A>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(A)}.`);return A}function Pe(A){if(A==="")return{};if(A.startsWith("{"))return T(A);const H={},ie=A.split(/[&;]/);for(const le of ie){const Ce=le.match(/^([^=&;]+)=([^&;]*)$/);if(Ce===null)throw new Error(`Invalid query string part: ${JSON.stringify(le)}.`);H[Ce[1]]=decodeURIComponent(Ce[2])}return H}function Ze(A){if(A===void 0)return"";const H=Object.keys(A);return H.length===0?"":H.some(ie=>typeof A[ie]!="string")?JSON.stringify(A):H.map(ie=>`${encodeURIComponent(ie)}=${encodeURIComponent(A[ie])}`).join("&")}function et(A,H,ie=/^[a-zA-Z]/){if(typeof A=="string"&&A.match(ie)!==null){const le=A.toUpperCase();if(Object.prototype.hasOwnProperty.call(H,le))return H[le]}throw new Error(`Invalid enum value: ${JSON.stringify(A)}.`)}function st(A){return qe(_.eR.create(),A,fe)}function rt(A){return qe(_.eR.create(),A,ye)}function ht(A){return qe(_.eR.create(),A,Vn)}function Kt(A){if(!Array.isArray(A))throw new Error(`Expected array, received: ${JSON.stringify(A)}.`);for(const H of A)if(typeof H!="string")throw new Error(`Expected string, received: ${JSON.stringify(H)}.`);return A}function Bn(A){if(!Array.isArray(A))throw new Error(`Expected array, received: ${JSON.stringify(A)}.`);for(const H of A)if(!Number.isInteger(H))throw new Error(`Expected integer, received: ${JSON.stringify(H)}.`);return A}function qt(A){if(!Array.isArray(A))throw new Error(`Expected array, received: ${JSON.stringify(A)}.`);for(const H of A)F(H);return A}function ds(A){if(typeof A!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(A)}`);return A}function Lt(A){for(const H in A)return A}function Ii(A,H){if(A!==H)throw new Error(`Expected ${JSON.stringify(H)}, but received: ${JSON.stringify(A)}`);return H}function Bt(A,H){if(A===void 0){const ie=new Array(H);return ie.fill(null),ie}return qe(new Array(H),A,ie=>{if(ie!==null&&typeof ie!="string")throw new Error(`Expected string or null, but received: ${JSON.stringify(name)}`);return ie})}},147:(se,Ee,G)=>{G.d(Ee,{Aw:()=>Ve,C:()=>We,DA:()=>fe,DI:()=>Ie,LC:()=>tt,Lk:()=>Le,_U:()=>It,ay:()=>ze,lw:()=>_,nx:()=>C,u6:()=>ye,vo:()=>Ge});/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _(q,ne,R,ae,B,J,$,M,T){for(let U=0;U<$;++U)for(let ee=0;ee<T;++ee){let te=0;for(let ve=0;ve<M;++ve)te+=R[U+ae*ve]*B[ve+J*ee];q[U+ne*ee]=te}return q}function F(q,ne,R){for(let ae=0;ae<R;++ae){const B=ne*ae;q.fill(0,B,B+R),q[B+ae]=1}return q}function fe(q,ne,R=ne){return F(new q(ne*R),ne,Math.min(ne,R))}function C(q,ne,R=!0){const ae=ne.length,B=R?ae+1:ae,J=new q(B*(ae+1));R&&(J[J.length-1]=1);for(let $=0;$<ae;++$)J[(B+1)*$]=ne[$];return J}function ye(q,ne,R=!0){const ae=ne.length,B=R?ae+1:ae,J=fe(q,B,ae+1);for(let $=0;$<ae;++$)J[B*ae+$]=ne[$];return J}function Le(q,ne,R){for(let ae=0;ae<R;++ae)for(let B=0;B<R;++B)if(q[ae*ne+B]!==(ae===B?1:0))return!1;return!0}function We(q,ne,R,ae,B,J){for(let $=0;$<J;++$){const M=$*ae,T=$*ne;for(let U=0;U<B;++U)q[T+U]=R[M+U]}return q}function Ve(q,ne,R,ae){We(q,ne+1,R,ae+1,ae,ae);for(let B=0;B<ae;++B)q[(ne+1)*ne+B]=R[(ae+1)*ae+B];q[q.length-1]=1;for(let B=ae;B<ne;++B)q[(ne+1)*B+B]=1;return q}let ge;function me(q,ne,R){let ae=1;(ge===void 0||ge.length<R)&&(ge=new Uint32Array(R));for(let B=0;B<R;++B)ge[B]=B;for(let B=0;B<R;++B){const J=ne*B;let $=B;{let U=Math.abs(q[J+B]);for(let ee=B+1;ee<R;++ee){const te=Math.abs(q[J+ee]);te>U&&(U=te,$=ee)}}if(B!==$){ae*=-1;for(let U=0;U<R;++U){const ee=ne*U,te=q[ee+B];q[ee+B]=q[ee+$],q[ee+$]=te}{const U=ge[B];ge[B]=ge[$],ge[$]=U}}const M=q[J+B],T=1/M;ae*=M;for(let U=0;U<R;++U)q[ne*U+B]*=T;q[J+B]=T;for(let U=0;U<R;++U){if(U===B)continue;const ee=-q[ne*B+U];for(let te=0;te<R;++te){const ve=ne*te;q[ve+U]+=ee*q[ve+B]}q[ne*B+U]=ee*T}}for(let B=0;B<R;++B){let J=ge[B];for(;J!==B;){const $=ne*B,M=ne*J;for(let U=0;U<R;++U){const ee=$+U,te=M+U,ve=q[ee];q[ee]=q[te],q[te]=ve}const T=ge[B]=ge[J];ge[J]=J,J=T}}return ae}function Ie(q,ne,R,ae,B){return We(q,ne,R,ae,B,B),me(q,ne,B)}function tt(q,ne,R,ae,B,J){for(let $=0;$<J;++$){const M=ne*$,T=ae*$;for(let U=0;U<B;++U)if(q[M+U]!==R[T+U])return!1}return!0}function Dt(q,ne,R,ae,B,J){for(let $=0;$<B;++$)for(let M=0;M<J;++M)q[M+$*ne]=R[$+M*ae];return q}function Ge(q,ne,R,ae,B){for(let J=0;J<B;++J){let $=ne[R*B+J];for(let M=0;M<B;++M)$+=ne[R*M+J]*ae[M];q[J]=$}return q}function It(q,ne,R,ae,B){for(let J=0;J<B;++J){let $=0;for(let M=0;M<B;++M)$+=ne[R*M+J]*ae[M];q[J]=$}return q}function ze(q,ne,R,ae,B,J){const $=B.length;for(let M=0;M<$;++M){const T=B[M];for(let U=0;U<J;++U)q[U*ne+M]=R[U*ae+T]}return q}function Be(q,ne,R,ae,B,J){const $=B.length;for(let M=0;M<$;++M){const T=B[M];for(let U=0;U<J;++U)q[M*ne+U]=R[T*ae+U]}return q}},4038:(se,Ee,G)=>{G.d(Ee,{$$:()=>C,HN:()=>_,IY:()=>fe});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _{constructor(){this.handlers=new Set,this.count=0;const Le=this;this.dispatch=function(){++Le.count,Le.handlers.forEach(We=>{We.apply(this,arguments)})}}add(Le){return this.handlers.add(Le),()=>this.remove(Le)}remove(Le){return this.handlers.delete(Le)}dispose(){this.handlers=void 0}}function F(ye,...Le){ye();for(let We=0,Ve=Le.length;We<Ve;++We)Le[We].add(ye);return()=>{for(let We=0,Ve=Le.length;We<Ve;++We)Le[We].remove(ye)}}class fe extends _{}const C={count:0,add(ye){return()=>{}},remove(ye){return!1}}},2974:(se,Ee,G)=>{se.exports=G.p+"bossauth.html"},3956:(se,Ee,G)=>{se.exports=G.p+"google_oauth2_redirect.html"},4320:(se,Ee,G)=>{var _=G(3206),F=G(4037),fe=G(8103),C=G(3038);/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ye(i){return("0"+i.toString(16)).slice(-2)}function Le(i){return Array.prototype.map.call(i,ye).join("")}function We(i){if(!/^(?:[0-9a-fA-F]{2})*$/.test(i))throw new Error("Invalid hex-encoded string");const e=i.length/2,t=new Uint8Array(e);for(let n=0;n<e;++n)t[n]=parseInt(i.substr(n*2,2),16);return t}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ve(i){const e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{const n=i.match(e);if(n!==null)return[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3],10),parseFloat(n[4])]}const t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{const n=i.match(t);if(n!==null)return[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(i)}.`)}function ge(i){try{if(typeof i!="string")throw new Error(`Expected string, but received ${JSON.stringify(i)}.`);const e=document.createElement("canvas").getContext("2d");e.fillStyle=i;const t=Ve(e.fillStyle);return C.ln.fromValues(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function me(i){return ge(i).subarray(0,3)}function Ie(i){const e=i[3]===void 0?3:4;let t=0;for(let n=0;n<e;n++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(i[e-1-n]*255)));return t}function tt(i){return C.eR.fromValues((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255)}function Dt(i){return C.ln.fromValues((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255,(i>>>24&255)/255)}function Ge(i){if(i[3]===void 0||i[3]===1){let t="#";for(let n=0;n<3;++n)t+=ye(Math.min(255,Math.max(0,Math.round(i[n]*255))));return t}let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(i[t]*255)));return e+=`, ${(0,fe.K)(i[3])})`,e}function It(i){return i<=.03928?i/12.92:((i+.055)/1.055)**2.4}function ze(i){const[e,t,n]=i;return .2126*It(e)+.7152*It(t)+.0722*It(n)}function Be(i){return ze(i)<=.179}class q extends _.B0{constructor(e){super(C.eR.clone(e)),this.defaultValue=e}toString(){return Ge(this.value)}toJSON(){if(!C.eR.equals(this.value,this.defaultValue))return Ge(this.value)}reset(){this.value=C.eR.clone(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}const{value:t}=this,n=me(e);C.eR.equals(t,n)||(this.value=n)}}class ne extends _.B0{constructor(){super(void 0)}toJSON(){const{value:e}=this;if(e!==void 0)return Ge(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}const{value:t}=this,n=me(e);(t===void 0||!C.eR.equals(t,n))&&(this.value=n)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var R=(i=>(i[i.UINT8=0]="UINT8",i[i.INT8=1]="INT8",i[i.UINT16=2]="UINT16",i[i.INT16=3]="INT16",i[i.UINT32=4]="UINT32",i[i.INT32=5]="INT32",i[i.UINT64=6]="UINT64",i[i.FLOAT32=7]="FLOAT32",i))(R||{});const ae={0:!1,1:!0,2:!1,3:!0,4:!1,5:!0,6:!1,7:void 0},B={0:1,1:1,2:2,3:2,4:4,5:4,6:8,7:4},J={0:Uint8Array,1:Int8Array,2:Uint16Array,3:Int16Array,4:Uint32Array,5:Int32Array,6:Uint32Array,7:Float32Array},$={0:1,1:1,2:1,3:1,4:1,5:1,6:2,7:1};function M(i,e,t=0,n=e.byteLength){const s=B[i],r=$[i];return new J[i](e,t,n/s*r)}var T=G(2596);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var U=(i=>(i[i.LITTLE=0]="LITTLE",i[i.BIG=1]="BIG",i))(U||{});function ee(){const i=Uint16Array.of(4386);return new Uint8Array(i.buffer)[0]===17?1:0}const te=ee();function ve(i){const e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);for(let t=0,n=e.length;t<n;t+=2){const s=e[t];e[t]=e[t+1],e[t+1]=s}}function qe(i){const e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);for(let t=0,n=e.length;t<n;t+=4){let s=e[t];e[t]=e[t+3],e[t+3]=s,s=e[t+1],e[t+1]=e[t+2],e[t+2]=s}}function Xe(i){const e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);for(let t=0,n=e.length;t<n;t+=8){let s=e[t];e[t]=e[t+7],e[t+7]=s,s=e[t+1],e[t+1]=e[t+6],e[t+6]=s,s=e[t+2],e[t+2]=e[t+5],e[t+5]=s,s=e[t+3],e[t+3]=e[t+4],e[t+4]=s}}function He(i,e,t=te){e!==t&&ve(i)}function Vn(i,e,t=te){e!==t&&qe(i)}function Qt(i,e,t=te){e!==t&&Xe(i)}function ii(i,e,t,n=te){if(!(e===n||t===1))switch(t){case 2:ve(i);break;case 4:qe(i);break;case 8:Xe(i);break}}var f=G(7900);/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cs=2**-1074,W=new Float64Array(1),K=new Uint32Array(W.buffer);function ue(i,e){if(Number.isNaN(i)||Number.isNaN(e))return NaN;if(i===e)return e;if(i===0)return e<0?-cs:cs;W[0]=i;const t=te===U.LITTLE?0:1,n=1-t;return e>i==i>0?K[t]===4294967295?(K[t]=0,K[n]+=1):K[t]+=1:K[t]===0?(K[t]=4294967295,K[n]-=1):K[t]-=1,W[0]}var P=G(8796);/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const he={[R.UINT8]:[0,255],[R.INT8]:[-128,127],[R.UINT16]:[0,65535],[R.INT16]:[-32768,32767],[R.UINT32]:[0,4294967295],[R.INT32]:[-2147483648,2147483647],[R.UINT64]:[P.R.ZERO,new P.R(4294967295,4294967295)],[R.FLOAT32]:[0,1]};function re(i,e){if(typeof e=="number"){const o=i[0],a=i[1];return(e-o)/(a-o)}const t=i[0],n=i[1];let s;P.R.compare(e,t)<0?s=-P.R.subtract(ht,t,e).toNumber():s=P.R.subtract(ht,e,t).toNumber();let r=P.R.absDifference(ht,n,t).toNumber();return P.R.compare(t,n)>0&&(r*=-1),s/r}function de(i,e,t){if(typeof i[0]=="number"){const a=i[0],l=i[1];let c=a*(1-t)+l*t;if(e!==R.FLOAT32){const d=he[e];c=Math.round(c),c=Math.max(d[0],c),c=Math.min(d[1],c)}return c}let n=i[0],s=i[1];P.R.compare(n,s)>0&&([n,s]=[s,n],t=1-t);const r=P.R.subtract(ht,s,n).toNumber(),o=new P.R;return t<=0?(ht.setFromNumber(r*-t),P.R.subtract(o,n,P.R.min(ht,n))):t>=1?(ht.setFromNumber(r*(t-1)),P.R.add(o,s,ht),P.R.less(o,s)&&(o.low=o.high=4294967295)):(ht.setFromNumber(r*t),P.R.add(o,n,ht),P.R.less(o,n)&&(o.low=o.high=4294967295)),o}function Pe(i,e){return typeof e=="number"?Math.min(Math.max(i[0],e),i[1]):P.R.min(P.R.max(i[0],e),i[1])}function Ze(i,e){return[Pe(i,e[0]),Pe(i,e[1])]}function et(i){if(rt(i[0],i[1])<=0)return i;throw new Error(`Invalid interval: [${i[0]}, ${i[1]}]`)}function st(i){return rt(i[0],i[1])<=0?i:[i[1],i[0]]}function rt(i,e){return typeof i=="number"?i-e:P.R.compare(i,e)}const ht=new P.R,Kt=new P.R;function Bn(i,e){return typeof e=="number"?Math.abs(e-i[0])<Math.abs(e-i[1])?0:1:P.R.less(P.R.absDifference(ht,i[0],e),P.R.absDifference(Kt,i[1],e))?0:1}function qt(i,e){let t;switch(typeof e!="string"?t=""+e:t=e,i){case R.UINT64:return P.R.parseString(t);case R.FLOAT32:{const n=parseFloat(t);if(!Number.isFinite(n))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return n}default:{const n=parseInt(t),s=he[i];if(!Number.isInteger(n)||n<s[0]||n>s[1])throw new Error(`Invalid ${R[i].toLowerCase()} value: ${JSON.stringify(t)}`);return n}}}function ds(i){if(typeof i=="number")return i;if(typeof i=="string"){const e=new P.R,t=Number(i);if(e.tryParseString(i))return t.toString()===e.toString()?t:e;if(!Number.isFinite(t))throw new Error(`Invalid value: ${JSON.stringify(i)}`);return t}throw new Error(`Invalid value: ${JSON.stringify(i)}`)}function Lt(i,e){return(0,f.Xu)(new Array(2),i,t=>qt(e,t))}function Ii(i){return(0,f.Xu)(new Array(2),i,e=>ds(e))}function Bt(i,e,t){return i===R.UINT64?P.R.equal(e[0],t[0])&&P.R.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function A(i,e,t=he[e]){if(!Bt(e,i,t))return e===R.UINT64?[i[0].toString(),i[1].toString()]:i}function H(i,e,t){switch(i){case R.FLOAT32:return ue(e,t*(1/0));case R.UINT64:{const n=e;return t===-1?n.low===0&&n.high===0?n:P.R.decrement(new P.R,n):n.low===4294967295&&n.high===4294967295?n:P.R.increment(new P.R,n)}default:{const n=he[i];return Math.max(n[0],Math.min(n[1],e+t))}}}function ie(i,e){switch(i){case R.FLOAT32:return 0;case R.UINT64:return .5/P.R.absDifference(ht,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function le(i,e){switch(i){case R.FLOAT32:return 1;case R.UINT64:{const t=P.R.absDifference(ht,e[0],e[1]).toNumber();return t/(t+1)}default:{const t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function Ce(i,e){if(i===void 0)return he[e];let[t,n]=i;if(e===R.UINT64)return typeof t=="number"&&(t=P.R.fromNumber(t)),typeof n=="number"&&(n=P.R.fromNumber(n)),[t,n];if(typeof t!="number"&&(t=t.toNumber()),typeof n!="number"&&(n=n.toNumber()),e!==R.FLOAT32){t=Math.round(t),n=Math.round(n);const s=he[e];Number.isFinite(t)?t=Math.min(Math.max(s[0],t),s[1]):t=s[0],Number.isFinite(n)?n=Math.min(Math.max(s[0],n),s[1]):n=s[1]}return[t,n]}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Te(i=128){const e=Math.ceil(i/32),t=new Uint32Array(e);crypto.getRandomValues(t);let n="";for(let s=0;s<e;++s)n+=("00000000"+t[s].toString(16)).slice(-8);return n}function ot(i){const e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength),t=65536;for(let n=0,s=e.length;n<s;n+=t)crypto.getRandomValues(e.subarray(n,Math.min(s,n+t)));return i}function ut(){const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]}var j=G(4038);/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Li extends T.O8{constructor(e){super(),this.id=e,this.changed=new j.IY}}var Re=(i=>(i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID",i))(Re||{});const Xt=[0,1,2,3],kl={float32:R.FLOAT32,uint32:R.UINT32,int32:R.INT32,uint16:R.UINT16,int16:R.INT16,uint8:R.UINT8,int8:R.INT8,rgb:void 0,rgba:void 0};function jb(i){return i.type!=="rgb"&&i.type!=="rgba"}function us(i){return i.type==="uint8"&&i.tag!==void 0}const si={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, true);dv.setUint8(${e} + 2, ${i} >>> 16);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(i){return Ie(me(i))},serializeJson(i){return Ge(tt(i))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, true);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, true);`},deserializeJson(i){return Ie(ge(i))},serializeJson(i){return Ge(Dt(i))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setFloat32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(i){return(0,f._D)(i)},serializeJson(i){return i}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(i){return(0,f.bX)(i)},serializeJson(i){return i}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setInt32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(i){return(0,f.bX)(i)},serializeJson(i){return i}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(i){return(0,f.bX)(i)},serializeJson(i){return i}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setInt16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(i){return(0,f.bX)(i)},serializeJson(i){return i}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(i,e){return`dv.setUint8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getUint8(${e});`},deserializeJson(i){return(0,f.bX)(i)},serializeJson(i){return i}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(i,e){return`dv.setInt8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getInt8(${e});`},deserializeJson(i){return(0,f.bX)(i)},serializeJson(i){return i}}},Yb=255;function xh(i,e,t){let n=0;const s=t.length,r=new Array(s),o=[];for(let h=0;h<s;++h)r[h]=h;const a=h=>si[t[h].type].alignment(i);r.sort((h,p)=>a(p)-a(h));let l=0;const c=new Array(s);let d=e;const u=()=>{d+=(4-d%4)%4,n+=d,o[l]=d,d=0,++l};for(let h=0;h<s;++h){const p=r[h],m=t[p],g=si[m.type],v=g.serializedBytes(i),y=g.alignment(i),S=(y-d%y)%y,b=d+S+v;b+(4-b%4)%4<=Yb?d+=S:u(),c[p]={offset:d,group:l},d+=v}return u(),{serializedBytes:n,offsets:c,propertyGroupBytes:o}}class Eh{constructor(e,t,n){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=n,n.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}const{serializedBytes:s,offsets:r,propertyGroupBytes:o}=xh(e,t,n);this.propertyGroupBytes=o;let a="let groupOffset0 = offset;";for(let u=1;u<o.length;++u)a+=`let groupOffset${u} = groupOffset${u-1} + ${o[u-1]}*annotationCount;`;for(let u=0;u<o.length;++u)a+=`groupOffset${u} += ${o[u]}*annotationIndex;`;let l=a,c=a;const d=n.length;for(let u=0;u<d;++u){const{group:h,offset:p}=r[u],m=n[u],g=si[m.type],v=`properties[${u}]`,y=`groupOffset${h} + ${p}`;l+=g.serializeCode(v,y,e),c+=g.deserializeCode(v,y,e)}this.serializedBytes=s,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",l),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",c)}}function Pl(i,e){const t=[];for(const n of Xt){const s=Ft[n];t[n]=new Eh(i,s.serializedBytes(i),e)}return t}function Th(i,e){const t=i.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:n,enumLabels:s}=i;if(n!==void 0){const r=n.indexOf(e);if(r!==-1)return`${s[r]} (${t})`}return t}function Qb(i,e){switch(i.type){case"rgb":return Ge(tt(e));case"rgba":return Ge(Dt(e));default:return Th(i,e)}}function Kb(i){const e=(0,f.zr)(i);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(i)}`);return e}function qb(i){if((0,f.zr)(i),!Object.prototype.hasOwnProperty.call(si,i))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return i}function Xb(i){const e=new Set;for(const t of i){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function Zb(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"id",Kb),t=(0,f.cQ)(i,"type",qb),n=(0,f.MM)(i,"description",f.zr),s=(0,f.MM)(i,"default",l=>si[t].deserializeJson(l),0);let r,o,a;switch(t){case"rgb":case"rgba":break;default:{const l=R[t.toUpperCase()];r=(0,f.MM)(i,"enum_values",c=>(0,f.$v)(c,d=>qt(l,d))),r!==void 0&&(o=(0,f.cQ)(i,"enum_labels",c=>(0,f.Xu)(new Array(r.length),c,f.zr))),a=(0,f.MM)(i,"tag",f.zr)}}return{type:t,identifier:e,description:n,default:s,enumValues:r,enumLabels:o,tag:a}}function eC(i){const e=i.default,t=jb(i),n=t?i.tag:void 0,s=t?i.enumValues:void 0,r=t?i.enumLabels:void 0;return{id:i.identifier,description:i.description,type:i.type,tag:n,enum_values:s,enum_labels:r,default:e===0?void 0:si[i.type].serializeJson(e)}}function tC(i){if(!(i===void 0||i.length===0))return i.map(eC)}function Dh(i){if(i===void 0)return[];const e=(0,f.$v)(i,Zb);return Xb(e),e}function Al(i,e,t,n,s){for(let r=0;r<n;++r)i.setFloat32(e,s[r],t),e+=4;return e}function Ml(i,e,t,n,s,r){return e=Al(i,e,t,n,s),e=Al(i,e,t,n,r),e}function Nl(i,e,t,n,s){for(let r=0;r<n;++r)s[r]=i.getFloat32(e,t),e+=4;return e}function Ol(i,e,t,n,s,r){return e=Nl(i,e,t,n,s),e=Nl(i,e,t,n,r),e}const Ft={1:{icon:"\uA579",description:"Line",toJSON(i){return{pointA:Array.from(i.pointA),pointB:Array.from(i.pointB)}},restoreState(i,e,t){i.pointA=(0,f.cQ)(e,"pointA",n=>(0,f.Xu)(new Float32Array(t),n,f.zo)),i.pointB=(0,f.cQ)(e,"pointB",n=>(0,f.Xu)(new Float32Array(t),n,f.zo))},serializedBytes(i){return 2*4*i},serialize(i,e,t,n,s){Ml(i,e,t,n,s.pointA,s.pointB)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n),o=new Float32Array(n);return Ol(i,e,t,n,r,o),{type:1,pointA:r,pointB:o,id:s,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},0:{icon:"\u26AC",description:"Point",toJSON:i=>({point:Array.from(i.point)}),restoreState:(i,e,t)=>{i.point=(0,f.cQ)(e,"point",n=>(0,f.Xu)(new Float32Array(t),n,f.zo))},serializedBytes:i=>i*4,serialize:(i,e,t,n,s)=>{Al(i,e,t,n,s.point)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n);return Nl(i,e,t,n,r),{type:0,point:r,id:s,properties:[]}},visitGeometry(i,e){e(i.point,!1)}},2:{icon:"\u2751",description:"Bounding Box",toJSON:i=>({pointA:Array.from(i.pointA),pointB:Array.from(i.pointB)}),restoreState:(i,e,t)=>{i.pointA=(0,f.cQ)(e,"pointA",n=>(0,f.Xu)(new Float32Array(t),n,f.zo)),i.pointB=(0,f.cQ)(e,"pointB",n=>(0,f.Xu)(new Float32Array(t),n,f.zo))},serializedBytes:i=>2*4*i,serialize(i,e,t,n,s){Ml(i,e,t,n,s.pointA,s.pointB)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n),o=new Float32Array(n);return Ol(i,e,t,n,r,o),{type:2,pointA:r,pointB:o,id:s,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},3:{icon:"\u25CE",description:"Ellipsoid",toJSON:i=>({center:Array.from(i.center),radii:Array.from(i.radii)}),restoreState:(i,e,t)=>{i.center=(0,f.cQ)(e,"center",n=>(0,f.Xu)(new Float32Array(t),n,f.zo)),i.radii=(0,f.cQ)(e,"radii",n=>(0,f.Xu)(new Float32Array(t),n,f.Zw))},serializedBytes:i=>2*4*i,serialize(i,e,t,n,s){Ml(i,e,t,n,s.center,s.radii)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n),o=new Float32Array(n);return Ol(i,e,t,n,r,o),{type:3,center:r,radii:o,id:s,properties:[]}},visitGeometry(i,e){e(i.center,!1),e(i.radii,!0)}}};function _l(i,e){const t=Ft[i.type].toJSON(i,e.rank);t.type=Re[i.type].toLowerCase(),t.id=i.id,t.description=i.description||void 0;const{relatedSegments:n}=i;n?.some(r=>r.length!==0)&&(t.segments=n.map(r=>r.map(o=>o.toString())));const s=e.properties.value;return s.length!==0&&(t.props=i.properties.map((r,o)=>si[s[o].type].serializeJson(r))),t}function nC(i,e,t=!1){(0,f.Rf)(i);const n=(0,f.cQ)(i,"type",l=>(0,f.sl)(l,Re)),s=(0,f.cQ)(i,"id",t?f.z$:f.zr)||Vl(),r=(0,f.cQ)(i,"segments",l=>{if(l===void 0)return e.relationships.map(()=>[]);const c=(0,f.J6)(l);return c.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(c[0])?[(0,f.$v)(c,d=>P.R.parseString(d))]:(0,f.$v)((0,f.J6)(l,e.relationships.length),d=>(0,f.$v)(d,u=>P.R.parseString(u)))}),o=(0,f.cQ)(i,"props",l=>{const c=e.properties.value;return l===void 0?c.map(d=>d.default):(0,f.$v)((0,f.J6)(l,c.length),(d,u)=>si[c[u].type].deserializeJson(d))}),a={id:s,description:(0,f.cQ)(i,"description",f.z$),relatedSegments:r,properties:o,type:n};return Ft[n].restoreState(a,i,e.rank),a}class hs extends T.O8{constructor(e,t=[],n=new _.B0([])){super(),this.relationships=t,this.properties=n,this.annotationMap=new Map,this.changed=new j.IY,this.readonly=!1,this.childAdded=new j.HN,this.childUpdated=new j.HN,this.childCommitted=new j.HN,this.childDeleted=new j.HN,this.pending=new Set,this.references=new Map,this.rank_=e,this.annotationPropertySerializers=Pl(e,n.value)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=Vl();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),t||this.pending.add(e.id),this.changed.dispatch(),this.childAdded.dispatch(e),t&&this.childCommitted.dispatch(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();const t=e.id;this.pending.delete(t),this.changed.dispatch(),this.childCommitted.dispatch(t)}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new Li(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();const e=[],{pending:t}=this;for(const n of this)t.has(n.id)||e.push(_l(n,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();const{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&(0,f.$v)(e,n=>{const s=nC(n,this);t.set(s.id,s)});for(const n of this.references.values()){const{id:s}=n,r=t.get(s);n.value=r||null,n.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class Ih extends hs{constructor(e,t=new _.B0([]),n){super(e.value.sourceRank,n,t),this.watchableTransform=e,this.properties=t,this.getTagProperties=()=>{const{properties:s}=this;return s.value.filter(us)},this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated())),this.registerDisposer(t.changed.add(()=>{this.updateAnnotationPropertySerializers(),this.changed.dispatch()}))}get rank(){return this.ensureUpdated(),this.rank_}updateAnnotationPropertySerializers(){this.annotationPropertySerializers=Pl(this.rank_,this.properties.value)}addProperty(e){this.properties.value.push(e);for(const t of this)t.properties.push(e.default);this.properties.changed.dispatch()}removeProperty(e){const t=this.properties.value.findIndex(n=>n.identifier===e);this.properties.value.splice(t,1);for(const n of this)n.properties.splice(t,1);this.properties.changed.dispatch()}ensureUpdated(){const e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;const n=e.sourceRank,s=t.sourceRank;if(s===n&&(t.inputSpace===e.inputSpace||(0,F.r1)(t.inputSpace.ids.slice(0,n),e.inputSpace.ids.slice(0,n))))return;const{ids:r}=e.inputSpace,o=t.inputSpace.ids,a=[];for(let c=0;c<n;++c){let d=o.indexOf(r[c]);d>=s&&(d=-1),a.push(d)}const l=c=>{const d=new Float32Array(n);for(let u=0;u<n;++u){const h=a[u];d[u]=h===-1?0:c[u]}return d};for(const c of this.annotationMap.values())switch(c.type){case 0:c.point=l(c.point);break;case 1:case 2:c.pointA=l(c.pointA),c.pointB=l(c.pointB);break;case 3:c.center=l(c.center),c.radii=l(c.radii);break}this.rank_!==n&&(this.rank_=n,this.updateAnnotationPropertySerializers()),this.changed.dispatch()}}const iC="Data Bounds";function Vl(){return Te(160)}function sC(i){return{type:2,id:"data-bounds",description:iC,pointA:new Float32Array(i.lowerBounds),pointB:new Float32Array(i.upperBounds),properties:[]}}function xn(i){const e=new hs(i.lowerBounds.length);return e.readonly=!0,e.add(sC(i)),e}function rC(i,e){let t=0;const n=[];for(const c of Xt){const u=e[c].serializedBytes;n[c]=t;const p=i[c].length;t+=u*p}const s=[],r=[],o=new ArrayBuffer(t),a=new DataView(o),l=te===U.LITTLE;for(const c of Xt){const d=e[c],{rank:u}=d,h=d.serialize,p=i[c];s[c]=p.map(S=>S.id),r[c]=new Map(p.map((S,w)=>[S.id,w]));const g=Ft[c].serialize,v=n[c],y=d.propertyGroupBytes[0];for(let S=0,w=p.length;S<w;++S){const b=p[S];g(a,v+S*y,l,u,b),h(a,v,S,w,l,b.properties)}}return{data:new Uint8Array(o),typeToIds:s,typeToOffset:n,typeToIdMaps:r}}class oC{constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return rC(this.annotations,this.propertySerializers)}}function Lh(i){if(i==null)return i;const{relatedSegments:e}=i;if(e!==void 0)for(let t=0,n=e.length;t<n;++t){const s=e[t];s!==void 0&&(e[t]=s.map(r=>new P.R(r.low,r.high)))}return i}var De=G(147);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lo=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xB5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"}],Bl=[...lo,{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],aC=[{prefix:"u",exponent:-6},...Bl],ir=new Map;ir.set("",{unit:"",exponent:0});const lC=new Map;for(const{prefix:i,exponent:e}of aC){lC.set(e,i);for(const t of["m","s","Hz","rad/s"])ir.set(`${i}${t}`,{unit:t,exponent:e})}function Rh(i){const e=Math.log10(i),t=lo.length,n=(0,F.lX)(0,t,s=>lo[s].exponent<=e);return lo[Math.min(n,t-1)]}function kh(i,e,t={}){const{precision:n=6,elide1:s=!0}=t;let r=i,o="";if(e!==""){const l=Rh(i);o=l.prefix,r=Fl(i,-l.exponent)}if(s&&r===1)return{scale:"",unit:e,prefix:o};let a;if(n!==0){r<1||r>=1e3?a=r.toPrecision(n):a=r.toFixed(n);const l=a.indexOf("e");let c,d;l!==-1?(c=a.substring(0,l),d=a.substring(l)):(c=a,d="");const u=c.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);u!==null&&(c=c.substring(0,c.length-u[1].length),c.endsWith(".")&&(c=c.substring(0,c.length-1)),a=c+d)}else a=r.toString();return{scale:a,unit:e,prefix:o}}function Ri(i,e,t){const{scale:n,unit:s,prefix:r}=kh(i,e,t);return`${n}${r}${s}`}function sr(i){if(i==="")return{scale:1,unit:""};const e=i.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([a-zA-Z]+)?$/);if(e===null)return;const t=e[1];let n=t===void 0?1:Number(t);if(Number.isNaN(n))return;let s="";if(e[2]!==void 0){const r=ir.get(e[2]);if(r===void 0)return;s=r.unit,r.exponent>0?n*=10**r.exponent:n/=10**-r.exponent}if(!(n<=0||!Number.isFinite(n)))return{scale:n,unit:s}}function Ph(i){const e=ir.get(i);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return e}function Fl(i,e){return e>=0?i*10**e:i/10**-e}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yV(i,e){const t=i.length;for(let n=0;n<t;++n)if(i[n]!==e[n])return!1;return!0}function Ah(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]+t[s];return i}function Ul(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]-t[s];return i}function SV(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]*t[s];return i}function bV(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]/t[s];return i}function cC(i,e,t,n){const s=i.length;for(let r=0;r<s;++r)i[r]=e[r]+t[r]*n;return i}function dC(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]*t;return i}function $l(i){let e=1;for(let t=0,n=i.length;t<n;++t)e*=i[t];return e}function uC(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=Math.min(e[s],t[s]);return i}function CV(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=Math.max(e[s],t[s]);return i}const ps=new Float32Array(0),Mh=new Float64Array(0),wV=Float64Array.of(1,1,1);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let hC=0;function fs(){return++hC}function pC(i,e){return(0,F.r1)(i.lowerBounds,e.lowerBounds)&&(0,F.r1)(i.upperBounds,e.upperBounds)}function fC(i,e){return i===void 0?e===void 0:e===void 0?!1:i.explicit===e.explicit&&(0,F.r1)(i.coordinates,e.coordinates)&&(0,F.r1)(i.labels,e.labels)}function gC(i,e){const t=new Map;for(let n=0,s=i.length;n<s;++n)t.set(i[n],e[n]);return i=Array.from(t.keys()),i.sort((n,s)=>n-s),e=Array.from(i,n=>t.get(n)),{coordinates:i,labels:e}}function Nh(i){if(i.length===1)return i[0];const e=new Map;let t=!1;for(const r of i){r.explicit&&(t=!0);const{coordinates:o,labels:a}=r;for(let l=0,c=o.length;l<c;++l)e.set(o[l],a[l])}const n=Array.from(e.keys());n.sort((r,o)=>r-o);const s=Array.from(n,r=>e.get(r));return{explicit:t,coordinates:n,labels:s}}function Oh(i){if(i=i.filter(e=>e!==void 0),i.length!==0)return Nh(i)}function mC(i,e){return(0,F.r1)(i.transform,e.transform)&&pC(i.box,e.box)}function co(i,e){return i.valid===e.valid&&i.rank===e.rank&&(0,F.r1)(i.names,e.names)&&(0,F.r1)(i.ids,e.ids)&&(0,F.r1)(i.timestamps,e.timestamps)&&(0,F.r1)(i.units,e.units)&&(0,F.r1)(i.scales,e.scales)&&(0,F.wm)(i.boundingBoxes,e.boundingBoxes,mC)&&(0,F.wm)(i.coordinateArrays,e.coordinateArrays,fC)}function xV(i,e,t){parseFixedLengthArray(i,t,(n,s)=>{const r=unitFromJson(n);return e[s]=r.exponent,r.unit})}function Oe(i){const{names:e,units:t,scales:n}=i,{valid:s=!0,rank:r=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:a=e.map((u,h)=>-h),boundingBoxes:l=[]}=i,{coordinateArrays:c=new Array(r)}=i,{bounds:d=CC(l,r)}=i;return{valid:s,rank:r,names:e,timestamps:o,ids:a,units:t,scales:n,boundingBoxes:l,bounds:d,coordinateArrays:c}}const Fn=Oe({valid:!1,names:[],units:[],scales:Mh,boundingBoxes:[]}),ki=Oe({valid:!0,names:[],units:[],scales:Mh,boundingBoxes:[]});function vC(i){const[e,t]=(0,f.J6)(i,2),n=(0,f.Mo)(e),s=(0,f.zr)(t),r=ir.get(s);if(r===void 0)throw new Error(`Invalid unit: ${JSON.stringify(s)}`);return{unit:r.unit,scale:Fl(n,r.exponent)}}function uo(i,e=!1){if(i===void 0)return Fn;(0,f.Rf)(i);const t=Yl(Object.keys(i),e),n=t.length,s=new Array(n),r=new Float64Array(n),o=new Array(n);for(let a=0;a<n;++a)(0,f.cQ)(i,t[a],l=>{if(Array.isArray(l)){const{unit:c,scale:d}=vC(l);s[a]=c,r[a]=d}else{(0,f.Rf)(l);const c=(0,f.cQ)(l,"coordinates",f.VH),d=(0,f.cQ)(l,"labels",f.si),u=c.length;if(u!==d.length)throw new Error(`Length of coordinates array (${u}) does not match length of labels array (${d.length})`);s[a]="",r[a]=1,o[a]={explicit:!0,...gC(c,d)}}});return Oe({valid:!1,names:t,units:s,scales:r,coordinateArrays:o})}function Gl(i){const{rank:e}=i;if(e===0)return;const{names:t,units:n,scales:s,coordinateArrays:r}=i,o={};for(let a=0;a<e;++a){const l=t[a],c=r[a];c?.explicit?o[l]={coordinates:Array.from(c.coordinates),labels:c.labels}:o[l]=[s[a],n[a]]}return o}class zl extends _.B0{constructor(){super(Fn)}toJSON(){return Gl(this.value)}reset(){this.value=Fn}restoreState(e){this.value=uo(e)}}function yC(i,e,t){return i.voxelCenterAtIntegerCoordinates[e]?t=Math.round(t):t=Math.floor(t)+.5,t}function _h(i,e){let t=i.lowerBounds[e],n=i.upperBounds[e];return i.voxelCenterAtIntegerCoordinates[e]&&(t+=.5,n+=.5),[t,n]}function SC(i,e,t){const n=i.upperBounds[e];Number.isFinite(n)&&(t=Math.min(t,n-1));const s=i.lowerBounds[e];return Number.isFinite(s)&&(t=Math.max(t,s)),t}function Wl(i,e,t){return t=SC(i,e,t),yC(i,e,t)}function Vh(i,e){let t=(i+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,i),e)),t}function bC(i,e){const{lowerBounds:t,upperBounds:n}=e,s=i.length;for(let r=0;r<s;++r)i[r]=Vh(t[r],n[r]);return i}function En(i){const e=i.lowerBounds.length;return{box:i,transform:De.DA(Float64Array,e,e+1)}}function Bh(i,e,t){const{box:{lowerBounds:n,upperBounds:s},transform:r}=i,o=n.length,a=t,l=r[a*o+e];let c=l,d=l,u=!1;for(let h=0;h<o;++h){const p=r[a*h+e];if(p===0)continue;const m=p*n[h],g=p*s[h];c+=Math.min(m,g),d+=Math.max(m,g),u=!0}if(u)return{lower:c,upper:d}}function CC(i,e){const t=new Float64Array(e),n=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),n.fill(Number.POSITIVE_INFINITY);const s=new Array(e);s.fill(0);const r=new Array(e);r.fill(0);for(const a of i)for(let l=0;l<e;++l){const c=Bh(a,l,e);if(c===void 0)continue;const{lower:d,upper:u}=c;if(Number.isFinite(d)&&Number.isFinite(u)){const h=Math.floor(d),p=Math.floor(u);h===d&&p===u?++r[l]:d-h===.5&&u-p===.5&&++s[l]}t[l]=t[l]===Number.NEGATIVE_INFINITY?d:Math.min(t[l],d),n[l]=n[l]===Number.POSITIVE_INFINITY?u:Math.max(n[l],u)}const o=r.map((a,l)=>s[l]>0&&a===0);return{lowerBounds:t,upperBounds:n,voxelCenterAtIntegerCoordinates:o}}function wC(i,e,t){const{transform:n,box:s}=i,r=t.length,o=s.lowerBounds.length,a=new Float64Array((o+1)*e);for(let l=0;l<r;++l){const c=t[l];if(c!==-1)for(let d=0;d<=o;++d)a[d*e+c]=n[d*r+l]}return{transform:a,box:s}}function Fh(i,e){const t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},n=new Float64Array(2*i);return n[e]=1,{transform:n,box:t}}function Uh(i,e,t){if(e===t)return i;const{box:n}=i,s=n.lowerBounds.length,r=new Float64Array((s+1)*t);return De.C(r,t,i.transform,e,e,s+1),{box:n,transform:r}}function xC(i,e){const{rank:t,sourceRank:n}=i;if(t!==e.rank||n!==e.sourceRank)return!1;const{inputSpace:s}=i,{inputSpace:r}=e;return!(0,F.r1)(r.scales,s.scales)||!(0,F.r1)(r.units,s.units)||!(0,F.r1)(e.outputSpace.names,i.outputSpace.names)?!1:zh(i.transform,t,i.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function wt(i){return{rank:i.rank,sourceRank:i.rank,inputSpace:i,outputSpace:i,transform:De.DA(Float64Array,i.rank+1)}}function EC(i,e,t,n){const{transform:s,box:r}=i,o=i.box.lowerBounds.length,a=n.length,l=new Float64Array((o+1)*a);for(let c=0;c<a;++c){const d=n[c];for(let h=0;h<o;++h){let p=0;for(let m=0;m<a;++m){const g=t[m];p+=e[(a+1)*m+c]*s[a*h+m]*(g/d)}l[a*h+c]=p}let u=e[(a+1)*a+c];for(let h=0;h<a;++h){const p=t[h];u+=e[(a+1)*h+c]*s[a*o+h]*(p/d)}l[o*a+c]=u}return{transform:l,box:r}}function $h(i,e,t){return i.boundingBoxes.map(n=>EC(n,e,i.scales,t))}function Hl(i,e,t){const n=Oe({valid:i.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:$h(i,e,t.scales),coordinateArrays:t.coordinateArrays});return co(n,t)?t:n}function Jl(i,e=!1){if(e){const t=Number(i);if(Number.isInteger(t)&&t>=0)return!0}return i.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function ho(i,e=!1){const t=new Set;for(const n of i){if(!Jl(n,e)||t.has(n))return!1;t.add(n)}return!0}function jl(i){const e=i.length,t=new Array(e);t.fill(!0);for(let n=0;n<e;++n){const s=i[n];if(!Jl(s)){t[n]=!1;continue}const r=i.indexOf(s,n+1);r!==-1&&(t[n]=!1,t[r]=!1)}return t}function rr(i){return i.endsWith("'")}function Gh(i){return i.endsWith("'")||i.endsWith("^")}function TC(i){return i.endsWith("^")}function DC(i){return!Gh(i)}function IC(i,e,t){const n=new Float64Array(i),s=e.length,r=(s+1)*s;for(let o=0;o<s;++o)n[r+o]*=e[o]/t[o];return n}function zh(i,e,t,n,s,r){if(!De.LC(i,e+1,n,s+1,e,e))return!1;for(let o=0;o<e;++o){const a=i[(e+1)*e+o],l=n[(s+1)*s+o];if(a*(t[o]/r[o])!==l)return!1}for(let o=e;o<s;++o)if(n[(s+1)*s+o]!==0)return!1;for(let o=e;o<s;++o){for(let a=0;a<e;++a)if(n[(s+1)*a+o]!==0)return!1;for(let a=0;a<s;++a){const l=n[(s+1)*o+a];if(o===a){if(l!==1)return!1}else if(l!==0)return!1}}return!0}function LC(i,e){if(!e.includes(i))return i;const[,t,n]=i.match(/^([^']*)('?)$/);for(let s=0;;++s){const r=`${t}${s}${n}`;if(!e.includes(r))return r}}function RC(i,e){const{inputSpace:t,transform:n}=i,{ids:s,rank:r}=t,{rank:o,names:a,units:l,scales:c}=e,d=new Array(r);d.fill(!0);const u=[],h=e.ids.map((z,Y)=>{const Q=s.indexOf(z);return Q!==-1?d[Q]=!1:u.push(Y),Q}),{outputSpace:p}=i,{names:m,units:g,scales:v,ids:y,timestamps:S,coordinateArrays:w}=p,b=d,x=[],E=[],D=new Float64Array(o),I=[],L=[],N=new Array(o);let k=0;const O=new Float64Array((o+1)**2);O[O.length-1]=1;for(let z=0;z<r;++z)if(!b[z]){x[k]=m[z],I[k]=y[z],E[k]=g[z],D[k]=v[z],L[k]=S[z],N[k]=w[z];for(let Y=0;Y<o;++Y){const Q=h[Y];Q!==-1&&(O[Y*(o+1)+k]=n[Q*(r+1)+z])}O[o*(o+1)+k]=n[r*(r+1)+z],++k}for(const z of u)I[k]=fs(),x[k]=LC(a[z],x),D[k]=c[z],E[k]=l[z],O[z*(o+1)+k]=1,++k;const V=Oe({valid:e.valid,rank:o,names:x,ids:I,timestamps:L,units:E,scales:D,boundingBoxes:$h(e,O,D),coordinateArrays:N});return{rank:o,sourceRank:i.sourceRank,inputSpace:e,outputSpace:V,transform:O}}function Wh(i){const e=Hl(i.inputSpace,i.transform,i.outputSpace);return e===i.outputSpace?i:{rank:i.rank,sourceRank:i.sourceRank,inputSpace:i.inputSpace,transform:i.transform,outputSpace:e}}class Hh{constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new j.IY,this.inputSpaceChanged=new j.IY,this.defaultTransform=Wh(e);const n=this;this.outputSpace={changed:n.changed,get value(){return n.value.outputSpace},set value(s){const{value:r}=n;if(co(r.outputSpace,s)||r.rank!==s.rank)return;const o=IC(r.transform,r.outputSpace.scales,s.scales);n.value_={sourceRank:r.sourceRank,rank:r.rank,inputSpace:r.inputSpace,outputSpace:Hl(r.inputSpace,o,s),transform:o},n.changed.dispatch()}},this.inputSpace={changed:n.inputSpaceChanged,get value(){return n.value.inputSpace},set value(s){const{value:r}=n;co(r.inputSpace,s)||(n.value_=RC(r,s),n.inputSpaceChanged.dispatch(),n.changed.dispatch())}}}set value(e){const t=this.value;e!==t&&(this.value_=Wh(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){const{value:e}=this,{rank:t,transform:n,inputSpace:s,outputSpace:r,sourceRank:o}=e,{defaultTransform:a,mutableSourceRank:l}=this,{inputSpace:c,rank:d,transform:u,outputSpace:h}=a,{units:p,scales:m}=s,g=o===t&&(0,F.r1)(m,l?r.scales:c.scales)&&(0,F.r1)(p,l?r.units:c.units),v=zh(u,d,h.scales,n,t,r.scales),y=(0,F.r1)(h.names,r.names);if(!(v&&y&&g))return{sourceRank:o,transform:v?void 0:n,outputSpace:e.outputSpace,inputSpace:g?void 0:s}}set transform(e){const{value:t}=this,{inputSpace:n}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:n,transform:e,outputSpace:Hl(n,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){const k=e.inputSpace||e.outputSpace,O=k.rank,V=Oe({rank:O,names:k.names.map((z,Y)=>`${Y}`),units:k.units,scales:k.scales,coordinateArrays:k.coordinateArrays});this.value={rank:O,transform:e.transform||De.DA(Float64Array,O+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:V};return}const{inputSpace:t,sourceRank:n,outputSpace:s,transform:r,rank:o}=this.defaultTransform,{inputSpace:a,sourceRank:l,outputSpace:c,transform:d}=e,u=e.outputSpace.rank,h=t.names,p=a!==void 0?a.names:h,m=new Array(n);for(let k=0;k<n;++k){let O=p.indexOf(h[k]);O>=l&&(O=-1),m[k]=O}const g=u-l+n;for(let k=l;k<u;++k)m[n+k-l]=k;const v=new Float64Array(g),y=new Array(g),S=[];for(let k=0;k<n;++k){const O=m[k];O===-1||a===void 0?(v[k]=t.scales[k],S[k]=t.units[k],y[k]=t.coordinateArrays[k]):(v[k]=a.scales[O],S[k]=a.units[O],y[k]=Oh([t.coordinateArrays[k],a.coordinateArrays[O]]))}const w=a||c,b=h.slice(0,n),x=s.names.slice(0,n),E=s.coordinateArrays.slice(0,n),D=new Float64Array(g),I=[];for(let k=0;k<g;++k){const O=m[k];O===-1?(D[k]=s.scales[k],I[k]=s.units[k],E[k]=s.coordinateArrays[k]):(x[k]=c.names[O],I[k]=c.units[O],D[k]=c.scales[O],E[k]=c.coordinateArrays[O])}if(!ho(x)){this.reset();return}for(let k=n;k<g;++k){const O=k-n+l;v[k]=w.scales[O],S[k]=w.units[O],b[k]=`${k}`}const L=new Float64Array((g+1)**2);L[L.length-1]=1;for(let k=0;k<g;++k){const O=m[k];let V;O===-1||d===void 0?k>=n?V=0:V=r[o*(o+1)+k]*(s.scales[k]/D[k]):V=d[u*(u+1)+O],L[g*(g+1)+k]=V;for(let z=0;z<g;++z){const Y=m[z];let Q;O===-1!=(Y===-1)?Q=0:O===-1||d===void 0?O>=n||Y>=n?Q=O===Y?1:0:Q=r[z*(o+1)+k]:Q=d[Y*(u+1)+O],L[z*(g+1)+k]=Q}}const N=t.boundingBoxes.map(k=>Uh(k,o,g));for(let k=n;k<g;++k)N.push(Fh(g,k));for(let k=0;k<g;++k){if(L[g*(g+1)+k]!==0)continue;let V;for(let Y=0;Y<g;++Y){const Q=L[Y*(g+1)+k];if(Q!==0)if(Q===1)if(V===void 0)V=Y;else{V=null;break}else{V=null;break}}if(V==null)continue;let z=y[V];z!==void 0&&(z.explicit&&(z={...z,explicit:!1}),E[k]=Oh([z,E[k]]))}this.value={rank:g,transform:L,sourceRank:n,outputSpace:Oe({rank:g,names:x,scales:D,units:I,coordinateArrays:E}),inputSpace:Oe({rank:g,names:b,scales:v,units:S,coordinateArrays:y,boundingBoxes:N})}}toJSON(){return Yh(this.spec)}restoreState(e){this.spec=jh(e)}}function kC(i,e=!1){const t=(0,f.zr)(i);if(!Jl(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function Yl(i,e=!1){const t=(0,f.$v)(i,n=>kC(n,e));if(!ho(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}class Ql{constructor(e,t){this.combined=e,this.bindings=new Set,this.retainCount=0,this.prevCombined=this.combined.value,this.dimensionRefCounts=new Map,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t}getRenameValidity(e){const t=this.combined.value.names,n=jl(e),s=e.length;for(let r=0;r<s;++r){if(!n[r])continue;const o=e[r];if(t.includes(o))continue;let a=!0;for(const l of this.bindings)if(l.space.value.names.includes(o)){a=!1;break}n[r]=a}return n}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){const{combined:e,bindings:t}=this,n=this.retainCount>0?1:0;if(t.size===0&&!n){e.value=Fn;return}const s=this.includeDimensionPredicate_,r=e.value;let o=Array.from(r.names),a=Array.from(r.units),l=Array.from(r.scales),c=Array.from(r.ids),d=Array.from(r.timestamps),u=r.names.map(()=>n?1:0);const h=[];let p=!1;for(const x of t){const{space:{value:E},prevValue:D,mappedDimensionIds:I}=x;p=p||E.valid;const{names:L,units:N,scales:k,ids:O,timestamps:V}=E,z=[],Y=[];h.push(Y),x.mappedDimensionIds=z,x.prevValue=E;const Q=L.length;for(let X=0;X<Q;++X){const ce=L[X];if(!s(ce))continue;if(D!==void 0){const Ke=O[X],$e=D.ids.indexOf(Ke);if($e!==-1){const Tt=I[$e];if(Tt!==void 0){const we=c.indexOf(Tt);if(we!==-1){z[X]=Tt,++u[we],Y[X]=we;const xe=V[X];xe!==void 0&&!(xe<=d[we])&&(o[we]=ce,l[we]=k[X],a[we]=N[X],d[we]=xe);continue}}}}let oe=o.indexOf(ce);if(oe!==-1){z[X]=c[oe],++u[oe],Y[X]=oe;continue}oe=o.length,Y[X]=oe,u[oe]=1+n,o[oe]=ce,a[oe]=N[X],l[oe]=k[X],d[oe]=V[X];const Se=fs();c[oe]=Se,z[X]=Se}}const{dimensionRefCounts:m}=this;m.clear();let g=0,v=o.length;for(const x of t){const{space:{value:E}}=x,D=h[g++],{rank:I}=E,L=Array.from(E.names),N=Array.from(E.timestamps),k=Float64Array.from(E.scales),O=Array.from(E.units);for(let V=0;V<I;++V){const z=D[V];z!==void 0&&(O[V]=a[z],k[V]=l[z],N[V]=d[z],L[V]=o[z])}for(const V of L){let z=m.get(V);z===void 0?z=1:++z,m.set(V,z)}if(!(0,F.r1)(O,E.units)||!(0,F.r1)(k,E.scales)||!(0,F.r1)(L,E.names)||!(0,F.r1)(N,E.timestamps)){const V=Oe({valid:E.valid,ids:E.ids,scales:k,units:O,names:L,timestamps:N,boundingBoxes:E.boundingBoxes,coordinateArrays:E.coordinateArrays});x.prevValue=V,x.space.value=V}}{for(let E=0;E<v;++E)s(o[E])||(u[E]=0);const x=(E,D)=>u[D]!==0;o=o.filter(x),a=a.filter(x),l=l.filter(x),c=c.filter(x),d=d.filter(x),u=u.filter(x),v=o.length}const y=[],S=new Array(v);for(let x=0,E=r.rank;x<E;++x){const D=r.coordinateArrays[x];if(!D?.explicit)continue;const I=c.indexOf(r.ids[x]);I!==-1&&(S[I]=[D])}for(const x of t){const{space:{value:E}}=x,{rank:D,boundingBoxes:I,coordinateArrays:L}=E,N=E.names.map(k=>o.indexOf(k));for(const k of I)y.push(wC(k,v,N));for(let k=0;k<D;++k){const O=L[k];if(O===void 0)continue;const V=N[k],z=S[V];z===void 0?S[V]=[O]:z.push(O)}}const w=new Array(v);for(let x=0;x<v;++x){const E=S[x];E!==void 0&&(w[x]=Nh(E))}const b=Oe({valid:p,ids:c,names:o,units:a,scales:new Float64Array(l),boundingBoxes:y,coordinateArrays:w});if(n)for(let x=0;x<v;++x)--u[x];co(r,b)||(this.prevCombined=b,e.value=b)}retain(){return++this.retainCount,()=>{--this.retainCount===0&&this.update()}}bind(e){const t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:n}=this;n.size===0&&this.combined.changed.add(this.handleCombinedChanged),n.add(t);const s=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),r=()=>{s();const{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),r}}function Jh(i,e,t,n,s){const r=s.length,o=new i((r+1)**2);o[o.length-1]=1;for(let a=0;a<r;++a){const l=n[a];o[(r+1)*r+a]=e[(t+1)*t+l];for(let c=0;c<r;++c){const d=s[c];o[(r+1)*c+a]=e[(t+1)*d+l]}}return o}function PC(i){if(i===void 0)return;const e=new Float64Array(16);if(Array.isArray(i))if(i.length===16)for(let t=0;t<4;++t)for(let n=0;n<4;++n)e[t*4+n]=(0,f.zo)(i[n*4+t]);else{(0,f.J6)(i,4);for(let t=0;t<4;++t){const n=(0,f.J6)(i[t],4);for(let s=0;s<4;++s)e[s*4+t]=(0,f.zo)(n[s])}}else{(0,f.Rf)(i);const t=C.Yu.create(),n=C.eR.create(),s=C.eR.fromValues(1,1,1);(0,f.MM)(i,"rotation",o=>{(0,f.Vr)(t,o),C.Yu.normalize(t,t)}),(0,f.MM)(i,"translation",o=>{(0,f.Vr)(n,o)}),(0,f.MM)(i,"scale",o=>{(0,f.Vr)(s,o)});const r=C.pB.create();C.pB.fromRotationTranslationScale(r,t,n,s),e.set(r)}return{sourceRank:3,transform:e,outputSpace:Oe({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function jh(i){if(i===void 0)return;const e=(0,f.Rf)(i),t=(0,f.cQ)(e,"outputDimensions",uo),n=t.rank,s=(0,f.cQ)(e,"sourceRank",a=>{if(a===void 0)return n;if(!Number.isInteger(a)||a<0||a>n)throw new Error(`Expected integer in range [0, ${n}] but received: ${JSON.stringify(a)}`);return a}),r=(0,f.MM)(e,"inputDimensions",a=>{const l=uo(a,!0);if(l.rank!==n)throw new Error(`Expected rank of ${n}, but received rank of: ${l.rank}`);return l});return{transform:(0,f.MM)(e,"matrix",a=>{const l=new Float64Array((n+1)**2),c=(0,f.J6)(a,n);l[l.length-1]=1;for(let d=0;d<n;++d)try{const u=(0,f.J6)(c[d],n+1);for(let h=0;h<=n;++h)l[(n+1)*h+d]=(0,f.zo)(u[h])}catch(u){throw new Error(`Error in row ${d}: ${u.message}`)}return l}),outputSpace:t,inputSpace:r,sourceRank:s}}function Yh(i){if(i===void 0)return;const{transform:e,outputSpace:t,inputSpace:n,sourceRank:s}=i;let r;const o=t.rank;if(e!==void 0){r=[];for(let a=0;a<o;++a){const l=[];r[a]=l;for(let c=0;c<=o;++c)l[c]=e[(o+1)*c+a]}}return{sourceRank:s===o?void 0:s,matrix:r,outputDimensions:Gl(t),inputDimensions:n===void 0?void 0:Gl(n)}}function AC(i,e,t){const{box:n,transform:s}=i,r=i.box.lowerBounds.length,o=e.length,a=new Float64Array((r+1)*o);if(De.ay(a,o,s,t,e,r+1),!a.every(l=>l===0))return{transform:a,box:n}}function Kl(i,e){const{ids:t,names:n,scales:s,units:r,timestamps:o,coordinateArrays:a}=i;return Oe({rank:e.length,valid:i.valid,ids:e.map(l=>t[l]),names:e.map(l=>n[l]),timestamps:e.map(l=>o[l]),scales:Float64Array.from(e,l=>s[l]),units:e.map(l=>r[l]),coordinateArrays:e.map(l=>a[l]),boundingBoxes:i.boundingBoxes.map(l=>AC(l,e,i.rank)).filter(l=>l!==void 0)})}function Qh(i,e,t){return e===t?i:Kl(i,(0,F.ep)(i.rank,t,e))}function Kh(i,e){const{transform:t,rank:n}=i,s=(0,C.PC)(t,n,[e]);if(s.length!==1)return;const[r]=s,o=Math.abs(t[(n+1)*r+e]),{inputSpace:a}=i;return{scale:a.scales[r]*o,unit:a.units[r]}}function qh(i,e){const{scales:t,units:n}=i.defaultInputSpace;return e<t.length?{scale:t[e],unit:n[e]}:void 0}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const EV={channelCoordinateSpace:ki,shape:new Uint32Array(0),numChannels:1,coordinates:new Uint32Array(0)};function MC(i){const{rank:e}=i,{bounds:{lowerBounds:t,upperBounds:n}}=i;if(t.some(a=>a!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(n.some(a=>!Number.isInteger(a)||a<=0||a>=4294967296))throw new Error("Upper bounds of channel coordinate space must all be positive integers");const s=new Uint32Array(n),r=$l(s),o=new Uint32Array(r*e);for(let a=0;a<r;++a){let l=a;for(let c=0;c<e;++c){const d=l%s[c];l=(l-d)/s[c],o[a*e+c]=d}}return{channelCoordinateSpace:i,shape:s,numChannels:r,coordinates:o}}function ql(i,e,t,n,s,r){const{scales:o}=t,{scales:a,rank:l}=s,c=e+1;for(let d=0;d<l;++d){const u=r[d];if(u===-1)continue;const h=a[d];for(let p=0;p<e;++p){const m=n[p],g=o[m];i[c*p+u]*=g/h}}}function NC(i,e,t,n,s=ki){const{inputSpace:r,rank:o,sourceRank:a,outputSpace:l,transform:c}=t,{names:d}=r,{names:u}=l;let h;if(n!==void 0)h=Array.from(n.modelSubspaceDimensionIndices);else{h=[];for(let V=0;V<a;++V)h[V]=V}const p=h.length;for(let V=a;V<o;++V)h.push(V);const m=(0,C.PC)(t.transform,o,h,!0),g=h.length,v=h.map(V=>d[V]||`${V}`),y=m.map(V=>u[V]);if(g!==m.length)return{error:"Rank mismatch between model subspace dimensions ("+v.join(", ")+") and corresponding layer/global dimensions ("+y.join(", ")+")"};let S=Jh(Float32Array,c,o,m,h);const w=m.map(V=>u[V]),b=e.names.map(V=>w.indexOf(V)),x=i.names.map(V=>w.indexOf(V));ql(S,g,r,h,i,x),ql(S,g,r,h,e,b);const E=s.names.map(V=>w.indexOf(V));ql(S,g,r,h,s,E);const D=[],I=s.rank;if(n!==void 0){let{subsourceToModelSubspaceTransform:V}=n;p!==g&&(V=De.Aw(new Float32Array((g+1)**2),g,V,p)),S=De.lw(new Float32Array((g+1)**2),g+1,S,g+1,V,g+1,g+1,g+1,g+1)}const L=new Uint32Array(I),{lowerBounds:N,upperBounds:k,voxelCenterAtIntegerCoordinates:O}=s.bounds;for(let V=0;V<I;++V){let z=N[V],Y=k[V];if(O[V]&&(z+=.5,Y+=.5),z!==0||!Number.isInteger(Y)||Y<=0||Y>=4294967296)return{error:`Channel dimension ${s.names[V]} must have lower bound of 0 and positive integer upper bound; current bounds are [${z}, ${Y}]`};L[V]=Y;const Q=E[V];let X=-1;if(Q!==-1)for(let ce=0;ce<g;++ce){const oe=S[Q+ce*(g+1)];if(oe!==0){if(oe!==1||X!==-1)return{error:`Channel dimension ${y[Q]} must map to a single source dimension`};X=ce}}D[V]=X}return{rank:g,unpaddedRank:p,modelDimensionNames:v,layerDimensionNames:y,localToRenderLayerDimensions:b,globalToRenderLayerDimensions:x,channelToRenderLayerDimensions:E,modelToRenderLayerTransform:S,channelToModelDimensions:D,channelSpaceShape:L}}function OC(i,e){return i===e?!0:i.error!==void 0||e.error!==void 0?!1:(0,F.r1)(i.modelDimensionNames,e.modelDimensionNames)&&(0,F.r1)(i.layerDimensionNames,e.layerDimensionNames)&&(0,F.r1)(i.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&(0,F.r1)(i.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&(0,F.r1)(i.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&(0,F.r1)(i.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&(0,F.r1)(i.channelSpaceShape,e.channelSpaceShape)}function Xh(i,e,t,n,s){return(0,_.Uq)((r,o,a,l)=>NC(r,o,a,n,l),[i,e,t,s===void 0?(0,_.XZ)(void 0):s],OC)}function _C(i,e,t,n){const{globalToRenderLayerDimensions:s}=t;for(let r=0;r<3;++r){let o=0;const a=n[r];if(a!==-1){const l=s[a];l!==-1&&(o=e[l])}i[r]=o}}function VC(i,e,t,n){const{globalToRenderLayerDimensions:s}=t;for(let r=0;r<3;++r){const o=n[r];if(o!==-1){const a=s[o];a!==-1&&(i[a]=e[r])}}}function TV(i,e,t,n){const{globalToRenderLayerDimensions:s}=t.modelTransform,{layerRank:r,chunkToLayerTransform:o}=t,a=r+1;for(let l=0;l<3;++l){let c=0;const d=n[l];if(d!==-1){const u=s[d];if(u!==-1){c=o[a*r+u];for(let h=0;h<r;++h)c+=o[a*h+u]*e[h]}}i[l]=c}return i}function po(i,e){const t=i.rank,n=i.unpaddedRank;let s;n!==t&&e!==void 0&&(e=De.Aw(new Float32Array((t+1)**2),t,e,n)),e!==void 0?(s=new Float32Array((t+1)*(t+1)),De.lw(s,t+1,i.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):s=i.modelToRenderLayerTransform;const r=new Float32Array((t+1)*(t+1)),o=De.DI(r,t+1,s,t+1,t+1);if(o===0)throw new Error("Transform is singular");const{globalToRenderLayerDimensions:a,localToRenderLayerDimensions:l,channelToRenderLayerDimensions:c}=i,d=a.length,u=l.length,h=d+u,p=new Float32Array((h+1)*t);for(let x=0;x<t;++x){for(let E=0;E<d;++E){const D=a[E];D!==-1&&(p[x+E*t]=r[x+D*(t+1)])}for(let E=0;E<u;++E){const D=l[E];D!==-1&&(p[x+(d+E)*t]=r[x+D*(t+1)])}p[x+h*t]=r[x+t*(t+1)]}const m=c.length,g=new Array(m),v=[];for(let x=0;x<m;++x){const E=c[x];let D=-1;if(E!==-1){for(let I=0;I<t;++I){const L=s[E+I*(t+1)];if(L!==0){if(L!==1||D!==-1)throw new Error(`Channel dimension ${i.layerDimensionNames[E]} must map with stride 1 to a single data chunk dimensions`);D=I}}if(D!==-1){const I=s[E+t*(t+1)];if(I!==0&&I!==-.5)throw new Error(`Channel dimension ${i.layerDimensionNames[E]} must have an offset of 0 in the chunk coordinate space; current offset is ${I}`);v.push(D)}}g[x]=D}const{channelSpaceShape:y}=i,S=$l(y),w=v.length,b=new Uint32Array(S*w);for(let x=0;x<S;++x){let E=x,D=0;for(let I=0;I<m;++I){const L=E%y[I];E=(E-L)/y[I],g[I]!==-1&&(b[x*w+D]=L,++D)}}return{layerRank:t,modelTransform:i,chunkToLayerTransform:s,layerToChunkTransform:r,chunkToLayerTransformDet:o,combinedGlobalLocalRank:h,combinedGlobalLocalToChunkTransform:p,channelToChunkDimensionIndices:g,chunkChannelDimensionIndices:v,numChannels:S,chunkChannelCoordinates:b,channelSpaceShape:y}}function Zh(i,e){const{globalToRenderLayerDimensions:t}=i,n=[],s=[];for(let r=0;r<3;++r){const o=e[r];if(o===-1)continue;const a=t[o];s.push(a),a!==-1&&n.push(a)}for(let r=s.length;r<3;++r)s[r]=-1;return{layerDisplayDimensionIndices:n,displayToLayerDimensionIndices:s}}function ep(i,e){const{chunkToLayerTransform:t,modelTransform:n}=i,s=n.rank,{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:o}=e,a=r.length,l=(0,C.PC)(t,s,r);if(l.length!==a){const{modelDimensionNames:u,layerDimensionNames:h}=n;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(r,p=>h[p]).join(",\xA0")}) and corresponding chunk dimensions (${Array.from(l,p=>u[p]).join(",\xA0")})`)}const c=C.pB.create();for(let u=0;u<3;++u){const h=o[u];if(h!==-1){for(let p=0;p<a;++p){const m=l[p];c[p*4+u]=t[m*(s+1)+h]}c[12+u]=t[s*(s+1)+h]}}const d=C.pB.create();C.pB.invert(d,c);for(let u=l.length;u<3;++u)l[u]=-1;return{modelTransform:i.modelTransform,chunkTransform:i,displaySubspaceModelMatrix:c,displaySubspaceInvModelMatrix:d,chunkDisplayDimensionIndices:l,numChunkDisplayDims:a}}function gs(i,e,t,n,s){const r=e.length,o=t.length,a=i.length;let l=!0;for(let c=0;c<n;++c){let d=c,u=0;for(let h=0;h<r;++h)u+=s[d+h*n]*e[h];d+=r*n;for(let h=0;h<o;++h)u+=s[d+h*n]*t[h];u+=s[d+o*n],c<a?i[c]=u:(u<0||u>=1)&&(l=!1)}return l}function DV(i,e,t,n){return scatterUpdate(i,e,n.globalToRenderLayerDimensions),scatterUpdate(i,t,n.localToRenderLayerDimensions),i}function BC(i,e,t){i.fill(0),i[15]=1;let n=!0;const{displayDimensionIndices:s}=e,{globalToRenderLayerDimensions:r,modelToRenderLayerTransform:o}=t,a=t.rank;for(let l=0;l<3;++l){const c=s[l];if(c===-1){n=!1;continue}const d=r[c];if(d===-1){n=!1;continue}i[l+12]=o[d+a*(a+1)];for(let u=0;u<3;++u)i[l+4*u]=o[d+(a+1)*u]}if(!n){const{globalDimensionNames:l}=e,c=Array.from(s.filter(d=>d!==-1),d=>l[d]).join(",\xA0");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(",\xA0")}) to display dimensions (${c}) does not have full rank`)}}var Fe=G(5716);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ue=(i=>(i[i.GPU_MEMORY=0]="GPU_MEMORY",i[i.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",i[i.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",i[i.DOWNLOADING=3]="DOWNLOADING",i[i.QUEUED=4]="QUEUED",i[i.NEW=5]="NEW",i[i.FAILED=6]="FAILED",i[i.EXPIRED=7]="EXPIRED",i))(Ue||{});const Xl=8;var ri=(i=>(i[i.FIRST_TIER=0]="FIRST_TIER",i[i.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",i[i.VISIBLE=0]="VISIBLE",i[i.PREFETCH=1]="PREFETCH",i[i.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",i[i.RECENT=2]="RECENT",i[i.LAST_TIER=2]="LAST_TIER",i))(ri||{});const Zl=3;var ec=(i=>(i[i.totalTime=0]="totalTime",i[i.totalChunks=1]="totalChunks",i))(ec||{}),oi=(i=>(i[i.numChunks=0]="numChunks",i[i.systemMemoryBytes=1]="systemMemoryBytes",i[i.gpuMemoryBytes=2]="gpuMemoryBytes",i))(oi||{});const Un=3,LV=Xl*Zl*Un+2;function Pi(i,e){return i*Zl+e}function tp(i){return Xl*Zl*Un+i}const RV=1e13,FC="ChunkQueueManager",UC="ChunkManager",$C="ChunkSource.invalidate",GC="ChunkQueueManager.requestChunkStatistics",zC="ChunkManager.chunkLayerStatistics";class fo{constructor(){this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.numPrefetchChunksAvailable=0}}var Qe=G(4104);/**
 * @license
 * Copyright 2024 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var np=(i=>(i[i.MEDIAN=0]="MEDIAN",i[i.MEAN=1]="MEAN",i[i.MAX=2]="MAX",i))(np||{});class WC{constructor(e=10,t=10){if(this.numStoredTimes=e,this.queryPoolSize=t,this.timeElapsedQueries=[],this.warnedAboutMissingExtension=!1,this.storedTimeDeltas=[],this.queryPoolSize<1)throw new Error(`Query pool size must be at least 1, but got ${t}.`)}getTimingExtension(e){const t=e.getExtension("EXT_disjoint_timer_query_webgl2");return t===null&&!this.warnedAboutMissingExtension&&(console.log("EXT_disjoint_timer_query_webgl2 extension not available. Cannot measure frame time."),this.warnedAboutMissingExtension=!0),t}startFrameTimeQuery(e,t){if(t===null)return null;const n=e.createQuery();return n!==null&&e.beginQuery(t.TIME_ELAPSED_EXT,n),n}endFrameTimeQuery(e,t,n){if(t!==null&&n!==null&&e.endQuery(t.TIME_ELAPSED_EXT),this.timeElapsedQueries.length>=this.queryPoolSize){const s=this.timeElapsedQueries.shift();s!=null&&e.deleteQuery(s)}this.timeElapsedQueries.push(n)}grabAnyFinishedQueryResults(e){const t=[];for(let n=0;n<this.timeElapsedQueries.length;n++){const s=this.timeElapsedQueries[n];if(s!==null&&e.getQueryParameter(s,e.QUERY_RESULT_AVAILABLE)){const o=e.getQueryParameter(s,e.QUERY_RESULT)/1e6;this.storedTimeDeltas.push(o),e.deleteQuery(s),t.push(n)}}for(let n=t.length-1;n>=0;n--)this.timeElapsedQueries.splice(n,1);this.storedTimeDeltas.length>this.numStoredTimes&&(this.storedTimeDeltas=this.storedTimeDeltas.slice(-this.numStoredTimes))}getLastFrameTimesInMs(e=10){return this.storedTimeDeltas.slice(-e)}getQueries(){return this.timeElapsedQueries}}class HC{constructor(e=10,t=8,n=16.666666666666668,s=15){this.numberOfStoredFrameDeltas=e,this.maxDownsamplingFactor=t,this.desiredFrameTimingMs=n,this.downsamplingPersistenceDurationInFrames=s,this.lastFrameTime=null,this.frameDeltas=[],this.downsamplingRates=new Map,this.frameCount=0,this.validateConstructorArguments();for(let r=1;r<=this.maxDownsamplingFactor;r*=2)this.downsamplingRates.set(r,-1/0)}validateConstructorArguments(){this.numberOfStoredFrameDeltas=Math.max(1,Math.round(this.numberOfStoredFrameDeltas)),this.maxDownsamplingFactor=Math.max(2,Math.round(this.maxDownsamplingFactor))}storeFrameDelta(e){this.frameDeltas.push(e),this.frameDeltas.length>this.numberOfStoredFrameDeltas&&this.frameDeltas.shift()}calculateMeanFrameTime(){return this.frameDeltas.reduce((e,t)=>e+t,0)/this.frameDeltas.length}calculateMedianFrameTime(){const e=this.frameDeltas.slice().sort((n,s)=>n-s),t=Math.floor(e.length/2);return e.length%2===1?e[t]:(e[t-1]+e[t])/2}calculateMaxFrameTime(){return Math.max(...this.frameDeltas)}updateMaxTrackedDownsamplingRate(e){this.downsamplingRates.set(e,this.frameCount);let t=1;for(const[n,s]of this.downsamplingRates)this.frameCount-s<=this.downsamplingPersistenceDurationInFrames&&(t=n);return t}resetForNewFrameSet(){this.lastFrameTime=null,this.frameCount=0,this.downsamplingRates.forEach((e,t)=>{this.downsamplingRates.set(t,-1/0)})}addFrame(e=Date.now()){if(this.lastFrameTime!==null){const t=e-this.lastFrameTime;t>0&&this.storeFrameDelta(t)}this.lastFrameTime=e,this.frameCount++}calculateFrameTimeInMs(e=2){if(this.frameDeltas.length===0)return 0;switch(e){case 0:return this.calculateMedianFrameTime();case 1:return this.calculateMeanFrameTime();case 2:return this.calculateMaxFrameTime()}}calculateDownsamplingRate(e=1){const t=this.calculateFrameTimeInMs(e);if(t===0)return Math.min(4,this.maxDownsamplingFactor);let n=Math.max(t/this.desiredFrameTimingMs,1);return n=Math.min(Math.pow(2,Math.round(Math.log2(n))),this.maxDownsamplingFactor),this.updateMaxTrackedDownsamplingRate(n)}getFrameDeltas(){return this.frameDeltas}getFrameCount(){return this.frameCount}getDownsamplingRates(){return this.downsamplingRates}setFrameDeltas(e,t=!0){this.frameDeltas=e.slice(-this.numberOfStoredFrameDeltas),t&&this.frameCount++}}var JC=G(310);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const jC=300;class tc{constructor(){this.width=0,this.height=0,this.logicalWidth=0,this.logicalHeight=0,this.visibleLeftFraction=0,this.visibleTopFraction=0,this.visibleWidthFraction=0,this.visibleHeightFraction=0}}function ip(i,e){const t=1/i.visibleWidthFraction,n=1/i.visibleHeightFraction,s=-1-(-1+2*i.visibleLeftFraction)*t;let r=-1-(-1+2*i.visibleTopFraction)*n;r=-r,e[0]=e[0]*t+e[3]*s,e[4]=e[4]*t+e[7]*s,e[8]=e[8]*t+e[11]*s,e[12]=e[12]*t+e[15]*s,e[1]=e[1]*n+e[3]*r,e[5]=e[5]*n+e[7]*r,e[9]=e[9]*n+e[11]*r,e[13]=e[13]*n+e[15]*r}function sp(i,e){return i.width===e.width&&i.height===e.height&&i.logicalWidth===e.logicalWidth&&i.logicalHeight===e.logicalHeight&&i.visibleLeftFraction===e.visibleLeftFraction&&i.visibleTopFraction===e.visibleTopFraction}class rp extends T.O8{constructor(e,t,n){super(),this.context=e,this.element=t,this.visibility=n,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new tc,this.monitorState={},this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){const{context:e}=this;e.ensureBoundsUpdated();const{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;const{element:n}=this,s=n.getBoundingClientRect();e.ensureMonitorPanel(n,this.monitorState,s);const r=e.container,o=e.canvasRect,{canvas:a}=e,{width:l,height:c}=a,d=l/o.width,u=c/o.height,h=o.left,p=o.top,m=this.canvasRelativeLogicalLeft=Math.round((s.left-h)*d+n.clientLeft),g=this.canvasRelativeLogicalTop=Math.round((s.top-p)*u+n.clientTop),v=n.clientWidth,y=n.clientHeight,S=m+v,w=g+y;let b=g,x=m,E=S,D=w;for(let k=n.parentElement;k!==null&&k!==r;k=k.parentElement){const O=k.getBoundingClientRect();O.x===0&&O.y===0&&O.width===0&&O.height===0||(x=Math.max(x,(O.left-h)*d),b=Math.max(b,(O.top-p)*u),E=Math.min(E,(O.right-h)*d),D=Math.min(D,(O.bottom-p)*u))}b=this.canvasRelativeClippedTop=Math.round(Math.max(b,0)),x=this.canvasRelativeClippedLeft=Math.round(Math.max(x,0)),E=Math.round(Math.min(E,l)),D=Math.round(Math.min(D,c));const I=this.renderViewport,L=I.width=Math.max(0,E-x),N=I.height=Math.max(0,D-b);I.logicalWidth=v,I.logicalHeight=y,I.visibleLeftFraction=(x-m)/v,I.visibleTopFraction=(b-g)/y,I.visibleWidthFraction=L/v,I.visibleHeightFraction=N/y}setGLClippedViewport(){const{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:n,renderViewport:{width:s,height:r}}=this,o=t+r;e.enable(WebGL2RenderingContext.SCISSOR_TEST);const a=this.context.canvas.height-o;e.viewport(n,a,s,r),e.scissor(n,a,s,r)}setGLLogicalViewport(){const{gl:e,renderViewport:{width:t,height:n,logicalWidth:s,logicalHeight:r}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+r),s,r),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+n),t,n)}disposed(){this.context.unmonitorPanel(this.element,this.monitorState),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;const{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}}class nc extends rp{constructor(e,t,n){super(e,t,n),this.canvas=document.createElement("canvas"),this.canvasRenderingContext=this.canvas.getContext("2d");const{canvas:s}=this;t.appendChild(s),t.style.position="relative",s.style.position="absolute",s.style.left="0",s.style.right="0",s.style.top="0",s.style.bottom="0"}draw(){this.drawIndirect();const{renderViewport:e,canvas:t}=this,{logicalWidth:n,logicalHeight:s}=e;t.width=n,t.height=s;const{canvasRenderingContext:r}=this;r?.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,n,s,0,0,n,s)}}class YC extends _.DN{constructor(){super(Float64Array.of(0,0,1,1),e=>(0,f.Xu)(new Float64Array(4),e,f.xU))}toJSON(){const{value:e}=this,[t,n,s,r]=e;if(!(t===0&&n===0&&s===1&&r===1))return Array.from(e)}}class QC extends T.O8{constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new j.IY,this.updateFinished=new j.IY,this.continuousCameraMotionStarted=new j.IY,this.continuousCameraMotionFinished=new j.IY,this.changed=this.updateFinished,this.panels=new Set,this.resizeGeneration=0,this.boundsGeneration=-1,this.framerateMonitor=new WC,this.continuousCameraMotionInProgress=!1,this.orderedPanels=[],this.frameNumber=0,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.debouncedEndContinuousCameraMotion=this.registerCancellable((0,Fe.A)(()=>{this.continuousCameraMotionInProgress=!1,this.continuousCameraMotionFinished.dispatch()},jC)),this.scheduleRedraw=this.registerCancellable((0,Qe.t)(()=>this.draw()));const{canvas:t,resizeObserver:n}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",n.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",s=>{console.log(`Lost WebGL context: ${s.statusMessage}`),s.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=(0,JC.y)(t)}ensureMonitorPanel(e,t,n){t.addedToResizeObserver||(this.resizeObserver.observe(e),t.addedToResizeObserver=!0);const s=this.rootRect,r=s.top-n.top,o=s.left-n.left,a=n.right-s.right,l=n.bottom-s.bottom,c=`${r}px ${a}px ${l}px ${o}px`;t.intersectionObserverMargin!==c&&(t.intersectionObserverMargin=c,t.intersectionObserver?.disconnect(),(t.intersectionObserver=new IntersectionObserver(this.resizeCallback,{root:this.container,rootMargin:c,threshold:[.93,.94,.95,.96,.97,.98,.99,1]})).observe(e))}unmonitorPanel(e,t){t.addedToResizeObserver&&this.resizeObserver.unobserve(e),t.intersectionObserver?.disconnect()}flagContinuousCameraMotion(){this.continuousCameraMotionInProgress||this.continuousCameraMotionStarted.dispatch(),this.continuousCameraMotionInProgress=!0,this.debouncedEndContinuousCameraMotion()}get isContinuousCameraMotionInProgress(){return this.continuousCameraMotionInProgress}applyWindowedViewportToElement(e,t){const[n,s,r,o]=t,a=1/r,l=1/o;e.style.position="absolute",e.style.top=`${-l*s*100}%`,e.style.left=`${-a*n*100}%`,e.style.width=`${a*100}%`,e.style.height=`${l*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(const e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){const{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;const{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.rootRect=this.container.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();const e=this.gl,t=this.framerateMonitor.getTimingExtension(e),n=this.framerateMonitor.startFrameTimeQuery(e,t);this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const{orderedPanels:s,panels:r}=this;s.length!==r.size&&(s.push(...r),s.sort((o,a)=>o.drawOrder-a.drawOrder));for(const o of s){if(!o.shouldDraw)continue;o.ensureBoundsUpdated();const{renderViewport:a}=o;a.width===0||a.height===0||o.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch(),this.framerateMonitor.endFrameTimeQuery(e,t,n),this.framerateMonitor.grabAnyFinishedQueryResults(e)}getDepthArray(){const{width:e,height:t}=this.canvas,n=new Float32Array(e*t);for(const s of this.panels){if(!s.shouldDraw)continue;const r=s.getDepthArray();if(r===void 0)continue;const{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:a,renderViewport:{width:l,height:c}}=s;for(let d=0;d<c;++d){const u=(c-1-d)*l;n.set(r.subarray(u,u+l),(o+d)*l+a)}}return n}getLastFrameTimesInMs(e=10){return this.framerateMonitor.getLastFrameTimesInMs(e)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class op extends tc{constructor(){super(...arguments),this.globalPosition=ps,this.projectionMat=C.pB.create(),this.viewMatrix=C.pB.create(),this.invViewMatrix=C.pB.create(),this.viewProjectionMat=C.pB.create(),this.invViewProjectionMat=C.pB.create()}}function KC(i,e){return i.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&sp(i,e)&&(0,F.r1)(i.globalPosition,e.globalPosition)&&(0,F.r1)(i.projectionMat,e.projectionMat)&&(0,F.r1)(i.viewMatrix,e.viewMatrix)}function ap(i){const{viewMatrix:e,viewProjectionMat:t}=i;C.pB.invert(e,i.invViewMatrix),C.pB.multiply(t,i.projectionMat,e),C.pB.invert(i.invViewProjectionMat,t)}var go=G(3517);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Tn=(i=>(i[i.info=0]="info",i[i.warning=1]="warning",i[i.error=2]="error",i))(Tn||{});class kV{}class ai{constructor(){this.changed=new j.IY,this.messages=[],this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){const{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{const{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(const e of this.children)yield*e}}var Je=G(4509);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mo=!(typeof Window<"u"&&self instanceof Window),lp=!1,cp=!1,ic="rpc.promise.response",dp="rpc.promise.cancel",up="rpc.ready",hp=new Map;function pt(i,e){hp.set(i,e)}class qC extends Error{constructor(e,t){super(t),this.name=e,this.message=t}}function pp(i,e){pt(i,function(t){const n=t.id,s=new Je.Qi,r=e.call(this,t,s);this.set(n,{promise:r,cancellationToken:s}),r.then(({value:o,transfers:a})=>{this.delete(n),this.invoke(ic,{id:n,value:o},a)},o=>{this.delete(n),this.invoke(ic,{id:n,error:o.message,errorName:o.name})})})}pt(dp,function(i){const e=i.id,t=this.get(e);if(t!==void 0){const{cancellationToken:n}=t;n.cancel()}}),pt(ic,function(i){const e=i.id,{resolve:t,reject:n}=this.get(e);this.delete(e),Object.prototype.hasOwnProperty.call(i,"value")?t(i.value):i.errorName===Je.wS.name?n(Je.wS):n(new qC(i.errorName,i.error))}),pt(up,function(i){this.onPeerReady()});const XC=mo?-1:0;class ZC{constructor(e,t){this.target=e,this.objects=new Map,this.nextId=XC,t&&(this.queue=[]),e.onmessage=n=>{const s=n.data;cp&&console.log("Received message",s),hp.get(s.functionName).call(this,s)}}sendReady(){this.invoke(up,{})}onPeerReady(){const{queue:e}=this;if(e!==void 0){this.queue=void 0;for(const{data:t,transfers:n}of e)this.target.postMessage(t,n)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){const t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}getOptionalRef(e){if(e===void 0)return;const t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}invoke(e,t,n){t.functionName=e,cp&&console.trace("Sending message",t);const{queue:s}=this;if(s!==void 0){s.push({data:t,transfers:n});return}this.target.postMessage(t,n)}promiseInvoke(e,t,n=Je.fx,s){return(0,Je.gI)(n,(r,o,a)=>{const l=t.id=this.newId();this.set(l,{resolve:r,reject:o}),this.invoke(e,t,s),a.add(()=>{this.invoke(dp,{id:l})})})}newId(){return mo?this.nextId--:this.nextId++}}class hn extends T.O8{constructor(){super(...arguments),this.rpc=null,this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){lp&&console.log(`[${mo}] #rpc object = ${this.rpc.numObjects}`);const{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}}function ew(i,e,t={}){e!=null&&i.initializeSharedObject(e,t.id)}class vo extends hn{constructor(e,t={}){super(),ew(this,e,t)}}pt("SharedObject.dispose",function(i){const e=this.get(i.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");lp&&console.log(`[${mo}] #rpc objects: ${this.numObjects}`),e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null}),pt("SharedObject.refCountReachedZero",function(i){const e=this.get(i.id),t=i.gen;e.counterpartRefCountReachedZero(t)});const fp=new Map;function Zt(i){return e=>{e.prototype.RPC_TYPE_ID=i}}function yo(i){return e=>{if(i!==void 0)e.prototype.RPC_TYPE_ID=i;else if(i=e.prototype.RPC_TYPE_ID,i===void 0)throw new Error("RPC_TYPE_ID should have already been defined");fp.set(i,e)}}pt("SharedObject.new",function(i){const e=this,t=i.type,n=fp.get(t),s=new n(e,i);--s.refCount});var tw=Object.defineProperty,nw=Object.getOwnPropertyDescriptor,iw=(i,e,t,n)=>{for(var s=n>1?void 0:n?nw(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&tw(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gp="SharedWatchableValue.changed";let ft=class extends vo{constructor(i,e={}){super(i,e),this.updatingValue_=!1,i!==void 0&&(this.base=new _.B0(e.value),this.setupChangedHandler())}initializeCounterpart(i,e={}){e.value=this.value,super.initializeCounterpart(i,e)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{const{rpc:i}=this;i!==null&&i.invoke(gp,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(i,e){const t=new ft;return t.base=e,t.setupChangedHandler(),t.initializeCounterpart(i),t}static make(i,e){return ft.makeFromExisting(i,new _.B0(e))}get value(){return this.base.value}set value(i){this.base.value=i}get changed(){return this.base.changed}};ft=iw([yo("SharedWatchableValue")],ft),pt(gp,function(i){const e=this.get(i.id);e.updatingValue_=!0,e.base.value=i.value,e.updatingValue_=!1});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vt extends _.B0{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}vt.VISIBLE=Number.POSITIVE_INFINITY,vt.IGNORED=Number.NEGATIVE_INFINITY;class or extends vt{constructor(){super(...arguments),this.contributors=new Map}add(e){const{contributors:t}=this,n=e.changed.add(()=>{this.update()}),s=()=>{t.delete(s),n(),this.update()};return t.set(s,e),this.update(),s}update(){let e=Number.NEGATIVE_INFINITY;for(const t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function ar(i){return class extends i{constructor(){super(...arguments),this.visibility=new or}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(ft.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var sw=Object.defineProperty,rw=Object.getOwnPropertyDescriptor,ow=(i,e,t,n)=>{for(var s=n>1?void 0:n?rw(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&sw(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var li=(i=>(i[i.DATA=0]="DATA",i[i.ANNOTATION=1]="ANNOTATION",i[i.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION",i))(li||{});function aw(){return new _._Y([0,1,2])}class mp extends T.O8{constructor(){super(...arguments),this.role=0,this.messages=new ai,this.layerChanged=new j.IY,this.redrawNeeded=new j.IY,this.layerChunkProgressInfo=new fo}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,n,s){}}class vp extends mp{constructor(){super(...arguments),this.visibility=new or}attach(e){}}function lr(i,e,t){let{state:n}=t;if(n===void 0||n.transform!==i||n.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),n=t.state={transform:i,displayDimensionRenderInfo:e,modelTransform:void 0},i.error!==void 0){t.messages.addMessage({severity:Tn.error,message:i.error});return}try{const s=C.pB.create();BC(s,e,i),n.modelTransform=s}catch(s){t.messages.addMessage({severity:Tn.error,message:s.message})}}return n.modelTransform}class yp extends T.O8{constructor(e){super(),this.renderViewport=new tc,this.changed=new j.HN;const{parametersConstructor:t=op,navigationState:n,update:s,isEqual:r=KC}=e;this.oldValue_=new t,this.value_=new t;const o=()=>{const{oldValue_:l,value_:c}=this;l.displayDimensionRenderInfo=n.displayDimensionRenderInfo.value,Object.assign(l,this.renderViewport);let{globalPosition:d}=l;const u=n.position.value,h=u.length;d.length!==h&&(l.globalPosition=d=new Float32Array(h)),d.set(u),s(l,n),!r(l,c)&&(this.value_=l,this.oldValue_=c,this.changed.dispatch(c,l))},a=this.update=this.registerCancellable((0,Fe.A)(o,0));this.registerDisposer(n.changed.add(a)),o()}setViewport(e){sp(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}}let So=class extends hn{constructor(i,e,t=10){super(),this.base=e,this.updateInterval=t,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable((0,Fe.A)((n,s)=>{let r;if(s.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)r=s,this.prevDisplayDimensionRenderInfo=s.displayDimensionRenderInfo;else{const{displayDimensionRenderInfo:o,...a}=s;r=a}this.rpc.invoke(go.kg,{id:this.rpcId,value:r})},this.updateInterval)),this.initializeCounterpart(i,{value:e.value}),this.registerDisposer(e.changed.add(this.update))}flush(){this.update.flush()}};So=ow([Zt(go.Bh)],So);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nt{constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new j.IY}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){const{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class pn extends T.O8{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");const{element:n}=this;n.type="checkbox";const s=()=>{const r=this.model.value;this.element.checked=r,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(r?t.enableTitle:t.disableTitle)??"")};this.registerDisposer(e.changed.add(s)),s(),this.registerEventListener(n,"change",function(r){e.value=this.checked}),n.addEventListener("mousedown",r=>{r.preventDefault()})}disposed(){const{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}}class en extends T.O8{constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,Fe.A)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bo(i){try{return i()}catch(e){return{error:e.message}}}function sc(i){if(i.error!==void 0)throw new Error(i.error);return i}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rc extends T.O8{constructor(e,t){if(super(),this.register=e,this.changed=new j.IY,this.disposerMap=new Map,t===void 0)this.map=new Map;else{const n=this.map=new Map(t),{disposerMap:s}=this;for(const[r,o]of n){const a=new T.O8;s.set(r,a),e(a,o,r)}}}get value(){return this.map}set(e,t){const{map:n,disposerMap:s}=this;let r=s.get(e);return r!==void 0&&r.dispose(),r=new T.O8,s.set(e,r),n.set(e,t),this.register(r,t,e),this.changed.dispatch(),this}delete(e){const{map:t,disposerMap:n}=this,s=n.get(e);return s!==void 0?(s.dispose(),n.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){const{map:e,disposerMap:t}=this;if(e.size>0){for(const n of t.values())n.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){const{map:e,disposerMap:t}=this;for(const n of t.values())n.dispose();e.clear(),t.clear(),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Sp=Symbol("objectId");let lw=0;function xt(i){if(i instanceof Object){let e=i[Sp];return e===void 0&&(e=i[Sp]=lw++),`o${e}`}return""+JSON.stringify(i)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oc=!1;var bp=(i=>(i[i.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",i[i.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT",i))(bp||{});function cw(i){i=i.replace("\0","");const e=[];for(let t of i.split(`
`)){let n=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);n!==null?e.push({message:n[3].trim(),file:parseInt(n[1],10),line:parseInt(n[2],10)}):(n=t.match(/^ERROR:\s*(.+)$/),n!==null?e.push({message:n[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}class dw extends Error{constructor(e,t,n,s){const r=`Error compiling ${bp[e].toLowerCase()} shader: ${n}`;super(r),this.name="ShaderCompilationError",this.log=n,this.message=r,this.shaderType=e,this.source=t,this.errorMessages=s}}class uw extends Error{constructor(e,t,n){const s=`Error linking shader: ${n}`;super(s),this.name="ShaderLinkError",this.log=n,this.message=s,this.vertexSource=e,this.fragmentSource=t}}function Cp(i,e,t){const n=i.createShader(t);if(i.shaderSource(n,e),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS)){const s=i.getShaderInfoLog(n)||"";if(oc){const r=e.replace("<","&lt;").replace(">","&gt;").split(`
`);let o="<pre>";o+=s.replace("<","&lt;").replace(">","&gt;")+`
`,r.forEach((l,c)=>{o+=`${c+1}: ${l}
`}),o+=`
</pre>`,console.log(o);const a=window.open("about:blank","_blank");if(a!==null)try{a.document.write(o)}catch{}}throw new dw(t,e,s,cw(s))}return n}let ac;class hw extends T.O8{constructor(e,t,n,s,r,o){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=n,this.attributes=new Map,this.uniforms=new Map,this.vertexShaderInputBinders={},this.transferFunctionTextures=new Map;const a=this.vertexShader=Cp(e,t,e.VERTEX_SHADER),l=this.fragmentShader=Cp(e,n,e.FRAGMENT_SHADER),c=e.createProgram();if(e.attachShader(c,a),e.attachShader(c,l),oc&&o?.length&&(e.transformFeedbackVaryings(c,o.map(h=>h.name),WebGL2RenderingContext.INTERLEAVED_ATTRIBS),this.vertexDebugOutputs=o),e.linkProgram(c),!e.getProgramParameter(c,e.LINK_STATUS)){const h=e.getProgramInfoLog(c)||"";throw new uw(t,n,h)}this.program=c;const{uniforms:d,attributes:u}=this;if(s)for(const h of s)d.set(h,e.getUniformLocation(c,h));if(r)for(const h of r)u.set(h,e.getAttribLocation(c,h))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){ac=this,this.gl.useProgram(this.program)}bindAndUpdateTransferFunctionTexture(e,t,n,s){const r=this.textureUnits.get(e);if(r===void 0)throw new Error(`Invalid texture unit symbol: ${e.toString()}`);const o=this.transferFunctionTextures.get(e);if(o===void 0)throw new Error(`Invalid transfer function texture symbol: ${e.toString()}`);return o.updateAndActivate({textureUnit:r,sortedControlPoints:t,dataType:n,lookupTableSize:s})}unbindTransferFunctionTextures(){const e=this.gl;for(const t of this.transferFunctionTextures.keys()){const n=this.textureUnits.get(t);n!==void 0&&(this.gl.activeTexture(e.TEXTURE0+n),this.gl.bindTexture(e.TEXTURE_2D,null))}}disposed(){const{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0,this.transferFunctionTextures=void 0}}function pw(i,e,t,n,s){if(i.drawArraysInstanced(e,t,n,s),!oc||!ac?.vertexDebugOutputs)return;const{vertexDebugOutputs:r}=ac;let o=0;for(const h of r)o+=fw[h.typeName];const a=i.createBuffer(),l=o*n*s;i.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,a),i.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,l,WebGL2RenderingContext.DYNAMIC_DRAW),i.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),i.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,a),i.beginTransformFeedback(WebGL2RenderingContext.POINTS),i.enable(WebGL2RenderingContext.RASTERIZER_DISCARD),i.drawArraysInstanced(WebGL2RenderingContext.POINTS,t,n,s),i.disable(WebGL2RenderingContext.RASTERIZER_DISCARD),i.endTransformFeedback(),i.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,null),i.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,a);const c=new Uint8Array(l);i.getBufferSubData(WebGL2RenderingContext.ARRAY_BUFFER,0,c,0,l),i.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),i.deleteBuffer(a);let d=0;const u=new Float32Array(c.buffer);for(let h=0;h<s;++h)for(let p=0;p<n;++p){let m=`i=${h} v=${p}:`;for(const g of r)switch(m+=` ${g.name}=`,g.typeName){case"float":m+=`${u[d++]}`;break;case"vec2":m+=`${u[d++]},${u[d++]}`;break;case"vec3":m+=`${u[d++]},${u[d++]},${u[d++]}`;break;case"vec4":m+=`${u[d++]},${u[d++]},${u[d++]},${u[d++]}`;break}console.log(m)}}class wp{constructor(){this.code="",this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(const t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}}const cr={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},fw={float:4,vec2:8,vec3:12,vec4:16};class fn{constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new Set,this.fragmentExtensions="",this.vertexCode=new wp,this.vertexMain="",this.fragmentCode=new wp,this.outputBufferCode="",this.fragmentMain="",this.required=new Set,this.uniforms=new Array,this.attributes=new Array,this.initializers=[],this.textureUnits=new Map,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());const n=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,n),n}addTextureSampler(e,t,n,s){const r=this.allocateTextureUnit(n,s);return this.addUniform(`highp ${e}`,t,s),this.addInitializer(o=>{if(s){const a=new Int32Array(s);for(let l=0;l<s;++l)a[l]=l+r;o.gl.uniform1iv(o.uniform(t),a)}else o.gl.uniform1i(o.uniform(t),r)}),r}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,n){return this.attributes.push(t),n!==void 0&&(this.attributesCode+=`layout(location = ${n})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,n=""){this.varyingsCodeVS+=`${n} out ${e} ${t};
`,this.varyingsCodeFS+=`${n} in ${e} ${t};
`}addOutputBuffer(e,t,n){n!==null&&(this.outputBufferCode+=`layout(location = ${n}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,n){return this.uniforms.push(t),n!=null?this.uniformsCode+=`uniform ${e} ${t}[${n}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){const e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
float defaultMaxProjectionIntensity = 0.0;
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
float defaultMaxProjectionIntensity = 0.0;
${this.fragmentCode}
${this.fragmentMain}
`,n=new hw(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);n.textureUnits=this.textureUnits;const{initializers:s}=this;if(s.length>0){n.bind();for(const r of s)r(n)}return n}}function PV(i,e){const t=new Set;for(const n of e){const s=new RegExp(`(?:^|[^a-zA-Z0-9_])${n}[^a-zA-Z0-9_])`);i.match(s)!==null&&t.add(n)}return t}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function dr(){return new _.B0(void 0)}function Co(i){return new _.DN(i,f.zr)}function wo(i,e,t){const n=new Map,{parameters:s,fallbackParameters:r,shaderError:o,encodeParameters:a=v=>v,extraParameters:l=(0,_.XZ)(void 0),encodeExtraParameters:c=v=>v,getContextKey:d,defineShader:u}=t;o!==void 0&&(o.value=void 0);const{encodeContext:h=d}=t,p=(0,f.JB)(t.memoizeKey);function m(v,y,S){const w=JSON.stringify({id:p,context:h(v),parameters:a(y),extraParameters:c(S)});return e.memoize.get(w,()=>{const b=new fn(e);return u(b,v,y,S),b.build()})}function g(v){const y=d(v);let S=n.get(y);S===void 0&&(S={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:s.value,extraParameters:l.value},n.set(y,S));const w=s.changed.count,b=l.changed.count;if(w===S.parametersGeneration&&b===S.extraParametersGeneration)return S;const x=S.parameters=s.value,E=S.extraParameters=l.value,D=S.shader;S.parametersGeneration=w,S.extraParametersGeneration=b;let I=null;try{I=m(v,x,E),S.fallback=!1,r!==void 0&&(r.value=x),o!==void 0&&(o.value=null)}catch(L){if(o!==void 0&&(o.value=L),r!==void 0)try{const N=r.value;I=m(v,N,E),S.parameters=N,S.fallback=!0}catch{}}return D!==null&&D.dispose(),S.shader=I,S}return i.registerDisposer(()=>{for(const v of n.values()){const{shader:y}=v;y!==null&&y.dispose()}}),g}function Ai(i,e,t){return wo(i,e,{...t,getContextKey:n=>n,encodeContext:n=>xt(n),defineShader:(n,s,r,o)=>(n.require(s),t.defineShader(n,r,o))})}function ms(i,e=1,t=0){return`
#line ${t} ${e}
`+i}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class At{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,n=WebGL2RenderingContext.FLOAT,s=!1,r=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,n,s,r,o)}bindToVertexAttribI(e,t,n=WebGL2RenderingContext.UNSIGNED_INT,s=0,r=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,n,s,r)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){const n=this.gl;this.bind(),n.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,n,s){const r=new At(e,n);return r.setData(t,s),r}}function ci(i,e,t,...n){return i.memoize.get((0,f.JB)({id:"getMemoizedBuffer",getter:xt(t),args:n}),()=>{const s=new T.fL(At.fromData(i,t(...n),e,WebGL2RenderingContext.STATIC_DRAW));return s.registerDisposer(s.value),s})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gw(i=-1,e=-1,t=1,n=1,s=1,r=1){return(0,F.CS)(new Float32Array([i,e,i,n,t,n,t,e]),2,s,r)}function AV(i=-1,e=-1,t=-1,n=1,s=1,r=1,o=1,a=1){return tile2dArray(new Float32Array([i,e,t,n,e,t,i,s,t,n,s,t,i,e,r,n,e,r,i,s,r,n,s,r]),3,o,a)}function ur(i,e=-1,t=-1,n=1,s=1,r=1,o=1){return ci(i,WebGL2RenderingContext.ARRAY_BUFFER,gw,e,t,n,s,r,o).value}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function di(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function mw(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function vw(i,e,t,n,s=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),di(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,t,n,0,r,o,null),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function yw(i,e,t){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lc(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain("v4f_fragColor = getValue0();")}function xp(i,e=lc,t=1){return i.memoize.get(`elementWiseTextureShader:${t}:${xt(e)}`,()=>{const n=new fn(i);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler",t),n.addInitializer(s=>{const r=[];for(let o=0;o<t;++o)r[o]=o;i.uniform1iv(s.uniform("uSampler"),r)});for(let s=0;s<t;++s)n.addFragmentCode(`
vec4 getValue${s}() {
  return texture(uSampler[${s}], vTexCoord);
}
`);return n.addUniform("mat4","uProjectionMatrix"),n.require(e),n.addAttribute("vec4","aVertexPosition"),n.addAttribute("vec2","aTexCoord"),n.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),n.build()})}function MV(i){return xp(i,lc,1)}function Sw(i){return i.memoize.get("trivialColorShader",()=>{const e=new fn(i);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}function NV(i){return i.memoize.get("trivialUniformColorShader",()=>{const e=new ShaderBuilder(i);return e.addUniform("mat4","uProjectionMatrix"),e.addAttribute("vec4","aVertexPosition"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = uColor;"),e.setVertexMain("gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ep extends T.O8{constructor(){super(...arguments),this.width=Number.NaN,this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}}class bw extends Ep{constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){const{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){const{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class Cw extends bw{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){const{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class xo extends Cw{constructor(e){super(e,!0)}}const OV=null;class ww extends T.O8{constructor(e){super(),this.gl=e,this.framebuffer=this.gl.createFramebuffer()}disposed(){const{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class gn extends Ep{constructor(e,t,n,s){super(),this.gl=e,this.internalFormat=t,this.format=n,this.dataType=s,this.texture=e.createTexture()}performResize(){vw(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){const{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class xw extends gn{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,n=WebGL2RenderingContext.DEPTH_COMPONENT,s=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,n,s)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function vs(i,e,t=WebGL2RenderingContext.RGBA8,n=WebGL2RenderingContext.RGBA,s=WebGL2RenderingContext.UNSIGNED_BYTE){const r=new Array;for(let o=0;o<e;++o)r[o]=new gn(i,t,n,s);return r}class $n extends T.O8{constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=new Array,this.attachmentVerified=!1,this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];const{framebuffer:n=new ww(e),colorBuffers:s,depthBuffer:r}=t;this.framebuffer=this.registerDisposer(n),this.colorBuffers=s,this.depthBuffer=r,r!==void 0&&this.registerDisposer(r);const{fullAttachmentList:o}=this;s.forEach((a,l)=>{this.registerDisposer(a),o[l]=e.COLOR_ATTACHMENT0+l})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();const{gl:n,depthBuffer:s}=this;s!==void 0?(s.resize(e,t),s.attachToFramebuffer()):n.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((r,o)=>{r.resize(e,t),r.attachToFramebuffer(n.COLOR_ATTACHMENT0+o)}),n.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),n.viewport(0,0,e,t)}bindSingle(e){const{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,n,s,r=1,o=1){const{gl:a}=this;try{this.bindSingle(e),a.readPixels(t,n,r,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,s)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;const{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class Dn extends T.O8{constructor(e,t){super(),this.gl=e,this.shader=t,this.copyVertexPositionsBuffer=ur(this.gl),this.copyTexCoordsBuffer=ur(this.gl,0,0,1,1),this.registerDisposer(t)}draw(...e){const{gl:t,shader:n}=this;n.bind();const s=e.length;for(let a=0;a<s;++a)t.activeTexture(t.TEXTURE0+a),t.bindTexture(t.TEXTURE_2D,e[a]);t.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,C.r3);const r=n.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(r,2);const o=n.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(r),t.disableVertexAttribArray(o);for(let a=0;a<s;++a)t.activeTexture(t.TEXTURE0+a),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=lc,n=1){return e.memoize.get(`OffscreenCopyHelper:${n}:${xt(t)}`,()=>new Dn(e,xp(e,t,n)))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ew=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,Tw=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,gt=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,Dw=[gt,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],Tp=[gt,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],Eo=[gt,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],Dp=[gt,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],Iw=[[gt,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],Eo,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],Lw=[Dp,Eo,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],Ip=[gt,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],Rw=[gt,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],Lp=[gt,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],Rp=[gt,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],cc=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,kp=[gt,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],Pp=[gt,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],To=[gt,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],Ap=[gt,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],kw=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,Pw=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,Aw=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,Mp=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,Mw=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,dc=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,Nw=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,Ow=[dc,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],_w=[dc,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function yt(i,e=1){switch(i){case R.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case R.UINT8:case R.INT8:case R.UINT16:case R.INT16:case R.UINT32:case R.INT32:case R.UINT64:{const t=ae[i]?"":"u",n=B[i]*8;if(e===1)return`${t}int${n}_t`;if(e>1&&e*n<=32)return`${t}int${n}x${e}_t`;break}}throw new Error(`No shader type for ${R[i]}[${e}].`)}const ys={[R.UINT8]:Lp,[R.INT8]:Rp,[R.UINT16]:kp,[R.INT16]:Pp,[R.UINT32]:To,[R.INT32]:Ap,[R.UINT64]:gt,[R.FLOAT32]:cc};function Vw(i,e){return e===1?i:i==="float"?`vec${e}`:`${i[0]}vec${e}`}const Bw={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function Do(i,e,t,n,s,r,o=1){let a=0,l=r*o;for(;l>0;){const u=Math.min(4,l),h=Vw(e,u);l-=u,i.addAttribute("highp "+h,`a${s}${a}`),++a}l=r*o;let c="";for(let u=0;u<o;++u){c+=`highp ${e}[${r}] get${s}${u}() {
  highp ${e}[${r}] result;
`;for(let h=0;h<r;++h){const p=u*r+h,m=Math.floor(p/4),g=p%4;c+=`  result[${h}] = a${s}${m}`,(g!==0||p!==l-1)&&(c+=`[${g}]`),c+=`;
`}c+=`  return result;
`,c+=`}
`}i.addVertexCode(c);const d=Bw[t];i.addInitializer(u=>{const h=[];for(let p=0;p<a;++p)h[p]=u.attribute(`a${s}${p}`);u.vertexShaderInputBinders[s]={enable(p){const{gl:m}=u;for(let g=0;g<a;++g){const v=h[g];m.enableVertexAttribArray(v),m.vertexAttribDivisor(v,p)}},disable(){const{gl:p}=u;for(let m=0;m<a;++m){const g=h[m];p.vertexAttribDivisor(g,0),p.disableVertexAttribArray(g)}},bind(p,m){const{gl:g}=u;for(let v=0;v<a;++v){const y=h[v],S=Math.min(4,l-4*v);e==="float"?g.vertexAttribPointer(y,S,t,n,p,m):g.vertexAttribIPointer(y,Math.min(4,l-4*v),t,p,m),m+=d*S}}}})}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fw=!1;class Np extends T.O8{constructor(e,t,n,s=new or){super(),this.channels=e,this.properties=t,this.bounds=n,this.visibility=s,this.framebuffers=[],this.producerVisibility=new or,this.frameNumber=-1}getFramebuffers(e){const{framebuffers:t}=this,n=this.bounds.value.length;for(;t.length<n;){const s=new $n(e,{colorBuffers:vs(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(s)}return t}get visibleHistograms(){return this.visibility.visible?this.bounds.value.length:0}disposed(){for(const e of this.framebuffers)e.dispose();this.framebuffers.length=0}}const Op=Symbol("histogramDataSamplerTextureUnit"),_p=Symbol("histogramDepthTextureUnit"),uc=4096,Uw=2**14;class hc extends T.O8{constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{const t=new fn(this.gl);return t.addOutputBuffer("vec4","outputValue",0),t.addAttribute("float","aInput1"),t.addTextureSampler("sampler2D","uDataSampler",Op),t.addTextureSampler("sampler2D","uDepthSampler",_p),t.addVertexCode(Mp),t.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),t.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),t.build()})()),this.inputIndexBuffer=this.registerDisposer(ci(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(uc)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new hc(e))}compute(e,t,n,s,r){const{gl:o}=this,{shader:a}=this,l=s.getFramebuffers(o);a.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(a.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const c=a.textureUnit(Op),d=a.textureUnit(_p);o.activeTexture(WebGL2RenderingContext.TEXTURE0+d),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),di(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+c);const u=s.frameNumber;s.frameNumber=r;for(let h=0;h<e;++h)if(o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n[h].texture),di(o),l[h].bind(256,1),r!==u&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,uc,Uw/uc),Fw){const p=new Float32Array(1024);o.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,p);const m=new Float32Array(256);for(let g=0;g<256;++g)m[g]=p[g*4];console.log("histogram",m.join(" "))}o.disable(WebGL2RenderingContext.BLEND)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pc={[R.UINT8]:"vec2",[R.INT8]:"vec2",[R.UINT16]:"vec2",[R.INT16]:"vec2",[R.FLOAT32]:"vec2",[R.UINT32]:"Uint32LerpParameters",[R.INT32]:"Int32LerpParameters",[R.UINT64]:"Uint64LerpParameters"},hr={[R.UINT8]:"",[R.INT8]:"",[R.UINT16]:"",[R.INT16]:"",[R.FLOAT32]:"",[R.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[R.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[R.UINT64]:[gt,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]},Vp=`
float computeInvlerp(float inputValue, vec2 p) {
  float outputValue = inputValue;
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;function Io(i){const t=`
float computeInvlerp(${yt(i)} inputValue, vec2 p) {
  return computeInvlerp(float(toRaw(inputValue)), p);
}
`;return[ys[i],Vp,t]}function Bp(i){const e=yt(i),t=i===R.INT32?"int":"uint",n=pc[i];return[ys[i],hr[i],`
float computeInvlerp(${t} v, ${n} p) {
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
float computeInvlerp(${e} inputValue, ${n} p) {
  return computeInvlerp(toRaw(inputValue), p);
}
`]}const $w={[R.UINT8]:Io(R.UINT8),[R.INT8]:Io(R.INT8),[R.UINT16]:Io(R.UINT16),[R.INT16]:Io(R.INT16),[R.FLOAT32]:Vp,[R.UINT32]:Bp(R.UINT32),[R.INT32]:Bp(R.INT32),[R.UINT64]:[gt,Eo,Dp,Ip,hr[R.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function pr(i){let t=`
${yt(i)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return i===R.FLOAT32?t+=`return inputValue;
`:t+=`return ${R[i].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[ys[i],t]}function Fp(i){const e=yt(i),t=pc[i];return[ys[i],hr[i],Mw,i===R.UINT32?dc:Ow,i===R.UINT32?Nw:_w,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}const Gw={[R.UINT8]:pr(R.UINT8),[R.INT8]:pr(R.INT8),[R.UINT16]:pr(R.UINT16),[R.INT16]:pr(R.INT16),[R.FLOAT32]:pr(R.FLOAT32),[R.UINT32]:Fp(R.UINT32),[R.INT32]:Fp(R.INT32),[R.UINT64]:[gt,Eo,Tp,Iw,Lw,Ip,Rw,hr[R.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function Up(i,e,t){const n=`uLerpParams_${e}`,s=`uLerpBounds_${e}`,r=`uLerpScalar_${e}`;let o="";switch(t){case R.INT8:case R.UINT8:case R.INT16:case R.UINT16:case R.FLOAT32:i.addUniform("vec2",n);break;case R.INT32:case R.UINT32:{const a=pc[t];i.addUniform(`${t===R.INT32?"i":"u"}vec2`,s),i.addUniform("float",r),o+=`
#define ${n} ${a}(${s}[0], int(${s}[1]), ${r})
`;break}case R.UINT64:{i.addUniform("uvec3",s),i.addUniform("float",r),o+=`
#define ${n} Uint64LerpParameters(uint64_t(${s}.xy), int(${s}[2]), ${r})
`;break}}return[hr[t],o]}function Ss(i,e,t,n=!1){const s=yt(t);let r=`
float ${e}(${s} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${n?"v = clamp(v, 0.0, 1.0);":""}
  defaultMaxProjectionIntensity = v;
  return v;
}
`;if(t!==R.UINT64&&t!==R.FLOAT32){const o=ae[t]?"int":"uint";r+=`
float ${e}(${o} inputValue) {
  return ${e}(${s}(inputValue));
}
`}return[ys[t],Up(i,e,t),$w[t],r]}function zw(i,e,t){return[ys[t],Up(i,e,t),Gw[t],`
${yt(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}const Mi=new P.R;function Ni(i,e,t,n){const{gl:s}=i;switch(t){case R.INT8:case R.UINT8:case R.INT16:case R.UINT16:case R.FLOAT32:s.uniform2f(i.uniform(`uLerpParams_${e}`),n[0],1/(n[1]-n[0]));break;case R.INT32:case R.UINT32:{const r=n[0],o=n[1]-r,a=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),l=2**a/o,c=i.uniform(`uLerpBounds_${e}`);t===R.UINT32?s.uniform2ui(c,r,a):s.uniform2i(c,r,a),s.uniform1f(i.uniform(`uLerpScalar_${e}`),l);break}case R.UINT64:{const r=n[0],o=n[1];P.R.absDifference(Mi,o,r);const a=Mi.high>0?32+Math.ceil(Math.log2(Mi.high)):Math.ceil(Math.log2(Mi.low)),l=Math.max(0,a-24);P.R.rshift(Mi,Mi,l);let c=1/Mi.low;P.R.compare(r,o)>0&&(c*=-1);const d=i.uniform(`uLerpBounds_${e}`);s.uniform3ui(d,r.low,r.high,l),s.uniform1f(i.uniform(`uLerpScalar_${e}`),c)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mt(i,e,t){(0,f.MM)(i,e,n=>t.restoreState(n))}class fr extends T.O8{constructor(){super(...arguments),this.children=new Map,this.changed=new j.IY}add(e,t){const{children:n}=this;if(n.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){const{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);const n=t.get(e);this.children.delete(e),n.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){const{changed:e}=this;for(const t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){const e=this.baseJSON();for(const[t,n]of this.children)e[t]=n.toJSON();return e}baseJSON(){return{}}reset(){for(const e of this.children.values())e.reset()}restoreState(e){(0,f.Rf)(e);for(const[t,n]of this.children)try{if(Object.prototype.hasOwnProperty.call(e,t)){const s=e[t];if(s===void 0)continue;n.restoreState(s)}}catch(s){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${s.message}`)}}}class VV extends fr{constructor(){super(...arguments),this.lastState={}}restoreState(e){(0,f.Rf)(e),this.lastState=e,super.restoreState(e)}reset(){this.lastState={},super.reset()}baseJSON(){const e=Object.assign(super.baseJSON(),this.lastState);for(const t of this.children.keys())delete e[t];return e}toJSON(){const e=super.toJSON();return this.lastState=e,e}add(e,t){const n=super.add(e,t),s=this.lastState[e];return s!==void 0&&(t.reset(),t.restoreState(s)),n}}const $p=new WeakMap;function Lo(i){let e=$p.get(i);const t=i.changed.count;if(e!==void 0&&e.generation===t)return e;let n;if(i instanceof fr){n=i.baseJSON();for(const[s,r]of i.children)n[s]=Lo(r).value}else n=i.toJSON();return e===void 0?(e={generation:t,value:n},$p.set(i,e)):(e.generation=t,e.value=n),e}var Oi=G(6703);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ro=(i=>(i[i.LINKED=0]="LINKED",i[i.RELATIVE=1]="RELATIVE",i[i.UNLINKED=2]="UNLINKED",i))(Ro||{}),Gp=(i=>(i[i.LINKED=0]="LINKED",i[i.UNLINKED=2]="UNLINKED",i))(Gp||{});class Ww extends Oi.F{constructor(e=0){super(Ro,e)}}class BV extends Oi.F{constructor(e=0){super(Gp,e)}}const ko=C.eR.create(),zp=C.Yu.create();function gr(i,e,t,n){let s=!1;const r=!1;let o;i.registerDisposer(e);const a=()=>{if(!r){switch(s=!0,t.value){case 2:if(n.isValid(i))break;case 0:n.assign(i,e);break;case 1:n.add(i,e,o);break}s=!1}},l=()=>{if(!s)switch(t.value){case 2:break;case 0:n.assign(e,i);break;case 1:n.subtract(e,i,o);break}};let c=2;const d=()=>{const u=t.value;if(u!==c)switch(u){case 2:o=void 0;break;case 0:o=void 0,n.assign(i,e);break;case 1:o=n.difference(i,e);break}c=u,i.changed.dispatch()};return i.registerDisposer(i.changed.add(l)),i.registerDisposer(e.changed.add(a)),i.registerDisposer(t.changed.add(d)),d(),i}function Wp(i,e,t,n){return gr(i,e,t,n)}class ui extends T.O8{constructor(e){super(),this.coordinateSpace=e,this.coordinates_=ps,this.changed=new j.IY,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=ps,this.changed.dispatch()}set value(e){const{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;const{coordinates_:n}=this;n.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const{rank:n}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:d}=this;if(!(d!==void 0&&d.length===n)){d=this.coordinates_=new Float32Array(n),bC(d,e.bounds);const{voxelCenterAtIntegerCoordinates:u}=e.bounds;for(let h=0;h<n;++h)u[h]?d[h]=Math.round(d[h]):d[h]=Math.floor(d[h])+.5}this.changed.dispatch();return}const s=new Float32Array(n),r=this.coordinates_,{ids:o,scales:a}=e,{ids:l,scales:c}=t;for(let d=0;d<n;++d){const u=o[d],h=l.indexOf(u);h===-1?s[d]=Vh(e.bounds.lowerBounds[d],e.bounds.upperBounds[d]):s[d]=r[h]*(c[h]/a[d])}this.coordinates_=s,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();const{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from((0,f.$v)(e,f.zo)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();const{bounds:{voxelCenterAtIntegerCoordinates:e}}=this.coordinateSpace.value,{coordinates_:t}=this,n=t.length;for(let s=0;s<n;++s)e[s]?t[s]=Math.round(t[s]):t[s]=Math.floor(t[s])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();const{curCoordinateSpace:t,coordinates_:n}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(n),this.changed.dispatch()}static getOffset(e,t){const n=e.coordinates_,s=t.coordinates_;if(n.length===s.length)return Ul(new Float32Array(n.length),n,s)}static addOffset(e,t,n,s=1){e.handleCoordinateSpaceChanged();const{value:r}=t;n!==void 0&&r.length===n.length&&(cC(e.value,r,n,s),e.changed.dispatch())}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}(0,f.Rf)(t),Mt(t,"voxelCoordinates",e)}}}}var Gn=(i=>(i[i.STOP=0]="STOP",i[i.LOOP=1]="LOOP",i[i.REVERSE=2]="REVERSE",i))(Gn||{});const Hp=10;class fc{constructor(){this.velocity=Hp,this.atBoundary=2,this.paused=!0}}function Hw(i,e){return i.velocity===e.velocity&&i.atBoundary===e.atBoundary&&i.paused===e.paused}function Jw(i){return(0,f.Rf)(i),{velocity:(0,f.MM)(i,"velocity",f.zo,Hp),atBoundary:(0,f.MM)(i,"atBoundary",e=>(0,f.sl)(e,Gn),0),paused:(0,f.MM)(i,"paused",f.aO,!0)}}function jw(i){const{velocity:e,atBoundary:t,paused:n}=i;return{velocity:e,atBoundary:t===0?void 0:Gn[t].toLowerCase(),paused:n?void 0:!1}}class gc extends T.O8{constructor(e){super(),this.coordinateSpace=e,this.changed=new j.IY,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()})),this.curCoordinateSpace=e.value,this.velocities_=new Array(this.curCoordinateSpace?.rank??0)}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.velocities_}set value(e){const{curCoordinateSpace:t}=this;t===void 0||t.rank!==e.length||(this.velocities_=e,this.changed.dispatch())}get(e){const t=this.coordinateSpace.value?.ids;if(t===void 0)return;const n=t.indexOf(e);return n===-1?void 0:this.value[n]}dimensionVelocity(e,t){const n=new j.IY;let s=-1;const r=()=>{const c=this.coordinateSpace.value?.ids;c===void 0?s=-1:(s===-1||c[s]!==t)&&(s=c.indexOf(t))},o=()=>{if(r(),s!==-1)return this.value[s]},a=c=>{if(r(),s===-1)return;const d=this.value;d[s]!==c&&(d[s]=c,this.changed.dispatch())},l=o();return e.registerDisposer(this.changed.add(()=>{o()!==l&&n.dispatch()})),{get value(){return o()},set value(c){a(c)},changed:n}}modifyDimension(e,t){const n=this.coordinateSpace.value?.ids;if(n===void 0)return;const s=n.indexOf(e);if(s===-1)return;const r=this.value,o=r[s],a=t(o);o!==a&&(r[s]=a,this.changed.dispatch())}togglePlayback(e,t=void 0){this.modifyDimension(e,(n=new fc)=>({...n,paused:t??!n.paused}))}playbackEnabled(e){const t=this;return{changed:this.changed,get value(){return t.get(e)!==void 0},set value(n){t.modifyDimension(e,s=>n?s??new fc:void 0)}}}multiplyVelocity(e,t){this.modifyDimension(e,(n=new fc)=>{let s=Math.round(n.velocity*t);return s===0&&(s=Math.sign(n.velocity)||1),{...n,velocity:s}})}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const{rank:n}=e;if(!e.valid)return;if(t===void 0){let{velocities_:l}=this;l.length===n||(l=new Array(n)),this.changed.dispatch();return}const s=new Array(n),r=this.velocities_,{ids:o}=e,{ids:a}=t;for(let l=0;l<n;++l){const c=o[l],d=a.indexOf(c);d!==-1&&(s[l]=r[d])}this.velocities_=s,this.changed.dispatch()}toJSON(){this.handleCoordinateSpaceChanged();const{velocities_:e,curCoordinateSpace:t}=this;if(!t?.valid||!e.some(o=>o!==void 0))return;const n={},{names:s,rank:r}=t;for(let o=0;o<r;++o){const a=e[o];a!==void 0&&(n[s[o]]=jw(a))}return n}reset(){this.handleCoordinateSpaceChanged(),this.velocities_=new Array(this.curCoordinateSpace?.rank??0)}restoreState(e){if(e===void 0){this.reset();return}(0,f.Rf)(e);const t=this.curCoordinateSpace=this.coordinateSpace.value;if(this.velocities_=new Array(t?.rank??0),t===void 0)throw new Error("Must specify dimensions in order to specify velocities");const n=this.velocities_=new Array(t?.rank??0),{names:s}=t;for(const r of Object.keys(e)){const o=s.indexOf(r);if(o===-1)throw new Error(`Invalid dimension name: ${JSON.stringify(r)}`);n[o]=(0,f.cQ)(e,r,Jw)}this.changed.dispatch()}assign(e){const t=e.value,n=this.value,s=n.length;let r=!1;for(let o=0;o<s;++o){const a=t[o],l=n[o];a!==l&&((l===void 0||a===void 0||!Hw(l,a))&&(r=!0),n[o]=a)}r&&this.changed.dispatch()}}class Yw extends T.O8{constructor(e,t){super(),this.peer=e,this.positionLink=t,this.changed=new j.IY,this.velocity=this.registerDisposer(new gc(this.peer.coordinateSpace)),this.registerDisposer(e),this.velocity.changed.add(()=>{this.positionLink.value===2?this.changed.dispatch():this.peer.assign(this.velocity)});const n=()=>{this.positionLink.value!==2&&this.velocity.assign(this.peer)};this.registerDisposer(e.changed.add(n)),n()}toJSON(){if(this.positionLink.value===2)return this.velocity.toJSON()}reset(){this.positionLink.value===2&&this.velocity.reset()}restoreState(e){this.positionLink.value===2&&this.velocity.restoreState(e)}copyToPeer(){this.positionLink.value===2&&this.peer.assign(this.velocity)}}class mc extends T.O8{constructor(e,t,n){super(),this.display=e,this.position=t,this.velocity=n,this.dimensionStates=new Map,this.lastUpdateGeneration=0,this.handleVelocityChanged(),this.registerDisposer(n.changed.add(()=>this.handleVelocityChanged()))}disposed(){this.unregisterUpdateStartedCallback?.(),super.disposed()}handleVelocityChanged(){const{dimensionStates:e}=this,t=this.position.coordinateSpace.value?.ids??[],n=t.length,s=this.velocity.value,r=++this.lastUpdateGeneration,o=this.position.value,a=Date.now();for(let l=0;l<n;++l){const c=s[l];if(c===void 0||c.velocity===0||c.paused)continue;const d=t[l],u=e.get(d);u===void 0?e.set(d,{prevTime:a,dimensionIndex:l,prevCoordinate:o[l],generation:r}):(u.generation=r,u.dimensionIndex=l)}for(const[l,c]of e)c.generation!==r&&e.delete(l);if(e.size===0){const{unregisterUpdateStartedCallback:l}=this;l!==void 0&&(l(),this.unregisterUpdateStartedCallback=void 0)}else this.unregisterUpdateStartedCallback===void 0&&(this.unregisterUpdateStartedCallback=this.display.updateStarted.add(()=>this.updateStarted()),this.display.scheduleRedraw())}updateStarted(){const e=this.position.coordinateSpace.value;if(e===void 0)return;const t=e.ids,n=this.position.value;let s=!1,r=!1;const o=Date.now(),a=this.velocity.value,{bounds:{lowerBounds:l,upperBounds:c}}=e;for(const[d,u]of this.dimensionStates){const{dimensionIndex:h}=u;if(t[h]!==d)continue;const p=a[h];if(Math.floor(n[h])!==Math.floor(u.prevCoordinate)){p?.paused===!1&&(a[h]={...p,paused:!0},r=!0);continue}const m=o-u.prevTime,g=p?.velocity??0,v=m*g/1e3;if(v===0)continue;let y=n[h]+v;const S=l[h],w=Math.ceil(c[h]-1),b=v>0?w:S,x=v>0?S:w,E=Math.sign(v);if(Number.isFinite(b)&&y*E>=b*E)switch(p.atBoundary){case 1:if(Number.isFinite(x)){y=x;break}case 0:a[h]={...p,paused:!0},r=!0,y=b;break;case 2:a[h]={...p,velocity:-g},r=!0,y=b;break}n[h]=y,u.prevCoordinate=n[h],u.prevTime=o,s=!0}s&&this.position.changed.dispatch(),r&&this.velocity.changed.dispatch(),this.display.scheduleRedraw()}}function Jp(i,e,t){if(t===void 0||Object.keys(t).length===0){i.value=0;return}(0,f.Rf)(t),i.value=2,(0,f.cQ)(t,"value",n=>{n!==void 0&&e.restoreState(n)}),(0,f.cQ)(t,"link",n=>i.restoreState(n))}class mr{constructor(e,t=new Ww){this.peer=e,this.link=t}get changed(){return this.value.changed}toJSON(){const{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){Jp(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}}class jp extends mr{}class Yp extends mr{constructor(){super(...arguments),this.value=gr(new ui(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:ui.getOffset,add:ui.addOffset,subtract:(e,t,n)=>{ui.addOffset(e,t,n,-1)}})}}function Qw(i){return i[0]===0&&i[1]===0&&i[2]===0&&i[3]===1}class bs extends T.O8{constructor(e){super(),this.changed=new j.IY,e==null&&(e=C.Yu.create()),this.orientation=e}toJSON(){const{orientation:e}=this;if(C.Yu.normalize(this.orientation,this.orientation),!Qw(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{(0,f.Vr)(this.orientation,e),C.Yu.normalize(this.orientation,this.orientation)}catch{C.Yu.identity(this.orientation)}this.changed.dispatch()}reset(){C.Yu.identity(this.orientation),this.changed.dispatch()}snap(){const e=C.w0.create();C.w0.fromQuat(e,this.orientation);const t=[!1,!1,!1];for(let n=0;n<3;++n){let s=0,r=0;for(let o=0;o<3;++o){const a=e[n*3+o];e[n*3+o]=0,!t[o]&&Math.abs(a)>Math.abs(s)&&(s=a,r=o)}e[n*3+r]=Math.sign(s),t[r]=!0}C.Yu.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){const n=new bs(C.Yu.multiply(C.Yu.create(),e.orientation,t));let s=!1;n.registerDisposer(e.changed.add(()=>{s||(r=!0,C.Yu.multiply(n.orientation,e.orientation,t),n.changed.dispatch(),r=!1)}));let r=!1;const o=C.Yu.invert(C.Yu.create(),t);return n.registerDisposer(n.changed.add(()=>{r||(s=!0,C.Yu.multiply(e.orientation,n.orientation,o),e.changed.dispatch(),s=!1)})),n}assign(e){C.Yu.copy(this.orientation,e.orientation),this.changed.dispatch()}}class vc extends mr{constructor(){super(...arguments),this.value=gr(new bs,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{const n=C.Yu.create();return C.Yu.multiply(n,C.Yu.invert(n,t.orientation),e.orientation)},add:(e,t,n)=>{C.Yu.multiply(e.orientation,t.orientation,n),e.changed.dispatch()},subtract:(e,t,n)=>{C.Yu.multiply(e.orientation,t.orientation,C.Yu.invert(zp,n)),e.changed.dispatch()}})}}class Qp extends T.O8{constructor(e){super(),this.coordinateSpace=e,this.changed=new j.IY,this.curCoordinateSpace=Fn,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Fn,this.changed.dispatch()}toJSON(){const e={};let t=!1;const{value:n}=this,{factors:s}=n,{names:r,rank:o}=this.curCoordinateSpace;for(let a=0;a<o;++a){const l=s[a];l!==1&&(e[r[a]]=l,t=!0)}if(t)return e}restoreState(e){const{coordinateSpace:{value:t}}=this,{names:n,rank:s}=t,r=new Float64Array(s);if(r.fill(-1),e!==void 0){const o=(0,f.Rf)(e);for(let a=0;a<s;++a)r[a]=(0,f.cQ)(o,n[a],l=>l===void 0?1:(0,f.Mo)(l))}this.value_={factors:r},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){const{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){const{coordinateSpace:{value:e}}=this;let t=this.value_;const{curCoordinateSpace:n}=this;if(n===e)return t;const{ids:s}=n,{ids:r,rank:o}=e,a=t.factors,l=new Float64Array(o);l.fill(1);for(let c=0;c<o;++c){const d=r[c],u=s.indexOf(d);u!==-1&&(l[c]=a[u])}return(0,F.r1)(l,a)||(t=this.value_={factors:l},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function Kp(i,e,t,n,s){if(t===n)return e;const{ids:r}=t,{rank:o,ids:a}=n,l=new i(o);for(let c=0;c<o;++c){const d=a[c],u=r.indexOf(d);l[c]=u===-1?s(c):e[u]}return l}class Kw extends mr{constructor(){super(...arguments),this.value=gr(new Qp(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{const{factors:n}=e.value,s=e.coordinateSpace.value,r=t.value.factors;return{coordinateSpace:s,offsets:Ul(new Float64Array(n.length),n,r)}},add:(e,t,n)=>{const s=Kp(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Ah(new Float64Array(s.length),s,t.value.factors))},subtract:(e,t,n)=>{const s=Kp(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Ul(new Float64Array(s.length),t.value.factors,s))},isValid:()=>!0})}}function qp(i,e,t){const{rank:n,names:s,units:r}=i,{displayRank:o,displayDimensionIndices:a}=e,l=new Float64Array(3),c=new Float64Array(3);let d;const{factors:u}=t,h=new Array(3),p=new Float64Array(3);if(l.fill(1),c.fill(1),p.fill(1),h.fill(""),o===0)d=1;else{d=Number.POSITIVE_INFINITY;const{scales:m}=i;for(let g=0;g<o;++g){const v=a[g],y=c[g]=u[v]*m[v];d=Math.min(d,y),h[g]=r[v],p[g]=m[v]}for(let g=0;g<o;++g)l[g]=c[g]/d}return{globalRank:n,globalDimensionNames:s,displayRank:o,displayDimensionIndices:a,displayDimensionUnits:h,displayDimensionScales:p,canonicalVoxelFactors:l,voxelPhysicalScales:c,canonicalVoxelPhysicalSize:d}}function Xp(i,e){return(0,F.r1)(i.globalDimensionNames,e.globalDimensionNames)&&(0,F.r1)(i.displayDimensionIndices,e.displayDimensionIndices)&&(0,F.r1)(i.canonicalVoxelFactors,e.canonicalVoxelFactors)&&(0,F.r1)(i.voxelPhysicalScales,e.voxelPhysicalScales)&&i.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&(0,F.r1)(i.displayDimensionUnits,e.displayDimensionUnits)&&(0,F.r1)(i.displayDimensionScales,e.displayDimensionScales)}function qw(i,e){const t=i.displayDimensionRenderInfo;return t===e?!0:Xp(t,e)?(i.displayDimensionRenderInfo=e,!0):!1}class Zp extends T.O8{constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new j.IY,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=qp(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);const n=()=>{this.value};this.registerDisposer(e.changed.add(n)),this.registerDisposer(t.changed.add(n))}get value(){const{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:n},curRelativeDisplayScales:s,curDisplayDimensions:r,curCoordinateSpace:o}=this;let a=this.value_;if(s!==e||r!==n||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=n,this.curCoordinateSpace=t;const l=qp(t,n,e);Xp(a,l)||(this.value_=a=l,this.changed.dispatch())}return a}}class ef extends T.O8{constructor(e){super(),this.coordinateSpace=e,this.changed=new j.IY,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){const{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}const n=new Int32Array(3),{ids:s}=t.coordinateSpace,{ids:r}=e,o=t.displayDimensionIndices,a=t.displayRank;let l=0;for(let c=0;c<a;++c){const d=r.indexOf(s[o[c]]);d!==-1&&(n[l]=d,++l)}if(n.fill(-1,l),l===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,l,n),this.changed.dispatch()}setToDefault(e){const t=Math.min(e.rank,3),n=new Int32Array(3);n.fill(-1);for(let s=0;s<t;++s)n[s]=s;this.assignValue(e,t,n)}assignValue(e,t,n){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:n},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}const t=Yl(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");const{coordinateSpace:{value:n}}=this,s=new Int32Array(3);s.fill(-1);const{names:r}=n;let o=0;for(const a of t){const l=r.indexOf(a);l!==-1&&(s[o++]=l)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(n,o,s)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;const{value:e}=this,t=[],{displayRank:n,displayDimensionIndices:s,coordinateSpace:{names:r}}=e;if(n!==0){for(let o=0;o<n;++o)t[o]=r[s[o]];return t}}assign(e){if(e.default)this.default=!0;else{const{displayRank:t,displayDimensionIndices:n}=e.value;this.setDimensionIndices(t,n)}}}class Xw extends jp{constructor(){super(...arguments),this.value=Wp(new ef(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}}class Cs extends T.O8{constructor(e,t,n){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=n,this.changed=new j.IY,this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(n.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=ko){const{coordinateSpace:{value:n},value:s}=this.position,{displayDimensionIndices:r,displayRank:o}=this.displayDimensions.value;if(n===void 0)return!1;t.fill(0);for(let a=0;a<o;++a){const l=r[a];t[a]=s[l]}if(e(t)!==!1){for(let a=0;a<o;++a){const l=r[a];s[l]=t[a]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){C.pB.fromQuat(e,this.orientation.orientation);const{value:n}=this.position,{canonicalVoxelFactors:s,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){const a=r[o],l=t/s[o];e[o]*=l,e[4+o]*=l,e[8+o]*=l,e[12+o]=n[a]||0}}toMat3(e,t){C.w0.fromQuat(e,this.orientation.orientation);const{canonicalVoxelFactors:n,displayRank:s}=this.displayDimensionRenderInfo.value;for(let r=0;r<s;++r){const o=t/n[r];e[r]*=o,e[3+r]*=o,e[6+r]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;const{position:n}=this,{value:s}=n,{bounds:r}=n.coordinateSpace.value;s[e]=Wl(r,e,s[e]+t),n.changed.dispatch()}translateVoxelsRelative(e){if(!this.valid)return;const t=C.eR.transformQuat(ko,e,this.orientation.orientation),{position:n}=this,{value:s}=n,{displayDimensionIndices:r,displayRank:o}=this.displayDimensions.value,{bounds:a}=n.coordinateSpace.value;for(let l=0;l<o;++l){const c=r[l],d=t[l];d!==0&&(s[c]=Wl(a,c,s[c]+d))}this.position.changed.dispatch()}rotateRelative(e,t){const n=C.Yu.create();C.Yu.setAxisAngle(n,e,t);const s=this.orientation.orientation;C.Yu.multiply(s,s,n),this.orientation.changed.dispatch()}rotateAbsolute(e,t,n){const{coordinateSpace:{value:s},value:r}=this.position;if(s===void 0)return;const{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:a,displayRank:l}}}=this,{scales:c}=s,d=C.Yu.create();C.Yu.setAxisAngle(d,e,t);const u=this.orientation.orientation,h=ko;ko.fill(0);for(let m=0;m<l;++m){const g=a[m],v=n[g]-r[g];h[m]=v*c[g]*o[g]}const p=C.Yu.invert(zp,u);C.eR.transformQuat(h,h,p),C.Yu.multiply(u,d,u),C.eR.transformQuat(h,h,u);for(let m=0;m<l;++m){const g=a[m];r[g]=n[g]-h[m]/(c[g]*o[g])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;const{displayDimensionIndices:n}=this.displayDimensions.value,{position:s}=this,r=s.coordinateSpace.value.rank;for(let o=0;o<r;++o)if(n.indexOf(o)===-1&&e--===0){this.translateDimensionRelative(o,t);return}}}class yc extends mr{constructor(e,t){super(e),this.value=(()=>{const n=new e.constructor(t),s=(c,d)=>{c.assign(d)},r=(c,d)=>c.value/d.value*(c.canonicalVoxelPhysicalSize/d.canonicalVoxelPhysicalSize),o=(c,d,u)=>{c.setPhysicalScale(d.value*u,d.canonicalVoxelPhysicalSize)},a=(c,d,u)=>{c.setPhysicalScale(d.value/u,d.canonicalVoxelPhysicalSize)},l=c=>c.coordinateSpaceValue.valid&&c.canonicalVoxelPhysicalSize!==0;return gr(n,this.peer,this.link,{assign:s,isValid:l,difference:r,add:o,subtract:a}),n})()}}function vr(i){return{changed:i.changed,toJSON(){return i.toJSON()},restoreState(e){Jp(i.link,i.value.legacyJsonView,e)},reset(){i.reset()}}}class tf extends T.O8{constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new j.IY,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){const{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){const{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:n}}}}=this,{curCanonicalVoxelPhysicalSize:s}=this;if(!(!Number.isNaN(e)&&t===s)){if(!Number.isNaN(e)){s!==0&&(this.value_=e*(s/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!n.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){const{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=(0,f.Mo)(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=(0,f.Mo)(t)}}}setPhysicalScale(e,t){const n=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/n)}assign(e){const{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class Zw extends tf{getDefaultValue(){const{legacyValue_:e}=this;if(Number.isNaN(e))return 1;const{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}}class ex extends tf{getDefaultValue(){const{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;const{canonicalVoxelPhysicalSize:a}=this;return 200*Math.tan(Math.PI/8)*1e-9*e/a}const{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:n}}}=this,{canonicalVoxelFactors:s,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value;let o=s.reduce((a,l,c)=>{const d=r[c],u=(n[d]-t[d])*l;return Math.max(a,u)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}}class Sc extends T.O8{constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new j.IY,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){const{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,n=this.canonicalVoxelPhysicalSize;t!==n&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=n/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;const{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){const{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){const{canonicalVoxelPhysicalSize:n}=this.displayDimensionRenderInfo.value;e=e*(t/n)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class nf extends jp{constructor(e,t){super(e),this.value=Wp(new Sc(e.defaultValue,t),this.peer,this.link,{assign:(n,s)=>n.assign(s),isValid:()=>!0})}}class ws extends T.O8{constructor(e,t,n){super(),this.pose=e,this.zoomFactor=t,this.depthRange=n,this.changed=new j.IY,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(n),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tx{constructor(e){if(this.parents=new Array,this.parentPriorities=new Array,this.bindings=new Map,e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(const[t,n]of e.bindings)this.bindings.set(t,n)}}addParent(e,t){const{parents:n,parentPriorities:s}=this;let r=0;const{length:o}=n;for(;r<o&&t<s[r];)++r;return n.splice(r,0,e),s.splice(r,0,t),()=>{this.removeParent(e)}}removeParent(e){const t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){const{parents:t,parentPriorities:n}=this,s=n.length;let r=0,o;for(;r<s&&n[r]>0;++r)if(o=t[r].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;r<s;++r)if(o=t[r].get(e),o!==void 0)return o}*getAll(e){const{parents:t,parentPriorities:n}=this,s=n.length,r=0;let o;for(;r<s&&n[r]>0;)o=t[r].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);r<s;)o=t[r].get(e),o!==void 0&&(yield o)}*entries(){const{parents:e,parentPriorities:t}=this,n=t.length;let s=0;for(;s<n&&t[s]>0;++s)yield*e[s].entries();for(yield*this.bindings.entries();s<n;++s)yield*e[s].entries()}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var sf=(i=>(i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT",i))(sf||{});function bc(i){return(i.ctrlKey?1:0)|(i.altKey?2:0)|(i.metaKey?4:0)|(i.shiftKey?8:0)}function Cc(i,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=i,t}function nx(i,e,t){let n="";return e&1&&(n+="control+"),t&1&&(n+="control?+"),e&2&&(n+="alt+"),t&2&&(n+="alt?+"),e&4&&(n+="meta+"),t&4&&(n+="meta?+"),e&8&&(n+="shift+"),t&8&&(n+="shift?+"),n+=i,n}function rf(i){const e=i.indexOf(":");let t;if(e!==-1&&(t=i.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);const n=i.substring(e+1).split("+");let s,r=0,o=0;e:for(const a of n)switch(a){case"control":r|=1;break;case"control?":o|=1;break;case"alt":r|=2;break;case"alt?":o|=2;break;case"meta":r|=4;break;case"meta?":o|=4;break;case"shift":r|=8;break;case"shift?":o|=8;break;default:if(s===void 0)s=a;else{s=void 0;break e}}if(s===void 0||r&o)throw new Error(`Invalid event identifier: ${JSON.stringify(i)}`);return{phase:t,keyName:s,modifiers:r,optionalModifiers:o}}function*ix(i,e,t){t===0&&(yield Cc(i,e));for(let n=0;n<16;++n)(n&(e|t))===n&&(n&e)===e&&(yield Cc(i,n))}function*of(i){const{phase:e}=i,t=ix(i.keyName,i.modifiers,i.optionalModifiers);if(e===void 0)for(const n of t)yield`at:${n}`,yield`bubble:${n}`;else for(const n of t)yield`${e}:${n}`}function sx(i,e){const t=nx(i.keyName,i.modifiers,i.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}function rx(i){return i=i.replace(/^(?:at|bubble|capture)|(?:(?:shift|control|alt|meta)\?\+)/g,""),i}class Ae extends tx{static fromObject(e,t={}){const n=new Ae;if(n.label=t.label,t.parents!==void 0)for(const[s,r]of t.parents)n.addParent(s,r);for(const s of Object.keys(e))n.set(s,e[s]);return n}setFromObject(e){for(const t of Object.keys(e))this.set(t,e[t])}set(e,t){const n=rf(e),s=sx(n,t);for(const r of of(n))super.set(r,s)}delete(e){for(const t of of(rf(e)))super.delete(t)}describe(){const e=[],t=new Map;for(const[,s]of this.entries())t.set(s.originalEventIdentifier,s.action);const n=new Map;for(const[s,r]of t){let o=n.get(r);o===void 0&&(o=[],n.set(r,o)),o.push(rx(s))}for(const[s,r]of n){const o=r.length===1?r[0]:`{${r.join(",")}}`;e.push(`${o}\u2192${s}`)}return e.join(", ")}}function af(i,e,t){if(t===void 0)return;t.stopPropagation!==!1&&i.stopPropagation();const n=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),s=!i.target.dispatchEvent(n);(t.preventDefault!==!1||s)&&i.preventDefault()}const Po=[];Po[Event.AT_TARGET]="at",Po[Event.CAPTURING_PHASE]="capture",Po[Event.BUBBLING_PHASE]="bubble";function lf(i,e,t,n,s){const r=Po[t]+":"+i,o=s.get(r);af(e,n,o)}function cf(i,e,t,n){lf(Cc(i,bc(e)),e,e.eventPhase,t,n)}function Z(i,e,t,n){return(0,T.K6)(i,`action:${e}`,t,n)}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tn extends T.O8{constructor(e,t,n){super(),this.target=e,this.eventMap=t,this.shouldIgnore=void 0,this.registerEventListener(e,"wheel",s=>{n!==void 0&&n(s),this.dispatch("wheel",s)}),this.registerEventListener(e,"click",s=>{n!==void 0&&n(s),this.dispatch(`click${s.button}`,s)}),this.registerEventListener(e,"dblclick",s=>{n!==void 0&&n(s),this.dispatch(`dblclick${s.button}`,s)}),this.registerEventListener(e,"mousedown",s=>{n!==void 0&&n(s);let r=s.button;r===2&&(s.buttons&3)===1&&(r=0),this.dispatch(`mousedown${r}`,s)}),this.registerEventListener(e,"mouseup",s=>{n!==void 0&&n(s),this.dispatch(`mouseup${s.button}`,s)})}dispatch(e,t){this.shouldIgnore?.(t)||cf(e,t,t,this.eventMap)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zt(i,e,t){const{document:n}=i.view;let s=i.clientX,r=i.clientY;const o=d=>{const u=d.clientX-s,h=d.clientY-r;s=d.clientX,r=d.clientY,e(d,u,h)},a=i.button,l=d=>{n.removeEventListener("pointermove",o,!0),n.removeEventListener("pointerup",c,!1),t!==void 0&&t(d,d.clientX-s,d.clientY-r)},c=d=>{d.button===a&&l(d)};n.addEventListener("pointermove",o,!0),n.addEventListener("pointerup",c,!1),n.addEventListener("pointercancel",l,!1)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ox=0,ax=1,lx=2;function _i(i){let e=0;const{deltaMode:t}=i;switch(t){case ox:e=.005;break;case ax:e=.1;break;case lx:e=2;break}return Math.exp(i.deltaY*e)}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const yr=6,FV=2,wc=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function Ao(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,yr*e,t)}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ut=yr;function In(i,e=!1){i.addVertexCode(wc),i.addUniform("highp vec3","uLineParams"),i.addVarying("highp float","vLineCoord"),i.addVarying("highp float","vLineFeatherFraction"),e&&(i.addVarying("highp float","vEndpointFraction"),i.addVarying("highp float","vLineCoordT"),i.addVarying("highp float","vLineBorderStartFraction")),i.addVertexCode(Aw),i.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&i.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),i.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function mn(i,e,t){Ao(i,e,t)}function vn(i,e,t){const{gl:n}=i;n.uniform3f(i.uniform("uLineParams"),1/e.width,1/e.height,t)}/**
 * @license
 * Copyright 2024 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function df(i,e=-1,t=1,n=1,s=-1){const r=new Float32Array(i*yr*2),o=(t-e)/i;let a=e;for(let l=0;l<i;++l){const c=l*yr*2;r[c]=a,r[c+1]=n,r[c+2]=a+o,r[c+3]=n,r[c+4]=a+o,r[c+5]=s,r[c+6]=a,r[c+7]=n,r[c+8]=a+o,r[c+9]=s,r[c+10]=a,r[c+11]=s,a+=o}return r}function UV(i,e,t=-1,n=1,s=1,r=-1){return getMemoizedBuffer(i,WebGL2RenderingContext.ARRAY_BUFFER,df,e,t,n,s,r).value}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mo(i,e,t,n){e*=6;const s=Math.floor(e),r=e-s,o=n*(1-t),a=n*(1-t*r),l=n*(1-t*(1-r));switch(s%6){case 0:i[0]=n,i[1]=l,i[2]=o;break;case 1:i[0]=a,i[1]=n,i[2]=o;break;case 2:i[0]=o,i[1]=n,i[2]=l;break;case 3:i[0]=o,i[1]=a,i[2]=n;break;case 4:i[0]=l,i[1]=o,i[2]=n;break;case 5:i[0]=n,i[1]=o,i[2]=a;break}return i}function cx(i,e,t,n){const s=Math.max(Math.max(e,t),n),r=Math.min(Math.min(e,t),n);if(i[2]=s,r===s)i[0]=0,i[1]=0;else{const o=s-r;i[1]=o/s,e===s?i[0]=(t-n)/o:t===s?i[0]=2+(n-e)/o:i[0]=4+(e-t)/o,i[0]/=6,i[0]<0&&(i[0]+=1),i[0]>1&&(i[0]-=1)}return i}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hi extends T.O8{constructor(e,t=()=>C.eR.fromValues(1,0,0),n=hi.template(),s=()=>{},r=!0){super(),this.model=e,this.getDefaultColor=t,this.element=n,this.unsetHandler=s,n.addEventListener("change",()=>this.updateModel()),n.addEventListener("input",()=>this.updateModel()),r&&n.addEventListener("wheel",o=>{o.stopPropagation(),o.preventDefault(),this.adjustHueViaWheel(o)}),n.addEventListener("mousedown",o=>{o.button===2&&(o.stopPropagation(),s())}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}static template(){const e=document.createElement("input");return e.classList.add("neuroglancer-color-widget"),e.type="color",e}getRGB(){return this.model.value??this.getDefaultColor()}updateView(){this.element.value=Ge(this.getRGB())}updateModel(){this.model.value=me(this.element.value)}adjustHueViaWheel(e){const t=this.getRGB(),n=C.eR.create();cx(n,t[0],t[1],t[2]);const{deltaY:s}=e;let r=Math.round(n[0]*256);r+=s>0?1:s<0?-1:0,r=(r+256)%256,n[0]=r/256,Mo(n,n[0],n[1],n[2]),this.model.value=n}}var uf=G(2104),hf=G(2809);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Me(i){for(;;){const e=i.firstChild;if(!e)break;i.removeChild(e)}}function at(i){const{parentElement:e}=i;return e?(e.removeChild(i),!0):!1}function $t(i,e=Math.max(1,i.value.length)){const t=`${e}ch`;i.style.width!==t&&(i.style.width="0px",i.offsetWidth,i.style.width=t)}function nn(i,e){let t=i.firstElementChild;for(const n of e)n!==t&&i.insertBefore(n,t),t=n.nextElementSibling;for(;t!==null;){const n=t.nextElementSibling;i.removeChild(t),t=n}}function xc(i){return i instanceof HTMLElement?!!(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement||i.isContentEditable):!1}function dx(i){const e=i.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $V(i){const e=Ne(i);return i.svgHover&&(e.classList.add("neuroglancer-icon-hover"),e.innerHTML+=i.svgHover),e}function Ne(i){const{title:e,onClick:t,href:n}=i;let s;n!==void 0?(s=document.createElement("a"),s.href=n,s.target="_blank"):s=document.createElement("div"),e!==void 0&&(s.title=e),t!==void 0&&s.addEventListener("click",t);const{svg:r}=i;return s.className="neuroglancer-icon",r!==void 0&&(s.innerHTML=r),i.text!==void 0&&s.appendChild(document.createTextNode(i.text)),s}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gt extends T.O8{constructor(e=new vt(vt.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div");const{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){at(this.element),super.disposed()}}class ux extends T.O8{constructor(){super(...arguments),this.changed=new j.IY,this.options=new Map,this.optionsChanged=new j.IY,this.selectedValue=void 0,this.defaultValue=void 0,this.ready_=!0}get value(){const{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);const{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){const e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){const{options:n}=this;if(n.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);n.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}remove(e){const{options:t}=this;if(!t.has(e))throw new Error(`Option is not defined: ${JSON.stringify(e)}.`);t.delete(e),this.optionsChanged.dispatch()}toJSON(){const{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}}class hx extends T.O8{constructor(e,t,n=new vt(vt.VISIBLE),s=!1){super(),this.getter=e,this.selected=t,this.visibility=n,this.invalidateByDefault=s,this.element=document.createElement("div"),this.tabs=new Map,this.tabVisibilityChanged=new j.HN,this.debouncedUpdateSelectedTab=this.registerCancellable((0,Qe.t)(()=>this.updateSelectedTab()));const{element:r}=this;r.className="neuroglancer-stack-view",this.registerDisposer(n.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){const{tabs:t}=this,n=t.get(e);n!==void 0&&(n.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){const t=this.tabs.get(e);t!==void 0&&(t.visibility.value=vt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){const{tabs:t}=this;let n=t.get(e);n===void 0&&(n=this.getter(e),this.element.appendChild(n.element),t.set(e,n)),n.element.style.display="",n.visibility.value=vt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){const{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){const{tabs:t}=this;for(const[n,s]of t)e?.(n)||(t.delete(n),s.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),at(this.element),super.disposed()}}class px extends ux{}function fx(i,e){const t="neuroglancer-selected-tab-label";e?i.classList.add(t):i.classList.remove(t)}class gx extends T.O8{constructor(e,t=new vt(vt.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new Map,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable((0,Qe.t)(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;const{element:n,tabBar:s}=this;n.className="neuroglancer-tab-view",s.className="neuroglancer-tab-view-bar",n.appendChild(s),this.registerDisposer(t.changed.add(this.debouncedUpdateView));const r=this.stack=this.registerDisposer(new hx(e.makeTab,e.selectedTab,this.visibility));n.appendChild(r.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView));let o=this.selectedTab.value;this.registerDisposer(e.selectedTab.changed.add(()=>{this.tabs.value.find(({id:c})=>c===o)?.hidden?(this.tabs.changed.count++,this.debouncedUpdateView()):this.updateTabLabelStyles(),o=this.selectedTab.value})),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){const e=this.selectedTab.value;for(const[t,n]of this.tabLabels)fx(n,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{const e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:n})=>n===t)!==void 0)}Me(this.tabBar),this.tabsGeneration=-1}}makeTabs(){const{tabBar:e,tabLabels:t,handleTabElement:n}=this;for(const{id:s,label:r,hidden:o}of this.tabs.value){if(o&&s!==this.selectedTab.value)continue;const a=document.createElement("div");a.classList.add("neuroglancer-tab-label"),a.textContent=r,a.addEventListener("click",()=>{this.selectedTab.value=s}),n!==void 0&&n(s,a),t.set(s,a),e.appendChild(a)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Me(this.tabBar),this.tabLabels.clear(),at(this.element),super.disposed()}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pf=Ae.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});function ff(i,e){const t=new fn(i);return In(t),t.addTextureSampler("sampler2D","uHistogramSampler",e),t.addOutputBuffer("vec4","out_color",0),t.addAttribute("uint","aDataValue"),t.addUniform("float","uBoundsFraction"),t.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),t.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${pi-1} ? cumSum : total;
if (dataValue == ${pi-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),t.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),t.build()}class gf extends T.O8{constructor(e,t,n,s){super(),this.element=e,this.dataType=t,this.getModel=n,this.setModel=s,e.title=pf.describe(),this.registerDisposer(new tn(e,pf)),Z(e,"set",r=>{const o=r.detail,a=this.getModel(),l=this.getTargetValue(o);if(l===void 0)return;const c=Ze(a.window,a.range),d=Bn(c,l),u=h=>{const p=this.getModel();this.setModel(Sr(p,"range",d,h))};u(l),zt(o,h=>{const p=this.getTargetValue(h);p!==void 0&&u(p)})}),Z(e,"adjust-window-via-drag",r=>{const o=r.detail,a=this.getTargetFraction(o),l=this.getWindowLerp(a),c=a<.5?0:1,d=u=>{const h=this.getModel();this.setModel(Sr(h,"window",c,u))};zt(o,u=>{const h=this.getModel().window,p=this.getTargetFraction(u);d(c===0?de([l,h[1]],this.dataType,-p/(1-p)):de([h[0],l],this.dataType,1/p))})}),Z(e,"zoom-via-wheel",r=>{const o=r.detail,a=_i(o),l=this.getTargetFraction(o),{dataType:c}=this,d=this.getModel(),u=de(d.window,c,l*(1-a)),h=de(d.window,c,(1-l)*a+l);this.setModel({...d,window:[u,h],range:d.range})})}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return de(this.getModel().window,this.dataType,e)}getTargetValue(e){const t=this.getTargetFraction(e);if(Number.isFinite(t))return this.getWindowLerp(t)}}const mf=Symbol("histogramSamplerTexture");function Sr(i,e,t,n,s=!1){const r={...i},o=i[e];if(r[e]=[o[0],o[1]],r[e][t]=n,e==="window"&&rt(n,o[1-t])*(2*t-1)<0&&(r[e][1-t]=n),e==="range"&&s){const a=[i.window[0],i.window[1]];for(let l=0;l<2;++l)rt(n,a[l])*(2*l-1)>0&&(a[l]=n);r.window=a}return r}const pi=254+1;class mx extends nc{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controller=this.registerDisposer(new gf(this.element,this.parent.dataType,()=>this.parent.trackable.value,n=>{this.parent.trackable.value=n})),this.dataValuesBuffer=this.registerDisposer(ci(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{const n=new Uint8Array(pi*Ut);for(let s=0;s<pi;++s)for(let r=0;r<Ut;++r)n[s*Ut+r]=s;return n})).value,this.lineShader=this.registerDisposer(ff(this.gl,mf)),this.regionCornersBuffer=ur(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{const n=new fn(this.gl);return n.addAttribute("vec2","aVertexPosition"),n.addUniform("vec2","uBounds"),n.addUniform("vec4","uColor"),n.addOutputBuffer("vec4","out_color",0),n.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),n.setFragmentMain(`
out_color = uColor;
`),n.build()})());const{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){const{lineShader:e,gl:t,regionShader:n,parent:{dataType:s,trackable:{value:r}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{n.bind(),t.uniform4f(n.uniform("uColor"),.2,.2,.2,1);const o=re(r.window,r.range[0]),a=re(r.window,r.range[1]),l=le(s,r.window);t.uniform2f(n.uniform("uBounds"),Math.min(o,a)*l,Math.max(o,a)*l+(1-l));const c=n.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(c,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(c)}if(this.parent.histogramSpecifications.producerVisibility.visible){const{renderViewport:o}=this;e.bind(),vn(e,{width:o.logicalWidth,height:o.logicalHeight},1);const a=e.textureUnit(mf);t.uniform1f(e.uniform("uBoundsFraction"),le(s,r.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+a),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),di(t);const l=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(l,1,WebGL2RenderingContext.UNSIGNED_BYTE),mn(t,pi,1),t.disableVertexAttribArray(l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function vx(){}class yx extends nc{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=ur(this.gl,-1,-1,1,1);const{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");const n=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=Ai(this,this.gl,{...n,memoizeKey:{id:"colorLegendShader",base:n.memoizeKey},defineShader:(s,r,o)=>{s.addOutputBuffer("vec4","v4f_fragData0",0),s.addAttribute("vec2","aVertexPosition"),s.addUniform("float","uLegendOffset"),s.addVarying("float","vLinearPosition"),s.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);const a=this.parent.dataType,l=yt(a);s.addFragmentCode(zw(s,"ng_colorLegendLerp",a)),s.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${l} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${l} getDataValue(int dummyChannel) {
  return getDataValue();
}
${l} getInterpolatedDataValue() {
  return getDataValue();
}
${l} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),n.defineShader(s,r,o)}})}drawIndirect(){const e=this.shaderGetter(vx),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();const{gl:n}=this;n.clearColor(0,0,0,0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),n.enable(WebGL2RenderingContext.BLEND);const{trackable:{value:{window:s}},dataType:r}=this.parent;Ni(t,"ng_colorLegendLerp",this.parent.dataType,s);const o=ie(r,s);n.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),n.disable(WebGL2RenderingContext.DEPTH_TEST),n.disable(WebGL2RenderingContext.STENCIL_TEST);const a=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(a,2,WebGL2RenderingContext.FLOAT),n.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),n.disableVertexAttribArray(a)}isReady(){return!0}}function vf(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${i}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=i==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function yf(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-invlerp-widget-bounds"),n.classList.add(`neuroglancer-invlerp-widget-${i}-bounds`);const s=[vf(i,0),vf(i,1)];for(let o=0;o<2;++o){const a=s[o];a.addEventListener("input",()=>{Ec(a)}),a.addEventListener("change",()=>{const l=t.value,c=l[i];try{const d=qt(e,a.value);t.value=Sr(l,i,o,d,!0)}catch{br(a,c[o])}})}let r;return n.appendChild(s[0]),n.appendChild(s[1]),i==="range"&&(r=[document.createElement("div"),document.createElement("div"),document.createElement("div")],r[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),n.insertBefore(r[0],s[0]),n.insertBefore(r[1],s[1]),n.appendChild(r[2])),{container:n,inputs:s,spacers:r}}function Ec(i){$t(i,Math.max(1,i.value.length+.1))}function br(i,e){let t;e instanceof P.R||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),i.value=t,Ec(i)}function Sf(i){const e=i.value,{range:t}=e;i.value={...e,range:[t[1],t[0]]}}function Sx(i,e,t){const n=e.value,s=de(n.range,i,.5-t/2),r=de(n.range,i,.5+t/2);e.value={...n,range:[s,r]}}function bx(i,e,t,n,s){const r=Math.exp(s),o=e.value,a=de(t,i,.5-r/2+n),l=de(t,i,.5+r/2+n);e.value={...o,range:[a,l]}}class bf extends Gt{constructor(e,t,n,s,r,o,a){super(e),this.display=t,this.dataType=n,this.trackable=s,this.histogramSpecifications=r,this.histogramIndex=o,this.legendShaderOptions=a,this.cdfPanel=this.registerDisposer(new mx(this)),this.boundElements={range:yf("range",this.dataType,this.trackable),window:yf("window",this.dataType,this.trackable)},this.registerDisposer(r.visibility.add(this.visibility));const{element:l,boundElements:c}=this;if(a!==void 0){const u=this.registerDisposer(new yx(this));l.appendChild(u.element)}const d=u=>{const h=Ne({svg:u,title:"Invert range",onClick:()=>{this.invertRange()}});return c.range.spacers[1].appendChild(h),h};this.invertArrows=[d(hf),d(uf)],l.appendChild(c.range.container),l.appendChild(this.cdfPanel.element),l.classList.add("neuroglancer-invlerp-widget"),l.appendChild(c.window.container),this.updateView(),this.registerDisposer(s.changed.add(this.registerCancellable((0,Qe.t)(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){Sf(this.trackable)}updateView(){const{boundElements:e}=this,{trackable:{value:t},dataType:n}=this;for(let u=0;u<2;++u)br(e.range.inputs[u],t.range[u]),br(e.window.inputs[u],t.window[u]);const s=rt(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=s?"row-reverse":"row";const r=Ze(t.window,t.range),o=e.range.spacers,a=le(n,t.window),l=re(t.window,r[s?1:0])*a,c=re(t.window,r[s?0:1])*a+(1-a);o[s?2:0].style.width=`${l*100}%`,o[s?0:2].style.width=`${(1-c)*100}%`;const{invertArrows:d}=this;d[s?1:0].style.display="",d[s?0:1].style.display="none"}}class Cx extends Gt{constructor(e,t,n,s,r,o,a){super(e),this.display=t,this.watchableDataType=n,this.trackable=s,this.histogramSpecifications=r,this.histogramIndex=o,this.legendShaderOptions=a,this.invlerpWidget=this.makeInvlerpWidget(),this.registerDisposer(n.changed.add(()=>{Me(this.element),this.invlerpWidget.dispose(),this.invlerpWidget=this.makeInvlerpWidget()}))}get dataType(){return this.watchableDataType.value}disposed(){this.invlerpWidget.dispose(),super.disposed()}makeInvlerpWidget(){const{dataType:e}=this,t=new bf(this.visibility,this.display,e,this.trackable,this.histogramSpecifications,this.histogramIndex,this.legendShaderOptions);return this.element.appendChild(t.element),t}}const wx=Ae.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function Cf(i,e){i.bindInputEventMap(wx),i.bindAction("adjust-contrast-via-wheel",t=>{t.stopPropagation();const n=_i(t.detail);Sx(e.dataType,e.trackable,n)}),i.bindAction("adjust-via-drag",t=>{t.stopPropagation();let n=t.detail.screenX,s=t.detail.screenY,r=e.trackable.value.range,o=r,a=n,l=s;zt(t.detail,c=>{const d=e.trackable.value.range,u=c.screenX,h=c.screenY;Bt(e.dataType,d,o)||(r=d,n=a,s=l),bx(e.dataType,e.trackable,r,(h-s)*2/screen.height,(u-n)*4/screen.width),o=e.trackable.value.range,a=u,l=h})}),i.bindAction("invert-range",t=>{t.stopPropagation(),Sf(e.trackable)})}var wf=G(5061),xf=G(7349),Ef=G(350),xx=G(9575);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function No(i={}){return Ne({svg:xx,...i})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let zn=null,fi=null;const Ex=200;class pe{constructor(e=!1,t=!1){if(zn===null){zn=document.createElement("ul"),zn.id="statusContainer",zn.tabIndex=-1;const s=document.getElementById("neuroglancer-container");s?s.appendChild(zn):document.body.appendChild(zn)}if(t&&fi===null){fi=document.createElement("ul"),fi.id="statusContainerModal";const s=document.getElementById("neuroglancer-container");s?s.appendChild(fi):document.body.appendChild(fi)}const n=document.createElement("li");if(this.element=n,e===!0&&(e=Ex),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,t){const s=document.createElement("div"),r=No({title:"Dismiss",onClick:()=>{this.dismissModal()}});r.classList.add("dismiss-modal"),r.addEventListener("click",()=>this.dismissModal()),s.appendChild(r),s.appendChild(n),this.modalElementWrapper=s,fi.appendChild(s)}else zn.appendChild(n)}dispose(){this.modalElementWrapper?fi.removeChild(this.modalElementWrapper):zn.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}dismissModal(){this.modalElementWrapper&&(fi.removeChild(this.modalElementWrapper),this.modalElementWrapper=void 0,zn.appendChild(this.element))}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){const n=new pe(t.delay);n.setText(t.initialMessage);const s=n.dispose.bind(n);return e.then(s,r=>{let o;r instanceof Error?o=r.message:o=""+r;const{errorPrefix:a=""}=t;n.setErrorMessage(a+o),n.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";const t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){const t=new pe;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){const n=pe.showMessage(e);return window.setTimeout(()=>n.dispose(),t),n}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tx=/^[A-Z]$/;class Tf extends T.O8{constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(Z(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){const{globalBinder:e}=this.tool;this===e.activeTool_&&e.deactivate_()}}class Oo extends T.O8{constructor(e,t=!1){super(),this.localBinder=e,this.toggle=t,this.changed=new j.HN,this.keyBinding=void 0}get context(){return this.localBinder.context}get globalBinder(){return this.localBinder.globalBinder}unbind(){const{keyBinding:e}=this;e!==void 0&&this.localBinder.set(e,void 0)}}class gi extends Oo{constructor(e,t=!1){super(e.toolBinder,t),this.layer=e}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}}class Df extends T.O8{constructor(e){super(),this.layer=e,this.changed=new j.HN}get context(){return this.layer}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){const{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}}function Tc(i,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),(0,f.Rf)(e);const t=(0,f.cQ)(e,"type",f.zr);let n=i,s;for(;;){if(n=Object.getPrototypeOf(n),n===null)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);if(s=_o.get(n)?.get(t),s!==void 0)break}return s(i,e)}function Dx(i,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),(0,f.Rf)(e);const t=(0,f.cQ)(e,"type",f.zr),n=If.get(t);if(n===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return n(i,e)}const If=new Map,_o=new Map;function Cr(i,e){If.set(i,e)}function sn(i,e,t){const{prototype:n}=i;let s=_o.get(n);s===void 0&&(s=new Map,_o.set(n,s)),s.set(e,t)}function Ix(i,e){const{prototype:t}=i,n=_o.get(t);n&&n.delete(e)}class Lx extends T.O8{constructor(e){super(),this.layer=e,this.changed=new j.HN}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){const e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=Dx(this.layer,e)}reset(){this.value=void 0}toJSON(){const e=this.value_;if(e!==void 0)return e.toJSON()}}class Rx extends T.O8{constructor(e){super(),this.inputEventMapBinder=e,this.bindings=new Map,this.changed=new j.HN,this.debounceDeactivate=this.registerCancellable((0,Fe.A)(()=>{this.deactivate_(),this.reactivateQueuedTool()},100))}get(e){return this.bindings.get(e)}set(e,t){const{bindings:n}=this,s=n.get(e);if(s!==void 0){s.keyBinding=void 0,n.delete(e);const r=s.localBinder;r.bindings.delete(e),r.jsonToKey.delete(JSON.stringify(s.toJSON())),this.destroyTool(s),r.changed.dispatch()}if(t!==void 0){const r=t.localBinder,o=JSON.stringify(t.toJSON()),a=r.jsonToKey.get(o);if(a!==void 0){const l=r.bindings.get(a);l.keyBinding=void 0,n.delete(a),r.bindings.delete(a),r.jsonToKey.delete(o),this.destroyTool(l)}r.bindings.set(e,t),t.keyBinding=e,r.jsonToKey.set(o,e),n.set(e,t),r.changed.dispatch()}this.changed.dispatch()}activate(e,t){if(t=t||this.get(e),t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel();const n=this.activeTool_;if(t.toJSON()===n?.tool.toJSON()){t.toggle&&this.deactivate_();return}n!==void 0&&(n.tool.toggle&&!t.toggle&&(this.queuedTool=n.tool),this.deactivate_());const s=new Tf(t,this.inputEventMapBinder);if(this.activeTool_=s,!t.toggle){const r=`Key${e}`;s.registerEventListener(window,"keydown",o=>{o.stopPropagation(),o.preventDefault()}),s.registerEventListener(window,"keyup",o=>{o.code===r&&this.debounceDeactivate()}),s.registerEventListener(window,"blur",()=>{this.debounceDeactivate()})}return t.activate(s),t}reactivateQueuedTool(){if(this.queuedTool){const e=new Tf(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){this.queuedTool===e&&(this.queuedTool=void 0),this.activeTool_?.tool===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();const e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}}class Dc extends T.O8{constructor(e,t){super(),this.context=e,this.globalBinder=t,this.bindings=new Map,this.jsonToKey=new Map,this.changed=new j.HN}disposed(){this.clear(),super.disposed()}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){const n=Tc(this.context,t);n!==void 0&&this.set(e,n)}removeJsonString(e){const t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){const{bindings:e}=this;if(e.size===0)return;const t={};for(const[n,s]of e)t[n]=s.toJSON();return t}deleteTool(e){const{globalBinder:t,bindings:n,jsonToKey:s}=this,r=n.get(e);r&&(n.delete(e),t.bindings.delete(e),s.delete(JSON.stringify(r.toJSON())),t.destroyTool(r),t.changed.dispatch(),this.changed.dispatch())}clear(){const{globalBinder:e,bindings:t}=this;if(t.size!==0){for(const[n,s]of t)s.keyBinding=void 0,e.bindings.delete(n),e.destroyTool(s);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){(0,f.Rf)(e);for(const[t,n]of Object.entries(e)){if(!t.match(Tx))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);const s=Tc(this.context,n);if(s===void 0)return;this.set(t,s)}}}}class Lf extends T.O8{constructor(e,t){super(),this.localBinder=e,this.toolJson=t,this.element=document.createElement("div"),this.toolJsonString=JSON.stringify(this.toolJson);const{element:n}=this;n.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.changed.add(this.registerCancellable((0,Qe.t)(()=>this.updateView())))),this.updateView(),n.title="click \u2192 bind key, dbclick \u2192 unbind",n.addEventListener("dblclick",()=>{this.localBinder.removeJsonString(this.toolJsonString)}),Rf(this,n,s=>this.localBinder.setJson(s,this.toolJson))}updateView(){const{localBinder:e}=this,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t??" "}}function Rf(i,e,t){let n;e.addEventListener("mousedown",s=>{if(s.button!==0||n!==void 0)return;s.preventDefault(),s.stopPropagation(),n=new T.O8,i.registerDisposer(n),n.registerDisposer(new pe(!1)).setText("Press A-Z to bind key"),n.registerEventListener(window,"keydown",o=>{const{code:a}=o,l=a.match(/^Key([A-Z])$/);if(l===null)return;o.stopPropagation(),o.preventDefault();const c=l[1];t(c)},{capture:!0}),n.registerEventListener(window,"mouseup",o=>{o.button!==0||n===void 0||(o.preventDefault(),o.stopPropagation(),i.unregisterDisposer(n),n.dispose(),n=void 0)})}),e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation()})}function Wn(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-tool-button"),n.appendChild(i.registerDisposer(new Lf(e,t.toolJson)).element);const s=document.createElement("div");s.classList.add("neuroglancer-tool-button-label");const r=t.label;return r!==void 0&&(s.textContent=r),t.title&&(s.title=t.title),n.appendChild(s),n}function kf(i){const e=i.registerDisposer(new pe(!1));e.element.classList.add("neuroglancer-tool-status");const t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);const{inputEventMapBinder:n}=i;return i.inputEventMapBinder=(s,r)=>{const o=document.createElement("div");o.textContent=s.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),n(s,r)},{message:e,content:t}}function Vi(i){const{message:e,content:t}=kf(i),n=document.createElement("div");n.classList.add("neuroglancer-tool-status-header");const s=document.createElement("div");s.classList.add("neuroglancer-tool-status-header-container"),s.appendChild(n),t.appendChild(s);const r=document.createElement("div");return r.classList.add("neuroglancer-tool-status-body"),t.appendChild(r),{message:e,body:r,header:n}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mi(i,e="text/plain"){let t=!1;const n=(0,T.K6)(document,"copy",s=>{const{clipboardData:r}=s;r!==null&&(r.setData(e,i),t=!0),s.stopPropagation(),s.preventDefault()},!0);try{document.execCommand("copy")}finally{n()}return t}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vo=new _.B0(0);window.addEventListener("keydown",i=>{Vo.value=bc(i)}),window.addEventListener("keyup",i=>{Vo.value=bc(i)});const kx=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),Px=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class yn extends T.O8{constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.shouldIgnore=void 0,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){if(this.shouldIgnore?.(t))return!0;const n=t.target,{tagName:s}=n;if(n===this.target)return!1;const r=s==="TEXTAREA"||s==="INPUT"||s==="BUTTON"||s==="SELECT",o=!r&&(n.isContentEditable||n.ownerDocument&&n.ownerDocument.designMode==="on");return!r&&!o||this.allShortcutsAreGlobal||kx.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:s==="INPUT"&&Px.has(n.type)?e!=="enter":s==="INPUT"||s==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){const t=Ax(e);this.shouldIgnoreEvent(t,e)||cf(t,e,e,this.eventMap)}}function Ax(i){return i.code.toLowerCase()}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rn extends T.O8{constructor(e,t){super(),this.element=Ne({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");const n=()=>{const s=e.value;this.element.dataset.checked=s?"true":"false",this.element.title=(s?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(n)),n()}}var Mx=G(3112);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Hn(i={}){return Ne({svg:Mx,...i})}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nx extends T.O8{constructor(e){super(),this.redraw=e}}class Wt extends T.O8{constructor(e,t,n=new vt(vt.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=n,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable((0,Qe.t)(()=>this.updateView())),this.debouncedForceUpdateView=()=>{this.generation=-1,this.debouncedUpdateView()},this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(n.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;const{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.disposeCurrentView();const n=this.currentViewDisposer=new Nx(this.debouncedForceUpdateView);this.render(e.value,this.element,n),this.generation=t}disposeCurrentView(){const{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),Me(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bo extends T.O8{constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new Map;const{element:t,valueIndexMap:n}=this;let s=0;for(const r of Object.keys(e.enumType))if(Number.isNaN(Number(r))){const o=document.createElement("option");o.textContent=o.value=r.toLowerCase(),t.appendChild(o),n.set(e.enumType[r],s),++s}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",r=>{r.preventDefault(),r.stopPropagation(),this.adjustViaWheel(r)}),this.updateView()}adjustViaWheel(e){const{element:t}=this,{deltaY:n}=e;n>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):n<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){const{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ic extends T.O8{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let{validator:n,label:s}=t;const{element:r,inputElement:o}=this;n===void 0&&(e instanceof _.DN?n=e.validator:n=a=>a),this.validator=n,s!==void 0&&(r.textContent=s),r.appendChild(o),r.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){at(this.element),super.disposed()}}/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Pf(i,e,t,n){return Math.floor((i-e)*(n-1)/(t-e))}function Ox(i,e,t){const{boundingBoxes:n,bounds:s}=i;let[r,o]=_h(s,e);if(r=Math.floor(r),o=Math.floor(o-1),!Number.isFinite(r)||!Number.isFinite(o))return;const a=[],l=d=>Pf(d,r,o,t),{rank:c}=i;for(const d of n){const u=Bh(d,e,c);u!==void 0&&(u.lower=Math.max(0,l(u.lower)),u.upper=Math.min(t-1,l(Math.ceil(u.upper-1))),a.push(u))}return a.sort((d,u)=>{const h=d.lower-u.lower;return h!==0?h:u.upper-u.upper}),(0,F.U8)(a,(d,u)=>{if(u===0)return!0;const h=a[u-1];return h.lower!==d.lower||h.upper!==d.upper}),{lowerBound:r,upperBound:o,normalizedBounds:a}}class Af extends T.O8{constructor(e,t,n="column"){super(),this.position=e,this.dimensionId=t,this.orientation=n,this.element=document.createElement("div"),this.visible=!0,this.dragging=new _.B0(!1),this.tickWidth=this.orientation==="column"?10:5,this.barWidth=this.orientation==="column"?15:10,this.barRightMargin=this.orientation==="column"?10:2,this.canvasWidth=this.tickWidth+this.barWidth+this.barRightMargin;const s=this.element;s.classList.add("neuroglancer-position-dimension-plot"),s.dataset.orientation=n;const r=document.createElement("canvas"),o=r.getContext("2d"),a=document.createElement("div"),l=document.createElement("div");l.appendChild(a);const c=document.createTextNode("");a.appendChild(c);const d=document.createElement("div"),u=document.createElement("div");l.classList.add("neuroglancer-position-dimension-plot-lowerbound"),d.classList.add("neuroglancer-position-dimension-plot-upperbound"),u.classList.add("neuroglancer-position-dimension-plot-hoverposition"),s.appendChild(l),s.appendChild(d),s.appendChild(u),s.appendChild(r);let h,p,m;const g=()=>{const w=this.position.coordinateSpace.value,b=w.ids.indexOf(this.dimensionId);if(b===-1)return;let x;n==="column"?(x=100,r.width=this.canvasWidth,r.height=x,d.style.marginTop=`${x-1}px`):(x=r.clientWidth,r.width=x,r.height=this.canvasWidth);const E=Ox(w,b,x);if(E===void 0||w.bounds.lowerBounds[b]+1===w.bounds.upperBounds[b]){this.element.style.display="none",this.visible=!1;return}this.visible=!0;const{lowerBound:D,upperBound:I}=E;h=D,p=I,c.textContent=D.toString(),d.textContent=I.toString();let L,N,k;n!=="column"&&(N=a.clientWidth,k=d.clientWidth,L=Math.max(N,k)/2,r.style.marginLeft=`${L}px`,r.style.marginRight=`${L}px`,d.style.position="relative",d.style.left=`${x+L-k/2}px`,a.style.marginLeft=`${L-N/2}px`),this.drawDimensionBounds(r,o,E);const O=this.position.value[b],V=(X,ce)=>{if(X!==void 0&&X>=D&&Math.floor(X)<=I){o.fillStyle=ce;const oe=Pf(X,D,I,x);return n==="column"?o.fillRect(0,oe,this.canvasWidth,1):o.fillRect(oe,0,1,this.canvasWidth),oe}},z=V(O,"#f66"),Y=this.dragging.value;let Q=Y?z:V(m,"#66f");if(Q!==void 0){u.textContent=(Y?Math.floor(O):m).toString();const X=n==="column"?a.clientHeight:a.clientWidth,ce=n==="column"?d.clientHeight:d.clientWidth;let oe,Se,Ke;if(n!=="column"){oe=u.clientWidth,Q+=L,Q-=oe/2,Q=Math.max(0,Q);const $e=x+L-ce/2-oe;Se=Q>L+X/2,Ke=Q<$e}else Se=Q>X,Ke=Q<x-ce;a.style.visibility=Se?"":"hidden",d.style.visibility=Ke?"":"hidden",u.style.display="",u.style.visibility="visible",n==="column"?u.style.marginTop=`${Q}px`:u.style.marginLeft=`${Q}px`}else a.style.visibility="",u.style.display="none",d.style.visibility=""},v=this.registerCancellable((0,Qe.t)(g));this.registerDisposer(this.position.changed.add(v));const y=w=>{if(h===void 0||p===void 0)return;const b=r.getBoundingClientRect();let x;return n==="column"?x=(w.clientY-b.top)/b.height:x=(w.clientX-b.left)/b.width,x=Math.max(0,x),x=Math.min(1,x),Math.round(x*(p-h))+h},S=w=>{const b=this.position.coordinateSpace.value,x=b.ids.indexOf(this.dimensionId);if(x===-1)return;let E=y(w);if(E===void 0)return;const{position:D}=this,I=D.value;b.bounds.voxelCenterAtIntegerCoordinates[x]||(E+=.5),I[x]=E,D.value=I};r.addEventListener("pointermove",w=>{m=y(w),v()}),r.addEventListener("pointerleave",()=>{m=void 0,v()}),r.addEventListener("pointerdown",w=>{w.preventDefault(),w.stopPropagation(),!(w.ctrlKey||w.altKey||w.metaKey)&&(zt(w,b=>{this.wasDisposed||(m=void 0,S(b),v(),this.dragging.value=!0)},()=>{this.dragging.value=!1,v()}),S(w))}),g(),n==="row"&&(r.style.maxWidth="100%",r.style.justifySelf="stretch",new ResizeObserver(g).observe(r))}drawDimensionBounds(e,t,n){const{orientation:s}=this;t.clearRect(0,0,e.width,e.height);const{normalizedBounds:r}=n,o=s==="column"?l=>{t.fillRect(0,l,this.tickWidth,1)}:l=>{t.fillRect(l,0,1,this.tickWidth)};t.fillStyle="#fff";for(const{lower:l,upper:c}of r)o(l),o(c);const a=r.length;t.fillStyle="#ccc";for(let l=0;l<a;++l){const{lower:c,upper:d}=r[l],u=Math.floor(l*this.barWidth/a),h=Math.max(1,this.barWidth/a);s==="column"?t.fillRect(u+this.tickWidth,c,h,d+1-c):t.fillRect(c,u+this.tickWidth,d+1-c,h)}}}/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fo="neuroglancer-position",Mf=Ae.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},"alt+wheel":{action:"adjust-velocity-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),_x=[i=>i.nameElement,i=>i.coordinate,i=>i.scaleElement];function Uo(i,e){const t=i.coordinateArrays[e];return t===void 0?t:i.units[e]!==""||i.scales[e]!==1?null:t}class Vx{constructor(e,t,n,s){this.coordinateSpace=e,this.id=t,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.playButton=document.createElement("div"),this.pauseButton=document.createElement("div"),this.coordinateLabelWidth=0,this.maxPositionWidth=0,this.maxPositionWidthSeen=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;const{container:r,scaleElement:o,scaleContainer:a,coordinate:l,nameElement:c,nameContainer:d,coordinateLabel:u,playButton:h,pauseButton:p}=this;r.title="",r.classList.add("neuroglancer-position-dimension");const{allowFocus:m,showPlayback:g}=s;m&&(r.draggable=!0,r.tabIndex=-1),r.appendChild(d),r.appendChild(o),d.appendChild(c),d.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(o),c.classList.add("neuroglancer-position-dimension-name"),c.disabled=!0,c.spellcheck=!1,c.autocomplete="off",c.required=!0,c.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),o.classList.add("neuroglancer-position-dimension-scale"),o.disabled=!0,o.spellcheck=!1,o.autocomplete="off",r.appendChild(a),g&&(h.classList.add("neuroglancer-icon"),p.classList.add("neuroglancer-icon"),h.innerHTML=xf,p.innerHTML=wf,r.appendChild(h),r.appendChild(p)),r.appendChild(l),l.type="text",l.classList.add("neuroglancer-position-dimension-coordinate"),l.spellcheck=!1,l.autocomplete="off",l.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;const v=Uo(e,n);if(v!=null){let y=0;for(const S of v.labels)y=Math.max(y,S.length);this.coordinateLabelWidth=y,u.style.width=`${y+2}ch`,r.appendChild(u)}l.required=!0,l.placeholder=" ",u.classList.add("neuroglancer-position-dimension-coordinate-label"),m&&(d.addEventListener("dblclick",()=>{c.disabled=!1,c.focus(),c.select()}),a.addEventListener("dblclick",()=>{o.disabled=!1,o.focus(),o.select()}),l.addEventListener("focus",()=>{l.select()}),r.addEventListener("click",y=>{(!(y.target instanceof HTMLInputElement)||y.target.disabled)&&l.focus()}))}}function Nf(i,e){const t=e.length;t>i.maxPositionWidthSeen&&(i.maxPositionWidthSeen=t),$t(i.coordinate,Math.max(Math.min(i.maxPositionWidth,i.maxPositionWidthSeen),t))}function Of(i){const{value:e}=i;$t(i),i.parentElement.dataset.isEmpty=e===""?"true":"false"}class xs extends T.O8{constructor(e,t,{copyButton:n=!0,velocity:s=void 0,singleDimensionId:r=void 0,getToolBinder:o=void 0,allowFocus:a=!0,showPlayback:l=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new Map,this.dimensionWidgetList=[],this.dragSource=void 0;const{element:c,dimensionContainer:d}=this;if(this.velocity=s,this.singleDimensionId=r,this.getToolBinder=o,this.allowFocus=a,this.showPlayback=l,this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable((0,Qe.t)(()=>this.updateDimensions())))),c.className="neuroglancer-position-widget",d.style.display="contents",c.appendChild(d),n){const m=Hn({title:"Copy position to clipboard",onClick:()=>{const g=mi(this.getPositionText());pe.showTemporaryMessage(g?"Position copied to clipboard":"Failed to copy position to clipboard")}});m.addEventListener("dragstart",g=>{g.dataTransfer.setData(Fo,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),g.dataTransfer.setData("text",this.getPositionText()),g.stopPropagation()}),m.draggable=!0,c.appendChild(m)}const u=this.registerCancellable((0,Qe.t)(()=>this.updateView()));this.registerDisposer(e.changed.add(u)),s!==void 0&&this.registerDisposer(s.changed.add(u));const h=m=>{const g=m.target;return!!(g instanceof Element&&g.matches(".neuroglancer-position-dimension-playback *"))};if(a){const m=this.registerDisposer(new yn(c,Mf));m.allShortcutsAreGlobal=!0,m.shouldIgnore=h}const p=this.registerDisposer(new tn(c,Mf));p.shouldIgnore=h,this.registerDisposer(Z(c,"cancel",m=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();const{target:g}=m;g instanceof HTMLElement&&g.blur()})),this.updateView()}getDimensionIndex(e){return this.position.coordinateSpace.value.ids.indexOf(e)}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");const n=e.dropdownOwner,s=this.getToolBinder?.();if(s!==void 0){const a=this.getDimensionIndex(e.id),l=Wn(n,s,{toolJson:{type:wr,dimension:e.coordinateSpace.names[a]}});t.appendChild(l)}const r=n.registerDisposer(new Af(this.position,e.id));t.appendChild(r.element);const o=this.velocity?.dimensionVelocity(n,e.id);if(o!==void 0){const a=document.createElement("div");a.classList.add("neuroglancer-position-dimension-playback");const l=document.createElement("div");l.classList.add("neuroglancer-position-dimension-playback-header"),a.appendChild(l),l.appendChild(n.registerDisposer(new rn(this.velocity.playbackEnabled(e.id),{svg:Ef,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),l.appendChild(document.createTextNode("Playback")),t.appendChild(a);const c=n.registerDisposer((0,_.Uq)(d=>d!==void 0,[o]));a.appendChild(n.registerDisposer(new Wt(c,(d,u,h)=>{if(!d)return;const p=new _.B0(0);p.changed.add(()=>{const b=p.value,x=o.value;x!==void 0&&x.velocity!==b&&(o.value={...x,velocity:b})});const m=Ne({text:"\xB1",title:"Negate velocity",onClick:()=>{p.value=-p.value}}),g=h.registerDisposer(new Ic(p));g.element.insertBefore(m,g.element.firstChild),g.element.title="Velocity in coordinates per second";const v=document.createElement("span");v.textContent="/s",g.element.appendChild(v),u.appendChild(g.element);const y=new Oi.F(Gn,Gn.STOP),S=()=>{y.value=o.value?.atBoundary??Gn.STOP,p.value=o.value?.velocity??0};S(),h.registerDisposer(o.changed.add(S)),y.changed.add(()=>{const b=y.value,x=o.value;x!==void 0&&x.atBoundary!==b&&(o.value={...x,atBoundary:b})});const w=new Bo(y).element;u.appendChild(w),w.title="Behavior when lower/upper bound is reached"})).element)}r.dragging.changed.add(()=>{(e.draggingPosition=r.dragging.value)===!1&&this.updateDropdownVisibility(e)})}openCoordinateArrayDropdown(e,t,n){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");const{coordinates:s,labels:r}=n,o=[],a=s.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let l=0;l<a;++l){const c=document.createElement("div");c.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");const d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate");const u=document.createElement("div");u.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),u.textContent=r[l],d.textContent=s[l].toString(),c.appendChild(d),c.appendChild(u),c.addEventListener("click",()=>{const h=this.getDimensionIndex(e.id);if(h===-1)return;const{position:p}=this,m=p.value;m[h]=s[l]+.5,e.modified=!1,p.value=m}),t.appendChild(c),o.push({entryElement:c,coordinateElement:d,labelElement:u})}}openDropdown(e){if(e.dropdownOwner!==void 0)return;const t=this.getDimensionIndex(e.id);if(t===-1)return;this.closeDropdown();const n=e.dropdownOwner=new T.O8,s=document.createElement("div");s.draggable=!0,s.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),s.addEventListener("pointerenter",()=>{e.hasFocus=!0}),s.tabIndex=-1,e.container.appendChild(s);const r=Uo(e.coordinateSpace,t);r==null?this.openRegularDropdown(e,s):this.openCoordinateArrayDropdown(e,s,r),this.widgetWithOpenDropdown=e,n.registerDisposer(()=>{at(s),e.dropdownOwner=void 0,e.container.dataset.dropdownVisible=void 0,this.widgetWithOpenDropdown=void 0}),n.registerEventListener(document,"pointerdown",o=>{const{target:a}=o;a instanceof Node&&e.container.contains(a)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;const{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();const n=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(n===null)break;if(n[1]!==void 0&&document.execCommand("insertText",void 0,n[1]),n[2]!==void 0){const{dimensionWidgetList:s}=this,r=s.indexOf(e);if(r===-1||r+1===s.length)break;const o=t.substring(n[0].length);e=s[r+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;const{coordinateSpace:n}=this.position;n.value=Qh(n.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t,n){const s=new Vx(e,t,n,{allowFocus:this.allowFocus,showPlayback:this.showPlayback});this.singleDimensionId===void 0&&(s.container.addEventListener("dragstart",r=>{this.dragSource=s,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),s.container.addEventListener("dragenter",r=>{const{dragSource:o}=this;if(o===void 0||o===s)return;const{dimensionWidgetList:a}=this,l=a.indexOf(o),c=a.indexOf(s);l===-1||c===-1||(r.preventDefault(),this.reorderDimensionTo(c,l))}),s.container.addEventListener("dragend",r=>{this.dragSource===s&&(this.dragSource=void 0)})),this.allowFocus?(s.container.addEventListener("focusin",()=>{s.hasFocus=!0,this.updateDropdownVisibility(s)}),s.container.addEventListener("focusout",r=>{const{relatedTarget:o}=r;o instanceof Node&&s.container.contains(o)||(s.hasFocus=!1,this.updateDropdownVisibility(s))}),s.coordinate.addEventListener("paste",r=>{const o=s.coordinate,a=o.value,{clipboardData:l}=r;if(l===null)return;let c=l.getData("text"),{selectionEnd:d,selectionStart:u}=o;if(u!==0||d!==a.length){u==null&&(u=0),d==null&&(d=0);const h=c.match(/[^\-0-9.]/);h!==null&&(c=c.substring(0,h.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(s,c);r.preventDefault(),r.stopPropagation()}),s.coordinate.addEventListener("input",()=>{s.modified=!0;const r=s.coordinate,o=r.value;let{selectionDirection:a,selectionEnd:l,selectionStart:c}=r;c===null&&(c=0),l===null&&(l=c);let d="";const u=/[^\-0-9.]/g;d+=o.substring(0,c).replace(u,"");const h=d.length;d+=o.substring(c,l).replace(u,"");const p=d.length;d+=o.substring(l).replace(u,""),r.value=d,r.selectionStart=h,r.selectionEnd=p,r.selectionDirection=a,Nf(s,d),l===c&&l===o.length&&o.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(s,1)}),s.nameElement.addEventListener("input",()=>{const{nameElement:r}=s;$t(r),this.updateNameValidity()}),s.scaleElement.addEventListener("input",()=>{const{scaleElement:r}=s;Of(r),this.updateScaleValidity(s)}),s.coordinate.addEventListener("blur",r=>{const{relatedTarget:o}=r;this.dimensionWidgetList.some(a=>a.coordinate===o)||s.modified&&this.updatePosition()}),s.nameElement.addEventListener("blur",r=>{s.nameElement.disabled=!0;const{relatedTarget:o}=r;this.dimensionWidgetList.some(a=>a.nameElement===o)||this.updateNames()||this.forceUpdateDimensions()}),s.scaleElement.addEventListener("blur",r=>{s.scaleElement.disabled=!0;const{relatedTarget:o}=r;this.dimensionWidgetList.some(a=>a.scaleElement===o)||this.updateScales()||this.forceUpdateDimensions()})):s.coordinate.disabled=!0,Z(s.container,"adjust-via-wheel",r=>{const o=r.detail,{deltaY:a}=o;a!==0&&this.adjustDimensionPosition(s.id,Math.sign(a))}),Z(s.container,"adjust-velocity-via-wheel",r=>{const o=r.detail;this.adjustDimensionVelocity(s,_i(o))}),Z(s.container,"adjust-up",()=>{this.adjustDimensionPosition(s.id,-1)}),Z(s.container,"adjust-down",()=>{this.adjustDimensionPosition(s.id,1)});for(const r of _x){const o=r(s);Z(o,"maybe-tab-forward",a=>{this.handleLeftRightMovement(a,s,1,r)}),Z(o,"maybe-tab-backward",a=>{this.handleLeftRightMovement(a,s,-1,r)}),Z(o,"tab-forward",()=>{this.selectAdjacentField(s,1,r)}),Z(o,"tab-backward",()=>{this.selectAdjacentField(s,-1,r)})}if(Z(s.coordinate,"commit",()=>{this.updatePosition()}),Z(s.nameElement,"commit",()=>{this.updateNames()}),Z(s.scaleElement,"commit",()=>{this.updateScales()}),Z(s.coordinate,"delete-backward",r=>{r.stopPropagation();const{coordinate:o}=s;o.selectionStart===o.selectionEnd&&o.selectionStart===0&&(r.preventDefault(),this.selectAdjacentCoordinate(s,-1))}),this.showPlayback){const r=o=>{this.velocity?.togglePlayback(s.id,o)};s.playButton.addEventListener("click",()=>r(!1)),s.pauseButton.addEventListener("click",()=>r(!0))}return s}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=Fn),this.coordinateSpace=e;const{dimensionWidgets:t,dimensionWidgetList:n}=this;n.length=0;const{names:s,ids:r,scales:o,units:a,bounds:{lowerBounds:l,upperBounds:c}}=e,d=(h,p)=>{const m=l[p],g=c[p],v=Math.max(Number.isFinite(m)?Math.floor(m).toString().length:0,Number.isFinite(g)?Math.ceil(g).toString().length:0);let y=t.get(h);y===void 0?(y=this.newDimension(e,h,p),t.set(h,y),y.maxPositionWidthSeen=v):y.coordinateSpace=e,y.maxPositionWidth=v;const S=s[p];y.nameElement.value=S,y.nameElement.dataset.isValid=void 0,$t(y.nameElement);const w=Uo(e,p);w===void 0?y.container.dataset.coordinateArray="none":w===null?y.container.dataset.coordinateArray="invalid":y.container.dataset.coordinateArray="valid",y.scaleContainer.title="Drag to reorder, double click to change scale",w===null&&(y.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");const{scale:b,prefix:x,unit:E}=kh(o[p],a[p]),D=`${b}${x}${E}`;return y.scaleElement.value=D,y.scaleElement.dataset.isValid=void 0,Of(y.scaleElement),n.push(y),y.container},{singleDimensionId:u}=this;if(u!==void 0){const h=this.getDimensionIndex(u);h===-1?nn(this.dimensionContainer,[]):nn(this.dimensionContainer,[d(u,h)])}else nn(this.dimensionContainer,r.map(d));for(const[h,p]of t)p.coordinateSpace!==e&&(this.closeDropdown(p),t.delete(h))}updateDimensions(){const{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,n){const{dimensionWidgetList:s}=this;let r=s.indexOf(e);if(r!==-1)for(;;){if(r+=t,r<0||r>=s.length)return!1;const o=s[r],a=n(o);if(a.style.display!=="none")return a.disabled=!1,a.focus(),a.selectionStart=0,a.selectionEnd=a.value.length,a.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,n=>n.coordinate)}handleLeftRightMovement(e,t,n,s){e.stopPropagation();const r=s(t);r.selectionStart!==r.selectionEnd||r.selectionStart!==(n===1?r.value.length:0)||this.selectAdjacentField(t,n,s)&&e.preventDefault()}updateNameValidity(){const{dimensionWidgetList:e}=this,t=e.map(r=>r.nameElement.value),n=t.length,s=this.combiner.getRenameValidity(t);for(let r=0;r<n;++r)e[r].nameElement.dataset.isValid=s[r]===!1?"false":"true"}updateScaleValidity(e){const t=sr(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimensionPosition(e,t){const n=this.getDimensionIndex(e);if(n===-1)return;this.updatePosition();const{position:s}=this;if(!s.valid)return;const r=s.coordinateSpace.value,{bounds:o}=r,a=Float32Array.from(s.value);a[n]=Wl(o,n,a[n]+t),this.position.value=a,this.updateView()}adjustDimensionVelocity(e,t){const{velocity:n}=this;n!==void 0&&n.multiplyVelocity(e.id,t)}updatePosition(){if(!this.allowFocus)return;const{dimensionWidgetList:e}=this,{position:t}=this,{value:n}=t,s=t.coordinateSpace.value;if(n===void 0)return;const r=e.length;let o=!1;for(let a=0;a<r;++a){const l=e[a];if(!l.modified)continue;l.modified=!1,o=!0;const c=l.coordinate.value;let d=Number(c);Number.isFinite(d)&&(Number.isInteger(d)&&!c.includes(".")&&s!==void 0&&!s.bounds.voxelCenterAtIntegerCoordinates[a]&&(d+=.5),n[a]=d)}o&&(t.value=n)}updateNames(){if(!this.allowFocus)return;const{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,n=t.value,s=e.map(l=>l.nameElement.value);if(this.combiner.getRenameValidity(s).includes(!1))return!1;const r=n.names;if((0,F.r1)(r,s))return!1;const o=n.timestamps.map((l,c)=>r[c]===s[c]?l:Date.now()),a={...n,names:s,timestamps:o};return t.value=a,!0}updateScales(){if(!this.allowFocus)return;const{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,n=t.value,s=e.map(u=>sr(u.scaleElement.value));if(s.includes(void 0))return!1;const r=Float64Array.from(s,u=>u.scale),o=Array.from(s,u=>u.unit),{scales:a,units:l}=n;if((0,F.r1)(a,r)&&(0,F.r1)(l,o))return!1;const c=n.timestamps.map((u,h)=>r[h]===a[h]&&o[h]===l[h]?u:Date.now()),d=Oe({valid:n.valid,rank:n.rank,scales:r,units:o,timestamps:c,ids:n.ids,names:n.names,boundingBoxes:n.boundingBoxes,coordinateArrays:n.coordinateArrays});return t.value=d,!0}getPositionText(){const{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();const{position:{value:e},dimensionWidgetList:t}=this,n=t.length;if(e===void 0)return;const s=this.coordinateSpace,{velocity:r}=this;for(let o=0;o<n;++o){const a=t[o],l=a.coordinate,c=Math.floor(e[o]),d=c.toString();Nf(a,d),l.value=d;const u=Uo(s,o);let h="";if(u!=null){const{coordinates:m}=u,g=(0,F.El)(m,c,(v,y)=>v-y);g!==m.length&&(h=u.labels[g])}const p=a.coordinateLabel;if(p.textContent=h,this.showPlayback){const m=r?.value?.[o];if(m!==void 0){const g=m.paused;a.playButton.style.display=g?"":"none",a.pauseButton.style.display=g?"none":""}else a.playButton.style.display="none",a.pauseButton.style.display="none"}}}disposed(){this.closeDropdown(),at(this.element),super.disposed()}}class Bx extends T.O8{constructor(e,t,n){super(),this.element=e,this.mouseState=t,this.coordinateSpace=n,this.tempPosition=C.eR.create(),e.className="neuroglancer-mouse-position-widget";const s=this.registerCancellable((0,Qe.t)(()=>this.updateView()));this.registerDisposer(t.changed.add(s)),this.registerDisposer(n.changed.add(s))}updateView(){let e="";const{mouseState:t,coordinateSpace:{value:n}}=this;if(t.active&&n!==void 0){const s=t.position,{rank:r,names:o}=n;for(let a=0;a<r;++a)a!==0&&(e+="  "),e+=`${o[a]} ${Math.floor(s[a])}`}this.element.textContent=e}disposed(){at(this.element),super.disposed()}}const wr="dimension",Fx=Ae.fromObject({"at:shift?+wheel":{action:"adjust-position-via-wheel"},"at:shift?+alt+wheel":{action:"adjust-velocity-via-wheel"},"shift?+alt?+space":{action:"toggle-playback"},"at:shift?+alt?+mousedown0":{action:"toggle-playback"}});class Ux extends Oo{constructor(e,t){super(e.toolBinder),this.viewer=e,this.dimensionId=t;const n=this.coordinateSpace.value,s=this.dimensionIndex=n.ids.indexOf(t);this.dimensionName=n.names[s],this.registerDisposer(this.coordinateSpace.changed.add(()=>{const r=this.coordinateSpace.value,o=this.dimensionIndex=this.coordinateSpace.value.ids.indexOf(t);if(o===-1){this.unbind();return}const a=r.names[o];this.dimensionName!==a&&(this.dimensionName=a,this.changed.dispatch())}))}get position(){return this.viewer.position}get velocity(){return this.viewer.velocity}get coordinateSpace(){return this.viewer.coordinateSpaceCombiner.combined}activate(e){const{viewer:t}=this,{content:n}=kf(e);n.classList.add("neuroglancer-position-tool"),e.bindInputEventMap(Fx);const s=new xs(t.position,t.coordinateSpaceCombiner,{velocity:t.velocity,singleDimensionId:this.dimensionId,copyButton:!1,allowFocus:!1,showPlayback:!1});s.element.style.userSelect="none",n.appendChild(e.registerDisposer(s).element);const r=e.registerDisposer(new Af(t.position,this.dimensionId,"row"));r.element.style.flex="1",n.appendChild(r.element),e.bindAction("adjust-position-via-wheel",l=>{l.stopPropagation();const c=l.detail,{deltaY:d}=c;d!==0&&s.adjustDimensionPosition(this.dimensionId,Math.sign(d))});const o=this.velocity.dimensionVelocity(e,this.dimensionId),a=e.registerDisposer((0,_.Uq)(l=>l!==void 0,[o]));n.appendChild(e.registerDisposer(new Wt(a,(l,c,d)=>{if(!l)return;c.classList.add("neuroglancer-position-dimension-playback");const u=document.createElement("div"),h=document.createElement("div");u.classList.add("neuroglancer-icon"),h.classList.add("neuroglancer-icon"),u.innerHTML=xf,h.innerHTML=wf,c.appendChild(u),c.appendChild(h);const p=()=>t.velocity.togglePlayback(this.dimensionId);u.addEventListener("click",p),h.addEventListener("click",p);const m=()=>{const E=o.value?.paused;u.style.display=E?"":"none",h.style.display=E?"none":""};d.registerDisposer(o.changed.add(m)),m();const g=new _.B0(0);g.changed.add(()=>{const E=g.value,D=o.value;D!==void 0&&D.velocity!==E&&(o.value={...D,velocity:E})});const v=Ne({text:"\xB1",title:"Negate velocity",onClick:()=>{g.value=-g.value}}),y=d.registerDisposer(new Ic(g));y.inputElement.disabled=!0,y.element.insertBefore(v,y.element.firstChild),y.element.title="Velocity in coordinates per second";const S=document.createElement("span");S.textContent="/s",y.element.appendChild(S),c.appendChild(y.element);const w=new Oi.F(Gn,Gn.STOP),b=()=>{w.value=o.value?.atBoundary??Gn.STOP,g.value=o.value?.velocity??0};b(),d.registerDisposer(o.changed.add(b)),w.changed.add(()=>{const E=w.value,D=o.value;D!==void 0&&D.atBoundary!==E&&(o.value={...D,atBoundary:E})});const x=new Bo(w).element;c.appendChild(x),x.title="Behavior when lower/upper bound is reached"})).element),n.appendChild(e.registerDisposer(new rn(t.velocity.playbackEnabled(this.dimensionId),{svg:Ef,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),e.bindAction("adjust-velocity-via-wheel",l=>{l.stopPropagation();const c=_i(l.detail);t.velocity.multiplyVelocity(this.dimensionId,c)}),e.bindAction("toggle-playback",l=>{l.stopPropagation(),t.velocity.togglePlayback(this.dimensionId)})}get description(){return`dim ${this.dimensionName}`}toJSON(){return{type:wr,dimension:this.dimensionName}}}function Lc(i,e){const t=(0,f.cQ)(e,"dimension",f.zr),n=i.coordinateSpaceCombiner.combined.value,s=n.names.indexOf(t);if(s===-1)throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return new Ux(i,n.ids[s])}function $x(i){sn(i,wr,(e,t)=>Lc({position:e.position,velocity:e.velocity,coordinateSpaceCombiner:e.layerSpecification.coordinateSpaceCombiner,toolBinder:e.toolBinder},t))}function Gx(i){sn(i,wr,(e,t)=>Lc({position:e.localPosition,velocity:e.localVelocity,coordinateSpaceCombiner:e.localCoordinateSpaceCombiner,toolBinder:e.toolBinder},t))}function zx(i){sn(i,wr,(e,t)=>Lc({position:e.viewerNavigationState.position.value,velocity:e.viewerNavigationState.velocity.velocity,coordinateSpaceCombiner:e.layerSpecification.root.coordinateSpaceCombiner,toolBinder:e.toolBinder},t))}/**
 * @license
 * Copyright 2024 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $o=512,xr=4,_f=4,Rc=.05,Go=.05,Vf=Symbol("transferFunctionSamplerTexture"),Bf=Symbol("histogramSamplerTexture"),Ff={[R.UINT8]:256,[R.INT8]:256,[R.UINT16]:8192,[R.INT16]:8192,[R.UINT32]:8192,[R.INT32]:8192,[R.UINT64]:8192,[R.FLOAT32]:8192};class Ln{constructor(e,t=C.yb){this.inputValue=e,this.outputColor=t}normalizedInput(e){return re(e,this.inputValue)}transferFunctionIndex(e,t){return Math.floor(this.normalizedInput(e)*(t-1))}interpolateColor(e,t){const n=C.ln.create();for(let s=0;s<4;++s)n[s]=de([this.outputColor[s],e.outputColor[s]],R.UINT8,t);return n}static copyFrom(e){const t=e.inputValue,n=C.ln.clone(e.outputColor);return new Ln(t,n)}}class zo{constructor(e=[],t,n=!0){this.controlPoints=e,this.dataType=t,this.autoComputeRange=n,this.controlPoints=e,this.range=he[t],this.sortAndComputeRange()}get length(){return this.controlPoints.length}addPoint(e){const{inputValue:t,outputColor:n}=e,s=this.controlPoints.findIndex(o=>o.inputValue===t);s!==-1&&this.updatePointColor(s,n);const r=new Ln(t,n);this.controlPoints.push(r),this.sortAndComputeRange()}removePoint(e){this.controlPoints.splice(e,1),this.computeRange()}updatePoint(e,t){this.controlPoints[e]=t;const n=t.inputValue,s=t.outputColor;this.sortAndComputeRange();for(let r=0;r<this.controlPoints.length;++r)if(this.controlPoints[r].inputValue===n&&(0,F.r1)(this.controlPoints[r].outputColor,s))return r;return-1}updatePointColor(e,t){let n=C.ln.create();if(t.length===3){const s=this.controlPoints[e].outputColor[3];n=C.ln.fromValues(t[0],t[1],t[2],s)}else n=C.ln.clone(t);this.controlPoints[e].outputColor=n}findNearestControlPointIndex(e){const n=new Ln(e).normalizedInput(this.range);return this.findNearestControlPointIndexByNormalizedInput(n)}findNearestControlPointIndexByNormalizedInput(e){return(0,F.Lp)(this.controlPoints.map(t=>t.normalizedInput(this.range)),e,(t,n)=>t-n)}sortAndComputeRange(){this.controlPoints.sort((e,t)=>e.normalizedInput(this.range)-t.normalizedInput(this.range)),this.computeRange()}computeRange(){if(this.autoComputeRange)if(this.controlPoints.length==0)this.range=he[this.dataType];else if(this.controlPoints.length===1){let e=he[this.dataType][1];this.dataType===R.FLOAT32&&e<=this.controlPoints[0].inputValue&&(e=this.controlPoints[0].inputValue+1),this.range=[this.controlPoints[0].inputValue,e]}else this.range=[this.controlPoints[0].inputValue,this.controlPoints[this.controlPoints.length-1].inputValue];this.range[0]===this.range[1]&&(this.range=he[this.dataType])}copy(){const e=new zo([],this.dataType,this.autoComputeRange);return e.range=this.range,e.controlPoints=this.controlPoints.map(t=>Ln.copyFrom(t)),e}}class Es{constructor(e){this.lookupTableSize=e,this.outputValues=new Uint8Array(e*xr).fill(0)}resize(e){this.lookupTableSize=e,this.outputValues=new Uint8Array(e*xr).fill(0)}updateFromControlPoints(e,t=void 0){const n=t||e.range,{controlPoints:s}=e,r=this.outputValues,o=this.lookupTableSize;function a(u,h){r[u]=h[0],r[u+1]=h[1],r[u+2]=h[2],r[u+3]=h[3]}function l(u){return u.transferFunctionIndex(n,o)}if(s.length===0){r.fill(0);return}const c=l(s[0]);if(c>0){const u=C.ln.fromValues(0,0,0,0);for(let h=0;h<c;++h){const p=h*xr;a(p,u)}}let d=0;for(let u=c;u<o;++u){const h=s[d],p=u*xr;if(d===s.length-1)a(p,h.outputColor);else{const m=s[d+1],g=l(h),v=l(m),y=(u-g)/(v-g),S=h.interpolateColor(m,y);a(p,S),u>=v&&d++}}}static equal(e,t){return(0,F.r1)(e.outputValues,t.outputValues)}copy(){const e=new Es(this.lookupTableSize);return e.outputValues.set(this.outputValues),e}}class Wx extends T.O8{constructor(e,t,n=Ff[e]){super(),this.dataType=e,this.trackable=t,this.lookupTable=new Es(n),this.updateLookupTable()}get sortedControlPoints(){return this.trackable.value.sortedControlPoints}get range(){return this.sortedControlPoints.range}get size(){return this.lookupTable.lookupTableSize}updateLookupTable(e=void 0){this.lookupTable.updateFromControlPoints(this.sortedControlPoints,e)}addPoint(e){this.sortedControlPoints.addPoint(e)}updatePoint(e,t){return this.sortedControlPoints.updatePoint(e,t)}removePoint(e){this.sortedControlPoints.removePoint(e)}updatePointColor(e,t){this.sortedControlPoints.updatePointColor(e,t)}findNearestControlPointIndex(e,t){const n=de(t,this.dataType,e);return this.sortedControlPoints.findNearestControlPointIndex(n)}}class Uf extends T.O8{constructor(e){super(),this.gl=e,this.texture=null,this.height=1,this.priorOptions=void 0}updateAndActivate(e){const{gl:t}=this;if(t===null)return;let{texture:n}=this;function s(o,a){if(a===void 0)throw new Error("Texture unit must be defined for transfer function texture");o.activeTexture(WebGL2RenderingContext.TEXTURE0+a),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n)}if(n!==null&&this.optionsEqual(e))return s(t,e.textureUnit),this.width*this.height;n===null&&(n=this.texture=t.createTexture()),s(t,e.textureUnit),di(t);const r=this.createLookupTable(e);return t.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA,this.width,this.height,0,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,r.outputValues),this.setOptions(e),this.width*this.height}setTextureWidthAndHeightFromSize(e){this.width=e}disposed(){this.gl?.deleteTexture(this.texture),this.texture=null,this.priorOptions=void 0,super.disposed()}}class Hx extends Uf{constructor(e){super(e),this.gl=e,this.texture=null,this.priorOptions=void 0}optionsEqual(e){const t=this.priorOptions;if(t===void 0)return!1;const n=Es.equal(t.lookupTable,e.lookupTable),s=t.textureUnit===e.textureUnit;return n&&s}createLookupTable(e){return this.setTextureWidthAndHeightFromSize(e.lookupTable.lookupTableSize),e.lookupTable}setOptions(e){this.priorOptions={...e,lookupTable:e.lookupTable.copy()}}}class Jx extends Uf{constructor(e){super(e),this.gl=e}optionsEqual(e){const t=this.priorOptions;if(t===void 0)return!1;const n=(0,F.wm)(t.sortedControlPoints.controlPoints,e.sortedControlPoints.controlPoints,(o,a)=>o.inputValue===a.inputValue&&(0,F.r1)(o.outputColor,a.outputColor)),s=t.textureUnit===e.textureUnit,r=t.dataType===e.dataType;return n&&s&&r}setOptions(e){this.priorOptions={...e,sortedControlPoints:e.sortedControlPoints.copy()}}createLookupTable(e){const t=this.ensureTextureSize(e.lookupTableSize);if(t===void 0)return new Es(0);this.setTextureWidthAndHeightFromSize(t);const n=new Es(t),s=e.sortedControlPoints;return n.updateFromControlPoints(s),n}ensureTextureSize(e){const t=this.gl;if(t===null)return;const n=t.getParameter(t.MAX_TEXTURE_SIZE);return Math.min(e,n)}}class jx extends nc{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controlPointsPositionArray=new Float32Array,this.controlPointsColorArray=new Float32Array,this.linePositionArray=new Float32Array,this.transferFunction=this.registerDisposer(new Wx(this.parent.dataType,this.parent.trackable,$o)),this.controller=this.registerDisposer(new Qx(this.element,this.parent.dataType,this.transferFunction,()=>this.parent.trackable.value,r=>{this.parent.trackable.value=r})),this.dataValuesBuffer=this.registerDisposer(ci(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{const r=new Uint8Array(pi*Ut);for(let o=0;o<pi;++o)for(let a=0;a<Ut;++a)r[o*Ut+a]=o;return r})).value,this.histogramLineShader=this.registerDisposer(ff(this.gl,Bf)),this.transferFunctionLineShader=this.registerDisposer((()=>{const r=new fn(this.gl);return In(r),r.addAttribute("vec4","aLineStartEnd"),r.addOutputBuffer("vec4","out_color",0),r.addVarying("float","vColor"),r.setVertexMain(`
vec4 start = vec4(aLineStartEnd[0], aLineStartEnd[1], 0.0, 1.0);
vec4 end = vec4(aLineStartEnd[2], aLineStartEnd[3], 0.0, 1.0);
emitLine(start, end, 1.0);
`),r.setFragmentMain(`
out_color = vec4(0.35, 0.35, 0.35, getLineAlpha());
`),r.build()})()),this.transferFunctionShader=this.registerDisposer((()=>{const r=new fn(this.gl);return r.addAttribute("vec2","aVertexPosition"),r.addVarying("vec2","vTexCoord"),r.addOutputBuffer("vec4","out_color",0),r.addTextureSampler("sampler2D","uSampler",Vf),r.addUniform("float","uTransferFunctionEnd"),r.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vTexCoord = (aVertexPosition + 1.0) / 2.0;
`),r.setFragmentMain(`
ivec2 texel = ivec2(floor(vTexCoord.x * uTransferFunctionEnd), 0);
out_color = texelFetch(uSampler, texel, 0);
`),r.build()})()),this.controlPointsShader=this.registerDisposer((()=>{const r=new fn(this.gl);return r.addAttribute("vec2","aVertexPosition"),r.addAttribute("vec3","aVertexColor"),r.addVarying("vec3","vColor"),r.addOutputBuffer("vec4","out_color",0),r.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
gl_PointSize = 14.0;
vColor = aVertexColor;
`),r.setFragmentMain(`
float vColorSum = vColor.r + vColor.g + vColor.b;
vec3 bordercolor = vec3(0.0, 0.0, 0.0);
if (vColorSum < 0.4) {
  bordercolor = vec3(1.0, 1.0, 1.0);
}
float dist = distance(gl_PointCoord, vec2(0.5, 0.5));
float alpha = smoothstep(0.25, 0.4, dist);
vec4 tempColor = vec4(mix(vColor, bordercolor, alpha), 1.0);
alpha = 1.0 - smoothstep(0.4, 0.5, dist);
out_color = tempColor * alpha;
`),r.build()})());const{element:t,gl:n}=this;t.classList.add("neuroglancer-transfer-function-panel"),this.textureVertexBufferArray=df($o),this.texture=this.registerDisposer(new Hx(n));function s(r){return ci(n,WebGL2RenderingContext.ARRAY_BUFFER,()=>r).value}this.textureVertexBuffer=this.registerDisposer(s(this.textureVertexBufferArray)),this.controlPointsVertexBuffer=this.registerDisposer(s(this.controlPointsPositionArray)),this.controlPointsColorBuffer=this.registerDisposer(s(this.controlPointsColorArray)),this.linePositionBuffer=this.registerDisposer(s(this.linePositionArray))}get drawOrder(){return 1}updateTransferFunctionPointsAndLines(){const e=this.parent.trackable.value.window;function t(I){return re(e,I)*2-1}function n(I){return I/255*2-1}function s(I){return I/255}function r(I,L,N){for(let k=0;k<Ut;++k)I[L++]=N[0],I[L++]=N[1],I[L++]=N[2],I[L++]=N[3];return L}function o(I){return I>=-1&&I<=1}const{transferFunction:a}=this,{controlPoints:l}=a.trackable.value.sortedControlPoints;let c=Math.max(l.length-1,0);const d=xr-1,u=new Float32Array(l.length*d),h=new Float32Array(l.length*2);let p=0,m=null,g=null;const v=l.map(I=>{const L=t(I.inputValue),N=n(I.outputColor[3]);return{input:L,output:N}});if(l.length>0){const{firstPointIndexInWindow:I,lastPointIndexInWindow:L,pointClosestToLeftEdge:N,pointClosestToRightEdge:k}=E();if(I===null){const O=v[l.length-1].input<-1,V=v[0].input>1;O?D():!V&&l.length>1&&x(N,k)}else{const O=v[I];O.input>-1&&(I>0?b(I,O):m=C.ln.fromValues(O.input,-1,O.input,O.output),c+=1);const V=v[L];V.input<1&&(L<l.length-1?w(L,V):g=C.ln.fromValues(V.input,V.output,1,V.output),c+=1)}}const y=[];for(let I=0;I<l.length;++I){const L=I*d,N=I*2,k=v[I].input,O=v[I].output,{outputColor:V}=l[I];if(u[L]=s(V[0]),u[L+1]=s(V[1]),u[L+2]=s(V[2]),h[N]=k,h[N+1]=O,I===l.length-1)break;if(!(o(k)&&o(O)))continue;c+=1;const z=C.ln.fromValues(k,O,v[I+1].input,v[I+1].output);y.push(z)}const S=new Float32Array(c*_f*Ut);m!==null&&(p=r(S,p,m));for(const I of y)p=r(S,p,I);g!==null&&r(S,p,g),this.controlPointsColorArray=u,this.controlPointsPositionArray=h,this.linePositionArray=S,this.controlPointsVertexBuffer.setData(this.controlPointsPositionArray),this.controlPointsColorBuffer.setData(this.controlPointsColorArray),this.linePositionBuffer.setData(this.linePositionArray);function w(I,L){const N=v[I+1],k=re([L.input,N.input],1),O=de([L.output,N.output],R.FLOAT32,k);g=C.ln.fromValues(L.input,L.output,1,O)}function b(I,L){const N=v[I-1],k=re([N.input,L.input],-1),O=de([N.output,L.output],R.FLOAT32,k);m=C.ln.fromValues(-1,O,L.input,L.output)}function x(I,L){if(c+=1,I===null||L===null)throw new Error("Could not find points closest to the left and right edges");const N=re([I.input,L.input],-1),k=re([I.input,L.input],1),O=de([I.output,L.output],R.FLOAT32,N),V=de([I.output,L.output],R.FLOAT32,k);m=C.ln.fromValues(-1,O,1,V)}function E(){let I=null,L=null,N=null,k=null;for(let O=0;O<l.length;++O){const V=v[O];if(o(V.input)&&(I=I??O,L=O),V.input<-1)N=V;else if(V.input>1){k=V;break}}return{firstPointIndexInWindow:I,lastPointIndexInWindow:L,pointClosestToLeftEdge:N,pointClosestToRightEdge:k}}function D(){const I=l.length-1;c+=1;const L=v[I].output;m=C.ln.fromValues(-1,L,1,L)}}drawIndirect(){const{transferFunctionLineShader:e,gl:t,transferFunctionShader:n,controlPointsShader:s,histogramLineShader:r}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{n.bind();const o=n.attribute("aVertexPosition");t.uniform1f(n.uniform("uTransferFunctionEnd"),$o-1),this.textureVertexBuffer.bindToVertexAttrib(o,2,WebGL2RenderingContext.FLOAT);const a=n.textureUnit(Vf);this.texture.updateAndActivate({lookupTable:this.transferFunction.lookupTable,textureUnit:a}),Ao(this.gl,$o,1),t.disableVertexAttribArray(o),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}if(this.parent.histogramSpecifications.producerVisibility.visible){const{renderViewport:o}=this;r.bind(),vn(r,{width:o.logicalWidth,height:o.logicalHeight},1);const a=r.textureUnit(Bf);t.uniform1f(r.uniform("uBoundsFraction"),le(this.parent.dataType,this.parent.trackable.value.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+a),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),di(t);const l=r.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(l,1,WebGL2RenderingContext.UNSIGNED_BYTE),mn(t,pi,1),t.disableVertexAttribArray(l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}if(this.controlPointsPositionArray.length>0){const{renderViewport:o}=this;e.bind();const a=e.attribute("aLineStartEnd");this.linePositionBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT),vn(e,{width:o.logicalWidth,height:o.logicalHeight},1),mn(t,this.linePositionArray.length/(Ut*_f),1),t.disableVertexAttribArray(a),s.bind();const l=s.attribute("aVertexPosition");this.controlPointsVertexBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT);const c=s.attribute("aVertexColor");this.controlPointsColorBuffer.bindToVertexAttrib(c,3,WebGL2RenderingContext.FLOAT),t.drawArrays(t.POINTS,0,this.controlPointsPositionArray.length/2),t.disableVertexAttribArray(l),t.disableVertexAttribArray(c)}t.disable(WebGL2RenderingContext.BLEND)}update(){this.transferFunction.updateLookupTable(this.parent.trackable.value.window),this.updateTransferFunctionPointsAndLines()}isReady(){return!0}}function Yx(i,e){function t(r){const o=document.createElement("input");return o.addEventListener("focus",()=>{o.select()}),o.classList.add("neuroglancer-transfer-function-widget-bound"),o.type="text",o.spellcheck=!1,o.autocomplete="off",o.title=`${r===0?"Lower":"Upper"} window for transfer function`,o}const n=document.createElement("div");n.classList.add("neuroglancer-transfer-function-window-bounds");const s=[t(0),t(1)];for(let r=0;r<2;++r){const o=s[r];o.addEventListener("input",()=>{Ec(o)}),o.addEventListener("change",()=>{const a=e.value.window,l={range:a,window:a};try{const c=qt(i,o.value),d=Sr(l,"window",r,c,!0).window;if(d[0]===d[1])throw new Error("Window bounds cannot be equal");e.value={...e.value,window:d}}catch{br(o,a[r])}})}return n.appendChild(s[0]),n.appendChild(s[1]),{container:n,inputs:s}}const kc=Ae.fromObject({"shift?+mousedown0":{action:"add-or-drag-point"},"shift+dblclick0":{action:"remove-point"},"shift?+mousedown2":{action:"change-point-color"},"shift?+wheel":{action:"zoom-via-wheel"}});class Qx extends T.O8{constructor(e,t,n,s,r){super(),this.element=e,this.dataType=t,this.transferFunction=n,this.getModel=s,this.setModel=r,this.currentGrabbedControlPointIndex=-1,e.title=kc.describe(),this.registerDisposer(new tn(e,kc)),Z(e,"add-or-drag-point",o=>{const a=o.detail;this.updateValue(this.addControlPoint(a)),zt(a,l=>{this.updateValue(this.moveControlPoint(l))})}),Z(e,"remove-point",o=>{const a=o.detail,l=this.findControlPointIfNearCursor(a);l!==-1&&(this.transferFunction.removePoint(l),this.updateValue({...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}))}),Z(e,"change-point-color",o=>{const a=o.detail,l=this.findControlPointIfNearCursor(a);if(l!==-1){const c=this.transferFunction.trackable.value.defaultColor,d=this.convertPanelSpaceColorToAbsoluteValue(c);this.transferFunction.updatePointColor(l,d),this.updateValue({...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints})}}),Z(e,"zoom-via-wheel",o=>{const a=o.detail,l=_i(a),c=this.getTargetFraction(a),{dataType:d}=this,u=this.getModel(),h=de(u.window,d,c*(1-l)),p=de(u.window,d,(1-c)*l+c);h!==p&&this.setModel({...u,window:[h,p]})})}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}updateValue(e){e!==void 0&&this.setModel(e)}convertPanelSpaceInputToAbsoluteValue(e){return de(this.transferFunction.trackable.value.window,this.dataType,e)}convertPanelSpaceColorToAbsoluteValue(e){return e.length===3?C.eR.fromValues(Math.round(e[0]*255),Math.round(e[1]*255),Math.round(e[2]*255)):C.ln.fromValues(Math.round(e[0]*255),Math.round(e[1]*255),Math.round(e[2]*255),Math.round(e[3]*255))}addControlPoint(e){const t=this.transferFunction.trackable.value.defaultColor,n=this.findControlPointIfNearCursor(e);if(n!==-1){this.currentGrabbedControlPointIndex=n;return}const s=this.getControlPointPosition(e);if(s===void 0)return;const{normalizedX:r,normalizedY:o}=s,a=C.ln.fromValues(t[0],t[1],t[2],o);return this.transferFunction.addPoint(new Ln(this.convertPanelSpaceInputToAbsoluteValue(r),this.convertPanelSpaceColorToAbsoluteValue(a))),this.currentGrabbedControlPointIndex=this.findControlPointIfNearCursor(e),{...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}}moveControlPoint(e){if(this.currentGrabbedControlPointIndex!==-1){const t=this.getControlPointPosition(e);if(t===void 0)return;const{normalizedX:n,normalizedY:s}=t,r=this.transferFunction.trackable.value.sortedControlPoints.controlPoints[this.currentGrabbedControlPointIndex].outputColor;return r[3]=Math.round(s*255),this.currentGrabbedControlPointIndex=this.transferFunction.updatePoint(this.currentGrabbedControlPointIndex,new Ln(this.convertPanelSpaceInputToAbsoluteValue(n),r)),{...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}}}getControlPointPosition(e){const t=this.element.getBoundingClientRect();let n=(e.clientX-t.left)/t.width,s=(t.bottom-e.clientY)/t.height;if(!(n<0||n>1||s<0||s>1))return n<Go/3?n=0:n>1-Go/3&&(n=1),s<Go?s=0:s>1-Go&&(s=1),{normalizedX:n,normalizedY:s}}findControlPointIfNearCursor(e){const{transferFunction:t}=this,{window:n}=t.trackable.value,s=t.sortedControlPoints.controlPoints.length;function r(S){return S<0||S>=s?null:re(n,t.sortedControlPoints.controlPoints[S].inputValue)}function o(S){return S<0||S>=s?null:t.sortedControlPoints.controlPoints[S].outputColor[3]/255}const a=this.getControlPointPosition(e);if(a===void 0)return-1;const l=a.normalizedX,c=a.normalizedY,d=t.findNearestControlPointIndex(l,n);if(d===-1)return-1;const u=r(d);if(Math.abs(l-u)>Rc)return-1;const h=[[d,Math.abs(o(d)-c)]],p=r(d+1);(p!==null?Math.abs(p-l):1/0)<=Rc&&h.push([d+1,Math.abs(o(d+1)-c)]);const g=r(d-1);return(g!==null?Math.abs(g-l):1/0)<=Rc&&h.push([d-1,Math.abs(o(d-1)-c)]),h.sort((S,w)=>S[1]-w[1])[0][0]}}class Kx extends Gt{constructor(e,t,n,s,r,o){super(e),this.display=t,this.dataType=n,this.trackable=s,this.histogramSpecifications=r,this.histogramIndex=o,this.transferFunctionPanel=this.registerDisposer(new jx(this)),this.window=Yx(this.dataType,this.trackable),this.registerDisposer(r.visibility.add(this.visibility));const{element:a}=this;a.classList.add("neuroglancer-transfer-function-widget"),a.appendChild(this.transferFunctionPanel.element),a.appendChild(this.window.container),this.window.container.dispatchEvent(new Event("change"));const l=document.createElement("div");l.classList.add("neuroglancer-transfer-function-color-picker");const c=this.registerDisposer(new hi((0,_.Uq)(d=>d.defaultColor,[s]),()=>C.eR.fromValues(1,1,1)));c.element.title="Transfer Function Color Picker",c.element.id="neuroglancer-tf-color-widget",c.element.addEventListener("change",()=>{s.value={...this.trackable.value,defaultColor:c.model.value}}),c.element.addEventListener("input",()=>{s.value={...this.trackable.value,defaultColor:c.model.value}}),l.appendChild(c.element),a.appendChild(l),this.updateControlPointsAndDraw(),this.registerDisposer(this.trackable.changed.add(()=>{this.updateControlPointsAndDraw()}))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}updateView(){for(let e=0;e<2;++e)br(this.window.inputs[e],this.trackable.value.window[e]);this.transferFunctionPanel.scheduleRedraw()}updateControlPointsAndDraw(){this.transferFunctionPanel.update(),this.updateView()}}function qx(i,e,t,n){i.addUniform("highp float",`uTransferFunctionEnd_${e}`),i.addTextureSampler("sampler2D",`uTransferFunctionSampler_${e}`,`TransferFunction.${e}`);const s=Ss(i,e,t,!0),r=yt(t);let o=`
vec4 ${e}_(float inputValue) {
  int index = clamp(int(round(inputValue * uTransferFunctionEnd_${e})), 0, int(uTransferFunctionEnd_${e}));
  return texelFetch(uTransferFunctionSampler_${e}, ivec2(index, 0), 0);
}
vec4 ${e}(${r} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  defaultMaxProjectionIntensity = v;
  return v < 0.0 ? vec4(0.0, 0.0, 0.0, 0.0) : ${e}_(clamp(v, 0.0, 1.0));
}
vec4 ${e}() {
  return ${e}(getDataValue(${n.join(",")}));
}
`;if(t!==R.UINT64&&t!==R.FLOAT32){const a=ae[t]?"int":"uint";o+=`
vec4 ${e}(${a} inputValue) {
  return ${e}(${r}(inputValue));
}
`}return[s[0],s[1],s[2],o]}function Xx(i,e,t,n,s=Ff[t]){const{gl:r}=i;i.transferFunctionTextures.get(`TransferFunction.${e}`)===void 0&&i.transferFunctionTextures.set(`TransferFunction.${e}`,new Jx(r));const a=i.bindAndUpdateTransferFunctionTexture(`TransferFunction.${e}`,n,t,s);if(a===void 0)throw new Error("Failed to create transfer function texture");r.uniform1f(i.uniform(`uTransferFunctionEnd_${e}`),a-1);const l=n.range;Ni(i,e,t,l)}function Zx(i,e){i.bindInputEventMap(kc)}function eE(i){return{makeControl:(e,t,n)=>{const{watchableValue:s,channelCoordinateSpaceCombiner:r,defaultChannel:o,histogramSpecifications:a,histogramIndex:l,dataType:c}=i(e);if(r!==void 0&&o.length!==0){const u=t.registerDisposer(new ui(r.combined)),h=t.registerDisposer(new xs(u,r,{copyButton:!1}));t.registerDisposer(u.changed.add(()=>{const m=u.value,g=Array.from(m,y=>Math.floor(y)),v=s.value;(0,F.r1)(v.channel,g)||(s.value={...s.value,channel:g})}));const p=()=>{const m=u.value,g=s.value;(0,F.r1)(g.channel,m)||(m.set(g.channel),u.changed.dispatch())};p(),t.registerDisposer(s.changed.add(p)),n.labelContainer.appendChild(h.element)}const d=t.registerDisposer(new Kx(n.visibility,n.display,c,s,a,l));return{control:d,controlElement:d.element}},activateTool:(e,t)=>{Zx(e,t)}}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function tE(i){const e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/gm;return i.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function nE(i){const e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/;let t=0;const n=i;e:for(;i.length;){const s=i.match(e);if(s===null)break;const r=s[0];switch(r.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){i=i.substring(r.length);break e}break}i=i.substring(r.length)}return t!==0?-1:n.length-i.length}function iE(i){const e=[],t=new Map;if(i===void 0)return{errors:e,parameters:t};const n=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;i=i.trim(),i.length!==0;){const s=i.match(n);if(s===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}const r=s[1];i=i.substring(s[0].length);const o=nE(i);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a;try{a=JSON.parse(i.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${r}: ${a}`);break}t.has(r)?e.push(`Duplicate #uicontrol parameter: ${r}`):t.set(r,a),i=i.substring(o),i=i.trim(),i.length>0&&!i.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),i=i.substring(1)}return{parameters:t,errors:e}}function sE(i,e){let t,n,s,r;const o=[];i!=="float"&&i!=="uint"&&i!=="int"&&o.push("type must be float, int, or uint");for(const[a,l]of e){const c=()=>{if(typeof l!="number"){o.push(`Expected ${a} argument to be a number`);return}return(i==="int"||i==="uint")&&(Number.isInteger(l)||o.push(`Expected ${a} argument to be an integer`),i==="uint"&&l<0&&o.push(`Expected ${a} argument to be an unsigned integer`)),l};a==="min"?t=c():a==="max"?n=c():a==="default"?r=c():a==="step"?s=c():o.push(`Invalid parameter: ${a}`)}return t===void 0&&o.push("min must be specified"),n===void 0&&o.push("max must be specified"),t!==void 0&&n!==void 0&&(t>n&&o.push("min must be less than max"),s===void 0&&(i==="float"?s=(n-t)/100:s=1),r!==void 0?(r<t||r>n)&&o.push("default must be within valid range"):i==="float"?r=(t+n)/2:r=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:i,min:t,max:n,step:s,default:r},errors:void 0}}function rE(i,e){let t=!1;const n=[];i!=="bool"&&n.push("type must be bool");for(const[s,r]of e)if(s==="default"){if(typeof r!="boolean"){n.push(`Expected ${s} argument to be a boolean`);continue}t=r}else n.push(`Invalid parameter: ${s}`);return n.length>0?{errors:n}:{control:{type:"checkbox",valueType:i,default:t},errors:void 0}}function oE(i,e){let t="white";const n=[];i!=="vec3"&&n.push("type must be vec3");for(const[s,r]of e)s==="default"?typeof r!="string"?n.push("Expected default argument to be a string"):t=r:n.push(`Invalid parameter: ${s}`);return n.length>0?{errors:n}:{control:{type:"color",valueType:i,defaultString:t,default:me(t)},errors:void 0}}function Wo(i,e){typeof i=="number"&&(i=[i]);const t=new Array(e);return(0,f.Xu)(t,i,n=>{if(!Number.isInteger(n)||n<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(n)}`);return n}),t}function aE(i,e,t){const{imageData:n,properties:s}=t;if(n!==void 0)return lE(i,e,n);if(s!==void 0)return cE(i,e,s);const r=[];return r.push("invlerp control not supported"),{errors:r}}function lE(i,e,t){const n=[];i!=="invlerp"&&n.push("type must be invlerp");let s=new Array(t.channelRank).fill(0);const{dataType:r}=t;let o=!0,a=he[r],l;for(const[c,d]of e)try{switch(c){case"range":{a=Lt(d,r);break}case"window":{l=et(Lt(d,r));break}case"clamp":{typeof d!="boolean"?n.push(`Invalid clamp value: ${JSON.stringify(d)}`):o=d;break}case"channel":{s=Wo(d,s.length);break}default:n.push(`Invalid parameter: ${c}`);break}}catch(u){n.push(`Invalid ${c} value: ${u.message}`)}return n.length>0?{errors:n}:{control:{type:"imageInvlerp",dataType:r,clamp:o,default:{range:a,window:l??st(a),channel:s}},errors:void 0}}function cE(i,e,t){const n=[];i!=="invlerp"&&n.push("type must be invlerp");let s=!0,r,o,a;for(const[c,d]of e)try{switch(c){case"range":{r=Ii(d);break}case"window":{o=Ii(d);break}case"clamp":{typeof d!="boolean"?n.push(`Invalid clamp value: ${JSON.stringify(d)}`):s=d;break}case"property":{const u=(0,f.zr)(d);if(!t.has(u))throw new Error(`Property not defined: ${JSON.stringify(a)}`);a=u;break}default:n.push(`Invalid parameter: ${c}`);break}}catch(u){n.push(`Invalid ${c} value: ${u.message}`)}if(n.length>0)return{errors:n};if(a===void 0)for(const c of t.keys()){a=c;break}const l=t.get(a);return r!==void 0&&(r=Ce(r,l)),o!==void 0&&(o=Ce(o,l)),{control:{type:"propertyInvlerp",clamp:s,properties:t,default:{range:r,window:o,property:a,dataType:l}},errors:void 0}}function dE(i,e,t){const n=t.imageData,s=n?.dataType,r=n?.channelRank,o=[];let a=new Array(r).fill(0),l=C.eR.fromValues(1,1,1),c,d=new zo([],s!==void 0?s:R.FLOAT32),u=!1;i!=="transferFunction"&&o.push("type must be transferFunction"),s===void 0&&o.push("image data must be provided to use a transfer function");for(const[h,p]of e)try{switch(h){case"channel":{a=Wo(p,a.length);break}case"defaultColor":{l=me(p);break}case"window":{s!==void 0&&(c=et(Lt(p,s)));break}case"controlPoints":{u=!0,s!==void 0&&(d=zf(p,s));break}default:o.push(`Invalid parameter: ${h}`);break}}catch(m){o.push(`Invalid ${h} value: ${m.message}`)}if(c===void 0&&(c=d.range),d.length===0&&!u&&s!==void 0){const h=de(c,s,.4),p=de(c,s,.7);d.addPoint(new Ln(h,C.yb)),d.addPoint(new Ln(p,C.ln.fromValues(255,255,255,255)))}return o.length>0?{errors:o}:{control:{type:"transferFunction",dataType:s,default:{sortedControlPoints:d,channel:a,defaultColor:l,window:c}},errors:void 0}}const uE=new Map([["slider",sE],["color",oE],["invlerp",aE],["checkbox",rE],["transferFunction",dE]]);function Er(i,e={}){i=tE(i);const t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/gm,n=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,s=[],r=new Map,o=i.replace(t,(a,l,c)=>{const d=l.match(n),u=()=>Math.max(0,i.substring(0,c).split(`
`).length-1);if(d===null)return s.push({line:u(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";const h=d[1],p=d[2],m=d[3]??h,g=d[4],{parameters:v,errors:y}=iE(g);for(const b of y)s.push({line:u(),message:b});if(r.has(p)&&s.push({line:u(),message:`Duplicate definition for control ${p}`}),y.length>0)return"";const S=uE.get(m);if(S===void 0)return s.push({line:u(),message:`Invalid control type ${m}`}),"";const w=S(h,v,e);if(w.errors!==void 0){for(const b of w.errors)s.push({line:u(),message:b});return""}return r.set(p,w.control),""});return{source:i,code:o,errors:s,controls:r}}function $f(i){return`u_shaderControl_${i}`}function Ts(i,e){const{builderValues:t}=i;for(const[n,s]of i.parseResult.controls){const r=$f(n),o=t[n];switch(s.type){case"imageInvlerp":{const a=[Ss(e,r,s.dataType,s.clamp),`
float ${r}() {
  return ${r}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(a),e.addFragmentCode(`#define ${n} ${r}
`);break}case"propertyInvlerp":{const a=o.property,l=s.properties.get(a),c=[Ss(e,r,l,s.clamp),`
float ${r}() {
  return ${r}(prop_${a}());
}
`];e.addVertexCode(c),e.addVertexCode(`#define ${n} ${r}
`);break}case"checkbox":{const a=`#define ${n} ${o.value}
`;e.addFragmentCode(a),e.addVertexCode(a);break}case"transferFunction":{e.addFragmentCode(`#define ${n} ${r}
`),e.addFragmentCode(qx(e,r,s.dataType,o.channel));break}default:{e.addUniform(`highp ${s.valueType}`,r),e.addVertexCode(`#define ${n} ${r}
`),e.addFragmentCode(`#define ${n} ${r}
`);break}}}}function hE(i){const e={};for(const[t,n]of i)e[t]=n;return e}function pE(i,e){return e instanceof Map?Array.from(e.entries()):e}function Gf(i){if(i!==void 0)return JSON.stringify(hE(i),pE)}class fE{constructor(){this.changed=new j.IY,this.controls=void 0}get value(){return this.controls}set value(e){Gf(e)!==Gf(this.controls)&&(this.controls=e,this.changed.dispatch())}}function gE(i,e,t){return i===void 0?t:((0,f.Rf)(i),{range:(0,f.MM)(i,"range",n=>Lt(n,e),t.range),window:(0,f.MM)(i,"window",n=>et(Lt(n,e)),t.window),channel:(0,f.MM)(i,"channel",n=>Wo(n,t.channel.length),t.channel)})}class mE extends _.DN{constructor(e,t){super(t,n=>gE(n,e,t)),this.dataType=e,this.defaultValue=t}toJSON(){const{value:{range:e,window:t,channel:n},dataType:s,defaultValue:r}=this,o=A(e,s,r.range),a=A(t,s,r.window),l=(0,F.r1)(r.channel,n)?void 0:n;if(!(o===void 0&&a===void 0&&l===void 0))return{range:o,window:a,channel:l}}}function vE(i,e,t){if(i===void 0)return t;(0,f.Rf)(i);const n=(0,f.MM)(i,"property",r=>{if(r=(0,f.zr)(r),!e.has(r))throw new Error(`Invalid value: ${JSON.stringify(r)}`);return r},t.property),s=e.get(n);return{property:n,dataType:s,range:(0,f.MM)(i,"range",r=>Lt(r,s),t.range),window:(0,f.MM)(i,"window",r=>et(Lt(r,s)),t.window)}}class yE extends _.DN{constructor(e,t){super(t,n=>vE(n,e,t)),this.properties=e,this.defaultValue=t}toJSON(){const{value:{range:e,window:t,property:n,dataType:s},defaultValue:r}=this,o=he[s],a=A(e??o,s,r.range??o),l=A(t??o,s,r.window??o),c=n===r.property?void 0:n;if(!(a===void 0&&l===void 0&&c===void 0))return{range:a,window:l,property:c}}}function zf(i,e){const t=(0,f.$v)(i,n=>{const s=e===R.UINT64&&typeof n[0]=="string"||typeof n[0]=="number";if(n.length!==3||!s||typeof n[1]!="string"||typeof n[2]!="number")throw new Error(`Expected array of length 3 (x, "#RRGGBB", A), but received: ${JSON.stringify(n)}`);const r=qt(e,n[0]);if(n[1].length!==7||n[1][0]!=="#")throw new Error(`Expected #RRGGBB, but received: ${JSON.stringify(n[1])}`);if(n[2]<0||n[2]>1)throw new Error(`Expected opacity in range [0, 1], but received: ${JSON.stringify(n[2])}`);const o=me(n[1]);function a(l){return Math.min(255,Math.max(Math.round(l*255),0))}return new Ln(r,C.ln.fromValues(a(o[0]),a(o[1]),a(o[2]),a(n[2])))});return new zo(t,e)}function SE(i,e,t){if(i===void 0)return t;(0,f.Rf)(i);const n=(0,f.MM)(i,"controlPoints",r=>zf(r,e),t.sortedControlPoints),s=(0,f.MM)(i,"window",r=>Lt(r,e),t.window);return{sortedControlPoints:n,channel:(0,f.MM)(i,"channel",r=>Wo(r,t.channel.length),t.channel),defaultColor:(0,f.MM)(i,"defaultColor",r=>me(r),t.defaultColor),window:s}}function bE(i){return{...i,sortedControlPoints:i.sortedControlPoints.copy()}}class CE extends _.DN{constructor(e,t){const n=bE(t);super(n,s=>SE(s,e,n)),this.dataType=e,this.defaultValue=t}controlPointsToJson(e,t){function n(s){return t===R.UINT64?s.toJSON():s}return e.map(s=>[n(s.inputValue),Ge(C.eR.fromValues(s.outputColor[0]/255,s.outputColor[1]/255,s.outputColor[2]/255)),s.outputColor[3]/255])}toJSON(){const{value:{channel:e,sortedControlPoints:t,defaultColor:n,window:s},dataType:r,defaultValue:o}=this,a=A(s,r,o.window),l=(0,F.r1)(o.channel,e)?void 0:e,c=(0,F.r1)(o.defaultColor,n)?void 0:Ge(n),d=(0,F.wm)(o.sortedControlPoints.controlPoints,t.controlPoints,(u,h)=>(0,F.r1)(u.outputColor,h.outputColor)&&u.inputValue===h.inputValue)?void 0:this.controlPointsToJson(t.controlPoints,r);if(!(l===void 0&&c===void 0&&d===void 0&&a===void 0))return{channel:l,defaultColor:c,controlPoints:d,window:a}}}function Wf(i){switch(i.type){case"slider":return{trackable:new _.DN(i.default,e=>{let t;if(i.valueType==="float"?t=(0,f.zo)(e):t=(0,f.bX)(e),t<i.min||t>i.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${i.min}, ${i.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new q(i.default),getBuilderValue:()=>null};case"imageInvlerp":return{trackable:new mE(i.dataType,i.default),getBuilderValue:e=>({channel:e.channel,dataType:i.dataType})};case"propertyInvlerp":return{trackable:new yE(i.properties,i.default),getBuilderValue:e=>({property:e.property,dataType:e.dataType})};case"checkbox":return{trackable:new nt(i.default),getBuilderValue:e=>({value:e})};case"transferFunction":return{trackable:new CE(i.dataType,i.default),getBuilderValue:e=>({channel:e.channel,dataType:i.dataType})}}}function Hf(i,e){return JSON.stringify(i)+"\0"+e.source}function Ho(i){const e={},t=[];for(const[n,s]of i.controls){const{trackable:r,getBuilderValue:o}=Wf(s),a=o(r.value);e[n]=a,s.type==="propertyInvlerp"&&t.push(a.property)}return{builderValues:e,parseResult:i,key:Hf(e,i),referencedProperties:t}}class Jo extends T.O8{constructor(e,t=(0,_.XZ)({}),n){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=n,this.changed=new j.IY,this.controls=new fE,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new j.IY,this.state_=new Map,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();const s=this;this.parseErrors={changed:this.parseResultChanged,get value(){return s.handleFragmentMainChanged(),s.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return s.handleFragmentMainChanged(),s.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return s.parseResult_}},this.builderState=(0,_.Uq)((l,c)=>{const d={},u=[];for(const[h,{control:p,trackable:m,getBuilderValue:g}]of c){const v=g(m.value);d[h]=v,p.type==="propertyInvlerp"&&u.push(v.property)}return{key:Hf(d,l),parseResult:l,builderValues:d,referencedProperties:u}},[this.parseResult,this],(l,c)=>l.key===c.key);const r=(0,_.Uq)(l=>{const c=[];for(const{control:d,trackable:u}of l.values())d.type!=="imageInvlerp"&&d.type!=="transferFunction"||c.push({channel:u.value.channel});return c},[this],(l,c)=>(0,F.wm)(l,c,(d,u)=>(0,F.r1)(d.channel,u.channel))),o=(0,_.Uq)(l=>{const c=[];for(const{control:d,trackable:u}of l.values())d.type==="propertyInvlerp"&&c.push(u.value.property);return c},[this],F.r1),a=(0,_.ol)(l=>{const c=[];for(const{control:d,trackable:u}of l.values())if(d.type==="imageInvlerp"||d.type==="transferFunction")c.push(u.value.window);else if(d.type==="propertyInvlerp"){const{dataType:h,range:p,window:m}=u.value;c.push(m??p??he[h])}return c},this);this.histogramSpecifications=this.registerDisposer(new Np(r,o,a))}handleFragmentMainChanged(){const e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;const n=this.dataContext.value;if(n===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{const s=this.parseResult_=Er(this.fragmentMain.value,n);this.parseErrors_=s.errors,this.processedFragmentMain_=s.code,s.errors.length===0&&(this.controls.value=s.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){const e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;const t=this.controls.value;if(t===void 0)return;let n=!1;const{state_:s,unparsedJson:r}=this;for(const[o,a]of s)t.get(o)===void 0&&(a.trackable.changed.remove(this.changed.dispatch),s.delete(o),n=!0);for(const[o,a]of t){let l=s.get(o);if(l!==void 0&&JSON.stringify(l.control)!==JSON.stringify(a)&&(l.trackable.changed.remove(this.changed.dispatch),l=void 0),l===void 0){const{trackable:c,getBuilderValue:d}=Wf(a);l={control:a,trackable:c,getBuilderValue:d},l.trackable.changed.add(this.changed.dispatch),s.set(o,l),n=!0}if(r!==void 0&&Object.prototype.hasOwnProperty.call(r,o)){n=!0;try{l.trackable.restoreState(r[o])}catch{}}}r!==void 0&&(n=!0),this.unparsedJson=void 0,n&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;const{state:t}=this;if((0,f.Rf)(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(const[s,r]of t){const{trackable:o}=r;if(o.reset(),Object.prototype.hasOwnProperty.call(e,s))try{o.restoreState(e[s])}catch{}}this.unparsedJson=void 0}reset(){for(const e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){const{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;const n={};let s=!0;for(const[r,o]of e){const a=o.trackable.toJSON();a!==void 0&&(n[r]=a,s=!1)}if(!s)return n}}function Jf(i,e,t,n,s){const r=$f(t),o=e.uniform(r);switch(n.type){case"slider":switch(n.valueType){case"int":case"uint":i.uniform1i(o,s);break;case"float":i.uniform1f(o,s)}break;case"color":i.uniform3fv(o,s);break;case"imageInvlerp":Ni(e,r,n.dataType,s.range);break;case"propertyInvlerp":{const{dataType:a}=s;Ni(e,r,a,s.range??he[a]);break}case"checkbox":break;case"transferFunction":Xx(e,r,n.dataType,s.sortedControlPoints)}}function vi(i,e,t,n){const{state:s}=t;if(t.controls.value===n)for(const[r,o]of s)Jf(i,e,r,o.control,o.trackable.value);else for(const[r,o]of n){const a=s.get(r),l=a!==void 0&&JSON.stringify(a.control)===JSON.stringify(o)?a.trackable.value:o.default;Jf(i,e,r,o,l)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wE extends _.B0{}class xE extends rc{constructor(){super((e,{showMatches:t,segmentationState:n})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(n.changed.add(this.changed.dispatch)),e.registerDisposer((0,_.no)((s,r)=>{if(r==null)return;const{segmentationGroupState:o}=r;s.registerDisposer(o.changed.add(this.changed.dispatch)),s.registerDisposer((0,_.no)((a,l)=>{const{visibleSegments:c}=l;let d=c.size===0;a.registerDisposer(c.changed.add(()=>{const u=c.size===0;u!==d&&(d=u,this.changed.dispatch())}))},o))},n))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new _.B0(void 0),showMatches:new nt(!1)},super.set(e,t)),t}}const jf=`
void main() {
  setColor(defaultColor());
}
`;class Yf extends T.O8{constructor(){super(...arguments),this.annotationProperties=new _.B0(void 0),this.shader=Co(jf),this.shaderControls=new Jo(this.shader,(0,_.ol)(e=>{const t=new Map;if(e===void 0)return null;for(const n of e){const s=kl[n.type];s!==void 0&&t.set(n.identifier,s)}return{properties:t}},this.annotationProperties)),this.fallbackShaderControls=new _.B0(Ho(Er(jf))),this.shaderError=dr(),this.color=new q(C.eR.fromValues(1,1,0)),this.relationshipStates=this.registerDisposer(new xE),this.ignoreNullSegmentFilter=new nt(!0),this.swapVisibleSegmentsOnMove=new nt(!0),this.disablePicking=new _.B0(!1),this.displayUnfiltered=(0,_.ol)((e,t)=>{for(const n of e.values())if(n.showMatches.value){if(!t)return!1;const s=n.segmentationState.value;if(s!=null&&s.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter),this.hoverState=new wE(void 0)}}class jo extends T.O8{constructor(e){super();const{transform:t,localPosition:n,source:s,role:r=li.ANNOTATION}=e;this.transform=t,this.localPosition=n,this.source=this.registerDisposer(s),this.role=r,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer((0,_.ol)(o=>bo(()=>po(sc(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex,this.subsubsourceId=e.subsubsourceId}get sourceIndex(){const{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}}var Qf=G(9459);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yo=!1,EE=!1,TE=C.pB.create();function DE(i,e){let t=0,n=Math.abs(i.detTransform);const{transform:s,size:r}=i;for(let o=0;o<3;++o){let a=0;for(let c=0;c<3;++c)a+=e[c*4+2]*s[4*o+c];const l=r[o];t+=Math.abs(a)*l,n*=l}return n/t}function Kf(i,e,t){const{curPositionInChunks:n,fixedPositionWithinChunk:s}=i,{nonDisplayLowerClipBound:r,nonDisplayUpperClipBound:o}=i,{rank:a,chunkDataSize:l}=i.source.spec;if(!gs(n,e,t,i.layerRank,i.fixedLayerToChunkTransform))return!1;for(let c=0;c<a;++c){const d=n[c];if(d<r[c]||d>=o[c])return Yo&&console.log("excluding source",i,`because of chunkDim=${c}, sum=${d}`,r,o,i.fixedLayerToChunkTransform),!1;const u=l[c],h=n[c]=Math.floor(d/u);s[c]=d-h*u}return!0}function IE(i,e){const t=e.length;let n=0;if(Yo&&console.log(e),t>1){let s=0;for(let r=0;r<t;++r){const o=e[r],{chunkLayout:a}=o,l=DE(a,i);Yo&&console.log(`chunksize = ${a.size}, sliceArea = ${l}`),l>s&&(s=l,n=r)}}return n}const Ds=new Qf.i(C.eR.create(),C.pB.create(),0);class LE extends op{constructor(){super(...arguments),this.viewportNormalInGlobalCoordinates=C.eR.create(),this.viewportNormalInCanonicalCoordinates=C.eR.create(),this.centerDataPosition=C.eR.create(),this.pixelSize=0}}function RE(i,e){if(i.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||i.pixelSize!==e.pixelSize)return!0;const{viewMatrix:t}=i,{viewMatrix:n}=e;for(let s=0;s<12;++s)if(t[s]!==n[s])return!0;return!1}class kE extends hn{constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new Map,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((t,n)=>{RE(t,n)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;const e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(const[n,s]of t){const{allSources:r,visibleSources:o}=s;if(o.length=0,r.length===0||!qw(s,e))continue;const a=IE(this.projectionParameters.value.viewMatrix,r.map(c=>c[0])),l=r[a];for(const c of n.filterVisibleSources(this,l))o.push(c);o.reverse(),Yo&&console.log("visible sources chosen",o)}}}const PE=18;function Qo(i){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:n=PE,chunkToViewTransform:s,displayRank:r,minBlockSize:o,maxBlockSize:a}=i;const{lowerVoxelBound:l=new Uint32Array(e)}=i,c=new Float32Array(e);for(let p=0;p<e;++p){let m=0;for(let g=0;g<r;++g){const v=s[p*r+g];m+=v*v}c[p]=Math.sqrt(m)}const d=new Uint32Array(e);o!==void 0?d.set(o):d.fill(1);const u=new Array(e);for(let p=0;p<e;++p){let m=Number.POSITIVE_INFINITY;c[p]===0?m=d[p]:(t!==void 0&&(m=2**Math.floor(Math.log2(t[p]-l[p]))),a!==void 0&&(m=Math.min(m,a[p]))),u[p]=m}function h(){let p=1/0,m=-1;for(let g=0;g<e;++g){if(d[g]>=u[g])continue;const v=d[g]*c[g];v<p&&(p=v,m=g)}return m}n-=Math.log2($l(d));for(let p=0;p<n;++p){const m=h();if(m===-1)break;d[m]*=2}return d}function AE(i){const e=[],{displayRank:t,chunkToViewTransform:n,rank:s}=i;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[Qo(i)];for(let r=0;r<3;++r){const o=(r+2)%3,a=new Float32Array(n);for(let l=0;l<s;++l)a[l*t+o]=0;e[r]=Qo({...i,chunkToViewTransform:a})}return e}var qf=(i=>(i[i.ISOTROPIC=0]="ISOTROPIC",i[i.FLAT=1]="FLAT",i))(qf||{});function zV(i,e,t){return t===void 0?e:matrix.multiply(new Float32Array((i+1)*(i+1)),i+1,e,i+1,t,i+1,i+1,i+1,i+1)}function ME(i){if(i.chunkDataSizes!==void 0)return i.chunkDataSizes;const{chunkLayoutPreference:e=0}=i;switch(e){case 0:return[Qo(i)];case 1:return AE(i)}}function Ko(i){const{rank:e,chunkDataSize:t,upperVoxelBound:n}=i,{lowerVoxelBound:s=new Float32Array(e)}=i,r=new Float32Array(e),o=new Float32Array(e);for(let a=0;a<e;++a)r[a]=Math.floor(s[a]/t[a]),o[a]=Math.floor((n[a]-1)/t[a]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:r,upperChunkBound:o,lowerVoxelBound:s,upperVoxelBound:n}}function*NE(i,e,t){const n=i.projectionParameters.value.pixelSize*1.1,s=t[0].effectiveVoxelSize,r=e.renderScaleTarget.value,o=d=>{const u=n*r;for(let h=0;h<3;++h){const p=d[h];if(p>u&&p>1.01*s[h])return!0}return!1},a=(d,u)=>{const h=n*r;for(let p=0;p<3;++p){const m=d[p],g=u[p];if(Math.abs(h-m)<Math.abs(h-g)&&m<1.01*g)return!0}return!1};let l=t.length-1,c;for(;;){const d=t[l];if(c!==void 0&&!a(d.effectiveVoxelSize,c)||(yield d,l===0||!o(d.effectiveVoxelSize)))break;c=d.effectiveVoxelSize,--l}}const OE="SliceView",_E="sliceview/RenderLayer",VE="SliceView.addVisibleLayer",BE="SliceView.removeVisibleLayer",FE="ChunkManager.requestChunk",Pc=new Float32Array(3),Ac=new Float32Array(3),Xf=C.pB.create(),Zf=new Float32Array(24);function eg(i,e,t,n){const s=Pc,r=Ac,{lowerChunkDisplayBound:o,upperChunkDisplayBound:a}=e;for(let u=0;u<3;++u)s[u]=Math.max(s[u],o[u]),r[u]=Math.min(r[u],a[u]);const{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e;function d(){if(!n(s[0],s[1],s[2],r[0],r[1],r[2],i))return;let u=0,h=Math.max(0,r[0]-s[0]),p=h;for(let y=1;y<3;++y){const S=Math.max(0,r[y]-s[y]);p*=S,S>h&&(h=S,u=y)}if(p===0)return;if(p===1){l[c[0]]=s[0],l[c[1]]=s[1],l[c[2]]=s[2],t(s,i);return}const m=s[u],g=r[u],v=Math.floor(.5*(m+g));r[u]=v,d(),r[u]=g,s[u]=v,d(),s[u]=m}d()}function tg(i,e,t,n){if(!Kf(t,i.globalPosition,e))return;const{size:s}=t.chunkLayout,r=C.pB.multiply(Xf,i.viewProjectionMat,t.chunkLayout.transform);for(let c=0;c<3;++c){const d=s[c];for(let u=0;u<4;++u)r[4*c+u]*=d}const o=Zf;(0,C._S)(o,r);const a=Pc,l=Ac;a.fill(Number.NEGATIVE_INFINITY),l.fill(Number.POSITIVE_INFINITY),eg(o,t,n,C.T_)}function UE(i,e,t,n,s){if(!Kf(t,i.globalPosition,e))return;const{size:r}=n,o=C.pB.multiply(Xf,i.viewProjectionMat,n.transform);for(let h=0;h<3;++h){const p=r[h];for(let m=0;m<4;++m)o[4*h+m]*=p}const a=TE;C.pB.invert(a,o);const l=Pc,c=Ac,d=.001;for(let h=0;h<3;++h){const p=a[12+h]+d/r[h],m=Math.abs(a[h]),g=Math.abs(a[4+h]);l[h]=Math.floor(p-m-g),c[h]=Math.floor(p+m+g+1)}const u=Zf;for(let h=0;h<3;++h){const p=o[4*h],m=o[4*h+1],g=o[4*h+2];u[h]=p,u[4+h]=-p,u[8+h]=+m,u[12+h]=-m,u[16+h]=+g,u[20+h]=-g}{const p=o[12],m=o[4*3+1],g=o[4*3+2];u[3]=1+p,u[7]=1-p,u[11]=1+m,u[15]=1-m,u[19]=g,u[23]=-g}EE&&(console.log("clippingPlanes",u),console.log("modelViewProjection",o.join(",")),console.log(`lower=${l.join(",")}, upper=${c.join(",")}`)),eg(u,t,s,C.qp)}function Mc(i,e){const{finiteRank:t}=e;if(t===3)return e;Ds.finiteRank=t,C.eR.copy(Ds.size,e.size);const n=C.pB.copy(Ds.transform,e.transform),s=C.pB.copy(Ds.invTransform,e.invTransform);Ds.detTransform=e.detTransform;const{invViewMatrix:r,width:o,height:a}=i,l=(0,C.sJ)(i.projectionMat);for(let c=t;c<3;++c){const d=r[12+c];let u=d,h=d;const p=Math.abs(r[c]*o);u-=p,h+=p;const m=Math.abs(r[c+4]*a);u-=m,h+=m;const g=Math.abs(r[c+8]*l);u-=g,h+=g;const v=Math.max(1,h-u);n[12+c]=u,n[5*c]=v}return C.pB.invert(s,n),Ds}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $E="annotation.MetadataChunkSource",GE="annotation.GeometryChunkSource",zE="annotation.SubsetGeometryChunkSource",WE="annotation.reference.add",HE="annotation.reference.delete",JE="annotation.commit",jE="annotation.commit",YE="annotation/SpatiallyIndexedRenderLayer",QE="annotation/PerspectiveRenderLayer:updateSources",KE="annotation/RenderLayer",qE="annotation/RenderLayer.updateSegmentation",XE=C.w0.create();function ng(i,e,t,n,s,r){const{displayDimensionRenderInfo:o,viewMatrix:a,projectionMat:l,width:c,height:d}=i,{voxelPhysicalScales:u}=o,h=Math.abs(C.w0.determinant((0,C._A)(XE,a))),p=(0,C.xK)(u),m=(0,C.I1)(l)/h*p;if(n.length===0)return;const g=n[0];let v=Math.abs(g.chunkLayout.detTransform)*p;const{lowerClipDisplayBound:y,upperClipDisplayBound:S}=g;for(let I=0;I<3;++I)v*=S[I]-y[I];const w=Math.min(v,m),b=c*d,E=b/t**2/w;let D=0;for(let I=n.length-1;I>=0&&D<E;--I){const L=n[I],N=L.source.spec,{chunkLayout:k}=L,O=(0,C.xK)(k.size)*Math.abs(k.detTransform)*p,{limit:V,rank:z}=N,{nonDisplayLowerClipBound:Y,nonDisplayUpperClipBound:Q}=L;let X=1;for(let xe=0;xe<z;++xe){const ct=Q[xe]-Y[xe];Number.isFinite(ct)&&(X/=ct)}const ce=V*X/O;let oe=!0;const Se=D+ce,Ke=(1/Se)**(1/3),$e=Math.sqrt(b/(Se*w)),Tt=(E-D)*O/X,we=Math.min(1,Tt/N.limit);tg(i,e,L,()=>{oe&&(s(L,I),oe=!1),r(L,I,we,Ke,$e)}),D=Se}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Is=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ZE=!1;function ig(i,e){return{defineShader(t,n){const s=`prop_${n}`,r=`a_${s}`;t.addAttribute(`${i}`,r),t.addVertexCode(`${i} ${s}() { return ${r}; }`),t.addInitializer(o=>{const a=o.attribute(r),{gl:l}=o;o.vertexShaderInputBinders[s]=a===-1?{enable(){},disable(){},bind(){}}:{enable(c){l.enableVertexAttribArray(a),l.vertexAttribDivisor(a,c)},disable(){l.vertexAttribDivisor(a,0),l.disableVertexAttribArray(a)},bind(c,d){e(l,a,c,d)}}})}}}function Nc(i,e,t,n){return ig(i,(s,r,o,a)=>{s.vertexAttribPointer(r,e,t,n,o,a)})}function Ls(i,e,t){return ig(i,(n,s,r,o)=>{n.vertexAttribIPointer(s,e,t,r,o)})}const sg={rgb:Nc("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:Nc("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:Nc("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:Ls("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:Ls("highp int",1,WebGL2RenderingContext.INT),uint16:Ls("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:Ls("highp int",1,WebGL2RenderingContext.SHORT),uint8:Ls("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:Ls("highp int",1,WebGL2RenderingContext.BYTE)};class eT extends T.O8{constructor(e,t,n,s){super(),this.gl=e,this.annotationType=t,this.rank=n,this.properties=s;const r=this.serializedGeometryBytesPerAnnotation=Ft[t].serializedBytes(n),{offsets:o,serializedBytes:a,propertyGroupBytes:l}=xh(n,r,s);this.serializedBytesPerAnnotation=a,this.propertyOffsets=o,this.propertyGroupBytes=l,this.geometryDataStride=l[0];const c=this.propertyGroupCumulativeBytes=new Array(l.length);c[0]=0;for(let d=1;d<l.length;++d)c[d]=c[d-1]+l[d-1]}defineProperties(e,t){const{properties:n,rank:s}=this;for(const l of t){const c=n[l];sg[c.type].defineShader(e,c.identifier,s)}const{propertyOffsets:r}=this,{propertyGroupBytes:o,propertyGroupCumulativeBytes:a}=this;e.addInitializer(l=>{const c=t.map(u=>l.vertexShaderInputBinders[`prop_${n[u].identifier}`]),d=c.length;l.vertexShaderInputBinders.properties={enable(u){for(let h=0;h<d;++h)c[h].enable(u)},bind(u,h){for(let p=0;p<d;++p){const{group:m,offset:g}=r[t[p]];c[p].bind(o[m],h+g+a[m]*u)}},disable(){for(let u=0;u<d;++u)c[u].disable()}}})}}class qo extends eT{constructor(e,t,n,s,r,o,a){super(e,t,n,s),this.shaderControlState=r,this.fallbackShaderParameters=o,this.shaderError=a,this.histogramShaders=new Map}getDependentShader(e,t){return Ai(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(n,s)=>{const{rank:r,properties:o}=this,a=[],l=s.referencedProperties,c=s.parseResult.code;for(let u=0,h=o.length;u<h;++u){const p=o[u],m=`prop_${p.identifier}`;!l.includes(p.identifier)&&!c.match(new RegExp(`\\b${m}\\b`))||a.push(u)}this.defineProperties(n,a),n.addUniform("highp vec3","uColor"),n.addUniform("highp uint","uSelectedIndex"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec3","uSubspaceMatrix",r),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp float","uModelClipBounds",r*2),n.addUniform("highp uint","uPickID"),n.addVarying("highp uint","vPickID","flat"),n.addVertexCode(Is),n.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),n.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);const d=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;n.addVertexCode(d),n.addFragmentCode(d),n.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${r}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Ts(s,n),n.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerColor(vec3 color) { setPointMarkerColor(vec4(color, 1.0)); }
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(const[u,h]of Oc)u!==this.annotationType&&h.defineShaderNoOpSetters(n);t(n),n.addVertexCode(`
#define main userMain
`+ms(s.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let n=`
void setPartIndex(${t.map((s,r)=>`highp uint partIndex${r}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((s,r)=>`highp uint pickOffset${r} = pickBaseOffset + partIndex${r};`).join(`
`)}
`;return t.length===0&&(n+=`
  highp uint pickOffset0 = pickBaseOffset;
`),n+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((s,r)=>` || selectedIndex == pickOffset${r}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(n),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,n){const{shader:s,parameters:r}=e(t.renderContext.emitter);if(s===null)return;s.bind();const{gl:o}=this,{renderContext:a}=t,{annotationLayer:l}=t;if(vi(o,s,this.shaderControlState,r.parseResult.controls),o.uniform3fv(s.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(s.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(s.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),a.emitPickID&&o.uniform1ui(s.uniform("uPickID"),t.basePickId),a.emitColor){const d=l.state.displayState.color.value;o.uniform3f(s.uniform("uColor"),d[0],d[1],d[2]),o.uniform1ui(s.uniform("uSelectedIndex"),t.selectedIndex)}const c=s.vertexShaderInputBinders.properties;c.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),c.bind(t.count,t.bufferOffset),n(s),c.disable()}getHistogramShader(e){const{histogramShaders:t}=this;let n=t.get(e);if(n===void 0){const{gl:s}=this;n=s.memoize.get(JSON.stringify({t:"propertyHistogramGenerator",propertyType:e}),()=>{const r=new fn(s);return this.defineHistogramShader(r,e),r.build()}),t.set(e,n)}return n}defineHistogramShader(e,t){sg[t].defineShader(e,"histogram",0),e.addOutputBuffer("vec4","out_histogram",0);const s="invlerpForHistogram",r=kl[t];e.addVertexCode(Ss(e,s,r,!1)),e.setVertexMain(`
float x = invlerpForHistogram(prop_histogram());
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
gl_PointSize = 1.0;
`),e.setFragmentMain("out_histogram = vec4(1.0, 1.0, 1.0, 1.0);")}computeHistograms(e,t){const{histogramSpecifications:n}=this.shaderControlState,s=n.properties.value,r=s.length,{properties:o}=this,a=o.length,{propertyOffsets:l}=this,{propertyGroupBytes:c,propertyGroupCumulativeBytes:d}=this,{gl:u}=this;u.enable(WebGL2RenderingContext.BLEND),u.disable(WebGL2RenderingContext.SCISSOR_TEST),u.disable(WebGL2RenderingContext.DEPTH_TEST),u.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE);const h=n.getFramebuffers(u),p=n.frameNumber;n.frameNumber=t,u.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer);for(let m=0;m<r;++m){const g=s[m];for(let v=0;v<a;++v){const y=o[v];if(y.identifier!==g)continue;const S=y.type,w=kl[S],b=this.getHistogramShader(S);b.bind();const x=b.vertexShaderInputBinders.prop_histogram;x.enable(0);const{group:E,offset:D}=l[v];if(Ni(b,"invlerpForHistogram",w,n.bounds.value[m]),x.bind(c[E],e.bufferOffset+D+d[E]*e.count),h[m].bind(256,1),t!==p&&(u.clearColor(0,0,0,0),u.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),u.drawArrays(WebGL2RenderingContext.POINTS,0,e.count),ZE){const I=new Float32Array(1024);u.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,I);const L=new Float32Array(256);for(let N=0;N<256;++N)L[N]=I[N*4];console.log("histogram",L.join(" "))}x.disable();break}}u.disable(WebGL2RenderingContext.BLEND)}}const Oc=new Map;function Xo(i,e){Oc.set(i,e)}function Tr(i){return Oc.get(i)}var rg=G(4704),tT=Object.defineProperty,nT=Object.getOwnPropertyDescriptor,_c=(i,e,t,n)=>{for(var s=n>1?void 0:n?nT(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&tT(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const og=!1;class Jn{constructor(e){this.source=e,this.state=Ue.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=Ue.GPU_MEMORY}freeGPUMemory(e){this.state=Ue.SYSTEM_MEMORY}}function ag(i){if(typeof i!="number"||i<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(i)}`);return i}class Zo{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new _.DN(t,ag),this.itemLimit=new _.DN(e,ag)}}let Vc=class extends hn{constructor(i,e,t,n){super(),this.gl=e,this.frameNumberCounter=t,this.capacities=n,this.visibleChunksChanged=new j.IY,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new nt(!0,!0);const s=r=>({itemLimit:this.registerDisposer(ft.makeFromExisting(i,r.itemLimit)).rpcId,sizeLimit:this.registerDisposer(ft.makeFromExisting(i,r.sizeLimit)).rpcId});this.initializeCounterpart(i,{gpuMemoryCapacity:s(n.gpuMemory),systemMemoryCapacity:s(n.systemMemory),downloadCapacity:s(n.download),computeCapacity:s(n.compute),enablePrefetch:this.registerDisposer(ft.makeFromExisting(i,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){const i=this.chunkUpdateDeadline;let e;i===null||Date.now()<i?e=0:e=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(i=!1){let e=this.chunkUpdateDeadline;!i&&e===null&&(e=Date.now()+30);let t=!1,n=0;for(;;){if(!i&&Date.now()>e){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}const s=this.pendingChunkUpdates;if(s==null)break;try{this.applyChunkUpdate(s)&&(t=!0)}finally{if(++n,(this.pendingChunkUpdates=s.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}}return t&&this.visibleChunksChanged.dispatch(),n}handleFetch_(i,e){const{resolve:t,reject:n,cancellationToken:s}=e.promise;if(s.isCanceled){n(Je.wS);return}const r=e.key,o=i.chunks.get(r);if(!o){n(new Error(`No chunk found at ${r} for source ${i.constructor.name}`));return}const a=o.data;if(!a){n(new Error(`At ${r} for source ${i.constructor.name}: chunk has no data`));return}t({value:a})}applyChunkUpdate(i){let e=!1;const{rpc:t}=this,n=t.get(i.source);if(n!==void 0){if(og&&console.log(`${Date.now()} Chunk.update processed: ${n.rpcId} ${i.id} ${i.state}`),i.promise!==void 0)this.handleFetch_(n,i);else if(i.id===void 0){for(const s of n.chunks.keys())n.deleteChunk(s);e=!0}else{const s=i.state;if(s===Ue.EXPIRED)n.deleteChunk(i.id);else{let r;const o=i.id;i.new?(r=n.getChunk(i),n.addChunk(o,r)):r=n.chunks.get(o);const a=r.state;if(s!==a)switch(s){case Ue.GPU_MEMORY:r.copyToGPU(this.gl),r.constructor.name!=="ManifestChunk"&&(e=!0);break;case Ue.SYSTEM_MEMORY:a===Ue.GPU_MEMORY&&r.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${Ue[s]}`)}if(s<=Ue.SYSTEM_MEMORY){const{chunkRequesters:l}=n;if(l!==void 0){const c=l.get(o);if(c!==void 0)for(const d of c)d(r)}}}}return e}}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){const i=this.rpc,e=await i.promiseInvoke(GC,{queue:this.rpcId}),t=new Map;for(const[n,s]of e){const r=i.get(n);r!==void 0&&t.set(r,s)}return t}};Vc=_c([Zt(FC)],Vc);function lg(i,e){const t=i.get(e.source);og&&console.log(`${Date.now()} Chunk.update received: ${t.rpcId} ${e.id} ${e.state} with chunkDataSize ${e.chunkDataSize}`);const n=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){n.applyChunkUpdate(e)&&n.visibleChunksChanged.dispatch();return}const s=n.pendingChunkUpdatesTail;s==null?(n.pendingChunkUpdates=e,n.pendingChunkUpdatesTail=e,n.scheduleChunkUpdate()):(s.nextUpdate=e,n.pendingChunkUpdatesTail=e)}pt("Chunk.update",function(i){lg(this,i)}),pp("Chunk.retrieve",function(i,e){return new Promise((t,n)=>{i.promise={resolve:t,reject:n,cancellationToken:e},lg(this,i)})}),pt(zC,function(i){const e=this.get(i.id);for(const t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(const t of i.layers){const n=this.get(t.id);if(n===void 0)continue;const s=n.layerChunkProgressInfo;s.numVisibleChunksAvailable=t.numVisibleChunksAvailable,s.numVisibleChunksNeeded=t.numVisibleChunksNeeded,s.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,s.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(s)}e.layerChunkStatisticsUpdated.dispatch()});let Bc=class extends hn{constructor(i){super(),this.chunkQueueManager=i,this.memoize=new rg.e,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new j.IY,this.registerDisposer(i.addRef()),this.initializeCounterpart(i.rpc,{chunkQueueManager:i.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(i,e){const t=i.encodeOptions(e);t.constructorId=xt(i);const n=(0,f.JB)(t);return this.memoize.get(n,()=>{const s=new i(this,e);return s.initializeCounterpart(this.rpc,{}),s.key=t,s})}};Bc=_c([Zt(UC)],Bc);class on extends hn{constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new Map,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){const t=this.chunks.get(e);t.state===Ue.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke($C,{id:this.rpcId})}static encodeOptions(e){return{}}}function it(i,e){let t=class extends i{constructor(...n){super(...n);const s=n[1];this.parameters=s.parameters}initializeCounterpart(n,s){s.parameters=this.parameters,super.initializeCounterpart(n,s)}static encodeOptions(n){return Object.assign({parameters:n.parameters},i.encodeOptions(n))}};return t=_c([Zt(e.RPC_ID)],t),t}class Dr extends hn{constructor(e){super(),this.layerChunkProgressInfo=e}}var Rt=G(4242);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cg=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function iT(i,e,t){i.registerDisposer(e.visibleSegments.changed.add(t)),i.registerDisposer(e.segmentEquivalences.changed.add(t))}function sT(i,e,t){i.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),i.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Sn(i){return`${i.low},${i.high}`}function rT(i){return!!(i.high>>>31)}function dg(i){return i.useTemporaryVisibleSegments.value?i.temporaryVisibleSegments:i.visibleSegments}function oT(i){return i.useTemporarySegmentEquivalences.value?i.temporarySegmentEquivalences:i.segmentEquivalences}function Rs(i,e){const t=dg(i),n=oT(i),s=n.disjointSets.visibleSegmentEquivalencePolicy.value;for(const r of t.unsafeKeys())if(s&Rt.y6.NONREPRESENTATIVE_EXCLUDED){const o=n.get(r);e(r,o)}else{if(!n.disjointSets.isMinElement(r))continue;for(const o of n.setElements(r))s&Rt.y6.REPRESENTATIVE_EXCLUDED&&s&Rt.y6.MAX_REPRESENTATIVE&&rT(o)||e(o,r)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mt=40,Ir=.5,ks=-4;function ea(i,e=ks){return(Math.log2(i)-e)/Ir}function aT(i,e=ks){return 2**(i*Ir+e)}function Bi(i,e=2**ks,t){t===void 0&&(t=2**Math.round(Ir*mt+ks)-1);const n=(0,f.JY)(e,t);return new _.DN(i,n)}class Ps{constructor(e=ks){this.visibility=new or,this.changed=new j.IY,this.frameNumber=-1,this.spatialScales=new Map,this.numHistogramRows=1,this.value=new Uint32Array(mt*this.numHistogramRows*2),this.fakeChunkCount=0,this.logScaleOrigin=e}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.fakeChunkCount=0,this.changed.dispatch())}add(e,t,n,s,r=!1){let{spatialScales:o,numHistogramRows:a,value:l}=this,c=o.get(e);if(c===void 0&&(c=o.size,o.set(e,c)),c>=a){this.numHistogramRows=a*=2;const u=new Uint32Array(a*mt*2);u.set(l),this.value=l=u}const d=c*mt*2+Math.min(Math.max(0,Math.round(ea(t,this.logScaleOrigin))),mt-1);l[d]+=n,l[d+mt]+=s,r&&(this.fakeChunkCount=this.fakeChunkCount+s)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fc extends mp{constructor(e,t,n){super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new Map,this.visibleSourcesList_=[];const{renderScaleTarget:s=Bi(1)}=n;this.renderScaleTarget=s,this.renderScaleHistogram=n.renderScaleHistogram,this.transform=n.transform,this.localPosition=n.localPosition,this.rpcTransfer=n.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer(n.dataHistogramSpecifications??new Np((0,_.XZ)([]),(0,_.XZ)([]),(0,_.XZ)([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){const{visibleSources:n}=this,s=n.get(e);s!==void 0?(++s.refCount,s.chunkTransform=t):(n.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){const{visibleSources:t}=this,n=t.get(e);n.refCount!==1?--n.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){const{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(const n of e.values())t.push(n);t.sort((n,s)=>Math.abs(n.chunkTransform.chunkToLayerTransformDet)-Math.abs(s.chunkTransform.chunkToLayerTransformDet))}return t}initializeCounterpart(){const e=this.registerDisposer(new Dr(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(ft.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(ft.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return NE(e,this,t)}}Fc.prototype.RPC_TYPE_ID=_E;class Fi extends vp{draw(e,t){}isReady(e,t){return!0}}var lT=Object.defineProperty,cT=Object.getOwnPropertyDescriptor,dT=(i,e,t,n)=>{for(var s=n>1?void 0:n?cT(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&lT(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uT extends kE{}const hT=ar(uT);function pT(i){return{source:i.source.addCounterpartRef(),effectiveVoxelSize:i.effectiveVoxelSize,layerRank:i.layerRank,nonDisplayLowerClipBound:i.nonDisplayLowerClipBound,nonDisplayUpperClipBound:i.nonDisplayUpperClipBound,lowerClipBound:i.lowerClipBound,upperClipBound:i.upperClipBound,lowerClipDisplayBound:i.lowerClipDisplayBound,upperClipDisplayBound:i.upperClipDisplayBound,chunkDisplayDimensionIndices:i.chunkDisplayDimensionIndices,lowerChunkDisplayBound:i.lowerChunkDisplayBound,upperChunkDisplayBound:i.upperChunkDisplayBound,fixedLayerToChunkTransform:i.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:i.combinedGlobalLocalToChunkTransform,chunkLayout:i.chunkLayout.toObject()}}function ta(i){return i.map(e=>e.map(pT))}function Uc(i,e){for(const t of e)for(const{source:n}of t)i.removeSource(n),n.dispose()}let na=class extends hT{constructor(i,e,t,n){super(new yp({parametersConstructor:LE,navigationState:t,update:(o,a)=>{const{invViewMatrix:l,centerDataPosition:c}=o;a.toMat4(l);const{canonicalVoxelFactors:d,voxelPhysicalScales:u}=o.displayDimensionRenderInfo;for(let b=0;b<3;++b)c[b]=l[12+b];const{logicalWidth:h,logicalHeight:p,projectionMat:m,viewportNormalInGlobalCoordinates:g,viewportNormalInCanonicalCoordinates:v}=o,{relativeDepthRange:y}=a;C.pB.ortho(m,-h/2,h/2,p/2,-p/2,-y,y),ip(o,m),ap(o);const{viewMatrix:S}=o;for(let b=0;b<3;++b){const x=g[b]=S[b*4+2];v[b]=x/d[b]}C.eR.normalize(g,g),C.eR.normalize(v,v);let w=0;for(let b=0;b<3;++b){const x=u[b],E=l[b];w+=(x*E)**2}w=Math.sqrt(w),o.pixelSize=w}})),this.chunkManager=i,this.layerManager=e,this.navigationState=t,this.wireFrame=n,this.gl=this.chunkManager.gl,this.viewChanged=new j.IY,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=new Array,this.offscreenFramebuffer=this.registerDisposer(new $n(this.gl,{colorBuffers:vs(this.gl,1),depthBuffer:new xw(this.gl)})),this.histogramInputTextures=[],this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=hc.get(this.gl),this.updateVisibleLayers=this.registerCancellable((0,Fe.A)(()=>{this.updateVisibleLayersNow()},0)),this.registerDisposer(t),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((o,a)=>{o.displayDimensionRenderInfo!==a.displayDimensionRenderInfo&&this.updateVisibleLayers()}));const s=this.chunkManager.rpc,r=this.sharedProjectionParameters=this.registerDisposer(new So(s,this.projectionParameters));this.initializeCounterpart(s,{chunkManager:i.rpcId,projectionParameters:r.rpcId}),this.registerDisposer(e.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(i.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(i,e){this.histogramGenerator.compute(i,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,e,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(i,e,t){UE(this.projectionParameters.value,i.renderLayer.localPosition.value,i,e,()=>{t(i.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let i=0,e=0;for(const{visibleSources:t}of this.visibleLayers.values())for(const n of t){const s=Mc(this.projectionParameters.value,n.chunkLayout),{source:r}=n,{chunks:o}=r;this.forEachVisibleChunk(n,s,a=>{const l=o.get(a);++e,l&&l.state===Ue.GPU_MEMORY&&++i})}return i===e}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(i,e){e.push(i.localPosition.changed.add(()=>this.invalidateVisibleChunks())),e.push(i.redrawNeeded.add(this.viewChanged.dispatch)),e.push(i.transform.changed.add(this.updateVisibleLayers)),e.push(i.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));const{renderScaleHistogram:t}=i;t!==void 0&&e.push(t.visibility.add(this.visibility)),e.push(i.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;const i=Date.now(),{visibleLayers:e,visibleLayerList:t}=this,{displayDimensionRenderInfo:n}=this.projectionParameters.value,s=this.rpc,r={id:this.rpcId};let o=!1;t.length=0;for(const a of this.layerManager.readyRenderLayers())if(a instanceof Fc){t.push(a);let l=e.get(a);if(l===void 0){const c=[],d=new ai;l={messages:d,allSources:this.getTransformedSources(a,d),transformGeneration:a.transform.changed.count,visibleSources:[],disposers:c,lastSeenGeneration:i,displayDimensionRenderInfo:n},c.push(a.messages.addChild(l.messages)),e.set(a.addRef(),l),this.bindVisibleRenderLayer(a,c)}else{l.lastSeenGeneration=i;const c=a.transform.changed.count;if(l.transformGeneration===c&&l.displayDimensionRenderInfo===n)continue;const d=l.allSources;l.allSources=this.getTransformedSources(a,l.messages),Uc(a,d),l.visibleSources.length=0,l.displayDimensionRenderInfo=n,l.transformGeneration=c}r.layerId=a.rpcId,r.sources=ta(l.allSources),r.displayDimensionRenderInfo=n,this.flushBackendProjectionParameters(),s.invoke(VE,r),o=!0}for(const[a,l]of e)l.lastSeenGeneration!==i&&(r.layerId=a.rpcId,s.invoke(BE,r),e.delete(a),Uc(a,l.allSources),(0,T.$F)(l.disposers),a.dispose(),o=!0);return o&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),o}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(i){const{offscreenFramebuffersWithHistograms:e}=this;let t=e[i];if(t===void 0){const{gl:n,histogramInputTextures:s,offscreenFramebuffer:r}=this;s.length<i&&s.push(...vs(n,i-s.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));const o=[r.colorBuffers[0].addRef()];for(let a=0;a<i;++a)o.push(s[a].addRef());t=this.registerDisposer(new $n(n,{colorBuffers:o,depthBuffer:r.depthBuffer.addRef()})),e[i]=t}return t}updateRendering(){const i=this.projectionParameters.value,{width:e,height:t}=i;if(!this.renderingStale||!this.valid||e===0||t===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();const{gl:n,offscreenFramebuffer:s}=this;s.bind(e,t),n.disable(n.SCISSOR_TEST),n.clearColor(0,0,0,0),n.colorMask(!0,!0,!0,!0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let r=0;const o=this.wireFrame.value,a={sliceView:this,projectionParameters:i,wireFrame:o};for(const l of this.visibleLayerList){const c=o?0:l.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(c).bind(e,t);for(let u=0;u<c;++u)n.clearBufferfv(WebGL2RenderingContext.COLOR,1+u,C.yb);n.enable(WebGL2RenderingContext.DEPTH_TEST),n.depthFunc(WebGL2RenderingContext.LESS),n.clearDepth(1),n.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),l.setGLBlendMode(n,r),l.draw(a),++r}n.disable(WebGL2RenderingContext.BLEND),n.disable(WebGL2RenderingContext.DEPTH_TEST),s.unbind()}disposed(){for(const[i,e]of this.visibleLayers)Uc(i,e.allSources),(0,T.$F)(e.disposers),i.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(i,e){const t=sa(this.projectionParameters.value.displayDimensionRenderInfo,i.transform.value,n=>i.getSources(n),e,i);for(const n of t)for(const s of n)i.addSource(s.source,s.chunkTransform);return t}};na=dT([Zt(OE)],na);class Lr extends on{constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){const t=on.encodeOptions(e);return t.spec=Lr.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}async fetchChunk(e,t,n=Je.fx){const s=e.join(),r=this.chunks.get(s);if(r!==void 0&&r.state<=Ue.SYSTEM_MEMORY)return t(r);this.addRef();let{chunkRequesters:o}=this;o===void 0&&(o=this.chunkRequesters=new Map);let a,l=o.get(s);l===void 0&&(l=[],o.set(s,l));const c=new Promise(d=>{a=u=>d(t(u)),l.push(a)});try{return await this.rpc.promiseInvoke(FE,{source:this.rpcId,chunkGridPosition:e},n),await c}finally{const d=l.indexOf(a);l.splice(d,1),l.length===0&&o.delete(s),o.size===0&&(this.chunkRequesters=void 0),this.dispose()}}}class ug extends Jn{constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=Ue.SYSTEM_MEMORY}}class ia extends T.O8{constructor(e,t){super(),this.gl=e,this.copyVertexPositionsBuffer=ur(this.gl),this.textureCoordinateAdjustment=new Float32Array(4);const n=new fn(e);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler"),n.addInitializer(s=>{e.uniform1i(s.uniform("uSampler"),0)}),n.addUniform("vec4","uColorFactor"),n.addUniform("vec4","uBackgroundColor"),n.addUniform("mat4","uProjectionMatrix"),n.addUniform("vec4","uTextureCoordinateAdjustment"),n.require(t),n.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),n.addAttribute("vec4","aVertexPosition"),n.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(n.build())}draw(e,t,n,s,r,o,a,l){const{gl:c,shader:d,textureCoordinateAdjustment:u}=this;u[0]=r,u[1]=o,u[2]=a-r,u[3]=l-o,d.bind(),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,e),c.disable(WebGL2RenderingContext.BLEND),c.uniformMatrix4fv(d.uniform("uProjectionMatrix"),!1,t),c.uniform4fv(d.uniform("uColorFactor"),n),c.uniform4fv(d.uniform("uBackgroundColor"),s),c.uniform4fv(d.uniform("uTextureCoordinateAdjustment"),u);const h=d.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(h,2),c.drawArrays(c.TRIANGLE_FAN,0,4),c.disableVertexAttribArray(h),c.bindTexture(c.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${xt(t)}`,()=>new ia(e,t))}}class fT{constructor(e){this.chunkManager=e}}function sa(i,e,t,n,s){n.clearMessages();const r=y=>(n.addMessage({severity:Tn.error,message:y}),[]);if(e.error!==void 0)return r(e.error);const o=e.rank,a=e.unpaddedRank,{displayDimensionIndices:l,displayRank:c,canonicalVoxelFactors:d}=i,u=Zh(e,l),{displayToLayerDimensionIndices:h}=u,p=new Float32Array(c*a),{modelToRenderLayerTransform:m}=e;for(let y=0;y<c;++y){const S=h[y];if(S===-1)continue;const w=d[y];for(let b=0;b<a;++b)p[c*b+y]=m[(o+1)*b+S]*w}const g=t({displayRank:c,multiscaleToViewTransform:p,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:v}=i;try{const y=S=>{const{chunkSource:w}=S,{spec:b}=w,{lowerClipBound:x=b.lowerVoxelBound,upperClipBound:E=b.upperVoxelBound}=S,D=po(e,S.chunkToMultiscaleTransform),{chunkDataSize:I}=b,{channelToChunkDimensionIndices:L}=D,N=new Float32Array(a),k=new Float32Array(a);N.set(x),k.set(E);const O=L.length,{channelSpaceShape:V}=e;for(let be=0;be<O;++be){const Ye=L[be];if(Ye===-1)continue;const bt=V[be];if(I[Ye]!==bt)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[be]]+` has extent ${bt} but corresponding chunk dimension has extent ${I[Ye]}`);N[Ye]=Number.NEGATIVE_INFINITY,k[Ye]=Number.POSITIVE_INFINITY}const z=ep(D,u),Y=C.eR.create(),Q=C.eR.create(),X=C.eR.create(),ce=C.eR.create(),oe=C.eR.create(),{numChunkDisplayDims:Se,chunkDisplayDimensionIndices:Ke}=z,{combinedGlobalLocalToChunkTransform:$e,layerRank:Tt,combinedGlobalLocalRank:we}=D,xe=new Float32Array($e);for(let be=0;be<Se;++be){const Ye=Ke[be];for(let bt=0;bt<=we;++bt)xe[Ye+bt*Tt]=0;Ye<a?(oe[be]=b.chunkDataSize[Ye],Y[be]=b.lowerChunkBound[Ye],Q[be]=b.upperChunkBound[Ye],X[be]=x[Ye],ce[be]=E[Ye],N[Ye]=Number.NEGATIVE_INFINITY,k[Ye]=Number.POSITIVE_INFINITY):(oe[be]=1,Y[be]=0,Q[be]=1,X[be]=0,ce[be]=1)}oe.fill(1,Se),Y.fill(0,Se),Q.fill(1,Se),X.fill(0,Se),ce.fill(1,Se);const ct=new Qf.i(oe,z.displaySubspaceModelMatrix,Se),dt=ct.localSpatialVectorToGlobal(C.eR.create(),C.Oi);for(let be=0;be<c;++be)dt[be]=Math.abs(dt[be]*v[be]);return dt.fill(1,c),{layerRank:Tt,lowerClipBound:x,upperClipBound:E,nonDisplayLowerClipBound:N,nonDisplayUpperClipBound:k,renderLayer:s,source:w,lowerChunkDisplayBound:Y,upperChunkDisplayBound:Q,lowerClipDisplayBound:X,upperClipDisplayBound:ce,effectiveVoxelSize:dt,chunkLayout:ct,chunkDisplayDimensionIndices:Ke,fixedLayerToChunkTransform:xe,curPositionInChunks:new Float32Array(a),combinedGlobalLocalToChunkTransform:D.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(a),chunkTransform:D,chunkDisplayTransform:z}};return g.map(S=>S.map(w=>y(w)))}catch(y){for(const x of g)for(const{chunkSource:E}of x)E.dispose();const{globalDimensionNames:S}=i,b=`Cannot render (${Array.from(i.displayDimensionIndices.filter(x=>x!==-1),x=>S[x]).join(",\xA0")}) cross section: ${y.message}`;return r(b)}}var gT=Object.defineProperty,mT=Object.getOwnPropertyDescriptor,$c=(i,e,t,n)=>{for(var s=n>1?void 0:n?mT(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&gT(e,t,s),s};/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hg(i){let e=0;const{typeToIds:t}=i;for(const n of Xt)e+=Tr(n).pickIdsPerInstance*t[n].length;return e}class pg{constructor(e){this.bufferValid=!1,this.numPickIds=0,this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){const{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class vT extends Jn{constructor(e,t){super(e),t.data!==void 0&&(this.data=new pg(t))}freeGPUMemory(e){super.freeGPUMemory(e);const{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class fg extends ug{constructor(e,t){super(e,t),t.data!==void 0&&(this.data=new pg(t))}freeGPUMemory(e){super.freeGPUMemory(e);const{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}let ra=class extends Lr{constructor(i,e){super(i,e),this.immediateChunkUpdates=!0,(this.parent=e.parent).spatiallyIndexedSources.add(this);const{rank:n,chunkDataSize:s}=this.spec,r=this.multiscaleToChunkTransform=new Float32Array((n+1)**2);De.DI(r,n+1,this.spec.chunkToMultiscaleTransform,n+1,n+1);for(let o=0;o<n;++o)for(let a=0;a<n+1;++a)r[(n+1)*a+o]/=s[o]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(i,e){e.parent=this.parent.rpcId,super.initializeCounterpart(i,e)}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new fg(this,i)}};ra=$c([Zt(GE)],ra);let Gc=class extends on{constructor(i,e,t){super(i,{}),this.parent=e,this.relationshipIndex=t,this.immediateChunkUpdates=!0}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new vT(this,i)}};Gc=$c([Zt(zE)],Gc);class yT extends Jn{constructor(e,t){super(e),this.annotation=Lh(t.annotation)}}let zc=class extends on{constructor(i,e){super(i),this.parent=e}getChunk(i){return new yT(this,i)}addChunk(i,e){super.addChunk(i,e);const{references:t}=this.parent,n=t.get(i);n!==void 0&&(n.value=e.annotation,n.changed.dispatch())}deleteChunk(i){const{references:e}=this.parent,t=e.get(i);t!==void 0&&(t.value=void 0,t.changed.dispatch())}};zc=$c([Zt($E)],zc);function gg(i,e,t,n){const s=new Uint8Array(i.data.length+n);for(const r of Xt){if(r===t)continue;const o=i.typeToOffset[r];let a=o;r>t&&(a+=n,i.typeToOffset[r]=a),s.set(i.data.subarray(o,o+i.typeToIds[r].length*e[r].serializedBytes),a)}return s}function Wc(i,e,t,n,s,r,o,a){const l=i.typeToOffset[t];let c=l,d=l;const{propertyGroupBytes:u}=e[t],h=u.length,p=i.typeToIds[t].length;for(let m=0;m<h;++m){const g=u[m];n.set(i.data.subarray(c+s*g,c+r*g),d+o*g),c+=g*p,d+=g*a}}function oa(i,e,t){const n=e.type,{rank:s}=t[n],{serializedAnnotations:r}=i,o=r.typeToIds[n],a=r.typeToIdMaps[n],l=Ft[n],c=t[n].serializedBytes;let d=a.get(e.id);if(d===void 0){d=a.size,a.set(e.id,d);const g=gg(r,t,n,c);Wc(r,t,n,g,0,d,0,d+1),o.push(e.id),r.data=g}const u=r.typeToOffset[n],h=new DataView(r.data.buffer,r.data.byteOffset,r.data.byteLength),p=te===U.LITTLE,m=t[n];l.serialize(h,u+m.propertyGroupBytes[0]*d,p,s,e),m.serialize(h,u,d,o.length,p,e.properties),i.bufferValid=!1}function aa(i,e,t,n){const{serializedAnnotations:s}=i,r=s.typeToIdMaps[e],o=r.get(t);if(o===void 0)return!1;const a=s.typeToIds[e],l=n[e].serializedBytes,c=gg(s,n,e,-l);Wc(s,n,e,c,0,o,0,a.length-1),Wc(s,n,e,c,o+1,a.length,o,a.length-1),a.splice(o,1),r.delete(t);for(let d=o,u=a.length;d<u;++d)r.set(a[d],d);return s.data=c,i.bufferValid=!1,!0}function ST(){const i=[],e=[],t=[];for(const n of Xt)i[n]=[],e[n]=0,t[n]=new Map;return new fg(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:i,typeToIdMaps:t})}class Rr extends hn{constructor(e,t){super(),this.chunkManager=e,this.metadataChunkSource=this.registerDisposer(new zc(this.chunkManager,this)),this.spatiallyIndexedSources=new Set,this.temporary=ST(),this.references=new Map,this.localUpdates=new Map,this.numCommitsInProgress=0,this.changed=new j.IY,this.readonly=!1,this.rank=t.rank,this.properties=new _.B0(t.properties),this.annotationPropertySerializers=Pl(this.rank,this.properties.value);const n=this.segmentFilteredSources=[],{relationships:s}=t;this.relationships=s;for(let r=0,o=s.length;r<o;++r)n.push(this.registerDisposer(new Gc(e,this,r)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(const n of this.segmentFilteredSources)n.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(n=>n.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=Vl();const n=new Li(e.id);return n.value=e,this.references.set(n.id,n),n.registerDisposer(()=>{this.references.delete(n.id)}),this.applyLocalUpdate(n,!1,t,e),n}applyLocalUpdate(e,t,n,s){const{localUpdates:r}=this,{id:o}=e;let a=this.localUpdates.get(o);const l=e.value;if(l==null)throw new Error("Cannot create local update from null annotation");if(a===void 0?(a={type:l.type,reference:e.addRef(),existingAnnotation:t?l:void 0,pendingCommit:void 0,commitInProgress:void 0},r.set(o,a),this.forEachPossibleChunk(l,c=>{const{data:d}=c;if(d===void 0)return;const u=l.type;aa(d,u,o,this.annotationPropertySerializers)}),s!==null&&oa(this.temporary.data,s,this.annotationPropertySerializers)):(s===null?aa(this.temporary.data,l.type,l.id,this.annotationPropertySerializers):oa(this.temporary.data,s,this.annotationPropertySerializers),e.value=s),n)if(a.commitInProgress!==void 0)a.pendingCommit=s;else{if(s===null&&a.existingAnnotation===void 0){r.delete(o),a.reference.dispose();return}this.sendCommitRequest(a,s)}this.notifyChanged(e.id,s||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(JE,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){const n=this.references.get(e),s=this.metadataChunkSource.chunks.get(e);s!==void 0&&(s.annotation=t||null),n!==void 0&&(n.value=t||null,n.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new Li(e),this.references.set(e,t),this.rpc.invoke(WE,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke(HE,{id:this.rpcId,annotation:e})});const n=this.metadataChunkSource.chunks.get(e);return n!==void 0&&(t.value=n.annotation),t}forEachPossibleChunk(e,t){const{relatedSegments:n}=e;if(n!==void 0){const l=n.length,{segmentFilteredSources:c}=this;for(let d=0;d<l;++d){const u=n[d];if(u===void 0)return;const h=c[d];for(const p of u){const m=h.chunks.get(Sn(p));m!==void 0&&t(m)}}}const{rank:s}=this,r=new Float32Array(s),o=new Float32Array(s),a=new Float32Array(s);for(const l of this.spatiallyIndexedSources){switch(e.type){case Re.POINT:De.vo(r,l.multiscaleToChunkTransform,s+1,e.point,s),o.set(r);break;case Re.LINE:case Re.AXIS_ALIGNED_BOUNDING_BOX:De.vo(r,l.multiscaleToChunkTransform,s+1,e.pointA,s),De.vo(o,l.multiscaleToChunkTransform,s+1,e.pointB,s);break;case Re.ELLIPSOID:De.vo(r,l.multiscaleToChunkTransform,s+1,e.center,s),De._U(o,l.multiscaleToChunkTransform,s+1,e.radii,s);for(let u=0;u<s;++u){const h=r[u],p=o[u];r[u]=h-p,o[u]=h+p}break}let c=1;for(let u=0;u<s;++u){const h=r[u],p=o[u],m=Math.min(h,p),g=Math.max(h,p);r[u]=Math.ceil(m-1),o[u]=Math.floor(g+1),c*=o[u]-r[u]}const{chunks:d}=l;for(let u=0;u<c;++u){let h=u;for(let m=0;m<s;++m){const g=r[m],y=o[m]-g,S=a[m]=h%y;h=(h-S)/y}const p=d.get(a.join());p!==void 0&&t(p)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&n.reference.id!==t.id){if(n.commitInProgress===null)throw new Error("Received invalid successful update notification");n.reference.id=t.id,this.references.delete(e),this.references.set(t.id,n.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,n),n.reference.value!==null&&(n.reference.value.id=t.id,aa(this.temporary.data,n.type,e,this.annotationPropertySerializers),oa(this.temporary.data,n.reference.value,this.annotationPropertySerializers)),n.reference.changed.dispatch()}n.existingAnnotation=t||void 0,n.commitInProgress=void 0;let{pendingCommit:s}=n;n.pendingCommit=void 0,t===null&&(s=void 0),s!==void 0?(s!==null&&(s.id=t.id),this.sendCommitRequest(n,s)):this.revertLocalUpdate(n)}disposed(){const{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new pe(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid update notification");new pe().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(n),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){aa(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);const{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,r=>{const{data:o}=r;o!==void 0&&oa(o,t,this.annotationPropertySerializers)});const{reference:n}=e,{id:s}=n;n.value=t||null,n.changed.dispatch(),n.dispose(),this.localUpdates.delete(s)}*[Symbol.iterator](){}}pt(jE,function(i){const e=this.get(i.id),t=i.annotationId,n=i.error;if(n!==void 0)e.handleFailedUpdate(t,n);else{const s=Lh(i.newAnnotation);e.handleSuccessfulUpdate(t,s)}});var kr=G(8795);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mg={offset:0,completions:[]};function yi(i,e){return e.offset+=i,e}function Hc(i,e){const t=[];for(const n of e)n.startsWith(i)&&t.push({value:n});return t.sort((n,s)=>(0,kr.e)(n.value,s.value)),t}function Ht(i,e,t,n){const s=[];for(const r of e){const o=t(r);o.startsWith(i)&&s.push({value:o,description:n(r)})}return s.sort((r,o)=>(0,kr.e)(r.value,o.value)),s}async function bT(i,e,t){if(i.startsWith("{"))return mg;const s=i.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],r=i.length-s.length,o=s.indexOf("=");if(o===-1){const a=await e(s);return{offset:a.offset+r,completions:a.completions.map(l=>({...l,value:`${l.value}=`}))}}return yi(r+o+1,await t(s.substring(0,o),s.substring(o+1)))}async function vg(i,e){return bT(i,async t=>{const n=[];for(const s of e){const r=s.key;r.value.startsWith(t)&&n.push(r)}return{offset:0,completions:n}},async(t,n)=>{for(const s of e)if(s.key.value===t)return{offset:0,completions:s.values.filter(r=>r.value.startsWith(n))};return mg})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jc extends Error{constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function yg(i,e){e===void 0&&(i.indexOf("/")===-1?e=":":e="/");const t=i.lastIndexOf(e);return t===-1?0:t+1}function CT(i,e){const t=yg(i,e);return i.substring(t)}var As=(i=>(i[i.annotations=0]="annotations",i[i.equivalences=1]="equivalences",i))(As||{});function Sg(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}class Jt extends T.O8{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}const bg="local://annotations",jc="local://equivalences";class wT extends Jt{get description(){return"Local in-memory"}async get(e){switch(e.url){case bg:{const{transform:t}=e;let n;if(t===void 0){const s=e.globalCoordinateSpace.value,{rank:r,names:o,scales:a,units:l}=s,c=Oe({rank:r,scales:a,units:l,names:o.map((u,h)=>`${h}`)}),d=Oe({rank:r,scales:a,units:l,names:o});n={rank:r,sourceRank:r,inputSpace:c,outputSpace:d,transform:(0,De.DA)(Float64Array,r+1)}}else n=wt(ki);return{modelTransform:n,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case jc:return{modelTransform:wt(ki),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:Ht(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}}const Cg=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class xT extends T.O8{constructor(e){super(),this.credentialsManager=e,this.dataSources=new Map([["local",new wT]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){const t=e.match(Cg);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');const[,n,s]=t,r=this.dataSources.get(n);if(r===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(n)}.`);return[r,s,n]}async get(e){const t=new Set,{cancellationToken:n=Je.fx}=e;let s=e.url;for(;;){const[r,o,a]=this.getProvider(e.url);t.add(e.url);try{return r.get({...e,url:s,providerProtocol:a,providerUrl:o,registry:this,cancellationToken:n,credentialsManager:this.credentialsManager})}catch(l){if(l instanceof Jc){const c=l.redirectTarget;if(t.has(c))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);s=c;continue}throw l}}}convertLegacyUrl(e){try{const[t,n,s]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:n,providerProtocol:s,registry:this})}catch{return e.url}}normalizeUrl(e){try{const[t,n,s]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:n,providerProtocol:s,registry:this})}catch{return e.url}}async completeUrl(e){const{url:t,cancellationToken:n=Je.fx}=e,s=t.match(Cg),r=s[1];if(r===void 0)return Promise.resolve({offset:0,completions:Ht(t,this.dataSources,([a])=>`${a}://`,([,a])=>a.description)});const o=this.dataSources.get(r);if(o!==void 0){const a=await o.completeUrl({registry:this,url:t,providerUrl:s[2],chunkManager:e.chunkManager,cancellationToken:n,credentialsManager:this.credentialsManager});return yi(r.length+3,a)}throw null}suggestLayerName(e){let[t,n]=this.getProvider(e);n.endsWith("/")&&(n=n.substring(0,n.length-1));const s=t.suggestLayerName;return s!==void 0?s(n):CT(n)}findSourceGroup(e){const[t,n,s]=this.getProvider(e);return(t.findSourceGroup||yg)(n)+s.length+3}}var la=G(4022);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ET(i){return typeof i=="boolean"?{enabled:i}:((0,f.Rf)(i),{enabled:(0,f.MM)(i,"enabled",f.aO)})}function Pr(i,e=void 0){return typeof i=="string"?{url:i,transform:e,enableDefaultSubsources:!0,subsources:new Map}:((0,f.Rf)(i),{url:(0,f.cQ)(i,"url",f.zr),transform:(0,f.cQ)(i,"transform",jh)||e,enableDefaultSubsources:(0,f.MM)(i,"enableDefaultSubsources",f.aO,!0),subsources:(0,f.MM)(i,"subsources",t=>(0,f.vS)(t,ET),new Map),state:(0,f.MM)(i,"state",f.Rf)})}function TT(i){return i.enabled}function wg(i){const e=Yh(i.transform),t={};let n=!0;for(const[s,r]of i.subsources){const o=TT(r);o!==void 0&&(t[s]=o,n=!1)}return e===void 0&&n&&i.enableDefaultSubsources===!0&&i.state===void 0?i.url:{url:i.url,transform:e,subsources:n?void 0:t,enableDefaultSubsources:i.enableDefaultSubsources===!0?void 0:!1,state:i.state}}class DT{constructor(e,t,n,s,r){this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=n,this.subsourceIndex=s,this.activated=void 0,this.guardValues=[],this.messages=new ai,this.isActiveChanged=new j.IY;let o;n===void 0||n.enabled===void 0?o=t.default&&r:o=n.enabled;const a=e.dataSource.modelTransform.sourceRank;let{modelSubspaceDimensionIndices:l}=t;if(l===void 0){l=new Array(a);for(let d=0;d<a;++d)l[d]=d}const{subsourceToModelSubspaceTransform:c=De.DA(Float32Array,l.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=c,this.modelSubspaceDimensionIndices=l,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if((0,F.r1)(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;const n=this.activated=new T.O8;e(n),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:Tn.error,message:e});const{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){const t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){const t=this.activated,{layer:n,transform:s}=this.loadedDataSource;return t.registerDisposer(Xh(n.manager.root.coordinateSpace,n.localPosition.coordinateSpace,s,this,e))}}class Yc extends T.O8{constructor(e,t,n){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new j.IY,this.activatedSubsourcesChanged=new j.IY,this.messages=new ai,t.canChangeModelSpaceRank?(this.transform=new Hh(wt(Oe({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new Hh(t.modelTransform),n.transform!==void 0&&(this.transform.spec=n.transform);const s=n.subsources;this.enableDefaultSubsources=n.enableDefaultSubsources,this.subsources=t.subsources.map((r,o)=>new DT(this,r,s.get(r.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(const e of this.subsources){const{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}}class IT extends T.O8{constructor(e,t=void 0){super(),this.layer=e,this.changed=new j.IY,this.messages=new ai,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),this.registerDisposer(e.messages.addChild(this.messages)),t===void 0?this.spec_=Sg():this.spec=t}get spec(){const{loadState:e}=this;if(e!==void 0&&e.error===void 0){const t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,n=>{const s=e.enableDefaultSubsources&&n.subsourceEntry.default;return[n.subsourceEntry.id,{enabled:n.enabled!==s?n.enabled:void 0}]})),state:this.spec.state})}return this.spec_}get loadState(){return this.loadState_}set spec(e){const{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){const l=t.dataSources.indexOf(this);if(l!==-1){t.dataSources.splice(l,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}const n=new T.O8,s=n.registerDisposer((0,T.K9)(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=n,this.spec_=e;const r=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,a=new Je.Qi;this.messages.addMessage({severity:Tn.info,message:"Loading data source"}),o.get({chunkManager:r,url:e.url,cancellationToken:a,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform,state:e.state}).then(l=>{if(n.wasDisposed)return;this.messages.clearMessages();const c=n.registerDisposer(new Yc(this,l,e));c.registerDisposer(t.addCoordinateSpace(c.transform.outputSpace)),c.registerDisposer(c.transform.changed.add(this.changed.dispatch)),this.loadState_=c,c.registerDisposer(c.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),l.state&&n.registerDisposer(l.state.changed.add(()=>{this.spec.state=l.state?.toJSON(),t.specificationChanged.dispatch()})),s()}).catch(l=>{this.wasDisposed||(this.loadState_={error:l},this.messages.clearMessages(),this.messages.addMessage({severity:Tn.error,message:l.message}),this.changed.dispatch())}),n.registerDisposer(()=>{a.cancel()}),this.changed.dispatch()}disposed(){const e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){const{loadState:e}=this;return e===void 0||e.error!==void 0?wg(this.spec):wg({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{const n=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==n?t.enabled:void 0}]})),state:this.spec.state})}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ui={side:"right",col:0,row:1/0,flex:1,size:300,minSize:100,visible:!1};class Si{constructor(e=Ui,t=e){this.defaultValue=e,this.value=t,this.changed=new j.HN,this.locationChanged=new j.HN,this.locationChanged.add(this.changed.dispatch);const n=this;this.watchableVisible={get value(){return n.visible},set value(s){n.visible=s},changed:n.locationChanged}}toJSON(e=this.defaultValue){const t={},{value:n}=this;for(const s in n)n[s]!==e[s]&&(t[s]=n[s]);return t}get visible(){return this.value.visible}set visible(e){const{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;(0,f.Rf)(e);const n={side:(0,f.MM)(e,"side",s=>{if(s!=="left"&&s!=="right"&&s!=="top"&&s!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(s)}`);return s},t.side),col:(0,f.MM)(e,"col",f.zo,t.col),row:(0,f.MM)(e,"row",f.zo,t.row),flex:(0,f.MM)(e,"flex",f.zo,t.flex),size:(0,f.MM)(e,"size",f.We,t.size),visible:(0,f.MM)(e,"visible",f.aO,t.visible),minSize:t.minSize};this.value=n,this.locationChanged.dispatch()}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ca="tab",xg="tabs",Eg="panels",LT={...Ui,row:0},Tg={...Ui,visible:!0,row:0};class Ar extends T.O8{constructor(e){super(),this.panels=e,this.layer=this.panels.layer,this.location=new Si(Tg),this.tabsChanged=new j.HN,this.selectedTab=new _.B0(void 0),this.tabs=[]}initialize(){const{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{e.specificationChanged.dispatch();const{layer:t}=this,{selectedLayer:n}=t.manager.root;if(n.layer?.layer!==t||this!==t.panels.panels[0])return;const s=this.location.value;n.location.value!==s&&(n.location.value=s,n.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)});for(const t of this.tabs){const{hidden:n}=this.layer.tabs.options.get(t);n&&this.registerDisposer(n.changed.add(()=>{this.panels.updateTabs(),this.tabsChanged.dispatch()}))}}normalizeTabs(){const{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}const t=this.layer.tabs.options,n=o=>t.get(o).order??0;e.sort((o,a)=>n(o)-n(a));const{selectedTab:s}=this,r=s.value;(r===void 0||!e.includes(r))&&(s.value=e[0])}pin(){const{layer:e}=this,{selectedLayer:t}=e.manager.root;if(t.layer?.layer!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;const{panels:n}=this,s=e.registerDisposer(new Ar(n));n.panels.splice(0,1,s),n.panels.push(this),n.updateTabs(),s.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){const{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;const{layer:n}=this,{selectedLayer:s}=n.manager.root,r=s.layer?.layer;s.visible&&r!=null&&r!==n&&r.panels.panels[0].pin(),e.panels.splice(t,1);const[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)n.unregisterDisposer(o);else{e.panels.push(o);for(let a=1,l=e.panels.length;a<l;++a){const c=e.panels[a];c.explicitTabs===void 0&&(c.explicitTabs=new Set(c.tabs))}}this.explicitTabs=void 0,e.updateTabs(),s.layer=n.managedLayer,s.location.value=this.location.value,s.location.locationChanged.dispatch(),s.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;const{panels:n}=this;{const{explicitTabs:o}=this;o!==void 0&&o.delete(e)}const{layer:s}=this,r=s.registerDisposer(new Ar(n));r.location.value=t,r.explicitTabs=new Set([e]),n.panels.splice(1,0,r),n.updateTabs(),r.initialize(),s.manager.root.layerManager.layersChanged.dispatch(),n.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{const{explicitTabs:s}=this;s!==void 0&&s.delete(e)}{const{explicitTabs:s}=t;s!==void 0&&s.add(e)}const{panels:n}=this;n.updateTabs(),t.selectedTab.value=e,n.specificationChanged.dispatch()}mergeInto(e){const{explicitTabs:t}=e;if(t!==void 0)for(const s of this.tabs)t.add(s);const{panels:n}=this;n.removePanel(this)}}class RT{constructor(e){this.layer=e,this.specificationChanged=new j.HN,this.updating=!1,this.panels=[e.registerDisposer(new Ar(this))]}restoreState(e){const{panels:t}=this;t[0].selectedTab.value=(0,f.MM)(e,ca,f.zr);const{layer:n}=this,{tabs:s}=n,r=new Set(s.options.keys());(0,f.MM)(e,Eg,o=>(0,f.$v)(o,a=>{(0,f.Rf)(a);const l=new Ar(this);l.location.restoreState(a),l.location.visible&&(l.selectedTab.value=(0,f.MM)(a,ca,f.zr),l.explicitTabs=(0,f.MM)(a,xg,c=>{const d=new Set;for(const u of(0,f.si)(c))r.has(u)&&(r.delete(u),d.add(u));return d}),l.explicitTabs===void 0?(l.tabs=Array.from(r),r.clear()):l.tabs=Array.from(l.explicitTabs),l.tabs.length!==0&&(l.normalizeTabs(),n.registerDisposer(l),l.initialize(),t.push(l)))})),t[0].tabs=Array.from(r),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;const t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){const{layer:e}=this,{tabs:t}=e,n=new Set(t.options.keys()),{panels:s}=this;this.updating=!0;const r=o=>{const a=o.tabs;if(o.explicitTabs===void 0)o.tabs=Array.from(n),n.clear();else{o.tabs=Array.from(o.explicitTabs);for(const l of o.tabs)n.delete(l)}(0,F.r1)(a,o.tabs)||(o.normalizeTabs(),o.tabsChanged.dispatch())};for(let o=1;o<s.length;){const a=s[o];if(a.location.visible&&(r(a),a.tabs.length!==0)){++o;continue}s.splice(o,1),e.unregisterDisposer(a)}if(r(s[0]),s[0].tabs.length===0){const{selectedLayer:o}=this.layer.manager.root;o.layer?.layer===this.layer&&(o.location.visible=!1)}this.updating=!1}toJSON(){const{panels:e}=this,t={};if(t[ca]=e[0].selectedTab.value,e.length>1){const n=[];for(let s=1,r=e.length;s<r;++s){const o=e[s],a=o.location.toJSON()??{};a[ca]=o.selectedTab.value;const{explicitTabs:l}=o;l!==void 0&&(a[xg]=Array.from(l)),n.push(a)}t[Eg]=n}return t}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kT(i,e){i.remove(e)}function PT(i,e){i.add(e)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Dg="tool",Ig="toolBindings",Qc="localPosition",Lg="localVelocity",Rg="localDimensions",kg="source",AT="transform",Pg="pick";class MT{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}}const Ag=[];class Rn extends T.O8{constructor(e){super(),this.managedLayer=e,this.pick=new nt(!0,!0),this.messages=new ai,this.layerEventListeners=new Map,this.layersChanged=new j.IY,this.readyStateChanged=new j.IY,this.specificationChanged=new j.IY,this.renderLayers=new Array,this.loadingCounter=1,this.tabs=this.registerDisposer(new px),this.panels=new RT(this),this.tool=this.registerDisposer(new Lx(this)),this.toolBinder=this.registerDisposer(new Dc(this,this.manager.root.toolBinder)),this.dataSourcesChanged=new j.IY,this.dataSources=[],this.localCoordinateSpaceCombiner.includeDimensionPredicate=Gh,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.messages.changed.add(this.layersChanged.dispatch);for(const t of Ag)this.tabs.add(t.id,{label:t.label,order:t.order,getter:()=>t.getter(this)})}get localPosition(){return this.managedLayer.localPosition}get localVelocity(){return this.managedLayer.localVelocity}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}dispatchLayerEvent(e){this.layerEventListeners.get(e)?.dispatch()}registerLayerEvent(e,t){const{layerEventListeners:n}=this;let s=n.get(e);s||(s=new j.HN,n.set(e,s));const r=s.add(t);return()=>r()}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=ps,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){const n=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:s}=n;if(s!==0){const o=(0,f.MM)(t,Qc,a=>(0,f.Xu)(new Float32Array(s),a,f.zo));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=(0,f.MM)(t,"annotationId",f.zr))!==void 0&&(e.annotationSourceIndex=(0,f.MM)(t,"annotationSource",f.bX,0),e.annotationPartIndex=(0,f.MM)(t,"annotationPart",f.bX),e.annotationSubsource=(0,f.MM)(t,"annotationSubsource",f.zr)),e.value=t.value}displaySelectionState(e,t,n){return!1}selectionStateToJson(e,t){const n={};if(e.localPositionValid){const{localPosition:s}=e;s.length>0&&(n.localPosition=Array.from(s))}return e.annotationId!==void 0&&(n.annotationId=e.annotationId,n.annotationPart=e.annotationPartIndex,n.annotationSource=e.annotationSourceIndex,n.annotationSubsource=e.annotationSubsource),e.value!=null&&(n.value=e.value),n}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;const n=this.localPosition.value,{localPosition:s}=e;s.length!==n.length?e.localPosition=n.slice():s.set(n),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;const n=t.localPosition,{localPosition:s}=e;s.length!==n.length?e.localPosition=n.slice():e.localPosition.set(n),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){const t=new IT(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(const t of this.dataSources){const{loadState:n}=t;if(!(n===void 0||n.error!==void 0))for(const s of n.subsources)if(s.enabled)yield s;else{const{activated:r}=s;s.messages.clearMessages(),r!==void 0&&(r.dispose(),s.activated=void 0,n.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter===0&&this.readyStateChanged.dispatch()}markLoading(){const e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter===1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){const t=this.manager.root.coordinateSpaceCombiner.bind(e),n=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}initializationDone(){const e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,n,s){return e===void 0?[]:[Pr(e,n)]}getDataSourceSpecifications(e){let t,n=(0,f.cQ)(e,kg,r=>Array.isArray(r)?r.map(o=>Pr(o)):typeof r=="object"?[Pr(r)]:(t=r,[]));const s=(0,f.cQ)(e,AT,PC);return n.push(...this.getLegacyDataSourceSpecifications(t,e,s,n)),n=n.filter(r=>r.url),n.length===0&&n.push(Sg()),n}restoreState(e){this.tool.restoreState(e[Dg]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[Rg]),this.localPosition.restoreState(e[Qc]),this.localVelocity.restoreState(e[Lg]),this.toolBinder.restoreState(e[Ig]),this.constructor.supportsPickOption&&this.pick.restoreState(e[Pg]);for(const t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);const{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){const{renderLayers:t,layersChanged:n}=this,s=t.indexOf(e);if(s===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(s,1),e.layerChanged.remove(n.dispatch),e.userLayer=void 0,e.dispose(),n.dispatch()}disposed(){const{layersChanged:e}=this;(0,T.$F)(this.dataSources);for(const t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let n;const{renderLayers:s}=this,{pickedRenderLayer:r}=t;if(r!==null&&s.indexOf(r)!==-1&&(n=r.transformPickedValue(t),n=this.transformPickedValue(n),n!=null))return n;for(const o of s)if(n=o.getValueAt(e),n!=null)break;return this.transformPickedValue(n)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[kg]:NT(this.dataSources),[Dg]:this.tool.toJSON(),[Ig]:this.toolBinder.toJSON(),[Rg]:this.localCoordinateSpace.toJSON(),[Qc]:this.localPosition.toJSON(),[Lg]:this.localVelocity.toJSON(),[Pg]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){const{globalPosition:n}=this.manager.root,{localPosition:s}=this;(0,F.b8)(n.value,t,e.globalToRenderLayerDimensions),(0,F.b8)(s.value,t,e.localToRenderLayerDimensions),s.changed.dispatch(),n.changed.dispatch()}}Rn.supportsPickOption=!1;function NT(i){if(i.length!==0)return i.length===1?i[0].toJSON():i.map(e=>e.toJSON())}class Kc extends T.O8{constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new zl,this.localCoordinateSpaceCombiner=new Ql(this.localCoordinateSpace,rr),this.localPosition=this.registerDisposer(new ui(this.localCoordinateSpace)),this.localVelocity=this.registerDisposer(new gc(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new j.IY,this.layerChanged=new j.IY,this.specificationChanged=new j.IY,this.containers=new Set,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e,this.registerDisposer(new mc(this.manager.root.display,this.localPosition,this.localVelocity))}get layer(){return this.layer_}set layer(e){const t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){const n=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{n.forEach(s=>s())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){const{layer:e}=this;return e?.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){const t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){const e=this.layer;if(e===null)return;const t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(const{layerManager:t}of this.manager.root.subsets)t.has(this)&&t.removeManagedLayer(this)}else{for(const{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class Mg extends T.O8{constructor(){super(),this.managedLayers=new Array,this.layerSet=new Set,this.layersChanged=new j.IY,this.readyStateChanged=new j.IY,this.specificationChanged=new j.IY,this.boundPositions=new WeakSet,this.numDirectUsers=0,this.nonArchivedLayerIndexGeneration=-1,this.renderLayerToManagedLayerMapGeneration=-1,this.renderLayerToManagedLayerMap_=new Map,this.scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,Fe.A)(()=>this.removeLayersWithSingleRef(),0)),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){const e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(const n of this.managedLayers)n.archived||(n.nonArchivedLayerIndex=t++);for(const n of this.managedLayers)n.archived&&(n.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(const n of this.managedLayers)if(!n.archived){if(t===e)return n;++t}}get renderLayerToManagedLayerMap(){const e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(const n of this.managedLayers){const s=n.layer;if(s!==null)for(const r of s.renderLayers)t.set(r,n)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(n=>e(n)?!0:(this.unbindManagedLayer(n),this.layerSet.delete(n),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers===1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers===0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,PT),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(const e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,kT),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(const e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){const t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){const t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){const n=this.managedLayers.length;if(e===t||e<0||e>=n||t<0||t>=n)return;const[s]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,s),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,n=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++n;return t}has(e){return this.layerSet.has(e)}get renderLayers(){const e=this;return{*[Symbol.iterator](){for(const t of e.managedLayers)if(t.layer!==null)for(const n of t.layer.renderLayers)yield n}}}get visibleRenderLayers(){const e=this;return{*[Symbol.iterator](){for(const t of e.managedLayers)if(!(t.layer===null||!t.visible))for(const n of t.layer.renderLayers)yield n}}}invokeAction(e){const t=new MT;for(const n of this.managedLayers){if(n.layer===null||!n.visible)continue;const s=n.layer;s.handleAction(e,t);for(const r of s.renderLayers)r.handleAction(e)}for(const n of t.callbacks)n()}}class OT{constructor(){this.changed=new j.IY,this.coordinateSpace=Fn,this.position=ps,this.unsnappedPosition=ps,this.active=!1,this.displayDimensions=void 0,this.pickedRenderLayer=null,this.pickedValue=new P.R(0,0),this.pickedOffset=0,this.pickedAnnotationLayer=void 0,this.pickedAnnotationId=void 0,this.pickedAnnotationBuffer=void 0,this.pickedAnnotationBufferBaseOffset=void 0,this.pickedAnnotationIndex=void 0,this.pickedAnnotationCount=void 0,this.pickedAnnotationType=void 0,this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){const{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}}class _T extends T.O8{constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new j.IY,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;const e=this.mouseState,t=this.changed.count;if(e.active)for(const n of this.layerManager.managedLayers){const s=n.layer;if(n.visible&&s!==null){const{selectionState:r}=s;s.resetSelectionState(r),r.generation=t,s.captureSelectionState(r,e)}}}get(e){this.update();const{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();const e={};for(const t of this.layerManager.managedLayers){const n=t.layer;if(n){const s=this.get(n);s!==void 0&&(e[t.name]=n.selectionStateToJson(s,!0))}}return e}}const Ng=10,qc={...Ui,minSize:150,row:1},Og={...qc,visible:!0};class VT extends T.O8{constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new j.IY,this.history=[],this.historyIndex=0,this.location=new Si(qc),this.pin=new _.B0(!0),this.registerDisposer((0,_.no)((n,s)=>{s||(this.capture(!0),n.registerDisposer(t.changed.add(n.registerCancellable((0,la.A)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){const e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;const e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){const{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>Ng&&t.splice(0,t.length-Ng),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,n=!0){if(n===!1&&(!this.location.visible||this.pin.value))return;const s={};e.initializeSelectionState(s),t(s)&&(this.location.visible=!0,n===!0?this.pin.value=!0:n==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:s}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){const{value:e}=this;let t;if(this.location.visible){if(t=this.location.toJSON(Og),this.pin.value&&e!==void 0){const n={};for(const s of e.layers){const{layer:r}=s;let o=r.selectionStateToJson(s.state,!1);Object.keys(o).length===0&&(o=void 0),n[s.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=n}}else t=this.location.toJSON(qc),t=(0,f.Zu)(t),t!==void 0&&(t.visible=!1);return t}select(){const{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){const t=BT(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}(0,f.Rf)(e),this.location.restoreState(e,Og);const t=this.coordinateSpace.value,n=(0,f.MM)(e,"position",r=>(0,f.Xu)(new Float32Array(t.rank),r,f.zo)),s=[];(0,f.MM)(e,"layers",r=>{(0,f.Rf)(r);const{layerManager:o}=this.layerSelectedValues;for(const[a,l]of Object.entries(r)){const c=o.getLayerByName(a);if(c===void 0)return;const d=c.layer;if(d===null)return;(0,f.Rf)(l);const u={};d.initializeSelectionState(u),d.selectionStateFromJson(u,l),s.push({layer:d,state:u})}}),this.pin.value=s.length>0||n!==void 0,this.value={position:n,coordinateSpace:t,layers:s}}}function BT(i){const{mouseState:e}=i;if(!e.active)return;const t=[];for(const n of i.layerManager.managedLayers){const s=n.layer;if(s===null)continue;const r=i.get(s);if(r===void 0)continue;const o={};s.initializeSelectionState(o),s.copySelectionState(o,r),t.push({layer:s,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}class FT extends T.O8{constructor(e){super(),this.view=e,this.messages=new ai,this.seenGeneration=-1,this.state=void 0}}let UT=0;class $T extends T.O8{constructor(e,t,n,s,r,o){super(),this.layerManager=e,this.renderLayerType=t,this.view=n,this.roles=s,this.layerAdded=r,this.visibility=o,this.visibleLayers_=new Map,this.debouncedUpdateVisibleLayers=this.registerCancellable((0,Fe.A)(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(s.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){const e=++UT,{visibleLayers_:t,renderLayerType:n,layerAdded:s,roles:r}=this;for(const o of this.layerManager.readyRenderLayers())if(o instanceof n&&r.has(o.role)){const a=o;let l=t.get(a);l===void 0&&(l=new FT(this.view),l.registerDisposer(a.messages.addChild(l.messages)),l.registerDisposer(a.addRef()),l.registerDisposer(a.visibility.add(this.visibility)),t.set(a,l),s(a,l),a.attach(l)),l.seenGeneration=e}for(const[o,a]of t)a.seenGeneration!==e&&(t.delete(o),a.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function _g(i,e,t,n,s){return n.registerDisposer(new $T(i,e,n,t,(r,o)=>{o.registerDisposer(r.redrawNeeded.add(()=>n.scheduleRedraw()));const{backend:a}=r;a&&(a.rpc.invoke(go.sC,{layer:a.rpcId,view:n.rpcId}),o.registerDisposer(()=>a.rpc.invoke(go.lG,{layer:a.rpcId,view:n.rpcId}))),s!==void 0&&s(r,o),n.scheduleRedraw(),o.registerDisposer(()=>n.scheduleRedraw())},n.visibility))}class GT extends T.O8{constructor(e){super(),this.layerManager=e,this.changed=new j.IY,this.location=new Si(LT),this.registerDisposer(e),this.location.changed.add(()=>{this.changed.dispatch();const t=this.layer?.layer??void 0;if(t!==void 0){const n=this.location.value;if(n.visible){const s=t.panels.panels[0];s.location.value!==n&&(s.location.value=n,s.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){const{managedLayers:n}=this.layerManager;n.length>0?t=this.layer=n[0]:e=!1}if(e===!0&&t!==void 0){const n=t.layer;(n===null||n.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;const t=e.layer;t!==null&&t instanceof jn&&(t.dataSources.some(n=>n.spec.url.length!==0)||Ms(e))}set layer(e){if(e===this.layer_)return;const t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){const n=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(n);const s=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{const r=e.layer;if(r!==null){const o=r.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(n),s()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){const e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),(0,f.Zu)(e)}restoreState(e){if(e===void 0){this.reset();return}(0,f.Rf)(e),this.location.restoreState(e);const t=(0,f.cQ)(e,"layer",f.z$),n=t!==void 0?this.layerManager.getLayerByName(t):void 0;n===void 0&&(this.visible=!1),this.layer=n}reset(){this.location.reset(),this.layer=void 0}}class zT extends T.O8{constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new j.IY,this.validate=(0,Fe.A)(()=>{const{layerName_:n}=this;if(n!==void 0){const s=this.layerManager.getLayerByName(n);s!==void 0&&this.filter(s)?(this.layer_=s,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{const{layer_:n}=this;if(n!==void 0)if(!this.layerManager.layerSet.has(n)||!this.filter(n))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{const{name:s}=n;s!==this.layerName_&&(this.layerName_=s,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){const t=(0,f.z$)(e);this.layerName=t}toJSON(){const{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class Vg extends T.O8{constructor(e,t,n,s){super(),this.layerManager=e,this.layer=t,this.predicate=n,this.getGroup=s,this.linkedLayers_=new Set,this.changed=new j.IY,this.linkedLayersChanged=new j.IY,this.root_=t;const r=this;this.root={get value(){return r.root_},changed:r.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;const t=(0,f.zr)(e);this.linkByName(t)}toJSON(){const{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){const{getGroup:t,layer:n,root_:s}=this;if(s===n){const{linkedLayers_:o}=this;if(o.size!==0){for(const a of o){const l=t(a);l.root_=a,l.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}const r=t(s);r.linkedLayers_.delete(n),r.linkedLayersChanged.dispatch(),this.root_=n,e&&this.changed.dispatch()}linkByName(e){const{layer:t}=this,{managedLayer:n}=t,{layerManager:s}=this,r=s.getLayerByName(e);if(r===void 0||r===n)return;const o=r.layer;o!==null&&this.predicate(o)&&this.linkToLayer(o)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);const{getGroup:t}=this,n=t(e).root_;if(n===this.layer)return;const s=t(n);s.linkedLayers_.add(this.layer),s.linkedLayersChanged.dispatch(),this.root_=n,this.changed.dispatch()}disposed(){this.isolate(!1)}}function Bg(i,e){const t=(0,f.MM)(e,"type",f.zr,"auto");i.archived=(0,f.MM)(e,"archived",f.aO,!1),i.archived?i.visible=!1:i.visible=(0,f.MM)(e,"visible",f.aO,!0);const n=Mr.get(t)||jn;return i.layer=new n(i),e}function Fg(i,e){try{const t=i.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw Ms(i),t}}function Ug(i,e){try{(0,f.Rf)(e),Bg(i,e),Fg(i,e)}catch(t){throw Ms(i),t}}function WT(i,e){try{Ug(i,e)}catch(t){new pe().setErrorMessage(t instanceof Error?t.message:""+t)}}function $g(i,e,t){const n=new Kc(e,i);return Ug(n,t),n}class Gg extends T.O8{constructor(){super(...arguments),this.changed=new j.IY}}class HT extends Gg{constructor(e,t,n,s,r,o,a,l,c){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=n,this.chunkManager=s,this.selectionState=r,this.selectedLayer=o,this.coordinateSpace=a,this.globalPosition=l,this.toolBinder=c,this.coordinateSpaceCombiner=new Ql(this.coordinateSpace,DC),this.subsets=new Set,this.layerSelectedValues=this.selectionState.layerSelectedValues,this.registerDisposer(n.layersChanged.add(this.changed.dispatch)),this.registerDisposer(n.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:((0,f.Rf)(e),t=Object.entries(e).map(([s,r])=>typeof r=="string"?{name:s,source:r}:((0,f.Rf)(r),{...r,name:s})));const n=[];for(const s of t){(0,f.Rf)(s);const r=this.layerManager.getUniqueLayerName((0,f.cQ)(s,"name",f.zr)),o=new Kc(r,this);try{Bg(o,s),this.layerManager.addManagedLayer(o),n.push({managedLayer:o,spec:s})}catch(a){o.dispose(),new pe().setErrorMessage(`Error creating layer ${JSON.stringify(r)}: `+(a instanceof Error)?a.message:""+a)}}for(const{managedLayer:s,spec:r}of n)try{Fg(s,r)}catch(o){new pe().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){const e=[];let t=0;for(const n of this.layerManager.managedLayers){const s=n.toJSON();s!=null&&(e.push(s),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}}class zg extends Gg{constructor(e){super(),this.master=e,this.changed=new j.IY,this.layerManager=this.registerDisposer(new Mg),this.registerDisposer(e);const{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){const t=this.master.layerManager,n=[];for(const s of new Set((0,f.$v)(e,f.zr))){const r=t.getLayerByName(s);if(r===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(s)}`);r.archived||n.push(r)}this.layerManager.clear();for(const s of n)this.layerManager.addManagedLayer(s.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}const Mr=new Map,Xc=new Map,Wg=[i=>{const{volume:e}=i;if(e===void 0)return;const t=Xc.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function $i(i,e=i.type){Mr.set(e,i)}function da(i){Wg.push(i)}function Hg(i,e){Xc.set(i,e)}function Zc(i,e){const t=i.layer;if(t===null)return;const n=t.toJSON(),s=new e(i);s.restoreState(n),s.initializationDone(),i.layer=s}function Jg(i,e){return e!==i.name?(e=i.manager.root.layerManager.getUniqueLayerName(e),i.name=e,i.layerChanged.dispatch(),!0):!1}function Ms(i){if(!i.wasDisposed)for(const e of i.containers)e.removeManagedLayer(i)}function ua(i,e){return i===void 0?e:e===void 0?i:i.priority<e.priority?e:i}function jg(i){let e;for(const n of Wg)e=ua(e,n(i));const{volume:t}=i;if(t!==void 0){const n=Xc.get(t.volumeType);n!==void 0&&(e=ua(e,{layerConstructor:n,priority:0}))}return e}function JV(i){let e;for(const t of i.dataSources){const{loadState:n}=t;if(!(n===void 0||n.error!==void 0))for(const s of n.subsources){const{subsourceEntry:r}=s,{subsource:o}=r;s.enabled&&(e=ua(e,jg(o)))}}return e?.layerConstructor}function Yg(i){let e;for(const t of i){const{subsourceEntry:n}=t,{subsource:s}=n;e=ua(e,jg(s))}return e}class jn extends Rn{activateDataSubsources(e){this.detectedLayerConstructor=Yg(e)?.layerConstructor}}jn.type="new",jn.typeAbbreviation="new";class ed extends Rn{activateDataSubsources(e){const t=Yg(e)?.layerConstructor;t!==void 0&&Zc(this.managedLayer,t)}}ed.type="auto",ed.typeAbbreviation="auto";function Qg(i,e){const t=$g(i,"new layer",{type:"new"});i.add(t),e.layer=t,e.visible=!0}$i(jn),$i(ed);const td="selectedAlpha",nd="notSelectedAlpha",id="objectAlpha",sd="saturation",rd="hoverHighlight",od="hideSegmentZero",ad="baseSegmentColoring",ld="ignoreNullVisibleSet",JT="mesh",jT="skeletons",cd="segments",ha="equivalences",dd="colorSeed",Kg="segmentColors",ud="meshRenderScale",hd="crossSectionRenderScale",pa="skeletonRendering",YT="skeletonShader",qg="segmentQuery",pd="meshSilhouetteRendering",Xg="linkedSegmentationGroup",Zg="linkedSegmentationColorGroup",fd="segmentDefaultColor",em="anchorSegment",tm="skeletonShaderControl";/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function nm(i,e,t,n){const s=document.createElement("label");s.classList.add("neuroglancer-layer-control-container");const r=document.createElement("div");r.classList.add("neuroglancer-layer-control-label-container");const o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),r.appendChild(o);const a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-text-container"),a.appendChild(document.createTextNode(t.label)),o.appendChild(a),t.title&&(o.title=t.title),s.appendChild(r);const{control:l,controlElement:c}=t.makeControl(e,i,{labelContainer:r,labelTextContainer:a,display:e.manager.root.display,visibility:n});return c.classList.add("neuroglancer-layer-control-control"),s.appendChild(c),{controlContainer:s,label:o,labelContainer:r,labelTextContainer:a,control:l}}class im extends gi{constructor(e,t){super(e),this.options=t}activate(e){const{options:t}=this,{layer:n}=this,{isValid:s}=t;if(s!==void 0&&!s(n).value)return;const{header:r,body:o}=Vi(e),{controlContainer:a,control:l,labelContainer:c}=nm(e,n,t,new vt(vt.VISIBLE));r.appendChild(c),o.appendChild(a),t.activateTool(e,l)}get description(){const{options:e}=this;return e.toolDescription??e.label}toJSON(){return this.options.toolJson}}function sm(i,e,t,n){const{controlContainer:s,label:r}=nm(i,e,t,n);return s.classList.add("neuroglancer-layer-options-control-container"),r.prepend(i.registerDisposer(new Lf(e.toolBinder,t.toolJson)).element),s}function fa(i,e,t,n){const{isValid:s}=n;return s===void 0?sm(i,e,n,t):i.registerDisposer(new Wt(s(e),(r,o,a)=>{r&&o.appendChild(sm(a,e,n,t))},t)).element}function gd(i,e){const{toolJson:t}=e,n=typeof t=="string"?t:t.type;sn(i,n,s=>new im(s,e))}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Nr(i){return{makeControl:(e,t)=>{const n=i(e),s=t.registerDisposer(new pn(n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const QT=Ae.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function md(i){return{makeControl:(e,t)=>{const n=i(e),s=t.registerDisposer(new Bo(n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{e.bindInputEventMap(QT),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(n.detail)})}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class KT extends T.O8{constructor(e,{min:t=0,max:n=1,step:s=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");const{element:r,inputElement:o,numericInputElement:a}=this;r.className="range-slider";const l=d=>{d.min=""+t,d.max=""+n,d.step=""+s,d.valueAsNumber=this.value.value,this.registerEventListener(d,"change",()=>this.inputValueChanged(d)),this.registerEventListener(d,"input",()=>this.inputValueChanged(d)),this.registerEventListener(d,"wheel",u=>{this.adjustViaWheel(d,u)})};o.type="range",l(o),a.type="number";const c=Math.max(t.toString().length,n.toString().length,Math.min(n,t+s).toString().length,Math.max(t,n-s).toString().length);a.style.width=c+2+"ch",l(a),r.appendChild(o),r.appendChild(a),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){const n=this.inputElement,{deltaY:s}=t;s>0?(n.stepUp(),this.inputValueChanged(e)):s<0&&(n.stepDown(),this.inputValueChanged(e))}disposed(){at(this.element),super.disposed()}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const qT=Ae.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function Yn(i){return{makeControl:(e,t)=>{const{value:n,options:s}=i(e),r=t.registerDisposer(new KT(n,s));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(qT),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(t.inputElement,n.detail)})}}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function rm(i,e){let t="";for(let n=0;n<=e&&(t=i.toFixed(n),parseFloat(t)!==i);++n);return t}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const XT=200,om=Ae.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function ZT(i){if(i<1||i>1024){const e=Math.log2(i)|0,t=i/2**e;return`${rm(t,1)}p${e}`}return Math.round(i)+""}class ga extends T.O8{constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.logScaleOrigin=ks,this.unitOfTarget="px",this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new _.B0(void 0),this.throttledUpdateView=this.registerCancellable((0,la.A)(()=>this.debouncedUpdateView(),XT,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable((0,Fe.A)(()=>this.updateView(),0));const{canvas:n,label:s,element:r,legend:o,legendRenderScale:a,legendSpatialScale:l,legendChunks:c}=this;s.className="neuroglancer-render-scale-widget-prompt",r.className="neuroglancer-render-scale-widget",r.title=om.describe(),o.className="neuroglancer-render-scale-widget-legend",r.appendChild(s),r.appendChild(n),r.appendChild(o),a.title="Target resolution of data in screen pixels",c.title="Number of chunks rendered",o.appendChild(a),o.appendChild(c),o.appendChild(l),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new tn(n,om)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));const d=h=>{const p=h.offsetX/n.width*mt;return aT(p,this.logScaleOrigin)};this.registerEventListener(n,"pointermove",h=>{this.hoverTarget.value=[d(h),h.offsetY]}),this.registerEventListener(n,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(Z(n,"set",h=>{this.target.value=d(h.detail)})),this.registerDisposer(Z(n,"adjust-via-wheel",h=>{this.adjustViaWheel(h.detail)})),this.registerDisposer(Z(n,"reset",h=>{this.reset(),h.preventDefault()}));const u=new ResizeObserver(()=>this.debouncedUpdateView());u.observe(n),this.registerDisposer(()=>u.disconnect()),this.updateView()}adjustViaWheel(e){const t=this.getWheelMoveValue(e);if(t===0)return;this.hoverTarget.value=void 0;const n=Math.round(this.logScaleOrigin+mt*Ir),s=Pe([2**this.logScaleOrigin,2**(n-1)],this.target.value*2**Math.sign(t));this.target.value=s,e.preventDefault()}getWheelMoveValue(e){return e.deltaY}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){const{ctx:e}=this,{canvas:t}=this,n=t.width=t.offsetWidth,s=t.height=t.offsetHeight,r=this.target.value,o=this.hoverTarget.value;{const{legendRenderScale:E}=this,D=o===void 0?r:o[0],I=ZT(D);E.textContent=I+" "+this.unitOfTarget}function a(E){return E*n/mt}e.clearRect(0,0,n,s);const{histogram:l}=this,{value:c,spatialScales:d}=l;l.visibility.visible||c.fill(0);const u=Array.from(d.keys());u.sort();const h=C.eR.create();let p=1;const m=d.size;let g=0,v=0;for(let E=0;E<mt;++E){let D=0;for(let I=0;I<m;++I){const L=I*mt*2+E,N=c[L],k=c[L+mt];g+=N,v+=k,D+=N+k}p=Math.max(D,p)}v-=l.fakeChunkCount;const S=s/Math.log(1+p);function w(E){return s-Math.log(1+E)*S}let b;if(o!==void 0){const E=Math.floor(ea(o[0],this.logScaleOrigin));if(E>=0&&E<mt){let D=0;const I=o[1];for(let L=m-1;L>=0;--L){const N=u[L],O=2*d.get(N)*mt+E,V=c[O]+c[O+mt];if(V===0)continue;const z=Math.round(w(D));if(D+=V,Math.round(w(D))<=I&&I<=z){b=N;break}}}}if(b!==void 0){g=0,v=0;const D=2*d.get(b)*mt;for(let I=0;I<mt;++I){const L=D+I;g+=c[L],v+=c[L+mt]}Number.isFinite(b)?this.legendSpatialScale.textContent=Ri(b,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${g}/${g+v}`;const x=u.map(E=>{const D=E===b?.5:1;let I;Number.isFinite(E)?I=(Math.log2(E)*.1%1+1)%1:I=0,Mo(h,I,D,1);const L=Ge(h);Mo(h,I,D,.5);const N=Ge(h);return[L,N]});for(let E=0;E<mt;++E){let D=0;for(let I=m-1;I>=0;--I){const L=u[I],k=d.get(L)*mt*2+E,O=c[k],V=c[k+mt],z=O+V;if(z===0)continue;const Y=Math.round(a(E)),Q=Math.round(a(E+1)),X=Math.round(w(D));D+=z;const ce=Math.round(w(D)),oe=(O*ce+V*X)/z;e.fillStyle=x[I][1],e.fillRect(Y,ce,Q-Y,oe-ce),e.fillStyle=x[I][0],e.fillRect(Y,oe,Q-Y,X-oe)}}{const E=r;e.fillStyle="#fff";const D=a(ea(E,this.logScaleOrigin));e.fillRect(Math.floor(D),0,1,s)}if(o!==void 0){const E=o[0];e.fillStyle="#888";const D=a(ea(E,this.logScaleOrigin));e.fillRect(Math.floor(D),0,1,s)}}}class eD extends ga{constructor(){super(...arguments),this.unitOfTarget="samples",this.logScaleOrigin=1}getWheelMoveValue(e){return-e.deltaY}}const tD=Ae.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function ma(i,e=ga){return{makeControl:(t,n)=>{const{histogram:s,target:r}=i(t),o=n.registerDisposer(new e(s,r));return{control:o,controlElement:o.element}},activateTool:(t,n)=>{t.bindInputEventMap(tD),t.bindAction("adjust-via-wheel",s=>{s.stopPropagation(),s.preventDefault(),n.adjustViaWheel(s.detail)}),t.bindAction("reset",s=>{s.stopPropagation(),s.preventDefault(),n.reset()})}}}var nD=G(8682);/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const iD=Ae.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function am(i){return{makeControl:(e,t)=>{const n=i(e),s=t.registerDisposer(new hi(n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{e.bindInputEventMap(iD),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustHueViaWheel(n.detail)})}}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lm extends T.O8{constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));const{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){at(this.element)}updateView(){this.element.value=(this.model.value??"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function va(i,e){e?i.displayState.segmentDefaultColor.value=C.eR.fromValues(1,0,0):i.displayState.segmentDefaultColor.value=void 0}function sD(){const i=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:n})=>{const s=document.createElement("input");s.type="radio",s.addEventListener("change",()=>{va(e,!s.checked)}),n.prepend(s);const r=document.createElement("div");r.classList.add("neuroglancer-segmentation-color-seed-control");const o=t.registerDisposer(new lm(e.displayState.segmentColorHash));r.appendChild(o.element);const a=Ne({svg:nD,title:"Randomize",onClick:()=>i(e)});return r.appendChild(a),t.registerDisposer((0,_.W1)(l=>{const c=l===void 0;r.style.visibility=c?"":"hidden",s.checked=c},e.displayState.segmentDefaultColor)),{controlElement:r,control:o}},activateTool:e=>{const{layer:t}=e.tool;va(t,!1),i(t)}}}function rD(){const i=am(e=>e.displayState.segmentDefaultColor);return{...i,makeControl:(e,t,n)=>{const s=i.makeControl(e,t,n),{controlElement:r}=s,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{va(e,o.checked),o.checked&&r.click()}),n.labelTextContainer.prepend(o),t.registerDisposer((0,_.W1)(a=>{const l=a!==void 0;r.style.visibility=l?"":"hidden",o.checked=l},e.displayState.segmentDefaultColor)),s},activateTool:(e,t)=>{va(e.tool.layer,!0),i.activateTool(e,t)}}}const cm=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:dd,...sD()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:fd,...rD()},{label:"Saturation",toolJson:sd,title:"Saturation of segment colors",...Yn(i=>({value:i.displayState.saturation}))},{label:"Opacity (on)",toolJson:td,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...Yn(i=>({value:i.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:nd,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...Yn(i=>({value:i.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:hd,isValid:i=>i.has2dLayer,...ma(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:ud,isValid:i=>i.has3dLayer,...ma(i=>({histogram:i.displayState.renderScaleHistogram,target:i.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:id,isValid:i=>i.has3dLayer,title:"Opacity of meshes and skeletons",...Yn(i=>({value:i.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:pd,isValid:i=>i.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...Yn(i=>({value:i.displayState.silhouetteRendering,options:{min:0,max:oD,step:.1}}))},{label:"Hide segment ID 0",toolJson:od,title:"Disallow selection and display of segment id 0",...Nr(i=>i.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:ad,title:"Color base segments individually",...Nr(i=>i.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:ld,...Nr(i=>i.displayState.ignoreNullVisibleSet)},{label:"Highlight on hover",toolJson:rd,title:"Highlight the segment under the mouse pointer",...Nr(i=>i.displayState.hoverHighlight)},...dm("2d"),...dm("3d")],oD=10;function dm(i){return[{label:`Skeleton mode (${i})`,toolJson:`${pa}.mode${i}`,isValid:e=>e.hasSkeletonsLayer,...md(e=>e.displayState.skeletonRenderingOptions[`params${i}`].mode)},{label:`Line width (${i})`,toolJson:`${pa}.lineWidth${i}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${i})`,title:`Skeleton line width (${i})`,...Yn(e=>({value:e.displayState.skeletonRenderingOptions[`params${i}`].lineWidth,options:{min:1,max:40,step:1}}))}]}function aD(i){for(const e of cm)gd(i,e)}var bn=G(3708);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lD(i,e,t){return i&1|e<<1&2|t<<2&4}function jV(i,e,t,n){const s=Math.max(e,t,n);let r=0,o=i.low,a=0,l=0,c=0;for(let d=0;d<s;++d){if(d<e){const u=o>>>r&1;a|=u<<d,r===31?(r=0,o=i.high):++r}if(d<t){const u=o>>>r&1;l|=u<<d,r===31?(r=0,o=i.high):++r}if(d<n){const u=o>>>r&1;c|=u<<d,r===31?(r=0,o=i.high):++r}}return Uint32Array.of(a,l,c)}function YV(i,e,t,n,s,r,o){const a=Math.max(e,t,n);let l=0,c=0,d=!1;function u(h){c|=(h&1)<<l,++l===32&&(i.low=c>>>0,c=0,l=0,d=!0)}for(let h=0;h<a;++h)h<e&&u(s>>h&1),h<t&&u(r>>h&1),h<n&&u(o>>h&1);return d?i.high=c>>>0:(i.high=0,i.low=c>>>0),i}function QV(i,e,t){let n=0;const s=e.length;let r=0,o=!1;function a(l){r|=(l&1)<<n,++n===32&&(i.low=r>>>0,r=0,n=0,o=!0)}for(let l=0;l<32;++l)for(let c=0;c<s;++c)t[c]-1>>>l&&a(e[c]>>>l);return o?i.high=r>>>0:(i.high=0,i.low=r>>>0),i}function um(i,e){return i<e&&i<(i^e)}function KV(i,e,t,n,s,r){let o=t,a=r;return um(o^a,e^s)&&(o=e,a=s),um(o^a,i^n)&&(o=i,a=n),o<a}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ya=!1;function cD(i,e,t,n,s,r,o){const{octree:a,lodScales:l,chunkGridSpatialOrigin:c,chunkShape:d}=i,u=l.length-1,h=e[0],p=e[4],m=e[8],g=e[1],v=e[5],y=e[9],S=e[3],w=e[7],b=e[11],x=e[15],E=S>0?0:1,D=w>0?0:1,I=b>0?0:1,L=t[4*4],N=t[4*4+1],k=t[4*4+2],O=t[4*4+3];function V(dt,be,Ye){return S*dt+w*be+b*Ye+x}function z(dt,be,Ye,bt,ni,oo){return V(dt+E*(bt-dt),be+D*(ni-be),Ye+I*(oo-Ye))}const Y=V(-O*L,-O*N,-O*k),Q=i.clipLowerBound[0],X=i.clipLowerBound[1],ce=i.clipLowerBound[2],oe=i.clipUpperBound[0],Se=i.clipUpperBound[1],Ke=i.clipUpperBound[2],$e=Math.sqrt((h*s)**2+(g*r)**2),Tt=Math.sqrt((p*s)**2+(v*r)**2),we=Math.sqrt((m*s)**2+(y*r)**2),xe=Math.max($e,Tt,we);function ct(dt,be,Ye){const bt=1<<dt,ni=be*5,oo=a[ni],vh=a[ni+1],yh=a[ni+2],Sh=a[ni+3],Dl=a[ni+4];let as=oo*bt*d[0]+c[0],ls=vh*bt*d[1]+c[1],ao=yh*bt*d[2]+c[2],Il=as+bt*d[0],Ll=ls+bt*d[1],Rl=ao+bt*d[2];if(as=Math.max(as,Q),ls=Math.max(ls,X),ao=Math.max(ao,ce),Il=Math.min(Il,oe),Ll=Math.min(Ll,Se),Rl=Math.min(Rl,Ke),(0,C.T_)(as,ls,ao,Il,Ll,Rl,t)){const bh=Math.max(Y,z(as,ls,ao,Il,Ll,Rl))/xe;if(Ye===0||bh*n<Ye){const nr=l[dt];if(nr!==0&&o(dt,be,nr/bh,Dl>>>31),dt>0&&(nr===0||bh*n<nr)){const mV=nr===0?Ye:nr,vV=(Dl&2147483647)>>>0;for(let Ch=Sh;Ch<vV;++Ch)ct(dt-1,Ch,mV)}}}}ct(u,a.length/5-1,0)}function hm(i,e,t,n,s,r,o,a){const{lodScales:l}=i;let c=0;for(;c+1<l.length&&l[c+1]!==0;)++c;const d=3,u=[];let h=0,p=0;function m(y,S){for(ya&&console.log(`emitChunksUpTo: stackDepth=${h}, targetStackIndex=${y}, subChunkIndex=${S}, priorSubChunkIndex=${p}`);;){if(h===0)return;const w=h-1,b=c-w,x=u[w*d],E=b===0?1:8,D=u[w*d+1],I=u[w*d+2];if(y===h){const L=S&E-1;p!==L&&x!==-1&&(ya&&console.log(`  drawing chunk because priorSubChunkIndex (${p}) != endSubChunk (${L})`),a(b,x,p,L,I)),p=L+1;return}p!==E&&x!==-1&&a(b,x,p,E,I),p=D+1,--h}}let g=0;ya&&(console.log(""),console.log("Starting to draw"));const{octree:v}=i;cD(i,e,t,n,s,r,(y,S,w,b)=>{if(!b&&!o(y,S,w)){g=Math.max(y,g);return}if(y<g)return;g=0;const x=S*5,E=v[x],D=v[x+1],I=v[x+2],L=lD(E,D,I),N=c-y;m(N,L);const k=N*d;u[k]=b?-1:S,u[k+1]=L,u[k+2]=w,ya&&console.log(`Adding to stack: lod=${y}, row=${u[k]}, subChunkIndex=${L}`),p=0,h=N+1}),m(0,0)}function dD(i){if(i.length%5!==0)throw new Error("Invalid length");const e=i.length/5,t=new Set;function n(s){if(t.has(s))throw new Error("Previously seen node");if(t.add(s),s<0||s>=e)throw new Error("Invalid node reference");const r=i[s*5],o=i[s*5+1],a=i[s*5+2],l=i[s*5+3],c=i[s*5+4];if(l<0||c<0||c<l||c>e||l+8<c)throw new Error("Invalid child references");for(let d=l;d<c;++d){const u=i[d*5],h=i[d*5+1],p=i[d*5+2];if(u>>>1!==r||h>>>1!==o||p>>>1!==a)throw new Error("invalid child");n(d)}}if(e!==0&&(n(e-1),t.size!==e))throw new Error("Orphan nodes in octree")}function pm(i,e,t){return`${i}/${e}:${t}`}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gi extends vp{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}var Sa=G(9254);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vd=3,uD=.8,bi=!1;let kn=0,Pn=0,fm=0,gm=0;class Or{constructor(e=Or.generateHashSeeds(vd)){this.hashSeeds=e,this.loadFactor=uD,this.size=0,this.emptyLow=4294967295,this.emptyHigh=4294967295,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=Or.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){const t=this.hashSeeds.length,n=new Array(t);for(let l=0;l<t;++l)n[l]=this.getHash(l,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:s}=this;if(s===-1)e:for(;;){s=Math.random()*16777216>>>0;for(let l=0;l<t;++l){const c=this.getHash(l,s,s);for(let d=0;d<t;++d)if(n[d]===c)continue e}this.mungedEmptyKey=s;break}const{table:r,emptyLow:o,emptyHigh:a}=this;for(let l=0;l<t;++l){const c=n[l];r[c]===o&&r[c+1]===a&&(r[c]=s,r[c+1]=s)}try{e(r)}finally{for(let l=0;l<t;++l){const c=n[l];r[c]===s&&r[c+1]===s&&(r[c]=o,r[c+1]=a)}}}static generateHashSeeds(e=vd){return ot(new Uint32Array(e))}getHash(e,t,n){let s=this.hashSeeds[e];return s=(0,Sa._)(s,t),s=(0,Sa._)(s,n),this.entryStride*(s&this.tableSize-1)}*keys(){const{emptyLow:e,emptyHigh:t,entryStride:n}=this,{table:s}=this;for(let r=0,o=s.length;r<o;r+=n){const a=s[r],l=s[r+1];(a!==e||l!==t)&&(yield new P.R(a,l))}}*unsafeKeys(e=new P.R){const{emptyLow:t,emptyHigh:n,entryStride:s}=this,{table:r}=this;for(let o=0,a=r.length;o<a;o+=s){const l=r[o],c=r[o+1];(l!==t||c!==n)&&(e.low=l,e.high=c,yield e)}}indexOfPair(e,t){const{table:n,emptyLow:s,emptyHigh:r}=this;if(e===s&&t===r)return-1;for(let o=0,a=this.hashSeeds.length;o<a;++o){const l=this.getHash(o,e,t);if(n[l]===e&&n[l+1]===t)return l}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){const{emptyLow:e,emptyHigh:t,table:n,entryStride:s}=this;let r,o;for(;r=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(r===e&&o===t)&&!this.hasPair(r,o)););this.emptyLow=r,this.emptyHigh=o;for(let a=0,l=n.length;a<l;a+=s)n[a]===e&&n[a+1]===t&&(n[a]=r,n[a+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){const t=this.indexOf(e);if(t!==-1){const{table:n}=this;return n[t]=this.emptyLow,n[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){const{table:e,entryStride:t,emptyLow:n,emptyHigh:s}=this,r=e.length;for(let o=0;o<r;o+=t)e[o]=n,e[o+1]=s}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){const n=kn,s=Pn;this.storePending(e,t),e[t]=n,e[t+1]=s}storePending(e,t){kn=e[t],Pn=e[t+1]}backupPending(){fm=kn,gm=Pn}restorePending(){kn=fm,Pn=gm}tryToInsert(){bi&&console.log(`tryToInsert: ${kn}, ${Pn}`);let e=0;const{emptyLow:t,emptyHigh:n,maxAttempts:s,table:r}=this,o=this.hashSeeds.length;let a=Math.floor(Math.random()*o);for(;;){const l=this.getHash(a,kn,Pn);if(this.swapPending(r,l),kn===t&&Pn===n)return!0;if(++e===s)break;a=(a+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;const{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){bi&&console.log("rehash begin"),this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);const{emptyLow:n,emptyHigh:s,entryStride:r}=this;for(let o=0,a=e.length;o<a;o+=r){const l=e[o],c=e[o+1];if((l!==n||c!==s)&&(this.storePending(e,o),!this.tryToInsert()))return bi&&console.log("rehash failed"),!1}return bi&&console.log("rehash end"),!0}grow(e){bi&&console.log(`grow: ${e}`);const t=this.table;let{tableSize:n}=this;for(;n<e;)n*=2;for(;;){for(let s=0;s<this.maxRehashAttempts;++s)if(this.rehash(t,n)){bi&&console.log("grow end");return}n*=2}}insertInternal(){for(++this.generation,kn===this.emptyLow&&Pn===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class mm extends Or{add(e){const{low:t,high:n}=e;return this.hasPair(t,n)?!1:(bi&&console.log(`add: ${t},${n}`),kn=t,Pn=n,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}}mm.prototype.entryStride=2;let _r=0,Vr=0,vm=0,ym=0;class yd extends Or{set(e,t){const{low:n,high:s}=e;return this.hasPair(n,s)?!1:(bi&&console.log(`add: ${n},${s} -> ${t.low},${t.high}`),kn=n,Pn=s,_r=t.low,Vr=t.high,this.insertInternal(),!0)}get(e,t){const n=this.indexOf(e);if(n===-1)return!1;const{table:s}=this;return t.low=s[n+2],t.high=s[n+3],!0}swapPending(e,t){const n=_r,s=Vr;super.swapPending(e,t),e[t+2]=n,e[t+3]=s}storePending(e,t){super.storePending(e,t),_r=e[t+2],Vr=e[t+3]}backupPending(){super.backupPending(),vm=_r,ym=Vr}restorePending(){super.restorePending(),_r=vm,Vr=ym}[Symbol.iterator](){return this.unsafeEntries()}*entries(){const{emptyLow:e,emptyHigh:t,entryStride:n}=this,{table:s}=this;for(let r=0,o=s.length;r<o;r+=n){const a=s[r],l=s[r+1];if(a!==e||l!==t){const c=new P.R(a,l),d=new P.R(s[r+2],s[r+3]);yield[c,d]}}}*unsafeEntries(e=[new P.R,new P.R]){const{emptyLow:t,emptyHigh:n,entryStride:s}=this,{table:r}=this,[o,a]=e;for(let l=0,c=r.length;l<c;l+=s){const d=r[l],u=r[l+1];(d!==t||u!==n)&&(o.low=d,o.high=u,a.low=r[l+2],a.high=r[l+3],yield e)}}}yd.prototype.entryStride=4;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ns{}const zi=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],hD=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],ba=["","r","rg","rgb","rgba"],pD=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],fD=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],gD=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],mD=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],Sm=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],vD=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],yD=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function Ca(i){return i===R.FLOAT32?"":ae[i]?"i":"u"}function Wi(i,e,t=1){switch(e){case R.UINT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=pD[t],i.textureFormat=zi[t],i.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint8Array,i.samplerPrefix="u",i;case R.INT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=fD[t],i.textureFormat=zi[t],i.texelType=WebGL2RenderingContext.BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Int8Array,i.samplerPrefix="i",i;case R.UINT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=gD[t],i.textureFormat=zi[t],i.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint16Array,i.samplerPrefix="u",i;case R.INT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=mD[t],i.textureFormat=zi[t],i.texelType=WebGL2RenderingContext.SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Int16Array,i.samplerPrefix="i",i;case R.UINT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=Sm[t],i.textureFormat=zi[t],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case R.INT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=vD[t],i.textureFormat=zi[t],i.texelType=WebGL2RenderingContext.INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Int32Array,i.samplerPrefix="i",i;case R.UINT64:if(t<1||t>2)break;return i.texelsPerElement=1,i.textureInternalFormat=Sm[t*2],i.textureFormat=zi[t*2],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=2*t,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case R.FLOAT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=yD[t],i.textureFormat=hD[t],i.texelType=WebGL2RenderingContext.FLOAT,i.arrayElementsPerTexel=t,i.arrayConstructor=Float32Array,i.samplerPrefix="",i}throw new Error(`No supported texture format for ${R[e]}[${t}].`)}function wa(i,e,t){const{arrayConstructor:n,arrayElementsPerTexel:s,textureInternalFormat:r,textureFormat:o,texelsPerElement:a}=e,{maxTextureSize:l}=i,c=t.length/s;if(c*a>l*l)throw new Error("Number of elements exceeds maximum texture size: "+a+" * "+c);const d=Math.ceil(c/l),u=Math.ceil(Math.log2(d)),h=(1<<u)*a,p=Math.ceil(c/(1<<u)),m=h*p*s;t.constructor!==n&&(t=new n(t.buffer,t.byteOffset,t.byteLength/n.BYTES_PER_ELEMENT));const g=(0,F.jx)(t,m);i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),di(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,h,p,0,o,e.texelType,g)}function SD(i,e,t,n,s){const{arrayConstructor:r,textureInternalFormat:o,textureFormat:a,texelsPerElement:l}=e;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),di(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,n*l,s,0,a,e.texelType,t)}function bD(i,e,t,n,s,r){const{arrayConstructor:o,textureInternalFormat:a,textureFormat:l,texelsPerElement:c}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),mw(i),i.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,a,n*c,s,r,0,l,e.texelType,t)}function CD(i){switch(i){case R.UINT8:return Lp;case R.INT8:return Rp;case R.UINT16:return kp;case R.INT16:return Pp;case R.UINT32:return To;case R.INT32:return Ap;case R.UINT64:return gt;case R.FLOAT32:return cc}}function bm(i,e,t,n,s,r){const o=yt(s,r),a=[CD(s)];let l=`
${o} ${i}(${n} index) {
`;switch(s){case R.UINT8:case R.UINT16:case R.UINT32:l+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${ba[r]};
  return result;
`;break;case R.INT8:case R.INT16:case R.INT32:l+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${ba[r]};
  return result;
`;break;case R.UINT64:a.push(Dw),l+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${ba[r*2]});
`;break;case R.FLOAT32:a.push(cc),l+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${ba[r]};
`;break}return l+=`
}
`,a.push(l),a}class xa{constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let n=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let s=0;s<e;++s)n+=`, out ${t}vec4 output${s}`;n+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let s=0;s<e;++s)n+=`
  output${s} = texelFetch(sampler, ivec2(x + ${s}, y), 0);
`;return n+=`
}
`,[Pw,n]}getAccessor(e,t,n,s=1){const r=Ca(n);return[this.getReadTextureValueCode(1,r),...bm(e,this.readTextureValue,t,"highp uint",n,s)]}}class wD{constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){const{textureDims:n}=this;let s=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${n} p`;for(let r=0;r<e;++r)s+=`, out ${t}vec4 output${r}`;s+=`) {
`;for(let r=0;r<e;++r)s+=`
  output${r} = texelFetch(sampler, ivec${n}(p.x * ${e} + ${r}, p.y
                                         ${n===3?", p.z":""}), 0);
`;return s+=`
}
`,s}getAccessor(e,t,n,s=1){const r=Ca(n);return[this.getReadTextureValueCode(1,r),...bm(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,n,s)]}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Cm=[gt,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],xD=Wi(new Ns,R.UINT64,1);class Hi extends T.O8{constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){const{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;const{gl:n,texture:s}=this;this.generation=t,n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,s),e.tableWithMungedEmptyKey(r=>{wa(this.gl,xD,r)}),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){const{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new Hi(e,t))}}class wm{constructor(e,t=vd){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`),this.accessHelper=new xa(`gpuhashtable_${this.prefix}`),this.samplerName=this.prefix+"_sampler",this.hashSeedsName=this.prefix+"_seeds",this.hashKeyMask=this.prefix+"_keyMask",this.readTable=this.prefix+"_readTable"}defineShader(e){const{hashSeedsName:t,samplerName:n,numAlternatives:s,hashKeyMask:r}=this;e.addUniform("highp uint",t,s),e.addUniform("highp uint",r),e.addTextureSampler("usampler2D",n,this.textureUnitSymbol),e.addFragmentCode(Cm),e.addFragmentCode(gt),e.addFragmentCode(Tp),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,R.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let a=0;a<s;++a)o+=`
  {
    uint h = hashCombine(${t}[${a}], x) & ${r};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,n){n.copyToGPU();const s=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+s),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n.texture),e.uniform1ui(t.uniform(this.hashKeyMask),n.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),n.hashTable.hashSeeds)}disable(e,t){const n=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class xm extends wm{defineShader(e){super.defineShader(e);const{numAlternatives:t,hashSeedsName:n,hashKeyMask:s}=this;let r=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)r+=`
  {
    uint h = hashCombine(${n}[${o}], x) & ${s};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;r+=`
  return false;
}
`,e.addFragmentCode(r)}get getFunctionName(){return`${this.prefix}_get`}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Em=2;class ED{constructor(e){this.prefix=e,this.seedName=this.prefix+"_seed"}defineShader(e){const{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(gt),e.addFragmentCode(Cm),e.addFragmentCode(Tw);let n=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${Em} v;
`;for(let s=0;s<Em;++s)n+=`
  v[${s}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;n+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(n)}enable(e,t,n){e.uniform1ui(t.uniform(this.seedName),n)}}const Tm=new Float32Array(3);function Dm(i){return`rgb(${i[0]*100}%,${i[1]*100}%,${i[2]*100}%)`}class Sd{constructor(e=ut()){this.hashSeed=e,this.changed=new j.IY}static getDefault(){return new Sd(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let n=(0,Sa._)(this.hashSeed,t.low);n=(0,Sa._)(n,t.high);const s=(n&255)/255,r=(n>>8&255)/255;return Mo(e,s,.5+.5*r,1),e}computeCssColor(e){return this.compute(Tm,e),Dm(Tm)}randomize(){this.hashSeed=ut(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){const t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class TD{constructor(e){this.prefix=e,this.hashMapShaderManager=new xm("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);const t=`
bool ${this.getFunctionName}(uint64_t x, out vec4 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    value.a = float((uintValue & 0xff000000u) >> 24) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,n){this.hashMapShaderManager.enable(e,t,n)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let bd;function DD(){if(bd===void 0){const i=new Ae;i.set("keyl","recolor"),i.set("keyx","clear-segments"),i.set("keys","toggle-show-slices"),i.set("keyb","toggle-scale-bar"),i.set("keyv","toggle-default-annotations"),i.set("keya","toggle-axis-lines"),i.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)i.set("digit"+e,"toggle-layer-"+e),i.set("control+digit"+e,"select-layer-"+e),i.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){const t=String.fromCharCode(97+e),n=String.fromCharCode(65+e);i.set(`alt?+control?+shift+key${t}`,`tool-${n}`)}i.set("keyn","add-layer"),i.set("keyh","help"),i.set("space","toggle-layout"),i.set("shift+space","toggle-layout-alternative"),i.set("backslash","toggle-show-statistics"),i.set("alt+arrowup","select-previous"),i.set("alt+arrowdown","select-next"),bd=i}return bd}let Cd;function Br(){return Cd===void 0&&(Cd=Ae.fromObject({"control+mousedown2":"select-position"})),Cd}let wd;function Im(){return wd===void 0&&(wd=Ae.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[Br(),0]]})),wd}let xd;function Lm(){return xd===void 0&&(xd=Ae.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:shift+dblclick0":"star","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[Br(),0]]})),xd}let Ed;function ID(){return Ed===void 0&&(Ed=Ae.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[Lm(),Number.NEGATIVE_INFINITY]]})),Ed}let Td;function LD(){return Td===void 0&&(Td=Ae.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[Lm(),Number.NEGATIVE_INFINITY]]})),Td}function RD(i){i.global.addParent(DD(),Number.NEGATIVE_INFINITY),i.sliceView.addParent(LD(),Number.NEGATIVE_INFINITY),i.perspectiveView.addParent(ID(),Number.NEGATIVE_INFINITY)}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Os;const Fr=[];function kD(){if(Os===void 0){const i=Os=document.createElement("div");i.classList.add("neuroglancer-drag-status"),document.body.appendChild(i)}return Os}function PD(){Os!==void 0&&(Me(Os),Os.style.display="none")}function Rm(i){const e=kD();Me(e),typeof i=="string"?e.appendChild(document.createTextNode(i)):e.appendChild(i()),e.style.display=""}function km(i,e){(0,F.U8)(Fr,t=>!(t.target===i&&t.operation===e))}function Cn(i,e,t){km(i,e),Fr.push({target:i,operation:e,status:t}),Rm(t)}function kt(i,e){km(i,e);const t=Fr.length===0?void 0:Fr[Fr.length-1];t===void 0?PD():Rm(t.status)}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _s="neuroglancer-drag-over",Pm={row:"row",column:"col"},AD={left:"right",right:"left",top:"bottom",bottom:"top"},Ci={left:"column",right:"column",top:"row",bottom:"row"},Ea={left:"row",right:"row",top:"column",bottom:"column"},Ji={row:"width",column:"height"},Am={row:"left",column:"top"},MD={row:"right",column:"bottom"},Mm={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},Ta={left:-1,right:1,top:-1,bottom:1};class ji extends T.O8{constructor(e,t=new Si){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new vt(vt.VISIBLE);const{element:n}=this;n.classList.add("neuroglancer-side-panel"),n.draggable=!0,n.addEventListener("dragstart",s=>{this.sidePanelManager.startDrag(this.makeDragSource(),s),n.style.backgroundColor="black",setTimeout(()=>{n.style.backgroundColor=""},0),Cn(n,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),n.addEventListener("dragend",s=>{this.sidePanelManager.endDrag(),kt(n,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{const t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){const t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");const{title:n}=e;let s;n!==void 0&&(s=document.createElement("div"),s.classList.add("neuroglancer-side-panel-title"),s.textContent=n,t.appendChild(s));const r=No({title:"Close panel",onClick:()=>{this.close()}});return r.style.order="100",t.appendChild(r),this.element.appendChild(t),{titleBar:t,titleElement:s,closeButton:r}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}}class ND extends T.O8{constructor(e,t,n=new vt(vt.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=n,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new j.HN,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new Set,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};const{element:s,centerColumn:r}=this;s.style.display="flex",s.style.flex="1",s.style.flexDirection="row",r.style.display="flex",r.style.flex="1",r.style.flexDirection="column",r.style.flexBasis="0px",r.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,Ta[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,n,s,r=!1){const o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";const a=10,l=Ci[s],c=Ea[s];return o.style[Ji[c]]=`${a}px`,o.style[Ji[l]]="100%",r?(o.style.position="absolute",o.style[s]="50%",o.style[Mm[s]]="-${size/2}px"):(o.style.position="relative",o.style[Mm[AD[s]]]=`-${a}px`),o.addEventListener("dragenter",d=>{this.hasDroppablePanel()&&(o.classList.add(_s),d.preventDefault(),Cn(o,"drop",()=>document.createTextNode(`Drop side panel as new ${l}`)))}),o.addEventListener("dragleave",()=>{kt(o,"drop"),o.classList.remove(_s)}),o.addEventListener("dragover",d=>{this.hasDroppablePanel()&&d.preventDefault()}),o.addEventListener("drop",d=>{const{dragSource:u}=this;if(u===void 0)return;kt(o,"drop"),o.classList.remove(_s);const h=Ci[e];u.dropAsNewPanel({side:e,row:h==="column"?n:t,col:h==="row"?n:t}),this.dragSource=void 0,d.preventDefault(),d.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),e.panel?.dispose(),this.invalidateLayout()}disposed(){for(const{panel:e}of this.registeredPanels)e?.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;const e={left:[],right:[],top:[],bottom:[]};for(const o of this.registeredPanels)e[o.location.value.side].push(o);const t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),n=this;function*s(){yield n.sides.left.outerDropZoneElement,yield*t("left"),yield n.centerColumn,yield*t("right"),yield n.sides.right.outerDropZoneElement}nn(this.element,s());function*r(){yield n.sides.top.outerDropZoneElement,yield*t("top"),yield n.center,yield*t("bottom"),yield n.sides.bottom.outerDropZoneElement}nn(this.centerColumn,r())}makeCrossGutter(e,t){const n=document.createElement("div");n.style.position="relative";const s=Ea[e];n.className=`neuroglancer-resize-gutter-${s==="row"?"horizontal":"vertical"}`,n.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();const a=this.sides[e].flexGroups[t];if(a===void 0||!a.visible)return;let c=a.element.getBoundingClientRect()[Ji[s]];const d=a.minSize,u=()=>{Cn(n,"drag",`Drag to resize, current ${Ji[s]} is ${a.crossSize}px`)};u(),zt(o,(h,p,m)=>{const g=s==="row"?p:m;c-=Ta[e]*g,a.crossSize=Math.max(d,Math.round(c)),u(),this.invalidateLayout()},()=>{kt(n,"drag")})});const r=this.makeDropZone(e,t-Ta[e]*.5,0,e,!0);return n.appendChild(r),n}makeFlexGutter(e,t,n){const s=document.createElement("div");s.style.position="relative";const r=Ci[e];s.className=`neuroglancer-resize-gutter-${r==="row"?"horizontal":"vertical"}`,s.addEventListener("pointerdown",a=>{if("button"in a&&a.button!==0)return;a.preventDefault();const l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;const{cells:c}=l,d=c[n];if(d===void 0||!d.registeredPanel.location.visible)return;let u=n+1;for(;u<c.length&&!c[u].registeredPanel.location.visible;)++u;if(u===c.length)return;const h=c[u],p=()=>{Cn(s,"drag",`Drag to resize, current ${Ji[r]} ratio is ${d.registeredPanel.location.value.flex} : ${h.registeredPanel.location.value.flex}`)};p(),zt(a,m=>{const g=d.registeredPanel.panel,v=h.registeredPanel.panel;if(g===void 0||v===void 0)return;const y=g.element.getBoundingClientRect(),S=v.element.getBoundingClientRect(),w=Math.max(.1,Math.min(.9,r==="column"?(m.clientY-y.top)/(S.bottom-y.top):(m.clientX-y.left)/(S.right-y.left))),b=d.registeredPanel.location.value,x=h.registeredPanel.location.value,E=b.flex+x.flex;d.registeredPanel.location.value={...b,flex:Math.round(w*E*100)/100},h.registeredPanel.location.value={...x,flex:Math.round((1-w)*E*100)/100},p(),d.registeredPanel.location.locationChanged.dispatch(),h.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{kt(s,"drag")})});const o=this.makeDropZone(e,t,n+.5,Am[Ci[e]],!0);return s.appendChild(o),s}renderSide(e,t,n){const s=Pm[Ea[e]],r=Pm[Ci[e]];n.sort((l,c)=>{const d=l.location.value,u=c.location.value,h=d[r]-u[r];return h!==0?h:d[s]-u[s]});const o=this;function*a(){let l=0;const c=n.length;let d=0;for(;l<c;){const u=n[l].location.value[r];let h=l,p=0,m=0;do{const S=n[h].location.value;if(S[r]!==u)break;S.visible&&(++p,m=Math.max(m,S.minSize)),++h}while(h<c);const g=p>0;let v=t[d];if(v===void 0){const S=o.makeCrossGutter(e,d),w=document.createElement("div");w.className=`neuroglancer-side-panel-${Ci[e]}`,v=t[d]={element:w,gutterElement:S,cells:[],crossSize:-1,minSize:m,visible:g,beginDropZone:o.makeDropZone(e,d,-1/0,Am[Ci[e]]),endDropZone:o.makeDropZone(e,d,1/0,MD[Ci[e]])}}else v.visible=g,v.minSize=m,v.crossSize=Math.max(v.crossSize,m);function*y(){yield v.beginDropZone;let S=0;for(let w=l,b=0;w<h;++w,++b){const x=n[w];let E=v.cells[b];E===void 0?E=v.cells[b]={registeredPanel:x,gutterElement:void 0}:E.registeredPanel=x;const D=E.registeredPanel.location.value;v.crossSize===-1&&(v.crossSize=Math.max(m,D.size)),(D[r]!==d||D[s]!==b||D.visible&&D.size!==v.crossSize)&&(E.registeredPanel.location.value={...D,[r]:d,[s]:b,size:D.visible?v.crossSize:D.size},E.registeredPanel.location.changed.dispatch());const I=D.visible&&o.visibility.visible;let{panel:L}=x;if(!I){L!==void 0&&(L.dispose(),x.panel=void 0);continue}++S,L===void 0&&(L=x.panel=x.makePanel()),L.element.style.flex=p>1?`${D.flex}`:"1",yield L.element,S===p?E.gutterElement=void 0:(E.gutterElement===void 0&&(E.gutterElement=o.makeFlexGutter(e,d,b)),yield E.gutterElement)}yield v.endDropZone}nn(v.element,y()),v.cells.length=h-l,g&&(v.element.style[Ji[Ea[e]]]=`${v.crossSize}px`,Ta[e]>0?(yield v.gutterElement,yield v.element):(yield v.element,yield v.gutterElement)),l=h,++d}t.length=d}return a()}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Nm(i={}){return Ne({text:"\u2197",...i})}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Om(i){return i.closest(".neuroglancer-selection-details")}class OD extends ji{constructor(e,t,n,s){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=n,this.selectedLayer=s,this.body=document.createElement("div");const{element:r,body:o}=this;r.classList.add("neuroglancer-selection-details"),this.registerDisposer(new tn(this.element,Br()));const{titleBar:a}=this.addTitleBar({title:"Selection"}),l=Ne({svg:uf,title:"Previous selection",onClick:()=>{this.state.goBack()}}),c=Ne({svg:hf,title:"Next selection",onClick:()=>{this.state.goForward()}});a.appendChild(l),a.appendChild(c),a.appendChild(this.registerDisposer(new rn(t.pin,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Wt(t,(d,u,h)=>{if(!t.location.visible||(l.style.visibility=t.canGoBack()?"visible":"hidden",c.style.visibility=t.canGoForward()?"visible":"hidden",d===void 0))return;const{position:p}=d;if(p!==void 0){const m=document.createElement("div");m.classList.add("neuroglancer-selection-details-position");const g=Hn({title:"Copy position",onClick:()=>{mi(S.map(b=>Math.floor(b)).join(", "))}});m.appendChild(g);const{coordinateSpace:{rank:v,names:y},position:S}=d;for(let b=0;b<v;++b){const x=document.createElement("span");x.classList.add("neuroglancer-selection-details-position-dimension");const E=document.createElement("span");E.classList.add("neuroglancer-selection-details-position-dimension-name"),E.textContent=y[b];const D=document.createElement("span");D.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),D.textContent=Math.floor(S[b]).toString(),x.appendChild(E),x.appendChild(D),m.appendChild(x)}const w=Nm({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=S}});m.appendChild(w),u.appendChild(m)}for(const m of d.layers){const{layer:g}=m;u.appendChild(h.registerDisposer(new Wt({value:void 0,changed:g.managedLayer.layerChanged},(v,y,S)=>{if(g.wasDisposed||!g.isReady)return;const w=document.createElement("div");if(w.classList.add("neuroglancer-selection-details-layer-body"),!g.displaySelectionState(m.state,w,S))return;const b=document.createElement("div");y.appendChild(b),b.classList.add("neuroglancer-selection-details-layer");const x=document.createElement("div");x.classList.add("neuroglancer-selection-details-layer-title"),x.textContent=g.managedLayer.name,x.addEventListener("click",()=>{this.selectedLayer.layer=g.managedLayer,this.selectedLayer.visible=!0}),x.title="Click to show layer side panel",b.appendChild(x),b.appendChild(w)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}var _m=G(9564);/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Vm(i={}){const e=Ne({svg:_m,...i});return e.classList.add("neuroglancer-eye-icon"),e}var _D=G(7237);/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function VD(i={}){return Ne({svg:_D,...i})}var BD=G(9187);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Bm(i={}){const e=Ne({svg:BD,...i});return e.classList.add("neuroglancer-star-icon"),e}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wi{constructor(e,t,n){this.key=e,this.value=t,this.label=n}toString(){const{key:e,value:t,label:n}=this;let s;return t===void 0?s=`${e}`:s=`${e}\u2192${t}`,n===void 0?s:`${s} ${n}`}}class FD extends T.O8{constructor(){super(...arguments),this.selectedSegment=new P.R,this.baseSelectedSegment=new P.R,this.hasSelectedSegment=!1,this.changed=new j.IY}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){const{selectedSegment:n,baseSelectedSegment:s}=this;let r=0,o=0,a=0,l=0,c;if(e==null)c=!1;else if(typeof e=="number")r=a=e>>>0,o=l=e<0?4294967295:0,c=!0;else if(e instanceof wi){const d=e.value||e.key;r=d.low,o=d.high,a=e.key.low,l=e.key.high,c=!0}else e instanceof P.R?(r=a=e.low,o=l=e.high,c=!0):c=!1;t&&r===0&&o===0&&(c=!1),c?c&&(!this.hasSelectedSegment||n.low!==r||n.high!==o||s.low!==a||s.high!==l)&&(n.low=r,n.high=o,s.low=a,s.high=l,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&P.R.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{const n=e.get(t);let s;n!==void 0&&(s=n.value),this.set(s,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function Ur(i){i.useTemporarySegmentEquivalences.value=!1,i.useTemporaryVisibleSegments.value=!1,i.temporaryVisibleSegments.clear(),i.temporarySegmentEquivalences.clear()}function Fm(i,e,t=!1){let n,s,r;if(typeof e=="number"?n=new P.R(e>>>0,e<0?4294967295:0):typeof e=="string"?n=P.R.parseString(e):n=t?e.clone():e,i==null)return n;const{segmentEquivalences:o,segmentPropertyMap:{value:a}}=i.segmentationGroupState.value;o.size!==0?(s=o.get(n),P.R.equal(s,n)?r=void 0:r=s):s=n;const l=a?.getSegmentLabel(s);return l===void 0&&r===void 0?n:new wi(n,r,l)}function Yi(i,e){if(e instanceof wi)return e;const t=Fm(i,e);return t instanceof P.R?new wi(t):t}function Um(i,e){const{length:t}=e;i.value<t&&(i.value=t)}function $r(i,e){return(0,_.W1)(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),i.segmentationGroupState.value.maxIdLength)}const Dd=(()=>{const i=document.createElement("div");i.classList.add("neuroglancer-segment-list-entry");const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),i.appendChild(e);const t=Hn({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");const n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry-copy-container");const s=n.childElementCount;n.appendChild(t);const r=e.childElementCount;e.appendChild(n);const o=e.childElementCount,a=Vm({title:"Toggle segment visibility"});a.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(a);const l=document.createElement("div");l.classList.add("neuroglancer-segment-list-entry-id-container");const c=e.childElementCount;e.appendChild(l);const d=document.createElement("div");d.classList.add("neuroglancer-segment-list-entry-id");const u=l.childElementCount;l.appendChild(d);const h=Bm({title:"Star segment"});h.classList.add("neuroglancer-segment-list-entry-star");const p=e.childElementCount;e.appendChild(h);const m=document.createElement("span");m.classList.add("neuroglancer-segment-list-entry-name");const g=i.childElementCount;i.appendChild(m);const v=VD({title:"Filter by label"});v.classList.add("neuroglancer-segment-list-entry-filter");const y=i.childElementCount;i.appendChild(v);const S=i.childElementCount;return i.appendChild(hi.template()),{template:i,copyContainerIndex:r,copyIndex:s,visibleIndex:o,idContainerIndex:c,idIndex:u,labelIndex:g,filterIndex:y,starIndex:p,colorWidgetIndex:S,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),UD=(()=>{const i=Dd,e=i.template.cloneNode(!0),t=e.children[0],n=t.children[i.idContainerIndex],s=n.childElementCount,r=n.children[i.idIndex].cloneNode(!0);r.classList.add("neuroglancer-segment-list-entry-unmapped-id"),n.appendChild(r);const o=t.children[i.copyContainerIndex],a=o.childElementCount;return o.appendChild(o.children[i.copyIndex].cloneNode(!0)),{...i,template:e,unmappedIdIndex:s,unmappedCopyIndex:a}})();function $D(i){const e=Dd,t=e.template.cloneNode(!0),n=[];for(let s=0;s<i;++s){n.push(t.childElementCount);const r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-extra-property"),r.style.width=`max(var(--neuroglancer-column-${s}-width), var(--neuroglancer-column-${s}-label-width))`,t.appendChild(r)}return{...e,template:t,numericalPropertyIndices:n}}const $m=new WeakMap;function GD(i){const e=d=>{const u=d.currentTarget,h=u.dataset.id,p=An;p.tryParseString(h),i.segmentSelectionState.set(p),Om(u)||i.selectSegment(p,!1)},t=d=>{const u=d.currentTarget,h=u.dataset.id,p=An;p.tryParseString(h),i.selectSegment(p,Om(u)?"toggle":!0)},n=()=>{i.segmentSelectionState.set(null)},s=d=>d.currentTarget.closest(".neuroglancer-segment-list-entry"),r=d=>{const u=s(d);mi(u.dataset.id),d.stopPropagation()},o=d=>{const u=s(d);mi(u.dataset.unmappedId),d.stopPropagation()},a=d=>{const h=s(d).dataset.id,p=An;p.tryParseString(h);const{selectedSegments:m,visibleSegments:g}=i.segmentationGroupState.value,v=!g.has(p);v&&m.add(p),g.set(p,v),d.stopPropagation(),d.preventDefault()},l=d=>{const h=s(d).dataset.id,p=An;p.tryParseString(h),i.filterBySegmentLabel(p),d.stopPropagation()},c=d=>{if(d.button!==2||d.ctrlKey||d.altKey||d.metaKey||d.shiftKey)return;const h=d.currentTarget.dataset.id,p=An;p.tryParseString(h),i.moveToSegment(p)};return(d,u)=>{const{children:h}=d,p=h[0].children;d.addEventListener("mousedown",c);const m=p[u.copyContainerIndex];u.unmappedCopyIndex!==-1&&m.children[u.unmappedCopyIndex].addEventListener("click",o),m.children[u.copyIndex].addEventListener("click",r),d.addEventListener("mouseenter",e),d.addEventListener("mouseleave",n),p[u.visibleIndex].addEventListener("click",a),h[u.filterIndex].addEventListener("click",l),d.addEventListener("action:select-position",t),p[u.starIndex].addEventListener("click",y=>{const w=s(y).dataset.id,b=An;b.tryParseString(w);const{selectedSegments:x}=i.segmentationGroupState.value;x.set(b,!x.has(b))});const v=new q(C.eR.fromValues(0,0,0));v.changed.add(()=>{const y=new P.R(Ie(v.value)),S=d.dataset.id,w=An;w.tryParseString(S),i.segmentStatedColors.value.delete(w),i.segmentStatedColors.value.set(w,y)}),new hi(v,void 0,h[u.colorWidgetIndex],()=>{const y=d.dataset.id,S=An;S.tryParseString(y),i.segmentStatedColors.value.delete(S)},!1)}}class Vs{constructor(e,t){if(this.displayState=e,this.template=t,e!==void 0){let n=$m.get(e);n===void 0&&(n=GD(e),$m.set(e,n)),this.registerEventHandlers=n}}static make(e,t){return new Vs(e,t?UD:Dd)}get(e){const{displayState:t}=this;return this.getWithNormalizedId(Yi(t,e))}getWithNormalizedId(e){const{displayState:t}=this,{template:n}=this,s=n.template.cloneNode(!0),r=e.key,o=e.value??r,a=o.toString();s.dataset.id=a;const{children:l}=s,c=l[0].children,d=c[n.idContainerIndex];d.children[n.idIndex].textContent=a;const{unmappedIdIndex:u}=n;if(t!==void 0?this.registerEventHandlers(s,n):c[n.visibleIndex].style.display="none",u!==-1){const h=d.children[u];if(P.R.equal(r,o)){h.style.display="none";const p=c[n.copyContainerIndex];p.children[n.unmappedCopyIndex].style.display="none"}else{const p=r.toString();s.dataset.unmappedId=p,h.textContent=p,t!==void 0&&Um(t.segmentationGroupState.value.maxIdLength,p)}}return l[n.labelIndex].textContent=e.label??"",t!==void 0&&(this.updateWithId(s,o),Um(t.segmentationGroupState.value.maxIdLength,a)),s}update(e){const t=An,n=e.dataset.id;n!==void 0&&(t.parseString(n),this.updateWithId(e,t))}updateWithId(e,t){const{children:n}=e,s=n[0].children,{template:r}=this,{displayState:o}=this,{segmentSelectionState:a}=o,{visibleSegments:l}=o.segmentationGroupState.value;s[r.visibleIndex].classList.toggle("neuroglancer-visible",l.has(t)),e.dataset.selected=(a.hasSelectedSegment&&P.R.equal(a.selectedSegment,t)).toString();const{selectedSegments:c}=o.segmentationGroupState.value;s[r.starIndex].classList.toggle("neuroglancer-starred",c.has(t));const d=s[r.idContainerIndex];let u=Rd(this.displayState,t);Gm(d.children[r.idIndex],u);const h=!!this.displayState?.segmentStatedColors.value.has(t);zm(n[r.colorWidgetIndex],u,h);const{unmappedIdIndex:p}=r;if(p!==-1){let m;if(o.baseSegmentColoring.value&&(m=e.dataset.unmappedId)!==void 0){const v=An;v.parseString(m),u=Rd(this.displayState,v)}else u=C.Oi;Gm(d.children[p],u);const g=!!this.displayState?.segmentStatedColors.value.has(t);zm(n[r.colorWidgetIndex],u,g)}}}function Gm(i,e){i.style.backgroundColor=Dm(e),i.style.color=Be(e)?"white":"black"}function zm(i,e,t){i.value=Ge(e.subarray(0,3)),i.classList.toggle("overridden",t)}class Wm extends Vs{constructor(e,t,n){const s=e.segmentationGroupState.value.segmentPropertyMap.value,r=(s?.numericalProperties??[]).filter(n),o=$D(r.length);super(e,o),this.parentElement=t,this.segmentPropertyMap=s,this.numericalProperties=r,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){const t=super.getWithNormalizedId(e),{numericalProperties:n}=this,{numericalPropertyIndices:s}=this.template;if(s.length>0){const r=this.segmentPropertyMap?.getSegmentInlineIndex(e.value??e.key)??-1;if(r!==-1){const{numericalPropertyWidths:o}=this;for(let a=0,l=s.length;a<l;++a){const c=n[a].values[r];if(!Number.isNaN(c)){const d=c.toString(),u=d.length;u>o[a]&&(o[a]=u,this.parentElement.style.setProperty(`--neuroglancer-column-${a}-width`,`${u}ch`)),t.children[s[a]].textContent=d}}}}return t}makeHeaderLabel(e,t,n){const s=document.createElement("span");s.textContent=e,s.classList.add("neuroglancer-segment-list-header-label"),s.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(n.style.textAlign="left");const r=document.createElement("span");r.classList.add("neuroglancer-segment-list-header-label-sort"),s.appendChild(r),r.textContent="\u25B2";const o=dx(s).width;return this.parentElement.style.setProperty(t,`${o}px`),n.appendChild(s),{id:e,label:s,sortIcon:r}}getHeader(){const{template:e}=this,t=e.template.cloneNode(!0),{children:n}=t,s=n[0].children,r=s[e.copyContainerIndex];r.style.visibility="hidden",s[e.visibleIndex].style.visibility="hidden",n[e.filterIndex].style.visibility="hidden";const o=s[e.idContainerIndex],a=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",n[e.labelIndex])],{numericalProperties:l}=this,{numericalPropertyIndices:c}=this.template;for(let d=0,u=c.length;d<u;++d){const h=l[d],p=this.makeHeaderLabel(h.id,`--neuroglancer-column-${d}-label-width`,t.children[c[d]]),{description:m}=h;m&&(p.label.title=m),a.push(p)}return{container:t,propertyLabels:a}}}function Id(i,e){return Vs.make(i??void 0,!0).getWithNormalizedId(e)}function Bs(i,e,t){e.registerDisposer((0,_.aM)((n,s)=>{iT(n,s,t)},i.segmentationGroupState)),e.registerDisposer((0,_.aM)((n,s)=>{n.registerDisposer(s.segmentColorHash.changed.add(t)),n.registerDisposer(s.segmentDefaultColor.changed.add(t))},i.segmentationColorGroupState)),e.registerDisposer(i.saturation.changed.add(t)),e.registerDisposer(i.segmentSelectionState.changed.add(t)),e.registerDisposer(i.baseSegmentColoring.changed.add(t)),e.registerDisposer(i.hoverHighlight.changed.add(t)),e.registerDisposer(i.segmentStatedColors.changed.add(t))}function Hm(i,e){const t=e.redrawNeeded.dispatch;Bs(i,e,t),e.registerDisposer((0,_.aM)((n,s)=>{sT(n,s,t)},i.segmentationGroupState))}function zD(i,e){Hm(i,e),e.registerDisposer(i.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function Ld(i,e){zD(i,e),e.registerDisposer(i.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}const Jm=C.ln.create(),An=new P.R,Da=new P.R;function Rd(i,e,t=Jm){if(i==null)return t.fill(1),t;const n=i.segmentationColorGroupState.value,{segmentStatedColors:s}=n;if(s.size!==0&&n.segmentStatedColors.get(e,Da))return t[0]=(Da.low&255)/255,t[1]=((Da.low&65280)>>>8)/255,t[2]=((Da.low&16711680)>>>16)/255,t;const r=n.segmentDefaultColor.value;return r!==void 0?(t[0]=r[0],t[1]=r[1],t[2]=r[2],t):(n.segmentColorHash.compute(t,e),t)}function WD(i,e,t=1){const n=Jm;n[3]=t,Rd(i,e,n);let s=i.saturation.value;i.hoverHighlight.value&&i.segmentSelectionState.isSelected(e)&&(s>.5?s=s-=.5:s+=.5);for(let r=0;r<3;++r)n[r]=n[r]*s+(1-s);return n[0]*=t,n[1]*=t,n[2]*=t,n}function jm(i,e={}){for(const t of cg)e[t]=i[t].rpcId;return e}const HD=ar(Dr);class Ia extends HD{constructor(e,t,n){super(n),this.chunkManager=e,this.displayState=t;const s=t.segmentationGroupState.value;for(const r of cg)this.registerDisposer(s[r].addRef())}initializeCounterpartWithChunkManager(e){const{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,jm(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(ft.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(ft.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function kd(i,e,t,n,s){const r=Math.min(1,i.objectAlpha.value),o=i.baseSegmentColoring.value;Rs(i.segmentationGroupState.value,(a,l)=>{const c=n?.registerUint64(e,a),d=t?WD(i,o?a:l,r):void 0;s(a,d,c,l)})}var JD=Object.defineProperty,jD=Object.getOwnPropertyDescriptor,Ym=(i,e,t,n)=>{for(var s=n>1?void 0:n?jD(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&JD(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const YD=C.pB.create(),an=C.w0.create(),Qm=!1;function Km(i,e){e.vertexBuffer=At.fromData(i,e.meshData.vertexPositions,i.ARRAY_BUFFER,i.STATIC_DRAW),e.indexBuffer=At.fromData(i,e.meshData.indices,i.ELEMENT_ARRAY_BUFFER,i.STATIC_DRAW),e.normalBuffer=At.fromData(i,e.meshData.vertexNormals,i.ARRAY_BUFFER,i.STATIC_DRAW)}function qm(i){i.vertexBuffer.dispose(),i.indexBuffer.dispose(),i.normalBuffer.dispose()}const QD=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function Xm(i){return i>=128&&(i=i-256),Math.max(-1,i/127)}function qV(i){let e=i.length;e-=1;const t=new Float32Array(Math.floor(i.length/2)*3);let n=0;for(let s=0;s<e;s+=2){const r=Xm(i[s]),o=Xm(i[s+1]);let a=r,l=o;const c=1-Math.abs(r)-Math.abs(o);c<0&&(a=(1-Math.abs(l))*(a>0?1:-1),l=(1-Math.abs(a))*(l>0?1:-1));const d=Math.sqrt(a**2+l**2+c**2);t[n]=a/d,t[n+1]=l/d,t[n+2]=c/d,n+=3}return t}function Zm(i){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,n){n.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,i,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}const KD={[bn.Pc.float32]:Zm(WebGL2RenderingContext.FLOAT),[bn.Pc.uint16]:Zm(WebGL2RenderingContext.UNSIGNED_SHORT),[bn.Pc.uint10]:{defineShader:i=>{i.addAttribute("highp uint","aVertexPosition"),i.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(i,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(i,e)=>{i.disableVertexAttribArray(e.attribute("aVertexPosition"))}}};class ev{constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=KD[this.vertexPositionFormat]}beginLayer(e,t,n,s){const{lightDirection:r,ambientLighting:o,directionalLighting:a}=n,l=this.tempLightVec;C.eR.scale(l,r,a),l[3]=o,e.uniform4fv(t.uniform("uLightDirection"),l);const c=s.silhouetteRendering.value;c>0&&e.uniform1f(t.uniform("uSilhouettePower"),c)}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginModel(e,t,n,s){const{projectionParameters:r}=n;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,C.pB.multiply(YD,r.viewProjectionMat,s)),(0,C._A)(an,s),(0,C.Jh)(an,an,r.displayDimensionRenderInfo.canonicalVoxelFactors),C.w0.invert(an,an),C.w0.transpose(an,an),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,an)}drawFragmentHelper(e,t,n,s,r){this.vertexPositionHandler.bind(e,t,n);const{meshData:o}=n;n.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),n.indexBuffer.bind();const{indices:a}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,r-s,a.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,s*a.BYTES_PER_ELEMENT)}drawFragment(e,t,n){const{meshData:s}=n,{indices:r}=s;this.drawFragmentHelper(e,t,n,0,r.length)}drawMultiscaleFragment(e,t,n,s,r){const o=n.meshData.subChunkOffsets[s],a=n.meshData.subChunkOffsets[r];this.drawFragmentHelper(e,t,n,o,a)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){const t=e.registerDisposer((0,_.Uq)(n=>n>0,[e.displayState.silhouetteRendering]));return Ai(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(n,s)=>{this.vertexPositionHandler.defineShader(n),n.addAttribute("highp vec2","aVertexNormal"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec4","uLightDirection"),n.addUniform("highp vec4","uColor"),n.addUniform("highp mat3","uNormalMatrix"),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp uint","uPickID"),s&&n.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(n.addUniform("highp vec3","uFragmentOrigin"),n.addUniform("highp vec3","uFragmentShape")),n.addVertexCode(QD);let r="";this.fragmentRelativeVertices?r+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:r+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,r+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,s&&(r+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),n.setVertexMain(r),n.setFragmentMain("emit(vColor, uPickID);")}})}}class La extends Gi{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new ev(!1,bn.Pc.float32),this.getShader=this.meshShaderManager.makeGetter(this),Ld(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));const s=this.backend=this.registerDisposer(new Ia(e,n,this.layerChunkProgressInfo));s.RPC_TYPE_ID=bn.Of,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),s.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const{gl:n,displayState:s,meshShaderManager:r}=this;if(s.objectAlpha.value<=0)return;const o=lr(s.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;const{shader:a}=this.getShader(e.emitter);if(a===null)return;a.bind(),r.beginLayer(n,a,e,this.displayState),r.beginModel(n,a,e,o);const l=this.source.chunks;let c=0,d=0;const{renderScaleHistogram:u}=this.displayState,h=this.source.fragmentSource.chunks;kd(s,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(p,m,g)=>{const v=Sn(p),y=l.get(v);if(++c,y!==void 0){++d,e.emitColor&&r.setColor(n,a,m),e.emitPickID&&r.setPickID(n,a,g),c+=y.fragmentIds.length;for(const S of y.fragmentIds){const{key:w}=this.source.getFragmentKey(v,S),b=h.get(w);b!==void 0&&b.state===Ue.GPU_MEMORY&&(r.drawFragment(n,a,b),++d)}}}),e.emitColor&&(u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),u.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,d,c-d)),r.endLayer(n,a)}isReady(){const{displayState:e,source:t}=this;let n=!0;const s=t.fragmentSource.chunks;return Rs(e.segmentationGroupState.value,r=>{const o=Sn(r),a=t.chunks.get(o);if(a===void 0){n=!1;return}for(const l of a.fragmentIds){const{key:c}=this.source.getFragmentKey(o,l),d=s.get(c);if(d===void 0||d.state!==Ue.GPU_MEMORY){n=!1;return}}}),n}getObjectPosition(e,t){const n=this.displayState.transform.value;if(n.error!==void 0)return;const s=Sn(e),r=this.source.chunks.get(s);if(r===void 0)return;const{rank:o}=n,a=new Float32Array(n.modelToRenderLayerTransform.length);De.DI(a,o+1,n.modelToRenderLayerTransform,o+1,o+1);const l=new Float32Array(o);De.vo(l,a,o+1,t,o);const{fragmentIds:c}=r;let d=0;const u=[];for(const S of c){const{key:w}=this.source.getFragmentKey(s,S),b=this.source.fragmentSource.chunks.get(w);if(b===void 0)continue;const{state:x,meshData:E}=b;x!==Ue.SYSTEM_MEMORY&&x!==Ue.GPU_MEMORY||(d+=E.vertexPositions.length/o,u.push(b))}const p=100*1e3/d,m=Math.max(1,Math.floor(1/p)),g=new Float32Array(o);let v=Number.POSITIVE_INFINITY;for(const S of u){const{meshData:w}=S,{vertexPositions:b}=w;if(!(b.length<o))for(let x=0;x<b.length;x+=o*m){let E=0;for(let D=0;D<o;D++)E+=(b[x+D]-l[D])**2;if(E<v){v=E;for(let D=0;D<o;D++)g[D]=b[x+D]}}}if(v===Number.POSITIVE_INFINITY)return;const y=new Float32Array(o);return De.vo(y,n.modelToRenderLayerTransform,o+1,g,o),y}}class qD extends Jn{constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class XD extends Jn{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),Km(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),qm(this)}}class Qi extends on{constructor(){super(...arguments),this.fragmentSource=this.registerDisposer(new Pd(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new qD(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}let Pd=class extends on{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new XD(this,i)}};Pd=Ym([Zt(bn.dI)],Pd);function tv(i,e,t,n){const s=i.get(pm(e,t,n));return s!==void 0&&s.state===Ue.GPU_MEMORY}class Ad extends Gi{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new ev(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),Ld(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));const s=this.backend=this.registerDisposer(new Ia(e,n,this.layerChunkProgressInfo));s.RPC_TYPE_ID=bn.Yo,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),s.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const{gl:n,displayState:s,meshShaderManager:r}=this;if(s.objectAlpha.value<=0)return;const o=lr(s.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;const{shader:a}=this.getShader(e.emitter);if(a===null)return;a.bind(),r.beginLayer(n,a,e,this.displayState);const{renderScaleHistogram:l}=this.displayState;e.emitColor&&l.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),(0,C._A)(an,o),(0,C.Jh)(an,an,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);const c=Math.abs(C.w0.determinant(an))**(1/3),{chunks:d}=this.source,u=this.source.fragmentSource.chunks,{projectionParameters:h}=e,p=C.pB.multiply(C.pB.create(),h.viewProjectionMat,o),m=(0,C._S)(new Float32Array(24),p),g=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:v}=this.source.format;r.beginModel(n,a,e,o);let y=0,S=0;kd(s,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(w,b,x)=>{const E=Sn(w),D=d.get(E);if(++y,D===void 0)return;++S;const{manifest:I}=D,{octree:L,chunkShape:N,chunkGridSpatialOrigin:k,vertexOffsets:O}=I;if(Qm)try{dD(L)}catch(V){console.log(`invalid octree for object=${w}: ${V.message}`)}e.emitColor&&r.setColor(n,a,b),e.emitPickID&&r.setPickID(n,a,x),hm(I,p,m,g,h.width,h.height,(V,z,Y)=>{const Q=tv(u,E,V,z);return e.emitColor&&l.add(I.lodScales[V]*c,Y,Q?1:0,Q?0:1),Q},(V,z,Y,Q)=>{const X=pm(E,V,z),ce=u.get(X),oe=L[5*z],Se=L[5*z+1],Ke=L[5*z+2],$e=1<<V;if(v&&(n.uniform3f(a.uniform("uFragmentOrigin"),k[0]+oe*N[0]*$e+O[V*3+0],k[1]+Se*N[1]*$e+O[V*3+1],k[2]+Ke*N[2]*$e+O[V*3+2]),n.uniform3f(a.uniform("uFragmentShape"),N[0]*$e,N[1]*$e,N[2]*$e)),Qm){const Tt=`lod=${V}, chunkIndex=${z}, subChunkBegin=${Y}, subChunkEnd=${Q}, uFragmentOrigin=${[k[0]+oe*N[0]*$e+O[V*3+0],k[1]+Se*N[1]*$e+O[V*3+1],k[2]+Ke*N[2]*$e+O[V*3+2]]}, uFragmentShape=${[N[0]*$e,N[1]*$e,N[2]*$e]}`,we=e.pickIDs.registerUint64(this,w,1,Tt);e.emitPickID&&r.setPickID(n,a,we)}r.drawMultiscaleFragment(n,a,ce,Y,Q)})}),l.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,S,y-S),r.endLayer(n,a)}isReady(e,t){const{displayState:n}=this;if(n.objectAlpha.value<=0)return!0;const s=lr(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(s===void 0)return!1;const{chunks:r}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:a}=e,l=C.pB.multiply(C.pB.create(),a.viewProjectionMat,s),c=(0,C._S)(new Float32Array(24),l),d=this.displayState.renderScaleTarget.value;let u=!0;return Rs(n.segmentationGroupState.value,h=>{if(!u)return;const p=Sn(h),m=r.get(p);if(m===void 0){u=!1;return}const{manifest:g}=m;hm(g,l,c,d,a.width,a.height,(v,y)=>(u=u&&tv(o,p,v,y),u),()=>{})}),u}getObjectPosition(e){const t=this.displayState.transform.value;if(t.error!==void 0)return;const n=this.source.chunks.get(Sn(e));if(n===void 0)return;const{manifest:s}=n,{clipLowerBound:r,clipUpperBound:o}=s,{rank:a}=t,l=new Float32Array(a);for(let d=0;d<3;++d)l[d]=(r[d]+o[d])/2;const c=new Float32Array(a);return De.vo(c,t.modelToRenderLayerTransform,a+1,l,a),c}}class ZD extends Jn{constructor(e,t){super(e),this.manifest=t.manifest}}class eI extends Jn{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),Km(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),qm(this)}}class Ra extends on{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new Md(this.chunkManager,this)),this.format=t.format}static encodeOptions(e){return{format:e.format,...on.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new ZD(this,e)}}let Md=class extends on{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new eI(this,i)}};Md=Ym([Zt(bn.pi)],Md);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function XV(i){let e=0;const t=i.length;for(let n=0;n<t;++n)e=e*31+i.charCodeAt(n)|0;return e}function nv(i,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,i^=e,i=(i<<13|i>>>19)>>>0,i=Math.imul(i,5)+3864292196>>>0,i}function tI(i,e){return i^=e,i^=i>>>16,i=Math.imul(i,2246822507)>>>0,i^=i>>>13,i*=3266489909,i^=i>>>16,i>>>0}function iv(i,e,t){let n=i;return n=nv(n,e),n=nv(n,t),tI(n,8)}function ka(i){return i^=i>>>16,i=Math.imul(i,2246822507),i^=i>>>13,i=Math.imul(i,3266489909),i^=i>>>16,i}function sv(i,e){return i<<e|i>>>32-e}function ZV(i,e,t,n){let s=e,r=e,o=e,a=e;const l=597399067,c=2869860233,d=951274213;let u=Math.imul(n,c);u=sv(u,16),u=Math.imul(u,d),r^=u;let h=Math.imul(t,l);h=sv(h,15),h=Math.imul(h,c),s^=h;const p=8;return s^=p,r^=p,o^=p,a^=p,s=s+r>>>0,s=s+o>>>0,s=s+a>>>0,r=r+s>>>0,o=o+s>>>0,a=a+s>>>0,s=ka(s),r=ka(r),o=ka(o),a=ka(a),s=s+r>>>0,s=s+o>>>0,s=s+a>>>0,r=r+s>>>0,i.low=s,i.high=r,i}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nI extends on{constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}function iI(i,e,t){const n=i.length-1;for(;;){if(e=e&n,i[e]===0){i[e]=t;return}++e}}function Fs(i,e){return e<=255?new Uint8Array(i):e<=65535?new Uint16Array(i):new Uint32Array(i)}function sI(i){const e=i.length/2,n=2**(Math.ceil(Math.log2(e))+1),s=Fs(n,e+1);for(let r=0;r<e;++r){const o=i[2*r],a=i[2*r+1];iI(s,iv(0,o,a),r+1)}return s}function rI(i,e,t,n){let s=iv(0,t,n);const r=i.length-1;for(;;){s=s&r;let o=i[s];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===n)return o;++s}}class rv{constructor(e){this.inlineProperties=e.inlineProperties}}class oI{constructor(e){this.segmentPropertyMap=e;const{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=sI(t.ids)),this.tags=t?.properties.find(n=>n.type==="tags"),this.labels=t?.properties.find(n=>n.type==="label"),this.numericalProperties=t?.properties.filter(n=>n.type==="number")??[]}getSegmentInlineIndex(e){const{inlineIdToIndex:t}=this;return t===void 0?-1:rI(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){const t=this.getSegmentInlineIndex(e);if(t===-1)return;const{labels:n,tags:s}=this;let r="";if(n!==void 0&&(r=n.values[t]),s!==void 0){const{tags:o,values:a}=s,l=a[t];for(let c=0,d=l.length;c<d;++c){const u=o[l.charCodeAt(c)];r.length>0&&(r+=" "),r+="#",r+=u}}if(r.length!==0)return r}}function ov(i,e,t){for(let n=0,s=t.length;n<s;++n)e[t[n]]=i[n]}function aI(i){const e=i.length;if(e===0)return!0;let t=i[0],n=i[1];for(let s=0;s<e;s+=2){const r=i[s],o=i[s+1];if((o-n||r-t)<=0)return!1;t=r,n=o}return!0}function lI(i){const{ids:e}=i;if(aI(e))return i;const t=e.length/2,n=Fs(t,t-1);for(let o=0;o<t;++o)n[o]=o;n.sort((o,a)=>{const l=e[o*2],c=e[o*2+1],d=e[a*2],u=e[a*2+1];return c-u||l-d});const s=new Uint32Array(t*2);for(let o=0;o<t;++o){const a=n[o];s[o*2]=e[a*2],s[o*2+1]=e[a*2+1]}const r=i.properties.map(o=>{const{values:a}=o,l=new a.constructor(t);for(let c=0;c<t;++c)l[c]=a[n[c]];return{...o,values:l}});return{ids:s,properties:r}}function cI(i,e,t){const n=new Array(e);return n.fill(""),ov(i.values,n,t),{...i,values:n}}function dI(i,e,t){const n=new Float32Array(e);return n.fill(Number.NaN),ov(i.values,n,t),{...i,values:n}}function av(i,e,t){const{type:n}=i;return n==="label"||n==="description"||n==="string"||n==="tags"?cI(i,e,t):dI(i,e,t)}function uI(i,e){if(i===void 0)return e;if(e===void 0)return i;let t=0;const n=i.ids.length/2,s=e.ids.length/2,r=new Uint32Array(n),o=new Uint32Array(s),a=i.ids,l=e.ids;(0,F.NT)(n,s,(u,h)=>{const p=a[2*u+1],m=a[2*u],g=l[2*h+1],v=l[2*h];return p-g||m-v},u=>{r[u]=t,++t},u=>{o[u]=t,++t},(u,h)=>{r[u]=t,o[h]=t,++t});let c;if(t===n)c=a;else if(t===s)c=l;else{c=new Uint32Array(t*2);for(let u=0;u<n;++u){const h=r[u];c[2*h]=a[2*u],c[2*h+1]=a[2*u+1]}for(let u=0;u<s;++u){const h=o[u];c[2*h]=l[2*u],c[2*h+1]=l[2*u+1]}}const d=[];if(t===n)d.push(...i.properties);else for(const u of i.properties)d.push(av(u,t,r));if(t===s)d.push(...e.properties);else for(const u of e.properties)d.push(av(u,t,o));return{ids:c,properties:d}}function hI(i,e){return new rv({inlineProperties:uI(i.inlineProperties,e.inlineProperties)})}function pI(i){for(;;){if(i.length===0)return;if(i.length===1)return i[0];const e=[];for(let t=0,n=i.length;t<n;t+=2)t+1===n?e.push(i[t]):e.push(hI(i[t],i[t+1]));i=e}}function fI(i,e){return i.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>xt(t))},()=>{const t=pI(e);if(t!==void 0)return new oI(t)})}const gI=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function mI(i,e){if(e.match(gI)!==null){const d=e.split(/[\s,]+/),u=[],h=new Set;for(let p=0,m=d.length;p<m;++p){const g=d[p];if(g==="")continue;const v=new P.R;if(!v.tryParseString(g))continue;const y=v.toString();h.has(y)||(h.add(y),u.push(v))}return u.sort(P.R.compare),{ids:u}}const t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},n=i?.segmentPropertyMap.inlineProperties?.properties,r=i?.tags?.tags||[],o=r.map(d=>d.toLowerCase()),a=i?.labels,l=[];let c;for(let d=0;d<e.length;d=c){let u=e.indexOf(" ",d);u===-1?c=u=e.length:c=u+1;const h=e.substring(d,u);if(h.length===0)continue;const p=(g,v)=>{const y=g.toLowerCase(),S=o.indexOf(y);if(S===-1){l.push({begin:v,end:u,message:`Invalid tag: ${g}`});return}if(g=r[S],t.includeTags.includes(g)||t.excludeTags.includes(g)){l.push({begin:v,end:u,message:`Duplicate tag: ${g}`});return}return g};if(h.startsWith("#")){const g=p(h.substring(1),d+1);g!==void 0&&t.includeTags.push(g);continue}if(h.startsWith("-#")){const g=p(h.substring(2),d+2);g!==void 0&&t.excludeTags.push(g);continue}if(h.startsWith("<")||h.startsWith(">")){let g=h.substring(1).toLowerCase();if(g!=="id"&&g!=="label"){const v=n?.find(y=>y.id.toLowerCase()===g&&(y.type==="number"||y.type==="label"||y.type==="string"));if(v===void 0){l.push({begin:d+1,end:u,message:`Invalid field: ${g}`});continue}g=v.id}if(t.sortBy.find(v=>v.fieldId===g)!==void 0){l.push({begin:d+1,end:u,message:`Duplicate sort field: ${g}`});continue}t.sortBy.push({order:h[0],fieldId:g});continue}if(h.startsWith("|")){let g=h.substring(1).toLowerCase();if(g==="id"||g==="label")continue;const v=n?.find(y=>y.id.toLowerCase()===g&&(y.type==="number"||y.type==="string"));if(v===void 0){l.push({begin:d+1,end:u,message:`Invalid field: ${g}`});continue}if(g=v.id,t.sortBy.find(y=>y.fieldId===g)||t.includeColumns.find(y=>y===g))continue;t.includeColumns.push(g);continue}if(h.startsWith("/")){if(t.regexp!==void 0){l.push({begin:d,end:u,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){l.push({begin:d,end:u,message:"Prefix cannot be combined with regular expression"});continue}if(a===void 0&&r.length==0){l.push({begin:d,end:u,message:"No label property"});continue}try{t.regexp=new RegExp(h.substring(1))}catch{l.push({begin:d,end:u,message:"Invalid regular expression syntax"})}continue}const m=h.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(m!==null){let g=m[1].toLowerCase();const v=m[2],y=i?.numericalProperties.find(I=>I.id.toLowerCase()===g);if(y===void 0){l.push({begin:d,end:d+g.length,message:`Invalid numerical field: ${g}`});continue}g=y.id;let S;try{S=qt(y.dataType,m[3])}catch(I){l.push({begin:d+m[1].length+m[2].length,end:u,message:I.message});continue}let w=t.numericalConstraints.find(I=>I.fieldId===g);w===void 0&&(w={fieldId:g,bounds:y.bounds},t.numericalConstraints.push(w));const b=Pe(y.bounds,w.bounds[0]),x=Pe(y.bounds,w.bounds[1]);let E=x,D=b;switch(v){case"<":E=H(y.dataType,S,-1);break;case"<=":E=S;break;case"=":E=D=S;break;case">=":D=S;break;case">":D=H(y.dataType,S,1);break}if(D=rt(b,D)>0?b:D,E=rt(x,E)<0?x:E,rt(D,E)>0){l.push({begin:d,end:u,message:"Constraint would not match any values"});continue}w.bounds=[D,E];continue}if(t.regexp!==void 0){l.push({begin:d,end:u,message:"Prefix cannot be combined with regular expression"});continue}if(a===void 0&&r.length==0){l.push({begin:d,end:u,message:"No label property"});continue}t.prefix!==void 0?t.prefix+=` ${h}`:t.prefix=h}return l.length>0?{errors:l}:(t.sortBy.length===0&&t.sortBy.push({fieldId:lv(i),order:"<"}),t)}function Nd(i){return"\\u"+i.toString(16).padStart(4,"0")}function vI(i,e){if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){const{ids:b}=e;return{query:e,total:-1,explicitIds:b,count:b.length}}const t=i?.segmentPropertyMap?.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};const n=t?.properties,s=t.ids.length/2,r=i?.tags?.tags?.length||0;let o=Fs(s,s);const a=Fs(r,r);a.fill(1);for(let b=0;b<s;++b)o[b]=b;const l=b=>{const x=o.length;let E=0;for(let D=0;D<x;++D){const I=o[D];b(I)&&(o[E]=I,++E)}o=o.subarray(0,E)},c=b=>{const x=i.tags.tagDescriptions,E=i.tags.tags;a.fill(0);for(let D=0;D<x.length;D++)x[D].match(b)!==null&&(a[D]=1),E[D].match(b)!==null&&(a[D]=1)};if(e.regexp!==void 0||e.prefix!==void 0){const{regexp:b,prefix:x}=e;if(i.labels!==void 0){const E=i.labels.values;b!==void 0&&l(D=>E[D].match(b)!==null),x!==void 0&&l(D=>E[D].startsWith(x))}if(o.length==0&&b!==void 0||i.labels==null&&b!=null){o=Fs(s,s);for(let E=0;E<s;++E)o[E]=E;c(b),e.regexp=void 0}}const{includeTags:d,excludeTags:u}=e,h=i.tags;if(d.length>0||u.length>0){const{values:b,tags:x}=h,E=[];for(const k of d)E.push([x.indexOf(k),1]);for(const k of u)E.push([x.indexOf(k),0]);E.sort((k,O)=>k[0]-O[0]);let D="^",I=0;const L=k=>{k<I||(D+=`[${Nd(I)}-${Nd(k)}]*`)};for(const[k,O]of E)L(k-1),O&&(D+=Nd(k)),I=k+1;L(65535),D+="$";const N=new RegExp(D);l(k=>b[k].match(N)!==null)}let p,m;const{numericalConstraints:g}=e;if(g.length>0){const b=i.numericalProperties,x=g.length,E=2**x-1;p=Fs(o.length,E);for(let L=0;L<x;++L){const N=g[L],k=b.find(Q=>Q.id===N.fieldId),{values:O}=k,V=2**L,[z,Y]=N.bounds;for(let Q=0,X=o.length;Q<X;++Q){const ce=O[o[Q]];p[Q]|=V*(ce>=z&&ce<=Y)}}m=o,o=m.slice();const D=o.length;let I=0;for(let L=0;L<D;++L)p[L]===E&&(o[I]=o[L],++I);o=o.subarray(0,I)}let v=[];if(h!==void 0){const b=[],{tags:x,values:E,tagDescriptions:D}=h,I=new Uint32Array(x.length);for(let L=0,N=o.length;L<N;++L){const k=E[o[L]];for(let O=0,V=k.length;O<V;++O)++I[k.charCodeAt(O)]}for(let L=0,N=x.length;L<N;++L){if(a[L]===0)continue;const k=I[L],O=x[L],V=D[L],z={tag:O,tagIndex:L,count:I[L],desc:V};e.includeTags.includes(O)||e.excludeTags.includes(O)?b.push(z):k>0&&v.push(z)}b.push(...v),v=b}const y=(b,x)=>{if(b.type!=="number"){const{values:E}=b;o.sort((D,I)=>(0,kr.e)(E[D],E[I])*x)}else{const E=b.values;o.sort((D,I)=>(E[D]-E[I])*x)}},S=b=>{h!==void 0&&y(h,b);const x=i?.labels;x!==void 0&&y(x,b)},{sortBy:w}=e;for(let b=w.length-1;b>=0;--b){const{fieldId:x,order:E}=w[b],D=E==="<"?1:-1;if(x==="id"){if(b+1===w.length){if(E==="<")continue;o.reverse();continue}o.sort((I,L)=>D*(I-L))}else x==="label"?S(D):y(n.find(I=>I.id===x),D)}return{query:e,intermediateIndices:m,intermediateIndicesMask:p,indices:o,tags:v,count:o.length,total:s}}function yI(i,e,t){const{values:s}=e,[r,o]=t,a=o<=r?0:256/(o-r),l=new Uint32Array(258),{numericalConstraints:c}=i.query,d=c.findIndex(u=>u.fieldId===e.id);if(d===-1){const u=i.indices;for(let h=0,p=u.length;h<p;++h){const m=s[u[h]];Number.isNaN(m)||++l[Math.min(255,Math.max(-1,(m-r)*a))+1>>>0]}}else{const u=i.intermediateIndices,h=i.intermediateIndicesMask,p=2**c.length-1-2**d;for(let m=0,g=u.length;m<g;++m)if((h[m]&p)===p){const y=s[u[m]];Number.isNaN(y)||++l[Math.min(255,Math.max(-1,(y-r)*a))+1>>>0]}}return{queryResult:i,histogram:l,window:t}}function SI(i,e,t,n){if(i===void 0){t.length=0,n.length=0;return}const{numericalProperties:s}=i,r=s.length;if(e?.indices===void 0){t.length=0;return}for(let a=0;a<r;++a){const l=t[a],c=n[a],d=s[a];l!==void 0&&l.queryResult===e&&Bt(d.dataType,l.window,c)||(t[a]=yI(e,d,c))}}function lv(i){return i?.tags||i?.labels?"label":"id"}function bI(i,e){const{ids:t}=e;if(t!==void 0)return t.map(a=>a.toString()).join(", ");let n="";e=e;const{prefix:s,regexp:r}=e;s!==void 0?n=s:r!==void 0&&(n=`/${r}`);for(const a of e.includeTags)n.length>0&&(n+=" "),n+=`#${a}`;for(const a of e.excludeTags)n.length>0&&(n+=" "),n+=`-#${a}`;for(const a of e.numericalConstraints){const{fieldId:l,bounds:c}=a,[d,u]=c,h=i.numericalProperties.find(p=>p.id===l);if(!Bt(h.dataType,h.bounds,c)){if(rt(d,u)===0){n.length>0&&(n+=" "),n+=`${l}=${d}`;continue}if(rt(d,h.bounds[0])>0){n.length>0&&(n+=" ");const p=H(h.dataType,d,-1),m=d.toString(),g=p.toString();h.dataType!==R.FLOAT32||m.length<=g.length?n+=`${l}>=${m}`:n+=`${l}>${g}`}if(rt(u,h.bounds[1])<0){n.length>0&&(n+=" ");const p=H(h.dataType,u,1),m=u.toString(),g=p.toString();h.dataType!==R.FLOAT32||m.length<=g.length?n+=`${l}<=${m}`:n+=`${l}<${g}`}}}let{sortBy:o}=e;if(o.length===1){const a=o[0];a.order==="<"&&a.fieldId===lv(i)&&(o=[])}for(const a of o)n.length>0&&(n+=" "),n+=`${a.order}${a.fieldId}`;for(const a of e.includeColumns)n.length>0&&(n+=" "),n+=`|${a}`;return n}const Us=new P.R;function CI(i,e,t){if(e===void 0)return;const{explicitIds:n}=e;if(n!==void 0){n.forEach(t);return}const{indices:s}=e;if(s!==void 0){const{ids:r}=i.segmentPropertyMap.inlineProperties;for(let o=0,a=s.length;o<a;++o){const l=s[o];Us.low=r[l*2],Us.high=r[l*2+1],t(Us,o)}}}function*wI(i,e,t=!1){if(e===void 0)return;const{explicitIds:n}=e;if(n!==void 0)for(const r of n)yield r;const{indices:s}=e;if(s!==void 0){const{ids:r}=i.segmentPropertyMap.inlineProperties;for(let o=0,a=s.length;o<a;++o){const l=s[o];t?yield new P.R(r[l*2],r[l*2+1]):(Us.low=r[l*2],Us.high=r[l*2+1],yield Us)}}}function cv(i,e,t){if(t.size===0)return 0;let n=0;return CI(i,e,s=>{t.has(s)&&++n}),n}function dv(i,e,t,n){const s=i.includeTags.filter(o=>o!==e),r=i.excludeTags.filter(o=>o!==e);return n===!0&&(t?s:r).push(e),{...i,includeTags:s,excludeTags:r}}function xI(i){return i.ids!==void 0?!1:i.errors!==void 0?!0:!(i.numericalConstraints.length>0||i.includeTags.length>0||i.excludeTags.length>0||i.prefix||i.regexp)}function Pa(i,e){if(i===void 0||i.ids!==void 0||i.errors!==void 0)return!1;const{sortBy:t,includeColumns:n}=i;return t.find(s=>s.fieldId===e)!==void 0||n.includes(e)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class EI extends Gt{constructor(e){super(),this.layer=e;const{element:t}=this;t.appendChild(this.registerDisposer(new Wt(e.displayState.segmentationGroupState.value.graph,(n,s,r)=>{n?.tabContents&&s.appendChild(n.tabContents(e,r,this))})).element)}}class Od{}class _d extends T.O8{constructor(e,t){super(),this.graph=e,this.segmentsState=t}createRenderLayers(e,t,n){return[]}}function e2(i,e){let t,n;const s=()=>{const{value:a}=e;if(a===void 0){n!==void 0&&(n(),n=void 0,t=void 0);return}t!=null&&Uint64.equal(t,a)||(n!==void 0&&(n(),n=void 0,t=void 0),n=i.trackSegment(a,l=>{t=l,e.value=l??void 0}))};s();const r=e.changed.add(s);return()=>{r(),n!==void 0&&(n(),n=void 0)}}var Vd=G(9100),TI=Object.defineProperty,DI=Object.getOwnPropertyDescriptor,II=(i,e,t,n)=>{for(var s=n>1?void 0:n?DI(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&TI(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const LI="DisjointUint64Sets",uv="DisjointUint64Sets.add",hv="DisjointUint64Sets.clear",pv="DisjointUint64Sets.highBitRepresentativeChanged",fv="DisjointUint64Sets.deleteSet";let Ki=class extends vo{constructor(){super(...arguments),this.disjointSets=new Vd.I,this.changed=new j.IY}get value(){return this}static makeWithCounterpart(i,e){const t=new Ki;return t.disjointSets.visibleSegmentEquivalencePolicy=e,t.registerDisposer(e.changed.add(()=>{gv(t)})),t.initializeCounterpart(i),e.value&&gv(t),t}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(i,e){if(this.disjointSets.link(i,e)){const{rpc:t}=this;return t&&t.invoke(uv,{id:this.rpcId,al:i.low,ah:i.high,bl:e.low,bh:e.high}),this.changed.dispatch(),!0}return!1}linkAll(i){for(let e=1,t=i.length;e<t;++e)this.link(i[0],i[e])}has(i){return this.disjointSets.has(i)}get(i){return this.disjointSets.get(i)}clear(){if(this.disjointSets.clear()){const{rpc:i}=this;i&&i.invoke(hv,{id:this.rpcId}),this.changed.dispatch()}}setElements(i){return this.disjointSets.setElements(i)}deleteSet(i){if(this.disjointSets.deleteSet(i)){const{rpc:e}=this;e&&e.invoke(fv,{id:this.rpcId,l:i.low,h:i.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(i){if(i!==void 0){const e=[new P.R,new P.R];(0,f.$v)(i,t=>{(0,f.$v)(t,(n,s)=>{e[s%2].parseString(String(n),10),s!==0&&this.link(e[0],e[1])})})}}assignFrom(i){this.clear(),i instanceof Ki&&(i=i.disjointSets);for(const[e,t]of i)this.link(e,t)}};Ki=II([yo(LI)],Ki);const $s=new P.R,Bd=new P.R;pt(uv,function(i){const e=this.get(i.id);$s.low=i.al,$s.high=i.ah,Bd.low=i.bl,Bd.high=i.bh,e.disjointSets.link($s,Bd)&&e.changed.dispatch()}),pt(hv,function(i){const e=this.get(i.id);e.disjointSets.clear()&&e.changed.dispatch()});function gv(i){i.rpc.invoke(pv,{id:i.rpcId,value:i.disjointSets.visibleSegmentEquivalencePolicy.value})}pt(pv,function(i){const e=this.get(i.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=i.value}),pt(fv,function(i){const e=this.get(i.id);$s.low=i.l,$s.high=i.h,e.disjointSets.deleteSet($s)&&e.changed.dispatch()});/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class RI extends Od{constructor(){super(...arguments),this.spanningTreeEdges=new Map,this.equivalences=new Ki,this.connections=new Set,this.changed=new j.HN}link(e,t){this.equivalences.link(e,t);for(const n of this.connections)n.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(const e of this.connections)Fd(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){const n=e.toString(),s=t.toString(),{spanningTreeEdges:r}=this;let o=r.get(n);o===void 0&&(o=new Set,r.set(n,o));let a=r.get(s);a===void 0&&(a=new Set,r.set(s,a)),o.add(s),a.add(n)}removeSpanningTreeEdge(e,t){const n=e.toString(),s=t.toString(),{spanningTreeEdges:r}=this,o=r.get(n),a=r.get(s);o.delete(s),o.size===0&&r.delete(n),a.delete(n),a.size===0&&r.delete(s)}*getSpanningTreeNeighbors(e){const t=new P.R,n=this.spanningTreeEdges.get(e.toString());if(n!==void 0)for(const s of n)t.parseString(s),yield t}restoreState(e){const{equivalences:t,spanningTreeEdges:n}=this;if(t.clear(),n.clear(),e===void 0)return;const s=[new P.R,new P.R];(0,f.$v)(e,r=>{(0,f.$v)(r,(o,a)=>{s[a%2].parseString(String(o),10),a!==0&&t.link(s[0],s[1])&&this.addSpanningTreeEdge(s[0],s[1])})})}toJSON(){const{spanningTreeEdges:e}=this;if(e.size===0)return;const t=new Array;for(const[n,s]of e){const r=P.R.parseString(n);for(const o of s){const a=P.R.parseString(o);P.R.compare(r,a)>0||t.push([r,a])}}return t.sort((n,s)=>P.R.compare(n[0],s[0])||P.R.compare(n[1],s[1])),t.map(n=>n.map(s=>s.toString()))}get visibleSegmentEquivalencePolicy(){return Rt.y6.MIN_REPRESENTATIVE}async merge(e,t){const{equivalences:n}=this;return P.R.equal(n.get(e),n.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),n.get(e))}async split(e,t){const n=this.computeSplit(e,t);if(n===void 0)throw new Error("Segments are already split");const{includeBaseSegments:s,includeRepresentative:r,excludeBaseSegments:o,excludeRepresentative:a}=n,{equivalences:l}=this;this.deleteSet(e),this.linkAll(s),this.linkAll(o);const c=(h,p)=>{for(const m of h)for(const g of this.getSpanningTreeNeighbors(m))P.R.equal(l.get(g),p)||this.removeSpanningTreeEdge(m,g)},d=l.get(e),u=l.get(t);c(s,d),c(o,u);for(const h of this.connections){const{selectedSegments:p,visibleSegments:m}=h.segmentsState;p.has(a)&&(p.delete(a),p.add(r),m.add(r))}return this.normalizeAll(),this.changed.dispatch(),{include:d,exclude:u}}trackSegment(e,t){return()=>{}}computeSplit(e,t){const{equivalences:n}=this,s=n.get(e);if(!P.R.equal(s,n.get(t)))return;const r=new Vd.I;for(const u of n.setElements(s))if(!P.R.equal(u,t))for(const h of this.getSpanningTreeNeighbors(u))P.R.equal(h,t)||r.link(u,h);const o=[],a=[],l=r.get(e);let c=e,d=t;for(const u of n.setElements(s))P.R.equal(r.get(u),l)?(o.push(u),P.R.compare(u,c)<0&&(c=u)):(a.push(u),P.R.compare(u,d)<0&&(d=u));return o.sort(P.R.compare),a.sort(P.R.compare),{includeBaseSegments:o,includeRepresentative:c,excludeBaseSegments:a,excludeRepresentative:d}}connect(e){const t=e.displayState.segmentationGroupState.value,n=new kI(this,t);return t.segmentEquivalences.assignFrom(this.equivalences),Fd(t.visibleSegments,t.segmentEquivalences.disjointSets),n.registerDisposer(t.visibleSegments.changed.add(n.registerCancellable((0,Fe.A)(()=>Fd(t.visibleSegments,t.segmentEquivalences.disjointSets),0)))),this.connections.add(n),n.registerDisposer(()=>{this.connections.delete(n)}),n}}function Fd(i,e){const t=[];for(const n of i.unsafeKeys()){const s=e.get(n);P.R.equal(n,s)||(t.push(s),i.delete(n))}for(const n of t)i.add(n)}class kI extends _d{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var PI=G(3786);/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mv=yr;function Aa(i,e){i.addVertexCode(wc),i.addUniform("highp vec3","uCircleParams"),i.addVarying("highp vec4","vCircleCoord"),i.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),i.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function Ma(i,e,t){const{gl:n}=i;n.uniform3f(i.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function Na(i,e,t){Ao(i,e,t)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function xi(i){i.addAttribute("int","aDummyVertexId",0),i.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class Qn extends T.O8{constructor(e){super(),this.buffer=new At(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){const{buffer:t}=this,{gl:n}=t;t.bind(),e>this.size&&(this.size=e,n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),n.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),n.vertexAttribDivisor(0,0),n.enableVertexAttribArray(0)}disable(){const{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new Qn(e))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const AI=C.pB.create(),vv=`void main() {
  emitDefault();
}
`,Gr=[],MI=Wi(new Ns,R.FLOAT32,3);class yv extends T.O8{constructor(e,t){super(),this.base=e,this.targetIsSliceView=t,this.textureAccessHelper=new xa("vertexData"),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl)),this.edgeShaderGetter=Ai(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(n,s)=>{if(s.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(n),this.defineAttributeAccess(n),In(n),n.addAttribute("highp uvec2","aVertexIndex"),n.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;n.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),n.addFragmentCode(Is);const{vertexAttributes:o}=this,a=o.length;for(let l=1;l<a;++l){const c=o[l];n.addVarying(`highp ${c.glslDataType}`,`vCustom${l}`),r+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,n.addFragmentCode(`#define ${c.name} vCustom${l}
`)}n.setVertexMain(r),Ts(s,n),n.setFragmentMainFunction(ms(s.parseResult.code))}}),this.nodeShaderGetter=Ai(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(n,s)=>{if(s.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(n),this.defineAttributeAccess(n),Aa(n,this.targetIsSliceView),n.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;n.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),n.addFragmentCode(Is);const{vertexAttributes:o}=this,a=o.length;for(let l=1;l<a;++l){const c=o[l];n.addVarying(`highp ${c.glslDataType}`,`vCustom${l}`),r+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,n.addFragmentCode(`#define ${c.name} vCustom${l}
`)}n.setVertexMain(r),Ts(s,n),n.setFragmentMainFunction(ms(s.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){xi(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){const{textureAccessHelper:t}=this;t.defineShader(e);const n=this.vertexAttributes.length;for(let s=Gr.length;s<n;++s)Gr[s]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${s}`);this.vertexAttributes.forEach((s,r)=>{e.addTextureSampler(`${Ca(s.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,Gr[r]),e.addVertexCode(t.getAccessor(`readAttribute${r}`,`uVertexAttributeSampler${r}`,s.dataType,s.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,n,s){const{viewProjectionMat:r}=n.projectionParameters,o=C.pB.multiply(AI,r,s);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}drawSkeleton(e,t,n,s,r){const{vertexAttributes:o}=this,a=o.length,{vertexAttributeTextures:l}=s;for(let c=0;c<a;++c){const d=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Gr[c]);e.activeTexture(d),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l[c])}{t.bind();const c=t.attribute("aVertexIndex");s.indexBuffer.bindToVertexAttribI(c,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(c,1),vn(t,r,this.targetIsSliceView?1:0),mn(e,1,s.numIndices/2),e.vertexAttribDivisor(c,0),e.disableVertexAttribArray(c)}n!==null&&(n.bind(),Ma(n,r,{featherWidthInPixels:this.targetIsSliceView?1:0}),Na(n.gl,2,s.numVertices))}endLayer(e,t){const{vertexAttributes:n}=this,s=n.length;for(let r=0;r<s;++r){const o=t.textureUnit(Gr[r])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}}var Sv=(i=>(i[i.LINES=0]="LINES",i[i.LINES_AND_POINTS=1]="LINES_AND_POINTS",i))(Sv||{});class bv extends Oi.F{constructor(e,t=e){super(Sv,e,t)}}class Cv extends _.DN{constructor(e,t=e){super(e,f.Mo,t)}}class NI{constructor(){this.compound=new fr,this.shader=Co(vv),this.shaderControlState=new Jo(this.shader),this.params2d={mode:new bv(1),lineWidth:new Cv(2)},this.params3d={mode:new bv(0),lineWidth:new Cv(1)};const{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){const e=this.compound.toJSON();for(const t of Object.values(e))if(t!==void 0)return e}}class OI extends T.O8{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.layerChunkProgressInfo=new fo,this.redrawNeeded=new j.IY,this.fallbackShaderParameters=new _.B0(Ho(Er(vv))),Ld(n,this),this.displayState.shaderError.value=void 0;const{skeletonRenderingOptions:s}=n;this.registerDisposer(s.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));const r=this.sharedObject=this.registerDisposer(new Ia(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID=PI.k,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});const o=this.vertexAttributes=[VI];for(const[a,l]of t.vertexAttributes)o.push({name:a,dataType:l.dataType,numComponents:l.numComponents,webglDataType:_I(l.dataType),glslDataType:l.numComponents>1?`vec${l.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,n,s,r){const o=s.lineWidth.value,{gl:a,source:l,displayState:c}=this;if(c.objectAlpha.value<=0)return;const d=lr(c.transform.value,e.projectionParameters.displayDimensionRenderInfo,r);if(d===void 0)return;let u;s.mode.value===1?u=Math.max(5,o*2):u=o;const h=n.edgeShaderGetter(e.emitter),p=n.nodeShaderGetter(e.emitter),{shader:m,parameters:g}=h,{shader:v,parameters:y}=p;if(m===null||v===null)return;const{shaderControlState:S}=this.displayState.skeletonRenderingOptions;m.bind(),n.beginLayer(a,m,e,d),vi(a,m,S,g.parseResult.controls),a.uniform1f(m.uniform("uLineWidth"),o),v.bind(),n.beginLayer(a,v,e,d),a.uniform1f(v.uniform("uNodeDiameter"),u),vi(a,v,S,y.parseResult.controls);const w=l.chunks;kd(c,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(b,x,E)=>{const D=Sn(b),I=w.get(D);I===void 0||I.state!==Ue.GPU_MEMORY||(x!==void 0&&(m.bind(),n.setColor(a,m,x),v.bind(),n.setColor(a,v,x)),E!==void 0&&(m.bind(),n.setPickID(a,m,E),v.bind(),n.setPickID(a,v,E)),n.drawSkeleton(a,m,v,I,e.projectionParameters))}),n.endLayer(a,m)}isReady(){const{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;const n=e.chunks;let s=!0;return Rs(t.segmentationGroupState.value,r=>{const o=Sn(r),a=n.get(o);if(a===void 0||a.state!==Ue.GPU_MEMORY){s=!1;return}}),s}}class Ud extends Gi{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new yv(this.base,!1)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));const{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class wv extends Fi{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new yv(this.base,!0)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);const{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}function _I(i){switch(i){case R.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${R[i]}`)}}const VI={dataType:R.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class BI extends Jn{constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;const n=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=n.length}copyToGPU(e){super.copyToGPU(e);const{attributeTextureFormats:t}=this.source,{vertexAttributes:n,vertexAttributeOffsets:s}=this,r=this.vertexAttributeTextures=[];for(let o=0,a=s.length;o<a;++o){const l=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),wa(e,t[o],n.subarray(s[o],o+1!==a?s[o+1]:n.length)),r[o]=l}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=At.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);const{vertexAttributeTextures:t}=this;for(const n of t)e.deleteTexture(n);t.length=0,this.indexBuffer.dispose()}}const FI=new Map;function UI(i){const e=[MI];for(const t of i.values())e.push(Wi(new Ns,t.dataType,t.numComponents));return e}class Oa extends on{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=UI(this.vertexAttributes)),e}getChunk(e){return new BI(this,e)}get vertexAttributes(){return FI}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var St=(i=>(i[i.UNKNOWN=0]="UNKNOWN",i[i.IMAGE=1]="IMAGE",i[i.SEGMENTATION=2]="SEGMENTATION",i))(St||{});const t2=18;function $d(i){const{rank:e,dataType:t,fillValue:n=t===R.UINT64?P.R.ZERO:0,compressedSegmentationBlockSize:s}=i,{baseVoxelOffset:r=new Float32Array(e)}=i;return{...Ko(i),compressedSegmentationBlockSize:s,baseVoxelOffset:r,dataType:t,fillValue:n}}function $I(i){if(i.compressedSegmentationBlockSize!==void 0||i.volumeType!==2&&!i.volumeSourceOptions.discreteValues)return!1;switch(i.dataType){case R.UINT32:case R.UINT64:break;default:return!1}switch(i.rank){case 3:return!0;case 4:{const{chunkDataSize:e}=i;return e[3]===1}default:return!1}}function xv(i){const{rank:e,lowerVoxelBound:t,upperVoxelBound:n}=i;if(!$I(i))return $d(i);let{volumeSourceOptions:{displayRank:s,multiscaleToViewTransform:r},chunkToMultiscaleTransform:o,chunkToViewTransform:a}=i;a===void 0&&(a=De.lw(new Float32Array(e*s),s,r,s,o,e+1,s,e,e));const{maxCompressedSegmentationBlockSize:l,chunkDataSize:c}=i;return $d({...i,compressedSegmentationBlockSize:Float32Array.from(Qo({rank:e,chunkToViewTransform:a,displayRank:s,lowerVoxelBound:t,upperVoxelBound:n,maxVoxelsPerChunkLog2:9,maxBlockSize:l===void 0?c:uC(new Uint32Array(e),c,l)}))})}function qi(i){const{rank:e}=i,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:n,modelChannelDimensionIndices:s},chunkToMultiscaleTransform:r}=i,o=De.lw(new Float32Array(t*e),t,n,t,r,e+1,t,e,e);let{minBlockSize:a}=i;a===void 0?(a=new Uint32Array(e),a.fill(1)):a=new Uint32Array(a);const{lowerVoxelBound:l,upperVoxelBound:c}=i;if(s.length!==0)for(const u of(0,C.PC)(r,e,s)){let h=c[u];l!==void 0&&(h-=l[u]),a[u]=h}const{chunkDataSizes:d=ME({...i,minBlockSize:a,chunkToViewTransform:o,displayRank:t})}=i;return d.map(u=>xv({...i,chunkDataSize:u,chunkToViewTransform:o}))}const n2="volume";/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ev(i,e,t,n){const{dataType:s}=e;e.defineShader(i,t);let r="",o="";if(t===0)r+="highp int ignoredChannelIndex";else for(let l=0;l<t;++l)l!==0&&(r+=", "),r+=`highp int channelIndex${l}`,o+=`, channelIndex${l}`;i.addFragmentCode(Ew);const a=`
${yt(s)} getDataValue(${r}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${n}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${yt(s)} getInterpolatedDataValue(${r}) {
  highp vec3 positionWithinChunk = ${n};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${yt(s)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${yt(s)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${yt(s)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;i.addFragmentCode(a),t<=1&&i.addFragmentCode(`
${yt(s)} getDataValue() { return getDataValue(0); }
${yt(s)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}const Tv=new Array;function Dv(i){Tv.push(i)}function GI(i,e){for(const t of Tv){const n=t(i,e);if(n!=null)return n}throw new Error("No chunk format handler found.")}class Kn extends Lr{constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(GI(e.chunkQueueManager.gl,this.spec));const n=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(n),this.tempPositionWithinChunk=new Uint32Array(n)}static encodeSpec(e){const t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){const n=this.spec.rank,s=this.tempChunkGridPosition,r=this.tempPositionWithinChunk,{spec:o}=this;{const{chunkDataSize:g}=o;for(let v=0;v<n;++v){const y=e[v],S=g[v],w=Math.floor(y/S);s[v]=w,r[v]=Math.floor(y-S*w)}}const a=this.chunks.get(s.join());if(a===void 0)return null;const l=a.chunkDataSize;for(let g=0;g<3;++g)if(r[g]>=l[g])return;if(t.channelSpaceShape.length===0)return a.getValueAt(r);const{numChannels:c,chunkChannelCoordinates:d,chunkChannelDimensionIndices:u}=t,h=u.length;let p=0;const m=new Array(c);for(let g=0;g<c;++g){for(let v=0;v<h;++v)r[u[v]]=d[p++];m[g]=a.getValueAt(r)}return m}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class zI extends ug{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}}class ln extends fT{}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const WI=C.eR.create(),HI=C.eR.create(),_a=.001,Iv=.001;function Lv(i){let e=0;for(let t=0;t<3;++t)i[t]<0&&(e+=1<<t);return e}const Gd=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),Rv=(()=>{const i=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],n=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],s=new Int32Array(8*8*6);for(let r=0;r<8;++r)for(let o=0;o<t.length;++o){const a=e[r]*8+t[o];s[r*8*6+o]=i[n[a]]}return s})();function Va(i){i.addUniform("highp vec3","uPlaneNormal"),i.addUniform("highp float","uPlaneDistance"),i.addUniform("highp ivec2","uVertexIndex",24),i.addUniform("highp vec3","uVertexBasePosition",8),i.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),Gd)}),i.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${Iv}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${_a}) && (lambda <= (1.0 + ${_a}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function kv(i,e,t,n,s,r,o,a=!0){const l=Lv(s),c=Rv.subarray(l*48,(l+1)*48),d=[0,0],u=[C.eR.create(),C.eR.create()],h=C.eR.create(),p=C.eR.create(),m=g=>Gd.subarray(g*3,g*3+3);for(let g=0;g<4;++g){for(let y=0;y<2;++y)d[y]=c[2*(o*4+g)+y],C.eR.multiply(u[y],i,m(d[y])),C.eR.add(u[y],u[y],r),C.eR.min(u[y],u[y],t),C.eR.max(u[y],u[y],e);C.eR.subtract(h,u[1],u[0]);const v=C.eR.dot(h,s);if(Math.abs(v)>Iv){let y=(n-C.eR.dot(u[0],s))/v;if(y>=-_a&&y<=1+_a)return a&&console.log(`vertex ${o}, e = ${g}, good, lambda=${y}, denom=${v}, v0=${u[0].join()}, vDir=${h.join()}`),y=Math.max(0,Math.min(1,y)),C.eR.scaleAndAdd(p,u[0],h,y),p;a&&console.log(`vertex ${o}, e = ${g}, skipped, denom = ${v}, vDir = ${h.join()}, v0=${u[0].join()}, v1=${u[1].join()}uPlaneNormal = ${(0,C.nL)(s)}, lambda=${y}`)}else a&&console.log(`vertex ${o}, e = ${g}, skipped, deom = ${v}, vDir = ${(0,C.nL)(h)}, uPlaneNormal = ${(0,C.nL)(s)}, uLowerClipBound=${e.join()}, uUpperClipBound=${t.join()}, chunkSize=${i}, uVertexBasePosition(v0)=${m(d[0]).join()}, uVertexBasePosition(v1)=${m(d[1]).join()}, uTranslation=${r.join()}`)}}function i2(i,e,t,n,s,r){const o=[];for(let a=0;a<6;++a){const l=kv(i,e,t,n,s,r,a,!1);l!==void 0&&o.push(l)}return o}function JI(i,e,t){const{gl:n}=i;n.uniform3fv(i.uniform("uPlaneNormal"),e),n.uniform1f(i.uniform("uPlaneDistance"),t);const s=Lv(e);n.uniform2iv(i.uniform("uVertexIndex"),Rv.subarray(s*48,(s+1)*48))}function zd(i,e,t,n,s){const r=(0,C.uD)(WI,e,n);C.eR.normalize(r,r);const o=C.eR.dot(C.eR.transformMat4(HI,t,s),r);JI(i,r,o)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wd=!1,Pv=.001,Av=C.pB.create();function jI(i,e){if(xi(i),Va(i),i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),e){In(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${Ut};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}i.addVarying("highp vec3","vChunkPosition"),i.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${Pv} * abs(uPlaneNormal);
`)}function YI(i,e,t,n,s,r,o){const a=C.eR.create(),l=C.eR.create(),c=C.eR.fromValues(Math.abs(s[0]),Math.abs(s[1]),Math.abs(s[2])),d=C.eR.create();for(let u=0;u<6;++u){const h=kv(i,e,t,n,s,r,u);if(h===void 0){console.log("no intersection found");return}C.eR.transformMat4(a,h,o);const p=u!==0&&C.eR.equals(a,d);C.eR.copy(d,a),C.eR.sub(l,h,r),C.eR.scaleAndAdd(l,l,c,Pv),console.log(`${p?"SKIPPED":"OUTPUT"} vertex ${u}, at ${a}, vChunkPosition = ${l}, uTranslation=${r.join()}, position=${h.join()}`)}}function QI(i,e,t){t&&vn(i,e,1)}function KI(i,e,t,n,s,r){const o=t.projectionParameters.value,{centerDataPosition:a}=o;zd(e,o.viewportNormalInGlobalCoordinates,a,r.transform,r.invTransform),i.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,C.pB.multiply(Av,n,r.transform)),i.uniform3fv(e.uniform("uLowerClipBound"),s.lowerClipDisplayBound),i.uniform3fv(e.uniform("uUpperClipBound"),s.upperClipDisplayBound),Wd&&(window.debug_sliceView_uLowerClipBound=s.lowerClipDisplayBound,window.debug_sliceView_uUpperClipBound=s.upperClipDisplayBound,window.debug_sliceView=t,window.debug_sliceView_dataToDevice=C.pB.clone(Av),window.debug_sliceView_chunkLayout=r)}function qI(i,e,t){i.uniform3fv(e.uniform("uChunkDataSize"),t),Wd&&(window.debug_sliceView_chunkDataSize=t)}function XI(i,e,t,n){if(i.uniform3fv(e.uniform("uTranslation"),t),n?mn(e.gl,6,1):i.drawArrays(i.TRIANGLE_FAN,0,6),Wd){const r=window.debug_sliceView.projectionParameters.value,o=window.debug_sliceView_chunkDataSize,a=window.debug_sliceView_uLowerClipBound,l=window.debug_sliceView_uUpperClipBound,c=window.debug_sliceView_dataToDevice,d=window.debug_sliceView_chunkLayout;console.log(`Drawing chunk: ${t.join()} of data size ${o.join()}, projection`,c);const u=d.globalToLocalNormal(C.eR.create(),r.viewportNormalInGlobalCoordinates),h=C.eR.dot(C.eR.transformMat4(C.eR.create(),r.centerDataPosition,d.invTransform),u);YI(o,a,l,h,u,t,c)}}function ZI(i,e,t){return i>e?t>i?i:e>t?e:t:t>e?e:i>t?i:t}class Mv extends Fc{constructor(e,t){const{shaderError:n=dr(),shaderParameters:s}=t;super(e.chunkManager,e,t);const{gl:r}=this;this.vertexIdHelper=this.registerDisposer(Qn.get(r)),this.shaderParameters=s;const{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?(0,_.XZ)(Fn):o,this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch));const a=this.registerDisposer((0,_.Uq)((l,c)=>({numChannelDimensions:l.rank,dataHistogramChannelSpecifications:c}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=wo(this,r,{memoizeKey:`volume/RenderLayer:${xt(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:s,encodeParameters:t.encodeShaderParameters,shaderError:n,extraParameters:a,defineShader:(l,c,d,u)=>{const{chunkFormat:h,dataHistogramsEnabled:p}=c,{dataHistogramChannelSpecifications:m,numChannelDimensions:g}=u;if(jI(l,h===null),l.addOutputBuffer("vec4","v4f_fragData0",0),l.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),h===null)return;Ev(l,h,g,"vChunkPosition");const v=m.length;if(p&&v>0){let y="";const{dataType:S}=h;for(let w=0;w<v;++w){const{channel:b}=m[w],x=`out_histogram${w}`;l.addOutputBuffer("vec4",x,1+w);const E=`getDataValue(${b.join(",")})`,D=`invlerpForHistogram${w}`;l.addFragmentCode(Ss(l,D,S,!1)),l.addFragmentCode(`
float getHistogramValue${w}() {
  return invlerpForHistogram${w}(${E});
}
`),y+=`{
float x = getHistogramValue${w}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${x} = vec4(x, x, x, 1.0);
}`}l.addFragmentCode(`void userMain();
void main() {
  ${y}
  userMain();
}
#define main userMain
`)}this.defineShader(l,d)},getContextKey:l=>`${l.chunkFormat?.shaderKey}/${l.dataHistogramsEnabled}`}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){const{tempChunkPosition:t}=this;for(const{source:n,chunkTransform:s}of this.visibleSourcesList){if(!gs(t,e,this.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))continue;const r=n.getValueAt(t,s);if(r!=null)return r}return null}beginChunkFormat(e,t,n){const{gl:s}=this,r=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:r}),{shader:a,parameters:l,fallback:c}=o;if(a!==null&&(a.bind(),QI(a,n,t===null),t!==null)){if(r){const{dataHistogramChannelSpecifications:d}=o.extraParameters,u=d.length,h=this.dataHistogramSpecifications.bounds.value;for(let p=0;p<u;++p)Ni(a,`invlerpForHistogram${p}`,t.dataType,h[p])}this.initializeShader(e,a,l,c),t.beginDrawing(s,a)}return o}endSlice(e,t,n){}draw(e){const{sliceView:t}=e,n=t.visibleLayers.get(this),{visibleSources:s}=n;if(s.length===0)return;const{projectionParameters:r,wireFrame:o}=e,{gl:a}=this;this.vertexIdHelper.enable();const l=C.eR.create(),{renderScaleHistogram:c}=this;c!==void 0&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let d,u=null,h;const p=C.eR.create(),m=()=>{u!==null&&(u.unbindTransferFunctionTextures(),h!==null&&h.endDrawing(a,u),this.endSlice(t,u,d.parameters))};let g=!0;for(const v of s){const y=Mc(r,v.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:S}}=v,w=v.source,{fixedPositionWithinChunk:b,chunkDisplayDimensionIndices:x}=v;for(const V of x)b[V]=0;const E=o?null:w.chunkFormat;if(E!==h&&(h=E,m(),d=this.beginChunkFormat(t,E,r),u=d.shader),u===null)continue;const D=w.chunks;p.fill(1);const I=y.size;let L;const N=w.spec.rank;KI(a,u,t,r.viewProjectionMat,v,y),E!==null&&E.beginSource(a,u),g=!0;let k=0,O=0;if(t.forEachVisibleChunk(v,y,V=>{const z=D.get(V);if(z&&z.state===Ue.GPU_MEMORY){const Y=z.chunkDataSize;if(Y!==L){L=Y;for(let X=0;X<3;++X){const ce=x[X];p[X]=ce===-1||ce>=N?1:L[ce]}qI(a,u,p)}const{chunkGridPosition:Q}=z;for(let X=0;X<3;++X){const ce=x[X];l[X]=ce===-1||ce>=N?0:I[X]*Q[ce]}E!==null&&E.bindChunk(a,u,z,b,x,S,g),g=!1,XI(a,u,l,o),++k}else++O}),(k!==0||O!==0)&&c!==void 0){const{effectiveVoxelSize:V}=v,z=ZI(V[0],V[1],V[2]);c.add(z,z/r.pixelSize,k,O)}}if(m(),this.vertexIdHelper.disable(),!e.wireFrame){const v=this.getDataHistogramCount();v>0&&t.computeHistograms(v,this.dataHistogramSpecifications)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nv{constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new yd}update(){const{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;const{hashMap:n}=this;n.clear();for(const[s,r]of e.mappings())n.set(s,r)}}}const Ov=1,_v=2;class Vv extends Mv{constructor(e,t){super(e,{shaderParameters:new _.wP(n=>({hasEquivalences:n.registerDisposer((0,_.Uq)(s=>s.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:n.registerDisposer((0,_.Uq)((s,r,o)=>(o?r:s).size!==0,[t.segmentStatedColors,t.tempSegmentStatedColors2d,t.useTempSegmentStatedColors2d])),hasSegmentDefaultColor:n.registerDisposer((0,_.Uq)((s,r)=>s!==void 0||r!==void 0,[t.segmentDefaultColor,t.tempSegmentDefaultColor2d])),hasHighlightColor:n.registerDisposer((0,_.Uq)(s=>s!==void 0,[t.highlightColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring,baseSegmentHighlighting:t.baseSegmentHighlighting})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentationGroupState=this.displayState.segmentationGroupState.value,this.segmentColorShaderManager=new ED("segmentColorHash"),this.segmentStatedColorShaderManager=new TD("segmentStatedColor"),this.hashTableManager=new wm("visibleSegments"),this.gpuHashTable=this.registerDisposer(Hi.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=Hi.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesShaderManager=new xm("equivalences"),this.equivalencesHashMap=new Nv(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new Nv(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(Hi.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Hi.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),Hm(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){this.gpuSegmentStatedColorHashTable?.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let n=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;n+=`return x;
}
`,e.addFragmentCode(n),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uFlags"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let s=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};
  uint64_t valueForHighlight = ${t.baseSegmentHighlighting?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(s+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),s+=`
  bool has = (uFlags & ${_v}u) != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if ((uFlags & ${Ov}u) != 0u && uSelectedSegment == valueForHighlight.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
`,t.hasHighlightColor&&(e.addUniform("highp vec4","uHighlightColor"),s+=`
    emit(uHighlightColor);
    return;
`),s+=`
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let r=`vec4 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),r+=`
  vec4 rgba;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgba)) {
    return rgba;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec4","uSegmentDefaultColor"),r+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),r+=`  return vec4(segmentColorHash(value), 0.0);
`),r+=`
}
`,e.addFragmentCode(r),s+=`
  vec4 rgba = getMappedIdColor(valueForColor);
  if (rgba.a > 0.0) {
    alpha = rgba.a;
  }
  emit(vec4(mix(vec3(1.0,1.0,1.0), vec3(rgba), saturation), alpha));
`,e.setFragmentMain(s)}initializeShader(e,t,n){const{gl:s}=this,{displayState:r,segmentationGroupState:o}=this,{segmentSelectionState:a}=this.displayState,{segmentDefaultColor:{value:l},segmentColorHash:{value:c},highlightColor:{value:d},tempSegmentDefaultColor2d:{value:u}}=this.displayState,h=dg(o),p=this.displayState.ignoreNullVisibleSet.value;let m=0,g=0,v=0;if(a.hasSelectedSegment&&r.hoverHighlight.value){const S=r.baseSegmentHighlighting.value?a.baseSelectedSegment:a.selectedSegment;m=S.low,g=S.high,v|=Ov}if(s.uniform1f(t.uniform("uSelectedAlpha"),r.selectedAlpha.value),s.uniform1f(t.uniform("uSaturation"),r.saturation.value),s.uniform1f(t.uniform("uNotSelectedAlpha"),r.notSelectedAlpha.value),s.uniform2ui(t.uniform("uSelectedSegment"),m,g),h.hashTable.size===0&&p&&(v|=_v),s.uniform1ui(t.uniform("uFlags"),v),this.hashTableManager.enable(s,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),n.hasEquivalences){const S=o.useTemporarySegmentEquivalences.value;(S?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(s,t,S?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}const y=u||l;if(y){const[S,w,b,x]=y;s.uniform4f(t.uniform("uSegmentDefaultColor"),S,w,b,x===void 0?0:x)}else this.segmentColorShaderManager.enable(s,t,c);if(n.hasSegmentStatedColors){const S=r.useTempSegmentStatedColors2d.value?r.tempSegmentStatedColors2d.value:r.segmentStatedColors.value;let{gpuSegmentStatedColorHashTable:w}=this;(w===void 0||w.hashTable!==S.hashTable)&&(w?.dispose(),this.gpuSegmentStatedColorHashTable=w=Hi.get(s,S.hashTable)),this.segmentStatedColorShaderManager.enable(s,t,w)}d!==void 0&&s.uniform4fv(t.uniform("uHighlightColor"),d)}endSlice(e,t,n){const{gl:s}=this;this.hashTableManager.disable(s,t),n.hasEquivalences&&this.equivalencesShaderManager.disable(s,t),n.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(s,t),super.endSlice(e,t,n)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zr(i=.5){return new _.DN(i,f.xU)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hd=12,Bv=8,eL=6,tL=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function Fv(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*eL*e,t)}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Uv=0,Ba=Uv+1,Pt=Ba+Bv,Jd=Pt+Hd,nL=Jd+6,iL=Float32Array.from([0,0,0,0,0,1,Pt+0,1,0,0,1,0,1,Pt+1,0,1,0,0,1,1,Pt+2,1,1,0,1,1,1,Pt+3,0,0,0,0,1,0,Pt+4,0,0,1,0,1,1,Pt+5,1,0,0,1,1,0,Pt+6,1,0,1,1,1,1,Pt+7,0,0,0,1,0,0,Pt+8,0,0,1,1,0,1,Pt+9,0,1,0,1,1,0,Pt+10,0,1,1,1,1,1,Pt+11]),$v=C.pB.create(),Ei=new Float32Array(6);class Gv extends qo{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl))}defineShader(e){xi(e);const{rank:t}=this;Do(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,n){C.pB.invert($v,t.modelViewProjectionMatrix),(0,C.bS)($v,Ei);const{numChunkDisplayDims:s}=t.chunkDisplayTransform;for(let r=0;r<s;++r)Ei[r]=0,Ei[r+3]=0;for(let r=s;r<3;++r){const o=Math.abs(Ei[r+3]-Ei[r]);Ei[r]-=o,Ei[r+3]+=o}super.enable(e,t,r=>{const o=r.vertexShaderInputBinders.Bounds;o.enable(1);const{gl:a}=this;a.uniform3fv(r.uniform("uModelSpaceBoundOffsets"),Ei),a.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.geometryDataStride,t.bufferOffset);const{vertexIdHelper:l}=this;l.enable(),n(r),l.disable(),o.disable()})}}function zv(i){i.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function Wv(i){i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function jd(i){Wv(i),i.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function sL(i){zv(i),i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}class rL extends Gv{constructor(){super(...arguments),this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(At.fromData(this.gl,(0,F.CS)(iL,7,1,Ut))),this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{const{rank:t}=this;this.defineShader(e),In(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),jd(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)}),this.boxCornerOffsetsBuffer=this.registerDisposer(At.fromData(this.gl,(0,F.CS)(Gd,3,1,mv))),this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{const{rank:t}=this;this.defineShader(e),Aa(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),jd(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Ba}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){const{gl:t}=this;this.enable(this.edgeShaderGetter,e,n=>{const s=n.attribute("aBoxCornerOffset1"),r=n.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(s,3,WebGL2RenderingContext.FLOAT,!1,28,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,4,WebGL2RenderingContext.FLOAT,!1,28,12),vn(n,e.renderContext.projectionParameters,1),mn(t,Hd,e.count),t.disableVertexAttribArray(s),t.disableVertexAttribArray(r)})}drawCorners(e){const{gl:t}=this;this.enable(this.cornerShaderGetter,e,n=>{const s=n.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(s,3,WebGL2RenderingContext.FLOAT,!1),Ma(n,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Na(n.gl,Bv,e.count),t.disableVertexAttribArray(s)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}class oL extends Gv{constructor(){super(...arguments),this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{const{rank:t}=this;super.defineShader(e),Va(e),In(e),e.addVarying("highp float","vClipCoefficient"),jd(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${Ut};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)}),this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{const{rank:t}=this;super.defineShader(e),Va(e),e.addVarying("highp float","vClipCoefficient"),sL(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,n){super.enable(e,t,s=>{const r=t.renderContext.sliceView.projectionParameters.value;zd(s,r.viewportNormalInGlobalCoordinates,r.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),n(s)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{pw(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{vn(t,e.renderContext.projectionParameters,1),mn(t.gl,6,e.count)})}}function aL(i,e){const t=i.length;for(let n=0;n<t;++n){const s=e[n],r=e[n+t],o=i[n];i[n]=Math.abs(s-o)<Math.abs(r-o)?s:r}}Xo(Re.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:oL,perspectiveViewRenderHelper:rL,defineShaderNoOpSetters(i){Wv(i),zv(i)},pickIdsPerInstance:nL,snapPosition(i,e,t,n){const s=i.length,r=new Float32Array(e,t,s*2);n>=Ba&&n<Pt?aL(i,r):n>=Pt&&n<Jd},getRepresentativePoint(i,e,t){t===Uv||t>=Ba&&t<Pt||t>=Pt&&t<Jd,i.set(e.pointA)},updateViaRepresentativePoint(i,e,t){const n=e.length,{pointA:s,pointB:r}=i,o=new Float32Array(n),a=new Float32Array(n);for(let l=0;l<n;++l){const c=o[l]=e[l];a[l]=r[l]+(c-s[l])}return{...i,pointA:o,pointB:a}}});/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Gs=0,Yd=Gs+1,lL=Yd+2;function Hv(i){i.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function Jv(i){i.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}class jv extends qo{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{const{rank:t}=this;this.defineShader(e),In(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),Hv(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{const{rank:t}=this;this.defineShader(e),Aa(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),Jv(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${mv};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){xi(e);const{rank:t}=this;Do(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,n){super.enable(e,t,s=>{const r=s.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);const{vertexIdHelper:o}=this;o.enable(),n(s),o.disable(),r.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{vn(t,e.renderContext.projectionParameters,1),mn(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Ma(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Na(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}}function cL(i,e){const t=i.length;(0,C._q)(i,e.subarray(0,t),e.subarray(t),i)}function dL(i,e,t){const n=i.length,s=n*t;for(let r=0;r<n;++r)i[r]=e[s+r]}Xo(Re.LINE,{sliceViewRenderHelper:jv,perspectiveViewRenderHelper:jv,defineShaderNoOpSetters(i){Hv(i),Jv(i)},pickIdsPerInstance:lL,snapPosition(i,e,t,n){const s=i.length,r=new Float32Array(e,t,s*2);n===Gs?cL(i,r):dL(i,r,n-Yd)},getRepresentativePoint(i,e,t){i.set(t===Gs||t===Yd?e.pointA:e.pointB)},updateViaRepresentativePoint(i,e,t){const n={...i},s=e.length;switch(t){case Gs:{const{pointA:r,pointB:o}=i,a=new Float32Array(s),l=new Float32Array(s);for(let c=0;c<s;++c){const d=a[c]=e[c];l[c]=o[c]+(d-r[c])}return{...i,pointA:a,pointB:l}}case Gs+1:return{...i,pointA:new Float32Array(e)};case Gs+2:return{...i,pointB:new Float32Array(e)}}return n}});/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yv extends qo{constructor(){super(...arguments),this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{xi(e),Aa(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)}),this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{xi(t),In(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)}),this.shaderGetter2d=this.makeShaderGetter2d(2),this.shaderGetter1d=this.makeShaderGetter2d(1),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl))}defineShaderCommon(e){const{rank:t}=this;Do(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,n){super.enable(e,t,s=>{const r=s.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);const{vertexIdHelper:o}=this;o.enable(),n(s),o.disable(),r.disable()})}draw(e){const{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,n=>{Ma(n,e.renderContext.projectionParameters,{featherWidthInPixels:1}),Na(n.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,n=>{vn(n,e.renderContext.projectionParameters,1),mn(n.gl,1,e.count)});break}}}Xo(Re.POINT,{sliceViewRenderHelper:Yv,perspectiveViewRenderHelper:Yv,defineShaderNoOpSetters(i){i.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(i,e,t){i.set(new Float32Array(e,t,i.length))},getRepresentativePoint(i,e){i.set(e.point)},updateViaRepresentativePoint(i,e){return{...i,point:new Float32Array(e)}}});/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qv=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,uL=[Qv,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`];function hL(i,e){const t=[[i[0],i[1],i[2]],[i[3],i[4],i[5]],[i[6],i[7],i[8]]];return{A:t[0][0],B:t[0][1]+t[1][0],C:t[1][1],D:-2*e[0]*t[0][0]-e[1]*(t[0][1]+t[1][0])+e[2]*(t[0][2]+t[2][0]),E:-e[0]*(t[0][1]+t[1][0])-2*e[1]*t[1][1]+e[2]*(t[1][2]+t[2][1]),F:e[0]*e[0]*t[0][0]+e[0]*e[1]*(t[0][1]+t[1][0])-e[0]*e[2]*(t[0][2]+t[2][0])+e[1]*e[1]*t[1][1]-e[1]*e[2]*(t[1][2]+t[2][1])+e[2]*e[2]*t[2][2]-1}}const pL=[Qv,`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function fL(i){const e=i.A,t=i.B/2,n=i.C,s=i.D,r=i.E,o=i.F,a=2*(t*t-e*n),l=(n*s-t*r)/a,c=(e*r-t*s)/a,d=1/(e*l*l+2*t*l*c+n*c*c-o),u=d*e,h=d*t,p=d*n,m=u+p,g=Math.sqrt((u-p)*(u-p)+4*h*h),v=(m+g)/2,y=(m-g)/2,S=1/Math.sqrt(v),w=1/Math.sqrt(y);let b;u>=p?b=C.Zc.fromValues(v-p,h):b=C.Zc.fromValues(h,v-u),C.Zc.normalize(b,b);const x=C.Zc.fromValues(-b[1],b[0]);return{k:C.Zc.fromValues(l,c),u1:b,u2:x,a:S,b:w,lambda1:v,lambda2:y,m11:u,m12:h,m22:p,valid:v>0&&y>0}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gL(i,e){const t=new Float32Array((i+1)*(e+1)*3);let n=0;for(let s=0;s<=i;++s){const r=s*Math.PI/i,o=Math.sin(r),a=Math.cos(r);for(let l=0;l<=e;++l){const c=l*2*Math.PI/e,d=Math.sin(c),u=Math.cos(c);t[n++]=u*o,t[n++]=a,t[n++]=d*o}}return t}function mL(i,e){const t=new Uint16Array(i*e*6);let n=0;for(let s=0;s<i;s++)for(let r=0;r<e;r++){const o=s*(e+1)+r,a=o+e+1;t[n++]=o,t[n++]=a,t[n++]=o+1,t[n++]=a,t[n++]=a+1,t[n++]=o+1}return t}class vL extends T.O8{constructor(e,t,n){super(),this.vertexBuffer=this.registerDisposer(ci(e,WebGL2RenderingContext.ARRAY_BUFFER,gL,t,n)).value,this.indexBuffer=this.registerDisposer(ci(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,mL,t,n)).value,this.numIndices=t*n*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){const n=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(n,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(n)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Kv=C.pB.create(),yL=!1;class qv extends qo{defineShader(e){const{rank:t}=this;Do(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,n){super.enable(e,t,s=>{const r=s.vertexShaderInputBinders.CenterAndRadii;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset),n(s),r.disable()})}}class SL extends qv{constructor(){super(...arguments),this.sphereRenderHelper=this.registerDisposer(new vL(this.gl,10,10)),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)}),this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{const{gl:n}=t,s=this.tempLightVec,{lightDirection:r,ambientLighting:o,directionalLighting:a}=e.renderContext;C.eR.scale(s,r,a),s[3]=o,n.uniform4fv(t.uniform("uLightDirection"),s),n.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,C.pB.transpose(C.pB.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class bL extends qv{constructor(){super(...arguments),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{xi(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(uL),e.addVertexCode(pL),e.addVertexCode(wc),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)}),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{const{gl:n}=t,s=e.renderContext.sliceView.projectionParameters.value,r=C.pB.multiply(Kv,e.renderSubspaceInvModelMatrix,s.invViewMatrix);n.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,r),n.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,s.projectionMat);const o=Kv;C.pB.invert(o,r),n.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);const{vertexIdHelper:a}=this;if(a.enable(),Ao(n,1,e.count),a.disable(),yL){const l=C.eR.fromValues(3406.98779296875,3234.910400390625,4045),c=C.eR.fromValues(10,10,10),d=C.w0.create();d[0]=1/(c[0]*c[0]),d[4]=1/(c[1]*c[1]),d[8]=1/(c[2]*c[2]);const u=C.w0.fromMat4(C.w0.create(),r),h=C.w0.multiply(C.w0.create(),C.w0.transpose(C.w0.create(),u),d);C.w0.multiply(h,h,u);const p=C.eR.transformMat4(C.eR.create(),l,o);console.log("Aviewport",h),console.log("cViewport",p);const m=hL(h,p),g=fL(m);console.log(m),console.log(g)}})}}Xo(Re.ELLIPSOID,{sliceViewRenderHelper:bL,perspectiveViewRenderHelper:SL,defineShaderNoOpSetters(i){i.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(i,e){i.set(e.center)},updateViaRepresentativePoint(i,e){return{...i,center:new Float32Array(e)}}});/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Xv=C.pB.create(),Zv=C.eR.create();function ey(i){i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}const CL={defineShader(i){ey(i),In(i),i.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),i.setVertexMain(`
int edgeIndex = gl_VertexID / ${Ut};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){vn(i,e,1)},draw(i,e,t){const{gl:n}=i,s=Xv,{chunkLayout:r}=e;C.pB.multiply(s,t.viewProjectionMat,r.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,s),n.uniform3fv(i.uniform("uChunkDataSize"),r.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const o=r.size,{curPositionInChunks:a,chunkDisplayDimensionIndices:l}=e,c=Zv;for(let d=0;d<3;++d){const u=l[d];c[d]=(u===-1?0:a[u])*o[d]}n.uniform3fv(i.uniform("uTranslation"),c),mn(n,Hd,1)}},wL={defineShader(i){Va(i),ey(i),In(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${Ut};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){vn(i,e,1)},draw(i,e,t){const{gl:n}=i,s=Xv,{chunkLayout:r}=e;C.pB.multiply(s,t.viewProjectionMat,r.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,s),n.uniform3fv(i.uniform("uChunkDataSize"),r.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const o=r.size,{curPositionInChunks:a,chunkDisplayDimensionIndices:l}=e,c=Zv;for(let d=0;d<3;++d){const u=l[d];c[d]=(u===-1?0:a[u])*o[d]}n.uniform3fv(i.uniform("uTranslation"),c),zd(i,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,r.transform,r.invTransform),mn(n,6,1)}};var xL=Object.defineProperty,EL=Object.getOwnPropertyDescriptor,TL=(i,e,t,n)=>{for(var s=n>1?void 0:n?EL(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&xL(e,t,s),s};/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const DL=C.pB.create();function IL(i){if(i!==void 0)return e=>{const{relatedSegments:t}=e;if(t===void 0)return!1;for(let n=0,s=t.length;n<s;++n){const r=i[n];if(r==null)continue;const{visibleSegments:o,segmentEquivalences:a}=r.segmentationGroupState.value;for(const l of t[n])if(o.has(a.get(l)))return!0}return!1}}function LL(i,e){const t=new oC(i.annotationPropertySerializers);for(const n of i)(e===void 0||e(n))&&t.add(n);return t.serialize()}let Qd=class extends ar(Dr){constructor(i,e,t,n){super(n),this.chunkManager=i,this.source=e,this.segmentationStates=t,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:e.rpcId,segmentationStates:this.serializeDisplayState()});const s=()=>{const r={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(qE,r)};this.registerDisposer(t.changed.add(s))}serializeDisplayState(){const{value:i}=this.segmentationStates;if(i!==void 0)return i.map(e=>e==null?e:jm(e.segmentationGroupState.value))}};Qd=TL([Zt(KE)],Qd);class RL extends T.O8{constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new fo,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new j.IY,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.segmentationStates=this.registerDisposer((0,_.Uq)((s,r)=>{const{displayState:o,source:a}=this.state,{relationshipStates:l}=o;return o.displayUnfiltered.value?void 0:a.relationships.map(c=>{const d=l.get(c);return d.showMatches.value?d.segmentationState.value:void 0})},[this.state.displayState.relationshipStates,this.state.displayState.ignoreNullSegmentFilter],(s,r)=>s===void 0||r===void 0?s===r:(0,F.r1)(s,r))),this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer((0,_.no)((s,r)=>{if(this.handleChangeAffectingBuffer(),r!==void 0)for(const o of r)o!=null&&s.registerDisposer((0,_.aM)((a,l)=>{a.registerDisposer(l.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),a.registerDisposer(l.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof hs||(this.sharedObject=this.registerDisposer(new Qd(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));const{displayState:n}=this.state;this.registerDisposer(n.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){const{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){const{source:e}=this;if(e instanceof hs){const t=e.changed.count;if(this.generation!==t){let{buffer:n}=this;n===void 0&&(n=this.buffer=this.registerDisposer(new At(this.chunkManager.gl))),this.generation=t;const s=this.serializedAnnotations=LL(e,IL(this.segmentationStates.value));n.setData(this.serializedAnnotations.data),this.numPickIds=hg(s)}}}}function ty(i){const{chunkTransform:e}=i,{unpaddedRank:t}=e.modelTransform,n=new Float32Array(t*2),s=new Float32Array(t*3);s.fill(0),n.fill(1,t);const{numChunkDisplayDims:r,chunkDisplayDimensionIndices:o}=i;for(let a=0;a<r;++a){const l=o[a];n[t+l]=0,s[l*3+a]=1}return{modelClipBounds:n,renderSubspaceTransform:s}}function ny(i,e,t){t.clearMessages();const n=l=>{t.addMessage({severity:Tn.error,message:l})};if(i.error!==void 0)return n(i.error);const s=Zh(i.modelTransform,e.displayDimensionIndices);let r;try{r=ep(i,s)}catch(l){return n(l.message)}const{modelClipBounds:o,renderSubspaceTransform:a}=ty(r);return{chunkTransform:i,chunkDisplayTransform:r,modelClipBounds:o,renderSubspaceTransform:a}}function Kd(i,e){class t extends i{constructor(s,r){super(),this.base=s,this.renderScaleHistogram=r,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;const o=s.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(const a of this.renderHelpers)a.dispose()}),this.role=s.state.role,this.registerDisposer(s.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(s.source.properties.changed.add(()=>{this.handleRankChanged(!0)})),this.handleRankChanged(),this.registerDisposer(this.base.state.displayState.shaderControls.histogramSpecifications.producerVisibility.add(this.visibility))}handleRankChanged(s=!1){const{rank:r}=this.base.source;if(!s&&r===this.curRank)return;this.curRank=r,this.tempChunkPosition=new Float32Array(r);const{renderHelpers:o,gl:a}=this;for(const d of o)d.dispose();const{properties:{value:l}}=this.base.source,{displayState:c}=this.base.state;for(const d of Xt){const u=Tr(d),h=u[e],p=o[d]=new h(a,d,r,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);p.pickIdsPerInstance=u.pickIdsPerInstance,p.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(s){super.attach(s),this.handleRankChanged();const{chunkTransform:r}=this,o=s.view.displayDimensionRenderInfo.value;s.state={chunkTransform:r,displayDimensionRenderInfo:o,chunkRenderParameters:ny(r,o,s.messages)}}updateAttachmentState(s){const r=s.state;this.handleRankChanged();const{chunkTransform:o}=this,a=s.view.displayDimensionRenderInfo.value;return r!==void 0&&r.chunkTransform===o&&r.displayDimensionRenderInfo===a?r.chunkRenderParameters:(r.chunkTransform=o,r.displayDimensionRenderInfo=a,r.chunkRenderParameters=ny(o,a,s.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(s,r){const{modelClipBounds:o}=r,a=this.curRank,{chunkTransform:l}=r;gs(o.subarray(0,a),s.projectionParameters.globalPosition,this.base.state.localPosition.value,l.layerRank,l.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(s,r,o,a=1){if(!s.bufferValid){let{buffer:l}=s;l===void 0&&(l=s.buffer=new At(this.gl));const{serializedAnnotations:c}=s;l.setData(c.data),s.numPickIds=hg(c),s.bufferValid=!0}this.drawGeometry(s,r,o,a)}drawGeometry(s,r,o,a=1){const{base:l}=this,{chunkDisplayTransform:c}=o,{serializedAnnotations:d}=s,{typeToIdMaps:u,typeToOffset:h}=d;let p=0;r.emitPickID&&(p=r.pickIDs.register(this,s.numPickIds,0,0,s));const m=l.hoverState.value,g=C.pB.multiply(DL,r.projectionParameters.viewProjectionMat,c.displaySubspaceModelMatrix),v={annotationLayer:l,renderContext:r,selectedIndex:0,basePickId:p,buffer:s.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:g,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:c.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:c.displaySubspaceInvModelMatrix,chunkDisplayTransform:c},y=this.base.state.displayState.shaderControls.histogramSpecifications.visibleHistograms>0;for(const S of Xt){const w=u[S];let b=w.size;if(b>0){const x=Tr(S);let E=4294967295;if(m!==void 0){const I=w.get(m.id);I!==void 0&&(E=I*x.pickIdsPerInstance)}b=Math.round(b*a),v.count=b,v.bufferOffset=h[S],v.selectedIndex=E;const D=this.renderHelpers[S];D.draw(v),y&&(D.computeHistograms(v,r.frameNumber),r.bindFramebuffer()),v.basePickId+=b*x.pickIdsPerInstance}}}updateMouseState(s,r,o,a){const l=a,{serializedAnnotations:c}=l,{typeToIds:d,typeToOffset:u}=c,h=this.curRank,p=this.chunkTransform;if(p.error===void 0)for(const m of Xt){const g=d[m],v=Tr(m),{pickIdsPerInstance:y}=v;if(o<g.length*y){const S=Math.floor(o/y),w=g[S],b=o%y;s.pickedAnnotationId=w,s.pickedAnnotationLayer=this.base.state,s.pickedOffset=b,s.pickedAnnotationBuffer=c.data.buffer,s.pickedAnnotationType=m,s.pickedAnnotationBufferBaseOffset=c.data.byteOffset+u[m],s.pickedAnnotationIndex=S,s.pickedAnnotationCount=g.length;const x=this.tempChunkPosition,{chunkToLayerTransform:E,combinedGlobalLocalToChunkTransform:D,layerRank:I}=p,{globalToRenderLayerDimensions:L}=p.modelTransform,{position:N}=s;if(!gs(x,N,this.base.state.localPosition.value,I,D))return;const k=this.base.source.annotationPropertySerializers[m];v.snapPosition(x,s.pickedAnnotationBuffer,s.pickedAnnotationBufferBaseOffset+s.pickedAnnotationIndex*k.propertyGroupBytes[0],b);const O=L.length;for(let V=0;V<O;++V){const z=L[V];if(z===-1)continue;let Y=E[(h+1)*h+z];for(let Q=0;Q<h;++Q)Y+=x[Q]*E[Q*(I+1)+z];Number.isFinite(Y)&&(N[V]=Y)}return}o-=g.length*y}}transformPickedValue(s){const{pickedAnnotationBuffer:r}=s;if(r===void 0)return;const{properties:{value:o}}=this.base.source;if(o.length===0)return;const{pickedAnnotationBufferBaseOffset:a,pickedAnnotationType:l,pickedAnnotationIndex:c,pickedAnnotationCount:d}=s,{annotationPropertySerializers:u}=this.base.source,h=new Array(o.length);return u[l].deserialize(new DataView(r),a,c,d,U.LITTLE===te,h),Qb(o[0],h[0])}}return t}const iy=i=>class extends i{constructor(){super(...arguments),this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,n){const s=this.updateAttachmentState(n);if(this.curRank===0||s===void 0)return;this.updateModelClipBounds(t,s);const{source:r}=this.base;if(r instanceof hs){const{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,s)}else{const{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(r.temporary.data,t,s);const{value:a}=this.base.segmentationStates;let l=0,c=0;if(a!==void 0)for(let d=0,u=a.length;d<u;++d){const h=a[d];if(h==null)continue;const p=r.segmentFilteredSources[d].chunks;Rs(h.segmentationGroupState.value,m=>{const g=Sn(m),v=p.get(g);if(v!==void 0&&v.state===Ue.GPU_MEMORY){const{data:y}=v;if(y===void 0)return;this.drawGeometryChunkData(y,t,s),++l}else++c})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,l,c)}}isReady(){const{base:t}=this,{source:n}=t;if(!(n instanceof Rr))return!0;const{value:s}=this.base.segmentationStates;if(s===void 0)return!0;for(let r=0,o=s.length;r<o;++r){const a=s[r];if(a===null)return!1;if(a===void 0)continue;const l=n.segmentFilteredSources[r].chunks;let c=!1;if(Rs(a.segmentationGroupState.value,d=>{const u=Sn(d);l.has(u)||(c=!0)}),c)return!1}return!0}},sy=Kd(Gi,"perspectiveViewRenderHelper");class kL extends iy(sy){}const ry=i=>{class e extends i{constructor(n){super(n.annotationLayer,n.renderScaleHistogram),this.wireFrameRenderHelper=this instanceof Fi?wL:CL,this.wireFrameShaderGetter=Ai(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof Fi}`,parameters:(0,_.XZ)(void 0),defineShader:o=>{this.wireFrameRenderHelper.defineShader(o)}}),this.renderScaleTarget=n.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));const s=this.registerDisposer(new Dr(this.layerChunkProgressInfo)),r=this.base.chunkManager.rpc;s.RPC_TYPE_ID=YE,s.initializeCounterpart(r,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(ft.makeFromExisting(r,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(ft.makeFromExisting(r,this.renderScaleTarget)).rpcId}),this.backend=s}attach(n){super.attach(n),n.state.sources=n.registerDisposer((0,_.no)((s,r,o)=>{const a=sa(o,r,l=>this.base.state.source.getSources(l),n.messages,this);for(const l of a)for(const c of l)s.registerDisposer(c.source),Object.assign(c,ty(c.chunkDisplayTransform));return n.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(QE,{layer:this.backend.rpcId,view:n.view.rpcId,displayDimensionRenderInfo:o,sources:ta(a)}),this.redrawNeeded.dispatch(),a},this.base.state.transform,n.view.displayDimensionRenderInfo))}draw(n,s){const r=this.updateAttachmentState(s);if(this.curRank===0||r===void 0)return;const o=s.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(n,r);const{renderScaleHistogram:a}=this;a.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const{projectionParameters:l}=n;let c;if(n.wireFrame){const{shader:d}=this.wireFrameShaderGetter(n.emitter);if(d===null)return;d.bind(),this.wireFrameRenderHelper.initialize(d,l),c=d}ng(l,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(d,u,h,p,m)=>{const g=d.source.chunks.get(d.curPositionInChunks.join());let v;if(g===void 0||g.state!==Ue.GPU_MEMORY)v=0;else{const{data:y}=g;if(y===void 0)return;c!==void 0?this.wireFrameRenderHelper.draw(c,d,l):this.drawGeometryChunkData(y,n,r,h),v=1}a.add(p,m,v,1-v)})}isReady(n,s){const r=this.updateAttachmentState(s);if(this.curRank===0||r===void 0)return;const o=s.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(n,r);const{projectionParameters:a}=n;let l=!0;return ng(a,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(c,d,u,h,p)=>{const m=c.source.chunks.get(c.curPositionInChunks.join());if(m===void 0||m.state!==Ue.GPU_MEMORY){l=!1;return}}),l}}return e},PL=ry(sy),AL=ry(Kd(Fi,"sliceViewRenderHelper")),ML=iy(Kd(Fi,"sliceViewRenderHelper"));var Fa=G(4499);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qd(i={}){return Ne({svg:Fa,...i})}var NL=G(1252);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mn(i={}){const e=Ne({svg:NL,...i}),t=e.firstElementChild;return t.style.fill="white",e}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oy=10,Ua=.5;class OL{constructor(){this.anchorIndex=0,this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,n=0;for(const s of e){if(n+=s.retainCount,t<n)break;const{deleteCount:r}=s;if(t<n+r){t=n;break}const{insertCount:o}=s;t=t-r+o,n+=o-o}this.anchorIndex=t}}class ay{constructor(){this.startIndex=0,this.endIndex=0,this.anchorIndex=0,this.anchorOffset=0,this.scrollOffset=0,this.viewportWidth=0}}class _L{constructor(){this.itemSize=[],this.totalKnownSize=0,this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){return this.itemSize[e]??this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,n=0){for(;t<e;++t)n+=this.getEstimatedSize(t);for(;t>e;--t)n-=this.getEstimatedSize(t-1);return n}getRangeSize(e,t){let n=0;const{itemSize:s,averageSize:r}=this;for(let o=e;o<t;++o)n+=s[o]??r;return n}splice(e){let{itemSize:t}=this;t=this.itemSize=(0,F.eL)(t,e),this.totalKnownSize=t.reduce((n,s)=>n+s,0),this.numItemsInTotalKnownSize=t.reduce(n=>n+1,0)}}function VL(i,e,t,n,s,r){const{anchorIndex:o,anchorClientOffset:a}=r,l=s.getEstimatedOffset(o);let c,d,u,h,p;if(n===0||s.totalKnownSize===0)c=Math.max(0,o-oy/2),d=Math.min(t,c+oy),p=o,u=0,h=a;else{const m=s.getEstimatedTotalSize(),g=Math.max(0,m-n);h=l-a,h=Math.max(0,Math.min(g,h));const v=h-2*Ua*n,y=h-Ua*n,S=h+n+Ua*n,w=l-a+n+2*Ua*n;c=Math.min(t,e.startIndex);let b=s.getEstimatedOffset(c,o,l);if(b<v)for(;c+1<t;++c){const E=s.getEstimatedSize(c);if(b+E>=y)break;b+=E}if(b>=y)for(;b>v&&c>0;--c){const E=s.getEstimatedSize(c-1);b-=E}d=Math.min(t,e.endIndex);let x=s.getEstimatedOffset(d,o,l);if(x<S)for(;x<=w&&d+1<=t;++d){const E=s.getEstimatedSize(d);x+=E}else if(x>=w)for(;d>c;--d){const E=s.getEstimatedSize(d-1);if(x-E<S)break;x-=E}for(p=o,u=l;p<c;++p){const E=s.getEstimatedSize(p);u+=E}for(;p>d;--p){const E=s.getEstimatedSize(p-1);u-=E}}i.startIndex=c,i.endIndex=d,i.anchorIndex=p,i.anchorOffset=u,i.scrollOffset=h}function BL(i,e){const t=e.getEstimatedOffset(i.anchorIndex),n=i.anchorOffset;i.anchorOffset=t,i.scrollOffset+=t-n}function FL(i,e){return i.startIndex<e.startIndex||i.endIndex>e.endIndex||i.viewportWidth!==0&&e.viewportWidth===0}class Wr extends T.O8{constructor(e){super(),this.element=document.createElement("div"),this.scrollContent=document.createElement("div"),this.header=document.createElement("div"),this.body=document.createElement("div"),this.topItems=document.createElement("div"),this.bottomItems=document.createElement("div"),this.renderedItems=[],this.renderGeneration=-1,this.listGeneration=-1,this.newRenderedItems=[],this.state=new OL,this.renderParams=new ay,this.newRenderParams=new ay,this.sizes=new _L,this.debouncedUpdateView=this.registerCancellable((0,Qe.t)(()=>this.updateView())),this.resizeObserver=new ResizeObserver(()=>this.updateView());const{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);const n=this.source=e.source;this.sizes.itemSize.length=n.length;const{element:s,header:r,body:o,scrollContent:a,topItems:l,bottomItems:c}=this;this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.disconnect()),s.appendChild(a),s.style.overflowAnchor="none",a.appendChild(r),a.appendChild(o),r.style.position="sticky",r.style.zIndex="1",r.style.top="0",e.horizontalScroll?(a.style.width="min-content",a.style.minWidth="100%",r.style.width="min-content",r.style.minWidth="100%",c.style.width="min-content",c.style.minWidth="100%"):(a.style.width="100%",r.style.width="100%",c.style.width="100%"),o.appendChild(l),o.appendChild(c),l.style.width="min-content",l.style.position="relative",l.style.height="0",l.style.minWidth="100%",c.style.height="0",c.style.position="relative",s.addEventListener("scroll",()=>{const d=s.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-d,this.renderParams.scrollOffset=d,this.debouncedUpdateView()}),n.changed!==void 0&&this.registerDisposer(n.changed.add(d=>{this.sizes.splice(d),this.state.splice(d),this.renderedItems.length=0,this.debouncedUpdateView()})),n.renderChanged!==void 0&&this.registerDisposer(n.renderChanged.add(this.debouncedUpdateView))}updateView(){const{element:e}=this,t=e.clientHeight-this.header.offsetHeight,n=e.clientWidth,{source:s,state:r,sizes:o}=this,a=s.length,{body:l,topItems:c,bottomItems:d}=this,{changed:u,renderChanged:h}=s;let p;for(;;){p=this.newRenderParams;const v=this.renderParams;VL(p,v,a,t,o,r),p.viewportWidth=n;let y;if(h!==void 0&&h.count!==this.renderGeneration||u!==void 0&&u.count!==this.listGeneration?(this.renderGeneration=h===void 0?-1:h.count,this.listGeneration=u===void 0?-1:u.count,y=!0,this.renderedItems.length=0):y=!1,!y&&!FL(p,v)){v.scrollOffset=p.scrollOffset,p=v;break}this.renderParams=p,this.newRenderParams=v;const S=this.renderedItems,w=this.newRenderedItems;w.length=0,this.renderedItems=w,this.newRenderedItems=S;const{source:b}=this,{render:x}=b,{startIndex:E,endIndex:D,anchorIndex:I}=p;function*L(N,k){for(let O=N;O<k;++O){let V=S[O];V===void 0&&(V=x.call(b,O)),w[O]=V,yield V}}nn(c,L(E,I)),nn(d,L(I,D));for(let N=E;N<D;++N){const V=w[N].getBoundingClientRect().height,z=o.itemSize[N];z!==void 0&&(o.totalKnownSize-=z,--o.numItemsInTotalKnownSize),o.itemSize[N]=V,o.totalKnownSize+=V,++o.numItemsInTotalKnownSize}}BL(p,o),r.anchorIndex=p.anchorIndex,r.anchorClientOffset=p.anchorOffset-p.scrollOffset;const m=o.getRangeSize(p.startIndex,p.anchorIndex),g=o.getEstimatedTotalSize()||0;l.style.height=`${g}px`,c.style.top=`${p.anchorOffset-m}px`,d.style.top=`${p.anchorOffset}px`,e.scrollTop=p.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){const{startIndex:t,endIndex:n}=this.renderParams,{renderedItems:s}=this;for(let r=t;r<n;++r){const o=s[r];o!==void 0&&e(o,r)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){const t=this.sizes.getEstimatedOffset(e),n=t+this.sizes.getEstimatedSize(e),s=this.element.scrollTop;if(t<s)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>s&&n>s+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){at(this.element)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ly extends T.O8{constructor(){super(...arguments),this.changed=new j.IY,this.isLoadingChanged=new j.IY,this.states=[],this.relationships=[],this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount===0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{const n=e.sourceIndex-t.sourceIndex;return n!==0?n:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){const e=new Set;for(const t of this.states)for(const n of t.source.relationships)e.add(n);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{const t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function UL(i,e){switch(e.type){case Re.AXIS_ALIGNED_BOUNDING_BOX:case Re.LINE:i.set(e.pointA);break;case Re.POINT:i.set(e.point);break;case Re.ELLIPSOID:i.set(e.center);break}}function $L(i,e){switch(e.type){case Re.AXIS_ALIGNED_BOUNDING_BOX:case Re.LINE:Ah(i,e.pointA,e.pointB),dC(i,i,.5);break;case Re.POINT:i.set(e.point);break;case Re.ELLIPSOID:i.set(e.center);break}}function cy(i,e,t){e.error===void 0&&i.setLayerPosition(e.modelTransform,t)}function dy(i,e,t){const{layerRank:n}=e,s=new Float32Array(n);Ft[i.type].visitGeometry(i,(r,o)=>{s.set(r);const a=new Float32Array(n);(o?De._U:De.vo)(a,e.chunkToLayerTransform,n+1,s,n),t(a,o)})}const uy=(i,e,t)=>{const n=t.chunkTransform.value,{layerRank:s}=n,r=new Float32Array(s),o=new Float32Array(s);UL(r,e),De.vo(o,n.chunkToLayerTransform,s+1,r,s),cy(i,n,o),t.displayState.swapVisibleSegmentsOnMove.value&&GL(e,t,!0)},GL=(i,e,t=!1)=>{const{relatedSegments:n}=i;if(n){const{source:s,displayState:r}=e,{relationships:o}=s,{relationshipStates:a}=r;for(let l=0,c=o.length;l<c;++l){const d=a.get(o[l]).segmentationState.value;if(d){t&&d.segmentationGroupState.value.visibleSegments.clear();for(const u of n)d.segmentationGroupState.value.visibleSegments.add(u)}}}};class hy extends Gt{constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:h=>this.render(h),changed:new j.HN},this.virtualList=new Wr({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new Map,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.selectedAnnotationState=(0,_.ol)((h,p)=>{if(h===void 0)return;const{layer:m}=this,g=h.layers.find(S=>S.layer===m)?.state;if(g===void 0)return;const{annotationId:v}=g;if(v===void 0)return;const y=this.annotationStates.states.find(S=>S.sourceIndex===g.annotationSourceIndex&&(g.annotationSubsource===void 0||S.subsourceId===g.annotationSubsource));if(y!==void 0)return{annotationId:v,annotationLayerState:y,pin:p}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin),this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(this.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");const n=document.createElement("div");n.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);const s=this.registerDisposer(new hi(this.displayState.color));s.element.title="Change annotation display color",this.registerDisposer(new en((0,_.ol)(h=>h.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),s.element)),n.appendChild(s.element);const{mutableControls:r}=this,o=Ne({text:Ft[Re.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new yy(this.layer,{})}});r.appendChild(o);const a=Ne({text:Ft[Re.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Xd(this.layer,{})}});r.appendChild(a);const l=Ne({text:Ft[Re.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new Ga(this.layer,{})}});r.appendChild(l);const c=Ne({text:Ft[Re.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new Cy(this.layer,{})}});r.appendChild(c),n.appendChild(r),this.element.appendChild(n),this.element.appendChild(this.headerRow);const{virtualList:d}=this;d.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(d.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});const u=Im();this.registerDisposer(new tn(this.virtualList.element,u)),this.virtualList.element.title=u.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){const e=this.annotationStates.states,{attachedAnnotationStates:t}=this,n=new Map;for(const[s,r]of t)e.includes(s)||(t.delete(s),r.refCounted.dispose());for(const s of e){const r=t.get(s);if(r!==void 0){n.set(s,r);continue}const o=s.source,a=new T.O8;o instanceof hs&&(a.registerDisposer(o.childAdded.add(l=>this.addAnnotationElement(l,s))),a.registerDisposer(o.childUpdated.add(l=>this.updateAnnotationElement(l,s))),a.registerDisposer(o.childDeleted.add(l=>this.deleteAnnotationElement(l,s)))),a.registerDisposer(s.transform.changed.add(this.forceUpdateView)),n.set(s,{refCounted:a,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=n,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){const e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,n=[],s=[];for(let r=0,o=t.rank;r<o;++r)this.annotationStates.states.some(a=>{const l=a.transform.value;return l.error!==void 0?!1:l.globalToRenderLayerDimensions[r]!==-1})&&n.push(r);for(let r=0,o=e.rank;r<o;++r)this.annotationStates.states.some(a=>{const l=a.transform.value;return l.error!==void 0?!1:l.localToRenderLayerDimensions[r]!==-1})&&s.push(r);(!(0,F.r1)(n,this.globalDimensionIndices)||!(0,F.r1)(s,this.localDimensionIndices))&&(this.localDimensionIndices=s,this.globalDimensionIndices=n,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,n=!1){const s=this.attachedAnnotationStates.get(e);if(s===void 0)return;const r=s.idToIndex.get(t);if(r===void 0)return;const o=s.listOffset+r;return n&&this.virtualList.scrollItemIntoView(r),this.virtualList.getItemElement(o)}clearSelectionClass(){const{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;const t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){const{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;const n=this.getRenderedAnnotationListElement(t,e);n!==void 0&&n.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){const e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;const n=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);n!==void 0&&n.classList.add("neuroglancer-annotation-selected")}updateHoverView(){const e=this.displayState.hoverState.value;let t,n;e!==void 0&&(t=e.id,n=e.annotationLayerState);const{previousHoverId:s,previousHoverAnnotationLayerState:r}=this;if(t===s&&n===r||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=n,t===void 0))return;const o=this.getRenderedAnnotationListElement(n,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){const{annotation:t,state:n}=this.listElements[e],{layer:s,gridTemplate:r,globalDimensionIndices:o,localDimensionIndices:a}=this,[l,c]=xy(s,t,n,r,o,a);for(const[u,h]of c.entries())this.setColumnWidth(u,h);l.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:t.id,partIndex:0,annotationLayerState:n}});const d=this.selectedAnnotationState.value;return d!==void 0&&d.annotationLayerState===n&&d.annotationId===t.id&&l.classList.add("neuroglancer-annotation-selected"),l}setColumnWidth(e,t){t+=2;const{columnWidths:n}=this;n[e]>t||(n[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;const{columnWidths:s}=this;s.length=0;const{headerRow:r}=this,o=document.createElement("div");o.style.gridColumn="symbol";const a=document.createElement("div");a.style.gridColumn="delete",Me(r),r.appendChild(o);let l=0,c="[symbol] 2ch";const d=(p,m)=>{const g=document.createElement("div");g.classList.add("neuroglancer-annotations-view-dimension");const v=document.createElement("span");v.classList.add("neuroglancer-annotations-view-dimension-name"),v.textContent=p.names[m];const y=document.createElement("scale");y.classList.add("neuroglancer-annotations-view-dimension-scale"),y.textContent=Ri(p.scales[m],p.units[m],{precision:2}),g.appendChild(v),g.appendChild(y),g.style.gridColumn=`dim ${l+1}`,this.setColumnWidth(l,y.textContent.length+v.textContent.length+3),c+=` [dim] var(--neuroglancer-column-${l}-width)`,++l,r.appendChild(g)},u=this.layer.manager.root.coordinateSpace.value;for(const p of this.globalDimensionIndices)d(u,p);const h=this.layer.localCoordinateSpace.value;for(const p of this.localDimensionIndices)d(h,p);r.appendChild(a),c+=" [delete] 2ch",this.gridTemplate=c,r.style.gridTemplateColumns=c,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1;const{listElements:t}=this;t.length=0;for(const[s,r]of this.attachedAnnotationStates){if(s.source.readonly||(e=!0),s.chunkTransform.value.error!==void 0)continue;const{source:o}=s,a=Array.from(o);r.annotations=a;const{idToIndex:l}=r;l.clear();for(let c=0,d=a.length;c<d;++c)l.set(a[c].id,c);for(const c of a)t.push({state:s,annotation:c})}const n=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:n,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(const t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const s=n.annotations.length;n.annotations.push(e),n.idToIndex.set(e.id,s);const r=n.listOffset+s;this.listElements.splice(r,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const s=n.idToIndex.get(e.id);if(s!==void 0){const r=n.listOffset+s;n.annotations[s]=e,this.listElements[r].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const{idToIndex:s}=n,r=s.get(e);if(r!==void 0){const o=n.listOffset+r,{annotations:a}=n;a.splice(r,1),s.delete(e);for(let l=r,c=a.length;l<c;++l)s.set(a[l].id,l);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}}class zL extends Gt{constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new hy(this.layer,this.layer.annotationDisplayState));const{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function $a(i,e=!1){const t=[],{relationships:n}=i.source,{relationshipStates:s}=i.displayState;for(let r=0,o=n.length;r<o;++r){const a=s.get(n[r]).segmentationState.value;if(a!=null&&a.segmentSelectionState.hasSelectedSegment){t[r]=[a.segmentSelectionState.selectedSegment.clone()],e&&(t[r]=[...t[r],a.segmentSelectionState.baseSelectedSegment.clone()]);continue}t[r]=[]}return t}class py extends Df{constructor(e,t){super(e)}get annotationLayer(){for(const e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}const fy="annotatePoint",gy="annotateLine",my="annotateBoundingBox",vy="annotateSphere";class yy extends py{trigger(e){const{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){const n=Hr(e,t);if(n===void 0)return;const s={id:"",description:"",relatedSegments:$a(t),point:n,type:Re.POINT,properties:t.source.properties.value.map(o=>o.default)},r=t.source.add(s,!0);this.layer.selectAnnotation(t,r.id,!0),r.dispose()}}get description(){return"annotate point"}toJSON(){return fy}}function Hr(i,e){const t=e.chunkTransform.value;if(t.error!==void 0)return;const n=new Float32Array(t.modelTransform.unpaddedRank);if(gs(n,i.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return n}class Sy extends py{constructor(){super(...arguments),this.inProgressAnnotation=new _.B0(void 0)}trigger(e){const{annotationLayer:t,inProgressAnnotation:n}=this;if(t!==void 0&&e.updateUnconditionally()){const s=()=>{const r=n.value,o=r.reference,a=this.getUpdatedAnnotation(o.value,e,t);JSON.stringify(_l(a,t.source))!==JSON.stringify(_l(o.value,t.source))&&(r.annotationLayer.source.update(o,a),this.layer.selectAnnotation(t,o.id,!0))};if(n.value===void 0){const r=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,r.id,!0);const o=e.changed.add(s),a=()=>{o(),r.dispose()};n.value={annotationLayer:t,reference:r,disposer:a}}else{s();const r=n.value;r.annotationLayer.source.commit(r.reference),r.disposer(),n.value=void 0}}}disposed(){this.deactivate(),super.disposed()}deactivate(){const e=this.inProgressAnnotation.value;e!==void 0&&(e.annotationLayer.source.delete(e.reference),e.disposer(),this.inProgressAnnotation.value=void 0)}}class by extends Sy{getInitialAnnotation(e,t){const n=Hr(e,t);return{id:"",type:this.annotationType,description:"",pointA:n,pointB:n,properties:t.source.properties.value.map(s=>s.default)}}getUpdatedAnnotation(e,t,n){const s=Hr(t,n);return s===void 0?e:{...e,pointB:s}}}class Xd extends by{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,n){const s=super.getUpdatedAnnotation(e,t,n),{pointA:r,pointB:o}=s,a=r.length;for(let l=0;l<a;++l)r[l]===o[l]&&(o[l]+=1);return s}toJSON(){return my}}Xd.prototype.annotationType=Re.AXIS_ALIGNED_BOUNDING_BOX;class Ga extends by{constructor(){super(...arguments),this.getBaseSegment=!1}get description(){return"annotate line"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=$a(t,this.getBaseSegment),n}getUpdatedAnnotation(e,t,n){const s=super.getUpdatedAnnotation(e,t,n),r=this.initialRelationships,o=$a(n,this.getBaseSegment);return r===void 0?s.relatedSegments=o:s.relatedSegments=Array.from(o,(a,l)=>{const c=r[l];return a=a.filter(d=>c.findIndex(u=>P.R.equal(d,u))===-1),[...c,...a]}),s}toJSON(){return gy}}Ga.prototype.annotationType=Re.LINE;class Cy extends Sy{getInitialAnnotation(e,t){const n=Hr(e,t);return{type:Re.ELLIPSOID,id:"",description:"",segments:$a(t),center:n,radii:C.eR.fromValues(0,0,0),properties:t.source.properties.value.map(s=>s.default)}}getUpdatedAnnotation(e,t,n){const s=Hr(t,n);if(s===void 0)return e;const r=e.center,o=r.length;for(let a=0;a<o;++a)s[a]=Math.abs(r[a]-s[a]);return{...e,radii:s}}get description(){return"annotate ellipsoid"}toJSON(){return vy}}Cr(fy,(i,e)=>new yy(i,e)),Cr(my,(i,e)=>new Xd(i,e)),Cr(gy,(i,e)=>new Ga(i,e)),Cr(vy,(i,e)=>new Cy(i,e));const WL=Ae.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function HL(i,e,t,n){return new Wt(t,(s,r,o)=>{const a=document.createElement("div");a.classList.add("neuroglancer-related-segment-list"),s!=null&&o.registerDisposer($r(s,a));const l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list-header");const c=Hn({title:"Copy segment IDs",onClick:()=>{mi(e.map(m=>m.toString()).join(", "))}});l.appendChild(c);let d;if(s!=null&&(d=document.createElement("input"),d.type="checkbox",d.addEventListener("change",()=>{const{visibleSegments:m}=s.segmentationGroupState.value,g=e.some(v=>!m.has(v));for(const v of e)m.set(v,g)}),l.appendChild(d)),n!==void 0){const m=Mn({title:"Remove all IDs",onClick:()=>{n([])}});l.appendChild(m)}const u=document.createElement("span");if(u.classList.add("neuroglancer-related-segment-list-title"),u.textContent=i,l.appendChild(u),n!==void 0){const m=qd({title:"Add related segment ID",onClick:()=>{const g=new T.O8,v=o.registerDisposer((0,T.K9)(g)),y=document.createElement("div");y.classList.add("neuroglancer-segment-list-entry"),y.classList.add("neuroglancer-segment-list-entry-new");const S=Hn({});if(S.classList.add("neuroglancer-segment-list-entry-copy"),y.appendChild(S),s!=null){const D=document.createElement("input");D.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),D.type="checkbox",y.appendChild(D)}const w=Mn({title:"Cancel adding new segment ID",onClick:()=>{v()}});w.classList.add("neuroglancer-segment-list-entry-delete"),y.appendChild(w);const b=document.createElement("input");b.autocomplete="off",b.spellcheck=!1,b.classList.add("neuroglancer-segment-list-entry-id");const x=g.registerDisposer(new yn(b,WL));x.allShortcutsAreGlobal=!0;const E=()=>{const D=new P.R;if(D.tryParseString(b.value))return b.dataset.valid="true",D;b.dataset.valid="false"};E(),b.addEventListener("input",()=>{E()}),b.addEventListener("blur",()=>{const D=E();D!==void 0&&n([...e,D]),v()}),Z(b,"cancel",v),Z(b,"commit",()=>{const D=E();D!==void 0&&n([...e,D]),v()}),y.appendChild(b),a.appendChild(y),b.focus(),g.registerDisposer(()=>{b.value="",y.remove()})}});l.appendChild(m)}a.appendChild(l);const h=[],p=Vs.make(s??void 0,!1);for(const m of e){const g=p.get(m);if(h.push(g),n!==void 0){const v=Mn({title:"Remove ID",onClick:y=>{n(e.filter(S=>!P.R.equal(S,m))),y.stopPropagation()}});v.classList.add("neuroglancer-segment-list-entry-delete"),g.children[0].appendChild(v)}a.appendChild(g)}if(s!=null){const m=o.registerCancellable((0,Qe.t)(()=>{const{visibleSegments:g}=s.segmentationGroupState.value;let v=0;for(const y of e)g.has(y)&&++v;for(const y of h)p.update(y);d.checked=v===e.length&&v>0,d.indeterminate=v>0&&v<e.length}));m(),m.flush(),Bs(s,o,m),o.registerDisposer(s.segmentationGroupState.changed.add(m))}r.appendChild(a)})}const wy="annotationColor";function Zd(i){class e extends i{constructor(...n){super(...n),this.annotationStates=this.registerDisposer(new ly),this.annotationDisplayState=new Yf,this.annotationCrossSectionRenderScaleHistogram=new Ps,this.annotationCrossSectionRenderScaleTarget=Bi(8),this.annotationProjectionRenderScaleHistogram=new Ps,this.annotationProjectionRenderScaleTarget=Bi(8),this.changeSelectedIndex=a=>{const l=this.manager.root.selectionState.value;if(l===void 0)return;const c=l.layers.find(v=>v.layer===this)?.state;if(c===void 0)return;const{annotationId:d}=c;if(d===void 0)return;let u=this.annotationStates.states.find(v=>v.sourceIndex===c.annotationSourceIndex&&(c.annotationSubsource===void 0||v.subsourceId===c.annotationSubsource));if(u===void 0)return;let h=this.annotationStates.states.indexOf(u),{source:p}=u,m=Array.from(p),g=m.findIndex(v=>v.id===d);for(;;){if(g=g+a,g===-1)h-=1;else if(g===m.length)h+=1;else{const v=m[g];this.selectAnnotation(u,v.id,!0),uy(this,v,u);return}if(u=this.annotationStates.states[h],u===void 0)return;p=u.source,m=Array.from(p),g=g===-1?m.length:0}},this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new zL(this)});let s;const r=()=>{const a=this.isReady;a&&s!==void 0?(s(),s=void 0):!a&&s===void 0&&(s=this.annotationStates.markLoading())};this.readyStateChanged.add(r),r();const{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){const{pickedAnnotationLayer:a}=o;if(a!==void 0&&this.annotationStates.states.includes(a)){const l=this.annotationDisplayState.hoverState.value;(l===void 0||l.id!==o.pickedAnnotationId||l.partIndex!==o.pickedOffset||l.annotationLayerState!==a)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:a});return}}this.annotationDisplayState.hoverState.value=void 0})),this.registerDisposer(this.registerLayerEvent("select-previous",()=>{this.changeSelectedIndex(-1)})),this.registerDisposer(this.registerLayerEvent("select-next",()=>{this.changeSelectedIndex(1)}))}initializeAnnotationLayerViewTab(n){}restoreState(n){super.restoreState(n),this.annotationDisplayState.color.restoreState(n[wy])}captureSelectionState(n,s){super.captureSelectionState(n,s);const r=s.pickedAnnotationLayer;r===void 0||!this.annotationStates.states.includes(r)||(n.annotationId=s.pickedAnnotationId,n.annotationType=s.pickedAnnotationType,n.annotationBuffer=new Uint8Array(s.pickedAnnotationBuffer,s.pickedAnnotationBufferBaseOffset),n.annotationIndex=s.pickedAnnotationIndex,n.annotationCount=s.pickedAnnotationCount,n.annotationPartIndex=s.pickedOffset,n.annotationSourceIndex=r.sourceIndex,n.annotationSubsource=r.subsourceId)}displayAnnotationState(n,s,r){if(n.annotationId===void 0)return!1;const o=this.annotationStates.states.find(l=>l.sourceIndex===n.annotationSourceIndex&&l.subsubsourceId===n.annotationSubsubsourceId&&(n.annotationSubsource===void 0||l.subsourceId===n.annotationSubsource));if(o===void 0)return!1;const a=r.registerDisposer(o.source.getReference(n.annotationId));return s.appendChild(r.registerDisposer(new Wt(r.registerDisposer(new _.wP(()=>({annotation:a,chunkTransform:o.chunkTransform}))),({annotation:l,chunkTransform:c},d,u)=>{let h;if(l==null)if(n.annotationType!==void 0&&n.annotationBuffer!==void 0){const p=Ft[n.annotationType],m=o.source.rank,g=p.serializedBytes(m),v=n.annotationBuffer.byteOffset,y=new DataView(n.annotationBuffer.buffer),S=U.LITTLE===te,{properties:w}=o.source,b=new Eh(m,g,w.value),x=n.annotationIndex,E=n.annotationCount;l=p.deserialize(y,v+b.propertyGroupBytes[0]*x,S,m,n.annotationId),b.deserialize(y,v,x,E,S,l.properties=new Array(w.value.length)),o.source.hasNonSerializedProperties()&&(h="Loading...")}else h=l===null?"Annotation not found":"Loading...";if(l!=null){const p=c.error===void 0?c.layerRank:0,m=document.createElement("div");m.classList.add("neuroglancer-selected-annotation-details-position-grid"),m.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${p}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,d.appendChild(m);const g=Ft[l.type],v=document.createElement("div");if(v.className="neuroglancer-selected-annotation-details-icon",v.textContent=g.icon,m.appendChild(v),p!==0){const{layerDimensionNames:L}=c.modelTransform;for(let N=0;N<p;++N){const k=document.createElement("div");k.classList.add("neuroglancer-selected-annotation-details-position-dim"),k.textContent=L[N],k.style.gridColumn=`dim ${N+1}`,m.appendChild(k)}dy(l,c,(N,k)=>{const O=Hn({title:"Copy position",onClick:()=>{mi(N.map(V=>Math.floor(V)).join(", "))}});O.style.gridColumn="copy",m.appendChild(O);for(let V=0;V<p;++V){const z=document.createElement("div");z.classList.add("neuroglancer-selected-annotation-details-position-coord"),z.style.gridColumn=`coord ${V+1}`,z.textContent=Math.floor(N[V]).toString(),m.appendChild(z)}if(!k){const V=Nm({title:"Move to position",onClick:()=>{cy(this,c,N)}});V.style.gridColumn="move",m.appendChild(V)}})}if(!o.source.readonly){const L=Mn({title:"Delete annotation",onClick:()=>{o.source.delete(a)}});L.classList.add("neuroglancer-selected-annotation-details-delete"),m.appendChild(L)}const{relationships:y,properties:{value:S}}=o.source,w=o.source.readonly,b=document.createElement("label");b.classList.add("neuroglancer-annotation-property");const x=document.createElement("span");x.classList.add("neuroglancer-annotation-property-label"),x.textContent="ID",b.appendChild(x);const E=document.createElement("span");E.classList.add("neuroglancer-annotation-property-value"),E.textContent=a.id,b.appendChild(E),d.appendChild(b);const D=[];for(let L=0,N=S.length;L<N;++L){const k=S[L],O=l.properties[L];if(us(k)&&k.tag){O!==0&&D.push(k.tag);continue}const V=document.createElement("label");V.classList.add("neuroglancer-annotation-property");const z=document.createElement("span");z.classList.add("neuroglancer-annotation-property-label"),z.textContent=k.identifier,V.appendChild(z);const{description:Y}=k;Y!==void 0&&(V.title=Y);const Q=document.createElement("span");switch(Q.classList.add("neuroglancer-annotation-property-value"),k.type){case"rgb":{const X=tt(O),ce=Ge(X);Q.textContent=ce,Q.style.backgroundColor=ce,Q.style.color=Be(X)?"white":"black";break}case"rgba":{const X=tt(O);Q.textContent=Ge(Dt(O)),Q.style.backgroundColor=Ge(tt(O)),Q.style.color=Be(X)?"white":"black";break}default:Q.textContent=Th(k,O);break}V.appendChild(Q),d.appendChild(V)}if(D.length){const L=document.createElement("label");L.classList.add("neuroglancer-annotation-property");const N=document.createElement("span");N.classList.add("neuroglancer-annotation-property-label"),N.textContent="tags",L.appendChild(N);const k=document.createElement("span");k.classList.add("neuroglancer-annotation-property-value"),k.textContent=D.map(O=>`#${O}`).join(" "),L.appendChild(k),d.appendChild(L)}const{relatedSegments:I}=l;for(let L=0,N=y.length;L<N;++L){const k=I===void 0?[]:I[L];if(k.length===0&&w)continue;const O=L,V=y[L];d.appendChild(u.registerDisposer(HL(V,k,o.displayState.relationshipStates.get(V).segmentationState,w?void 0:z=>{const Y=a.value;if(Y==null)return;let{relatedSegments:Q}=Y;Q===void 0?Q=o.source.relationships.map(()=>[]):Q=Q.slice(),Q[O]=z;const X={...Y,relatedSegments:Q};o.source.update(a,X),o.source.commit(a)})).element)}if(!o.source.readonly||l.description)if(o.source.readonly){const L=document.createElement("div");L.className="neuroglancer-annotation-details-description",L.textContent=l.description||"",d.appendChild(L)}else{const L=document.createElement("textarea");L.value=l.description||"",L.rows=3,L.className="neuroglancer-annotation-details-description",L.placeholder="Description",L.addEventListener("change",()=>{const N=L.value;o.source.update(a,{...l,description:N||void 0}),o.source.commit(a)}),d.appendChild(L)}}if(h!==void 0){const p=document.createElement("div");p.classList.add("neuroglancer-selection-annotation-status"),p.textContent=h,d.appendChild(p)}})).element),!0}displaySelectionState(n,s,r){let o=this.displayAnnotationState(n,s,r);return super.displaySelectionState(n,s,r)&&(o=!0),o}addLocalAnnotations(n,s,r){const{subsourceEntry:o}=n,a=new jo({localPosition:this.localPosition,transform:n.getRenderLayerTransform(),source:s,displayState:this.annotationDisplayState,dataSource:n.loadedDataSource.layerDataSource,subsourceIndex:n.subsourceIndex,subsourceId:o.id,role:r});this.addAnnotationLayerState(a,n)}addStaticAnnotations(n){const{subsourceEntry:s}=n,{staticAnnotations:r}=s.subsource;return r===void 0?!1:(n.activate(()=>{this.addLocalAnnotations(n,r,li.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(n,s){const r=s.activated;r.registerDisposer(this.annotationStates.add(n));const o=new RL(this.manager.chunkManager,n.addRef());if(o.source instanceof Rr){const a=new AL({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});r.registerDisposer(s.messages.addChild(a.messages));const l=new PL({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});r.registerDisposer(s.messages.addChild(l.messages)),r.registerDisposer((0,_.no)((c,d)=>{d&&(c.registerDisposer(this.addRenderLayer(a.addRef())),c.registerDisposer(this.addRenderLayer(l.addRef())))},this.annotationDisplayState.displayUnfiltered))}{const a=new ML(o,this.annotationCrossSectionRenderScaleHistogram);r.registerDisposer(this.addRenderLayer(a)),r.registerDisposer(s.messages.addChild(a.messages))}{const a=new kL(o.addRef(),this.annotationProjectionRenderScaleHistogram);r.registerDisposer(this.addRenderLayer(a)),r.registerDisposer(s.messages.addChild(a.messages))}}selectAnnotation(n,s,r){this.manager.root.selectionState.captureSingleLayerState(this,o=>(o.annotationId=s,o.annotationSourceIndex=n.sourceIndex,o.annotationSubsource=n.subsourceId,o.annotationSubsubsourceId=n.subsubsourceId,!0),r)}toJSON(){const n=super.toJSON();return n[wy]=this.annotationDisplayState.color.toJSON(),n}}return e}function xy(i,e,t,n,s,r){const o=t.chunkTransform.value,a=document.createElement("div");a.classList.add("neuroglancer-annotation-list-entry"),a.dataset.color=t.displayState.color.toString(),a.style.gridTemplateColumns=n;const l=document.createElement("div");l.className="neuroglancer-annotation-icon",l.textContent=Ft[e.type].icon,a.appendChild(l);let c;const d=()=>{t.source.readonly||c===void 0&&(c=Mn({title:"Delete annotation",onClick:g=>{g.stopPropagation(),g.preventDefault();const v=t.source.getReference(e.id);try{t.source.delete(v)}finally{v.dispose()}}}),c.classList.add("neuroglancer-annotation-list-entry-delete"),a.appendChild(c))},u=[];let h=0;if(dy(e,o,(g,v)=>{++h;const y=document.createElement("div");y.className="neuroglancer-annotation-position",a.appendChild(y);let S=0;const w=(b,x)=>{for(const E of b){const D=x[E];if(D!==-1){const I=Math.floor(g[D]),L=document.createElement("div"),N=I.toString();L.textContent=N,L.classList.add("neuroglancer-annotation-coordinate"),L.style.gridColumn=`dim ${S+1}`,u[S]=Math.max(u[S]||0,N.length),y.appendChild(L)}++S}};w(s,o.modelTransform.globalToRenderLayerDimensions),w(r,o.modelTransform.localToRenderLayerDimensions),d()}),e.description){++h;const g=document.createElement("div");g.classList.add("neuroglancer-annotation-description"),g.textContent=e.description,a.appendChild(g)}const{properties:{value:p}}=t.source,m=[];for(let g=0,v=p.length;g<v;++g){const y=p[g],S=e.properties[g];us(y)&&y.tag&&S!==0&&m.push(y.tag)}if(m.length){const g=document.createElement("div");g.classList.add("neuroglancer-annotation-tags"),g.textContent=m.map(v=>`#${v}`).join(" "),a.appendChild(g)}return l.style.gridRow=`span ${h}`,c!==void 0&&(c.style.gridRow=`span ${h}`),a.addEventListener("mouseenter",()=>{i.selectAnnotation(t,e.id,!1)}),a.addEventListener("action:select-position",g=>{g.stopPropagation(),i.selectAnnotation(t,e.id,"toggle")}),a.addEventListener("action:pin-annotation",g=>{g.stopPropagation(),i.selectAnnotation(t,e.id,!0)}),a.addEventListener("action:move-to-annotation",g=>{g.stopPropagation(),g.preventDefault(),uy(i,e,t)}),[a,u]}/**
 * /**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2021 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const eu="selectSegments",tu="mousedown0",JL=Ae.fromObject({[`at:alt?+shift?+${tu}`]:"drag-select-segments"});var jL=(i=>(i[i.IDLE=0]="IDLE",i[i.SELECT=1]="SELECT",i[i.DESELECT=2]="DESELECT",i))(jL||{});class YL extends gi{toJSON(){return eu}activate(e){const{layer:t}=this,{body:n,header:s}=Vi(e);let r=0,o=!1;e.bindInputEventMap(JL);const a=()=>Vo.value&sf.ALT?2:1,l=h=>{r!==h&&(r=h,o=!1,c())},c=()=>{Me(n);const h=document.createElement("span");switch(r){case 0:s.textContent="Select/Deselect segments",h.textContent=`${tu} to select segments; alt+${tu} to deselect segments.`;break;case 1:case 2:s.textContent=`${r===1?"Select":"Deselect"} segments`,h.textContent=`Drag to ${r===1?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}n.appendChild(h)};c();const d=()=>{if(r===0)return;const{segmentSelectionState:h}=t.displayState;if(h.hasSelectedSegment){const p=h.selectedSegment,{selectedSegments:m,visibleSegments:g}=t.displayState.segmentationGroupState.value;switch(r){case 1:m.add(p),g.add(p);break;case 2:m.delete(p);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{o&&d()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(c)),e.registerDisposer(Vo.changed.add(()=>{r!==0&&l(a())}));const u=(h,p)=>{h.stopPropagation(),l(p),d();const m=h.detail.screenX,g=h.detail.screenY;zt(h.detail,(v,y,S)=>{if(!o){const w=v.screenX-m,b=v.screenY-g;w*w+b*b>25&&(d(),o=!0)}},v=>{o=!1,l(0)})};e.bindAction("drag-select-segments",h=>u(h,a()))}get description(){return"select"}}function QL(i){sn(i,eu,e=>new YL(e))}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nu="mergeSegments",iu="splitSegments",KL=Ae.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),qL=Ae.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class XL extends gi{constructor(e){super(e),this.lastAnchorBaseSegment=new _.B0(void 0);const t=()=>{const n=e.anchorSegment.value;if(n===void 0)return;const{segmentSelectionState:s}=e.displayState;if(!s.hasSelectedSegment)return;const{segmentEquivalences:r}=e.displayState.segmentationGroupState.value,o=r.get(n);if(!P.R.equal(s.selectedSegment,o))return;const a=s.baseSelectedSegment,l=(0,Rt.YR)(a),c=r.disjointSets.visibleSegmentEquivalencePolicy.value;c&Rt.y6.NONREPRESENTATIVE_EXCLUDED&&l||c&Rt.y6.REPRESENTATIVE_EXCLUDED&&!l||(this.lastAnchorBaseSegment.value=a.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return nu}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{const c=this.layer.anchorSegment.value,d=this.lastAnchorBaseSegment.value;if(c===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};const u=t.segmentEquivalences.get(c);return t.visibleSegments.has(u)?d===void 0||!P.R.equal(t.segmentEquivalences.get(d),u)?{anchorSegment:c,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:d,error:void 0}:{anchorSegment:c,error:"Anchor segment must be in visible set"}},s=()=>{const{anchorSegment:c,error:d}=n();if(c===void 0||d!==void 0)return{anchorSegment:c,error:d,otherSegment:void 0,anchorSegmentValid:!1};const{displayState:u}=this.layer,h=u.segmentSelectionState.baseValue;return h===void 0||P.R.equal(u.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(c))?{anchorSegment:c,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:c,otherSegment:h,error:void 0,anchorSegmentValid:!0}},{body:r,header:o}=Vi(e);o.textContent="Merge segments",r.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(KL),e.registerDisposer(()=>{Ur(t)});const a=()=>{Me(r);const{displayState:c}=this.layer,{anchorSegment:d,otherSegment:u,anchorSegmentValid:h,error:p}=s(),m=y=>{const S=Id(this.layer.displayState,y);return S.classList.add("neuroglancer-segment-list-entry-double-line"),S};if(d!==void 0&&r.appendChild(m(Yi(c,d))),p!==void 0){const y=document.createElement("span");y.textContent=p,r.appendChild(y)}if(u!==void 0){const y=document.createElement("span");y.textContent=" merge ",r.appendChild(y),r.appendChild(m(Yi(c,u)))}const{segmentEquivalences:g}=t;if(!h){Ur(t);return}t.useTemporaryVisibleSegments.value=!0;const v=t.temporaryVisibleSegments;v.clear(),v.add(g.get(d)),u!==void 0&&v.add(g.get(u))};a(),e.registerDisposer($r(this.layer.displayState,r));const l=e.registerCancellable((0,Qe.t)(a));Bs(this.layer.displayState,e,l),e.registerDisposer(this.layer.anchorSegment.changed.add(l)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(l)),e.bindAction("merge-segments",c=>{c.stopPropagation(),(async()=>{const{graph:{value:d}}=t;if(d===void 0)return;const{anchorSegment:u,otherSegment:h,error:p}=s();if(!(u===void 0||h===void 0||p!==void 0))try{await d.merge(u,h),pe.showTemporaryMessage("Merge performed")}catch(m){pe.showTemporaryMessage(`Merge failed: ${m}`)}})()}),e.bindAction("set-anchor",c=>{c.stopPropagation();const{segmentSelectionState:d}=this.layer.displayState,u=d.baseValue;if(u===void 0)return;const h=this.layer.anchorSegment.value;if(t.visibleSegments.add(u),h===void 0||!P.R.equal(h,u)){this.layer.anchorSegment.value=u.clone();return}})}get description(){return"merge"}}class ZL extends gi{toJSON(){return iu}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{const d=this.layer.anchorSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};const u=t.segmentEquivalences.get(d);return t.visibleSegments.has(u)?{anchorSegment:d,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},{body:s,header:r}=Vi(e);r.textContent="Split segments",s.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(qL);const o=()=>{const{anchorSegment:d,error:u}=n();if(d===void 0||u!==void 0)return{anchorSegment:d,error:u,otherSegment:void 0,anchorSegmentValid:!1};const{displayState:h}=this.layer,p=h.segmentSelectionState.baseValue;return p===void 0||!P.R.equal(h.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))||P.R.equal(p,d)?{anchorSegment:d,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:d,otherSegment:p,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{Ur(t)});const a=()=>{Me(s);const{displayState:d}=this.layer,{anchorSegment:u,otherSegment:h,anchorSegmentValid:p,error:m}=o();let g,v;(()=>{const{segmentEquivalences:w}=t,{graphConnection:{value:b}}=this.layer;if(!p||b===void 0){Ur(t);return}if(t.useTemporaryVisibleSegments.value=!0,h!==void 0){const E=b.computeSplit(u,h);if(E!==void 0){g=new wi(u,E.includeRepresentative),v=new wi(h,E.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;const D=E.includeRepresentative,I=E.excludeRepresentative,L=t.temporarySegmentEquivalences;L.clear();for(const k of E.includeBaseSegments)L.link(k,D);for(const k of E.excludeBaseSegments)L.link(k,I);const N=t.temporaryVisibleSegments;N.clear(),N.add(D),N.add(I);return}}t.useTemporarySegmentEquivalences.value=!1;const x=t.temporaryVisibleSegments;x.clear(),x.add(w.get(u))})();const S=w=>{const b=Id(this.layer.displayState,w);return b.classList.add("neuroglancer-segment-list-entry-double-line"),b};if(u!==void 0&&s.appendChild(S(g??Yi(d,u))),m!==void 0){const w=document.createElement("span");w.textContent=m,s.appendChild(w)}if(v!==void 0){const w=document.createElement("span");w.textContent=" split ",s.appendChild(w),s.appendChild(S(v))}};e.registerDisposer($r(this.layer.displayState,s)),a();const l=e.registerCancellable((0,Qe.t)(a));Bs(this.layer.displayState,e,l),e.registerDisposer(this.layer.anchorSegment.changed.add(l));const c=async d=>{const{graph:{value:u}}=t;if(u===void 0)return;const{anchorSegment:h,otherSegment:p,error:m}=o();if(!(h===void 0||p===void 0||m!==void 0))try{await u.split(h,p),d&&t.visibleSegments.add(t.segmentEquivalences.get(p)),pe.showTemporaryMessage("Split performed")}catch(g){pe.showTemporaryMessage(`Split failed: ${g}`)}};e.bindAction("split-segments",d=>{d.stopPropagation(),c(!1)}),e.bindAction("split-and-select-segments",d=>{d.stopPropagation(),c(!0)}),e.bindAction("set-anchor",d=>{d.stopPropagation();const{segmentSelectionState:u}=this.layer.displayState,h=u.baseValue;if(h===void 0)return;t.visibleSegments.add(h);const p=this.layer.anchorSegment.value;if(p===void 0||!P.R.equal(p,h)){this.layer.anchorSegment.value=h.clone();return}})}get description(){return"split"}}function eR(i){sn(i,nu,e=>new XL(e)),sn(i,iu,e=>new ZL(e))}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tR=new P.R;class Ey extends T.O8{constructor(e,t){super(),this.segmentationDisplayState=e,this.parentElement=t,this.changed=new j.HN,this.explicitSegmentsVisible=!1,this.debouncedUpdate=(0,Fe.A)(()=>this.update(),0)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}}class Ty extends Ey{constructor(e,t){super(e,t),this.segmentationDisplayState=e,this.parentElement=t,this.render=n=>{const{explicitSegments:s}=this,r=s[n];return this.segmentWidgetFactory.get(r)},this.update(),this.registerDisposer(e.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate))}update(){const e=[],{selectedSegments:t}=this.segmentationDisplayState.segmentationGroupState.value,n=[...t],{explicitSegments:s}=this;s===void 0?e.push({retainCount:0,insertCount:n.length,deleteCount:0}):e.push(...(0,F.ak)(s,n,P.R.equal)),this.explicitSegments=n,this.length=n.length,this.changed.dispatch(e)}}class Dy extends Ey{constructor(e,t,n,s){super(n,s),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=n,this.parentElement=s,this.queryResult=new _.B0(void 0),this.prevQueryResult=new _.B0(void 0),this.statusText=new _.B0(""),this.selectedMatches=0,this.visibleMatches=0,this.matchStatusTextPrefix="",this.selectedSegmentsGeneration=-1,this.visibleSegmentsGeneration=-1,this.explicitSegmentsVisible=!1,this.render=r=>{const{explicitSegments:o}=this;let a;if(o!==void 0)a=o[r];else{a=tR;const l=this.queryResult.value.indices[r],{ids:c}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;a.low=c[l*2],a.high=c[l*2+1]}return this.segmentWidgetFactory.get(a)},this.update(),this.registerDisposer(n.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(n.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),e&&this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){return this.queryResult.value?.count??0}update(){const e=this.query.value,{segmentPropertyMap:t}=this;this.prevQueryResult.value=this.queryResult.value;const n=this.prevQueryResult.value;let s;if(this.prevQuery===e)s=n;else{const b=mI(t,e);s=vI(t,b)}const r=[];let o=!1,a="";const l=xI(s.query);l||this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(r.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0);const{explicitIds:c}=s;c!==void 0?this.explicitSegments=c:this.explicitSegmentsVisible||(this.explicitSegments=void 0),n!==s&&(r.push({retainCount:0,deleteCount:n?.count??0,insertCount:s.count}),o=!0,this.queryResult.value=s),s.explicitIds!==void 0?a=`${s.count} ids`:l?a=`${s.count} total ids`:s.total>0&&(a=`${s.count} match /${s.total} total ids`);const{selectedSegments:d,visibleSegments:u}=this.segmentationDisplayState.segmentationGroupState.value,h=d.changed.count,p=u.changed.count,m=this.selectedSegmentsGeneration,g=this.visibleSegmentsGeneration,v=n!==s,y=m!==h||v,S=g!==p||v;this.selectedSegmentsGeneration=h,this.visibleSegmentsGeneration=p,y&&(this.selectedMatches=s.count>0?cv(t,s,d):0),S&&(this.visibleMatches=s.count>0?cv(t,s,u):0);let w=a;this.selectedMatches>0&&(this.selectedMatches===this.visibleMatches?w=`${this.selectedMatches} vis/${w}`:this.visibleMatches>0?w=`${this.visibleMatches} vis/${this.selectedMatches} star/${w}`:w=`${this.selectedMatches} star/${w}`),this.statusText.value=w,this.prevQuery=e,this.matchStatusTextPrefix=a,this.length=s.count,o&&this.changed.dispatch(r)}}const Iy=Ae.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}});function Ly(i){$t(i,Math.max(1,i.value.length+.1))}function su(i,e){let t;if(Number.isInteger(e))t=e.toString();else{const n=e.toString(),s=e.toPrecision(6);t=n.length<s.length?n:s}i.value=t,Ly(i)}function nR(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${i}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(i==="range"?"range":"for distribution"),t.addEventListener("input",()=>{Ly(t)}),t}function iR(i,e,t){if(i===void 0||i.indices===void 0)return;const n=i.query;let{sortBy:s,includeColumns:r}=n;Pa(n,t)?(s=s.filter(a=>a.fieldId!==t),r=r.filter(a=>a!==t)):r.push(t),e({...n,sortBy:s,includeColumns:r})}function Ry(i,e,t){const n=i?.query,s=n?.sortBy;if(s===void 0)return;const{includeColumns:r}=n,a=s.find(c=>c.fieldId===t)?.order==="<"?">":"<",l=r.filter(c=>c!==t);for(const c of s)c.fieldId!=="id"&&c.fieldId!=="label"&&c.fieldId!==t&&l.push(c.fieldId);e({...n,sortBy:[{fieldId:t,order:a}],includeColumns:l})}function ky(i,e,t){const s=i?.query?.sortBy?.find(r=>r.fieldId===t)?.order;e.textContent=s===">"?"\u25BC":"\u25B2",e.style.visibility=s===void 0?"":"visible",e.title=`Sort by ${t} in ${s==="<"?"descending":"ascending"} order`}class sR extends T.O8{constructor(e,t,n){super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=n,this.propertyHistograms=[],this.bounds={window:new _.B0([]),range:new _.B0([])},this.throttledUpdate=this.registerCancellable((0,la.A)(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable((0,Qe.t)(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable((0,Fe.A)(()=>this.setQueryFromBounds(),200));const s=e?.numericalProperties,r=[];let o;if(s!==void 0&&s.length>0){o=document.createElement("details");const a=document.createElement("summary");a.textContent=`${s.length} numerical propert${s.length>1?"ies":"y"}`,o.appendChild(a),o.classList.add("neuroglancer-segment-query-result-numerical-list");const l=this.bounds.window.value;for(let c=0,d=s.length;c<d;++c){const u=s[c],h=this.makeNumericalPropertySummary(c,u);r.push(h),o.appendChild(h.element),l[c]=u.bounds}}this.listElement=o,this.properties=r,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){const e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;const t=e.query,n=[],s=this.bounds.range.value,{properties:r}=this;for(let o=0,a=r.length;o<a;++o){const l=r[o].property;n.push({fieldId:l.id,bounds:s[o]})}this.setQuery({...t,numericalConstraints:n})}getBounds(e){const{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){const{property:n}=this.properties[e];let s=Ze(n.bounds,t.range);rt(s[0],s[1])>0&&(s=[s[1],s[0]]);const r=Ze(n.bounds,t.window),o=this.getBounds(e),{dataType:a}=this.properties[e].property;Bt(a,r,o.window)||(this.bounds.window.value[e]=r,this.bounds.window.changed.dispatch()),Bt(a,s,o.range)||(this.bounds.range.value[e]=s,this.bounds.range.changed.dispatch())}setBound(e,t,n,s){const o=this.segmentPropertyMap.numericalProperties[n].bounds;s=Pe(o,s);const a=this.getBounds(n),l=Sr(a,e,t,s,!0);this.setBounds(n,l)}handleNewQueryResult(){const e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if(e?.indices!==void 0){const{numericalConstraints:n}=e.query,{numericalProperties:s}=this.segmentPropertyMap,r=this.bounds.range.value,o=n.length,a=s.length;r.length=a;for(let l=0;l<a;++l)r[l]=s[l].bounds;for(let l=0;l<o;++l){const c=n[l],d=s.findIndex(u=>u.id===c.fieldId);r[d]=c.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){const e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(SI(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();const{listElement:e}=this;if(e===void 0)return;const{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";const{properties:n}=this;for(let s=0,r=n.length;s<r;++s)this.updateNumericalPropertySummary(s,n[s],t[s])}makeNumericalPropertySummary(e,t){const n=document.createElement("div");n.classList.add("neuroglancer-segment-query-result-numerical-plot-container");const s=document.createElement("img");s.classList.add("neuroglancer-segment-query-result-numerical-plot");const r=new gf(s,t.dataType,()=>this.getBounds(e),d=>this.setBounds(e,d)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");const a=document.createElement("input");a.type="checkbox",a.addEventListener("click",()=>{iR(this.queryResult.value,this.setQuery,t.id)});const l=d=>{const u=document.createElement("div");u.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),u.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${d}`);const h=g=>{const v=nR(d,g);return v.addEventListener("change",()=>{if(this.bounds[d].value[e]!==void 0){try{const S=qt(t.dataType,v.value);this.setBound(d,g,e,S),this.bounds[d].changed.dispatch()}catch{}su(v,this.bounds[d].value[e][g])}}),v},p=[h(0),h(1)];let m;if(d==="range"){m=[document.createElement("div"),document.createElement("div"),document.createElement("div")],m[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),m[1].appendChild(a);const g=document.createElement("span");g.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),g.appendChild(document.createTextNode(t.id)),g.appendChild(o),g.addEventListener("click",()=>{Ry(this.queryResult.value,this.setQuery,t.id)}),m[1].appendChild(g);const{description:v}=t;v&&(m[1].title=v),u.appendChild(m[0]),u.appendChild(p[0]);const y=document.createElement("div");y.textContent="\u2264",y.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),u.appendChild(y),u.appendChild(m[1]);const S=document.createElement("div");S.textContent="\u2264",S.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),u.appendChild(S),u.appendChild(p[1]),u.appendChild(m[2])}else u.appendChild(p[0]),u.appendChild(p[1]);return{container:u,spacers:m,inputs:p}},c={range:l("range"),window:l("window")};return n.appendChild(c.range.container),n.appendChild(s),n.appendChild(c.window.container),{property:t,controller:r,element:n,plotImg:s,boundElements:c,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:a,sortIcon:o}}updateNumericalPropertySummary(e,t,n){const s=t.bounds.window,r=this.bounds.window.value[e],o=t.bounds.range,a=this.bounds.range.value[e],{property:l}=t,c=this.queryResult.value,d=Pa(c?.query,l.id);if(t.columnCheckbox.checked=d,t.columnCheckbox.title=d?"Remove column from result table":"Add column to result table",ky(c,t.sortIcon,l.id),t.propertyHistogram===n&&Bt(l.dataType,s,r)&&Bt(l.dataType,o,a))return;const{histogram:u}=n,h="http://www.w3.org/2000/svg",p=document.createElementNS(h,"svg");p.setAttribute("width","1"),p.setAttribute("height","1"),p.setAttribute("preserveAspectRatio","none");const m=document.createElementNS(h,"rect"),g=re(r,a[0]),v=re(r,a[1]);m.setAttribute("x",`${g}`),m.setAttribute("y","0"),m.setAttribute("width",`${v-g}`),m.setAttribute("height","1"),m.setAttribute("fill","#4f4f4f"),p.appendChild(m);const y=u.length,S=(L,N,k)=>{const O=document.createElementNS(h,"polyline");let V="",z=0;for(let oe=L;oe<k;++oe)z+=u[oe];if(z===0)return;const Y=re(r,n.window[0]),Q=re(r,n.window[1]),X=(oe,Se)=>{const Ke=oe/(y-2),$e=Y*(1-Ke)+Q*Ke;V+=` ${$e},${1-Se}`};L!==0&&X(L,0);let ce=0;for(let oe=L;oe<N;++oe){const Se=u[oe];ce+=Se,X(oe,ce/z)}return O.setAttribute("fill","none"),O.setAttribute("stroke-width","1px"),O.setAttribute("points",V),O.setAttribute("vector-effect","non-scaling-stroke"),O};{const L=S(0,y-1,y);L!==void 0&&(L.setAttribute("stroke","cyan"),p.appendChild(L))}if(!Bt(l.dataType,l.bounds,a)){const L=Math.floor(Math.max(0,Math.min(1,re(n.window,a[0])))*(y-2)),N=Math.ceil(Math.max(0,Math.min(1,re(n.window,a[1])))*(y-2)),k=S(L,N,N);k!==void 0&&(k.setAttribute("stroke","white"),p.appendChild(k))}const w=new XMLSerializer().serializeToString(p);t.plotImg.src=`data:image/svg+xml;base64,${btoa(w)}`,t.propertyHistogram=n;for(let L=0;L<2;++L)s[L]=r[L],su(t.boundElements.window.inputs[L],r[L]),o[L]=a[L],su(t.boundElements.range.inputs[L],a[L]);const b=t.boundElements.range.spacers,x=Ze(r,a),E=le(l.dataType,r),D=re(r,x[0])*E,I=re(r,x[1])*E+(1-E);b[0].style.width=`${D*100}%`,b[2].style.width=`${(1-I)*100}%`}}function rR(i,e){const{tags:t}=i;if(t===void 0||t.length===0)return;const n=i.query,s=document.createElement("div");s.classList.add("neuroglancer-segment-query-result-tag-list");for(const{tag:r,count:o,desc:a}of t){const l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");const c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),r!==a&&a!==void 0&&a!==""?c.textContent=r+" ("+a+")":c.textContent=r,s.appendChild(l);const d=n.includeTags.includes(r),u=n.excludeTags.includes(r);let h;d?h="Remove tag from required set":u?h="Remove tag from excluded set":h="Add tag to required set",c.addEventListener("click",()=>{e(dv(n,r,!0,!d&&!u))}),c.title=h;const p=d||u,m=v=>{const y=v?o:i.count-o,S=document.createElement("div");if(S.classList.add("neuroglancer-segment-query-result-tag-toggle"),S.classList.add(`neuroglancer-segment-query-result-tag-${v?"include":"exclude"}`),l.appendChild(S),!p&&y===0)return;const w=v?d:u;S.appendChild(new rn({get value(){return w},set value(b){e(dv(n,r,v,b))},changed:j.$$},{text:v?"+":"-",enableTitle:`Add tag to ${v?"required":"exclusion"} set`,disableTitle:`Remove tag from ${v?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};m(!0),m(!1),l.appendChild(c);const g=document.createElement("span");g.classList.add("neuroglancer-segment-query-result-tag-count"),p||(g.textContent=o.toString()),l.appendChild(g)}return s}class Py extends T.O8{constructor(e,t){super(),this.listSource=e,this.group=t,this.element=document.createElement("div"),this.selectionStatusContainer=document.createElement("span"),this.selectionStatusMessage=document.createElement("span"),this.statusChanged=new j.IY,this.debouncedUpdateStatus=(0,Fe.A)(()=>this.updateStatus(),0);const{element:n}=this;n.style.display="contents",this.starAllButton=Bm({title:"Click to toggle star status, shift+click to unstar non-visible segments.",onClick:r=>{const o=this.starAllButton.classList.contains("neuroglancer-starred");if(r.shiftKey){const a=[];for(const l of this.group.selectedSegments)this.group.visibleSegments.has(l)||a.push(l);this.group.selectedSegments.delete(a);return}this.selectSegments(!o,!1)}}),this.copyAllSegmentsButton=Hn({title:"Copy all segment IDs",onClick:()=>{this.copySegments(!1)}}),this.copyVisibleSegmentsButton=Hn({title:"Copy visible segment IDs",onClick:()=>{this.copySegments(!0)}}),this.visibilityToggleAllButton=Vm({onClick:r=>{if(r.shiftKey){this.invertVisibility();return}this.makeSegmentsVisible(!this.visibilityToggleAllButton.classList.contains("neuroglancer-visible"))}});const{selectionStatusContainer:s}=this;this.selectionStatusMessage.classList.add("neuroglancer-segment-list-status-message"),s.classList.add("neuroglancer-segment-list-status"),s.appendChild(this.copyAllSegmentsButton),s.appendChild(this.starAllButton),s.appendChild(this.visibilityToggleAllButton),s.appendChild(this.copyVisibleSegmentsButton),s.appendChild(this.selectionStatusMessage),this.element.appendChild(s),this.registerDisposer(t.visibleSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(t.selectedSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(e.changed.add(this.debouncedUpdateStatus))}makeSegmentsVisible(e){const{visibleSegments:t}=this.group,n=Array.from(this.listSegments(!0));t.set(n,e)}invertVisibility(){const e=[],t=[],{visibleSegments:n}=this.group;for(const s of this.listSegments(!0))n.has(s)?t.push(s):e.push(s);n.set(e,!0),n.set(t,!1)}selectSegments(e,t=!1){const{selectedSegments:n,visibleSegments:s}=this.group,r=Array.from(this.listSegments(!0));(e||!t)&&n.set(r,e),t&&s.set(r,e)}copySegments(e=!1){let t=[...this.listSegments(!0)];e&&(t=t.filter(n=>this.group.visibleSegments.has(n))),t.sort(P.R.compare),mi(t.join(", "))}*listSegments(e=!1){}updateStatus(){const{listSource:e,group:t,starAllButton:n,selectionStatusMessage:s,copyAllSegmentsButton:r,copyVisibleSegmentsButton:o,visibilityToggleAllButton:a}=this;e.debouncedUpdate.flush();const{visibleSegments:l,selectedSegments:c}=t;let d=0,u=0,h=0,p="";const m=c.size,g=l.size;e instanceof Dy?(h=e.numMatches,d=e.visibleMatches,u=e.selectedMatches,p=e.statusText.value):p=`${g}/${m} visible`;const v=h?d:g,y=h?u:m,S=h||m;n.classList.toggle("neuroglancer-starred",y===S),n.classList.toggle("neuroglancer-indeterminate",y>0&&y!==S),s.textContent=p,r.title=`Copy all ${S} ${h?"matching":"starred"} segment(s)`,o.title=`Copy ${v} ${h?"visible matching":"visible"} segment(s)`,r.style.visibility=S?"visible":"hidden",o.style.visibility=v?"visible":"hidden",n.style.visibility=S?"visible":"hidden",a.style.visibility=S?"visible":"hidden";const w=v===S;a.classList.toggle("neuroglancer-visible",w);const b=v>0&&v!==S;a.classList.toggle("neuroglancer-indeterminate",b);let x;w?x=`Click to hide ${S} segment ID(s).`:x=`Click to show ${S-v} segment ID(s).`,b&&(x+="  Shift+click to invert visibility."),a.title=x,this.statusChanged.dispatch()}}class oR extends Py{constructor(e,t){super(e,t),this.listSource=e,this.group=t}listSegments(e=!1){return this.group.selectedSegments[Symbol.iterator]()}}class aR extends Py{constructor(e,t,n,s,r,o,a){super(t,n),this.listSource=t,this.segmentPropertyMap=s,this.debouncedUpdateQueryModel=a;const l=g=>{o.focus(),o.select();const v=bI(s,g);document.execCommand("insertText",!1,v),r.value=v,o.select()},c=document.createElement("div");c.classList.add("neuroglancer-segment-query-result-statistics");const d=document.createElement("div");d.classList.add("neuroglancer-segment-query-result-statistics-separator");const u=document.createElement("ul");u.classList.add("neuroglancer-segment-query-errors"),this.element.prepend(u,c,d),this.registerEventListener(o,"input",()=>{a()}),this.registerDisposer(Z(o,"cancel",()=>{o.focus(),o.select(),document.execCommand("delete"),o.blur(),o.value="",r.value=""})),this.registerDisposer(Z(o,"toggle-listed",()=>{this.toggleMatches()})),this.registerDisposer(Z(o,"hide-all",()=>{n.visibleSegments.clear()})),this.registerDisposer(Z(o,"hide-listed",()=>{a(),a.flush(),t.debouncedUpdate.flush();const{visibleSegments:g}=n;this.listSource instanceof Ty?g.clear():g.delete(Array.from(this.listSegments()))}));const h=this.registerDisposer(new sR(s,t.queryResult,l));{const{listElement:g}=h;g!==void 0&&c.appendChild(g)}const p=g=>{const v=g?.errors;if(Me(u),v!==void 0)for(const y of v){const S=document.createElement("li");S.textContent=y.message,u.appendChild(S)}};let m;(0,_.W1)(g=>{if(t.segmentWidgetFactory=new Wm(t.segmentationDisplayState,t.parentElement,y=>Pa(g?.query,y.id)),e.scrollToTop(),Me(e.header),s!==void 0){const y=t.segmentWidgetFactory.getHeader();y.container.classList.add("neuroglancer-segment-list-header");for(const S of y.propertyLabels){const{label:w,sortIcon:b,id:x}=S;w.addEventListener("click",()=>{Ry(t.queryResult.value,l,x)}),ky(g,b,x)}e.header.appendChild(y.container)}if(p(g),d.style.display="none",m?.remove(),g===void 0)return;const{query:v}=g;v.errors!==void 0||v.ids!==void 0||(m=rR(g,l),m!==void 0&&c.appendChild(m),(h.properties.length>0||m!==void 0)&&(d.style.display=""))},t.queryResult)}updateQuery(){const{listSource:e,debouncedUpdateQueryModel:t}=this;t(),t.flush(),e.debouncedUpdate.flush()}listSegments(e=!1){const{listSource:t,segmentPropertyMap:n}=this;this.updateQuery();const s=t.queryResult.value;return wI(n,s,e)}toggleMatches(){const{listSource:e}=this;this.updateQuery(),e.debouncedUpdate.flush();const t=e.queryResult.value;if(t===void 0)return;const{visibleMatches:n}=e,s=n!==t.count;return this.selectSegments(s,!0),!0}}class lR extends Gt{constructor(e){super(),this.layer=e;const{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Wt(e.displayState.segmentationGroupState.value.graph,(l,c,d)=>{if(l===void 0||l.tabContents)return;const u=document.createElement("div");u.className="neuroglancer-segmentation-toolbox",u.appendChild(Wn(d,e.toolBinder,{toolJson:nu,label:"Merge",title:"Merge segments"})),u.appendChild(Wn(d,e.toolBinder,{toolJson:iu,label:"Split",title:"Split segments"})),c.appendChild(u)})).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(Wn(this,e.toolBinder,{toolJson:eu,label:"Select",title:"Select/Deselect segments"})),t.appendChild(n);const s=document.createElement("input");s.classList.add("neuroglancer-segment-list-query"),s.addEventListener("focus",()=>{s.select()});const r=this.registerDisposer(new yn(s,Iy));r.allShortcutsAreGlobal=!0;const{segmentQuery:o}=this.layer.displayState,a=this.registerCancellable((0,Fe.A)(()=>{o.value=s.value},200));s.autocomplete="off",s.title=Iy.describe(),s.spellcheck=!1,s.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer((0,_.W1)(l=>{s.value=l},o)),this.registerDisposer((0,_.W1)(l=>{Date.now()-l<100&&(setTimeout(()=>{s.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(s),t.appendChild(this.registerDisposer(new Wt(e.displayState.segmentPropertyMap,(l,c,d)=>{const u=d.registerDisposer(new Dy(o,l,e.displayState,c)),h=d.registerDisposer(new Ty(e.displayState,c)),p=d.registerDisposer(new Wr({source:u,horizontalScroll:!0})),m=d.registerDisposer(new Wr({source:h,horizontalScroll:!0})),g=e.displayState.segmentationGroupState.value,v=d.registerDisposer(new aR(p,u,g,l,o,s,a));v.element.appendChild(p.element),c.appendChild(v.element);const y=d.registerDisposer(new oR(h,g));y.element.appendChild(m.element),c.appendChild(y.element);const S=()=>{const x=u.query.value!==""||u.numMatches>0,E=h.length>0||!x;v.element.style.display=x?"contents":"none",y.element.style.display=E?"contents":"none"};d.registerDisposer(v.statusChanged.add(S)),d.registerDisposer(y.statusChanged.add(S)),v.updateStatus(),y.updateStatus();const w=d.registerCancellable((0,Qe.t)(()=>{u.updateRenderedItems(p),h.updateRenderedItems(m)})),{displayState:b}=this.layer;Bs(b,d,w),d.registerDisposer(b.segmentationGroupState.value.selectedSegments.changed.add(w)),p.element.classList.add("neuroglancer-segment-list"),p.element.classList.add("neuroglancer-preview-list"),m.element.classList.add("neuroglancer-segment-list"),d.registerDisposer(e.bindSegmentListWidth(p.element)),d.registerDisposer(e.bindSegmentListWidth(m.element)),d.registerDisposer(new tn(p.element,Br())),d.registerDisposer(new tn(m.element,Br())),h.segmentWidgetFactory=new Wm(h.segmentationDisplayState,h.parentElement,x=>Pa(void 0,x.id)),m.scrollToTop(),Me(m.header)})).element)}}var zs=G(4472);/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cR{constructor(){zs.A.initializeHead(this)}}const ru=new cR,dR=window.top===window,ou=(0,Fe.A)(()=>{if(!dR)return;const{activeElement:i}=document;if(i===null||i===document.body){const e=zs.A.front(ru);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{ou()},!0),window.addEventListener("blur",()=>{ou()},!0);class za extends T.O8{constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable((0,Fe.A)(()=>{const{activeElement:t}=document,{element:n}=this;n.contains(t)||xc(t)||(t!=null&&(t===this.lastFocusedElement||t.contains(n))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),zs.A.insertBefore(ru,this),this.registerEventListener(e,"focus",()=>{zs.A.pop(this),zs.A.insertAfter(ru,this)}),ou()}disposed(){zs.A.pop(this),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const r2=100;let au=0;const uR=Ae.fromObject({escape:{action:"close"}});class Jr extends T.O8{constructor(){super(),this.keyMap=new Ae,this.keyMap.addParent(uR,Number.NEGATIVE_INFINITY),++au;const e=this.container=document.createElement("div");e.className="overlay";const t=this.content=document.createElement("div");this.registerDisposer(new za(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new yn(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--au,document.body.removeChild(this.container),super.disposed()}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wa(i={}){return Ne({text:"?",...i})}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ay extends T.O8{constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");const{element:t,label:n,topRow:s,selectElement:r,linkedLayers:o,unlinkButton:a}=this;s.appendChild(n),s.appendChild(r),s.appendChild(a),a.textContent="Unlink",a.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(s),t.appendChild(o),this.updateView();const l=(0,Fe.A)(()=>this.updateView(),0);this.registerEventListener(r,"change",()=>{this.updateModel(),l()}),this.registerDisposer(this.group.changed.add(l)),this.registerDisposer(this.group.linkedLayersChanged.add(l)),this.registerDisposer(this.group.layerManager.layersChanged.add(l))}updateModel(){const e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){const{selectElement:e,group:t}=this,{predicate:n}=t;Me(e);const s=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=s?"":"none";const{linkedLayers:r}=this,o=t.linkedLayers.size!==0;if(r.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",Me(r);for(const a of t.linkedLayers){const l=document.createElement("div");l.classList.add("neuroglancer-linked-layer-widget-layer");const c=No({title:"Unlink layer",onClick:()=>{this.group.getGroup(a).isolate()}});l.appendChild(c),l.appendChild(document.createTextNode(a.managedLayer.name)),r.appendChild(l)}}else{e.style.display="";const a=document.createElement("option");e.appendChild(a);let l=0;for(const c of this.group.layerManager.managedLayers){const d=c.layer;if(d!==null&&d!==t.layer&&n(d)){++l;const u=document.createElement("option"),{name:h}=c;u.textContent=h,u.value=h,e.appendChild(u)}}e.value=t.toJSON()??"",this.element.style.display=l===0?"none":""}}}var hR=G(4138);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ha(i={}){return Ne({svg:hR,...i})}var o2=G(1561),pR=G(5237),Ti=G.n(pR),fR=G(2205),gR=G.n(fR);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */gR()(Ti());const mR=500;class Ja extends T.O8{constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=(0,Fe.A)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},mR),this.textEditor=Ti()(s=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));const{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();const n=new IntersectionObserver(s=>{s.some(r=>r.isIntersecting)&&this.textEditor.refresh()},{root:document.body});n.observe(this.element),this.registerDisposer(()=>n.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){const{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value;let n;const{shaderControlState:s}=this.state;s!==void 0?n=s.parseErrors.value:n=[],t===void 0&&n.length===0?this.setValidState(void 0):t!=null||n.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{const r=[];for(const o of n)r.push({message:o.message,severity:"error",from:Ti().Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(const o of t.errorMessages)r.push({message:o.message,severity:"error",from:Ti().Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?r.push({message:t.log,severity:"error",from:Ti().Pos(0)}):r.push({message:t.message,severity:"error",from:Ti().Pos(0)});return r}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){const{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,at(this.element),this.textEditor=void 0,super.disposed()}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vR(i){return{makeControl:(e,t,n)=>{const{watchableValue:s,channelCoordinateSpaceCombiner:r,dataType:o,defaultChannel:a,histogramSpecifications:l,legendShaderOptions:c,histogramIndex:d}=i(e);if(r!==void 0&&a.length!==0){const h=t.registerDisposer(new ui(r.combined)),p=t.registerDisposer(new xs(h,r,{copyButton:!1}));t.registerDisposer(h.changed.add(()=>{const g=h.value,v=Array.from(g,S=>Math.floor(S)),y=s.value;(0,F.r1)(y.channel,v)||(s.value={...s.value,channel:v})}));const m=()=>{const g=h.value,v=s.value;(0,F.r1)(g,v.channel)||(g.set(v.channel),h.changed.dispatch())};m(),t.registerDisposer(s.changed.add(m)),n.labelContainer.appendChild(p.element)}const u=t.registerDisposer(new bf(n.visibility,n.display,o,s,l,d,a.length===0?c:void 0));return{control:u,controlElement:u.element}},activateTool:(e,t)=>{Cf(e,t)}}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yR(i){return{makeControl:(e,t,n)=>{const{watchableValue:s,properties:r,histogramSpecifications:o,legendShaderOptions:a,histogramIndex:l}=i(e);{const h=document.createElement("select");for(const[g,v]of r){const y=document.createElement("option");y.textContent=`${g} (${R[v].toLowerCase()})`,y.value=g,h.appendChild(y)}const p=()=>{const g=h.value,v=r.get(g),{window:y,range:S}=s.value;s.value={window:y!==void 0?Ce(y,v):void 0,range:S!==void 0?Ce(S,v):void 0,property:g,dataType:v}},m=()=>{h.value=s.value.property};t.registerEventListener(h,"change",p),t.registerDisposer(s.changed.add(m)),m(),n.labelContainer.appendChild(h)}const c={changed:s.changed,get value(){let{dataType:h,window:p,range:m}=s.value;return m===void 0&&(m=he[h]),{window:st(p??m),range:m}},set value(h){const{window:p,range:m}=h;s.value={...s.value,window:p,range:m}}},d=(0,_.Uq)(h=>h.dataType,[s]),u=t.registerDisposer(new Cx(n.visibility,n.display,d,c,o,l,a));return{control:u,controlElement:u.element}},activateTool:(e,t)=>{Cf(e,t)}}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function My(i,e){const{shaderControlState:t}=i,n=t.state.get(e);if(n===void 0)return;const{control:s}=n;switch(s.type){case"slider":return Yn(()=>({value:n.trackable,options:{min:s.min,max:s.max,step:s.step}}));case"color":return am(()=>n.trackable);case"checkbox":return Nr(()=>n.trackable);case"imageInvlerp":return vR(()=>({dataType:s.dataType,defaultChannel:s.default.channel,watchableValue:n.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:r(),legendShaderOptions:i.legendShaderOptions}));case"propertyInvlerp":return yR(()=>({properties:s.properties,watchableValue:n.trackable,histogramSpecifications:t.histogramSpecifications,histogramIndex:r(),legendShaderOptions:i.legendShaderOptions}));case"transferFunction":return eE(()=>({dataType:s.dataType,watchableValue:n.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,defaultChannel:s.default.channel,histogramSpecifications:t.histogramSpecifications,histogramIndex:r()}))}function r(o=s.type){const a=c=>{if(o==="imageInvlerp"||o==="transferFunction")return c==="imageInvlerp"||c==="transferFunction";if(o==="propertyInvlerp")return c==="propertyInvlerp";throw new Error(`${o} does not support histogram index.`)};let l=0;for(const[c,{control:{type:d}}]of t.state){if(c===e)break;a(d)&&l++}return l}}function Ny(i,e,t){return{label:t,toolJson:SR(t,e),makeControl:(n,s,r)=>{const o=i(n);return My(o,t).makeControl(n,s,r)},activateTool:(n,s)=>{const r=i(n.tool.layer);return My(r,t).activateTool(n,s)}}}class ja extends Gt{constructor(e,t,n,s={}){super(s.visibility),this.state=e,this.display=t,this.layer=n,this.options=s,this.controlDisposer=void 0;const{toolId:r=Oy}=s;this.toolId=r;const{element:o}=this;o.style.display="contents";const{controls:a}=e;this.registerDisposer(a.changed.add(this.registerCancellable((0,Fe.A)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){const{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Me(e));const t=this.controlDisposer=new T.O8,n=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(const s of this.state.state.keys())e.appendChild(fa(t,this.layer,this.visibility,Ny(n,this.toolId,s)))}disposed(){this.controlDisposer?.dispose(),super.disposed()}}const Oy="shaderControl",_y="control";function SR(i,e){return{type:e,[_y]:i}}class bR extends im{constructor(e,t,n,s){super(e,Ny(()=>t,n,s)),this.layerShaderControls=t,this.control=s,this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable((0,Fe.A)(()=>{t.shaderControlState.state.get(s)===void 0&&this.unbind()}))))}activate(e){const{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}}function Ya(i,e,t=Oy){sn(i,t,(n,s)=>{const r=(0,f.cQ)(s,_y,f.zr);return new bR(n,e(n),t,r)})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Vy(i){return new Ja({fragmentMain:i.displayState.skeletonRenderingOptions.shader,shaderError:i.displayState.shaderError,shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState})}class CR extends Gt{constructor(e){super(),this.layer=e;const{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{const s=this.registerDisposer(new Ay(e.displayState.linkedSegmentationGroup));s.label.textContent="Linked to: ",t.appendChild(s.element)}{const s=this.registerDisposer(new Ay(e.displayState.linkedSegmentationColorGroup));s.label.textContent="Colors linked to: ",t.appendChild(s.element)}for(const s of cm)t.appendChild(fa(this,e,this.visibility,s));const n=this.registerDisposer(new Wt(e.hasSkeletonsLayer,(s,r,o)=>{if(!s)return;const a=document.createElement("div");a.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";const l=document.createElement("div");l.style.flex="1",l.textContent="Skeleton shader:",a.appendChild(l),a.appendChild(Ha({title:"Show larger editor view",onClick:()=>{new wR(this.layer)}})),a.appendChild(Wa({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),r.appendChild(a);const c=o.registerDisposer(Vy(this.layer));r.appendChild(c.element),r.appendChild(o.registerDisposer(new ja(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:tm})).element),c.textEditor.refresh()},this.visibility));t.appendChild(n.element)}}class wR extends Jr{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(Vy(this.layer)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}var xR=Object.defineProperty,ER=Object.getOwnPropertyDescriptor,TR=(i,e,t,n)=>{for(var s=n>1?void 0:n?ER(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&xR(e,t,s),s};/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let jr=class extends vo{constructor(){super(...arguments),this.hashTable=new yd,this.changed=new j.HN}get value(){return this}static makeWithCounterpart(i){const e=new jr;return e.initializeCounterpart(i),e}set_(i,e){return this.hashTable.set(i,e)}set(i,e){if(this.set_(i,e)){const{rpc:t}=this;t&&t.invoke("Uint64Map.set",{id:this.rpcId,key:i,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}get(i,e){return this.hashTable.get(i,e)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(i){return this.hashTable.delete(i)}delete(i){if(this.delete_(i)){const{rpc:e}=this;e&&e.invoke("Uint64Map.delete",{id:this.rpcId,key:i}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}assignFrom(i){this.clear();for(const[e,t]of i.unsafeEntries())this.set(e,t)}clear(){if(this.hashTable.clear()){const{rpc:i}=this;i&&i.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){const i={};for(const[e,t]of this.hashTable.unsafeEntries())i[e.toString()]=t.toString();return i}};jr=TR([yo("Uint64Map")],jr),pt("Uint64Map.set",function(i){const e=this.get(i.id);e.set_(i.key,i.value)&&e.changed.dispatch()}),pt("Uint64Map.delete",function(i){const e=this.get(i.id);e.delete_(i.key)&&e.changed.dispatch()}),pt("Uint64Map.clear",function(i){const e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class DR{constructor(){this.changed=new j.HN,this.data=new Map}dispose(){this.data.clear()}get size(){return this.data.size}get value(){return this}has(e){return this.data.has(BigInt(e.toString()))}add(e){const{data:t}=this;if(Array.isArray(e)){const n=[];for(let s of e){const r=BigInt(s.toString());t.has(r)||(s=s.clone(),n.push(s),t.set(r,s))}n.length!==0&&this.changed.dispatch(n,!0)}else{const n=BigInt(e.toString());if(t.has(n))return;t.set(n,e.clone()),this.changed.dispatch(e,!0)}}[Symbol.iterator](){return this.data.values()}delete(e){const{data:t}=this;if(Array.isArray(e)){const n=[];for(const s of e){const r=BigInt(s.toString());t.has(r)&&(t.delete(r),n.push(s))}n.length!==0&&this.changed.dispatch(n,!1)}else{const n=BigInt(e.toString());if(!t.has(n))return;t.delete(n),this.changed.dispatch(e,!1)}}set(e,t){t?this.add(e):this.delete(e)}clear(){this.data.size>0&&(this.data.clear(),this.changed.dispatch(null,!1))}toJSON(){return Array.from(this.data.keys(),e=>e.toString())}assignFrom(e){this.clear();const t=e.data,{data:n}=this,s=Array.from(t.values());for(const[r,o]of t)n.set(r,o);this.changed.dispatch(s,!0)}}var IR=Object.defineProperty,LR=Object.getOwnPropertyDescriptor,RR=(i,e,t,n)=>{for(var s=n>1?void 0:n?LR(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&IR(e,t,s),s};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let qn=class extends vo{constructor(){super(...arguments),this.hashTable=new mm,this.changed=new j.HN}get value(){return this}static makeWithCounterpart(i){const e=new qn;return e.initializeCounterpart(i),e}set(i,e){e?this.add(i):this.delete(i)}reserve_(i){return this.hashTable.reserve(i)}reserve(i){if(this.reserve_(i)){const{rpc:e}=this;e&&e.invoke("Uint64Set.reserve",{id:this.rpcId,value:i})}}add_(i){let e=!1;for(const t of i)e=this.hashTable.add(t)||e;return e}add(i){const e=Array().concat(i);if(this.add_(e)){const{rpc:t}=this;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(i){let e=!1;for(const t of i)e=this.hashTable.delete(t)||e;return e}delete(i){const e=Array().concat(i);if(this.delete_(Array().concat(i))){const{rpc:t}=this;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){const{rpc:i}=this;i&&i.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){const i=new Array;for(const e of this.unsafeKeys())i.push(e.toString());return i.sort(),i}assignFrom(i){this.clear();for(const e of i.unsafeKeys())this.add(e)}};qn=RR([yo("Uint64Set")],qn),pt("Uint64Set.reserve",function(i){const e=this.get(i.id);e.reserve_(i.value)&&e.changed.dispatch()}),pt("Uint64Set.add",function(i){const e=this.get(i.id);e.add_(i.value)&&e.changed.dispatch()}),pt("Uint64Set.delete",function(i){const e=this.get(i.id);e.delete_(i.value)&&e.changed.dispatch()}),pt("Uint64Set.clear",function(i){const e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kR extends T.O8{constructor(e){super(),this.layer=e,this.specificationChanged=new j.HN,this.localGraph=new RI,this.visibleSegments=this.registerDisposer(qn.makeWithCounterpart(this.layer.manager.rpc)),this.selectedSegments=this.registerDisposer(new DR),this.segmentPropertyMap=new _.B0(void 0),this.graph=new _.B0(void 0),this.segmentEquivalences=this.registerDisposer(Ki.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer((0,_.Uq)(r=>r?.visibleSegmentEquivalencePolicy||Rt.y6.MIN_REPRESENTATIVE,[this.graph])))),this.localSegmentEquivalences=!1,this.maxIdLength=new _.B0(1),this.hideSegmentZero=new nt(!0,!0),this.segmentQuery=new _.DN("",f.zr),this.temporaryVisibleSegments=this.layer.registerDisposer(qn.makeWithCounterpart(this.layer.manager.rpc)),this.temporarySegmentEquivalences=this.layer.registerDisposer(Ki.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=this.layer.registerDisposer(ft.make(this.layer.manager.rpc,!1)),this.useTemporarySegmentEquivalences=this.layer.registerDisposer(ft.make(this.layer.manager.rpc,!1));const{specificationChanged:t}=this;this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch);const{visibleSegments:n,selectedSegments:s}=this;n.changed.add(t.dispatch),s.changed.add(t.dispatch),s.changed.add((r,o)=>{o||(r?n.delete(r):n.clear())}),n.changed.add((r,o)=>{o&&r&&s.add(r)})}restoreState(e){(0,f.MM)(e,od,t=>this.hideSegmentZero.restoreState(t)),(0,f.MM)(e,ha,t=>{this.localGraph.restoreState(t)}),(0,f.MM)(e,cd,t=>{const{segmentEquivalences:n,selectedSegments:s,visibleSegments:r}=this;(0,f.$v)(t,o=>{let a=String(o);const l=a.startsWith("!");l&&(a=a.substring(1));const c=P.R.parseString(a,10),d=n.get(c);s.add(d),l||r.add(d)})}),(0,f.MM)(e,qg,t=>this.segmentQuery.restoreState(t))}toJSON(){const e={};e[od]=this.hideSegmentZero.toJSON();const{selectedSegments:t,visibleSegments:n}=this;t.size>0?e[cd]=[...t].map(r=>n.has(r)?r.toString():"!"+r.toString()):e[cd]=[];const{segmentEquivalences:s}=this;return this.localSegmentEquivalences&&s.size>0&&(e[ha]=s.toJSON()),e[qg]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.selectedSegments.assignFrom(e.selectedSegments),this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}}class PR extends T.O8{constructor(e){super(),this.layer=e,this.specificationChanged=new j.HN,this.segmentColorHash=Sd.getDefault(),this.segmentStatedColors=this.registerDisposer(new jr),this.tempSegmentStatedColors2d=this.registerDisposer(new jr),this.segmentDefaultColor=new ne,this.tempSegmentDefaultColor2d=new _.B0(void 0),this.highlightColor=new _.B0(void 0);const{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.tempSegmentStatedColors2d.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch),this.tempSegmentDefaultColor2d.changed.add(t.dispatch),this.highlightColor.changed.add(t.dispatch)}restoreState(e){(0,f.MM)(e,dd,t=>this.segmentColorHash.restoreState(t)),(0,f.MM)(e,fd,t=>this.segmentDefaultColor.restoreState(t)),(0,f.MM)(e,Kg,t=>{const n=(0,f.vS)(t,s=>me(String(s)));for(const[s,r]of n){const o=P.R.parseString(String(s)),a=new P.R(Ie(r));this.segmentStatedColors.set(o,a)}})}toJSON(){const e={};e[dd]=this.segmentColorHash.toJSON(),e[fd]=this.segmentDefaultColor.toJSON();const{segmentStatedColors:t}=this;if(t.size>0){const n=e[Kg]={};for(const[s,r]of t.unsafeEntries())n[s.toString()]=Ge(tt(r.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.tempSegmentStatedColors2d.assignFrom(e.tempSegmentStatedColors2d),this.segmentDefaultColor.value=e.segmentDefaultColor.value,this.highlightColor.value=e.highlightColor.value}}class By extends T.O8{constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}get changed(){return this.linkedGroup.root.changed}get value(){const e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;const t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){const{curGroupState:n}=this;n!==void 0&&(t.assignFrom(n),n.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){this.curGroupState?.dispose()}}class AR{constructor(e){this.layer=e,this.segmentSelectionState=new FD,this.selectedAlpha=zr(.5),this.saturation=zr(1),this.notSelectedAlpha=zr(0),this.hoverHighlight=new nt(!0,!0),this.silhouetteRendering=new _.DN(0,f.Zw,0),this.objectAlpha=zr(1),this.ignoreNullVisibleSet=new nt(!0,!0),this.skeletonRenderingOptions=new NI,this.shaderError=dr(),this.renderScaleHistogram=new Ps,this.renderScaleTarget=Bi(1),this.selectSegment=this.layer.selectSegment,this.transparentPickEnabled=this.layer.pick,this.baseSegmentColoring=new nt(!1,!1),this.baseSegmentHighlighting=new nt(!1,!1),this.useTempSegmentStatedColors2d=this.layer.registerDisposer(ft.make(this.layer.manager.rpc,!1)),this.filterBySegmentLabel=this.layer.filterBySegmentLabel,this.moveToSegment=t=>{this.layer.moveToSegment(t)},this.linkedSegmentationGroup=this.layer.registerDisposer(new Vg(this.layer.manager.rootLayers,this.layer,t=>t instanceof Ct,t=>t.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new Vg(this.layer.manager.rootLayers,this.layer,t=>t instanceof Ct,t=>t.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=this.layer.registerDisposer(new kR(this.layer)),this.originalSegmentationColorGroupState=this.layer.registerDisposer(new PR(this.layer)),e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new By(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new By(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new _.rG(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new _.DY(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new _.DY(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.tempSegmentStatedColors2d=this.layer.registerDisposer(new _.DY(this.segmentationColorGroupState,t=>t.tempSegmentStatedColors2d)),this.segmentDefaultColor=this.layer.registerDisposer(new _.DY(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.tempSegmentDefaultColor2d=this.layer.registerDisposer(new _.DY(this.segmentationColorGroupState,t=>t.tempSegmentDefaultColor2d)),this.highlightColor=this.layer.registerDisposer(new _.DY(this.segmentationColorGroupState,t=>t.highlightColor)),this.segmentQuery=this.layer.registerDisposer(new _.rG(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new _.rG(this.segmentationGroupState,t=>t.segmentPropertyMap))}}const MR=Zd(Rn);class Ct extends MR{constructor(e){super(e),this.sliceViewRenderScaleHistogram=new Ps,this.sliceViewRenderScaleTarget=Bi(1),this.graphConnection=new _.B0(void 0),this.segmentQueryFocusTime=new _.B0(Number.NEGATIVE_INFINITY),this.selectSegment=(n,s)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=n.clone(),!0),s)},this.filterBySegmentLabel=n=>{const s=Yi(this.displayState,n),{label:r}=s;r&&this.filterSegments(r)},this.filterSegments=n=>{this.displayState.segmentationGroupState.value.segmentQuery.value=n,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer},this.displayState=new AR(this),this.anchorSegment=new _.DN(void 0,n=>n===void 0?void 0:P.R.parseString(n)),this.has2dLayer=this.registerDisposer((0,_.ol)(n=>n.some(s=>s instanceof Vv),{changed:this.layersChanged,value:this.renderLayers})),this.has3dLayer=this.registerDisposer((0,_.ol)(n=>n.some(s=>s instanceof La||s instanceof Ad||s instanceof Ud||s instanceof wv),{changed:this.layersChanged,value:this.renderLayers})),this.hasSkeletonsLayer=this.registerDisposer((0,_.ol)(n=>n.some(s=>s instanceof Ud),{changed:this.layersChanged,value:this.renderLayers})),this.registerDisposer((0,_.aM)((n,s)=>{n.registerDisposer(s.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer((0,_.aM)((n,s)=>{n.registerDisposer(s.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.hoverHighlight.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new CR(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new lR(this)});const t=this.registerDisposer((0,_.Uq)(n=>n===void 0,[this.displayState.segmentationGroupState.value.graph]));this.tabs.add("graph",{label:"Graph",order:-25,getter:()=>new EI(this),hidden:t}),this.tabs.default="rendering"}bindSegmentListWidth(e){return $r(this.displayState,e)}get volumeOptions(){return{volumeType:St.SEGMENTATION}}activateDataSubsources(e){const t=[],n=this.displayState.linkedSegmentationGroup.root.value===this;let s;for(const r of e){if(this.addStaticAnnotations(r))continue;const{volume:o,mesh:a,segmentPropertyMap:l,segmentationGraph:c,local:d}=r.subsourceEntry.subsource;if(o instanceof ln){switch(o.dataType){case R.FLOAT32:r.deactivate("Data type not compatible with segmentation layer");continue}r.activate(()=>r.addRenderLayer(new Vv(o,{...this.displayState,transform:r.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else a!==void 0?r.activate(()=>{const u={...this.displayState,transform:r.getRenderLayerTransform()};if(a instanceof Qi)r.addRenderLayer(new La(this.manager.chunkManager,a,u));else if(a instanceof Ra)r.addRenderLayer(new Ad(this.manager.chunkManager,a,u));else{const h=new OI(this.manager.chunkManager,a,u);r.addRenderLayer(new Ud(h.addRef())),r.addRenderLayer(new wv(h))}},this.displayState.segmentationGroupState.value):l!==void 0?n?(r.activate(()=>{}),t.push(l)):r.deactivate("Not supported on non-root linked segmentation layers"):c!==void 0?n?s!==void 0?r.deactivate("Only one segmentation graph is supported"):(s=c,r.activate(u=>{const h=c.connect(this);u.registerDisposer(()=>{h.dispose(),this.graphConnection.value=void 0});const p={...this.displayState,transform:r.getRenderLayerTransform()},m=h.createRenderLayers(this.manager.chunkManager,p,this.localPosition);this.graphConnection.value=h;for(const g of m)r.addRenderLayer(g)})):r.deactivate("Not supported on non-root linked segmentation layers"):d===As.equivalences?n?s!==void 0?r.deactivate("Only one segmentation graph is supported"):(s=this.displayState.originalSegmentationGroupState.localGraph,r.activate(u=>{this.graphConnection.value=u.registerDisposer(s.connect(this)),u.registerDisposer(()=>{this.graphConnection.value=void 0})})):r.deactivate("Not supported on non-root linked segmentation layers"):r.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=fI(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=s}getLegacyDataSourceSpecifications(e,t,n,s){const r=super.getLegacyDataSourceSpecifications(e,t,n,s),o=(0,f.MM)(t,JT,l=>l===null?null:(0,f.zr)(l)),a=(0,f.MM)(t,jT,l=>l===null?null:(0,f.zr)(l));if(o!==void 0||a!==void 0)for(const l of r)l.enableDefaultSubsources=!1,l.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&r.push(Pr(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),a!=null&&r.push(Pr(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:a,type:"skeletons"}))),t[ha]!==void 0&&s.find(l=>l.url===jc)===void 0&&r.push({url:jc,enableDefaultSubsources:!0,transform:{outputSpace:ki,sourceRank:0,transform:void 0,inputSpace:ki},subsources:new Map}),r}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[td]),this.displayState.saturation.restoreState(e[sd]),this.displayState.notSelectedAlpha.restoreState(e[nd]),this.displayState.hoverHighlight.restoreState(e[rd]),this.displayState.objectAlpha.restoreState(e[id]),this.displayState.baseSegmentColoring.restoreState(e[ad]),this.displayState.silhouetteRendering.restoreState(e[pd]),this.displayState.ignoreNullVisibleSet.restoreState(e[ld]);const{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[pa]);const n=e[YT];n!==void 0&&t.shader.restoreState(n),this.displayState.renderScaleTarget.restoreState(e[ud]),this.anchorSegment.restoreState(e[em]),this.sliceViewRenderScaleTarget.restoreState(e[hd]);const s=(0,f.MM)(e,Xg,f.zr);s!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(s);const r=(0,f.MM)(e,Zg,o=>o===!1?void 0:(0,f.zr)(o),s);r!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(r),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){const e=super.toJSON();e[td]=this.displayState.selectedAlpha.toJSON(),e[nd]=this.displayState.notSelectedAlpha.toJSON(),e[sd]=this.displayState.saturation.toJSON(),e[id]=this.displayState.objectAlpha.toJSON(),e[rd]=this.displayState.hoverHighlight.toJSON(),e[ad]=this.displayState.baseSegmentColoring.toJSON(),e[ld]=this.displayState.ignoreNullVisibleSet.toJSON(),e[pd]=this.displayState.silhouetteRendering.toJSON(),e[em]=this.anchorSegment.toJSON(),e[pa]=this.displayState.skeletonRenderingOptions.toJSON(),e[ud]=this.displayState.renderScaleTarget.toJSON(),e[hd]=this.sliceViewRenderScaleTarget.toJSON();const{linkedSegmentationGroup:t,linkedSegmentationColorGroup:n}=this.displayState;return e[Xg]=t.toJSON(),n.root.value!==t.root.value&&(e[Zg]=n.toJSON()??!1),e[ha]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),n.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:Fm(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":case"star":{if(!this.pick.value)break;const{segmentSelectionState:n}=this.displayState;if(n.hasSelectedSegment){const s=n.selectedSegment,r=this.displayState.segmentationGroupState.value,o=e==="select"?r.visibleSegments:r.selectedSegments,a=!o.has(s);(a||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=a),t.defer(()=>{t.segmentationToggleSegmentState===a&&o.set(s,a)})}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);const n=new P.R;let{value:s}=e;typeof s=="number"&&(s=s.toString()),typeof s!="string"||!n.tryParseString(s)?e.value=void 0:e.value=n}selectionStateToJson(e,t){const n=super.selectionStateToJson(e,t),{value:s}=e;return s instanceof wi?t?n.value={key:s.key.toString(),value:s.value?s.value.toString():void 0,label:s.label}:n.value=(s.value||s.key).toString():s instanceof P.R&&(n.value=s.toString()),n}displaySegmentationSelection(e,t,n){const{value:s}=e;let r;if((typeof s=="number"||typeof s=="string")&&(r=new P.R,!r.tryParseString(s.toString())))return!1;if(s instanceof P.R)r=s.clone();else if(s instanceof wi)r=s.key.clone();else return!1;const{displayState:o}=this,a=Yi(o,r),{segmentEquivalences:l,segmentPropertyMap:{value:c}}=this.displayState.segmentationGroupState.value,d=l.get(r),u=Id(this.displayState,a);if(Bs(o,n,n.redraw),n.registerDisposer($r(o,u)),u.classList.add("neuroglancer-selection-details-segment"),t.appendChild(u),c!==void 0){const{inlineProperties:h}=c.segmentPropertyMap;if(h!==void 0){const p=c.getSegmentInlineIndex(d);if(p!==-1){for(const m of h.properties)if(m.type!=="label"){if(m.type==="description"){const g=m.values[p];if(!g)continue;const v=document.createElement("div");v.classList.add("neuroglancer-selection-details-segment-description"),v.textContent=g,t.appendChild(v)}else if(m.type==="number"||m.type==="string"){const g=m.values[p];if(m.type==="number"?Number.isNaN(g):!g)continue;const v=document.createElement("div");v.classList.add("neuroglancer-selection-details-segment-property");const y=document.createElement("div");y.classList.add("neuroglancer-selection-details-segment-property-name"),y.textContent=m.id,m.description&&(y.title=m.description);const S=document.createElement("div");S.classList.add("neuroglancer-selection-details-segment-property-value"),S.textContent=g.toString(),v.appendChild(y),v.appendChild(S),t.appendChild(v)}}}}}return!0}displaySelectionState(e,t,n){let s=this.displaySegmentationSelection(e,t,n);return super.displaySelectionState(e,t,n)&&(s=!0),s}moveToSegment(e){for(const t of this.renderLayers){if(!(t instanceof Ad||t instanceof La))continue;const n=t.displayState.transform.value;if(n.error!==void 0)return;const{rank:s,globalToRenderLayerDimensions:r}=n,{globalPosition:o}=this.manager.root,a=new Float32Array(s),l=[];for(let d=0;d<s;d++)l[r[d]]=d;(0,F.b8)(a,o.value,l);const c=t instanceof La?t.getObjectPosition(e,a):t.getObjectPosition(e);if(c!==void 0){this.setLayerPosition(n,c);return}}pe.showTemporaryMessage(`No position information loaded for segment ${e}`)}}Ct.type="segmentation",Ct.typeAbbreviation="seg",Ct.supportsPickOption=!0,aD(Ct),$i(Ct),Hg(St.SEGMENTATION,Ct),da(i=>{if(i.mesh!==void 0)return{layerConstructor:Ct,priority:1}}),Ya(Ct,i=>({shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState}),tm),eR(Ct),QL(Ct);var NR=G(9580);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yr(i,e=i.value){i.style.minWidth=e.length+1+"ch"}const Fy="neuroglancer-coordinate-space-transform-singleton";function Uy(i,e,t){let n;t&&(i+=.5,e+=.5),i===Number.NEGATIVE_INFINITY?n="(-\u221E,":n=`[${Math.floor(i)},`;let s;return e===Number.POSITIVE_INFINITY?s="+\u221E)":s=`${Math.floor(e)})`,{lower:n,upper:s}}const $y=Ae.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function Gy(){const i=document.createElement("div"),e=document.createElement("input");i.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),i.appendChild(e);const t=document.createElement("div"),n=document.createElement("span");n.innerHTML=NR,t.appendChild(n);const s=document.createTextNode("");return t.appendChild(s),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),i.appendChild(t),{cellElement:i,inputElement:e,suggestionElement:t}}function zy(i,e,t,n,s){if(e===void 0||e.scale===t&&e.unit===n)i.style.display="none";else{i.style.display="";const r=Ri(e.scale,e.unit,{elide1:!1});i.lastChild.textContent=r,i.title=`${s}${r}`}}function Wy(){const i=document.createElement("input");return i.spellcheck=!1,i.autocomplete="off",i.size=1,i.placeholder=" ",i.classList.add("neuroglancer-coordinate-space-transform-output-name"),i}function Hy(i,e,t){const n=i.map(h=>sr(h.value));if(n.includes(void 0))return!1;const s=Float64Array.from(n,h=>h.scale),r=Array.from(n,h=>h.unit),o=t.value,{scales:a,units:l,rank:c}=o;for(let h=0;h<c;++h)e[h]||(s[h]=a[h],r[h]=l[h]);if((0,F.r1)(a,s)&&(0,F.r1)(l,r))return!1;const d=o.timestamps.map((h,p)=>s[p]===a[p]&&r[p]===l[p]?h:Date.now()),u=Oe({valid:o.valid,rank:o.rank,scales:s,units:r,timestamps:d,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=u,!0}function Jy(i,e,t,n){const s=new Float64Array(i.scales),r=Array.from(i.units);if(s[e]===t&&r[e]===n)return i;const o=Array.from(i.timestamps);return s[e]=t,r[e]=n,o[e]=Date.now(),{...i,scales:s,units:r,timestamps:o}}class OR extends T.O8{constructor(e,t,n){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=n,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=Ne({svg:Fa,text:"S"}),this.addOutputDimensionIcon=Ne({svg:Fa,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=Wy(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=Ne({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{const{transform:L}=this,N=L.value.rank;L.transform=(0,De.DA)(Float64Array,N+1)}}),this.resetToDefaultButton=Ne({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{const{transform:L}=this;if(L.mutableSourceRank)return;const{defaultTransform:N}=L,{outputSpace:k}=N,O=k.ids.map(()=>fs());L.value={...N,outputSpace:{...k,ids:O}}}});const{element:s}=this,r=this.registerDisposer(new yn(s,$y));r.allShortcutsAreGlobal=!0,s.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new tn(s,$y));const o=(0,Qe.t)(()=>this.updateView());this.registerDisposer(e.changed.add(o));const{coefficientContainer:a,translationContainer:l,outputNameContainer:c,inputNameContainer:d,inputScaleContainer:u,inputLowerBoundsContainer:h,inputUpperBoundsContainer:p,outputScaleContainer:m,addOutputDimensionCell:g,addOutputDimensionIcon:v,addSourceDimensionIcon:y,resetToIdentityButton:S,resetToDefaultButton:w}=this;a.style.display="contents",l.style.display="contents",c.style.display="contents",d.style.display="contents",u.style.display="contents",m.style.display="contents",h.style.display="contents",p.style.display="contents";const b=document.createElement("div");b.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),S.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),w.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),b.appendChild(S),b.appendChild(w),s.appendChild(b);for(const[L,N]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){const k=document.createElement("div");k.classList.add(`neuroglancer-coordinate-space-transform-${L}-label`),k.classList.add("neuroglancer-coordinate-space-transform-label"),k.textContent=N,s.appendChild(k)}e.mutableSourceRank&&g.appendChild(y),g.appendChild(v),g.classList.add("neuroglancer-coordinate-space-transform-output-extend");const x="Embed in additional output dimension",E="Extend to additional source dimension";v.title=x,y.title=E,g.appendChild(this.addOutputDimensionInput),g.dataset.isActive="false",v.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=x,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),y.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=E,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),s.appendChild(a),s.appendChild(c),s.appendChild(d),s.appendChild(u),s.appendChild(m),s.appendChild(h),s.appendChild(p),a.appendChild(l),s.addEventListener("input",L=>{const{target:N}=L;if(N instanceof HTMLInputElement){Yr(N);let k=this.inputScaleElements.indexOf(N);if(k!==-1){this.inputScaleModified[k]=!0,this.updateScaleValidity(N);return}if(k=this.outputScaleElements.indexOf(N),k!==-1){this.outputScaleModified[k]=!0,this.updateScaleValidity(N);return}if(k=this.outputNameElements.indexOf(N),k!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(N)){this.updateCoefficientValidity(N);return}}});const D=(L,N,k)=>{Z(s,L,O=>{O.stopPropagation();const V=O.target;if(!(V instanceof HTMLInputElement)||k!==0&&(V.selectionStart!==V.selectionEnd||V.selectionStart!==(k===1?V.value.length:0)))return;const z=this.getElementGridPosition(V);if(z===void 0)return;const Y=this.getElementByGridPosition(z.row+N,z.col+k);Y!==null&&(Y.focus(),O.preventDefault())})};D("move-up",-1,0),D("move-down",1,0),D("move-left",0,-1),D("move-right",0,1);const I=(L,N)=>{L.addEventListener("focusout",k=>{const{relatedTarget:O}=k;O instanceof Node&&L.contains(O)||N(k)})};I(a,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),I(c,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),I(u,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),I(m,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),Z(s,"cancel",L=>{this.curTransform=void 0,this.updateView(),L.target.blur()}),Z(a,"commit",()=>{this.updateModelTransform()}),Z(c,"commit",()=>{this.updateModelOutputNames()}),Z(u,"commit",()=>{this.updateModelInputScales()}),Z(m,"commit",()=>{this.updateModelOutputScales()}),s.addEventListener("focusin",L=>{const{target:N}=L;N instanceof HTMLInputElement&&N.select()}),this.updateView()}updateWillBeDeletedAttributes(e){const{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));const{coefficientElements:n,inputBoundsElements:s,inputScaleElements:r}=this;for(let o=0;o<t;++o){const a=e[o];for(let d=0;d<=t;++d){const u=n[t*d+o],h=d<t&&e[d];u.dataset.willBeDeleted=(a||h).toString()}r[o].dataset.willBeDeleted=a.toString();const{lower:l,upper:c}=s[o];l.dataset.willBeDeleted=a.toString(),c.dataset.willBeDeleted=a.toString()}}updateAddOutputDimensionCellStyle(){const{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){const{outputNameElements:e}=this,t=e.map(l=>l.value),{value:{sourceRank:n,rank:s},mutableSourceRank:r}=this.transform;if(e.length!==s+1)return;const o=jl(t),a=new Array(s);a.fill(!1);for(let l=0;l<=s;++l){let c=o[l];t[l].length===0&&(r||l>=n)&&(c=!0,a[l]=!0),e[l].dataset.isValid=c.toString()}this.updateWillBeDeletedAttributes(a),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){const t=sr(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){const t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{const t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{const t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{const t=this.coefficientElements.indexOf(e),{rank:n}=this.transform.value;if(t!==-1)return{row:t%n,col:Math.floor(t/n)}}{const t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){const{rank:n}=this.transform.value;return e===-1?t<0||t>=n?null:this.inputScaleElements[t]:t===-2?e<0||e>n?null:this.outputNameElements[e]:t===-1?e<0||e>=n?null:this.outputScaleElements[e]:e<0||e>=n||t<0||t>n?null:this.coefficientElements[t*n+e]}dimensionRefCount(e){return(rr(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return Hy(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return Hy(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){const e=this.outputNameElements.map(S=>S.value),{value:t,mutableSourceRank:n}=this.transform,{outputSpace:s,rank:r,sourceRank:o}=t;if(e.length!==r+1)return;const a=[],l=[],c=e[r].length!==0;let d=o;for(let S=0;S<=r;++S){const w=e[S];if(w.length===0){if(S<o){if(!n)return!1;--d}continue}l.push(w),a.push(S)}if(!ho(l))return!1;const u=s.names;if(!c&&(0,F.r1)(u,l))return!0;let h=t.inputSpace,p=t.outputSpace,m=t.transform;if(c){this.addingSourceDimension&&++d;const S=e[r],w=(rr(S)?this.localCombiner:this.globalCombiner).combined.value,b=w.names.indexOf(S);let x,E;b!==-1?(x=w.units[b],E=w.scales[b]):(x="",E=1);const D=h.boundingBoxes.map(I=>Uh(I,r,r+1));this.addingSourceDimension||D.push(Fh(r+1,r)),h=Oe({valid:h.valid,rank:r+1,names:[...h.names,""],ids:[...h.ids,fs()],timestamps:[...h.timestamps,Date.now()],scales:Float64Array.from([...h.scales,E]),units:[...h.units,x],boundingBoxes:D,coordinateArrays:[...h.coordinateArrays,void 0]}),p=Oe({valid:s.valid,rank:r+1,names:[...s.names,S],ids:[...s.ids,fs()],timestamps:[...s.timestamps,Date.now()],scales:Float64Array.from([...s.scales,E]),units:[...s.units,x],coordinateArrays:[...s.coordinateArrays,void 0]}),m=(0,De.Aw)(new Float64Array((r+2)**2),r+1,m,r)}m=Jh(Float64Array,m,h.rank,a,a),h=Kl(h,a),p=Kl(p,a);const g=p.ids.map((S,w)=>{const b=a[w];if(b===r)return S;const x=l[w],E=u[b];return x===E||this.dimensionRefCount(E)===1&&this.dimensionRefCount(x)===(u.includes(x)?1:0)?S:fs()}),v=p.timestamps.map((S,w)=>{const b=a[w];return b===r||l[w]===u[b]?S:Date.now()});p={...p,names:l,ids:g,timestamps:v};const y={rank:p.rank,sourceRank:d,outputSpace:p,inputSpace:h,transform:m};return this.transform.value=y,!0}updateModelTransform(){const e=this.coefficientElements,{rank:t}=this.transform.value,n=new Float64Array((t+1)**2);n[n.length-1]=1;for(let s=0;s<t;++s)for(let r=0;r<=t;++r){const o=e[r*t+s],a=parseFloat(o.value);if(!Number.isFinite(a))return!1;n[r*(t+1)+s]=a}return this.transform.transform=n,!0}updateViewOutputNames(){const{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;const{outputNameElements:n}=this,{names:s}=e;for(let r=0;r<t;++r){const o=n[r];o.value=s[r],o.dataset.isValid="true",Yr(o)}n[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){const{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:n}=this;for(let s=0;s<t;++s)for(let r=0;r<=t;++r){const o=n[r*t+s];o.value=e[r*(t+1)+s].toString(),o.dataset.isValid="true",Yr(o)}}ensureViewRankUpdated(){const e=this.transform.value,{rank:t}=e,n=e.sourceRank;if(this.curSourceRank===n&&this.curRank===t)return;const{inputBoundsElements:s,inputNameElements:r,inputScaleElements:o}=this,{element:a,coefficientElements:l,outputNameElements:c,outputScaleElements:d,outputScaleSuggestionElements:u,inputScaleSuggestionElements:h,outputBoundsElements:p,coefficientContainer:m,translationContainer:g,outputNameContainer:v,inputNameContainer:y,inputScaleContainer:S,inputLowerBoundsContainer:w,inputUpperBoundsContainer:b,outputScaleContainer:x}=this;a.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,a.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Me(m),Me(g),m.appendChild(g),Me(v),Me(y),Me(S),Me(w),Me(b),Me(x),r.length=0,o.length=0,s.length=0,d.length=0,u.length=0,h.length=0,l.length=0,c.length=0,p.length=0;for(let E=0;E<t;++E){const D=I=>{I.classList.add("neuroglancer-coordinate-space-transform-input"),E>=n&&I.classList.add(Fy)};{const I=document.createElement("div");I.classList.add("neuroglancer-coordinate-space-transform-input-name"),D(I),I.style.gridRowStart="sourceNames",I.style.gridColumnStart=`sourceDim ${E+1}`,y.appendChild(I),r.push(I)}{const{cellElement:I,inputElement:L,suggestionElement:N}=Gy();I.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),D(I),I.style.gridRowStart="sourceScales",I.style.gridColumnStart=`sourceDim ${E+1}`,S.appendChild(I),o.push(L),h.push(N);const k=E;N.addEventListener("click",()=>{const O=qh(this.transform,k);O!==void 0&&(this.transform.inputSpace.value=Jy(this.transform.inputSpace.value,k,O.scale,O.unit))})}{const I=document.createElement("div");D(I),I.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),I.style.gridRowStart="sourceLower",I.style.gridColumnStart=`sourceDim ${E+1}`,w.appendChild(I);const L=document.createElement("div");D(L),L.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),L.style.gridRowStart="sourceUpper",L.style.gridColumnStart=`sourceDim ${E+1}`,b.appendChild(L),s.push({lower:I,upper:L})}}for(let E=0;E<t;++E){for(let D=0;D<=t;++D){const I=document.createElement("input");I.classList.add("neuroglancer-coordinate-space-transform-coeff"),I.spellcheck=!1,I.autocomplete="off",I.size=1,I.style.gridRowStart=`outputDim ${E+1}`,I.placeholder=" ",I.style.gridColumnStart=`sourceDim ${D+1}`,l[D*t+E]=I,D===t?I.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):D===n&&I.classList.add(Fy),(D===t?g:m).appendChild(I)}{const{cellElement:D,suggestionElement:I,inputElement:L}=Gy();D.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),D.style.gridRowStart=`outputDim ${E+1}`,D.style.gridColumnStart="outputScales";const N=E;I.addEventListener("click",()=>{const{value:k}=this.transform,O=Kh(k,N);O!==void 0&&(this.transform.outputSpace.value=Jy(k.outputSpace,N,O.scale,O.unit))}),u.push(I),x.appendChild(D),d.push(L)}{const D=document.createElement("div");D.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),D.style.gridRowStart=`outputDim ${E+1}`,D.style.gridColumnStart="outputNames";const I=Wy();I.title="Rebind to a different dimension",E>=n?I.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(I.title+=", or delete to remove source dimension"),I.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",c.push(I),v.appendChild(D),D.appendChild(I);const L=document.createElement("div");L.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),D.appendChild(L);const N=document.createElement("div");N.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),D.appendChild(N),p.push({lower:L,upper:N}),D.addEventListener("mousedown",k=>{k.target!==I&&(I.focus(),k.preventDefault())})}}c.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",v.appendChild(this.addOutputDimensionCell),this.curSourceRank=n,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;const{inputSpace:e,rank:t,sourceRank:n}=this.transform.value,{inputBoundsElements:s,inputNameElements:r,inputScaleElements:o,inputScaleSuggestionElements:a}=this,{names:l,scales:c,units:d,bounds:{lowerBounds:u,upperBounds:h,voxelCenterAtIntegerCoordinates:p}}=e;for(let m=0;m<t;++m){const g=o[m],v=c[m],y=d[m];g.value=Ri(v,y,{elide1:!1}),g.dataset.isValid="true",Yr(g);let S;if(m<n){let E=l[m];E||(E=`${m}`),r[m].textContent=E,S=`source dimension ${E}`,g.title=`Override scale of ${S}`}else S="singleton dimension",g.title=`Set extent of ${S}`;const{lower:w,upper:b}=Uy(u[m],h[m],p[m]),x=s[m];x.lower.textContent=w,x.lower.title=`Lower bound of ${S}`,x.upper.title=`Upper bound of ${S}`,x.upper.textContent=b,zy(a[m],qh(this.transform,m),v,y,`Revert scale of ${S} to `)}}updateViewOutputScales(){const{value:e}=this.transform,{rank:t,names:n,units:s,scales:r,bounds:{lowerBounds:o,upperBounds:a,voxelCenterAtIntegerCoordinates:l}}=e.outputSpace,{outputScaleElements:c,outputBoundsElements:d,outputScaleSuggestionElements:u}=this;for(let h=0;h<t;++h){const p=c[h],m=r[h],g=s[h];p.value=Ri(m,g,{elide1:!1}),Yr(p);const v=n[h];p.dataset.isValid="true";const y=`Change coordinates of ${rr(v)?"local":"global"} dimension ${v}`;p.title=`${y} (does not rescale the source)`;const{lower:S,upper:w}=Uy(o[h],a[h],l[h]),b=d[h];b.lower.textContent=S,b.upper.textContent=w,zy(u[h],Kh(e,h),m,g,`${y} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){const{transform:{value:n,mutableSourceRank:s,defaultTransform:r}}=this,{rank:o}=n;this.resetToIdentityButton.style.visibility=e||!(0,De.Lk)(n.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!s&&(e||t||!xC(r,n))?"visible":"hidden"}updateView(){const e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){at(this.element),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _R(i,e,{horizontal:t=!1,vertical:n=!0,topMargin:s=6,bottomMargin:r=6,leftMargin:o=6,rightMargin:a=6,maxHeight:l=!0,maxWidth:c=!0}={}){const d=e.getBoundingClientRect();if(t){const u=i.ownerDocument.documentElement.clientWidth,h=d.right,p=u-d.left;h>p?(i.style.left="",i.style.right=`${u-d.right}px`,c&&(i.style.maxWidth=h-o+"px")):(i.style.right="",i.style.left=`${d.left}px`,c&&(i.style.maxWidth=p-a+"px"))}if(n){const u=i.ownerDocument.documentElement.clientHeight,h=d.top-s,p=u-d.bottom-r;i.style.left=`${d.left}px`,i.style.width=`${d.width}px`,h>p*3?(i.style.top="",i.style.bottom=`${u-d.top}px`,l&&(i.style.maxHeight=h+"px")):(i.style.top=`${d.bottom}px`,i.style.bottom="",l&&(i.style.maxHeight=p+"px"))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function VR(i){const e=i[Symbol.iterator](),{value:t,done:n}=e.next();if(n)return"";let s=t.length;for(;s>0;){const{value:r,done:o}=e.next();if(o)break;let a=0;for(;a<s&&t.charCodeAt(a)===r.charCodeAt(a);++a);s=a}return t.substring(0,s)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lu="neuroglancer-multiline-autocomplete-completion-active",BR=!1;function FR(i){const e=document.createElement("div");return e.textContent=i.value,e}function*jy(i){for(;i.length>0;){const e=i.match(/[:/_]+/);if(e===null){yield i;return}const t=e.index+e[0].length;yield i.substring(0,t),i=i.substring(t)}}function UR(i){const e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=i.value;const t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=i.description||"",e.appendChild(t),e}const $R=Ae.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),GR=200;class zR extends T.O8{constructor(e){super(),this.element=document.createElement("div"),this.inputElement=document.createElement("span"),this.hintElement=document.createElement("span"),this.completionsVirtualList=void 0,this.onCommit=new j.HN,this.onInput=new j.HN,this.prevInputValue="",this.completionsVisible=!1,this.activeCompletionPromise=null,this.activeCompletionCancellationToken=void 0,this.hasFocus=!1,this.completionResult=null,this.dropdownContentsStale=!0,this.hasResultForDropdown=!1,this.commonPrefix="",this.completionDisabled=-1,this.activeIndex=-1,this.dropdownStyleStale=!0,this.resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()},this.resizeObserver=new ResizeObserver(this.resizeHandler),this.debouncedUpdateHintState=this.registerCancellable((0,Fe.A)(()=>this.updateHintState(),0)),this.completer=e.completer;const{delay:t=GR}=e,n=this.scheduleUpdateCompletions=(0,Fe.A)(()=>{const l=this.activeCompletionCancellationToken=new Je.Qi,c=this.activeCompletionPromise=this.completer(this.value,l);c!==null&&c.then(d=>{this.activeCompletionPromise===c&&(this.setCompletions(d),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{n.cancel()});const{element:s,inputElement:r,hintElement:o}=this;s.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.unobserve(r)),r.contentEditable="true",r.spellcheck=!1,s.appendChild(document.createTextNode("\u200B")),s.appendChild(r),s.appendChild(o),r.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),r.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),r.addEventListener("copy",l=>{const{clipboardData:c}=l;if(c!==null){const d=window.getSelection();d!==null&&!d.isCollapsed&&d.containsNode(r,!0)&&c.setData("text/plain",d.toString())}l.preventDefault(),l.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{const l=this.getSelectionRange(),{completionDisabled:c}=this;l!==void 0&&l.begin===c&&l.end===c||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),s.addEventListener("pointerdown",l=>{const{target:c}=l;if(c instanceof Node){if(r.contains(c))return;const{completionsVirtualList:d}=this;if(d?.element.contains(c))return}r===document.activeElement&&(this.moveCaretToEndOfInput(),l.stopPropagation(),l.preventDefault())}),s.addEventListener("click",()=>{r.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();const l=document.createRange(),{childNodes:c}=r;l.setStart(r,0),c.length===0?l.setEnd(r,0):l.setEndAfter(c[c.length-1]);const d=window.getSelection();d!==null&&(d.removeAllRanges(),d.addRange(l)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus){if(BR)return;this.hasFocus=!1,this.updateDropdown()}this.debouncedUpdateHintState();const l=window.getSelection();l!==null&&l.containsNode(this.inputElement,!0)&&l.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});const a=this.registerDisposer(new yn(r,$R));a.allShortcutsAreGlobal=!0,Z(r,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),Z(r,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),Z(r,"home",()=>{this.moveCaretToBeginningOfInput()}),Z(r,"end",()=>{this.moveCaretToEndOfInput()}),Z(r,"choose-active-completion-or-prefix",l=>{this.selectActiveCompletion(!0)&&l.preventDefault()}),Z(r,"commit",l=>{if(this.selectActiveCompletion(!1))l.stopPropagation();else{const c=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,c)}}),Z(r,"cancel",l=>{l.stopPropagation(),this.cancel()&&(l.detail.preventDefault(),l.detail.stopPropagation())})}disableCompletion(){const e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){const e=window.getSelection();if(e===null||e.rangeCount===0)return;const t=e.getRangeAt(0),{inputElement:n}=this,s=document.createRange();s.setStart(n,0),s.setEnd(t.startContainer,t.startOffset);const r=s.toString().length,o=e.toString().length;return{begin:r,end:r+o}}setValueAndSelection(e,t=void 0){const n=this.completionDisabled!==-1;this.onInput.dispatch(e);const{inputElement:s}=this;Me(s);let r=0;const o=t!==void 0?document.createRange():void 0;let a=!0;for(const l of jy(e)){a||s.appendChild(document.createElement("wbr")),a=!1;const c=r+l.length,d=document.createTextNode(l);if(s.appendChild(d),o!==void 0){const{begin:u,end:h}=t;u>=r&&u<=c&&o.setStart(d,u-r),h>=r&&h<=c&&o.setEnd(d,h-r)}r=c}if(o!==void 0){a&&(o.setStart(s,0),o.setEnd(s,0));const l=window.getSelection();l!==null&&(l.removeAllRanges(),l.addRange(o))}this.completionDisabled=n&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){const{inputElement:e}=this;if(document.activeElement!==e)return!1;const t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!==this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),!this.shouldAttemptCompletion()){this.hideCompletions();return}const{value:e}=this;e!==this.prevInputValue&&(this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions())}handleDropdownClick(e){const{completionsVirtualList:t}=this;if(t===void 0)return;const n=t.element;for(let s=e.target;s instanceof HTMLElement&&s!==n;s=s.parentElement){const r=s.dataset.completionIndex;if(r!==void 0){this.selectCompletion(Number(r));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this;const n=this.completionResult.completions.length;t===-1?e>0?t=0:t=n-1:t=(t+e+n)%n,this.setActiveIndex(t)}shouldShowDropdown(){const{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){const{completionsVirtualList:e,element:t}=this;e!==void 0&&_R(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();const n=this.completionResult,{makeElement:s=FR}=n;e=this.completionsVirtualList=new Wr({source:{length:n.completions.length,render:r=>{const o=n.completions[r],a=s.call(n,o);return a.classList.add("neuroglancer-multiline-autocomplete-completion"),a.dataset.completionIndex=`${r}`,this.activeIndex===r&&a.classList.add(lu),a}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",r=>{this.inputElement.focus(),r.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);const{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();const{completions:t}=e;if(t.length===0)return;const n=this.prevInputValue;if(n!==void 0){if(this.completionResult=e,t.length===1){const s=t[0];e.showSingleResult?this.hasResultForDropdown=!0:s.value.startsWith(n)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;const s=VR(function*(){for(const o of e.completions)yield o.value}()),r=this.getCompletedValue(s);r.startsWith(n)&&(this.commonPrefix=r,this.setHintValue(r))}this.updateDropdown()}}setHintValue(e){const t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);const{hintElement:n}=this;Me(n);let s=!0;for(const r of jy(e)){s||n.appendChild(document.createElement("wbr")),s=!1;const o=document.createTextNode(r);n.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){const{activeIndex:t}=this,{completionsVirtualList:n}=this;if(n!==void 0){if(t!==-1){const s=n.getItemElement(t);s!==void 0&&s.classList.remove(lu)}if(e!==-1){const s=n.getItemElement(e);s!==void 0&&s.classList.add(lu),n.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){const t=this.completionResult,n=this.prevInputValue;return n===void 0?"":n.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){const e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);const n=window.getSelection();n!==null&&(n.removeAllRanges(),n.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){const e=document.createRange(),{inputElement:t}=this,{childNodes:n}=t,s=n[n.length-1];s===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(s),e.setEndAfter(s));const r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;const{completionResult:s}=this;if(s!==null&&s.completions.length===1)t=0;else{const{commonPrefix:r}=this;return r.length>this.value.length?(this.value=r,this.moveCaretToEndOfInput(),!0):!1}}const n=this.getCompletedValueByIndex(t);return this.value===n?!1:(this.value=n,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;const e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";const{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){const{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),at(this.element),this.cancelActiveCompletion(),super.disposed()}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class WR extends zR{constructor(e){const{manager:t}=e.source.layer,n=(r,o)=>t.dataSourceProviderRegistry.completeUrl({url:r,chunkManager:t.chunkManager,cancellationToken:o}).then(a=>({completions:a.completions,makeElement:UR,offset:a.offset,showSingleResult:!0}));super({completer:n,delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new _.B0(!1);const s=r=>{r!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};s(""),this.onInput.add(s)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class cu extends T.O8{constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");const t=this.registerCancellable((0,Qe.t)(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>at(this.element)),this.updateView()}updateView(){const{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;const{element:n}=this;Me(n);const s=new Set;for(const r of e){const o=`${r.severity} ${r.message}`;if(s.has(o))continue;s.add(o);const a=document.createElement("li");n.appendChild(a),a.classList.add("neuroglancer-message"),a.classList.add(`neuroglancer-message-${Tn[r.severity]}`),a.textContent=r.message}}}class HR extends T.O8{constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");const{element:n}=this;n.classList.add("neuroglancer-layer-data-source-subsource");const s=document.createElement("label"),r=document.createElement("span"),o=()=>{s.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));const a=this.registerDisposer(new pn({get value(){return t.enabled},set value(m){t.enabled=m,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));s.classList.add("neuroglancer-layer-data-sources-info-line"),s.appendChild(a.element);const l=document.createElement("span");l.classList.add("neuroglancer-layer-data-sources-source-id");const{id:c}=t.subsourceEntry;c!=="default"&&(l.textContent=c),s.appendChild(l),r.classList.add("neuroglancer-layer-data-sources-source-type");const d=this.registerDisposer(new cu(this.loadedSubsource.messages));n.appendChild(s),s.appendChild(r),n.appendChild(d.element);let u="";const{subsource:h}=t.subsourceEntry,{volume:p}=h;if(p instanceof ln)u=`${R[p.dataType].toLowerCase()} volume`;else if(h.mesh instanceof Qi)u="meshes (single-res.)";else if(h.mesh instanceof Ra)u="meshes (multi-res.)";else if(h.mesh instanceof Oa)u="skeletons";else if(h.segmentPropertyMap!==void 0)u="segment property map";else if(h.local!==void 0)switch(h.local){case As.annotations:u="Local annotations";break;case As.equivalences:u="local segmentation graph";break}else h.staticAnnotations!==void 0?u="default annotations":h.annotation!==void 0?u="annotations":h.singleMesh!==void 0?u="single mesh":h.segmentationGraph!==void 0&&(u="segmentation graph");r.textContent=u}}class JR extends T.O8{constructor(e){super(),this.source=e,this.element=document.createElement("div");const{element:t}=this,n=document.createElement("label");n.classList.add("neuroglancer-layer-data-sources-source-default"),n.appendChild(this.registerDisposer(new pn({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(r){if(e.enableDefaultSubsources!==r){if(e.enableDefaultSubsources=r,r)for(const o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),n.appendChild(document.createTextNode("Enable default subsource set")),n.title="Enable the default set of subsources for this data source.",t.appendChild(n);for(const r of e.subsources)t.appendChild(this.registerDisposer(new HR(e,r)).element);const{transform:s}=e;if(s.mutableSourceRank||s.value.sourceRank!==0){const r=this.registerDisposer(new OR(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(r.element)}this.registerDisposer(()=>at(this.element))}}class jR extends T.O8{constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;const n=this.urlInput=this.registerDisposer(new WR(this)),s=(o,a)=>{const{source:l}=this,c=l.spec,d=this.source.layer;if(o=d.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==n.value&&(n.disableCompletion(),n.setValueAndSelection(o,{begin:o.length,end:o.length})),n.dirty.value=!1,o&&o===c.url){a&&e.detectedLayerConstructor!==void 0&&Yy(l.layer);return}if(d instanceof jn)try{const u=d.manager.dataSourceProviderRegistry.suggestLayerName(o);Jg(d.managedLayer,u)}catch{}l.spec={...c,url:o}};n.onCommit.add(s);const{element:r}=this;r.classList.add("neuroglancer-layer-data-source"),r.appendChild(n.element),r.appendChild(this.registerDisposer(new cu(t.messages)).element),this.updateView()}updateView(){const e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;const{loadState:t}=this.source;let{loadedView:n}=this;if(n!==void 0){if(n.source===t)return;n.dispose(),n=this.loadedView=void 0}t instanceof Yc&&(n=this.loadedView=new JR(t),this.element.appendChild(n.element))}disposed(){const{loadedView:e}=this;e!==void 0&&e.dispose(),at(this.element),super.disposed()}}function Yy(i){if(i instanceof jn){const e=i.detectedLayerConstructor;if(e!==void 0)return Zc(i.managedLayer,e),!0}return!1}class YR extends Gt{constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new Map,this.addDataSourceIcon=qd({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;const{element:t,dataSourcesContainer:n}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),n.classList.add("neuroglancer-layer-data-sources-container");const{addDataSourceIcon:s}=this;if(s.style.alignSelf="start",s.addEventListener("click",()=>{const o=this.layer.addDataSource(void 0);this.updateView();const a=this.sourceViews.get(o);a!==void 0&&a.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof jn){const{layerTypeDetection:o,layerTypeElement:a}=this;o.style.display="none",a.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(a),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{Yy(e)})}const r=this.reRender=(0,Qe.t)(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(r)),this.registerDisposer(this.visibility.changed.add(r)),this.updateView()}updateLayerTypeDetection(){const e=(()=>{const n=this.layer;if(!(n instanceof jn))return;const s=n.detectedLayerConstructor;if(s!==void 0){for(const r of this.sourceViews.values())if(r.urlInput.dirty.value)return;return s}})();if(e===this.detectedLayerConstructor)return;const{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){const{layerTypeElement:n}=this;n.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){const{sourceViews:e}=this;for(const t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;const e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;const t=Date.now(),{sourceViews:n}=this,{layer:s}=this;function*r(){let o=!0;const{dataSources:a}=s;for(const l of a){let c=n.get(l);c===void 0&&(c=new jR(this,l),c.registerDisposer(c.urlInput.dirty.changed.add(this.reRender)),n.set(l,c)),c.seenGeneration=t,c.updateView();const d=l.spec.url;a.length===1&&d===""&&setTimeout(()=>{c.urlInput.inputElement.focus()},0),o=l.spec.url.length===0,yield c.element}o||(yield this.addDataSourceIcon)}nn(this.dataSourcesContainer,r.call(this));for(const[o,a]of n)a.seenGeneration!==t&&(a.dispose(),n.delete(o))}this.updateLayerTypeDetection()}}Ag.push({id:"source",label:"Source",order:-100,getter:i=>new YR(i)});/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class QR extends T.O8{constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);const{element:t,selectElement:n}=this;t.appendChild(n),this.updateView(),this.registerEventListener(n,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,Fe.A)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){const{selectElement:e,ref:t}=this,{filter:n}=t;Me(e);const s=document.createElement("option");e.appendChild(s);for(const r of this.ref.layerManager.managedLayers)if(n(r)){const o=document.createElement("option"),{name:a}=r;o.textContent=a,o.value=a,e.appendChild(o)}e.value=t.layerName||""}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const KR="points",du="annotations",Qy="annotationProperties",Ky="annotationRelationships",qy="crossSectionAnnotationSpacing",Xy="projectionAnnotationSpacing",Zy="shader",eS="shaderControls";function qR(i,e){e!==void 0&&(0,f.$v)(e,(t,n)=>{i.add({type:Re.POINT,id:""+n,point:(0,f.f4)(t),properties:[]})})}function XR(i){const e=i.layer;return e===null||e instanceof Ct}function ZR(i){if(i===void 0)return null;const e=i.layer;return e===null||!(e instanceof Ct)?null:e.displayState}const tS="linkedSegmentationLayer",nS="filterBySegmentation",iS="ignoreNullSegmentFilter",sS="swapVisbleSegmentsOnMove";class ek extends T.O8{constructor(e,t,n){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=n,this.changed=new j.IY,this.curGeneration=-1,this.wasLoading=void 0,this.map=new Map,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){const e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;const{map:n}=this;let s=!1;for(const r of this.annotationStates.relationships){let o=n.get(r);o===void 0&&(o=this.addRelationship(r),s=!0),o.seenGeneration=e}if(!t){const{relationshipStates:r}=this.annotationDisplayState;for(const[o,a]of n)a.seenGeneration!==e&&(n.delete(o),r.delete(o),s=!0)}s&&this.changed.dispatch()}addRelationship(e){const t=this.annotationDisplayState.relationshipStates.get(e),n=new zT(this.layerManager.addRef(),XR);n.registerDisposer(n.changed.add(()=>{t.segmentationState.value=n.layerName===void 0?void 0:ZR(n.layer)}));const{showMatches:s}=t,r={layerRef:n,showMatches:s,seenGeneration:-1};return n.changed.add(this.changed.dispatch),s.changed.add(this.changed.dispatch),this.map.set(e,r),r}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(const e of this.map.values())e.showMatches.reset()}toJSON(){const{map:e}=this;if(e.size===0)return{};let t;const n=[];for(const[s,r]of e){r.showMatches.value&&n.push(s);const{layerName:o}=r.layerRef;o!==void 0&&((t=t||{})[s]=o)}return n.sort(),{[tS]:t,[nS]:n.length===0?void 0:n}}restoreState(e){const{isLoading:t}=this.annotationStates;(0,f.MM)(e,tS,n=>{typeof n=="string"&&(n={segments:n}),(0,f.Rf)(n);for(const s of Object.keys(n)){const r=(0,f.zr)(n[s]);let o=this.map.get(s);if(o===void 0){if(!t)continue;o=this.addRelationship(s)}o.layerRef.layerName=r}for(const[s,r]of this.map)Object.prototype.hasOwnProperty.call(n,s)||(r.layerRef.layerName=void 0)}),(0,f.MM)(e,nS,n=>{typeof n=="boolean"&&(n=n===!0?["segments"]:[]);for(const s of(0,f.si)(n)){let r=this.map.get(s);if(r===void 0){if(!t)continue;r=this.addRelationship(s)}r.showMatches.value=!0}})}disposed(){const{map:e}=this;for(const t of e.values())this.unbind(t);e.clear(),super.disposed()}}class tk extends T.O8{constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;const{element:n}=this,s=this.registerDisposer(new pn(t.showMatches)),r=new QR(t.layerRef);n.appendChild(s.element),n.appendChild(document.createTextNode(e)),n.appendChild(r.element)}}class nk extends T.O8{constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new Map,this.element=document.createElement("div"),this.element.style.display="contents";const t=this.registerCancellable((0,Qe.t)(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){const{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,n=t.changed.count,{widgets:s}=this;function*r(){for(const o of t.relationships){let a=s.get(o);a===void 0&&(a=new tk(o,e.get(o))),a.seenGeneration=n,yield a.element}}for(const[o,a]of s)a.seenGeneration!==n&&(a.dispose(),s.delete(o));nn(this.element,r.call(this))}disposed(){super.disposed();for(const e of this.widgets.values())e.dispose()}}function uu(i){const{localAnnotations:e}=i;if(e){const t=i.manager.root.selectionState.value?.layers.find(n=>n.layer===i);if(t&&t.state.annotationId)return e.get(t.state.annotationId)}}function hu(i,e){const t=i.getReference(e.id);i.update(t,e),i.commit(t)}const rS=class Jb extends gi{constructor(e,t){super(t,!0),this.propertyIdentifier=e}get tag(){const{localAnnotations:e}=this.layer;if(e){const t=e.properties.value.find(n=>n.identifier===this.propertyIdentifier);if(t&&us(t))return t.tag}return"unknown"}activate(e){const{localAnnotations:t}=this.layer;if(!t)return;const n=uu(this.layer);if(n){const{propertyIdentifier:s}=this,r=t.properties.value.findIndex(o=>o.identifier===s);r>-1&&(n.properties[r]=1-n.properties[r],hu(t,n))}e.cancel()}toJSON(){return`${Jb.TOOL_ID}_${this.propertyIdentifier}`}get description(){return`tag ${this.tag}`}};rS.TOOL_ID="tagTool";let Ws=rS;class ik extends Gt{constructor(e){super(),this.layer=e,this.tools=new Set;const{element:t}=this;t.classList.add("neuroglancer-tags-tab");const{localAnnotations:n}=e;if(!n)return;const{properties:s}=n,r=document.createElement("div");r.classList.add("neuroglancer-tags-container"),t.appendChild(r);let o=0,a=[];const l=new ai,c=v=>(l.clearMessages(),a.includes(v)?(l.addMessage({severity:Tn.error,message:`tag: "${v}" already exists`}),!1):!0),d=v=>{const{properties:y}=v;let S=-1;for(const w of y.value){const b=w.identifier.match(/tag([\d]+)/);S++,b&&b.length>1&&(S=parseInt(b[1]))}return`tag${S+1}`},u=v=>{const{value:y}=v;v.validity.valid&&c(y)&&n.addProperty({type:"uint8",tag:y,default:0,description:void 0,identifier:d(n)})},h={length:1,render:v=>{const y=document.createElement("div");y.classList.add("neuroglancer-tag-list-entry");const S=document.createElement("input");if(S.required=!0,y.append(S),v===h.length-1){y.classList.add("add");const w=Wn(this,e.toolBinder,{toolJson:`${Ws.TOOL_ID}__invalid`});y.prepend(w),S.placeholder="Tag name",o<h.length&&setTimeout(()=>{S.focus()},0),S.addEventListener("keyup",x=>{x.key==="Enter"&&u(S)});const b=qd({title:"Add additional tag",onClick:()=>u(S)});y.append(b),o=h.length}else{const w=n.getTagProperties()[v],{tag:b}=w,x=Wn(this,e.toolBinder,{toolJson:`${Ws.TOOL_ID}_${w.identifier}`,title:`Tag selected annotation with ${b}`});y.prepend(x),S.value=b,S.addEventListener("change",()=>{const{value:D}=S;if(!c(D)||!confirm(`Rename tag ${b} to ${D}?`)){S.value=b;return}w.tag=D,s.changed.dispatch();const I=uu(this.layer);I&&hu(n,I)});const E=Mn({title:"Delete tag",onClick:D=>{D.stopPropagation(),D.preventDefault(),confirm(`Delete tag ${b}?`)&&n.removeProperty(w.identifier);const I=uu(this.layer);I&&hu(n,I)}});E.classList.add("neuroglancer-tag-list-entry-delete"),y.append(E)}return y},changed:new j.IY},p=this.registerDisposer(new Wr({source:h}));r.appendChild(p.element);const m=this.registerDisposer(new cu(l));r.appendChild(m.element),p.body.classList.add("neuroglancer-tag-list"),p.element.classList.add("neuroglancer-tag-list-outer");const g=()=>{let v=1,y=0,S=0;const w=n.getTagProperties().map(b=>b.tag);for(const b of w)a.includes(b)?v++:S++;for(const b of a)w.includes(b)||y++;h.length=w.length+1,a=w,(y>0||S>0)&&h.changed.dispatch([{retainCount:v,deleteCount:y,insertCount:S}])};this.registerDisposer(s.changed.add(g)),g()}}const sk=Zd(Rn),pu=class wh extends sk{constructor(e){super(e),this.localAnnotationProperties=new _.B0([]),this.localAnnotationsJson=void 0,this.pointAnnotationsJson=void 0,this.tagTools=[],this.linkedSegmentationLayers=this.registerDisposer(new ek(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState)),this.syncTagTools=n=>{for(const s of this.tagTools)if(!n.includes(s)){Ix(wh,`${Ws.TOOL_ID}_${s}`);for(const[r,o]of this.toolBinder.bindings.entries())o instanceof Ws&&o.propertyIdentifier===s&&this.toolBinder.deleteTool(r)}this.tagTools=this.tagTools.filter(s=>n.includes(s));for(const s of n)this.tagTools.includes(s)||(this.tagTools.push(s),sn(wh,`${Ws.TOOL_ID}_${s}`,r=>new Ws(s,r)))},this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.annotationProjectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.registerDisposer(this.localAnnotationProperties.changed.add(()=>{const{localAnnotations:n}=this;if(n){const s=n.getTagProperties().map(r=>r.identifier);this.syncTagTools(s)}})),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new ok(this)});const t=this.registerDisposer(new _.ww(()=>this.localAnnotations===void 0,this.dataSourcesChanged));this.tabs.add("tags",{label:"Tags",order:10,getter:()=>new ik(this),hidden:t}),this.tabs.default="annotations"}disposed(){const{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){const t=(0,f.MM)(e,Qy,Dh);t&&this.syncTagTools(t.filter(us).map(n=>n.identifier)),super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[du],t&&(this.localAnnotationProperties.value=t||[]),this.localAnnotationRelationships=(0,f.MM)(e,Ky,f.si,["segments"]),this.pointAnnotationsJson=e[KR],this.annotationCrossSectionRenderScaleTarget.restoreState(e[qy]),this.annotationProjectionRenderScaleTarget.restoreState(e[Xy]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[iS]),this.annotationDisplayState.swapVisibleSegmentsOnMove.restoreState(e[sS]),this.annotationDisplayState.shader.restoreState(e[Zy]),this.annotationDisplayState.shaderControls.restoreState(e[eS])}getLegacyDataSourceSpecifications(e,t,n,s){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,n,s);const r=(0,f.MM)(t,"voxelSize",a=>(0,f.Xu)(new Float64Array(3),a,l=>(0,f.Mo)(l)/1e9)),o=["m","m","m"];if(r!==void 0){const a=Oe({rank:3,units:o,scales:r,names:["x","y","z"]});n===void 0?n={outputSpace:a,sourceRank:3,transform:void 0,inputSpace:a}:n={...n,inputSpace:a}}return[{url:bg,transform:n,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){let t=!1,n;for(const s of e){const{subsourceEntry:r}=s,{local:o}=r.subsource,a=c=>n!==void 0&&(0,f.JB)(c.value)!==(0,f.JB)(n.value)?(s.deactivate("Annotation properties are not compatible"),!1):(n=c,!0);if(o===As.annotations){if(t){s.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!a(this.localAnnotationProperties))continue;s.activate(c=>{const d=this.localAnnotations=new Ih(s.loadedDataSource.transform,this.localAnnotationProperties,this.localAnnotationRelationships);try{d.restoreState(this.localAnnotationsJson)}catch{}c.registerDisposer(()=>{d.dispose(),this.localAnnotations=void 0}),c.registerDisposer(this.localAnnotations.changed.add(()=>{this.specificationChanged.dispatch()}));try{qR(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;const u=new jo({localPosition:this.localPosition,transform:c.registerDisposer(Xh(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,s.loadedDataSource.transform,void 0)),source:d.addRef(),displayState:this.annotationDisplayState,dataSource:s.loadedDataSource.layerDataSource,subsourceIndex:s.subsourceIndex,subsourceId:r.id,role:li.ANNOTATION});this.addAnnotationLayerState(u,s)});continue}const{annotation:l}=r.subsource;if(l!==void 0){if(!a(l.properties))continue;s.activate(()=>{const c=new jo({localPosition:this.localPosition,transform:s.getRenderLayerTransform(),source:l,displayState:this.annotationDisplayState,dataSource:s.loadedDataSource.layerDataSource,subsourceIndex:s.subsourceIndex,subsourceId:r.id,role:li.ANNOTATION});this.addAnnotationLayerState(c,s)});continue}s.deactivate("Not compatible with annotation layer")}n&&(0,f.JB)(this.annotationDisplayState.annotationProperties.value)!==(0,f.JB)(n?.value)&&(this.registerDisposer(n.changed.add(()=>{this.annotationDisplayState.annotationProperties.value=[...n.value]})),this.annotationDisplayState.annotationProperties.value=[...n.value])}initializeAnnotationLayerViewTab(e){const t=e.registerDisposer((0,_.ol)(s=>s.some(r=>r.source instanceof Rr),this.annotationStates)),n=e.registerDisposer(new Wt(t,(s,r,o)=>{if(s){{const a=o.registerDisposer(new ga(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));a.label.textContent="Spacing (cross section)",r.appendChild(a.element)}{const a=o.registerDisposer(new ga(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));a.label.textContent="Spacing (projection)",r.appendChild(a.element)}}}));e.element.insertBefore(n.element,e.element.firstChild);{const s=e.registerDisposer(new pn(this.annotationDisplayState.ignoreNullSegmentFilter)),r=document.createElement("label");r.appendChild(document.createTextNode("Ignore null related segment filter")),r.title="Display all annotations if filtering by related segments is enabled but no segments are selected",r.appendChild(s.element),e.element.appendChild(r)}{const s=e.registerDisposer(new pn(this.annotationDisplayState.swapVisibleSegmentsOnMove)),r=document.createElement("label");r.appendChild(document.createTextNode("Swap visible segments when moving to annotation")),r.title="Swap visible segments when moving to annotation",r.appendChild(s.element),e.element.appendChild(r)}e.element.appendChild(e.registerDisposer(new nk(this.linkedSegmentationLayers)).element)}toJSON(){const e=super.toJSON();e[qy]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[Xy]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[du]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[du]=this.localAnnotationsJson),e[Qy]=tC(this.localAnnotationProperties.value);const{localAnnotationRelationships:t}=this;return e[Ky]=t.length===1&&t[0]==="segments"?void 0:t,e[iS]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[sS]=this.annotationDisplayState.swapVisibleSegmentsOnMove.toJSON(),e[Zy]=this.annotationDisplayState.shader.toJSON(),e[eS]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};pu.type="annotation",pu.typeAbbreviation="ann";let Qr=pu;function oS(i){return new Ja({shaderError:i.annotationDisplayState.shaderError,fragmentMain:i.annotationDisplayState.shader,shaderControlState:i.annotationDisplayState.shaderControls})}class rk extends Jr{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(oS(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}class ok extends Gt{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(oS(this.layer));const{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Wt(e.annotationDisplayState.annotationProperties,(r,o)=>{if(r===void 0||r.length===0)return;const a=document.createElement("div");o.appendChild(a),a.classList.add("neuroglancer-annotation-shader-property-list");for(const l of r){const c=document.createElement("div");c.classList.add("neuroglancer-annotation-shader-property");const d=document.createElement("span");d.classList.add("neuroglancer-annotation-shader-property-type"),d.textContent=l.type;const u=document.createElement("span");u.classList.add("neuroglancer-annotation-shader-property-identifier"),u.textContent=`prop_${l.identifier}`,c.appendChild(d),c.appendChild(u);const{description:h}=l;if(h!==void 0&&(c.title=h),us(l)){const p=document.createElement("span");p.classList.add("neuroglancer-annotation-tag-property-type"),p.textContent=`(${l.tag})`,c.appendChild(p)}a.appendChild(c)}})).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";const s=document.createElement("div");s.style.flex="1",s.textContent="Annotation shader:",n.appendChild(s),n.appendChild(Ha({title:"Show larger editor view",onClick:()=>{new rk(this.layer)}})),n.appendChild(Wa({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/annotation/rendering.md"})),t.appendChild(n),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new ja(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}}$i(Qr),$i(Qr,"pointAnnotation"),da(i=>{if(i.local===As.annotations)return{layerConstructor:Qr,priority:100};if(i.annotation!==void 0)return{layerConstructor:Qr,priority:1}}),Ya(Qr,i=>({shaderControlState:i.annotationDisplayState.shaderControls}));/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var fu=(i=>(i[i.DEFAULT=0]="DEFAULT",i[i.ADDITIVE=1]="ADDITIVE",i))(fu||{});const ak=new Map([[0,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA)}],[1,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE)}]]);function lk(i=0){return new Oi.F(fu,i)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const aS=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function ck(i=aS){return Co(i)}function lS(i,e){i.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
void emitIntensity(float value) {
}
`),i.addFragmentCode(Is),Ts(e,i),i.setFragmentMainFunction(ms(e.parseResult.code))}class dk extends Mv{constructor(e,t){const{opacity:n,blendMode:s,shaderControlState:r}=t;super(e,{...t,fallbackShaderParameters:new _.B0(Ho(Er(aS,{imageData:{dataType:e.dataType,channelRank:t.channelCoordinateSpace?.value?.rank??0}}))),encodeShaderParameters:o=>o.key,shaderParameters:r.builderState,dataHistogramSpecifications:r.histogramSpecifications}),this.shaderControlState=r,this.opacity=n,this.blendMode=s,this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),lS(e,t)}initializeShader(e,t,n){const{gl:s}=this;s.uniform1f(t.uniform("uOpacity"),this.opacity.value),vi(s,t,this.shaderControlState,n.parseResult.controls)}setGLBlendMode(e,t){const n=this.blendMode.value;n===fu.ADDITIVE||t>0?(e.enable(e.BLEND),ak.get(n)(e)):e.disable(WebGL2RenderingContext.BLEND)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uk(i=1){return new _.DN(i,f.zo)}var cn=(i=>(i[i.OFF=0]="OFF",i[i.ON=1]="ON",i[i.MAX=2]="MAX",i[i.MIN=3]="MIN",i))(cn||{});function cS(i=0){return new Oi.F(cn,i)}function Xi(i){return i===2||i===3}function dS(i){return Xi(i.mode.value)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hk="volume_rendering/VolumeRenderingRenderLayer",pk="volume_rendering/VolumeRenderingRenderLayer/update",fk=!1,gk=C.w0.create();function mk(i,e,t){let n=0,s=0;for(let c=0;c<3;++c){const d=i[16+c],u=d*e[c],h=d*t[c];n+=Math.min(u,h),s+=Math.max(u,h)}const r=-i[19],o=Math.max(r,n),a=i[23],l=Math.min(a,s);return{near:r,far:a,adjustedNear:o,adjustedFar:l}}function uS(i,e,t,n,s,r){if(n.length===0)return;const{viewMatrix:o,projectionMat:a,displayDimensionRenderInfo:l}=i,{voxelPhysicalScales:c}=l,d=(0,C.xK)(c),u=(0,C.sJ)(a),p=(u/t)**3,m=C.w0.determinant((0,C._A)(gk,o)),g={spatialScales:new Map,activeIndex:-1},v=D=>{const I=n[D];return Math.abs(I.chunkLayout.detTransform*m)};let y=n.length-1,S=v(y);for(let D=y;D>=0;--D){const I=v(D),L=Math.cbrt(I*d/m),N=u/Math.cbrt(I);g.spatialScales.set(L,N),I-p>=0&&(S=I,y=D),g.activeIndex=y}if(fk){console.log(n);for(let D=0;D<n.length;++D){const I=v(D),L=u/Math.cbrt(I);console.log(`scaleIndex=${D} viewVolume=${I} bestScaleIndex=${y} actualViewVolume=${p}, desiredSamples=${L}, difference=${I-p}`)}}const w=Math.cbrt(S*d/m),b=u/Math.cbrt(S);let x=!0;const E=n[y];tg(i,e,E,(D,I)=>{x&&(s(E,y,w,b,I,g),x=!1),r(E,y,D)})}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vk=64,hS=1,yk=10,gu=256,Sk=2**14,bk=!1,mu=Symbol("depthSamplerTextureUnit"),Ck=`
void emitRGBA(vec4 rgba) {
  float correctedAlpha = clamp(rgba.a * uBrightnessFactor * uGain, 0.0, 1.0);
  float weightedAlpha = correctedAlpha * computeOITWeight(correctedAlpha, depthAtRayPosition);
  outputColor += vec4(rgba.rgb * weightedAlpha, weightedAlpha);
  revealage *= 1.0 - correctedAlpha;
}
`,wk=C.pB.create(),xk=new Float32Array(24);function pS(){const i=Math.round(hS+mt*Ir);return[hS,i]}function fS(i){const e=pS(),t=[2**e[0],2**e[1]-1];return Pe(t,Math.round(i))}class Ek extends Gi{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}constructor(e){super(),this.gain=e.gain,this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.depthSamplesTarget=e.depthSamplesTarget,this.chunkResolutionHistogram=e.chunkResolutionHistogram,this.mode=e.mode,this.modeOverride=cS(),this.dataHistogramSpecifications=this.shaderControlState.histogramSpecifications,this.histogramIndexBuffer=this.registerDisposer(ci(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(gu))),this.registerDisposer(this.chunkResolutionHistogram.visibility.add(this.visibility)),this.registerDisposer(this.dataHistogramSpecifications.producerVisibility.add(this.visibility));const t=this.registerDisposer((0,_.Uq)((o,a,l,c)=>({numChannelDimensions:o.rank,mode:l===cn.OFF?a:l,dataHistogramChannelSpecifications:c}),[this.channelCoordinateSpace,this.mode,this.modeOverride,this.dataHistogramSpecifications.channels]));this.shaderGetter=wo(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:a,wireFrame:l})=>`${xt(o)}:${a.shaderKey}:${l}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:a,chunkFormat:l,wireFrame:c},d,u)=>{if(d.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");xi(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`);let h=Ck,p=`
  emitAccumAndRevealage(outputColor, 1.0 - revealage, 0u);
`,m=`
void emitIntensity(float value) {
}
`,g="";if(Xi(u.mode)){const v=u.mode===cn.MIN?"1.0 - value":"value";o.addFragmentCode(`
float savedDepth = 0.0;
float savedIntensity = 0.0;
vec4 newColor = vec4(0.0);
float userEmittedIntensity = -100.0;
`),m=`
float convertIntensity(float value) {
  return clamp(${v}, 0.0, 1.0);
}
void emitIntensity(float value) {
  userEmittedIntensity = value;
}
float getIntensity() {
  float intensity = userEmittedIntensity > -100.0 ? userEmittedIntensity : defaultMaxProjectionIntensity;
  return convertIntensity(intensity);
}
`,h=`
void emitRGBA(vec4 rgba) {
  float alpha = clamp(rgba.a, 0.0, 1.0);
  newColor = vec4(rgba.rgb * alpha, alpha);
}
`,p=`
  gl_FragDepth = savedIntensity;
`,g=`
  float newIntensity = getIntensity();
  bool intensityChanged = newIntensity > savedIntensity;
  savedIntensity = intensityChanged ? newIntensity : savedIntensity; 
  savedDepth = intensityChanged ? depthAtRayPosition : savedDepth;
  outputColor = intensityChanged ? newColor : outputColor;
  emit(outputColor, savedDepth, savedIntensity, uPickId);
  defaultMaxProjectionIntensity = 0.0;
  userEmittedIntensity = -100.0;
`}if(a(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp float","uChunkNumber"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addUniform("highp float","uGain"),o.addUniform("highp uint","uPickId"),o.addVarying("highp vec4","vNormalizedPosition"),o.addTextureSampler("sampler2D","uDepthSampler",mu),o.addVertexCode(tL),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
float depthAtRayPosition;
vec4 outputColor;
float revealage;
void userMain();
`),Ev(o,l,u.numChannelDimensions,"curChunkPosition"),o.addFragmentCode([m,h,`
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGBA(vec4(value, value, value, value));
}
void emitTransparent() {
  emitIntensity(0.0);
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
float computeDepthFromClipSpace(vec4 clipSpacePosition) {
  float NDCDepthCoord = clipSpacePosition.z / clipSpacePosition.w;
  return (NDCDepthCoord + 1.0) * 0.5;
}
vec2 computeUVFromClipSpace(vec4 clipSpacePosition) {
  vec2 NDCPosition = clipSpacePosition.xy / clipSpacePosition.w;
  return (NDCPosition + 1.0) * 0.5;
}
`]),c){let v=`
  emit(outputColor, 0u);
`;Xi(u.mode)&&(v=`
  emit(outputColor, 1.0, uChunkNumber, uPickId);
            `),o.setFragmentMainFunction(`
void main() {
  outputColor = vec4(uChunkNumber, uChunkNumber, uChunkNumber, 1.0);
  emitIntensity(uChunkNumber);
  ${v}
}
`)}else o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  revealage = 1.0;
  for (int rayStep = startStep; rayStep < endStep; ++rayStep) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(rayStep) * stepSize);
    vec4 clipSpacePosition = uModelViewProjectionMatrix * vec4(position, 1.0);
    depthAtRayPosition = computeDepthFromClipSpace(clipSpacePosition);
    vec2 uv = computeUVFromClipSpace(clipSpacePosition);
    float depthInBuffer = texture(uDepthSampler, uv).r;
    bool rayPositionBehindOpaqueObject = (1.0 - depthAtRayPosition) < depthInBuffer;
    if (rayPositionBehindOpaqueObject) {
      break;
    }
    curChunkPosition = position - uTranslation;
    userMain();
    ${g}
  }
  ${p}
}
`);o.addFragmentCode(Is),Ts(d,o),o.addFragmentCode(`
#define main userMain
`+ms(d.parseResult.code)+`
#undef main
`)}}),this.histogramShaderGetter=wo(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayerHistogram",parameters:e.shaderControlState.builderState,getContextKey:({chunkFormat:o})=>`${o.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{chunkFormat:a},l,c)=>{o.addOutputBuffer("vec4","outputValue",null),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp int","uHistogramIndex"),o.addAttribute("float","aInput1"),o.addVertexCode(`
vec3 chunkSamplePosition;
          `);const d=c.numChannelDimensions;a.defineShader(o,d,!0);const{dataType:u}=a;let h="",p="";if(d===0)h+="highp int ignoredChannelIndex";else for(let S=0;S<d;++S)S!==0&&(h+=", "),h+=`highp int channelIndex${S}`,p+=`, channelIndex${S}`;const m=`
${yt(u)} getDataValue(${h}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(chunkSamplePosition), uChunkDataSize - 1.0)));
  return getDataValueAt(p${p});
}`;o.addVertexCode(m),d<=1&&o.addVertexCode(`
${yt(u)} getDataValue() { return getDataValue(0); }
`);const g=c.dataHistogramChannelSpecifications,v=g.length;let y=`
  float x;
  switch (uHistogramIndex) {`;for(let S=0;S<v;++S){const{channel:w}=g[S],b=`getDataValue(${w.join(",")})`,x=`invlerpForHistogram${S}`;o.addVertexCode(Ss(o,x,u,!1)),o.addVertexCode(`
float getHistogramValue${S}() {
  return invlerpForHistogram${S}(${b});
}
`),y+=`
  case ${S}:
    x = getHistogramValue${S}();
    break;`}y+=`
  }
`,o.addVertexCode(Mp),o.setVertexMain(`
  vec3 rand3val = vec3(
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID), float(gl_InstanceID))),
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + float(gl_InstanceID))),
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 20.0, 15.0 + float(gl_InstanceID))));
  chunkSamplePosition = rand3val * (uChunkDataSize - 1.0);
${y}
  if (x == 0.0) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
  }
  else {
    if (x < 0.0) x = 0.0;
    else if (x > 1.0) x = 1.0;
    else x = (1.0 + x * 253.0) / 255.0;
    gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
  }
  gl_PointSize = 1.0;`),o.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
          `)}}),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl)),this.registerDisposer(this.depthSamplesTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.gain.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));const{chunkManager:n}=this.multiscaleSource,s=this.registerDisposer(new Dr(this.layerChunkProgressInfo)),r=n.rpc;s.RPC_TYPE_ID=hk,s.initializeCounterpart(r,{chunkManager:n.rpcId,localPosition:this.registerDisposer(ft.makeFromExisting(r,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(ft.makeFromExisting(r,this.depthSamplesTarget)).rpcId}),this.backend=s}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer((0,_.no)((t,n,s)=>{const r=sa(s,n,o=>this.multiscaleSource.getSources(o),e.messages,this);for(const o of r)for(const a of o)t.registerDisposer(a.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(pk,{layer:this.backend.rpcId,view:e.view.rpcId,sources:ta(r),displayDimensionRenderInfo:s}),this.redrawNeeded.dispatch(),r},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;const n=t.state.sources.value;if(n.length===0)return;let s=0,r=0,o={spatialScales:new Map,activeIndex:0},a=null,l,c;const d=C.eR.create(),{gl:u}=this;this.vertexIdHelper.enable(),this.modeOverride.value=cn.OFF;const{chunkResolutionHistogram:h}=this;h.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const p=()=>{const Y=!Xi(this.mode.value)&&!e.isContinuousCameraMotionInProgress;Xi(this.mode.value)||Y?(u.depthMask(!0),u.disable(WebGL2RenderingContext.BLEND),u.depthFunc(WebGL2RenderingContext.GREATER)):(u.depthMask(!1),u.enable(WebGL2RenderingContext.BLEND),u.depthFunc(WebGL2RenderingContext.LESS),e.bindVolumeRenderingBuffer())},m=()=>{if(a===null)return;a.unbindTransferFunctionTextures(),l!==null&&l.endDrawing(u,a);const Y=a.textureUnit(mu);if(u.activeTexture(WebGL2RenderingContext.TEXTURE0+Y),u.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),S!==0||w!==0){let Q=o.spatialScales.size-1;const X=new Set([fS(r)]);o.spatialScales.forEach((ce,oe)=>{const Se=fS(ce);Q!==o.activeIndex&&!X.has(Se)&&(h.add(oe,ce,0,yk,!0),X.add(Se)),Q--}),h.add(s,r,S,w)}};let g=!0;const{projectionParameters:v}=e;let y,S=0,w=0,b,x=1;const E=this.multiscaleSource.rank,D=C.eR.create(),I=this.getDataHistogramCount()>0&&!e.wireFrame&&!e.sliceViewsPresent&&!e.isContinuousCameraMotionInProgress,L=!Xi(this.mode.value)&&!e.isContinuousCameraMotionInProgress&&!e.wireFrame,k=Xi(this.mode.value)||L?e.pickIDs.register(this):0,O=[],V=[];let z;if(u.enable(WebGL2RenderingContext.CULL_FACE),u.cullFace(WebGL2RenderingContext.FRONT),uS(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,n[0],(Y,Q,X,ce,oe,Se)=>{s=X,r=ce,o=Se;const Ke=Mc(v,Y.chunkLayout),$e=Y.source,{fixedPositionWithinChunk:Tt,chunkDisplayDimensionIndices:we}=Y;for(const ls of we)Tt[ls]=0;const xe=$e.chunkFormat;if(xe!==l&&(l=xe,m(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:xe,wireFrame:e.wireFrame}),a=c.shader,a!==null&&(a.bind(),xe!==null&&(vi(u,a,this.shaderControlState,c.parameters.parseResult.controls),this.bindDepthBufferTexture(e,a),xe.beginDrawing(u,a),xe.beginSource(u,a)))),b=void 0,a===null)return;y=$e.chunks,d.fill(1);const ct=C.pB.multiply(wk,v.viewProjectionMat,Ke.transform),dt=xk;(0,C._S)(dt,ct);const be=C.pB.create();C.pB.invert(be,ct);const{near:Ye,far:bt,adjustedNear:ni,adjustedFar:oo}=mk(dt,Y.lowerClipDisplayBound,Y.upperClipDisplayBound),vh=ce,yh=this.depthSamplesTarget.value,Sh=vh/yh,Dl=(ni-Ye)/(bt-Ye),as=(oo-Ye)/(bt-Ye);z={uNearLimitFraction:Dl,uFarLimitFraction:as,uMaxSteps:this.depthSamplesTarget.value,uBrightnessFactor:Sh,uGain:Math.exp(this.gain.value),uPickId:k,uLowerClipBound:Y.lowerClipDisplayBound,uUpperClipBound:Y.upperClipDisplayBound,uModelViewProjectionMatrix:ct,uInvModelViewProjectionMatrix:be},this.setShaderUniforms(a,z)},Y=>{if(a===null)return;const Q=Y.curPositionInChunks.join(),X=y.get(Q);if(X!==void 0&&X.state===Ue.GPU_MEMORY){const ce=Y.chunkLayout.size,oe=X.chunkDataSize,{chunkDisplayDimensionIndices:Se,fixedPositionWithinChunk:Ke,chunkTransform:{channelToChunkDimensionIndices:$e}}=Y;if(e.wireFrame){const we=x/y.size;u.uniform1f(a.uniform("uChunkNumber"),we),++x}if(oe!==b){b=oe;for(let we=0;we<3;++we){const xe=Se[we];d[we]=xe===-1||xe>=E?1:b[xe]}u.uniform3fv(a.uniform("uChunkDataSize"),d)}const{chunkGridPosition:Tt}=X;for(let we=0;we<3;++we){const xe=Se[we];D[we]=xe===-1||xe>=E?0:ce[we]*Tt[xe]}if(u.uniform3fv(a.uniform("uTranslation"),D),l?.bindChunk(u,a,X,Ke,Se,$e,g),(I||L)&&O.push({chunk:X,fixedPositionWithinChunk:Ke,chunkDisplayDimensionIndices:Se,channelToChunkDimensionIndices:$e,chunkDataDisplaySize:d,chunkFormat:l}),L){const we=C.eR.create(),xe=C.eR.create();C.eR.copy(we,d),C.eR.copy(xe,D),V.push({uChunkDataSize:we,uTranslation:xe})}Fv(u,1,1),g=!1,++S}else++w}),m(),a=null,l=null,L){u.enable(WebGL2RenderingContext.DEPTH_TEST),u.depthMask(!0),u.disable(WebGL2RenderingContext.BLEND),u.depthFunc(WebGL2RenderingContext.GREATER),e.emitter=e.maxProjectionEmit,e.bindMaxProjectionBuffer(),this.modeOverride.value=cn.MAX;const Y=()=>{a!==null&&(a.unbindTransferFunctionTextures(),l!==null&&l.endDrawing(u,a))};g=!0;for(let Q=0;Q<S;++Q){const X=O[Q],ce=V[Q],oe=X.chunkFormat;if(oe!==l&&(l=oe,Y(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:oe,wireFrame:e.wireFrame}),a=c.shader,a!==null&&z!==void 0&&(a.bind(),oe!=null&&(vi(u,a,this.shaderControlState,c.parameters.parseResult.controls),this.bindDepthBufferTexture(e,a),this.setShaderUniforms(a,z),oe.beginDrawing(u,a),oe.beginSource(u,a)))),a===null)break;oe?.bindChunk(u,a,X.chunk,X.fixedPositionWithinChunk,X.chunkDisplayDimensionIndices,X.channelToChunkDimensionIndices,g),u.uniform3fv(a.uniform("uTranslation"),ce.uTranslation),u.uniform3fv(a.uniform("uChunkDataSize"),ce.uChunkDataSize),Fv(u,1,1),g=!1}this.modeOverride.value=cn.OFF}if(this.vertexIdHelper.disable(),u.disable(WebGL2RenderingContext.CULL_FACE),I){let Y=null,Q;const X=()=>{Y!==null&&(Y.unbindTransferFunctionTextures(),l!==null&&l.endDrawing(u,Y))},ce=(we,xe)=>{const ct=Math.ceil(we.reduce((Ye,bt)=>Ye*bt,1)/2),dt=Sk/xe,be=Math.min(ct,dt);return Math.max(Math.round(be/gu),1)};l=null;const{dataType:oe,dataHistogramSpecifications:Se}=this,Ke=Se.getFramebuffers(u),$e=this.getDataHistogramCount();for(let we=0;we<$e;++we)Ke[we].bind(256,1),u.clearColor(0,0,0,1),u.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const Tt=this.dataHistogramSpecifications.bounds.value;u.enable(WebGL2RenderingContext.BLEND),u.disable(WebGL2RenderingContext.DEPTH_TEST);for(let we=0;we<S;++we){g=!0;const xe=O[we],ct=xe.chunkFormat;if(ct!==l)if(l=ct,X(),Q=this.histogramShaderGetter({chunkFormat:ct}),Y=Q.shader,Y!==null)ct!=null&&(ct.beginDrawing(u,Y),ct.beginSource(u,Y)),Y.bind();else break;if(Y===null)break;u.uniform3fv(Y.uniform("uChunkDataSize"),xe.chunkDataDisplaySize),l?.bindChunk(u,Y,xe.chunk,xe.fixedPositionWithinChunk,xe.chunkDisplayDimensionIndices,xe.channelToChunkDimensionIndices,g),this.histogramIndexBuffer.value.bindToVertexAttrib(Y.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const dt=ce(xe.chunkDataDisplaySize,S);for(let be=0;be<$e;++be)Ke[be].bind(256,1),Ni(Y,`invlerpForHistogram${be}`,oe,Tt[be]),u.uniform1i(Y.uniform("uHistogramIndex"),be),u.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,gu,dt);g=!1}if(I&&bk){const we=this.dataHistogramSpecifications.getFramebuffers(u);for(let xe=0;xe<$e;++xe){we[xe].bind(256,1);const ct=new Float32Array(256*4);u.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,ct);const dt=new Float32Array(256);for(let be=0;be<256;++be)dt[be]=ct[be*4];console.log(`histogram${xe}`,dt.join(" "))}}X()}(L||I)&&p()}bindDepthBufferTexture(e,t){const{gl:n}=this;if(e.depthBufferTexture!==void 0&&e.depthBufferTexture!==null){const s=t.textureUnit(mu);n.activeTexture(WebGL2RenderingContext.TEXTURE0+s),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e.depthBufferTexture)}else throw new Error("Depth buffer texture ID for volume rendering is undefined or null")}setShaderUniforms(e,t){const{gl:n}=this;n.uniformMatrix4fv(e.uniform("uModelViewProjectionMatrix"),!1,t.uModelViewProjectionMatrix),n.uniformMatrix4fv(e.uniform("uInvModelViewProjectionMatrix"),!1,t.uInvModelViewProjectionMatrix),n.uniform1f(e.uniform("uNearLimitFraction"),t.uNearLimitFraction),n.uniform1f(e.uniform("uFarLimitFraction"),t.uFarLimitFraction),n.uniform1f(e.uniform("uGain"),t.uGain),n.uniform1ui(e.uniform("uPickId"),t.uPickId),n.uniform1i(e.uniform("uMaxSteps"),t.uMaxSteps),n.uniform3fv(e.uniform("uLowerClipBound"),t.uLowerClipBound),n.uniform3fv(e.uniform("uUpperClipBound"),t.uUpperClipBound),n.uniform1f(e.uniform("uBrightnessFactor"),t.uBrightnessFactor)}isReady(e,t){const n=t.state.sources.value;if(n.length===0)return!0;let s=!1;return uS(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,n[0],()=>{},r=>{const o=r.source.chunks.get(r.curPositionInChunks.join());(o===void 0||o.state!==Ue.GPU_MEMORY)&&(s=!0)}),!s}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tk=Ae.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class Dk{constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");const{element:t,nameContainer:n,nameElement:s,lowerElement:r,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),n.classList.add("neuroglancer-channel-dimensions-widget-name-container"),s.classList.add("neuroglancer-channel-dimensions-widget-name"),n.appendChild(s),r.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(n),t.appendChild(r),t.appendChild(o),n.draggable=!0,s.disabled=!0,s.spellcheck=!1,s.autocomplete="off",s.required=!0,s.placeholder=" ",n.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",n.addEventListener("dblclick",()=>{s.disabled=!1,s.focus(),s.select()}),s.addEventListener("focus",()=>{s.select()})}}class Ik extends T.O8{constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=this.combiner.combined;const{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");const n=this.registerCancellable((0,Qe.t)(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(n));const s=this.registerDisposer(new yn(t,Tk));s.allShortcutsAreGlobal=!0,this.registerDisposer(Z(t,"cancel",r=>{this.forceUpdateView();const{target:o}=r;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;const{coordinateSpace:n}=this;n.value=Qh(n.value,e,t)}makeNewDimensionWidget(e){const t=new Dk(e);return t.nameContainer.addEventListener("dragstart",n=>{this.dragSource=t,n.stopPropagation(),n.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",n=>{const{dragSource:s}=this;if(s===void 0||s===t)return;const{dimensionWidgets:r}=this,o=r.indexOf(s),a=r.indexOf(t);o===-1||a===-1||(n.preventDefault(),this.reorderDimensionTo(a,o))}),t.nameContainer.addEventListener("dragend",n=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",n=>{t.nameElement.disabled=!0;const{relatedTarget:s}=n;this.dimensionWidgets.some(r=>r.nameElement===s)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{const{nameElement:n}=t;$t(n),this.updateNameValidity()}),Z(t.nameElement,"commit",()=>{this.updateNames()}),Z(t.nameElement,"tab-forward",n=>this.selectAdjacentField(n,t,1)),Z(t.nameElement,"tab-backward",n=>this.selectAdjacentField(n,t,-1)),t}selectAdjacentField(e,t,n){e.stopPropagation();const{dimensionWidgets:s}=this,r=s.indexOf(t);if(r===-1)return;const o=r+n;if(o<0||o>=s.length)return;const a=s[o];a.nameElement.disabled=!1,a.nameElement.focus(),e.preventDefault()}updateNames(){const{dimensionWidgets:e,coordinateSpace:t}=this,n=t.value,s=e.map(l=>l.nameElement.value);if(this.combiner.getRenameValidity(s).includes(!1))return!1;const r=n.names;if((0,F.r1)(r,s))return!1;const o=n.timestamps.map((l,c)=>r[c]===s[c]?l:Date.now()),a={...n,names:s,timestamps:o};return t.value=a,!0}updateNameValidity(){const{dimensionWidgets:e}=this,t=e.map(r=>r.nameElement.value),n=t.length,s=this.combiner.getRenameValidity(t);for(let r=0;r<n;++r)e[r].nameElement.dataset.isValid=s[r]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){const{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;const{element:t}=this,n=this.dimensionWidgets,s=this.dimensionWidgets=e.ids.map(o=>n.find(a=>a.id===o)||this.makeNewDimensionWidget(o));function*r(){const{names:o,rank:a,bounds:l}=e;for(let c=0;c<a;++c){const d=s[c];d.nameElement.value=o[c],d.nameElement.dataset.isValid=void 0,$t(d.nameElement);const[u,h]=_h(l,c);d.lowerElement.textContent=u.toString(),d.upperElement.textContent=h.toString(),yield d.element}}nn(t,r.call(this))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vu="opacity",yu="blend",gS="shader",mS="shaderControls",Su="crossSectionRenderScale",vS="channelDimensions",bu="volumeRendering",Cu="volumeRenderingGain",wu="volumeRenderingDepthSamples",Lk=Zd(Rn),[yS,Rk]=pS();class Zi extends Lk{constructor(e){super(e),this.opacity=zr(.5),this.blendMode=lk(),this.fragmentMain=ck(),this.shaderError=dr(),this.dataType=new _.B0(void 0),this.sliceViewRenderScaleHistogram=new Ps,this.sliceViewRenderScaleTarget=Bi(1),this.volumeRenderingGain=uk(0),this.volumeRenderingChunkResolutionHistogram=new Ps(yS),this.volumeRenderingDepthSamplesTarget=Bi(vk,2**yS,2**Rk-1),this.channelCoordinateSpace=new zl,this.channelCoordinateSpaceCombiner=new Ql(this.channelCoordinateSpace,TC),this.channelSpace=this.registerDisposer((0,_.ol)(t=>bo(()=>MC(t)),this.channelCoordinateSpace)),this.volumeRenderingMode=cS(),this.shaderControlState=this.registerDisposer(new Jo(this.fragmentMain,this.registerDisposer((0,_.Uq)((t,n)=>t===void 0?null:{imageData:{dataType:t,channelRank:n.rank}},[this.dataType,this.channelCoordinateSpace],(t,n)=>JSON.stringify(t)===JSON.stringify(n))),this.channelCoordinateSpaceCombiner)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=rr,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.volumeRenderingGain.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRenderingMode.changed.add(this.specificationChanged.dispatch),this.volumeRenderingDepthSamplesTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new kk(this)}),this.tabs.default="rendering"}markLoading(){const e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){const t=super.addCoordinateSpace(e),n=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}activateDataSubsources(e){let t;for(const n of e){if(this.addStaticAnnotations(n))continue;const{subsourceEntry:s}=n,{subsource:r}=s,{volume:o}=r;if(!(o instanceof ln)){n.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){n.deactivate(`Data type must be ${R[o.dataType].toLowerCase()}`);continue}t=o.dataType,n.activate(a=>{n.addRenderLayer(new dk(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));const l=a.registerDisposer(new Ek({gain:this.volumeRenderingGain,multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),depthSamplesTarget:this.volumeRenderingDepthSamplesTarget,chunkResolutionHistogram:this.volumeRenderingChunkResolutionHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace,mode:this.volumeRenderingMode}));a.registerDisposer(n.messages.addChild(l.messages)),a.registerDisposer((0,_.no)((c,d)=>{d!==cn.OFF&&c.registerDisposer(this.addRenderLayer(l.addRef()))},this.volumeRenderingMode)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[vu]),(0,f.MM)(e,yu,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[gS]),this.shaderControlState.restoreState(e[mS]),this.sliceViewRenderScaleTarget.restoreState(e[Su]),this.channelCoordinateSpace.restoreState(e[vS]),(0,f.MM)(e,bu,t=>{typeof t=="boolean"?this.volumeRenderingMode.value=t?cn.ON:cn.OFF:this.volumeRenderingMode.restoreState(t)}),(0,f.MM)(e,Cu,t=>this.volumeRenderingGain.restoreState(t)),(0,f.MM)(e,wu,t=>this.volumeRenderingDepthSamplesTarget.restoreState(t))}toJSON(){const e=super.toJSON();return e[vu]=this.opacity.toJSON(),e[yu]=this.blendMode.toJSON(),e[gS]=this.fragmentMain.toJSON(),e[mS]=this.shaderControlState.toJSON(),e[Su]=this.sliceViewRenderScaleTarget.toJSON(),e[vS]=this.channelCoordinateSpace.toJSON(),e[bu]=this.volumeRenderingMode.toJSON(),e[Cu]=this.volumeRenderingGain.toJSON(),e[wu]=this.volumeRenderingDepthSamplesTarget.toJSON(),e}displayImageSelectionState(e,t){const{value:n}=e;if(n==null)return!1;const s=this.channelSpace.value;if(s.error!==void 0)return!1;const{numChannels:r,coordinates:o,channelCoordinateSpace:{names:a,rank:l}}=s,c=document.createElement("div");c.classList.add("neuroglancer-selection-details-value-grid");let d="[copy] 0fr ";l!==0&&(d+=`repeat(${l}, [dim] 0fr [coord] 0fr) `),d+="[value] 1fr",c.style.gridTemplateColumns=d;for(let u=0;u<r;++u){const h=l===0?n:n[u],p=h==null?"":h.toString(),m=Hn({title:"Copy value",onClick:()=>{mi(p)}});c.appendChild(m);for(let v=0;v<l;++v){const y=document.createElement("div");y.classList.add("neuroglancer-selection-details-value-grid-dim"),y.textContent=a[v],c.appendChild(y);const S=document.createElement("div");S.classList.add("neuroglancer-selection-details-value-grid-coord"),S.textContent=o[u*l+v].toString(),c.appendChild(S)}const g=document.createElement("div");g.classList.add("neuroglancer-selection-details-value-grid-value"),g.textContent=p,c.appendChild(g)}return t.appendChild(c),!0}displaySelectionState(e,t,n){let s=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,n)&&(s=!0),s}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),lS(e,t)},initializeShader:e=>{const t=e.shader;vi(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}}Zi.type="image",Zi.typeAbbreviation="img";function SS(i){return new Ja({shaderError:i.shaderError,fragmentMain:i.fragmentMain,shaderControlState:i.shaderControlState})}const bS=[{label:"Resolution (slice)",toolJson:Su,...ma(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))},{label:"Blending (slice)",toolJson:yu,...md(i=>i.blendMode)},{label:"Opacity (slice)",toolJson:vu,...Yn(i=>({value:i.opacity}))},{label:"Volume rendering (experimental)",toolJson:bu,...md(i=>i.volumeRenderingMode)},{label:"Gain (3D)",toolJson:Cu,isValid:i=>(0,_.Uq)(e=>e===cn.ON,[i.volumeRenderingMode]),...Yn(i=>({value:i.volumeRenderingGain,options:{min:-10,max:10,step:.1}}))},{label:"Resolution (3D)",toolJson:wu,isValid:i=>(0,_.Uq)(e=>e!==cn.OFF,[i.volumeRenderingMode]),...ma(i=>({histogram:i.volumeRenderingChunkResolutionHistogram,target:i.volumeRenderingDepthSamplesTarget}),eD)}];for(const i of bS)gd(Zi,i);class kk extends Gt{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(SS(this.layer));const{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(const r of bS)t.appendChild(fa(this,e,this.visibility,r));const n=document.createElement("div");n.style.flex="1";const s=document.createElement("div");s.className="neuroglancer-image-dropdown-top-row",s.appendChild(document.createTextNode("Shader")),s.appendChild(n),s.appendChild(Ha({title:"Show larger editor view",onClick:()=>{new Pk(this.layer)}})),s.appendChild(Wa({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),t.appendChild(s),t.appendChild(this.registerDisposer(new Ik(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new ja(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class Pk extends Jr{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(SS(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}$i(Zi),Hg(St.IMAGE,Zi),da(i=>{const{volume:e}=i;if(e!==void 0&&e.volumeType===St.UNKNOWN)return{layerConstructor:Zi,priority:-100}}),Ya(Zi,i=>({shaderControlState:i.shaderControlState,legendShaderOptions:i.getLegendShaderOptions()}));var CS=G(957),Ak=Object.defineProperty,Mk=Object.getOwnPropertyDescriptor,Nk=(i,e,t,n)=>{for(var s=n>1?void 0:n?Mk(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&Ak(e,t,s),s};/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let xu=class extends hn{constructor(i,e){super(),this.provider=i,this.registerDisposer(i),this.initializeCounterpart(e)}get(i,e){return this.provider.get(i,e)}};xu=Nk([Zt(CS.P)],xu),pp(CS.y,function(i,e){return this.get(i.providerId).get(i.invalidCredentials,e).then(n=>({value:n}))});/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Eu(i,e){if(e===void 0)return;const t=i.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:xt(e)},()=>new xu(e.addRef(),i.rpc)),n=t.addCounterpartRef();return t.dispose(),n}function lt(){return i=>{class e extends i{constructor(...n){super(...n);const s=n[1];this.credentialsProvider=s.credentialsProvider?.addRef()}initializeCounterpart(n,s){const{credentialsProvider:r}=this;s.credentialsProvider=Eu(this.chunkManager,r),super.initializeCounterpart(n,s)}static encodeOptions(n){const s=i.encodeOptions(n),{credentialsProvider:r}=n;return s.credentialsProvider=r===void 0?void 0:xt(r),s}}return e}}var Hs=G(6015);const wS=!1;var Js=G(3551),ke=G(9808);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Ok(i,e,t,n,s){const r=await(0,Js.Y)(i,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(n)}`,{},d=>d.text(),s),o=new DOMParser().parseFromString(r,"application/xml"),a=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let d=0,u=a.snapshotLength;d<u;++d)l.push(a.snapshotItem(d).textContent||"");const c=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let d=0,u=c.snapshotLength;d<u;++d)l.push(c.snapshotItem(d).textContent||"");return l}async function Tu(i,e,t,n,s){if(!n.startsWith("/"))throw null;const o=await Ok(i,t,n.substring(1),"/",s),a=n.lastIndexOf("/");return{offset:a+e.length+1,completions:o.map(l=>({value:l.substring(a)}))}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function _k(i,e,t,n,s=Je.fx){return await(0,ke.Bk)(`https://${i}.s3.amazonaws.com${e}`,t,n,s)}async function Vk(i,e,t){return await Tu(void 0,`s3://${i}`,`https://${i}.s3.amazonaws.com`,e,t)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Bk(i,e){return i.getCredentialsProvider("middleauthapp",new URL(e).origin)}function Qa(i,e,t){const n=/^\/([^/]+)/,s=t.match(n);if(s!==null)return wS?i.getCredentialsProvider("gcs",{bucket:s[1]}):i.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:s[1]})}function wn(i,e){const t=(0,ke.Dl)(i);switch(t.protocol){case"gs":case"gs+xml":return{credentialsProvider:wS?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:i};case"gs+ngauth+http":return{credentialsProvider:Qa(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:Qa(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:Qa(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:Qa(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return i=i.substr(11),{credentialsProvider:Bk(e,i),url:i};case"s3":return{credentialsProvider:void 0,url:i};default:return{credentialsProvider:void 0,url:i}}}async function Nt(i,e,t,n,s=Je.fx){const r=(0,ke.Dl)(e);switch(r.protocol){case"gs":return(0,Js.Y)(i,`https://www.googleapis.com/storage/v1/b/${r.host}/o/${encodeURIComponent(r.path.substring(1))}?alt=media&neuroglancer=${Te()}`,t,n,s);case"gs+xml":return(0,Js.Y)(i,`https://storage.googleapis.com/${r.host}${r.path}?neuroglancer=${Te()}`,t,n,s);case"s3":return _k(r.host,r.path,t,n,s);default:return(0,Js.Y)(i,e,t,n,s)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fk extends T.O8{constructor(e){super(),this.gl=e,this.buffer=this.registerDisposer(new At(e))}resize(e){let t;if(e<256){const n=t=new Uint8Array(e);for(let s=0;s<e;++s)n[s]=s;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){const n=t=new Uint16Array(e);for(let s=0;s<e;++s)n[s]=s;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{const n=t=new Uint32Array(e);for(let s=0;s<e;++s)n[s]=s;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){const n=e.attribute("aIndexRaw");n>=0&&(this.bindToVertexAttrib(n),t!==0&&this.gl.vertexAttribDivisor(n,t))}}function Uk(i,e,t=!1){const n=e.attribute("aIndexRaw");n>=0&&(t&&i.vertexAttribDivisor(n,0),i.disableVertexAttribArray(n))}function $k(i){return i.memoize.get("IndexBuffer",()=>new Fk(i))}function Gk(i){i.addAttribute("highp uint","aIndexRaw"),i.addVertexCode(To),i.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}class zk{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){const n=t.attribute(this.name);e.bindToVertexAttribI(n,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}}function Wk(i,e){return At.fromData(i,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xS=`void main() {
  emitGray();
}
`;class Hk{constructor(){this.shaderError=dr(),this.fragmentMain=Co(xS),this.shaderControlState=new Jo(this.fragmentMain)}}function ES(i){return yt(i.dataType,i.numComponents)}const es=[],TS=Wi(new Ns,R.FLOAT32,3),Jk=TS;function jk(i){return i.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function DS(i){const e=new Set,t=[];for(const n of i){const s=jk(n);let r="",o=0;for(;e.has(s+r);)r=""+ ++o;t.push(s+r)}return t}class Yk{constructor(e,t){this.attributeNames=e,this.attributeInfo=t,this.tempLightVec=new Float32Array(4),this.textureAccessHelper=new xa("vertexData"),this.indexBufferHelper=new zk("vertexIndex")}defineAttributeAccess(e,t){const{textureAccessHelper:n}=this;n.defineShader(e);const{attributeNames:s}=this;let r=2+s.length;for(let a=es.length;a<r;++a)es[a]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${a}`);r=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",es[r++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",es[r++]),e.addVertexCode(n.getAccessor("readVertexPosition","uVertexAttributeSampler0",R.FLOAT32,3)),e.addVertexCode(n.getAccessor("readVertexNormal","uVertexAttributeSampler1",R.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((a,l)=>{e.addTextureSampler(`${Ca(a.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,es[r]);const c=ES(a);e.addVarying(`highp ${c}`,`vCustom${l}`),e.addFragmentCode(`
#define ${s[l]} vCustom${l}
`),e.addVertexCode(n.getAccessor(`readAttribute${l}`,`uVertexAttributeSampler${r}`,a.dataType,a.numComponents)),o+=`vCustom${l} = readAttribute${l}(${t});
`,++r}),e.addVertexMain(o)}defineShader(e){e.require(Gk),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(Is),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,n){const{lightDirection:s,ambientLighting:r,directionalLighting:o,projectionParameters:a}=n,{viewProjectionMat:l}=a;e.uniformMatrix4fv(t.uniform("uProjection"),!1,l);const c=this.tempLightVec;C.eR.scale(c,s,o),c[3]=r,e.uniform4fv(t.uniform("uLightDirection"),c)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginObject(e,t,n){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,n)}bindVertexData(e,t,n){let s=0;const r=a=>{const l=WebGL2RenderingContext.TEXTURE0+t.textureUnit(es[s]);e.activeTexture(l),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,a),++s};r(n.vertexTexture),r(n.normalTexture);const{attributeNames:o}=this;n.vertexAttributeTextures.forEach((a,l)=>{o[l]!==void 0&&r(a)})}disableVertexData(e,t){let n=2;const s=this.attributeInfo.length,{attributeNames:r}=this;for(let o=0;o<s;++o)r[o]!==void 0&&++n;for(let o=0;o<n;++o){const a=t.textureUnit(es[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(a),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,n,s){s.ensure(n.numIndices).bind(t),this.bindVertexData(e,t,n.vertexData),this.indexBufferHelper.bind(n.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,n.numIndices)}endLayer(e,t){Uk(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}}class Qk{copyToGPU(e,t){const n=(s,r)=>{const o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),wa(e,r,s),o};this.vertexTexture=n(this.vertexPositions,TS),this.normalTexture=n(this.vertexNormals,Jk),this.vertexAttributeTextures=this.vertexAttributes.map((s,r)=>n(s,t[r])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);const{vertexAttributeTextures:t}=this;for(const n of t)e.deleteTexture(n);t.length=0}}class Kk extends Jn{constructor(e,t){super(e);const n=this.vertexData=new Qk;n.vertexPositions=t.vertexPositions,n.vertexNormals=t.vertexNormals,n.vertexAttributes=t.vertexAttributes;const s=this.indices=t.indices;this.numIndices=s.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=Wk(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}}function qk(i){return i.map(e=>Wi(new Ns,e.dataType,e.numComponents))}class Xk extends it(lt()(on),Hs.Fe){constructor(){super(...arguments),this.attributeTextureFormats=qk(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new Kk(this,e)}}const Zk=ar(hn);class eP extends Zk{}class tP extends Gi{constructor(e,t,n){super(),this.source=e,this.displayState=t,this.transform=n,this.shaderManager=new Yk(DS(this.source.info.vertexAttributes.map(r=>r.name)),this.source.info.vertexAttributes),this.shaders=new Map,this.sharedObject=this.registerDisposer(new eP),this.shaderGetter=Ai(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new _.B0(Ho(Er(xS))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:r=>r.key,shaderError:this.displayState.shaderError,defineShader:(r,o)=>{if(o.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Ts(o,r),this.shaderManager.defineShader(r),r.setFragmentMainFunction(ms(o.parseResult.code))}}),this.countingBuffer=this.registerDisposer($k(this.gl)),this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch));const{sharedObject:s}=this;s.visibility.add(this.visibility),s.RPC_TYPE_ID=Hs.nG,s.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){const{shaders:e}=this;for(const t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}isReady(){const e=this.source.chunks.get(Hs.b7);return!(e===void 0||e.state!==Ue.GPU_MEMORY)}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=lr(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(n===void 0)return;const s=this.source.chunks.get(Hs.b7);if(s===void 0||s.state!==Ue.GPU_MEMORY)return;const r=this.shaderGetter(e.emitter),{shader:o,parameters:a}=r;if(o===null)return;const{gl:l}=this,c=this.shaderManager;o.bind(),c.beginLayer(l,o,e),vi(l,o,this.displayState.shaderControlState,a.parseResult.controls);const{pickIDs:d}=e;c.beginObject(l,o,n),e.emitPickID&&c.setPickID(l,o,d.register(this,s.numIndices/3)),c.drawFragment(l,o,s,this.countingBuffer),c.endLayer(l,o)}transformPickedValue(e){const{pickedOffset:t}=e,n=this.source.chunks.get(Hs.b7);if(n===void 0)return;const s=t*3,{indices:r}=n;if(s>=r.length)return;const o=r[s],a=[],{attributeNames:l}=this.shaderManager;return n.vertexData.vertexAttributes.forEach((c,d)=>{const u=l[d];u!==void 0&&a.push(`${u}=${c[o].toPrecision(6)}`)}),a.join(", ")}}function nP(i,e,t){return i.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{const{url:n,credentialsProvider:s}=wn(t,e);return{info:await i.rpc.promiseInvoke(Hs.N3,{chunkManager:i.addCounterpartRef(),credentialsProvider:Eu(i,s),parameters:{meshSourceUrl:n}}),url:n,credentialsProvider:s}})}async function IS(i,e,t){const{info:n,url:s,credentialsProvider:r}=await nP(i,e,t);return i.getChunkSource(Xk,{credentialsProvider:r,parameters:{meshSourceUrl:s,info:n}})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const LS="shader",RS="shaderControls";class Kr extends Rn{constructor(e){super(e),this.managedLayer=e,this.displayState=new Hk,this.vertexAttributes=new _.B0(void 0),this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new sP(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[LS]),this.displayState.shaderControlState.restoreState(e[RS])}activateDataSubsources(e){let t=!1;for(const n of e){const{subsourceEntry:s}=n,{subsource:r}=s,{singleMesh:o}=r;if(o!==void 0){if(t){n.deactivate("Only one single-mesh source supported");continue}t=!0,n.activate(a=>{n.addRenderLayer(new tP(o,this.displayState,n.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,a.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}n.deactivate("Not compatible with image layer")}}toJSON(){const e=super.toJSON();return e[LS]=this.displayState.fragmentMain.toJSON(),e[RS]=this.displayState.shaderControlState.toJSON(),e}}Kr.type="mesh",Kr.typeAbbreviation="mesh";function kS(i){return new Ja({fragmentMain:i.displayState.fragmentMain,shaderError:i.displayState.shaderError,shaderControlState:i.displayState.shaderControlState})}class iP extends T.O8{constructor(e){super(),this.attributes=e,this.element=document.createElement("div"),this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){const{element:e}=this,t=this.attributes.value;if(t===void 0){Me(e);return}const n=DS(t.map(r=>r.name)),s=t.length;for(let r=0;r<s;++r){const o=t[r],a=document.createElement("div");a.className="neuroglancer-single-mesh-attribute";const l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute-type",l.textContent=ES(o);const c=document.createElement("div");if(c.className="neuroglancer-single-mesh-attribute-name",c.textContent=n[r],a.appendChild(l),a.appendChild(c),o.min!==void 0&&o.max!==void 0){const d=document.createElement("neuroglancer-single-mesh-attribute-minmax");d.className="neuroglancer-single-mesh-attribute-range",d.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,a.appendChild(d)}e.appendChild(a)}}disposed(){at(this.element)}}function PS(i){return new iP(i.vertexAttributes)}class sP extends Gt{constructor(e){super(),this.layer=e,this.attributeWidget=this.registerDisposer(PS(this.layer)),this.codeWidget=this.registerDisposer(kS(this.layer));const{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");const n=document.createElement("div");n.className="neuroglancer-single-mesh-dropdown-top-row";const s=document.createElement("div");s.style.flex="1",n.appendChild(s),n.appendChild(Ha({title:"Show larger editor view",onClick:()=>{new rP(this.layer)}})),n.appendChild(Wa({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),t.appendChild(n),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new ja(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}}class rP extends Jr{constructor(e){super(),this.layer=e,this.attributeWidget=this.registerDisposer(PS(this.layer)),this.codeWidget=this.registerDisposer(kS(this.layer)),this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}$i(Kr),da(i=>{if(i.singleMesh!==void 0)return{layerConstructor:Kr,priority:2}}),Ya(Kr,i=>({shaderControlState:i.displayState.shaderControlState}));var Ka=G(2366);/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const AS="boss";function js(i,e,t,n,s=Je.fx){return(0,ke.Bk)(e,t,n,s).catch(r=>{if(r.status!==500&&r.status!==401&&r.status!==403&&r.status!==504)throw r;return(0,Ka.R)(i,e,t,n,o=>{const a=new Headers(t.headers);return a.set("Authorization",`Bearer ${o}`),{...t,headers:a}},o=>{const{status:a}=o;if(a===403||a===401)return"refresh";throw o},s)})}var MS=G(6650);/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oP extends it(lt()(Kn),MS.jj){}class aP extends it(lt()(Qi),MS.Ve){}const Du=new Map;Du.set("image",St.IMAGE),Du.set("annotation",St.SEGMENTATION);const lP=new Set(["npz","jpeg"]),cP=Uint32Array.of(512,512,16);var NS=(i=>(i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS",i))(NS||{});function dP(i){switch(i){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function uP(i,e){(0,f.Rf)(i);const t=(0,f.cQ)(i,"voxel_unit",c=>(0,f.sl)(c,NS)),n=dP(t),s=new Float32Array(3),r=new Float64Array(3),o=new Float64Array(3),a=new Float64Array(3),l=["x","y","z"];for(let c=0;c<3;++c){const d=l[c];s[c]=(0,f.cQ)(i,`${d}_voxel_size`,f.Mo),r[c]=s[c]/n,o[c]=(0,f.cQ)(i,`${d}_start`,f.bX),a[c]=(0,f.cQ)(i,`${d}_stop`,f.bX)}return e.coordFrame={voxelSizeBaseInMeters:r,voxelSizeBaseInOriginalUnits:s,voxelOffsetBase:o,imageSizeBase:a,voxelUnit:t,names:l},e}function hP(i){let e=Du.get(i);return e===void 0&&(e=St.UNKNOWN),e}function pP(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"type",f.zr);let t=!1;return(0,f.cQ)(i,"downsample_status",f.zr)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:(0,f.cQ)(i,"description",f.zr),volumeType:hP(e),dataType:(0,f.cQ)(i,"datatype",s=>(0,f.sl)(s,R)),downsampled:t,scales:[],key:(0,f.cQ)(i,"name",f.zr),baseResolution:(0,f.cQ)(i,"base_resolution",f.bX)}}function fP(i,e,t,n,s,r){(0,f.Rf)(i);const o=(0,f.cQ)(i,"channels",a=>(0,f.$v)(a,l=>vP(e,t,n,r,s,l)));return Promise.all(o).then(a=>{const l=new Map;a.forEach(d=>{l.set(d.key,d)});const c={channels:l,scalingLevels:(0,f.cQ)(i,"num_hierarchy_levels",f.bX),coordFrameKey:(0,f.cQ)(i,"coord_frame",f.zr),coordFrame:void 0,key:(0,f.cQ)(i,"name",f.zr),collection:(0,f.cQ)(i,"collection",f.zr)};return EP(e,t,n,c)})}class gP extends ln{constructor(e,t,n,s,r,o){if(super(e),this.baseUrl=t,this.credentialsProvider=n,this.experimentInfo=s,this.parameters=o,this.meshPath=void 0,this.meshUrl=void 0,r===void 0){const u=Array.from(s.channels.keys());if(u.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(u)}`);r=u[0]}const a=s.channels.get(r);if(a===void 0)throw new Error(`Specified channel ${JSON.stringify(r)} is not one of the supported channels ${JSON.stringify(Array.from(s.channels.keys()))}`);if(this.channel=r,this.channelInfo=a,this.scales=a.scales,s.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(s.key)} does not have a valid coordinate frame`);this.coordinateFrame=s.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[a.scales[0]]),this.experiment=s.key;const l=(0,f.z$)(o.window);if(l!==void 0){const u=C.Zc.create(),h=l.split(/,/);if(h.length===2)u[0]=(0,f.zo)(h[0]),u[1]=(0,f.zo)(h[1]);else if(h.length===1)u[0]=0,u[1]=(0,f.zo)(h[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(l)}`);if(this.window=u,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(l)}.`)}const c=(0,f.z$)(o.meshurl);c!==void 0&&(this.meshUrl=c);let d=(0,f.z$)(o.encoding);if(d===void 0)d=this.dataType===R.UINT8?"jpeg":"npz";else if(!lP.has(d))throw new Error(`Invalid encoding: ${JSON.stringify(d)}.`);this.encoding=d}get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){const t=this.scales[0].downsampleFactors,{rank:n}=this;return(0,F.RO)(this.scales.map(s=>{const r=this.coordinateFrame.voxelOffsetBase,o=C.eR.create();for(let u=0;u<3;++u)o[u]=Math.ceil(r[u]);const a=s.downsampleFactors,l=n+1,c=new Float32Array(l*l);c[c.length-1]=1;for(let u=0;u<3;++u){const h=a[u]/t[u];c[l*u+u]=h,c[l*n+u]=o[u]*h}n===4&&(c[l*3+3]=1);const d=s.imageSize;return qi({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:c,chunkDataSizes:[cP],baseVoxelOffset:o,upperVoxelBound:d,volumeSourceOptions:e}).map(u=>({chunkSource:this.chunkManager.getChunkSource(oP,{credentialsProvider:this.credentialsProvider,spec:u,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:s.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:c}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(aP,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}}const mP=/^([^/?]+)\/([^/?]+)(?:\/([^/?]+))?(?:\?(.*))?$/;function OS(i,e,t,n,s){return i.memoize.getUncounted({hostname:e,collection:s,experiment:n,type:"boss:getExperimentInfo"},()=>js(t,`${e}/latest/collection/${s}/experiment/${n}/`,{},ke.cj).then(r=>fP(r,i,e,t,s,n)))}function vP(i,e,t,n,s,r){return i.memoize.getUncounted({hostname:e,collection:s,experiment:n,channel:r,type:"boss:getChannelInfo"},()=>js(t,`${e}/latest/collection/${s}/experiment/${n}/channel/${r}/`,{},ke.cj).then(pP))}function yP(i,e,t,n,s,r){return i.memoize.getUncounted({hostname:e,collection:n,experiment:s.key,channel:r,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>js(t,`${e}/latest/downsample/${n}/${s.key}/${r}`,{},ke.cj)).then(o=>bP(o,s,r))}function SP(i,e){(0,f.Rf)(i);const t=(0,f.cQ)(i,"voxel_size",o=>(0,f.vS)(o,f.by)),n=(0,f.cQ)(i,"extent",o=>(0,f.vS)(o,f.gG)),s=(0,f.cQ)(i,"num_hierarchy_levels",f.bX),r=new Array;for(let o=0;o<s;o++){const a=String(o),l=t.get(a),c=n.get(a);if(l===void 0||c===void 0)throw new Error(`Missing voxel_size/extent for resolution ${a}.`);const d=new Float32Array(3);for(let u=0;u<3;++u)d[u]=l[u]/e[u];r[o]={downsampleFactors:d,imageSize:c,key:a}}return r}function bP(i,e,t){const n=e.coordFrame;if(n===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);const s=e.channels.get(t);if(s===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return s.scales=SP(i,n.voxelSizeBaseInOriginalUnits),e.channels.set(t,s),e}function CP(i,e,t,n){const s=n.match(mP);if(s===null)throw new Error(`Invalid volume path ${JSON.stringify(n)}`);const r=s[1],o=s[2],a=s[3],l=(0,f.bL)(s[4]||"");return i.memoize.getUncounted({hostname:e,path:n,type:"boss:getVolume"},async()=>{const c=await OS(i,e,t,o,r),d=await yP(i,e,t,r,c,a),u=new gP(i,e,t,d,a,l),h=d.coordFrame,p={lowerBounds:h.voxelOffsetBase,upperBounds:Float64Array.from(h.imageSizeBase,(v,y)=>h.voxelOffsetBase[y]+v)},m=Oe({rank:3,names:h.names,units:["m","m","m"],scales:h.voxelSizeBaseInMeters,boundingBoxes:[En(p)]});return{modelTransform:wt(m),subsources:[{id:"default",default:!0,subsource:{volume:u}},{id:"bounds",default:!0,subsource:{staticAnnotations:xn(p)}}]}})}const _S=/^((?:http|https):\/\/[^/?]+)\/(.*)$/;function wP(i,e,t){return i.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>js(t,`${e}/latest/collection/`,{},ke.cj).then(n=>(0,f.cQ)(n,"collections",s=>(0,f.$v)(s,f.zr))))}function xP(i,e,t,n){return i.memoize.getUncounted({hostname:e,collection:n,type:"boss:getExperiments"},()=>js(t,`${e}/latest/collection/${n}/experiment/`,{},ke.cj).then(s=>(0,f.cQ)(s,"experiments",r=>(0,f.$v)(r,f.zr))))}function EP(i,e,t,n){const s=n.coordFrameKey;return i.memoize.getUncounted({hostname:e,coordinateframe:s,experimentInfo:n,type:"boss:getCoordinateFrame"},()=>js(t,`${e}/latest/coord/${s}/`,{},ke.cj).then(r=>uP(r,n)))}function TP(i,e,t,n){const s=n.match(/^(?:([^/]+)(?:\/?([^/]*)(?:\/?([^/]*)(?:\/?([^/]*)?))?)?)?$/);if(s===null||s[1]===void 0)return Promise.reject(null);if(s[2]===void 0){const r=s[1]||"";return wP(i,e,t).then(o=>({offset:0,completions:Ht(r,o,a=>a+"/",()=>{})}))}if(s[3]===void 0){const r=s[2]||"";return xP(i,e,t,s[1]).then(o=>({offset:s[1].length+1,completions:Ht(r,o,a=>a+"/",()=>{})}))}return OS(i,e,t,s[2],s[1]).then(r=>{const o=Ht(s[3],r.channels,a=>a[0],a=>`${a[1].channelType} (${R[a[1].dataType]})`);return{offset:s[1].length+s[2].length+2,completions:o}})}function DP(i){const e=i.match(/^(?:https:\/\/[^.]+([^/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${i}.`);return`https://auth${e[1]}/auth`}class IP extends Jt{constructor(e){super(),this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){const t=DP(e);return this.credentialsManager.getCredentialsProvider(AS,t)}get(e){const t=e.providerUrl.match(_S);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);const n=this.getCredentialsProvider(e.providerUrl);return CP(e.chunkManager,t[1],n,t[2])}async completeUrl(e){const t=e.providerUrl.match(_S);if(t===null)throw null;const n=t[1],s=this.getCredentialsProvider(t[1]),r=t[2],o=await TP(e.chunkManager,n,s,r);return yi(t[1].length+1,o)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const VS=new Map;function Ot(i,e){VS.set(i,e)}function LP(i){const e=new xT(i.credentialsManager);for(const[t,n]of VS)try{e.register(t,n(i))}catch(s){console.warn(`Skipping ${t} data source: ${s}`)}return e}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("boss",i=>new IP(i.credentialsManager));/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nn extends T.O8{constructor(){super(...arguments),this.errorHandler=async(e,t)=>{const{status:n}=e;if(n===401||n===403&&!t.accessToken)return"refresh";throw e instanceof Error&&t.email!==void 0&&(e.message+=`  (Using credentials for ${JSON.stringify(t.email)})`),e}}}function BS(i){let e,t,n;return(s,r)=>t!==void 0&&(e===void 0||s===void 0||e.generation!==s.generation)?(e===void 0&&n.addConsumer(r),t):(e=void 0,n=new Je.y3,t=i(s,n).then(o=>(e=o,n=void 0,o),o=>{throw n.isCanceled&&(n=void 0,t=void 0),o}),t)}function Xn(i){let e=0;return BS((t,n)=>i(n).then(s=>({generation:++e,credentials:s})))}class RP{constructor(){this.providers=new Map,this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){const n=this.providers.get(e);if(n===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return n(t,this.topLevelManager)}}class kP extends T.O8{constructor(e){super(),this.base=e,this.memoize=new rg.e}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class PP extends kP{constructor(){super(new RP),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class AP extends Nn{constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=BS(n=>this.anonymous&&n===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(n)))}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zn=new PP;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class MP{constructor(){this.finished=new j.HN}}class NP{constructor(){this.oidcCallbackService="bossAuthCallback",this.pendingRequests=new Map,this.registerListener()}registerListener(){addEventListener("message",e=>{if(e.origin===location.origin)try{const t=(0,f.Rf)(JSON.parse(e.data));if((0,f.zr)(t.service)===this.oidcCallbackService){const s=(0,f.zr)(t.access_token),r=(0,f.zr)(t.state),o=this.pendingRequests.get(r);if(o===void 0)return;o.finished.dispatch(s)}}catch{}})}addPendingRequest(e){const t=new MP;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${e.authServer}/realms/BOSS/protocol/openid-connect/auth?`;return t+=`client_id=${encodeURIComponent(e.clientId)}`,t+=`&redirect_uri=${encodeURIComponent(e.redirect_uri)}`,t+="&response_mode=fragment",t+="&response_type=code%20id_token%20token",e.state&&(t+=`&state=${e.state}`),e.nonce&&(t+=`&nonce=${e.nonce}`),t}}let Iu;function OP(){return Iu===void 0&&(Iu=new NP),Iu}function _P(i,e=Je.fx){const t=Te(),n=Te(),s=OP(),r=s.makeAuthRequestUrl({state:t,clientId:i.clientId,redirect_uri:new URL(G(2974),G.b).href,authServer:i.authServer,nonce:n}),o=s.addPendingRequest(t),a=new Promise((l,c)=>{o.finished.add((d,u)=>{d!==void 0?l(d):c(u)})});if(o.finished.add(e.add(()=>{o.finished.dispatch(void 0,Je.wS)})),!e.isCanceled){const l=open(r);l!==null&&o.finished.add(()=>{l.close()})}return a}class VP extends Nn{constructor(e){super(),this.authServer=e,this.get=Xn(t=>{const n=new pe(!0);let s;return new Promise((r,o)=>{const a=()=>{s=void 0,n.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,n.dispose(),o(Je.wS))});function l(u="Boss authorization required.",h="Request authorization."){n.setText(u+" ");const p=document.createElement("button");p.textContent=h,n.element.appendChild(p),p.addEventListener("click",()=>{d()}),n.setVisible(!0)}const c=this.authServer;function d(){s!==void 0&&s.cancel(),s=new Je.Qi,l("Waiting for Boss authorization...","Retry"),_P({realm:"boss",clientId:"endpoint",authServer:c},s).then(u=>{s!==void 0&&(a(),r(u))},u=>{s!==void 0&&(s=void 0,l(`Boss authorization failed: ${u}.`,"Retry"))})}l()})})}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Zn.register(AS,i=>new VP(i));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Lu="google-brainmaps";function Ys(i,e,t,n=Je.fx){return(0,Js.Y)(e,`${i.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?ke.cj:ke.Rc,n)}var jt=G(2020);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class BP extends it(lt()(Kn),jt.CR){}class FP extends it(lt()(Ra),jt.Ip){}class UP extends it(lt()(Qi),jt.Ve){}class $P extends it(lt()(Oa),jt.NV){}class GP extends it(lt()(ra),jt.Rw){}const qr=new Map;qr.set("UINT8",R.UINT8),qr.set("FLOAT",R.FLOAT32),qr.set("UINT32",R.UINT32),qr.set("UINT64",R.UINT64);function zP(i){(0,f.Rf)(i);try{return{corner:(0,f.cQ)(i,"corner",e=>(0,f.DW)(C.eR.create(),e,f.zo)),size:(0,f.cQ)(i,"size",e=>(0,f.DW)(C.eR.create(),e,f.Mo)),metadata:(0,f.cQ)(i,"metadata",f.z$)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}class WP{constructor(e){try{(0,f.Rf)(e),this.numChannels=(0,f.cQ)(e,"channelCount",f.We),this.dataType=(0,f.cQ)(e,"channelType",t=>(0,f.j3)(t,qr)),this.voxelSize=(0,f.cQ)(e,"pixelSize",t=>(0,f.DW)(C.eR.create(),t,f.Mo)),this.upperVoxelBound=(0,f.cQ)(e,"volumeSize",t=>(0,f.DW)(C.eR.create(),t,f.We)),this.boundingBoxes=(0,f.cQ)(e,"boundingBox",t=>t===void 0?[]:(0,f.$v)(t,zP))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}}function HP(i){return(0,f.Rf)(i),{name:(0,f.cQ)(i,"name",f.zr),type:(0,f.cQ)(i,"type",f.zr)}}function JP(i){try{return(0,f.Rf)(i),(0,f.cQ)(i,"meshes",e=>e===void 0?[]:(0,f.$v)(e,HP))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}const jP="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",Ru="([0-9]+)",FS=new RegExp(`^(.*)_${Ru}x${Ru}x${Ru}_lod([0-9]+)_${jP}$`);function YP(i,e){const t=new Map,n=i.scales[0],s=new Set;for(const o of e){if(o.type!=="TRIANGLES")continue;const a=o.name.match(FS);if(a===null)continue;const l=a[1];let c=t.get(l);c===void 0&&(c={key:l,chunkShape:C.eR.create(),lods:[]},t.set(l,c));const d=parseInt(a[5]);if(c.lods[d]!==void 0){s.add(l);continue}const u=C.eR.fromValues(parseInt(a[2],10),parseInt(a[3],10),parseInt(a[4],10)),h=new Uint32Array(3);for(let p=0;p<3;++p)h[p]=Math.ceil(n.upperVoxelBound[p]/u[p]);c.lods[d]={info:o,scale:parseFloat(a[6]),relativeBlockShape:u,gridShape:h}}const r=[];e:for(const o of t.values()){if(s.has(o.key))continue;const a=o.lods[0];if(a===void 0)continue;const l=a.relativeBlockShape;C.eR.multiply(o.chunkShape,l,n.voxelSize);for(let c=1;c<o.lods.length;++c){const d=o.lods[c];if(d===void 0)continue e;const{relativeBlockShape:u}=d;for(let h=0;h<3;++h){const p=u[h],m=l[h];if(p<m||p%m!==0)continue e;u[h]=p/m}}l.fill(1),r.push(o)}return r}function QP(i,e){const t=YP(i,e),n=[],s=o=>{n.some(a=>a.name===o.name)||n.push(o)},r=new Set;for(const o of t){s({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(const a of o.lods)r.add(a.info)}for(const o of e)s({single:o,multi:void 0,name:o.name,partOfMultiscale:r.has(o)});return n}class KP{constructor(e){try{(0,f.Rf)(e);const t=this.scales=(0,f.cQ)(e,"geometry",o=>(0,f.$v)(o,a=>new WP(a)));if(t.length===0)throw new Error("Expected at least one scale.");const n=t[0],s=this.numChannels=n.numChannels,r=this.dataType=n.dataType;for(let o=1,a=t.length;o<a;++o){const l=t[o];if(l.dataType!==r)throw new Error(`Scale ${o} has data type ${R[l.dataType]} but scale 0 has data type ${R[r]}.`);if(l.numChannels!==s)throw new Error(`Scale ${o} has ${l.numChannels} channel(s) but scale 0 has ${s} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(n.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){const t=this.scales[0],n=["x","y","z"],s=["m","m","m"],r=Array.from(t.voxelSize,l=>l/1e9),o=[0,0,0],a=Array.from(t.upperVoxelBound);return e&&(n.push("c^"),s.push(""),r.push(1),o.push(0),a.push(this.numChannels)),Oe({names:n,units:s,scales:Float64Array.from(r),boundingBoxes:[En({lowerBounds:new Float64Array(n.length),upperBounds:Float64Array.from(a)})]})}}class qP extends ln{constructor(e,t,n,s,r,o,a){super(e),this.instance=t,this.credentialsProvider=n,this.volumeId=s,this.changeSpec=r,this.multiscaleVolumeInfo=o,this.encoding=a.encoding,this.jpegQuality=a.jpegQuality,this.chunkLayoutPreference=a.chunkLayoutPreference;let l=St.IMAGE;this.dataType===R.UINT64&&(l=St.SEGMENTATION),this.volumeType=l}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=jt.r7.RAW;(this.dataType===R.UINT64||this.dataType===R.UINT32)&&this.volumeType===St.SEGMENTATION&&this.encoding!==jt.r7.RAW?t=jt.r7.COMPRESSED_SEGMENTATION:this.volumeType===St.IMAGE&&this.dataType===R.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==jt.r7.RAW&&e.discreteValues!==!0&&(t=jt.r7.JPEG);const n=t===jt.r7.JPEG?this.jpegQuality:void 0,s=this.scales[0],{upperVoxelBound:r}=s,o=C.eR.create(),{rank:a}=this;return(0,F.RO)(this.scales.map((l,c)=>{C.eR.divide(o,l.voxelSize,s.voxelSize);let d=l.upperVoxelBound,u;const{numChannels:h}=l,p=new Float32Array((a+1)**2);p[(a+1)*a+a]=1;const m=new Float32Array(a);h!==1&&(d=Float32Array.of(...d,h),u=Uint32Array.of(1,1,1,h),p[(a+1)*3+3]=1,m[3]=h);for(let g=0;g<3;++g)p[(a+1)*g+g]=o[g],m[g]=r[g]/o[g];return qi({rank:a,minBlockSize:u,chunkToMultiscaleTransform:p,dataType:l.dataType,upperVoxelBound:d,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:C.eR.fromValues(64,64,64)}).map(g=>({chunkSource:this.chunkManager.getChunkSource(BP,{credentialsProvider:this.credentialsProvider,spec:g,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:c,encoding:t,jpegQuality:n,instance:this.instance}}),chunkToMultiscaleTransform:p,upperClipBound:m}))}))}}function XP(i){const e=C.pB.create(),t=i.scales[0].voxelSize;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}function ZP(i){const e=i.match(/^([^:?/]+:[^:?/]+:[^:?/]+)(?::([^:?/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(i)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});const n=(0,f.bL)(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:n}}function e1(i){try{return(0,f.Rf)(i),{id:(0,f.cQ)(i,"id",f.zr),label:(0,f.cQ)(i,"label",f.zr),description:(0,f.cQ)(i,"description",f.z$)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function US(i){try{return(0,f.Rf)(i),(0,f.cQ)(i,"project",e=>e===void 0?[]:(0,f.$v)(e,e1))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function $S(i,e){try{return(0,f.Rf)(i),(0,f.cQ)(i,e,t=>t===void 0?[]:(0,f.$v)(t,f.zr))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}class a2{constructor(e,t){this.projects=new Map,this.hierarchicalVolumeIds=new Map;const{projects:n}=this;for(const s of US(e))n.set(s.id,s);try{verifyObject(t);const s=this.volumeIds=verifyObjectProperty(t,"volumeId",a=>a===void 0?[]:parseArray(a,verifyString));s.sort();const r=new Map;for(const a of s){let l=0;for(;;){let c=a.indexOf(":",l);c===-1?c=void 0:++c;const d=a.substring(0,l);let u=r.get(d);if(u===void 0&&(u=new Set,r.set(d,u)),u.add(a.substring(l,c)),c===void 0)break;l=c}}const{hierarchicalVolumeIds:o}=this;for(const[a,l]of r)o.set(a,Array.from(l))}catch(s){throw new Error(`Failed to parse Brain Maps volume list reply: ${s.message}`)}}}function t1(i){return(0,f.cQ)(i,"changeStackId",e=>e===void 0?void 0:(0,f.$v)(e,f.zr))}const n1=it(lt()(Rr),jt.rl);class i1 extends n1{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t}),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){const{upperVoxelBound:e}=this.parameters,t=Ko({rank:3,chunkDataSize:e,upperVoxelBound:e}),n=C.pB.create();return[[{chunkSource:this.chunkManager.getChunkSource(GP,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:n,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:n}]]}}const s1=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class GS extends Jt{constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:xt(this.credentialsProvider)},()=>Ys(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(n=>new KP(n)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:xt(this.credentialsProvider)},()=>Ys(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(n=>JP(n)))}get(e){const{volumeId:t,changeSpec:n,meshName:s,parameters:r}=ZP(e.providerUrl);(0,f.Rf)(r);const o=(0,f.MM)(r,"encoding",d=>(0,f.sl)(d,jt.r7)),a=(0,f.MM)(r,"jpegQuality",d=>{const u=(0,f.bX)(d);if(u<1||u>100)throw new Error(`Expected integer in range [1, 100], but received: ${d}`);return u},70),l=(0,f.MM)(r,"chunkLayout",d=>(0,f.sl)(d,qf)),c={encoding:o,chunkLayoutPreference:l,jpegQuality:a};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:n,brainmapsOptions:c},async()=>{const[d,u]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),h=new qP(e.chunkManager,this.instance,this.credentialsProvider,t,n,d,c),p={modelTransform:wt(d.getModelSpace(d.numChannels!==1)),subsources:[{id:s===void 0?"default":"volume",subsource:{volume:h},default:s===void 0}]},m=xn(d.box);d.scales[0].boundingBoxes.forEach((S,w)=>{m.add({type:Re.AXIS_ALIGNED_BOUNDING_BOX,description:S.metadata,pointA:S.corner,pointB:C.eR.add(C.eR.create(),S.corner,S.size),id:`boundingBox${w}`,properties:[]})}),p.subsources.push({id:"bounds",subsource:{staticAnnotations:m},default:!0});const v=QP(d,u),y=(S,w)=>{let b;const{single:x}=S;if(x!==void 0)x.type==="TRIANGLES"?b=e.chunkManager.getChunkSource(UP,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:x.name,changeSpec:n}}):b=e.chunkManager.getChunkSource($P,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:S.name,changeSpec:n}});else{const E=S.multi;b=e.chunkManager.getChunkSource(FP,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:bn.Pc.float32},parameters:{instance:this.instance,volumeId:t,info:E,changeSpec:n}})}p.subsources.push({id:s===void 0?`/${S.name}`:"default",subsource:{mesh:b},subsourceToModelSubspaceTransform:XP(d),modelSubspaceDimensionIndices:[0,1,2],default:w})};if(s!==void 0){const S=v.find(w=>w.name===s);if(S===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(S)}`);y(S,!0)}else{let S=!0;for(const w of v)w.partOfMultiscale||(y(w,S),S=!1)}return n!==void 0&&p.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(i1,{parameters:{volumeId:t,changestack:n.changeStackId,instance:this.instance,upperVoxelBound:d.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),p})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{const t=Ys(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(s=>US(s)),n=`${this.instance.description} project list`;return pe.forPromise(t,{delay:!0,initialMessage:`Retrieving ${n}.`,errorPrefix:`Error retrieving ${n}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{const n=Ys(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(r=>$S(r,"datasetIds")),s=`${this.instance.description} dataset list`;return pe.forPromise(n,{delay:!0,initialMessage:`Retrieving ${s}`,errorPrefix:`Error retrieving ${s}`}),n})}getVolumeList(e,t,n){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${n}:getVolumeList`},()=>{const s=Ys(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${n}`,responseType:"json"}).then(o=>{const a=$S(o,"volumeId"),l=t.length+n.length+2,c=[];for(const d of a)c.push(d.substring(l));return c}),r=`${this.instance.description} volume list`;return pe.forPromise(s,{delay:!0,initialMessage:`Retrieving ${r}`,errorPrefix:`Error retrieving ${r}`}),s})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{const n=Ys(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(r=>t1(r)),s=`change stacks for ${t}`;return pe.forPromise(n,{delay:!0,initialMessage:`Retrieving ${s}.`,errorPrefix:`Error retrieving ${s}: `}),n})}async completeUrl(e){const{providerUrl:t}=e,n=t.match(/^([^:/?]*)(?::([^:/?]*)(?::([^:/?]*)(?::([^:/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(n===null)throw null;const[,s,r,o,a,l,c]=n;if(c!==void 0)return yi(t.length-c.length,await vg(c,s1));if(l!==void 0){const u=`${s}:${r}:${o}`,h=await this.getMeshesInfo(e.chunkManager,u),p=[],m=new Set;for(const g of h)if(g.name.startsWith(l))switch(g.type){case"LINE_SEGMENTS":p.push({value:g.name,description:"Skeletons"});break;case"TRIANGLES":{p.push({value:g.name,description:"Mesh (single-resolution)"});const v=g.name.match(FS);if(v!==null){const y=v[1];if(m.has(y))break;m.add(y),p.push({value:y,description:"Mesh (multi-resolution)"})}break}}return p.sort((g,v)=>(0,kr.e)(g.value,v.value)),{offset:t.length-l.length,completions:p}}if(a!==void 0){const u=`${s}:${r}:${o}`,h=await this.getChangeStackList(e.chunkManager,u);if(h===void 0)throw null;return{offset:t.length-a.length,completions:Hc(a,h)}}if(o!==void 0)return{offset:t.length-o.length,completions:Hc(o,await this.getVolumeList(e.chunkManager,s,r))};if(r!==void 0){const u=await this.getDatasetList(e.chunkManager,s);return{offset:t.length-r.length,completions:Hc(r,u.map(h=>`${h}:`))}}const d=await this.getProjectList(e.chunkManager);return{offset:0,completions:Ht(s,d,u=>`${u.id}:`,u=>u.label)}}}const r1={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */if(Ot("brainmaps",i=>new GS(r1,i.credentialsManager.getCredentialsProvider(Lu))),typeof NEUROGLANCER_BRAINMAPS_SERVERS<"u")for(const[i,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))Ot(`brainmaps-${i}`,t=>new GS(e,t.credentialsManager.getCredentialsProvider(Lu)));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const o1="email",a1="openid",l1="https://accounts.google.com/o/oauth2/v2/auth";function c1(i){const e=i.split(".");try{if(e.length!==3)throw new Error("Invalid JWT format");const t=atob(e[1]),n=JSON.parse(t);return(0,f.Rf)(n),(0,f.cQ)(n,"email",f.zr)}catch(t){throw new Error(`Failed to decode id token: ${t.message}`)}}async function d1(i,e,t){const n=new T.O8;try{return await new Promise((s,r)=>{n.registerDisposer(t.add(()=>r(Je.wS))),n.registerEventListener(window,"message",o=>{if(o.origin===location.origin&&o.source===i)try{const a=(0,f.Rf)(o.data);if((0,f.cQ)(a,"state",f.zr)!==e)throw new Error("invalid state");const c=(0,f.cQ)(a,"id_token",f.zr),d={accessToken:(0,f.cQ)(a,"access_token",f.zr),tokenType:(0,f.cQ)(a,"token_type",f.zr),expiresIn:(0,f.cQ)(a,"expires_in",f.zr),scope:(0,f.cQ)(a,"scope",f.zr),email:c1(c)};s(d)}catch(a){r(new Error(`Received unexpected authentication response: ${a.message}`)),console.error("Response received: ",o.data)}})})}finally{n.dispose()}}function u1(i){let e=`${l1}?client_id=${encodeURIComponent(i.clientId)}`;const t=new URL(G(3956),G.b).href;e+=`&redirect_uri=${t}`;let n="token";const{scopes:s}=i;return s.includes("email")&&s.includes("openid")&&(n="token%20id_token"),e+=`&response_type=${n}`,e+="&include_granted_scopes=true",e+=`&scope=${encodeURIComponent(s.join(" "))}`,i.state&&(e+=`&state=${i.state}`),i.loginHint&&(e+=`&login_hint=${encodeURIComponent(i.loginHint)}`),i.immediate&&(e+="&immediate=true"),i.nonce!==void 0&&(e+=`&nonce=${i.nonce}`),i.authUser!==void 0&&(e+=`&authuser=${i.authUser}`),e}async function h1(i,e=Je.fx){const t=Te(),n=Te(),s=u1({state:t,nonce:n,clientId:i.clientId,scopes:i.scopes,approvalPrompt:i.approvalPrompt,loginHint:i.loginHint,immediate:i.immediate,authUser:i.authUser});let r,o;const a=[];if(i.immediate){const l=document.createElement("iframe");l.src=s,l.style.display="none",a.push(new Promise((c,d)=>{l.addEventListener("load",()=>{console.log("iframe loaded",l.contentDocument),l.contentDocument==null&&d(new Error("Immediate authentication failed"))})})),document.body.appendChild(l),r=l.contentWindow,o=()=>{at(l)}}else{const l=open(s);r=l,l!==null&&(o=()=>{try{l.close()}catch{}})}try{return await Promise.race([...a,d1(r,t,e)])}finally{o?.()}}class p1 extends Nn{constructor(e){super(),this.options=e,this.get=Xn(t=>{const{options:n}=this,s=new pe(!0);let r;return new Promise((o,a)=>{const l=()=>{r=void 0,s.dispose()};t.add(()=>{r!==void 0&&(r.cancel(),r=void 0,s.dispose(),a(Je.wS))});function c(u=`${n.description} authorization required.`,h="Request authorization."){s.setText(u+"  ");const p=document.createElement("button");p.textContent=h,s.element.appendChild(p),p.addEventListener("click",()=>{d(!1)}),s.setVisible(!0)}function d(u){r!==void 0&&r.cancel(),r=new Je.Qi,c(`Waiting for ${n.description} authorization...`,"Retry"),h1({clientId:n.clientId,scopes:n.scopes,immediate:u,authUser:0},r).then(h=>{r!==void 0&&(l(),o(h))},h=>{r!==void 0&&(r=void 0,u?c():c(`${n.description} authorization failed: ${h}.`,"Retry"))})}d(!0)})})}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const f1="https://www.googleapis.com/auth/brainmaps";class g1 extends p1{constructor(e){super({clientId:e,scopes:[f1,a1,o1],description:"Brain Maps"})}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Zn.register(Lu,()=>new g1("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));var zS=G(5990);/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ku="DVID";class l2{constructor(e,t){this.baseUrl=e,this.nodeKey=t}getNodeApiUrl(e=""){return`${this.baseUrl}/api/node/${this.nodeKey}${e}`}getRepoInfoUrl(){return`${this.baseUrl}/api/repos/info`}getKeyValueUrl(e,t){return`${this.getNodeApiUrl()}/${e}/key/${t}`}getKeyValueRangeUrl(e,t,n){return`${this.getNodeApiUrl()}/${e}/keyrange/${t}/${n}`}getKeyValuesUrl(e){return`${this.getNodeApiUrl()}/${e}/keyvalues?jsontar=false`}}function c2(i,e){return i.includes("?")?i+="&":i+="?",i+="app=Neuroglancer",e&&(i+=`&u=${e}`),i}function qa(i){return i.text()}function d2(i,e=uncancelableToken){const t=`${i.url}`,n={method:i.method,body:i.payload};return i.responseType===""?cancellableFetchOk(t,n,qa,e):cancellableFetchOk(t,n,responseJson,e)}function m1(i,e,t=Je.fx){return v1(i,e.url,{method:e.method,body:e.payload},e.responseType===""?qa:e.responseType==="json"?ke.cj:ke.Rc,t)}function v1(i,e,t,n,s=Je.fx){return(0,Ka.R)(i,e,t,n,(r,o)=>{const a={...o};return r.token&&(a.headers={...a.headers,Authorization:`Bearer ${r}`}),a},r=>{const{status:o}=r;if(o===403||o===401)return"refresh";throw r},s)}var Vt=G(3819);/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function y1(i,e,t,n,s){const r=await(0,Js.Y)(i,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(n)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},ke.cj,s);(0,f.Rf)(r);const o=(0,f.MM)(r,"prefixes",f.si,[]),a=(0,f.MM)(r,"items",l=>(0,f.$v)(l,c=>((0,f.Rf)(c),(0,f.cQ)(c,"name",f.zr))),[]).filter(l=>!l.endsWith("_$folder$"));return[...o,...a]}async function S1(i,e,t,n,s){if(!n.startsWith("/"))throw null;const o=await y1(i,t,n.substring(1),"/",s),a=n.lastIndexOf("/");return{offset:a+e.length+1,completions:o.map(l=>({value:l.substring(a)}))}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function b1(i,e,t){const{text:n,contentType:s}=await Nt(t,i,{headers:{accept:"text/html"}},async l=>({text:await l.text(),contentType:l.headers.get("content-type")}),e);if(s===null||/\btext\/html\b/i.exec(s)===null)return[];const r=new DOMParser().parseFromString(n,"text/html"),o=r.evaluate("//a/@href",r,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),a=[];for(let l=0,c=o.snapshotLength;l<c;++l){const u=o.snapshotItem(l).textContent;u&&a.push(new URL(u,i).toString())}return a}async function C1(i,e,t){console.log("getHtmlPathCompletions");const n=i.match(/^([a-z]+:\/\/.*\/)([^/?#]*)$/);if(n===null)throw null;const s=await b1(n[1],e,t),r=n[1].length,o=[];for(const a of s)a.startsWith(i)&&o.push({value:a.substring(r)});return{offset:r,completions:o}}const w1=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function ts(i,e,t){if(!e.includes("://"))return{offset:0,completions:Ht(e,w1,u=>u.value,u=>u.description)};const{url:n,credentialsProvider:s}=wn(e,i),r=e.length-n.length;let o;try{o=(0,ke.Dl)(n)}catch{throw null}const{protocol:a,host:l,path:c}=o,d=await(async()=>{if(a==="gs+xml"&&c.length>0)return await Tu(s,`${a}://${l}`,`https://storage.googleapis.com/${l}`,c,t);if(a==="gs"&&c.length>0)return await S1(s,`${a}://${l}`,l,c,t);if(a==="s3"&&c.length>0)return await Vk(l,c,t);const u=n.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^/]+|[^/]+\.storage\.googleapis\.com|[^/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(u!==null)return await Tu(s,u[1],u[1],u[2],t);if((a==="http"||a==="https")&&c.length>0)return await C1(n,t,s);throw null})();return{offset:r+d.offset,completions:d.completions}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class x1 extends it(lt()(Kn),Vt.jj){}class E1 extends it(lt()(Qi),Vt.Ve){}class T1 extends it(lt()(Ra),Vt.Ip){}class D1 extends it(lt()(Oa),Vt.NV){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function On(i,e){const t=i.split("/");for(const n of e.split("/")){if(n===".."&&t.length!==0){t.length=t.length-1;continue}t.push(n)}return t.join("/")}class I1{constructor(e,t){(0,f.Rf)(e);const n=t===1?3:4,s=this.resolution=new Float64Array(n),r=this.voxelOffset=new Float32Array(n),o=this.size=new Float32Array(n);if(n===4&&(s[3]=1,o[3]=t),(0,f.cQ)(e,"resolution",l=>(0,f.Xu)(s.subarray(0,3),l,f.Mo)),(0,f.MM)(e,"voxel_offset",l=>(0,f.Xu)(r.subarray(0,3),l,f.bX)),(0,f.cQ)(e,"size",l=>(0,f.Xu)(o.subarray(0,3),l,f.We)),this.chunkSizes=(0,f.cQ)(e,"chunk_sizes",l=>(0,f.$v)(l,c=>{const d=new Uint32Array(n);return n===4&&(d[3]=t),(0,f.Xu)(d.subarray(0,3),c,f.We),d})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=(0,f.cQ)(e,"sharding",Xa),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=(0,f.cQ)(e,"encoding",l=>(0,f.sl)(l,Vt.r7)))===Vt.r7.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=(0,f.cQ)(e,"compressed_segmentation_block_size",l=>(0,f.Xu)(C.eR.create(),l,f.We))),this.key=(0,f.cQ)(e,"key",f.zr),this.hidden=(0,f.cQ)(e,"hidden",f.uS)??!1}}function WS(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"data_type",y=>(0,f.sl)(y,R)),t=(0,f.cQ)(i,"num_channels",f.We),n=(0,f.cQ)(i,"type",y=>(0,f.sl)(y,St)),s=(0,f.cQ)(i,"mesh",f.z$),r=(0,f.cQ)(i,"skeletons",f.z$),o=(0,f.cQ)(i,"segment_properties",f.z$),a=(0,f.cQ)(i,"scales",y=>(0,f.$v)(y,S=>new I1(S,t)));if(a.length===0)throw new Error("Expected at least one scale");const l=a[0],c=t===1?3:4,d=new Float64Array(c),u=new Float64Array(c),h=new Float64Array(c),p=["x","y","z"],m=["m","m","m"];for(let y=0;y<3;++y)d[y]=l.resolution[y]/1e9,u[y]=l.voxelOffset[y],h[y]=u[y]+l.size[y];c===4&&(d[3]=1,h[3]=t,p[3]="c^",m[3]="");const v=Oe({rank:c,names:p,units:m,scales:d,boundingBoxes:[En({lowerBounds:u,upperBounds:h})]});return{dataType:e,volumeType:n,mesh:s,skeletons:r,segmentPropertyMap:o,scales:a,modelSpace:v}}class HS extends ln{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.url=n,this.info=s}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){const t=this.info.scales[0].resolution,{rank:n}=this;return(0,F.RO)(this.info.scales.filter(s=>!s.hidden).filter(s=>s.key!=="placeholder").map(s=>{const{resolution:r}=s,o=n+1,a=new Float32Array(o*o);a[a.length-1]=1;const{lowerBounds:l,upperBounds:c}=this.info.modelSpace.boundingBoxes[0].box,d=new Float32Array(n),u=new Float32Array(n);for(let h=0;h<3;++h){const p=r[h]/t[h];a[o*h+h]=p;const m=s.voxelOffset[h];a[o*n+h]=m*p,d[h]=l[h]/p-m,u[h]=c[h]/p-m}return n===4&&(a[o*3+3]=1,d[3]=l[3],u[3]=c[3]),qi({rank:n,dataType:this.dataType,chunkToMultiscaleTransform:a,upperVoxelBound:s.size,volumeType:this.volumeType,chunkDataSizes:s.chunkSizes,baseVoxelOffset:s.voxelOffset,compressedSegmentationBlockSize:s.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(h=>({chunkSource:this.chunkManager.getChunkSource(x1,{credentialsProvider:this.credentialsProvider,spec:h,parameters:{url:On(this.url,s.key),encoding:s.encoding,sharding:s.sharding}}),chunkToMultiscaleTransform:a,lowerClipBound:d,upperClipBound:u}))}))}}const L1=it(lt()(Rr),Vt.rl);class R1 extends it(lt()(ra),Vt.Rw){}class k1 extends L1{constructor(e,t){const{parameters:n}=t;super(e,{rank:n.rank,relationships:n.relationships.map(s=>s.name),properties:n.properties,parameters:n}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{const{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(R1,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function P1(i,e,t){return i.getChunkSource(E1,{parameters:t,credentialsProvider:e})}function JS(i){return(0,f.cQ)(i,"transform",e=>{const t=C.pB.create();return e!==void 0&&(0,f.Xu)(t.subarray(0,12),e,f.zo),C.pB.transpose(t,t),t})}function A1(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"@type",f.zr);let t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{const s=(0,f.cQ)(i,"lod_scale_multiplier",f.Mo),r=(0,f.cQ)(i,"vertex_quantization_bits",f.We),o=JS(i),a=(0,f.cQ)(i,"sharding",Xa);t={lodScaleMultiplier:s,transform:o,sharding:a,vertexQuantizationBits:r}}}const n=(0,f.cQ)(i,"segment_properties",f.z$);return{metadata:t,segmentPropertyMap:n}}async function M1(i,e,t){let n;try{n=await Qs(i,e,t)}catch(s){if((0,ke.El)(s))return{metadata:void 0};throw s}return A1(n)}function jS(i){return i===void 0?Vt.Y1.RAW:(0,f.sl)(i,Vt.Y1)}function Xa(i){if(i===void 0)return;(0,f.Rf)(i);const e=(0,f.cQ)(i,"@type",f.zr);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);const t=(0,f.cQ)(i,"hash",l=>(0,f.sl)(l,Vt.TV)),n=(0,f.cQ)(i,"preshift_bits",f.bX),s=(0,f.cQ)(i,"shard_bits",f.bX),r=(0,f.cQ)(i,"minishard_bits",f.bX),o=(0,f.cQ)(i,"minishard_index_encoding",jS),a=(0,f.cQ)(i,"data_encoding",jS);return{hash:t,preshiftBits:n,shardBits:s,minishardBits:r,minishardIndexEncoding:o,dataEncoding:a}}function N1(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"@type",f.zr);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);const t=JS(i),n=new Map;(0,f.cQ)(i,"vertex_attributes",o=>{o!==void 0&&(0,f.$v)(o,a=>{(0,f.Rf)(a);const l=(0,f.cQ)(a,"id",f.zr);if(l==="")throw new Error("vertex attribute id must not be empty");if(n.has(l))throw new Error(`duplicate vertex attribute id ${JSON.stringify(l)}`);const c=(0,f.cQ)(a,"data_type",u=>(0,f.sl)(u,R)),d=(0,f.cQ)(a,"num_components",f.We);n.set(l,{dataType:c,numComponents:d})})});const s=(0,f.cQ)(i,"sharding",Xa),r=(0,f.cQ)(i,"segment_properties",f.z$);return{metadata:{transform:t,vertexAttributes:n,sharding:s},segmentPropertyMap:r}}async function O1(i,e,t){const n=await Qs(i,e,t);return N1(n)}function YS(){return Oe({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function QS(i,e,t){const{metadata:n,segmentPropertyMap:s}=await M1(i,e,t);if(n===void 0)return{source:P1(i,e,{url:t,lod:0}),transform:C.pB.create(),segmentPropertyMap:s};let r;const{vertexQuantizationBits:o}=n;if(o===10)r=bn.Pc.uint10;else if(o===16)r=bn.Pc.uint16;else throw new Error(`Invalid vertex quantization bits: ${o}`);return{source:i.getChunkSource(T1,{credentialsProvider:e,parameters:{url:t,metadata:n},format:{fragmentRelativeVertices:!0,vertexPositionFormat:r}}),transform:n.transform,segmentPropertyMap:s}}async function KS(i,e,t){const{metadata:n,segmentPropertyMap:s}=await O1(i,e,t);return{source:i.getChunkSource(D1,{credentialsProvider:e,parameters:{url:t,metadata:n}}),transform:n.transform,segmentPropertyMap:s}}function Qs(i,e,t){return i.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:xt(e)},async()=>await Nt(e,`${t}/info`,{},ke.cj))}function qS(i){const e=C.pB.create(),t=i.scales[0].resolution;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}async function _1(i,e,t,n){const s=WS(n),r=new HS(i.chunkManager,e,t,s),{modelSpace:o}=s,a=[{id:"default",default:!0,subsource:{volume:r}},{id:"bounds",default:!0,subsource:{staticAnnotations:xn(o.bounds)}}];if(s.segmentPropertyMap!==void 0){const l=On(t,s.segmentPropertyMap),c=await Qs(i.chunkManager,e,l),d=Xr(i.chunkManager,e,c,l);a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}if(s.mesh!==void 0){const l=On(t,s.mesh),{source:c,transform:d}=await QS(i.chunkManager,e,l),u=qS(s);C.pB.multiply(u,u,d),a.push({id:"mesh",default:!0,subsource:{mesh:c},subsourceToModelSubspaceTransform:u})}if(s.skeletons!==void 0){const l=On(t,s.skeletons),{source:c,transform:d}=await KS(i.chunkManager,e,l),u=qS(s);C.pB.multiply(u,u,d),a.push({id:"skeletons",default:!0,subsource:{mesh:c},subsourceToModelSubspaceTransform:u})}return{modelTransform:wt(o),subsources:a}}async function V1(i,e,t){const{source:n,transform:s,segmentPropertyMap:r}=await KS(i.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:n},subsourceToModelSubspaceTransform:s}];if(r!==void 0){const a=On(t,r),l=await Qs(i.chunkManager,e,a),c=Xr(i.chunkManager,e,l,a);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:c}})}return{modelTransform:wt(YS()),subsources:o}}function Pu(i,e){return(0,f.Rf)(e),{url:On(i,(0,f.cQ)(e,"key",f.zr)),sharding:(0,f.cQ)(e,"sharding",Xa)}}class B1{constructor(e,t){this.url=e,(0,f.Rf)(t);const n=(0,f.cQ)(t,"dimensions",uo),{rank:s}=n,r=(0,f.cQ)(t,"lower_bound",a=>(0,f.Xu)(new Float64Array(s),a,f.zo)),o=(0,f.cQ)(t,"upper_bound",a=>(0,f.Xu)(new Float64Array(s),a,f.zo));this.coordinateSpace=Oe({rank:s,names:n.names,units:n.units,scales:n.scales,boundingBoxes:[En({lowerBounds:r,upperBounds:o})]}),this.parameters={type:(0,f.cQ)(t,"annotation_type",a=>(0,f.sl)(a,Re)),rank:s,relationships:(0,f.cQ)(t,"relationships",a=>(0,f.$v)(a,l=>{const c=Pu(e,l),d=(0,f.cQ)(l,"id",f.zr);return{...c,name:d}})),properties:(0,f.cQ)(t,"properties",Dh),byId:(0,f.cQ)(t,"by_id",a=>Pu(e,a))},this.spatialIndices=(0,f.cQ)(t,"spatial",a=>(0,f.$v)(a,l=>{const c=Pu(e,l),d=(0,f.cQ)(l,"grid_shape",v=>(0,f.Xu)(new Float32Array(s),v,f.We)),u=(0,f.cQ)(l,"chunk_size",v=>(0,f.Xu)(new Float32Array(s),v,f.Mo)),h=(0,f.cQ)(l,"limit",f.We),p=new Float32Array(s);for(let v=0;v<s;++v)p[v]=d[v]*u[v];const m=De.DA(Float32Array,s+1);for(let v=0;v<s;++v)m[(s+1)*s+v]=r[v];const g={limit:h,chunkToMultiscaleTransform:m,...Ko({rank:s,chunkDataSize:u,upperVoxelBound:p})};return g.upperChunkBound=d,{parameters:c,spec:g,limit:h}})),this.spatialIndices.reverse()}}async function F1(i,e,t,n){const s=new B1(t,n);return{modelTransform:wt(s.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:i.chunkManager.getChunkSource(k1,{credentialsProvider:e,metadata:s,parameters:s.parameters})}}]}}async function XS(i,e,t){const{source:n,transform:s,segmentPropertyMap:r}=await QS(i.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:n},subsourceToModelSubspaceTransform:s}];if(r!==void 0){const a=On(t,r),l=await Qs(i.chunkManager,e,a),c=Xr(i.chunkManager,e,l,a);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:c}})}return{modelTransform:wt(YS()),subsources:o}}function U1(i){(0,f.Rf)(i);const e=new P.R,t=(0,f.cQ)(i,"ids",r=>{r=(0,f.si)(r);const o=r.length,a=new Uint32Array(o*2);for(let l=0;l<o;++l){if(!e.tryParseString(r[l]))throw new Error(`Invalid uint64 id: ${JSON.stringify(r[l])}`);a[2*l]=e.low,a[2*l+1]=e.high}return a}),n=t.length/2,s=(0,f.cQ)(i,"properties",r=>(0,f.$v)(r,o=>{(0,f.Rf)(o);const a=(0,f.cQ)(o,"id",f.zr),l=(0,f.MM)(o,"description",f.zr),c=(0,f.cQ)(o,"type",u=>{if(u!=="label"&&u!=="description"&&u!=="string"&&u!=="tags"&&u!=="number")throw new Error(`Invalid property type: ${JSON.stringify(u)}`);return u});if(c==="tags"){const u=(0,f.cQ)(o,"tags",f.si);let h=(0,f.MM)(o,"tag_descriptions",f.si);if(h===void 0)h=new Array(u.length),h.fill("");else if(h.length!==u.length)throw new Error(`Expected tag_descriptions to have length: ${u.length}`);const p=(0,f.cQ)(o,"values",m=>{if(!Array.isArray(m)||m.length!==n)throw new Error(`Expected ${n} values, but received: ${m.length}`);return m.map(g=>String.fromCharCode(...g))});return{id:a,description:l,type:c,tags:u,tagDescriptions:h,values:p}}if(c==="number"){const u=(0,f.cQ)(o,"data_type",g=>(0,f.sl)(g,R));if(u===R.UINT64)throw new Error("uint64 properties not supported");const h=(0,f.cQ)(o,"values",g=>{if(!Array.isArray(g)||g.length!==n)throw new Error(`Expected ${n} values, but received: ${g.length}`);return J[u].from(g)});let p=1/0,m=-1/0;for(let g=h.length-1;g>=0;--g){const v=h[g];v<p&&(p=v),v>m&&(m=v)}return{id:a,description:l,type:c,dataType:u,values:h,bounds:[p,m]}}const d=(0,f.cQ)(o,"values",u=>{if((0,f.si)(u),u.length!==n)throw new Error(`Expected ${n} values, but received: ${u.length}`);return u});return{id:a,description:l,type:c,values:d}}));return lI({ids:t,properties:s})}const u2=it(lt()(nI),Vt.vq);function Xr(i,e,t,n){try{const s=(0,f.cQ)(t,"@type",f.zr);if(s!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(s)}`);const r=(0,f.MM)(t,"inline",U1);return new rv({inlineProperties:r})}catch(s){throw new Error(`Error parsing segment property map: ${s.message}`)}}async function $1(i,e,t,n){return{modelTransform:wt(ki),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Xr(i.chunkManager,e,n,t)}}]}}const G1=/^([^#]*)(?:#(.*))?$/;function ns(i){let[,e,t]=i.match(G1);e.endsWith("/")&&(e=e.substring(0,e.length-1));const n=(0,f.bL)(t||"");return{url:e,parameters:n}}function Za(i,e){const t=(0,f.uz)(e);return t&&(i+=`#${t}`),i}class ZS extends Jt{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.providerProtocol+"://"+Za(t,n)}convertLegacyUrl(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.type==="mesh"&&(n.type="mesh"),e.providerProtocol+"://"+Za(t,n)}get(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:n},async()=>{const{url:s,credentialsProvider:r}=wn(t,e.credentialsManager);let o;try{o=await Qs(e.chunkManager,r,s)}catch(c){if((0,ke.El)(c)&&n.type==="mesh")return await XS(e,r,s);throw c}(0,f.Rf)(o);const a=(0,f.MM)(o,"redirect",f.zr);if(a!==void 0)throw new Jc(a);const l=(0,f.MM)(o,"@type",f.zr);switch(l){case"neuroglancer_skeletons":return await V1(e,r,s);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await XS(e,r,s);case"neuroglancer_annotations_v1":return await F1(e,r,s,o);case"neuroglancer_segment_properties":return await $1(e,r,s,o);case"neuroglancer_multiscale_volume":case void 0:return await _1(e,r,s,o);default:throw new Error(`Invalid type: ${JSON.stringify(l)}`)}})}completeUrl(e){return ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2016 Google Inc., 2023 Gergely Csucs
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class z1 extends it(lt()(Kn),zS.D){}function W1(i){const{width:e,height:t,tilesize:n,overlap:s,format:r}=i,o=(0,f.sl)(r,zS.j),a=new Array;let l=e,c=t;for(;l>1||c>1;)a.push({width:l,height:c}),l=Math.ceil(l/2),c=Math.ceil(c/2);a.push({width:l,height:c});const d=3,u=Float64Array.of(1/1e9,1/1e9,1),h=new Float64Array(d),p=Float64Array.of(e,t,3),y=Oe({rank:d,names:["x","y","c^"],units:["m","m",""],scales:u,boundingBoxes:[En({lowerBounds:h,upperBounds:p})]});return{levels:a,modelSpace:y,overlap:s,tilesize:n,format:r,encoding:o}}class H1 extends ln{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.info=s,this.url=n.substring(0,n.lastIndexOf("."))+"_files"}get dataType(){return R.UINT8}get volumeType(){return St.IMAGE}get rank(){return this.info.modelSpace.rank}getSources(e){const{rank:t}=this,n=[Uint32Array.of(this.info.tilesize,this.info.tilesize,3)];return(0,F.RO)(this.info.levels.map((s,r,o)=>{const a=1<<r,l=t+1,c=new Float32Array(l*l);c[c.length-1]=1;const{upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,u=new Float32Array(t);for(let h=0;h<2;++h)c[l*h+h]=a,u[h]=d[h]/a;return c[l*2+2]=1,u[2]=d[2],qi({rank:t,dataType:this.dataType,chunkToMultiscaleTransform:c,upperVoxelBound:Float32Array.of(s.width,s.height,3),volumeType:this.volumeType,chunkDataSizes:n,volumeSourceOptions:e}).map(h=>({chunkSource:this.chunkManager.getChunkSource(z1,{credentialsProvider:this.credentialsProvider,spec:h,parameters:{url:On(this.url,(o.length-1-r).toString()),encoding:this.info.encoding,format:this.info.format,overlap:this.info.overlap,tilesize:this.info.tilesize}}),chunkToMultiscaleTransform:c,upperClipBound:u}))}))}}function J1(i,e,t){if(t.endsWith(".json")||t.includes(".json?"))throw new Error("DZI-JSON: OpenSeadragon hack not supported yet.");return i.memoize.getUncounted({type:"deepzoom:metadata",url:t,credentialsProvider:xt(e)},async()=>{const n=await Nt(e,t,{},qa),r=new DOMParser().parseFromString(n,"text/xml").documentElement,o=(0,f.Rf)(r.getElementsByTagName("Size").item(0));return{width:(0,f.We)(o.getAttribute("Width")),height:(0,f.We)(o.getAttribute("Height")),tilesize:(0,f.We)((0,f.zr)(r.getAttribute("TileSize"))),overlap:(0,f.bX)((0,f.zr)(r.getAttribute("Overlap"))),format:(0,f.zr)(r.getAttribute("Format"))}})}async function j1(i,e,t,n){const s=W1(n),r=new H1(i.chunkManager,e,t,s),{modelSpace:o}=s,a=[{id:"default",default:!0,subsource:{volume:r}},{id:"bounds",default:!0,subsource:{staticAnnotations:xn(o.bounds)}}];return{modelTransform:wt(o),subsources:a}}class Y1 extends Jt{get description(){return"Deep Zoom file-backed data source"}normalizeUrl(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.providerProtocol+"://"+Za(t,n)}convertLegacyUrl(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.providerProtocol+"://"+Za(t,n)}get(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"deepzoom:get",providerUrl:t,parameters:n},async()=>{const{url:s,credentialsProvider:r}=wn(t,e.credentialsManager),o=await J1(e.chunkManager,r,s);return j1(e,r,s,o)})}completeUrl(e){return ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2017 Google Inc., 2023 Gergely Csucs
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("deepzoom",()=>new Y1);var Yt=G(8820);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const el=new Map;el.set("uint8",R.UINT8),el.set("uint32",R.UINT32),el.set("uint64",R.UINT64);class Q1{constructor(e){this.obj=e,(0,f.Rf)(e),(0,f.cQ)(e,"TypeName",f.zr)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}}class K1{constructor(e,t,n){this.obj=e,this.name=t,this.base=n}}class q1 extends it(lt()(Kn),Yt.jj){}class X1 extends it(lt()(Oa),Yt.NV){}class Z1 extends it(lt()(Qi),Yt.Ve){}class tl extends K1{constructor(e,t,n,s,r){super(e,t,n),this.encoding=s;const o=(0,f.cQ)(e,"Extended",f.Rf),a=(0,f.cQ)(o,"Values",c=>(0,f.$v)(c,f.Rf));if(a.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;const l=new Set(r);if(s===Yt.r7.COMPRESSED_SEGMENTATIONARRAY){const c=(0,f.cQ)(o,"MaxDownresLevel",f.We);this.numLevels=c+1}else for(;l.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;l.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",l.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=(0,f.cQ)(a[0],"DataType",c=>(0,f.j3)(c,el)),this.voxelSize=(0,f.cQ)(o,"VoxelSize",c=>(0,f.Xu)(C.eR.create(),c,f.Mo)),this.blockSize=(0,f.cQ)(o,"BlockSize",c=>(0,f.Xu)(C.eR.create(),c,f.Mo)),this.lowerVoxelBound=(0,f.cQ)(o,"MinPoint",c=>(0,f.vp)(C.eR.create(),c)),this.upperVoxelBoundInclusive=(0,f.cQ)(o,"MaxPoint",c=>(0,f.vp)(C.eR.create(),c))}get volumeType(){return this.encoding===Yt.r7.COMPRESSED_SEGMENTATION||this.encoding===Yt.r7.COMPRESSED_SEGMENTATIONARRAY?St.SEGMENTATION:St.IMAGE}getSources(e,t,n,s){const{encoding:r}=this,o=[],a=64;for(let l=0;l<this.numLevels;++l){const c=2**l,d=2**-l,u=C.eR.create(),h=C.eR.create();for(let y=0;y<3;++y){const S=Math.floor(this.lowerVoxelBound[y]*d);u[y]=S-S%a;const w=Math.ceil((this.upperVoxelBoundInclusive[y]+1)*d);h[y]=w,w%a!==0&&(h[y]+=a-w%a)}let p=t.dataInstanceKey;r!==Yt.r7.COMPRESSED_SEGMENTATIONARRAY&&l>0&&(p+="_"+l.toString());const m={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:p,dataScale:l.toString(),encoding:r},g=C.pB.create();for(let y=0;y<3;++y)g[5*y]=c,g[12+y]=u[y]*c;const v=qi({rank:3,chunkToMultiscaleTransform:g,dataType:this.dataType,baseVoxelOffset:u,upperVoxelBound:C.eR.subtract(C.eR.create(),h,u),volumeType:this.volumeType,volumeSourceOptions:n,compressedSegmentationBlockSize:r===Yt.r7.COMPRESSED_SEGMENTATION||r===Yt.r7.COMPRESSED_SEGMENTATIONARRAY?C.eR.fromValues(8,8,8):void 0}).map(y=>({chunkSource:e.getChunkSource(q1,{spec:y,parameters:m,credentialsProvider:s}),chunkToMultiscaleTransform:g}));o.push(v)}return(0,F.RO)(o)}}function eA(i,e,t){(0,f.Rf)(i);const n=(0,f.cQ)(i,"Base",s=>new Q1(s));switch(n.typeName){case"uint8blk":case"grayscale8":{const s=n.compressionName.indexOf("jpeg")!==-1;return new tl(i,e,n,s?Yt.r7.JPEG:Yt.r7.RAW,t)}case"labels64":case"labelblk":return new tl(i,e,n,Yt.r7.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new tl(i,e,n,Yt.r7.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(n.typeName)} is not supported.`)}}class nl{constructor(e){if(this.errors=[],this.dataInstances=new Map,this.vnodes=new Set,e instanceof nl){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}(0,f.Rf)(e),this.alias=(0,f.cQ)(e,"Alias",f.zr),this.description=(0,f.cQ)(e,"Description",f.zr);const t=(0,f.cQ)(e,"DataInstances",f.Rf),n=Object.keys(t);for(const o of n)try{this.dataInstances.set(o,eA(t[o],o,n))}catch(a){const l=`Failed to parse data instance ${JSON.stringify(o)}: ${a.message}`;console.log(l),this.errors.push(l)}const s=(0,f.cQ)(e,"DAG",f.Rf),r=(0,f.cQ)(s,"Nodes",f.Rf);for(const o of Object.keys(r))this.vnodes.add(o)}}function tA(i){try{const e=(0,f.vS)(i,n=>new nl(n)),t=new Map;for(const[n,s]of e){t.set(n,s);for(const r of s.vnodes)if(r!==n){const o=new nl(s);t.set(r,o)}}for(const[n,s]of t)s.uuid=n;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}class nA{constructor(e){this.repositories=tA(e)}getNode(e){const t=[];for(const n of this.repositories.keys())n.startsWith(e)&&t.push(n);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}}function e0(i,e,t){return i.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{const n=m1(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(r=>new nA(r)),s=`repository info for DVID server ${e}`;return pe.forPromise(n,{initialMessage:`Retrieving ${s}.`,delay:!0,errorPrefix:`Error retrieving ${s}: `}),n})}class iA extends ln{constructor(e,t,n,s,r,o){super(e),this.baseUrl=t,this.nodeKey=n,this.dataInstanceKey=s,this.info=r,this.credentialsProvider=o}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}}const sA=/^((?:http|https):\/\/[^/]+)\/([^/]+)\/([^/]+)(\?.*)?$/;function t0(i){if(i.startsWith("https"))return i+"/api/server/token"}function rA(i){const e=i.match(sA);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(i)}.`);const t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},n=e[4];if(n&&n.length>1){const s=(0,f.bL)(n.substring(1));s.user&&(t.user=s.user)}return t.authServer=t0(t.baseUrl),t}function oA(i,e,t,n){const s=e.baseUrl,r=e.nodeKey,o=e.dataInstanceKey,a=t,l={lowerBounds:new Float64Array(a.lowerVoxelBound),upperBounds:Float64Array.from(a.upperVoxelBoundInclusive,h=>h+1)},c=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(a.voxelSize,h=>h/1e9),boundingBoxes:[En(l)]}),d=new iA(i.chunkManager,s,r,o,a,n),u={modelTransform:wt(c),subsources:[{id:"default",subsource:{volume:d},default:!0}]};if(a.meshSrc){const h=C.pB.create();for(let p=0;p<3;++p)h[5*p]=1/a.voxelSize[p];u.subsources.push({id:"meshes",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(Z1,{parameters:{...e,dataInstanceKey:a.meshSrc},credentialsProvider:n})},subsourceToModelSubspaceTransform:h})}return a.skeletonSrc&&u.subsources.push({id:"skeletons",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(X1,{parameters:{...e,dataInstanceKey:a.skeletonSrc},credentialsProvider:n})}}),u.subsources.push({id:"bounds",subsource:{staticAnnotations:xn(l)},default:!0}),u}function aA(i){const e=rA(i.providerUrl),{baseUrl:t,nodeKey:n,dataInstanceKey:s}=e;return i.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:t,nodeKey:n,dataInstanceKey:s},async()=>{const r=i.credentialsManager.getCredentialsProvider(ku,{dvidServer:e.baseUrl,authServer:e.authServer}),a=(await e0(i.chunkManager,t,r)).getNode(n);if(a===void 0)throw new Error(`Invalid node: ${JSON.stringify(n)}.`);const l=a.dataInstances.get(s);if(!(l instanceof tl))throw new Error(`Invalid data instance ${s}.`);return oA(i,e,l,r)})}function lA(i,e){return{offset:0,completions:Ht(e,i.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function cA(i,e){const t=e.match(/^(?:([^/]+)(?:\/([^/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:Ht(e,i.repositories.values(),r=>r.uuid+"/",r=>`${r.alias}: ${r.description}`)};const n=t[1],s=i.getNode(n);return yi(n.length+1,lA(s,t[2]))}async function dA(i){const e=/^((?:http|https):\/\/[^/]+)\/([^?]*).*$/,n=i.providerUrl.match(e);if(n===null)throw null;const s=n[1],r=n[2],o=t0(s),a=await e0(i.chunkManager,s,i.credentialsManager.getCredentialsProvider(ku,{dvidServer:s,authServer:o}));return yi(s.length+1,cA(a,r))}class uA extends Jt{constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return aA(e)}completeUrl(e){return dA(e)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("dvid",i=>new uA(i.credentialsManager));/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function hA(i,e=Je.fx){return{token:await(0,ke.Bk)(i,{method:"GET",credentials:"include"},qa,e)}}class pA extends Nn{constructor(e){super(),this.authServer=e,this.get=Xn(t=>{if(!this.authServer)return Promise.resolve({token:""});const n=new pe(!0);let s;return new Promise((r,o)=>{const a=()=>{s=void 0,n.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,n.dispose(),o(Je.wS))});function l(d,u="DVID authorization required.",h="Request authorization."){n.setText(u+" ");const p=document.createElement("button");p.textContent=h,n.element.appendChild(p),p.addEventListener("click",()=>{const m=d.match(/^[^/]+\/\/[^/.]+\.([^/]+)/);if(m){const g=`https://flyemlogin.${m[1]}/login`;window.alert(`Please log into ${g} and then refresh the neurogalncer page to try again.
If you are unable to log into ${g}, please check your authorization server ${d} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${d} to make sure it is correct.`)}),n.setVisible(!0)}function c(d){s!==void 0&&s.cancel(),s=new Je.Qi,l(d,"Waiting for DVID authorization...","Retry"),hA(d,s).then(u=>{s!==void 0&&(a(),r(u))},u=>{s!==void 0&&(s=void 0,l(d,`DVID authorization failed: ${u}.`,"Retry"))})}c(this.authServer)})})}}class fA extends AP{constructor(e,t){super(new pA(t),{})}}/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Zn.register(ku,i=>new fA(i.dvidServer,i.authServer));/**
 * @license
 * Copyright 2019 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zr=1,gA="GrapheneMeshSource:NewSegment";var mA=(i=>(i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i))(mA||{});class vA{}vA.RPC_ID="graphene/VolumeChunkSource";class n0{}n0.RPC_ID="graphene/ChunkedGraphSource";class i0{}i0.RPC_ID="graphene/MeshSource";class h2{}const eo=async i=>i;function s0(i,e){const t=P.R.rshift(new P.R,i,64-e);return P.R.equal(t,P.R.ONE)}function yA(i){if(i.charAt(0)==="~"){const t=i.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}return{key:i,fragmentId:i}}const SA="ChunkedGraphLayer",bA="ChunkedGraphLayer:updateSources",p2=5;function CA(i){const{rank:e,dataType:t}=i,{baseVoxelOffset:n=new Float32Array(e)}=i;return{...Ko(i),baseVoxelOffset:n,dataType:t}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Au(i){return new Date(i.getTime()-i.getTimezoneOffset()*6e4).toISOString().slice(0,-8)}class wA extends T.O8{constructor(e,t,n){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));const{element:s}=this;s.type="datetime-local",t&&this.setMin(t),n&&this.setMax(n),this.registerEventListener(s,"change",()=>this.updateModel()),this.updateView()}setMin(e){const{element:t}=this;t.min=Au(e)}setMax(e){const{element:t}=this;t.max=Au(e)}disposed(){at(this.element)}updateView(){this.model.value?this.element.value=Au(new Date(this.model.value)):this.element.value=""}updateModel(){try{this.element.value?this.model.restoreState(new Date(this.element.value).valueOf()):this.model.restoreState(0)}catch{}this.updateView()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function il(i,e=0){const t=C.ln.clone([...i]);return t[3]=e,t}const sl=C.eR.fromValues(1,0,0),Mu=C.eR.fromValues(0,0,1),xA=il(sl,.5),EA=il(Mu,.5),TA=il(sl,.25),DA=il(Mu,.25),IA=C.ln.fromValues(.5,.5,.5,.01),LA=new P.R(Ie(xA)),RA=new P.R(Ie(EA)),kA=new P.R(Ie(IA)),PA=C.ln.fromValues(0,0,0,.5),AA=C.eR.fromValues(1,1,1);class MA extends it(lt()(Qi),i0){getFragmentKey(e,t){return yA(t)}}class NA{constructor(e,t){const n=/^(https?:\/\/[.\w:\-/]+)\/segmentation\/(?:1\.0|table)\/([^/]+)\/?$/,s=e.match(n);if(s===null)throw Error(`Graph URL invalid: ${e}`);this.table=s[2];const{table:r}=this;this.segmentationUrl=`${s[1]}/segmentation/api/v${Zr}/table/${r}`,this.meshingUrl=`${s[1]}/meshing/api/v${Zr}/table/${r}`,this.l2CacheUrl=`${s[1]}/l2cache/api/v${Zr}`;try{(0,f.Rf)(t),this.supported_api_versions=(0,f.cQ)(t,"supported_api_versions",o=>(0,f.$v)(o,f.B8))}catch{this.supported_api_versions=[0]}if(!(Zr in this.supported_api_versions)){const o=`This Neuroglancer branch requires Graph Server version ${Zr}, but the server only supports version(s) ${this.supported_api_versions}.`;throw new Error(o)}}}const OA=8;class _A{constructor(e){(0,f.Rf)(e),this.chunkSize=(0,f.cQ)(e,"chunk_size",t=>(0,f.Xu)(C.eR.create(),t,f.We)),this.nBitsForLayerId=(0,f.MM)(e,"n_bits_for_layer_id",f.We,OA)}}function VA(i,e,t){const n=WS(i),s=(0,f.cQ)(i,"data_dir",a=>wn(a,t)).url,r=(0,f.cQ)(i,"app",a=>new NA(e,a)),o=(0,f.cQ)(i,"graph",a=>new _A(a));return{...n,app:r,graph:o,dataUrl:s}}class BA extends HS{constructor(e,t,n){super(e,void 0,n.dataUrl,n),this.chunkedGraphCredentialsProvider=t,this.info=n}getChunkedGraphSource(){const{rank:e}=this,t=this.info.scales[0],n=CA({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),s=e+1,r=new Float32Array(s*s);r[r.length-1]=1;const{lowerBounds:o,upperBounds:a}=this.info.modelSpace.boundingBoxes[0].box,l=new Float32Array(e),c=new Float32Array(e);for(let d=0;d<3;++d)r[s*d+d]=1,r[s*e+d]=t.voxelOffset[d],l[d]=o[d],c[d]=a[d];return{chunkSource:this.chunkManager.getChunkSource(tM,{spec:n,credentialsProvider:this.chunkedGraphCredentialsProvider,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:r,lowerClipBound:l,upperClipBound:c}}}function r0(i){return(0,f.cQ)(i,"transform",e=>{const t=C.pB.create();return e!==void 0&&(0,f.Xu)(t.subarray(0,12),e,f.zo),C.pB.transpose(t,t),t})}function FA(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"@type",f.zr);let t;if(e==="neuroglancer_legacy_mesh"){const s=(0,f.cQ)(i,"sharding",a0);s===void 0?t=void 0:t={lodScaleMultiplier:0,transform:r0(i),sharding:s,vertexQuantizationBits:10}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{const s=(0,f.cQ)(i,"lod_scale_multiplier",f.Mo),r=(0,f.cQ)(i,"vertex_quantization_bits",f.We),o=r0(i),a=(0,f.cQ)(i,"sharding",a0);t={lodScaleMultiplier:s,transform:o,sharding:a,vertexQuantizationBits:r}}}const n=(0,f.cQ)(i,"segment_properties",f.z$);return{metadata:t,segmentPropertyMap:n}}async function UA(i,e,t){let n;try{n=await Nu(i,e,t)}catch(s){if((0,ke.El)(s))return{metadata:void 0};throw s}return FA(n)}function o0(i){return i===void 0?Vt.Y1.RAW:(0,f.sl)(i,Vt.Y1)}function $A(i){if(i===void 0)return;(0,f.Rf)(i);const e=(0,f.cQ)(i,"@type",f.zr);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);const t=(0,f.cQ)(i,"hash",l=>(0,f.sl)(l,Vt.TV)),n=(0,f.cQ)(i,"preshift_bits",f.bX),s=(0,f.cQ)(i,"shard_bits",f.bX),r=(0,f.cQ)(i,"minishard_bits",f.bX),o=(0,f.cQ)(i,"minishard_index_encoding",o0),a=(0,f.cQ)(i,"data_encoding",o0);return{hash:t,preshiftBits:n,shardBits:s,minishardBits:r,minishardIndexEncoding:o,dataEncoding:a}}function a0(i){if(i===void 0)return;(0,f.Rf)(i);const e=new Array;for(const t in i){const n=Number(t);e[n]=$A(i[n])}return e}function GA(i,e,t){return i.getChunkSource(MA,{parameters:e,credentialsProvider:t})}async function zA(i,e,t,n,s){const{metadata:r,segmentPropertyMap:o}=await UA(i,void 0,n),a={manifestUrl:t,fragmentUrl:n,lod:0,sharding:r?.sharding,nBitsForLayerId:s},l=r?.transform||C.pB.create();return{source:GA(i,a,e),transform:l,segmentPropertyMap:o}}function Nu(i,e,t){return i.memoize.getUncounted({type:"graphene:metadata",url:t,credentialsProvider:xt(e)},async()=>await Nt(e,`${t}/info`,{},ke.cj))}function WA(i){const e=C.pB.create(),t=i.scales[0].resolution;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}async function HA(i,e,t,n){const s=VA(n,t,i.credentialsManager),r=new BA(i.chunkManager,e,s),o=new QA;i.state&&o.restoreState(i.state);const a=new ll(s,e,r,o),{modelSpace:l}=s,c=[{id:"default",default:!0,subsource:{volume:r}},{id:"graph",default:!0,subsource:{segmentationGraph:a}},{id:"bounds",default:!0,subsource:{staticAnnotations:xn(l.bounds)}}];if(s.segmentPropertyMap!==void 0){const d=On(t,s.segmentPropertyMap),u=await Nu(i.chunkManager,e,d),h=Xr(i.chunkManager,e,u,d);c.push({id:"properties",default:!0,subsource:{segmentPropertyMap:h}})}if(s.mesh!==void 0){const{source:d,transform:u}=await zA(i.chunkManager,e,s.app.meshingUrl,On(s.dataUrl,s.mesh),s.graph.nBitsForLayerId),h=WA(s);C.pB.multiply(h,h,u),c.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:h})}return{modelTransform:wt(l),subsources:c,state:o}}class JA extends ZS{get description(){return"Graphene file-backed data source"}get(e){const{url:t,parameters:n}=ns(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"graphene:get",providerUrl:t,parameters:n},async()=>{const{url:s,credentialsProvider:r}=wn(t,e.credentialsManager);let o;try{o=await Nu(e.chunkManager,r,s)}catch(c){throw(0,ke.El)(c)&&n.type==="mesh"&&console.log("does this happen?"),c}(0,f.Rf)(o);const a=(0,f.MM)(o,"redirect",f.zr);if(a!==void 0)throw new Jc(a);const l=(0,f.MM)(o,"@type",f.zr);switch(l){case"neuroglancer_multiscale_volume":case void 0:return await HA(e,r,s,o);default:throw new Error(`Invalid type: ${JSON.stringify(l)}`)}})}}function to(i){for(const e of i.dataSources){const{loadState:t}=e;if(!(t===void 0||t.error!==void 0)){for(const n of t.subsources)if(n.enabled&&n.subsourceEntry.id==="graph")return n}}}function rl(i,e,t,n){const{subsourceEntry:s}=e,r=new Ih(e.loadedDataSource.transform,new _.B0([]),["associated segments"]),o=new Yf;o.color.value.set(n),o.relationshipStates.set("associated segments",{segmentationState:new _.B0(i.displayState),showMatches:new nt(!1)});const a=new jo({localPosition:i.localPosition,transform:e.getRenderLayerTransform(),source:r,displayState:o,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:s.id,subsubsourceId:t,role:li.ANNOTATION});return i.addAnnotationLayerState(a,e),a}function jA(i,e){return(0,f.MM)(i,e,t=>P.R.parseString(String(t)))}function l0(i,e){return(0,f.cQ)(i,e,t=>P.R.parseString(String(t)))}function no(i){const e=l0(i,d0),t=l0(i,u0),n=(0,f.cQ)(i,h0,s=>(0,f.f4)(s));return{segmentId:e,rootId:t,position:n}}const Ks=i=>({[d0]:i.segmentId.toJSON(),[u0]:i.rootId.toJSON(),[h0]:[...i.position]}),c0="id",d0="segmentId",u0="rootId",h0="position",p0="sink",ol="source",f0="timestamp",g0="multicut",m0="focusSegment",v0="sinks",y0="sources",S0="merge",b0="merges",C0="autosubmit",YA="locked",w0="mergedRoot",x0="error",E0="findPath",T0="target",D0="centroids",I0="precision";class QA extends T.O8{constructor(){super(),this.changed=new j.IY,this.timestamp=new _.DN(0,e=>e),this.multicutState=new XA,this.mergeState=new KA,this.findPathState=new qA,this.registerDisposer(this.timestamp.changed.add(()=>{this.multicutState.reset(),this.changed.dispatch()})),this.registerDisposer(this.multicutState.changed.add(()=>{this.changed.dispatch()})),this.registerDisposer(this.mergeState.changed.add(()=>{this.changed.dispatch()})),this.registerDisposer(this.findPathState.changed.add(()=>{this.changed.dispatch()}))}replaceSegments(e,t){this.multicutState.replaceSegments(e,t),this.mergeState.replaceSegments(e,t),this.findPathState.replaceSegments(e,t)}reset(){this.timestamp.reset(),this.multicutState.reset(),this.mergeState.reset(),this.findPathState.reset()}toJSON(){return{[f0]:this.timestamp.toJSON(),[g0]:this.multicutState.toJSON(),[S0]:this.mergeState.toJSON(),[E0]:this.findPathState.toJSON()}}restoreState(e){(0,f.MM)(e,f0,t=>{this.timestamp.restoreState(t)}),(0,f.MM)(e,g0,t=>{this.multicutState.restoreState(t)}),(0,f.MM)(e,S0,t=>{this.mergeState.restoreState(t)}),(0,f.MM)(e,E0,t=>{this.findPathState.restoreState(t)})}}class KA extends T.O8{constructor(){super(),this.changed=new j.IY,this.merges=new _.B0([]),this.autoSubmit=new nt(!1),this.registerDisposer(this.merges.changed.add(this.changed.dispatch))}replaceSegments(e,t){const{merges:{value:n}}=this,s=t.size===1?[...t][0]:void 0;for(const r of n){if(r.source&&e.has(r.source.rootId))if(s)r.source.rootId=s;else{this.reset();return}if(r.sink&&e.has(r.sink.rootId))if(s)r.sink.rootId=s;else{this.reset();return}}}reset(){this.merges.value=[],this.autoSubmit.reset()}toJSON(){const{merges:e,autoSubmit:t}=this,n=s=>{const r={[c0]:s.id,[YA]:s.locked,[p0]:Ks(s.sink),[ol]:Ks(s.source)};return s.mergedRoot&&(r[w0]=s.mergedRoot.toJSON()),s.error&&(r[x0]=s.error),r};return{[b0]:e.value.filter(s=>s.source).map(n),[C0]:t.toJSON()}}restoreState(e){function t(s){const r=jA(s,w0),o=(0,f.cQ)(s,c0,f.zr),a=(0,f.MM)(s,x0,f.zr),l=!1,c=no(s[p0]),d=no(s[ol]);return{id:o,locked:l,sink:c,source:d,mergedRoot:r,error:a}}const n=s=>(0,f.$v)(s,r=>t(r));this.merges.value=(0,f.cQ)(e,b0,n),this.autoSubmit.restoreState((0,f.MM)(e,C0,f.aO))}}class qA extends T.O8{constructor(){super(),this.changed=new j.IY,this.triggerPathUpdate=new j.IY,this.source=new _.DN(void 0,e=>e),this.target=new _.DN(void 0,e=>e),this.centroids=new _.DN([],e=>e),this.precisionMode=new nt(!0),this.registerDisposer(this.source.changed.add(()=>{this.centroids.reset(),this.changed.dispatch()})),this.registerDisposer(this.target.changed.add(()=>{this.centroids.reset(),this.changed.dispatch()})),this.registerDisposer(this.centroids.changed.add(this.changed.dispatch))}get path(){const e=[],{source:{value:t},target:{value:n},centroids:{value:s}}=this;if(!t||!n||s.length===0)return e;for(let a=0;a<s.length-1;a++){const l=s[a],c=s[a+1],d={pointA:C.eR.fromValues(l[0],l[1],l[2]),pointB:C.eR.fromValues(c[0],c[1],c[2]),id:"",type:Re.LINE,properties:[]};e.push(d)}const r={pointA:t.position,pointB:e[0].pointA,id:"",type:Re.LINE,properties:[]},o={pointA:e[e.length-1].pointB,pointB:n.position,id:"",type:Re.LINE,properties:[]};return[r,...e,o]}replaceSegments(e,t){const{source:{value:n},target:{value:s}}=this,r=t.size===1?[...t][0]:void 0,o=!!n&&e.has(n.rootId),a=!!s&&e.has(s.rootId);r?(o&&(n.rootId=r),a&&(s.rootId=r),(o||a)&&(this.centroids.value.length?(this.centroids.reset(),this.triggerPathUpdate.dispatch()):this.changed.dispatch())):(o||a)&&this.reset()}reset(){this.source.reset(),this.target.reset(),this.centroids.reset(),this.precisionMode.reset()}toJSON(){const{source:{value:e},target:{value:t},centroids:n,precisionMode:s}=this;return{[ol]:e?Ks(e):void 0,[T0]:t?Ks(t):void 0,[D0]:n.toJSON(),[I0]:s.toJSON()}}restoreState(e){(0,f.MM)(e,ol,t=>{this.source.restoreState(no(t))}),(0,f.MM)(e,T0,t=>{this.target.restoreState(no(t))}),(0,f.MM)(e,D0,t=>{this.centroids.restoreState(t)}),(0,f.MM)(e,I0,t=>{this.precisionMode.restoreState(t)})}}class XA extends T.O8{constructor(e=new _.DN(void 0,n=>n),t=new _.B0(!1)){super(),this.focusSegment=e,this.blueGroup=t,this.changed=new j.IY,this.sinks=new _._Y,this.sources=new _._Y;const n=()=>{this.sinks.size===0&&this.sources.size===0&&(this.focusSegment.value=void 0)};this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(n)),this.registerDisposer(this.sources.changed.add(n)),this.registerDisposer(this.blueGroup.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(this.changed.dispatch)),this.registerDisposer(this.sources.changed.add(this.changed.dispatch))}replaceSegments(e,t){const n=t.size===1?[...t][0]:void 0,{focusSegment:{value:s}}=this;if(s&&e.has(s))if(n){this.focusSegment.value=n;for(const r of this.sinks)r.rootId=n;for(const r of this.sources)r.rootId=n;this.changed.dispatch()}else this.reset()}reset(){this.focusSegment.reset(),this.blueGroup.value=!1,this.sinks.clear(),this.sources.clear()}toJSON(){const{focusSegment:e,sinks:t,sources:n}=this;return{[m0]:e.toJSON(),[v0]:[...t].map(Ks),[y0]:[...n].map(Ks)}}restoreState(e){const t=r=>(0,f.$v)(r,o=>no(o));(0,f.MM)(e,m0,r=>{this.focusSegment.restoreState(P.R.parseString(String(r)))});const n=(0,f.cQ)(e,v0,t),s=(0,f.cQ)(e,y0,t);for(const r of n)this.sinks.add(r);for(const r of s)this.sources.add(r)}swapGroup(){this.blueGroup.value=!this.blueGroup.value}get activeGroup(){return this.blueGroup.value?this.sources:this.sinks}get segments(){return[...this.redSegments,...this.blueSegments]}get redSegments(){return[...this.sinks].filter(e=>!P.R.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}get blueSegments(){return[...this.sources].filter(e=>!P.R.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}}class is extends _d{constructor(e,t,n,s){super(e,t.displayState.segmentationGroupState.value),this.graph=e,this.layer=t,this.chunkSource=n,this.state=s,this.annotationLayerStates=[],this.operationIds=[],this.lastDeselectionMessageExists=!1,this.deleteMergeSubmission=m=>{const{mergeAnnotationState:g}=this;m.locked=!1,g.source.delete(g.source.getReference(m.id))},this.submitMerge=async(m,g=1)=>{const y=to(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(S=>S/1e-9);m.error=void 0;for(let S=1;S<=g;S++)try{const w=await this.graph.graphServer.mergeSegments(qs(m.sink,y),qs(m.source,y)),{mergeRoot:b,operationId:x}=w;pe.showTemporaryMessage(`Operation ID ${x}`,3e3),this.operationIds.push(x);const E=new qn;E.add(m.sink.rootId),E.add(m.source.rootId);const D=new qn;return D.add(b),this.state.replaceSegments(E,D),b}catch(w){if(S===g)throw m.error=w.message||"unknown",w}return P.R.ZERO};const r=t.displayState.segmentationGroupState.value;this.previousVisibleSegmentCount=r.visibleSegments.size,this.registerDisposer(r.selectedSegments.changed.add((m,g)=>{m!==null&&(m=Array().concat(m)),this.selectedSegmentsChanged(m,g)})),this.registerDisposer(r.visibleSegments.changed.add((m,g)=>{m!==null&&(m=Array().concat(m)),this.visibleSegmentsChanged(m,g)}));const{annotationLayerStates:o,state:{multicutState:a,findPathState:l}}=this;this.registerDisposer(s.timestamp.changed.add(()=>{r.selectedSegments.clear(),r.temporaryVisibleSegments.clear()}));const c=to(t),d=rl(t,c,"sinks",sl),u=rl(t,c,"sources",Mu);R0(a.sinks,d),R0(a.sources,u),o.push(d,u),t.tool.value instanceof io&&(t.tool.value=void 0),this.mergeAnnotationState=rl(t,c,"grapheneMerge",sl);{const{mergeState:m}=s,{merges:g,autoSubmit:v}=m,{mergeAnnotationState:y}=this,{visibleSegments:S}=r;for(const w of g.value)y.source.add(dM(w));this.registerDisposer(y.source.childAdded.add(w=>{const b=w;b.relatedSegments[0].map(D=>S.has(D))[0]===!1?(setTimeout(()=>{const{tool:D}=t;D.value instanceof io&&D.value.deactivate()},0),pe.showTemporaryMessage("Cannot merge a hidden segment.")):g.value.length<M0?g.value=[...g.value,A0(b,!0)]:(setTimeout(()=>{const{tool:D}=t;D.value instanceof io&&D.value.deactivate()},0),pe.showTemporaryMessage(`Maximum of ${M0} simultanous merges allowed.`))})),this.registerDisposer(y.source.childCommitted.add(w=>{const b=y.source.getReference(w),x=b.value;if(x){const E=x.relatedSegments[0],D=E.map(L=>S.has(L));E.length<4&&(y.source.delete(b),pe.showTemporaryMessage("Cannot merge segment with itself.")),D[2]===!1&&(y.source.delete(b),pe.showTemporaryMessage("Cannot merge a hidden segment."));const I=g.value.find(L=>L.id===b.id);if(I&&!I?.locked){const L=A0(x,!1);I.sink=L.sink,I.source=L.source,g.changed.dispatch(),v.value&&this.bulkMerge([I])}}b.dispose()})),this.registerDisposer(y.source.childDeleted.add(w=>{let b=!1;const x=g.value.filter(E=>{const D=E.id!==w||E.locked;return D||(b=!0),D});b&&(g.value=x)}))}const h=rl(t,c,"findpath",AA);this.findPathAnnotationState=h,h.source.childDeleted.add(m=>{l.source.value?.annotationReference?.id===m&&(l.source.value=void 0),l.target.value?.annotationReference?.id===m&&(l.target.value=void 0)});const p=()=>{const{path:m,source:g,target:v}=l,y=h.source;g.value&&!g.value.annotationReference&&cl(y,g.value,"find path source"),v.value&&!v.value.annotationReference&&cl(y,v.value,"find path target");for(const S of y)S.id!==g.value?.annotationReference?.id&&S.id!==v.value?.annotationReference?.id&&y.delete(y.getReference(S.id));for(const S of m)y.add(S)};this.registerDisposer(l.changed.add(p)),this.registerDisposer(l.triggerPathUpdate.add(()=>{const g=to(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(v=>v/1e-9);this.submitFindPath(l.precisionMode.value,g).then(v=>{})})),p()}createRenderLayers(e,t,n){return[new nM(e,this.chunkSource.getChunkedGraphSource(),t,n,this.graph.info.graph.nBitsForLayerId)]}visibleSegmentsChanged(e,t){const{segmentsState:n}=this,{focusSegment:{value:s}}=this.graph.state.multicutState;if(s&&!n.visibleSegments.has(s)&&(n.selectedSegments.has(s)?pe.showTemporaryMessage("Can't hide active multicut segment.",3e3):pe.showTemporaryMessage("Can't deselect active multicut segment.",3e3),n.selectedSegments.add(s),n.visibleSegments.add(s),e&&(e=e.filter(r=>!P.R.equal(r,s)))),e===null){this.segmentsState.segmentEquivalences.clear(),pe.showTemporaryMessage(`Hid all ${this.previousVisibleSegmentCount} segment(s).`,3e3);return}for(const r of e)if(!t&&!s0(r,this.graph.info.graph.nBitsForLayerId)){const o=[...n.segmentEquivalences.setElements(r)].length;n.segmentEquivalences.deleteSet(r),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=pe.showMessage(`Hid ${o} segment(s).`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}this.previousVisibleSegmentCount=n.visibleSegments.size}selectedSegmentsChanged(e,t){const{segmentsState:n}=this;if(e===null){const s=this.segmentsState.selectedSegments.size;pe.showTemporaryMessage(`Deselected all ${s} segment(s).`,3e3);return}for(const s of e){const r=s0(s,this.graph.info.graph.nBitsForLayerId),o=s.clone();t&&r&&this.graph.getRoot(o).then(a=>{n.visibleSegments.has(o)&&n.visibleSegments.add(a),n.selectedSegments.delete(o),n.selectedSegments.add(a)})}}computeSplit(e,t){}getMeshSource(){const{layer:e}=this;for(const t of e.dataSources){const{loadState:n}=t;if(n instanceof Yc){const{subsources:s}=n.dataSource,r=s.filter(a=>a.id==="graph")[0];if(r&&r.subsource.segmentationGraph&&r.subsource.segmentationGraph!==this.graph)continue;const o=s.filter(a=>a.id==="mesh")[0];if(o)return o.subsource.mesh}}}meshAddNewSegments(e){const t=this.getMeshSource();if(t)for(const n of e)t.rpc.invoke(gA,{rpcId:t.rpcId,segment:n.toString()})}async submitMulticut(e){const{state:{multicutState:t}}=this,{sinks:n,sources:s}=t;if(n.size===0||s.size===0)return pe.showTemporaryMessage("Must select both red and blue groups to perform a multi-cut.",7e3),!1;{const r=await this.graph.graphServer.splitSegments([...n].map(l=>qs(l,e)),[...s].map(l=>qs(l,e))),{splitRoots:o,operationId:a}=r;if(o.length===0)return pe.showTemporaryMessage("No split found.",3e3),!1;{console.log("Operation ID:",a),pe.showTemporaryMessage(`Operation ID ${a}`,3e3),this.operationIds.push(a);const l=t.focusSegment.value;t.reset();const{segmentsState:c}=this;c.selectedSegments.delete(l);for(const h of[...n,...s])c.selectedSegments.delete(h.rootId);this.meshAddNewSegments(o),c.selectedSegments.add(o),c.visibleSegments.add(o);const d=new qn;d.add(l);const u=new qn;return u.add(o),this.state.replaceSegments(d,u),!0}}}async bulkMerge(e){const{merges:t}=this.state.mergeState,n=d=>new Promise(u=>{if(d.length===0){u([]);return}const h=[];let p=0,m=0;const g=(v,y)=>{if(p===d.length||y.length===0)return;m++;let S=[];const w=()=>{b++,b===y.length&&(m-=1),m===0&&u(h)};let b=0;for(const x of y){x.locked=!0,x.status="trying...",t.changed.dispatch();const E=[x.source.rootId,x.sink.rootId];this.submitMerge(x,3).then(D=>{h.push(...E),x.status="done",x.mergedRoot=D,t.changed.dispatch(),p+=1,g(p,S),S=[],w(),cM(5e3).then(()=>{this.deleteMergeSubmission(x)})}).catch(()=>{t.changed.dispatch(),S.push(x),p>v&&(g(p,S),S=[]),w()})}};g(p,d)});e=e.filter(d=>!d.locked&&d.source);const s=await n(e),r=[];for(const d of e){d.error?(d.locked=!1,d.status=d.error):d.mergedRoot&&r.push(d.mergedRoot);const u=await this.graph.graphServer.filterLatestRoots(r),h=this.layer.displayState.segmentationGroupState.value,{visibleSegments:p,selectedSegments:m}=h;m.delete(s),this.meshAddNewSegments(u),m.add(u),p.add(u),t.changed.dispatch()}const o=this.layer.displayState.segmentationGroupState.value,{visibleSegments:a,selectedSegments:l}=o;l.delete(s);const c=await this.graph.graphServer.filterLatestRoots(r);l.add(c),a.add(c),t.changed.dispatch()}async submitFindPath(e,t){const{state:{findPathState:n}}=this,{source:s,target:r}=n;if(!s.value||!r.value)return!1;const o=await this.graph.findPath(s.value,r.value,e,t);return pe.showTemporaryMessage("Path found!",5e3),n.centroids.value=o,!0}}async function L0(i){if(i.response){let e;return i.response.headers.get("content-type")==="application/json"?e=(await i.response.json()).message:e=await i.response.text(),e}}async function al(i,e){let t,n=()=>{};e.initialMessage&&(t=new pe(!0),t.setText(e.initialMessage),n=t.dispose.bind(t));try{const s=await i;return n(),s}catch(s){if(s instanceof ke.j$&&s.response){const{errorPrefix:r=""}=e,o=await L0(s)||"unknown error";throw t||(t=new pe(!0)),t.setErrorMessage(r+o),t.setVisible(!0),new Error(`[${s.response.status}] ${r}${o}`)}throw s}}const qs=(i,e)=>{const{rootId:t,segmentId:n,position:s}=i;return{rootId:t,segmentId:n,position:s.map((r,o)=>r*e[o])}},Ou=Symbol("Graph Server Not Specified.");class ZA{constructor(e,t){this.url=e,this.credentialsProvider=t}async getTimestampLimit(){const e=await Nt(this.credentialsProvider,`${this.url}/oldest_timestamp`,{},ke.cj),t=(0,f.cQ)(e,"iso",f.zr);return new Date(t).valueOf()}async getRoot(e,t=0){const n=t/1e3,s=`${this.url}/node/${String(e)}/root?int64_as_str=1${t>0?`&timestamp=${n}`:""}`,r=Nt(this.credentialsProvider,s,{},eo),a=await(await al(r,{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "})).json();return P.R.parseString(a.root_id)}async mergeSegments(e,t){const{url:n}=this;if(n==="")return Promise.reject(Ou);const s=Nt(this.credentialsProvider,`${n}/merge?int64_as_str=1`,{method:"POST",body:JSON.stringify([[String(e.segmentId),...e.position],[String(t.segmentId),...t.position]])},eo);try{const o=await(await s).json(),a=P.R.parseString(o.new_root_ids[0]),l=P.R.parseString(o.operation_id);return{mergeRoot:a,operationId:l}}catch(r){if(r instanceof ke.j$){const o=await L0(r);throw new Error(o)}throw r}}async splitSegments(e,t){const{url:n}=this;if(n==="")return Promise.reject(Ou);const s=Nt(this.credentialsProvider,`${n}/split?int64_as_str=1`,{method:"POST",body:JSON.stringify({sources:e.map(c=>[String(c.segmentId),...c.position]),sinks:t.map(c=>[String(c.segmentId),...c.position])})},eo),o=await(await al(s,{initialMessage:`Splitting ${e.length} sources from ${t.length} sinks`,errorPrefix:"Split failed: "})).json(),a=new Array(o.new_root_ids.length);for(let c=0;c<a.length;++c)a[c]=P.R.parseString(o.new_root_ids[c]);const l=P.R.parseString(o.operation_id);return{splitRoots:a,operationId:l}}async filterLatestRoots(e){const t=`${this.url}/is_latest_roots`,n=Nt(this.credentialsProvider,t,{method:"POST",body:JSON.stringify({node_ids:e.map(a=>a.toJSON())})},eo),r=await(await al(n,{errorPrefix:"Could not check latest: "})).json(),o=[];for(const[a,l]of r.is_latest.entries())l&&o.push(e[a]);return o}async findPath(e,t,n){const{url:s}=this;if(s==="")return Promise.reject(Ou);const r=Nt(this.credentialsProvider,`${s}/graph/find_path?int64_as_str=1&precision_mode=${Number(n)}`,{method:"POST",body:JSON.stringify([[String(e.rootId),...e.position],[String(t.rootId),...t.position]])},eo),a=await(await al(r,{initialMessage:`Finding path between ${e.segmentId} and ${t.segmentId}`,errorPrefix:"Path finding failed: "})).json(),c=(0,f.cQ)(a,"centroids_list",p=>(0,f.$v)(p,f.pf)),u=a["failed_l2_ids"];u&&u.length>0&&pe.showTemporaryMessage("Some level 2 meshes are missing, so the path shown may have a poor level of detail.");const h=(0,f.MM)(a,"l2_path",f.si);return{centroids:c,l2_path:h}}}class ll extends Od{constructor(e,t,n,s){super(),this.info=e,this.credentialsProvider=t,this.chunkSource=n,this.state=s,this.connections=new Set,this.l2CacheAvailable=void 0,this.timestampLimit=new _.DN(0,r=>r),this.graphServer=new ZA(e.app.segmentationUrl,t),this.graphServer.getTimestampLimit().then(r=>{this.timestampLimit.value=r})}connect(e){const t=new is(this,e,this.chunkSource,this.state);return this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}get visibleSegmentEquivalencePolicy(){return Rt.y6.MAX_REPRESENTATIVE|Rt.y6.NONREPRESENTATIVE_EXCLUDED}async isL2CacheUrlAvailable(){if(this.l2CacheAvailable!==void 0)return this.l2CacheAvailable;try{const{l2CacheUrl:e,table:t}=this.info.app,n=await Nt(void 0,`${e}/table_mapping`,{},ke.cj);return this.l2CacheAvailable=!!(n&&n[t]),this.l2CacheAvailable}catch(e){return console.error("e",e),!1}}getRoot(e){return this.graphServer.getRoot(e,this.state.timestamp.value)}async findPath(e,t,n,s){const{l2CacheUrl:r,table:o}=this.info.app,a=n&&await this.isL2CacheUrlAvailable();let{centroids:l,l2_path:c}=await this.graphServer.findPath(qs(e,s),qs(t,s),n&&!a);if(n&&a&&c){const u=`${r}/table/${o}/attributes`;try{const h=await Nt(this.credentialsProvider,u,{method:"POST",body:JSON.stringify({l2_ids:c})},ke.cj);l=c.map(p=>(0,f.MM)(h,p,m=>(0,f.VH)(m.rep_coord_nm))).filter(p=>p!==void 0)}catch(h){console.log("e",h)}}return l.map(u=>u.map((h,p)=>h/s[p]))}tabContents(e,t,n){const s=document.createElement("div");s.style.display="contents";const r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",s.appendChild(fa(n,e,n.visibility,k0)),r.appendChild(Wn(t,e.toolBinder,{toolJson:_u,label:"Multicut",title:"Multicut segments"})),r.appendChild(Wn(t,e.toolBinder,{toolJson:Vu,label:"Merge",title:"Merge segments"})),r.appendChild(Wn(t,e.toolBinder,{toolJson:Bu,label:"Find Path",title:"Find Path"})),s.appendChild(r),s.appendChild(t.registerDisposer(new iM(e,e.annotationDisplayState)).element);const o=n.element;return o.classList.add("neuroglancer-annotations-tab"),o.classList.add("neuroglancer-graphene-tab"),s}async merge(e,t){return new P.R}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}}class eM extends Lr{constructor(e,t){super(e,t)}}class tM extends it(lt()(eM),n0){}class nM extends Fi{constructor(e,t,n,s,r){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.localPosition=s,this.layerChunkProgressInfo=new fo,this.leafRequestsActive=this.registerDisposer(ft.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer((0,_.ol)(a=>bo(()=>po(sc(a))),this.displayState.transform));const o=this.sharedObject=this.backend=this.registerDisposer(new Ia(e,n,this.layerChunkProgressInfo));o.RPC_TYPE_ID=SA,o.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(ft.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(ft.make(e.rpc,r)).rpcId}),this.registerDisposer(o.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);const t=this.chunkTransform.value,n=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:n},e.state.source=e.registerDisposer((0,_.no)((s,r,o)=>{const a=sa(o,r,l=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke(bA,{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:o,sources:ta(a)}),a[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,pe.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):!this.leafRequestsStatusMessage&&!e&&(this.leafRequestsStatusMessage=pe.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}}const _u="grapheneMulticutSegments",Vu="grapheneMergeSegments",Bu="grapheneFindPath";class iM extends hy{constructor(e,t){super(e,t),this.layer=e,this.displayState=t;const{graphConnection:{value:n}}=e;if(n instanceof is)for(const s of n.annotationLayerStates)this.annotationStates.add(s)}get annotationStates(){return this._annotationStates===void 0&&(this._annotationStates=this.registerDisposer(new ly)),this._annotationStates}}const cl=(i,e,t)=>{const n={id:"",point:e.position,type:Re.POINT,properties:[],relatedSegments:[[e.segmentId,e.rootId]],description:t},s=i.add(n);e.annotationReference=s},R0=(i,e)=>{const t=e.source;t.childDeleted.add(n=>{const s=[...i].find(r=>r.annotationReference?.id===n);s&&i.delete(s)}),i.changed.add((n,s)=>{if(n===null){for(const r of t)t.delete(t.getReference(r.id));return}s?cl(t,n):n.annotationReference&&t.delete(n.annotationReference)});for(const n of i)cl(t,n)};function sM(i,e){const n=to(e).getRenderLayerTransform(),s=bo(()=>po(sc(n.value)));if(s.error!==void 0)return;const r=new Float32Array(s.modelTransform.unpaddedRank);if(gs(r,i,e.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))return r}const rM=(i,e)=>{if(e.updateUnconditionally())return sM(e.unsnappedPosition,i)},k0={label:"Time",title:"View segmentation at earlier point of time",toolJson:"grapheneTime",...oM()};gd(Ct,k0);function oM(){return{makeControl:(i,e)=>{const t=i.displayState.segmentationGroupState.value,{graph:{value:n}}=t,s=n instanceof ll?n.state.timestamp:new _.DN(0,c=>c),r=n instanceof ll?n.timestampLimit:new _.DN(0,c=>c),o=document.createElement("div");o.classList.add("neuroglancer-time-control");const a=new _.DN(s.value,c=>c);a.changed.add(()=>{a.value!==s.value&&n instanceof ll&&(!(t.selectedSegments.size+t.temporaryVisibleSegments.size>0)||confirm("Changing graphene time will clear all selected segments.")?s.value=a.value:a.value=s.value)});const l=e.registerDisposer(new wA(a,new Date(r.value),new Date));return r.changed.add(()=>{l.setMin(new Date(r.value))}),s.changed.add(()=>{s.value!==a.value&&(a.value=s.value)}),o.appendChild(l.element),{controlElement:o,control:l}},activateTool:i=>{}}}const P0=(i,e)=>i.value!==0?(pe.showTemporaryMessage("Editing can not be performed with a segmentation at an older state."),e.cancel(),!0):!1,aM=Ae.fromObject({"at:shift?+control+mousedown0":{action:"set-anchor"},"at:shift?+keyg":{action:"swap-group"},"at:shift?+enter":{action:"submit"}});class lM extends gi{toJSON(){return _u}activate(e){const{layer:t}=this,{graphConnection:{value:n}}=t;if(!n||!(n instanceof is)){e.cancel();return}const{state:{multicutState:s,timestamp:r},segmentsState:o}=n;if(P0(r,e)||(e.registerDisposer(r.changed.add(()=>{e.cancel()})),s===void 0))return;const{body:a,header:l}=Vi(e);l.textContent="Multicut segments",a.classList.add("graphene-tool-status","graphene-multicut"),a.appendChild(Ne({text:"Swap",title:"Swap group",onClick:()=>{s.swapGroup()}})),a.appendChild(Ne({text:"Clear",title:"Clear multicut",onClick:()=>{s.reset()}}));const c=async()=>{d.classList.toggle("disabled",!0);const w=to(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(b=>b/1e-9);n.submitMulticut(w).then(b=>{d.classList.toggle("disabled",!1),b&&e.cancel()})},d=Ne({text:"Submit",title:"Submit multicut",onClick:()=>{c()}});a.appendChild(d);const u=document.createElement("div");u.className="activeGroupIndicator",u.innerHTML="Active Group: ",a.appendChild(u);const{displayState:h}=this.layer,p=h.segmentationGroupState.value,m=h.baseSegmentHighlighting.value,g=h.highlightColor.value;e.bindInputEventMap(aM),e.registerDisposer(()=>{v(),h.baseSegmentHighlighting.value=m,h.highlightColor.value=g});const v=()=>{Ur(p),h.useTempSegmentStatedColors2d.value=!1,h.tempSegmentStatedColors2d.value.clear(),h.tempSegmentDefaultColor2d.value=void 0,h.highlightColor.value=void 0},y=()=>{v(),u.classList.toggle("blueGroup",s.blueGroup.value);const S=s.focusSegment.value;if(S!==void 0){h.baseSegmentHighlighting.value=!0,h.highlightColor.value=s.blueGroup.value?DA:TA,o.useTemporaryVisibleSegments.value=!0,o.useTemporarySegmentEquivalences.value=!0,o.temporaryVisibleSegments.add(S);for(const w of s.segments)o.temporaryVisibleSegments.add(w);for(const w of o.segmentEquivalences.setElements(S))o.temporaryVisibleSegments.has(w)||o.temporarySegmentEquivalences.link(S,w);h.tempSegmentDefaultColor2d.value=PA,h.tempSegmentStatedColors2d.value.set(S,kA);for(const w of s.redSegments)h.tempSegmentStatedColors2d.value.set(w,LA);for(const w of s.blueSegments)h.tempSegmentStatedColors2d.value.set(w,RA);h.useTempSegmentStatedColors2d.value=!0}};y(),e.registerDisposer(s.changed.add(y)),e.registerDisposer(p.segmentEquivalences.changed.add((0,Fe.A)(()=>y(),0))),e.bindAction("swap-group",S=>{S.stopPropagation(),s.swapGroup()}),e.bindAction("set-anchor",S=>{S.stopPropagation();const w=Fu(this,p.visibleSegments);if(!w)return;const{rootId:b,segmentId:x}=w,{focusSegment:E,segments:D}=s;if(E.value===void 0&&(E.value=b.clone()),!P.R.equal(E.value,b)){pe.showTemporaryMessage(`The selected supervoxel has root segment ${b.toString()}, but the supervoxels already selected have root ${E.value.toString()}`,12e3);return}if(!P.R.equal(b,x)){for(const L of D)if(P.R.equal(L,x)){pe.showTemporaryMessage(`Supervoxel ${x.toString()} has already been selected`,7e3);return}}s.activeGroup.add(w)}),e.bindAction("submit",S=>{S.stopPropagation(),c()})}get description(){return"multicut"}}const Fu=(i,e)=>{const{layer:t,mouseState:n}=i,{segmentSelectionState:{value:s,baseValue:r}}=t.displayState;if(!r||!s)return;if(!e.has(s)){pe.showTemporaryMessage("The selected supervoxel is of an unselected segment",7e3);return}const o=rM(t,n);if(o!==void 0)return{rootId:s.clone(),segmentId:r.clone(),position:o}},cM=i=>new Promise((e,t)=>{setTimeout(e,i)});class io extends Ga{constructor(e,t){super(e,{}),this.annotationState=t,this.getBaseSegment=!0;const{inProgressAnnotation:n}=this,{displayState:s}=t;if(!s)return;const{disablePicking:r}=s;this.registerDisposer(n.changed.add(()=>{r.value=n.value!==void 0}))}get annotationLayer(){return this.annotationState}get description(){return"merge line"}toJSON(){return N0}}function A0(i,e){const t=i.relatedSegments[0],n={id:i.id,locked:!1,sink:{position:i.pointA.slice(),rootId:t[0].clone(),segmentId:t[1].clone()}};return e||(n.source={position:i.pointB.slice(),rootId:t[2].clone(),segmentId:t[3].clone()}),n}function dM(i){const{sink:e,source:t}=i;return{id:i.id,type:Re.LINE,pointA:e.position.slice(),pointB:t.position.slice(),relatedSegments:[[e.rootId.clone(),e.segmentId.clone(),t.rootId.clone(),t.segmentId.clone()]],properties:[]}}const M0=20,uM=Ae.fromObject({"at:shift?+enter":{action:"submit"}});class hM extends gi{activate(e){const{graphConnection:{value:t},tool:n}=this.layer;if(!t||!(t instanceof is)){e.cancel();return}const{state:{mergeState:s,timestamp:r}}=t;if(P0(r,e))return;const{merges:o,autoSubmit:a}=s,l=new io(this.layer,t.mergeAnnotationState);n.value=l,e.registerDisposer(()=>{n.value=void 0});const{body:c,header:d}=Vi(e);d.textContent="Merge segments",c.classList.add("graphene-tool-status","graphene-merge-segments"),e.bindInputEventMap(uM);const u=async()=>{o.value.filter(x=>x.locked).length||(h.classList.toggle("disabled",!0),await t.bulkMerge(o.value),h.classList.toggle("disabled",!1))},h=Ne({text:"Submit",title:"Submit merge",onClick:async()=>{u()}});c.appendChild(h),e.bindAction("submit",async x=>{x.stopPropagation(),u()}),c.appendChild(Ne({text:"Clear",title:"Clear pending merges",onClick:()=>{l.deactivate();for(const x of o.value)x.locked||t.deleteMergeSubmission(x)}}));const p=e.registerDisposer(new pn(a)),m=document.createElement("label");m.appendChild(document.createTextNode("auto-submit")),m.title="auto-submit merges",m.appendChild(p.element),c.appendChild(m);const g=document.createElement("div");g.classList.add("graphene-merge-segments-merges"),c.appendChild(g);const v=Vs.make(this.layer.displayState,!0),y=x=>{const E=v.getWithNormalizedId(x);return E.classList.add("neuroglancer-segment-list-entry-double-line"),E},S=x=>{const E=document.createElement("div");E.classList.add("graphene-merge-segments-point");const D=y(Yi(this.layer.displayState,x));return E.appendChild(D),E},w=x=>{const E=document.createElement("div");if(E.classList.add("graphene-merge-segments-submission"),E.appendChild(S(x.sink.rootId)),x.source&&(E.appendChild(document.createElement("div")).textContent="\uA579",E.appendChild(S(x.source.rootId))),x.locked||E.appendChild(Mn({title:"Delete merge",onClick:D=>{D.stopPropagation(),D.preventDefault(),t.deleteMergeSubmission(x)}})),x.status){const D=document.createElement("div");D.classList.add("graphene-merge-segments-submission-status"),D.textContent=x.status,E.appendChild(D)}return E},b=()=>{for(;g.firstChild;)g.removeChild(g.firstChild);for(const x of o.value)g.appendChild(w(x))};e.registerDisposer(o.changed.add(b)),b()}toJSON(){return Vu}get description(){return"merge segments"}}const pM=Ae.fromObject({"at:shift?+enter":{action:"submit"},"at:shift?+control+mousedown0":{action:"add-point"}});class fM extends gi{activate(e){const{layer:t}=this,{graphConnection:{value:n}}=t;if(!n||!(n instanceof is))return;const{state:{findPathState:s},findPathAnnotationState:r}=n,{source:o,target:a,precisionMode:l}=s,c=this.layer.displayState.segmentationGroupState.value,{body:d,header:u}=Vi(e);u.textContent="Find Path",d.classList.add("graphene-tool-status","graphene-find-path");const h=()=>{s.triggerPathUpdate.dispatch()};d.appendChild(Ne({text:"Submit",title:"Submit Find Path",onClick:()=>{h()}})),d.appendChild(Ne({text:"Clear",title:"Clear Find Path",onClick:()=>{s.source.reset(),s.target.reset(),s.centroids.reset()}}));const p=e.registerDisposer(new pn(l)),m=document.createElement("label"),g=document.createElement("span");g.textContent="Precision mode: ",m.appendChild(g),m.title="Precision mode returns a more accurate path, but takes longer.",m.appendChild(p.element),d.appendChild(m);const v=document.createElement("div");v.classList.add("find-path-annotations"),d.appendChild(v);const y=Im();this.registerDisposer(new tn(v,y));const S=()=>{Me(v);const w=[0,0,0],b=[0,1,2],x=[],E="[symbol] 2ch [dim] var(--neuroglancer-column-0-width) [dim] var(--neuroglancer-column-1-width) [dim] var(--neuroglancer-column-2-width) [delete] min-content",I=[o,a].map(L=>L.value?.annotationReference?.value).filter(L=>L);for(const L of I){const[N,k]=xy(this.layer,L,r,E,b,x);for(const[O,V]of k.entries())w[O]=V;v.appendChild(N)}for(const[L,N]of w.entries())v.style.setProperty(`--neuroglancer-column-${L}-width`,`${N+2}ch`)};s.changed.add(S),S(),e.bindInputEventMap(pM),e.bindAction("submit",w=>{w.stopPropagation(),h()}),e.bindAction("add-point",w=>{w.stopPropagation(),(async()=>{if(o.value){if(!a.value){const b=Fu(this,c.visibleSegments);b&&(a.value=b)}}else{const b=Fu(this,c.visibleSegments);b&&(o.value=b)}})()})}toJSON(){return Bu}get description(){return"find path"}}sn(Ct,_u,i=>new lM(i,!0)),sn(Ct,Vu,i=>new hM(i,!0)),sn(Ct,Bu,i=>new fM(i,!0));const N0="annotateMergeLine";Cr(N0,(i,e)=>new io(i,e));/**
 * @license
 * Copyright 2018 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("graphene",()=>new JA);/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gM(i,e,t){const n=window.outerHeight-window.innerHeight+window.innerHeight/2-t/2,s=window.innerWidth/2-e/2;return window.open(i,void 0,`toolbar=no, menubar=no, width=${e}, height=${t}, top=${n}, left=${s}`)}async function O0(i,e,t,n,s){const r=new pe(!1,!0),o=new Promise(a=>{function l(c,d){r.element.textContent=c+" ";const u=document.createElement("button");u.textContent=d,r.element.appendChild(u),u.addEventListener("click",()=>{l(n,"Retry");const h=gM(i,400,650),p=()=>{h?.close()};window.addEventListener("beforeunload",p);const m=setInterval(()=>{h?.closed&&(clearInterval(m),l(s,"Retry"))},1e3),g=async v=>{v.source===h&&(clearInterval(m),window.removeEventListener("message",g),window.removeEventListener("beforeunload",p),p(),a(v.data))};window.addEventListener("message",g)})}l(e,t)});try{return await o}finally{r.dispose()}}async function mM(i){const e=await O0(`${i}/api/v1/authorize`,`middleauth server ${i} login required.`,"Login",`Waiting for login to middleauth server ${i}...`,`Login window closed for middleauth server ${i}.`);(0,f.Rf)(e);const t=(0,f.cQ)(e,"token",f.zr),n=(0,f.cQ)(e,"app_urls",f.si);return{tokenType:"Bearer",accessToken:t,url:i,appUrls:n}}async function vM(i,e){return await O0(i,`Before you can access ${e}, you need to accept its Terms of Service.`,"Open","Waiting for Terms of Service agreement...",`Terms of Service closed for ${e}.`)==="success"}const _0="auth_token_v2";function yM(i){const e=localStorage.getItem(`${_0}_${i}`);return e?JSON.parse(e):null}function SM(i,e){localStorage.setItem(`${_0}_${i}`,JSON.stringify(e))}class bM extends Nn{constructor(e){super(),this.serverUrl=e,this.alreadyTriedLocalStorage=!1,this.get=Xn(async()=>{let t;return this.alreadyTriedLocalStorage||(this.alreadyTriedLocalStorage=!0,t=yM(this.serverUrl)),t||(t=await mM(this.serverUrl),SM(this.serverUrl,t)),t})}}class CM extends Error{constructor(e){super(),this.url=e}}class wM extends Nn{constructor(e,t){super(),this.serverUrl=e,this.credentialsManager=t,this.credentials=void 0,this.agreedToTos=!1,this.get=Xn(async()=>{if(this.credentials&&this.agreedToTos)return this.credentials.credentials;this.agreedToTos=!1;const n=await fetch(`${this.serverUrl}/auth_info`).then(o=>o.json()),s=this.credentialsManager.getCredentialsProvider("middleauth",n.login_url);if(this.credentials=await s.get(this.credentials),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new pe(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new CM(this.serverUrl)}),this.errorHandler=async(n,s)=>{const{status:r}=n;if(r===401)return"refresh";if(r===403){const{response:o}=n;if(o){const{headers:a}=o;if(a.get("content-type")==="application/json"){const c=await o.json();if(c.error&&c.error==="missing_tos"){const d=new URL(c.data.tos_form_url);if(d.searchParams.set("client","ng"),await vM(d.toString(),c.data.tos_name))return this.agreedToTos=!0,"refresh"}}}if(!s.accessToken)return"refresh"}throw n}}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Zn.register("middleauth",i=>new bM(i)),Zn.register("middleauthapp",(i,e)=>new wM(i,e));var Uu=G(5926);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xM extends it(lt()(Kn),Uu.j){}class EM extends ln{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.multiscaleMetadata=n,this.scales=s;let r,o;if(s.forEach((u,h)=>{if(u!==void 0){if(o===void 0&&(o=h),r!==void 0&&u.dataType!==r)throw new Error(`Scale s${h} has data type ${R[u.dataType]} but expected ${R[r]}.`);r=u.dataType}}),r===void 0)throw new Error("At least one scale must be specified.");const a=n.scales[o],l=s[o];this.dataType=r,this.volumeType=St.IMAGE,this.baseScaleIndex=o;const c=n.modelSpace,{rank:d}=c;this.modelSpace=Oe({names:c.names,scales:c.scales,units:c.units,boundingBoxes:[{transform:(0,De.nx)(Float64Array,a.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(d),upperBounds:new Float64Array(l.size)}}],coordinateArrays:c.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){const{scales:t,rank:n}=this,s=this.multiscaleMetadata.scales;return(0,F.RO)(t.filter(r=>r!==void 0).map((r,o)=>{const a=s[o],l=(0,De.nx)(Float32Array,a.downsamplingFactor);return qi({rank:n,chunkToMultiscaleTransform:l,dataType:r.dataType,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:[r.chunkSize],volumeSourceOptions:e}).map(c=>({chunkSource:this.chunkManager.getChunkSource(xM,{credentialsProvider:this.credentialsProvider,spec:c,parameters:{url:a.url,encoding:r.encoding}}),chunkToMultiscaleTransform:l}))}))}}class TM{constructor(e){(0,f.Rf)(e),this.dataType=(0,f.cQ)(e,"dataType",n=>(0,f.sl)(n,R)),this.size=Float32Array.from((0,f.cQ)(e,"dimensions",n=>(0,f.$v)(n,f.We))),this.chunkSize=(0,f.cQ)(e,"blockSize",n=>(0,f.Xu)(new Uint32Array(this.size.length),n,f.We));let t;(0,f.MM)(e,"compression",n=>{t=(0,f.cQ)(n,"type",s=>(0,f.sl)(s,Uu.r))}),t===void 0&&(t=(0,f.cQ)(e,"compressionType",n=>(0,f.sl)(n,Uu.r))),this.encoding=t}}function DM(i,e,t){return Promise.all(t.scales.map(async n=>{const s=await V0(i,e,n.url,!0);if(s!==void 0)return new TM(s)}))}function IM(i){let{protocol:e,host:t,path:n}=(0,ke.Dl)(i);n.endsWith("/")&&(n=n.substring(0,n.length-1));const s=[];for(;;){s.push(`${e}://${t}${n}/attributes.json`);const r=n.lastIndexOf("/");if(r===-1)break;n=n.substring(0,r)}return s}function LM(i,e,t,n){return i.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:xt(e)},()=>Nt(e,t,{},ke.cj).then(s=>{try{return(0,f.Rf)(s)}catch(r){throw new Error(`Error reading attributes from ${t}: ${r.message}`)}}).catch(s=>{if((0,ke.El)(s))return n?void 0:{};throw s}))}async function V0(i,e,t,n){const s=IM(t),r=await Promise.all(s.map((o,a)=>LM(i,e,o,n&&a===s.length-1)));if(r.indexOf(void 0)===-1)return r.reverse(),Object.assign({},...r)}function Di(i,e){if(i!==-1&&e!==i)throw new Error(`Rank mismatch, received ${e} but expected ${i}`);return e}function B0(i){return Float64Array.from((0,f.$v)(i,f.Mo))}function F0(i){const e=(0,f.J6)(i);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:(0,f.$v)(e,s=>{const r=B0(s);return t=Di(t,r.length),r}),single:void 0,rank:t}}function RM(i){const e=(0,f.J6)(i);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return F0(e);const t=B0(i);return{all:void 0,single:t,rank:t.length}}const kM=["x","y","z","t","c"];function PM(i){const e=kM.slice(0,i);for(;e.length<i;)e.push(`d${e.length+1}`);return e}function AM(i,e){(0,f.Rf)(e);let t=-1,n=(0,f.MM)(e,"resolution",h=>{const p=Float64Array.from((0,f.$v)(h,f.Mo));return t=Di(t,p.length),p}),s=(0,f.MM)(e,"axes",h=>{const p=(0,f.$v)(h,f.zr);return t=Di(t,p.length),p}),r=(0,f.MM)(e,"units",h=>{const p=(0,f.$v)(h,Ph);return t=Di(t,p.length),p}),o={unit:"m",exponent:-9},a,l;(0,f.MM)(e,"downsamplingFactors",h=>{const{single:p,all:m,rank:g}=RM(h);t=Di(t,g),p!==void 0&&(a=p),m!==void 0&&(l=m)}),(0,f.MM)(e,"pixelResolution",h=>{o=(0,f.cQ)(h,"unit",Ph),(0,f.MM)(h,"dimensions",p=>{n=Float64Array.from((0,f.$v)(p,f.Mo)),t=Di(t,n.length)})}),(0,f.MM)(e,"scales",h=>{const{all:p,rank:m}=F0(h);t=Di(t,m),l=p});const c=(0,f.MM)(e,"dimensions",h=>{const p=(0,f.$v)(h,f.We);return t=Di(t,p.length),p});if(t===-1)throw new Error("Unable to determine rank of dataset");r===void 0&&(r=new Array(t),r.fill(o)),n===void 0&&(n=new Float64Array(t),n.fill(1));for(let h=0;h<t;++h)n[h]=Fl(n[h],r[h].exponent);const d=new Array(t);s!==void 0&&(0,f.MM)(e,"coordinateArrays",h=>{(0,f.Rf)(h);for(let p=0;p<t;++p){const m=s[p];if(Object.prototype.hasOwnProperty.call(h,m)){const g=(0,f.si)(h[m]);d[p]={explicit:!1,labels:g,coordinates:Array.from(g,(v,y)=>y)},r[p]={unit:"",exponent:0},n[p]=1}}}),s===void 0&&(s=PM(t));const u=Oe({rank:t,valid:!0,names:s,scales:n,units:r.map(h=>h.unit),coordinateArrays:d});if(c===void 0){if(l===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:u,url:i,attributes:e,scales:l.map((h,p)=>({url:`${i}/s${p}`,downsamplingFactor:h}))}}return a===void 0&&(a=new Float64Array(t),a.fill(1)),{modelSpace:u,url:i,attributes:e,scales:[{url:i,downsamplingFactor:a}]}}class MM extends Jt{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{const{url:n,credentialsProvider:s}=wn(t,e.credentialsManager),r=await V0(e.chunkManager,s,n,!1),o=AM(n,r),a=await DM(e.chunkManager,s,o),l=new EM(e.chunkManager,s,o,a);return{modelTransform:wt(l.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:l}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:xn(l.modelSpace.bounds)}}]}})}completeUrl(e){return ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("n5",()=>new MM);/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function U0(i){return new Error(`ngauth server ${i} does not allow requests from Neuroglancer instance ${self.origin}`)}async function NM(i){const e=new pe(!1);function t(s,r){e.element.textContent=s+" ";const o=document.createElement("button");o.textContent=r,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${i}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to ngauth server ${i}...`,"Retry")})}const n=new Promise((s,r)=>{function o(a){if((a.origin||a.originalEvent.origin)!==i)return;const c=()=>{window.removeEventListener("message",o,!1)},{data:d}=a;a.data==="badorigin"&&(c(),r(U0(i)));try{(0,f.Rf)(d);const u=(0,f.cQ)(d,"token",f.zr);c(),s(u)}catch{console.log("ngauth: Received unexpected message from ${serverUrl}",a)}}window.addEventListener("message",o,!1)});t(`ngauth server ${i} login required.`,"Login");try{return{token:await n}}finally{e.dispose()}}class OM extends Nn{constructor(e){super(),this.serverUrl=e,this.get=Xn(async()=>{const t=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(t.status){case 200:return{token:await t.text()};case 401:return await NM(this.serverUrl);case 403:throw U0(this.serverUrl);default:throw ke.j$.fromResponse(t)}})}}class _M extends Nn{constructor(e,t,n){super(),this.ngauthCredentialsProvider=e,this.serverUrl=t,this.bucket=n,this.get=Xn(async()=>({tokenType:"Bearer",accessToken:(await(0,Ka.R)(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST"},ke.cj,(r,o)=>({...o,body:JSON.stringify({token:r.token,bucket:this.bucket})}),r=>{const{status:o}=r;if(o===401)return"refresh";throw r})).token}))}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Zn.register("ngauth",i=>new OM(i)),Zn.register("ngauth_gcs",(i,e)=>new _M(e.getCredentialsProvider("ngauth",i.authServer),i.authServer,i.bucket));/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $0(i){return new Error(`Nggraph server ${i} does not allow requests from Neuroglancer instance ${self.origin}`)}async function VM(i){const e=new pe(!1);function t(s,r){e.element.textContent=s+" ";const o=document.createElement("button");o.textContent=r,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${i}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${i}...`,"Retry")})}const n=new Promise((s,r)=>{function o(a){if((a.origin||a.originalEvent.origin)!==i||typeof a.data!="string")return;const c=()=>{window.removeEventListener("message",o,!1)};a.data==="badorigin"?(c(),r($0(i))):(c(),s(a.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${i} login required.`,"Login");try{return{token:await n}}finally{e.dispose()}}class BM extends Nn{constructor(e){super(),this.serverUrl=e,this.get=Xn(async()=>{const t=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(t.status){case 200:return{token:await t.text()};case 401:return await VM(this.serverUrl);case 403:throw $0(this.serverUrl);default:throw ke.j$.fromResponse(t)}})}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const FM="^(https?://[^/]+)/(.*)$";function UM(i){return(0,f.Rf)(i),{id:(0,f.cQ)(i,"id",e=>P.R.parseString((0,f.zr)(e))),baseSegments:(0,f.cQ)(i,"base_segment_ids",e=>(0,f.$v)(e,t=>P.R.parseString((0,f.zr)(t)))),baseSegmentParents:(0,f.cQ)(i,"base_segment_parent_ids",e=>(0,f.$v)(e,t=>P.R.parseString((0,f.zr)(t)))),name:(0,f.cQ)(i,"name",f.zr),tags:(0,f.cQ)(i,"tags",f.si),numVoxels:(0,f.cQ)(i,"num_voxels",f.bX),bounds:(0,f.cQ)(i,"bounds",e=>(0,f.$v)(e,t=>(0,f.zo)(t))),lastLogId:(0,f.cQ)(i,"last_log_id",e=>e==null?null:P.R.parseString((0,f.zr)(e)))}}let G0=0;class $M extends _d{constructor(e,t){super(e,t),this.debouncedVisibleSegmentsChanged=this.registerCancellable((0,Fe.A)(()=>this.visibleSegmentsChanged(),0)),this.segmentQueries=new Map,this.ignoreVisibleSegmentsChanged=!1,this.segmentEquivalencesChanged=this.registerCancellable((0,Fe.A)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();const{segmentQueries:s}=this,{segmentEquivalences:r}=this.segmentsState;r.clear();for(const[o,a]of s){if(a.current===void 0||(0,Rt.YR)(a.id))continue;const{id:l,baseSegments:c}=a.current;if(c.length>0){for(const d of c)r.link(d,l);a.addedEquivalences=!0}else a.addedEquivalences=!1}},0));const n=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(n)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(n)),this.visibleSegmentsChanged()}computeSplit(e,t){const{segmentEquivalences:n}=this.segmentsState,s=n.get(e);if((0,Rt.YR)(s)||!P.R.equal(n.get(t),s))return;const r=this.segmentQueries.get(s.toString());if(r===void 0)return;const{current:o}=r;if(o===void 0)return;const{baseSegments:a,baseSegmentParents:l}=o,c=l.length,d=new Vd.I;for(let m=0;m<c;++m){const g=a[m],v=l[m];P.R.equal(g,t)||P.R.equal(v,t)||(d.link(g,v),console.log(`Linking ${g} - ${v} == ${e}? ${P.R.equal(e,g)} ${P.R.equal(e,v)} :: unioned with include = ${P.R.equal(e,d.get(g))}, with exclude = ${P.R.equal(t,d.get(g))}`))}const u=[],h=[],p=d.get(e);for(const m of a)P.R.equal(d.get(m),p)?u.push(m):h.push(m);return console.log("include = "+u.map(m=>m.toString()).join(",")),console.log("exclude = "+h.map(m=>m.toString()).join(",")),{includeRepresentative:s,includeBaseSegments:u,excludeRepresentative:Rt.G1,excludeBaseSegments:h}}registerVisibleSegment(e){const t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:G0,disposer:this.graph.watchSegment(e,s=>this.handleSegmentUpdate(t.id.toString(),s))},n=e.toString();this.segmentQueries.set(n,t),console.log(`adding to segmentQueries: ${n}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);const n=this.segmentQueries.get(e);if(t==="invalid"){n.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(n.id),this.segmentsState.temporaryVisibleSegments.delete(n.id)}finally{this.ignoreVisibleSegmentsChanged=!1}n.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){n.current=void 0,n.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}n.current=t;const s=n.id,r=t.id;if(P.R.equal(r,s))n.current=t,(0,Rt.YR)(n.id)||this.segmentEquivalencesChanged();else{n.id=r;const o=r.toString(),a=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${r}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(s)&&this.segmentsState.visibleSegments.add(r),this.segmentsState.selectedSegments.has(s)&&(this.segmentsState.selectedSegments.delete(s),this.segmentsState.selectedSegments.add(r)),this.segmentsState.temporaryVisibleSegments.has(s)&&(this.segmentsState.temporaryVisibleSegments.delete(s),this.segmentsState.temporaryVisibleSegments.add(r))}finally{this.ignoreVisibleSegmentsChanged=!1}a===void 0?(console.log(`adding to segmentQueries due to rename -> ${r}`),this.segmentQueries.set(o,n),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof a.current!="object"||a.current.lastLogId===null||P.R.less(a.current.lastLogId,t.lastLogId))&&(a.current=t,this.segmentEquivalencesChanged()),n.disposer())}}visibleSegmentsChanged(){const{segmentsState:e}=this,{segmentQueries:t}=this,n=++G0,s=r=>{for(const o of r.unsafeKeys()){if(P.R.equal(o,Rt.G1))continue;const a=o.toString(),l=t.get(a);if(l!==void 0){l.seenGeneration=n;continue}this.registerVisibleSegment(o.clone())}};s(e.visibleSegments),s(e.temporaryVisibleSegments);for(const[r,o]of t)o.seenGeneration!==n&&(console.log(`removing from segmentQueries due to seenGeneration: ${r}`),t.delete(r),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}}class GM extends Od{constructor(e,t,n){super(),this.chunkManager=e,this.serverUrl=t,this.entityName=n,this.startingWebsocket=!1,this.websocket=void 0,this.watchesById=new Map,this.watches=new Set,this.nextWatchId=0,this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return Rt.y6.MAX_REPRESENTATIVE|Rt.y6.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new pe(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{const{numOpenFailures:t}=this;if(t>1){const o=1e3*Math.min(16,2**t);await new Promise(a=>setTimeout(a,o))}const n=(await Gu(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,s=new URL("/graph/watch/"+encodeURIComponent(n.token),this.serverUrl);s.protocol=s.protocol.replace("http","ws");const r=new WebSocket(s.href);r.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},r.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=r,this.nextWatchId=0;try{for(const o of this.watches){r.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));const a=this.nextWatchId++;o.watchId=a,this.watchesById.set(a,o)}}catch{}},r.onmessage=o=>{let a,l;try{const c=JSON.parse(o.data);(0,f.Rf)(c);const d=(0,f.cQ)(c,"watch_id",f.bX),u=this.watchesById.get(d);if(u===void 0)return;l=u;const h=(0,f.cQ)(c,"state",f.zr);h==="invalid"||h==="error"?a=h:a=(0,f.cQ)(c,"info",UM)}catch(c){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,c);return}console.log("got update",a),l.callback(a)}})()}connect(e){const t=e.displayState.segmentationGroupState.value;return new $M(this,t)}trackSegment(e,t){return this.watchSegment(e,n=>{if(n==="invalid")t(null);else{if(n==="error")return;t(n.id)}})}watchSegment(e,t){const n={callback:t,segment:e,watchId:-1};this.watches.add(n);const{websocket:s}=this;if(s!==void 0)try{s.send(JSON.stringify({watch:{segment_id:e.toString()}}));const o=this.nextWatchId++;n.watchId=o,this.watchesById.set(o,n)}catch{}else this.startWebsocket();return()=>{const{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){const a=n.watchId;this.watchesById.delete(a);try{o.send(JSON.stringify({unwatch:{watch_id:a}}))}catch{}}this.watches.delete(n)}}async merge(e,t){const n=await zu(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return(0,f.Rf)(n),(0,f.cQ)(n,"merged",s=>P.R.parseString(s))}async split(e,t){const n=await zu(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return(0,f.Rf)(n),{include:(0,f.cQ)(n,"include",s=>P.R.parseString(s)),exclude:(0,f.cQ)(n,"exclude",s=>P.R.parseString(s))}}}function z0(i){const e=i.match(FM);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(i)}`);return{serverUrl:e[1],id:e[2]}}function $u(i,e,t,n,s=Je.fx){return(0,Ka.R)(i,`${e}${t}`,n,ke.cj,(r,o)=>{const a=new Headers(o.headers);return a.set("Authorization",r.token),{...o,headers:a}},r=>{const{status:o}=r;if(o===401)return"refresh";throw r},s)}function zM(i,e,t,n,s=Je.fx){return $u(W0(i,e),e,t,n,s)}class WM extends Nn{constructor(e,t,n){super(),this.parentCredentialsProvider=e,this.serverUrl=t,this.entityName=n,this.get=Xn(async()=>{const s=await $u(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:s.token,entityType:s.entity_type,role:s.role}})}}function W0(i,e){return i.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new BM(e))}function Gu(i,e,t){return i.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new WM(W0(i,e),e,t))}function zu(i,e,t,n,s,r=Je.fx){return $u(Gu(i,e,t),e,n,s,r)}function HM(i){return(0,f.Rf)(i),(0,f.cQ)(i,"entities",e=>(0,f.$v)(e,t=>{(0,f.Rf)(t);const n=(0,f.cQ)(t,"entity",f.zr),s=(0,f.cQ)(t,"entity_type",f.zr),r=(0,f.cQ)(t,"access_role",f.zr);return{id:n,entityType:s,accessRole:r}}))}class JM extends Jt{get description(){return"nggraph data source"}get(e){const{serverUrl:t,id:n}=z0(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:n},async()=>{const s=Gu(e.chunkManager,t,n),{entityType:r}=(await s.get()).credentials;if(r!=="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(r)}`);const{datasource_url:o}=await zu(e.chunkManager,t,n,"/graph/config",{method:"POST"}),a=await e.registry.get({...e,url:o}),l=new GM(e.chunkManager,t,n),c=[...a.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:l}}];return{modelTransform:a.modelTransform,subsources:c}})}async completeUrl(e){const{serverUrl:t,id:n}=z0(e.providerUrl),s=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>HM(await zM(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:Ht(n,s,r=>r.id,r=>`${r.entityType} (${r.accessRole})`)}}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("nggraph",()=>new JM);var H0=G(6435);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jM extends it(lt()(Kn),H0.C){}class YM extends ln{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.url=n,this.info=s}get dataType(){return this.info.dataType}get volumeType(){return St.UNKNOWN}get rank(){return this.info.rank}getSources(e){const{info:t}=this,n=De.DA(Float32Array,t.rank+1),s=xv({rank:t.rank,volumeType:St.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:n,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(jM,{credentialsProvider:this.credentialsProvider,spec:s,parameters:{url:this.url}}),chunkToMultiscaleTransform:n}]]}}function QM(i,e,t,n){return i.rpc.promiseInvoke(H0.Y,{chunkManager:i.addCounterpartRef(),credentialsProvider:Eu(i,e),url:t},n)}function KM(i,e,t){return i.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{const{url:n,credentialsProvider:s}=wn(t,e),r=await QM(i,s,n,Je.fx),o=new YM(i,s,n,r),a={lowerBounds:new Float64Array(r.rank),upperBounds:Float64Array.from(r.volumeSize)},l=Oe({rank:r.rank,names:r.sourceNames,scales:r.sourceScales,units:r.units,boundingBoxes:[En(a)]}),c=Oe({rank:r.rank,names:r.viewNames,scales:r.viewScales,units:r.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:xn(a)}}],modelTransform:{sourceRank:r.rank,rank:r.rank,inputSpace:l,outputSpace:c,transform:r.transform}}})}class qM extends Jt{get description(){return"Single NIfTI file"}get(e){return KM(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("nifti",()=>new qM);/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class XM extends Jt{get description(){return"Wavefront OBJ mesh file"}async get(e){const t=await IS(e.chunkManager,e.credentialsManager,e.url),n=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:wt(n),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("obj",()=>new XM);/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("precomputed",()=>new ZS);var ZM=G(8997);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const eN=new Set(["jpg","raw16"]),tN=it(Kn,ZM.vc);class nN extends tN{}const iN=new Set(["COMPLETE","READ_ONLY"]),sN=new Set(["LOADING"]);function rN(i){const e=(0,f.$v)(i,f.Rf);if(e.length<1)throw new Error("No stacks found for owner object.");const t=new Map,n=(0,f.cQ)(e[0],"stackId",aN);for(const s of e){const r=(0,f.cQ)(s,"stackId",oN),o=lN(s);if(o!==void 0){const a=o.project;let l=t.get(a);if(l===void 0){const c=new Map;t.set(a,{stacks:c}),l=t.get(a)}l.stacks.set(r,o)}}return{owner:n,projects:t}}function oN(i){return(0,f.Rf)(i),(0,f.cQ)(i,"stack",f.zr)}function aN(i){return(0,f.Rf)(i),(0,f.cQ)(i,"owner",f.zr)}function lN(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"state",f.zr);let t=[],n=C.eR.create(),s=C.eR.create();if(iN.has(e)){const a=(0,f.cQ)(i,"stats",f.Rf);n=dN(a),s=cN(a),Object.prototype.hasOwnProperty.call(a,"channelNames")&&(t=uN(a))}else if(!sN.has(e))return;const r=(0,f.cQ)(i,"currentVersion",hN),o=(0,f.cQ)(i,"stackId",pN);return{lowerVoxelBound:n,upperVoxelBound:s,voxelResolution:r,project:o,channels:t}}function cN(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"stackBounds",f.Rf),t=C.eR.create();return t[0]=(0,f.cQ)(e,"maxX",f._D)+1,t[1]=(0,f.cQ)(e,"maxY",f._D)+1,t[2]=(0,f.cQ)(e,"maxZ",f._D)+1,t}function dN(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"stackBounds",f.Rf),t=C.eR.create();return t[0]=(0,f.cQ)(e,"minX",f._D),t[1]=(0,f.cQ)(e,"minY",f._D),t[2]=(0,f.cQ)(e,"minZ",f._D),t}function uN(i){return(0,f.Rf)(i),(0,f.cQ)(i,"channelNames",e=>(0,f.$v)(e,f.zr))}function hN(i){(0,f.Rf)(i);const e=C.eR.create();try{e[0]=(0,f.cQ)(i,"stackResolutionX",f._D),e[1]=(0,f.cQ)(i,"stackResolutionY",f._D),e[2]=(0,f.cQ)(i,"stackResolutionZ",f._D)}catch{e[0]=1,e[1]=1,e[2]=1}return e}function pN(i){return(0,f.Rf)(i),(0,f.cQ)(i,"project",f.zr)}class fN extends ln{constructor(e,t,n,s,r,o,a){super(e),this.baseUrl=t,this.ownerInfo=n,this.project=r,this.parameters=a;const l=n.projects.get(r);if(l===void 0)throw new Error(`Specified project ${JSON.stringify(r)} does not exist for specified owner ${JSON.stringify(n.owner)}`);if(s===void 0){const h=Array.from(l.stacks.keys());if(h.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(h)}`);s=h[0]}const c=l.stacks.get(s);if(c===void 0)throw new Error(`Specified stack ${JSON.stringify(s)} is not one of the supported stacks: `+JSON.stringify(Array.from(l.stacks.keys())));this.stack=s,this.stackInfo=c,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=(0,f.zB)(a.minIntensity),this.maxIntensity=(0,f.zB)(a.maxIntensity),this.maxTileSpecsToRender=(0,f.zB)(a.maxTileSpecsToRender),this.filter=(0,f.uS)(a.filter),this.minX=(0,f.zB)(a.minX),this.minY=(0,f.zB)(a.minY),this.minZ=(0,f.zB)(a.minZ),this.maxX=(0,f.zB)(a.maxX),this.maxY=(0,f.zB)(a.maxY),this.maxZ=(0,f.zB)(a.maxZ),this.minX!==void 0&&(c.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(c.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(c.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(c.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(c.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(c.upperVoxelBound[2]=this.maxZ);let d=(0,f.z$)(a.encoding);if(d===void 0)d="jpg";else if(!eN.has(d))throw new Error(`Invalid encoding: ${JSON.stringify(d)}.`);this.encoding=d,this.numLevels=(0,f.zB)(a.numlevels),this.dims=C.eR.create();let u=(0,f.zB)(a.tilesize);u===void 0&&(u=1024),this.dims[0]=u,this.dims[1]=u,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?R.UINT16:R.UINT8}get volumeType(){return St.IMAGE}get rank(){return 3}getSources(e){const t=[];let n=this.numLevels;n===void 0&&(n=gN(this.stackInfo,this.dims[0]));const{lowerVoxelBound:s,upperVoxelBound:r}=this.stackInfo;for(let o=0;o<n;o++){const a=C.pB.create(),l=Uint32Array.of(1,1,1);for(let g=0;g<2;++g)a[5*g]=2**o,l[g]=this.dims[g];const c=C.eR.create(),d=C.eR.create(),u=C.eR.create(),h=C.eR.create();for(let g=0;g<3;g++){const v=a[5*g],y=u[g]=s[g]/v,S=h[g]=r[g]/v;c[g]=Math.floor(y),d[g]=Math.ceil(S)}const p=$d({rank:3,chunkDataSize:l,dataType:this.dataType,lowerVoxelBound:c,upperVoxelBound:d}),m=this.chunkManager.getChunkSource(nN,{spec:p,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:m,chunkToMultiscaleTransform:a,lowerClipBound:u,upperClipBound:h}])}return(0,F.RO)(t)}}function gN(i,e){let t=0;for(let s=0;s<2;s++)t=Math.max(t,i.upperVoxelBound[s]);if(e>=t)return 1;let n=0;for(;t>e;)t=t/2,n++;return n}function dl(i,e,t){return i.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>(0,ke.vd)(`${e}/render-ws/v1/owner/${t}/stacks`).then(n=>n.json()).then(rN))}const mN=/^([^/?]+)(?:\/([^/?]+))?(?:\/([^/?]+))(?:\/([^/?]*))?(?:\?(.*))?$/,J0=/^((?:(?:(?:http|https):\/\/[^,/]+)[^/?]))\/(.*)$/;function vN(i,e){let t,n;{const d=e.match(J0);if(d===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=d[1],n=d[2]}const s=n.match(mN);if(s===null)throw new Error(`Invalid volume path ${JSON.stringify(n)}`);const r=s[1],o=s[2],a=s[3],l=s[4],c=(0,f.bL)(s[5]||"");return i.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:n},async()=>{const d=await dl(i,t,r),u=new fN(i,t,d,a,o,l,c),h=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(u.stackInfo.voxelResolution,m=>m/1e9),boundingBoxes:[En({lowerBounds:new Float64Array(u.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(u.stackInfo.upperVoxelBound)})]});return{modelTransform:wt(h),subsources:[{id:"default",default:!0,subsource:{volume:u}},{id:"bounds",default:!0,subsource:{staticAnnotations:xn(h.bounds)}}]}})}async function yN(i,e,t){const n=t.match(/^(?:([^/]+)(?:\/([^/]*))?(?:\/([^/]*))?(\/.*?)?)?$/);if(n===null||n[2]===void 0)throw null;if(n[3]===void 0){const d=n[2]||"",u=await dl(i,e,n[1]),h=Ht(d,u.projects,p=>p[0]+"/",()=>{});return{offset:n[1].length+1,completions:h}}if(n[4]===void 0){const d=n[3]||"",h=(await dl(i,e,n[1])).projects.get(n[2]);if(h===void 0)throw null;const p=Ht(d,h.stacks,m=>m[0]+"/",m=>m[1].project);return{offset:n[1].length+n[2].length+2,completions:p}}const s=n[4].substr(1)||"",o=(await dl(i,e,n[1])).projects.get(n[2]);if(o===void 0)throw null;const a=o.stacks.get(n[3]);if(a===void 0)throw null;const l=a.channels;if(l.length===0)throw null;const c=Ht(s,l,d=>d,()=>{});return{offset:n[1].length+n[2].length+n[3].length+3,completions:c}}async function SN(i,e){const t=i.match(J0);if(t===null)throw null;const n=t[1],s=t[2],r=await yN(e,n,s);return yi(t[1].length+1,r)}class bN extends Jt{get description(){return"Render"}get(e){return vN(e.chunkManager,e.providerUrl)}completeUrl(e){return SN(e.providerUrl,e.chunkManager)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("render",()=>new bN);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class CN extends Jt{get description(){return"VTK mesh file"}async get(e){const t=await IS(e.chunkManager,e.credentialsManager,e.url),n=Oe({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:wt(n),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("vtk",()=>new CN);var _t=G(2334);/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wu(i,e,t){(0,f.Rf)(i);const n=(0,f.cQ)(i,"name",r=>e((0,f.zr)(r))),s=(0,f.cQ)(i,"configuration",r=>(r===void 0?r={}:(0,f.Rf)(r),t(r,n)));return{name:n,configuration:s}}/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wN(i){const{name:e,configuration:t}=Wu(i,n=>{const s=j0.get(n);if(s===void 0)throw new Error(`Unknown codec: ${JSON.stringify(n)}`);return s},n=>n);return{resolver:e,configuration:t}}const j0=new Map;function ss(i){j0.set(i.name,i)}function ul(i,e){const t=[],n=[],s=[],r=[];n.push(e);const o=(0,f.$v)(i,wN),a=o.length;let l=0;for(;l<a;++l){const{resolver:g,configuration:v}=o[l];if(g.kind!==_t.L.arrayToArray)break;const y=g,{configuration:S,encodedArrayInfo:w}=y.resolve(v,e);n.push(w),e=w,t.push({kind:_t.L.arrayToArray,name:g.name,configuration:S})}if(l===a||o[l].resolver.kind!==_t.L.arrayToBytes)throw new Error("Missing array -> bytes codec");const{codecSpec:c,layoutInfo:d,encodedSize:u,shardingInfo:h}=(()=>{const{resolver:g,configuration:v}=o[l],y=g,{configuration:S,shardingInfo:w,encodedSize:b}=y.resolve(v,e);if(w!==void 0&&l+1!==a)throw new Error("bytes -> bytes codecs not supported following sharding codec");const x=y.getDecodedArrayLayoutInfo(S,e);return{codecSpec:{name:g.name,kind:_t.L.arrayToBytes,configuration:S},layoutInfo:x,encodedSize:b,shardingInfo:w}})();s[l]=d,r.push(u);const p=u,m=[];for(++l;l<a;){const{resolver:g,configuration:v}=o[l];if(g.kind!==_t.L.bytesToBytes)throw new Error(`Expected bytes -> bytes codec, but received ${JSON.stringify(g.name)} of kind ${_t.L[g.kind]}`);const y=g,{configuration:S,encodedSize:w}=y.resolve(v,p);m.push({name:g.name,kind:g.kind,configuration:S}),r.push(w),++l}for(let g=t.length-1;g>=0;--g)s[g]=o[g].resolver.getDecodedArrayLayoutInfo(t[g].configuration,n[g],s[g+1]);return{[_t.L.arrayToArray]:t,[_t.L.arrayToBytes]:c,[_t.L.bytesToBytes]:m,arrayInfo:n,layoutInfo:s,shardingInfo:h,encodedSize:r}}/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ss({name:"blosc",kind:_t.L.bytesToBytes,resolve(i){return(0,f.Rf)(i),{configuration:{}}}});/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ss({name:"zstd",kind:_t.L.bytesToBytes,resolve(i){return(0,f.Rf)(i),{configuration:{}}}});var xN=G(6742);/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ss({name:"bytes",kind:_t.L.arrayToBytes,resolve(i,e){(0,f.Rf)(i);const t=(0,f.cQ)(i,"endian",s=>{switch(s){case"little":return U.LITTLE;case"big":return U.BIG;case void 0:if(B[e.dataType]===1)return te}throw new Error(`Invalid endian value: ${JSON.stringify(s)}`)}),n=e.chunkShape.reduce((s,r)=>s*r,1);return{configuration:{endian:t},encodedSize:B[e.dataType]*n}},getDecodedArrayLayoutInfo(i,e){return{physicalToLogicalDimension:Array.from(e.chunkShape,(t,n)=>n),readChunkShape:e.chunkShape}}});/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ss({name:"crc32c",kind:_t.L.bytesToBytes,resolve(i,e){let t;return e!==void 0&&(t=e+4),{configuration:{},encodedSize:t}}});/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ss({name:"gzip",kind:_t.L.bytesToBytes,resolve(i){return(0,f.Rf)(i),{configuration:{level:(0,f.cQ)(i,"level",f.bX)}}}});/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var hl=(i=>(i[i.DEFAULT=0]="DEFAULT",i[i.V2=1]="V2",i))(hl||{});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ei=new Map;ei.set("|u1",{endianness:U.LITTLE,dataType:R.UINT8}),ei.set("|i1",{endianness:U.LITTLE,dataType:R.INT8});for(const[i,e]of[["<",U.LITTLE],[">",U.BIG]]){for(const t of["u","i"])ei.set(`${i}${t}8`,{endianness:e,dataType:R.UINT64});ei.set(`${i}u2`,{endianness:e,dataType:R.UINT16}),ei.set(`${i}i2`,{endianness:e,dataType:R.INT16}),ei.set(`${i}u4`,{endianness:e,dataType:R.UINT32}),ei.set(`${i}i4`,{endianness:e,dataType:R.INT32}),ei.set(`${i}f4`,{endianness:e,dataType:R.FLOAT32})}function EN(i){const e=ei.get(i);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(i)}`);return e}/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Y0(i){return(0,f.$v)(i,e=>{if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(e)}`);return e})}function Hu(i,e){return(0,f.Xu)(new Array(e),i,t=>{if(typeof t!="number"||!Number.isInteger(t)||t<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(t)}`);return t})}function Ju(i){if(i!=="."&&i!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(i)}`);return i}const ju=new Map([["",{unit:"",scale:1}],["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:60*60}],["day",{unit:"s",scale:60*60*24}]]);for(const i of["meter","second"])for(const e of Bl){const{longPrefix:t,prefix:n}=e;if(t===void 0)continue;const s={unit:i[0],scale:10**e.exponent};ju.set(`${t}${i}`,s),ju.set(`${n}${i[0]}`,s)}function TN(i){if(i===null)return{scale:1,unit:""};if(typeof i!="string")throw new Error(`Expected string but received: ${JSON.stringify(i)}`);const e=i.trim(),t=/^([-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)(?:[eE][-+]?\d+)?)\s*(.*)/,n=e.match(t);let s,r;n===null?(s=1,r=e):(s=Number(n[1]),r=n[2]);const o=ju.get(r);if(o===void 0)throw new Error(`Unsupported unit: ${JSON.stringify(r)}`);return{unit:o.unit,scale:s*o.scale}}function Q0(i,e){switch(i){case R.UINT8:case R.INT8:case R.UINT16:case R.INT16:case R.UINT32:case R.INT32:case R.UINT64:if(typeof e!="number"||!Number.isInteger(e))throw new Error(`Expected integer but received: ${JSON.stringify(e)}`);return e;case R.FLOAT32:if(typeof e=="number")return e;if(typeof e=="string"){if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e==="NaN")return new Float32Array(Uint32Array.of(2143289344).buffer)[0];if(e.match(/^0x[a-fA-F0-9]+$/))return new Float32Array(Uint32Array.of(Number(e)).buffer)[0]}throw new Error(`Expected number, "Infinity", "-Infinity", "NaN", or hex string but received: ${JSON.stringify(e)}`)}}function DN(i,e){try{(0,f.Rf)(i),(0,f.cQ)(i,"zarr_format",m=>{(0,f.qi)(m,3)});const t=(0,f.cQ)(i,"node_type",m=>{if(e!==void 0&&(0,f.qi)(m,e),m!=="array"&&m!=="group")throw new Error(`Expected "array" or "group" but received: ${JSON.stringify(m)}`);return m});if(e=t,t==="group")return{zarrVersion:3,nodeType:"group",userAttributes:(0,f.MM)(i,"attributes",f.Rf,{})};const n=(0,f.cQ)(i,"shape",Y0),s=n.length,r=(0,f.cQ)(i,"dimension_names",m=>(0,f.ZD)(m??void 0,s)),o=(0,f.cQ)(i,"data_type",m=>(0,f.sl)(m,R,/^[a-z0-9]+$/)),{configuration:a}=(0,f.cQ)(i,"chunk_grid",m=>Wu(m,g=>(0,f.qi)(g,"regular"),g=>(0,f.cQ)(g,"chunk_shape",v=>Hu(v,s)))),{userAttributes:l,dimensionUnits:c}=(0,f.cQ)(i,"attributes",m=>{m===void 0&&(m={}),(0,f.Rf)(m);const g=(0,f.cQ)(m,"dimension_units",v=>(0,f.ZD)(v,s));return{userAttributes:m,dimensionUnits:g}}),{configuration:d,name:u}=(0,f.cQ)(i,"chunk_key_encoding",m=>Wu(m,g=>(0,f.sl)(g,hl,/^(v2|default)$/),(g,v)=>(0,f.MM)(g,"separator",Ju,v===hl.DEFAULT?"/":"."))),h=(0,f.cQ)(i,"fill_value",m=>Q0(o,m)),p=(0,f.cQ)(i,"codecs",m=>ul(m,{dataType:o,chunkShape:a}));return{zarrVersion:3,nodeType:t,rank:s,shape:n,chunkShape:a,dataType:o,fillValue:h,dimensionNames:r,dimensionUnits:c,chunkKeyEncoding:u,dimensionSeparator:d,userAttributes:l,codecs:p}}catch(t){const n=e===void 0?"":`${e} `;throw new Error(`Error parsing zarr v3 ${n}metadata: ${t.message}`)}}function IN(i,e,t){try{(0,f.Rf)(i),(0,f.cQ)(i,"zarr_format",p=>{(0,f.qi)(p,2)});const n=(0,f.cQ)(i,"shape",Y0),s=n.length,r=(0,f.cQ)(i,"chunks",p=>Hu(p,s)),o=(0,f.cQ)(i,"order",p=>{if(p!=="C"&&p!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(p)}`);return p}),a=(0,f.MM)(i,"dimension_separator",t===void 0?Ju:p=>(0,f.qi)(p,t),t??"."),l=(0,f.cQ)(i,"dtype",p=>EN((0,f.zr)(p))),c=l.dataType,d=(0,f.cQ)(i,"fill_value",p=>p===null?0:Q0(c,p)),u=[];o==="F"&&u.push({name:"transpose",configuration:{order:Array.from(n,(p,m)=>s-m-1)}}),u.push({name:"bytes",configuration:{endian:l.endianness===U.LITTLE?"little":"big"}}),(0,f.cQ)(i,"compressor",p=>{if(p===null)return;(0,f.Rf)(p);const m=(0,f.cQ)(p,"id",f.zr);switch(m){case"blosc":u.push({name:"blosc",configuration:{cname:(0,f.cQ)(p,"cname",f.zr),clevel:(0,f.cQ)(p,"clevel",f.bX),typesize:B[c],shuffle:(0,f.cQ)(p,"shuffle",g=>{switch(g){case-1:return B[c]===1?"bitshuffle":"shuffle";case 0:return"noshuffle";case 1:return"shuffle";case 2:return"bitshuffle"}throw new Error(`Invalid value: ${JSON.stringify(g)}`)}),blocksize:(0,f.MM)(p,"blocksize",f.bX,0)}});break;case"zlib":case"gzip":u.push({name:"gzip",configuration:{level:(0,f.cQ)(p,"level",f.bX)}});break;case"zstd":u.push({name:"zstd",configuration:{level:(0,f.cQ)(p,"level",f.bX)}});break;default:throw new Error(`Unsupported compressor: ${JSON.stringify(m)}`)}});const h=ul(u,{dataType:c,chunkShape:r});return{zarrVersion:2,nodeType:"array",rank:s,shape:n,chunkShape:r,dataType:c,fillValue:d,dimensionNames:(0,f.cQ)(e,"_ARRAY_DIMENSIONS",p=>(0,f.ZD)(p,s)),dimensionUnits:(0,f.cQ)(e,"dimension_units",p=>(0,f.ZD)(p,s)),userAttributes:e,dimensionSeparator:a,chunkKeyEncoding:hl.V2,codecs:h}}catch(n){throw new Error(`Error parsing zarr v2 metadata: ${n.message}`)}}/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var K0=(i=>(i[i.START=0]="START",i[i.END=1]="END",i))(K0||{});ss({name:"sharding_indexed",kind:_t.L.arrayToBytes,resolve(i,e){(0,f.Rf)(i);const t=(0,f.cQ)(i,"chunk_shape",l=>Hu(l,e.chunkShape.length)),n=(0,f.MM)(i,"index_location",l=>(0,f.sl)(l,K0,/^[a-z]+$/),1),s=Array.from(e.chunkShape,(l,c)=>{const d=t[c];if(l%d!==0)throw new Error(`sub-chunk shape of ${JSON.stringify(d)} does not evenly divide outer chunk shape of ${JSON.stringify(e.chunkShape)}`);return l/d}),r=Array.from(s);r.push(2);const o=(0,f.cQ)(i,"index_codecs",l=>ul(l,{dataType:R.UINT64,chunkShape:r}));if(o.encodedSize[o.encodedSize.length-1]===void 0)throw new Error("index_codecs must specify fixed-size encoding");const a=(0,f.cQ)(i,"codecs",l=>ul(l,{dataType:e.dataType,chunkShape:t}));return{configuration:{indexCodecs:o,subChunkCodecs:a,subChunkShape:t,subChunkGridShape:s,indexLocation:n},shardingInfo:{subChunkShape:t,subChunkGridShape:s,subChunkCodecs:a}}},getDecodedArrayLayoutInfo(i,e){return i.subChunkCodecs.layoutInfo[0]}});/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ss({name:"transpose",kind:_t.L.arrayToArray,resolve(i,e){(0,f.Rf)(i);const{order:t,inverseOrder:n}=(0,f.cQ)(i,"order",r=>{const o=e.chunkShape.length,a=new Array(o),l=new Array(o);if(r==="C")for(let c=0;c<o;++c)a[c]=c,l[c]=c;else if(r==="F")for(let c=0;c<o;++c)a[c]=o-c-1,l[c]=o-c-1;else(0,f.Xu)(a,r,(c,d)=>{if(typeof c!="number"||!Number.isInteger(c)||c<0||c>=o)throw new Error(`Expected integer in range [0, ${o}) but received: ${JSON.stringify(c)}`);if(l[c]!==void 0)throw new Error(`Invalid permutation: ${JSON.stringify(r)}`);return l[c]=d,c});return{order:a,inverseOrder:l}}),s={dataType:e.dataType,chunkShape:Array.from(t,r=>e.chunkShape[r])};return{configuration:{encodedToDecoded:t,decodedToEncoded:n},encodedArrayInfo:s}},getDecodedArrayLayoutInfo(i,e,t){return{physicalToLogicalDimension:Array.from(t.physicalToLogicalDimension,s=>i.encodedToDecoded[s]),readChunkShape:Array.from(i.decodedToEncoded,s=>t.readChunkShape[s])}}});/**
 * @license
 * Copyright 2022 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const LN=new Set(["0.4","0.5-dev"]),q0=new Map([["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:60*60}],["day",{unit:"s",scale:60*60*24}]]);for(const i of["meter","second"])for(const e of Bl){const{longPrefix:t}=e;t!==void 0&&q0.set(`${t}${i}`,{unit:i[0],scale:10**e.exponent})}function RN(i){(0,f.Rf)(i);const e=(0,f.cQ)(i,"name",f.zr),t=(0,f.MM)(i,"type",f.zr),n=(0,f.MM)(i,"unit",s=>{const r=q0.get(s);if(r===void 0)throw new Error(`Unsupported unit: ${JSON.stringify(s)}`);return r},{unit:"",scale:1});return{name:e,unit:n.unit,scale:n.scale,type:t}}function kN(i){const e=(0,f.$v)(i,RN);return Oe({names:e.map(t=>{const{name:n,type:s}=t;return s==="channel"?`${n}'`:n}),scales:Float64Array.from(e,t=>t.scale),units:e.map(t=>t.unit)})}function PN(i,e){const t=(0,f.cQ)(e,"scale",n=>(0,f.Xu)(new Float64Array(i),n,f.Mo));return De.nx(Float64Array,t)}function AN(i,e){return De.DA(Float64Array,i+1)}function MN(i,e){const t=(0,f.cQ)(e,"translation",n=>(0,f.Xu)(new Float64Array(i),n,f.zo));return De.u6(Float64Array,t)}const NN=new Map([["scale",PN],["identity",AN],["translation",MN]]);function ON(i,e){(0,f.Rf)(e);const t=(0,f.cQ)(e,"type",f.zr),n=NN.get(t);if(n===void 0)throw new Error(`Unsupported coordinate transform type: ${JSON.stringify(t)}`);return n(i,e)}function X0(i,e){let t=De.DA(Float64Array,i+1);return e===void 0||(0,f.$v)(e,n=>{const s=ON(i,n);t=De.lw(new Float64Array(t.length),i+1,s,i+1,t,i+1,i+1,i+1,i+1)}),t}function _N(i,e,t){const n=(0,f.cQ)(t,"path",f.zr),s=(0,f.cQ)(t,"coordinateTransformations",o=>X0(i,o));return{url:`${e}/${n}`,transform:s}}function VN(i,e){const t=(0,f.cQ)(e,"axes",kN),n=t.rank,s=(0,f.cQ)(e,"coordinateTransformations",l=>X0(n,l)),r=(0,f.cQ)(e,"datasets",l=>(0,f.$v)(l,c=>{const d=_N(n,i,c);return d.transform=De.lw(new Float64Array((n+1)**2),n+1,s,n+1,d.transform,n+1,n+1,n+1,n+1),d}));if(r.length===0)throw new Error("At least one scale must be specified");const o=r[0].transform,a=new Float64Array(n);for(let l=0;l<n;++l){const c=a[l]=o[l*(n+1)+l];t.scales[l]*=c}for(const l of r){const c=l.transform;for(let d=0;d<n;++d){let u=0;for(let h=0;h<n;++h)u+=c[h*(n+1)+d]*.5;c[n*(n+1)+d]-=u}for(let d=0;d<n;++d)for(let u=0;u<=n;++u)c[u*(n+1)+d]/=a[d]}return{coordinateSpace:t,scales:r}}function BN(i,e){const t=e.multiscales;if(!Array.isArray(t))return;const n=[];for(const s of t){if(typeof s!="object"||s==null||Array.isArray(s))return;const r=s.version;if(r===void 0)return;if(!LN.has(r)){n.push(`OME multiscale metadata version ${JSON.stringify(r)} is not supported`);continue}return VN(i,s)}if(n.length!==0)throw new Error(n[0])}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class FN extends it(lt()(Kn),xN.j){}class UN extends ln{constructor(e,t,n){super(e),this.credentialsProvider=t,this.multiscale=n,this.volumeType=St.IMAGE}get dataType(){return this.multiscale.dataType}get modelSpace(){return this.multiscale.coordinateSpace}get rank(){return this.multiscale.coordinateSpace.rank}getSources(e){return(0,F.RO)(this.multiscale.scales.map(t=>{const{metadata:n}=t,{rank:s,codecs:r,shape:o}=n,a=r.layoutInfo[0].readChunkShape,{physicalToLogicalDimension:l}=n.codecs.layoutInfo[0],c=new Uint32Array(s),d=new Float32Array(s),u=new Float32Array((s+1)**2);u[(s+1)**2-1]=1;for(let p=0;p<s;++p){const m=l[s-1-p];c[p]=a[m],d[p]=o[m],u[p+m*(s+1)]=1}const h=new Float32Array((s+1)**2);return De.lw(h,s+1,t.transform,s+1,u,s+1,s+1,s+1,s+1),qi({rank:s,chunkToMultiscaleTransform:h,dataType:n.dataType,upperVoxelBound:d,volumeType:this.volumeType,chunkDataSizes:[c],volumeSourceOptions:e,fillValue:n.fillValue}).map(p=>({chunkSource:this.chunkManager.getChunkSource(FN,{credentialsProvider:this.credentialsProvider,spec:p,parameters:{url:t.url,metadata:n}}),chunkToMultiscaleTransform:h}))}))}}function Yu(i,e,t){return i.memoize.getUncounted({type:"zarr:json",url:t,credentialsProvider:xt(e)},async()=>{try{return await Nt(e,t,{},ke.cj)}catch(n){if((0,ke.El)(n))return;throw n}})}const $N=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];function GN(i,e){const t=new Set,n=e===2?"d":"dim_";return i.map((s,r)=>{if(s===null){let a=r;for(;;){if(s=`${n}${a}`,!t.has(s))return t.add(s),s;++a}}if(!t.has(s))return t.add(s),s;let o=1;for(;;){const a=`${s}${o}`;if(!t.has(a))return t.add(a),a;++o}})}function zN(i,e){const t=GN(e.dimensionNames,e.zarrVersion),n=e.dimensionUnits.map(TN),s=Oe({names:t,scales:Float64Array.from(Array.from(n,o=>o.scale)),units:Array.from(n,o=>o.unit),boundingBoxes:[En({lowerBounds:new Float64Array(e.rank),upperBounds:Float64Array.from(e.shape)})]}),r=De.DA(Float64Array,e.rank+1);return{coordinateSpace:s,dataType:e.dataType,scales:[{url:i,transform:r,metadata:e}]}}async function WN(i,e,t,n){const s=await Promise.all(t.scales.map(async g=>{const v=await pl(i,e,g.url,{zarrVersion:n.zarrVersion,expectedNodeType:"array",explicitDimensionSeparator:n.explicitDimensionSeparator});if(v===void 0)throw new Error(`zarr v{zarrVersion} array metadata not found at ${g.url}`);return v})),r=s[0].dataType,o=s.length,a=t.coordinateSpace.rank;for(let g=0;g<o;++g){const v=t.scales[g],y=s[g];if(y.rank!==a)throw new Error(`Expected zarr array at ${JSON.stringify(v.url)} to have rank ${a}, but received: ${y.rank}`);if(y.dataType!==r)throw new Error(`Expected zarr array at ${JSON.stringify(v.url)} to have data type ${R[r]}, but received: ${R[y.dataType]}`)}const l=new Float64Array(a),c=new Float64Array(a),d=t.scales[0],u=s[0];for(let g=0;g<a;++g){const v=l[g]=d.transform[(a+1)*a+g];c[g]=v+u.shape[g]}const h=En({lowerBounds:l,upperBounds:c}),{coordinateSpace:p}=t;return{coordinateSpace:Oe({names:p.names,units:p.units,scales:p.scales,boundingBoxes:[h]}),dataType:r,scales:t.scales.map((g,v)=>{const y=s[v];return{url:g.url,transform:g.transform,metadata:y}})}}async function pl(i,e,t,n){if(n.zarrVersion===2){const[o,a]=await Promise.all([Yu(i,e,`${t}/.zarray`),Yu(i,e,`${t}/.zattrs`)]);return o===void 0?a===void 0||n.expectedNodeType==="array"?void 0:{zarrVersion:2,nodeType:"group",userAttributes:(0,f.Rf)(a)}:n.expectedNodeType==="group"?void 0:IN(o,a??{},n.explicitDimensionSeparator)}if(n.zarrVersion===3){const o=await Yu(i,e,`${t}/zarr.json`);if(o===void 0)return;if(n.explicitDimensionSeparator!==void 0)throw new Error("dimension_separator query parameter not supported for zarr v3");return DN(o,n.expectedNodeType)}const[s,r]=await Promise.all([pl(i,e,t,{...n,zarrVersion:2}),pl(i,e,t,{...n,zarrVersion:3})]);if(s!==void 0&&r!==void 0)throw new Error("Both zarr v2 and v3 metadata found");return s??r}class Qu extends Jt{constructor(e=void 0){super(),this.zarrVersion=e}get description(){return`Zarr${this.zarrVersion===void 0?"":` v${this.zarrVersion}`} data source`}get(e){let[,t,n]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);const s=(0,f.bL)(n||"");(0,f.Rf)(s);const r=(0,f.MM)(s,"dimension_separator",Ju);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:r},async()=>{const{url:o,credentialsProvider:a}=wn(t,e.credentialsManager),l=await pl(e.chunkManager,a,o,{zarrVersion:this.zarrVersion,explicitDimensionSeparator:r});if(l===void 0)throw new Error("No zarr metadata found");let c;if(l.nodeType==="group"){const u=BN(o,l.userAttributes);if(u===void 0)throw new Error("Neithre array nor OME multiscale metadata found");c=await WN(e.chunkManager,a,u,{zarrVersion:l.zarrVersion,explicitDimensionSeparator:r})}else c=zN(o,l);const d=new UN(e.chunkManager,a,c);return{modelTransform:wt(d.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:d}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:xn(d.modelSpace.bounds)}}]}})}async completeUrl(e){const[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?yi(e.providerUrl.length-t.length,await vg(t,$N)):await ts(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ot("zarr",()=>new Qu),Ot("zarr2",()=>new Qu(2)),Ot("zarr3",()=>new Qu(3));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function HN(i){i.registerEventListener(document,"copy",e=>{if(xc(e.target))return;const t=document.getSelection();if(t!==null&&t.type==="Range")return;const n=Lo(i.state).value,{clipboardData:s}=e;s!==null&&s.setData("text/plain",JSON.stringify(n,void 0,"  ")),e.preventDefault()})}function JN(i,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let r=0;r<e;++r)r!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;const n=i.match(t);if(n===null)return;const s=new Float32Array(e);for(let r=0;r<e;++r){const o=Number(n[r+1]);if(!Number.isFinite(o))return;s[r]=o}return s}function jN(i){i.registerEventListener(document,"paste",e=>{if(xc(e.target))return;const{clipboardData:t}=e;if(t!==null){const n=t.getData("text/plain"),s=JN(n,i.coordinateSpace.value.rank);s!==void 0&&(i.navigationState.position.value=s)}e.preventDefault()})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function YN(){return(0,T.K6)(document,"contextmenu",i=>{i.preventDefault()})}function QN(){return(0,T.K6)(document,"wheel",i=>{i.ctrlKey&&i.preventDefault()},{passive:!1})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Z0=Symbol("SingleTextureVolumeChunk.textureUnit"),fl=Symbol("SingleTextureVolumeChunk.textureLayout");class eb extends T.O8{constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",Z0)}beginDrawing(e,t){const n=t.textureUnit(Z0);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),t[fl]=null}endDrawing(e,t){e.bindTexture(cr[this.shaderSamplerType],null),t[fl]=null}bindChunk(e,t,n,s,r,o,a){const l=n.textureLayout;(t[fl]!==l||a)&&(t[fl]=l,this.setupTextureLayout(e,t,l,s,r,o)),e.bindTexture(cr[this.shaderSamplerType],n.texture)}beginSource(e,t){}}class tb extends zI{constructor(e,t){super(e,t),this.texture=null,this.data=t.data}copyToGPU(e){if(super.copyToGPU(e),this.data===null)return;const t=this.texture=e.createTexture(),n=cr[this.chunkFormat.shaderSamplerType];e.bindTexture(n,t),this.setTextureData(e),e.bindTexture(n,null)}freeGPUMemory(e){super.freeGPUMemory(e),this.data!==null&&(e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gl extends T.O8{constructor(e,t,n){super(),this.chunkDataSize=t,this.textureDims=n,this.textureShape=new Uint32Array(this.textureDims);const s=t.length;let r=0;for(const u of t)u!==1&&++r;const o=this.strides=new Uint32Array(s*n),a=n===3?e.max3dTextureSize:e.maxTextureSize;let l=0,c=1;const{textureShape:d}=this;d.fill(1);for(let u=0;u<s;++u){const h=t[u];if(h===1)continue;const p=h*c;let m;p>a||c!==1&&l+r<n?(++l,c=h,m=1):(m=c,c=p),o[n*u+l]=m,d[l]=c}}static get(e,t,n){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${n}`,()=>new gl(e,t,n))}}let Ku=new Uint32Array(3*5);class qu extends eb{constructor(e,t,n,s){super(n,t),this.textureDims=s,Wi(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${s}D`,this.textureAccessHelper=new wD("chunkData",s)}static get(e,t,n){const s=`sliceview.UncompressedChunkFormat:${t}:${n}`;return e.memoize.get(s,()=>new qu(e,t,s,n))}defineShader(e,t,n=!1){super.defineShader(e,t);const{textureDims:s}=this,r=`ivec${this.textureDims}`,{textureAccessHelper:o}=this,a=(4+t)*s;Ku.length<a&&(Ku=new Uint32Array(a)),e.addUniform(`highp ${r}`,"uVolumeChunkStrides",4+t);const l=o.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType);let d=`
${yt(this.dataType)} getDataValueAt(highp ivec3 p`;for(let u=0;u<t;++u)d+=`, highp int channelIndex${u}`;d+=`) {
  highp ${r} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let u=0;u<t;++u)d+=`
  offset += channelIndex${u} * uVolumeChunkStrides[${4+u}];
`;d+=`
  return readVolumeData(offset);
}
`,n?(e.addVertexCode(l),e.addVertexCode(d)):(e.addFragmentCode(l),e.addFragmentCode(d))}setupTextureLayout(e,t,n,s,r,o){const a=Ku,l=o.length,{strides:c}=n,d=s.length,{textureDims:u}=this;for(let p=0;p<u;++p){let m=0;for(let g=0;g<d;++g)m+=s[g]*c[g*u+p];a[p]=m}for(let p=0;p<3;++p){const m=r[p];if(!(m>=d))for(let g=0;g<u;++g)a[(p+1)*u+g]=c[m*u+g]}for(let p=0;p<l;++p){const m=o[p];if(m===-1)a.fill(0,(4+p)*u,(4+p+1)*u);else for(let g=0;g<u;++g)a[(4+p)*u+g]=c[m*u+g]}const h=(4+l)*u;u===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),a,0,h):e.uniform2iv(t.uniform("uVolumeChunkStrides"),a,0,h)}getTextureLayout(e,t){return gl.get(e,t,this.textureDims)}setTextureData(e,t,n){const{textureShape:s}=t;(this.textureDims===3?bD:SD)(e,this,n,s[0],s[1],s[2])}}class KN extends tb{setTextureData(e){const{source:t}=this,{chunkFormatHandler:n}=t,{chunkFormat:s}=n;let r;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=r=n.textureLayout.addRef():this.textureLayout=r=s.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,r,this.data)}getValueAt(e){const{data:t}=this;if(t===null)return this.source.spec.fillValue;const{chunkFormat:n}=this,{chunkDataSize:s}=this;let r=0,o=1;const a=e.length;for(let c=0;c<a;++c)r+=o*e[c],o*=s[c];switch(n.dataType){case R.UINT8:case R.INT8:case R.FLOAT32:case R.UINT16:case R.INT16:case R.UINT32:case R.INT32:return t[r];case R.UINT64:{const c=r*2;return new P.R(t[c],t[c+1])}}}}class qN extends T.O8{}function XN(i,e){const t=new J[i]($[i]);return i===R.UINT64?(t[0]=e.low,t[1]=e.high):t[0]=e,t}function ZN(i,e,t,n,s){const{dataType:r}=e,o=XN(r,t),a=new Uint32Array(n);a.fill(1);const l=new gl(i,a,s);l.strides.fill(0);const c=i.createTexture(),d=cr[e.shaderSamplerType];i.bindTexture(d,c),e.setTextureData(i,l,o),i.bindTexture(d,null);const u=new qN;return u.textureLayout=l,u.texture=c,u}class eO extends T.O8{constructor(e,t){super();let n=0;for(const r of t.chunkDataSize)r>1&&++n;const s=n>=3?3:2;this.chunkFormat=this.registerDisposer(qu.get(e,t.dataType,s)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.UncompressedChunkFormat.fillValue:${t.chunkDataSize.length}:${t.dataType}:${t.fillValue}:${s}`,()=>ZN(e,this.chunkFormat,t.fillValue,t.chunkDataSize.length,s)))}getChunk(e,t){const n=new KN(e,t);return n.data===null&&(n.texture=this.fillValueChunk.texture,n.textureLayout=this.fillValueChunk.textureLayout),n}}Dv((i,e)=>e.compressedSegmentationBlockSize==null?new eO(i,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function nb(i,e,t,n,s,r){let o=0,a=0,l=1,c=1;for(let g=0;g<3;++g){const v=s[g],y=n[g],S=Math.floor(v/y),w=v%y;o+=S*l,l*=Math.ceil(t[g]/y),a+=w*c,c*=y}const d=e+o*2,u=i[d],h=i[d+1];let p=u&16777215;const m=u>>24&255;if(m>0){const v=(e+h&16777215)+Math.floor(a*m/32),y=i[v],S=a*m%32,w=y>>S&(1<<m)-1;p+=r*w}return p}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ib(i,e,t,n,s){const r=nb(i,e,t,n,s,1)+e;return i[r]}function g2(i,e,t,n,s){return ib(i,e+i[s[3]],t,n,s)}function tO(i,e,t,n,s){const r=n[0]*n[1]*n[2]*1;if(r!==i.length)throw new Error(`Output length ${i.length} is not equal to expected length ${r}.`);const o=n[0],a=n[1],l=n[2],c=[0,0,0];let d=0;for(let u=0;u<l;++u){c[2]=u;for(let h=0;h<a;++h){c[1]=h;for(let p=0;p<o;++p){c[0]=p;const m=decodeValueOffset(e,t,n,s,c,1)+t;i[d++]=e[m]}}}return i}function m2(i,e,t,n,s){const r=n[0]*n[1]*n[2]*1,o=r*n[3];if(o!==i.length)throw new Error(`Output length ${i.length} is not equal to expected length ${o}.`);const a=n[3];for(let l=0;l<a;++l)tO(i.subarray(r*l,r*(l+1)),e,t+e[l],n,s);return i}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sb(i,e,t,n,s,r){const o=nb(e,t,n,s,r,2)+t;return i.low=e[o],i.high=e[o+1],i}function v2(i,e,t,n,s,r){return sb(i,e,t+e[r[3]],n,s,r)}function nO(i,e,t,n,s){const r=n[0]*n[1]*n[2]*2;if(r!==i.length)throw new Error(`Output length ${i.length} is not equal to expected length ${r}.`);const o=n[0],a=n[1],l=n[2],c=[0,0,0];let d=0;for(let u=0;u<l;++u){c[2]=u;for(let h=0;h<a;++h){c[1]=h;for(let p=0;p<o;++p){c[0]=p;const m=decodeValueOffset(e,t,n,s,c,2)+t;i[d++]=e[m],i[d++]=e[m+1]}}}return i}function y2(i,e,t,n,s){const r=n[0]*n[1]*n[2]*2,o=r*n[3];if(o!==i.length)throw new Error(`Output length ${i.length} is not equal to expected length ${o}.`);const a=n[3];for(let l=0;l<a;++l)nO(i.subarray(r*l,r*(l+1)),e,t+e[l],n,s);return i}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ml extends T.O8{constructor(e,t){super();const n=this.subchunkGridSize=C.eR.create();for(let s=0;s<3;++s)n[s]=Math.ceil(e[s]/t[s]);this.singleton=!1}static get(e,t,n){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${(0,C.nL)(t)},${(0,C.nL)(n)}`,()=>new ml(t,n))}}const iO=Wi(new Ns,R.UINT32);let Xu=new Uint32Array(4*4);class Zu extends eb{constructor(e,t,n,s){super(s,e),this.subchunkSize=t,this.numChannels=n,this.textureAccessHelper=new xa("chunkData")}static get(e,t,n,s){const r=`sliceview.CompressedSegmentationChunkFormat:${t}:${s}`,o=`${r}:${(0,C.nL)(n)}`;return e.memoize.get(o,()=>new Zu(t,n,s,r))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);const n=4*(4+t);Xu.length<n&&(Xu=new Uint32Array(n));const{textureAccessHelper:s}=this;s.defineShader(e);const r=c=>"compressedSegmentationChunkFormat_"+c;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(kw);const{dataType:o}=this,a=yt(o);o===R.UINT64?e.addFragmentCode(gt):e.addFragmentCode(To),e.addFragmentCode(s.getAccessor(r("readTextureValue"),"uVolumeChunkSampler",R.UINT32,1));let l=`
uint ${r("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${r("readTextureValue")}(uint(channelIndex)).value;
}
${a} getDataValueAt(highp ivec3 p`;for(let c=0;c<t;++c)l+=`, highp int channelIndex${c}`;l+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let c=0;c<t;++c)l+=`
  chunkPositionFull += channelIndex${c} * uVolumeChunkStrides[${4+c}];
`;l+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${r("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${r("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${r("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${r("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===R.UINT64?"2u":"1u"};
  }
  ${a} result;
`,o===R.UINT64?l+=`
  result.value[0] = ${r("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${r("readTextureValue")}(outputValueOffset+1u).value;
`:l+=`
  result.value = ${r("readTextureValue")}(outputValueOffset).value;
`,l+=`
  return result;
}
`,e.addFragmentCode(l)}setupTextureLayout(e,t,n,s,r,o){const{subchunkGridSize:a}=n;e.uniform3i(t.uniform("uSubchunkGridSize"),a[0],a[1],a[2]);const l=Xu,c=o.length;if(l.fill(0),!n.singleton){for(let d=0;d<3;++d){l[d]=s[d];const u=r[d];u!==-1&&(l[4*(d+1)+u]=1)}for(let d=0;d<c;++d){const u=o[d];u!==-1&&(l[4*(4+d)+u]=1)}}e.uniform4iv(t.uniform("uVolumeChunkStrides"),l,0,(c+4)*4)}setTextureData(e,t,n){wa(e,iO,n)}getTextureLayout(e,t){return ml.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);const{subchunkSize:n}=this;e.uniform3i(t.uniform("uSubchunkSize"),n[0],n[1],n[2])}}class sO extends tb{setTextureData(e){const{data:t}=this,{chunkFormat:n}=this,s=this.textureLayout=n.getTextureLayout(e,this.chunkDataSize);n.setTextureData(e,s,t)}getValueAt(e){const{chunkDataSize:t,chunkFormat:n}=this,{data:s}=this;if(s===null)return this.source.spec.fillValue;const r=s[e[3]||0];if(n.dataType===R.UINT64){const o=new P.R;return sb(o,s,r,t,n.subchunkSize,e),o}return ib(s,r,t,n.subchunkSize,e)}}class rO extends T.O8{}function oO(i,e,t){const{dataType:n,numChannels:s}=e,r=new Uint32Array(s+2+(n===R.UINT64?2:1));r[0]=s,r[s]=2,n===R.UINT64?(r[s+2]=t.low,r[s+3]=t.high):r[s+2]=t;const o=new ml(Uint32Array.of(1,1,1),C.eR.fromValues(1,1,1));o.singleton=!0;const a=i.createTexture(),l=cr[e.shaderSamplerType];i.bindTexture(l,a),e.setTextureData(i,o,r),i.bindTexture(l,null);const c=new rO;return c.textureLayout=o,c.texture=a,c}class aO extends T.O8{constructor(e,t){super();const{dataType:n}=t;if(n!==R.UINT64&&n!==R.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${R[n]}`);this.chunkFormat=this.registerDisposer(Zu.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.CompressedSegmentationChunkFormat.fillValue:${t.dataType}:${t.fillValue}:${this.chunkFormat.numChannels}`,()=>oO(e,this.chunkFormat,t.fillValue)))}getChunk(e,t){const n=new sO(e,t);return n.data===null&&(n.texture=this.fillValueChunk.texture,n.textureLayout=this.fillValueChunk.textureLayout),n}}Dv((i,e)=>e.compressedSegmentationBlockSize!=null?new aO(i,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var rb=G(9783),lO=G(8085),cO=G(2027),dO=G(6984);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function dn(i,e){return t=>{t.style.flex=i,e(t)}}function S2(i,e){return t=>{Object.assign(t.style,i),e(t)}}function b2(i,e){return t=>{Object.assign(t,i),e(t)}}function rs(i,e){return t=>{t.style.display="flex",t.style.flexDirection=i;for(const n of e){const s=t.ownerDocument.createElement("div");t.appendChild(s),n(s)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const uO=C.pB.create();function ob(i,e){const t=C.pB.identity(uO),{globalPosition:n,displayDimensionRenderInfo:{canonicalVoxelFactors:s,displayDimensionIndices:r}}=i;for(let o=0;o<3;++o){const a=r[o];t[12+o]=a===-1?0:n[a],t[5*o]=e/s[o]}return C.pB.multiply(t,i.viewProjectionMat,t),t}class vl extends T.O8{constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer(At.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));const t=.5;this.colorBuffer=this.registerDisposer(At.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(Sw(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new vl(e))}draw(e,t=!0){const n=this.trivialColorShader,s=this.gl;n.bind(),s.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,e);const r=n.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(r,4);const o=n.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(s.colorMask(!1,!1,!1,!0),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.colorMask(!0,!0,!0,!0),s.enable(s.BLEND),s.blendFunc(s.ONE_MINUS_DST_ALPHA,s.DST_ALPHA)),s.lineWidth(1),s.drawArrays(s.LINES,0,6),t&&s.disable(s.BLEND),s.disableVertexAttribArray(r),s.disableVertexAttribArray(o)}}var hO=G(4373);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ab=!1;class lb{constructor(){this.renderLayers=[null],this.pickData=[null],this.values=[0,0,0],this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,n=1,s=null){return this.register(e,n,t.low,t.high,s)}register(e,t=1,n=0,s=0,r=null){const{renderLayers:o,values:a}=this,l=this.nextPickID;this.nextPickID+=t;const c=o.length;o[c]=e;const d=c*3;return a[d]=l,a[d+1]=n,a[d+2]=s,this.pickData[c]=r,l}setMouseState(e,t){const{renderLayers:n,values:s}=this;let r=0,o=n.length-1;for(;r<o;){const h=Math.ceil(r+(o-r)/2);s[h*3]>t?o=h-1:r=h}const a=e.pickedRenderLayer=n[r],l=r*3,c=e.pickedOffset=t-s[l];ab&&console.log(`Looking up pick ID ${t}: renderLayer`,a,`offset=${c}`);const{pickedValue:d}=e;d.low=s[l+1],d.high=s[l+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;const u=this.pickData[r];a!==null&&(ab&&console.log(`Picked value=${d}, offset=${c}, data=${this.pickData[r]}`),a.updateMouseState(e,d,c,u))}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cb=10,pO=1e3,fO=400,gO=500,mO=Math.PI/20,vO=20,yO=10;function db(i,e){return Math.sqrt(i*i+e*e)}function ub(i){let[e,t]=i;e.identifier>t.identifier&&([t,e]=[e,t]);const n=e.clientX-t.clientX,s=e.clientY-t.clientY,r=db(n,s),o=Math.atan2(n,s);return{distance:r,angle:o}}function SO(i,e){const t=Math.PI*2,n=Math.abs(i-e)%t;return Math.min(n,t-n)}class bO extends T.O8{constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new Map,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable((0,la.A)((n,s,r,o)=>{const a={event:n,centerX:r,centerY:o};this.dispatch(`touchhold${n.targetTouches.length}`,n,a,s)},pO,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchmove",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchend",n=>{this.handleTouchEvent(n)})}dispatch(e,t,n,s=t.eventPhase){lf(e,t,s,n,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;const t=new Map,{prevTouches:n,prevEvent:s}=this;let r=0,o=0;for(const h of e.targetTouches)t.set(h.identifier,h),r+=h.clientX,o+=h.clientY;r/=t.size,o/=t.size;for(const[h,p]of n.entries()){const m=t.get(h);if(m===void 0)n.delete(h);else{const g=m.clientX-p.clientX,v=m.clientY-p.clientY;(Math.abs(g)>=cb||Math.abs(v)>=cb)&&(this.moved=!0)}}if(s===void 0||s.targetTouches.length!==t.size||t.size===0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,r,o),(s===void 0||s.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type==="touchend"){const h=Date.now();if(e.targetTouches.length===0&&h-this.tapStartTime<fO){(this.curTapNumTouches!==this.priorTapNumTouches||h-this.tapEndTime>=gO)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=h,this.priorTapNumTouches=this.curTapNumTouches;const p={event:e,centerX:r,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,p)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=r,this.prevCenterY=o,this.translated=!1,t.size===2){const{distance:h,angle:p}=ub(t.values());this.prevDistance=h,this.prevAngle=p,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:a,prevCenterY:l,translated:c}=this;const d=r-a,u=o-l;if(c===!1&&db(d,u)>=yO&&(c=this.translated=!0),c===!0&&(d!==0||u!==0)){this.prevCenterX=r,this.prevCenterY=o;const h={event:e,deltaX:d,deltaY:u,centerX:r,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,h)}if(t.size===2){const{distance:h,angle:p}=ub(t.values());let{pinched:m,rotated:g,prevDistance:v,prevAngle:y}=this;m===!1&&Math.abs(h-v)>=vO&&(this.pinched=m=!0);const S=SO(p,y);if(g===!1&&S>=mO&&(this.rotated=g=!0),m===!0&&h!==v){this.prevDistance=h;const w={event:e,distance:h,prevDistance:v,centerX:r,centerY:o};this.dispatch("touchpinch",e,w)}g===!0&&p!==y&&(this.prevAngle=p,this.dispatch("touchrotate",e,{event:e,centerX:r,centerY:o,angle:p,prevAngle:y}))}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const eh=C.eR.create();class hb{constructor(){this.pickIDs=new lb,this.viewportWidth=0,this.viewportHeight=0,this.invTransform=C.pB.create(),this.frameNumber=-1}}class pb{constructor(){this.buffer=null,this.glWindowX=0,this.glWindowY=0}}const CO=30,Et=5,je=1+Et*2,yl=(()=>{const i=Et**2,e=(s,r)=>(s-Et)**2+(r-Et)**2;let t=new Uint32Array(je*je),n=0;for(let s=0;s<je;++s)for(let r=0;r<je;++r)e(s,r)>i||(t[n++]=r*je+s);return t=t.subarray(0,n),t.sort((s,r)=>{const o=s%je,a=(s-o)/je,l=r%je,c=(r-l)/je;return e(o,a)-e(l,c)}),t})();function fb(i,e,t,n,s,r,o){const a=n-Et,l=s-Et;if(!(a>=0&&l>=0&&a+je<=r&&l+je<=o))for(let c=0;c<je;++c)for(let d=0;d<je;++d){const u=a+d,h=l+c;(u<0||h<0||u>=r||h>=o)&&(i[e+(h*je+u)*t]=0)}}class gb extends rp{constructor(e,t,n){super(e,t,n.visibility),this.viewer=n,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.isMovingToMousePosition=!1,this.pickingData=[new hb,new hb],this.pickRequests=[new pb,new pb],this.pickBufferContents=new Float32Array(8*je*je),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.isMovingToMousePositionOnPick=!1,this.inputEventMap=n.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP<"u"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new za(t)),this.registerDisposer(new yn(t,this.inputEventMap)),this.registerDisposer(new tn(t,this.inputEventMap,s=>{this.onMousemove(s)})),this.registerDisposer(new bO(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",s=>{s.target!==t&&this.onMouseout()},!0),Z(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),Z(t,"snap",()=>{this.navigationState.pose.snap()}),Z(t,"zoom-in",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.zoomBy(.5)}),Z(t,"zoom-out",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.zoomBy(2)}),Z(t,"depth-range-decrease",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.depthRange.value*=.5}),Z(t,"depth-range-increase",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.depthRange.value*=2});for(let s=0;s<3;++s){const r=C.p9[s];for(const o of[-1,1]){const a=o<0?"-":"+";Z(t,`rotate-relative-${r}${a}`,()=>{this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateRelative(C.T2[s],o*.1)});const l=C.eR.create();Z(t,`${r}${a}`,()=>{this.context.flagContinuousCameraMotion();const{navigationState:c}=this,d=l;d[0]=0,d[1]=0,d[2]=0,d[s]=o,c.pose.translateVoxelsRelative(d)})}}Z(t,"zoom-via-wheel",s=>{this.context.flagContinuousCameraMotion();const r=s.detail;this.onMousemove(r,!1),this.zoomByMouse(_i(r))}),Z(t,"adjust-depth-range-via-wheel",s=>{this.context.flagContinuousCameraMotion();const r=s.detail;this.navigationState.depthRange.value*=_i(r)}),Z(t,"translate-via-mouse-drag",s=>{zt(s.detail,(r,o,a)=>{this.context.flagContinuousCameraMotion(),this.translateByViewportPixels(o,a)})}),Z(t,"translate-in-plane-via-touchtranslate",s=>{this.context.flagContinuousCameraMotion();const{detail:r}=s;this.translateByViewportPixels(r.deltaX,r.deltaY)}),Z(t,"translate-z-via-touchtranslate",s=>{this.context.flagContinuousCameraMotion();const{detail:r}=s,{navigationState:o}=this,a=eh;a[0]=0,a[1]=0,a[2]=r.deltaY+r.deltaX,o.pose.translateVoxelsRelative(a)});for(const s of[1,10])Z(t,`z+${s}-via-wheel`,r=>{this.context.flagContinuousCameraMotion();const o=r.detail,{navigationState:a}=this,l=eh,c=o.deltaY!==0?o.deltaY:o.deltaX;l[0]=0,l[1]=0,l[2]=(c>0?-1:1)*s,a.pose.translateVoxelsRelative(l)});Z(t,"move-to-mouse-position",()=>{const{mouseState:s}=this.viewer;s.updateUnconditionally()&&(this.navigationState.position.value=s.position)}),Z(t,"snap",()=>this.navigationState.pose.snap()),Z(t,"move-annotation",s=>{const{mouseState:r}=this.viewer,o=r.pickedAnnotationId,a=r.pickedAnnotationLayer;if(a!==void 0&&o!==void 0){s.stopPropagation();const l=a.source.getReference(o),c=l.value,d=Tr(c.type),u=r.pickedOffset,{chunkTransform:{value:h}}=a;if(h.error!==void 0)return;const{layerRank:p}=h,m=new Float32Array(p);d.getRepresentativePoint(m,c,r.pickedOffset);const g=C.Zc.set(C.Zc.create(),0,0);r.updateUnconditionally()&&zt(s.detail,(v,y,S)=>{C.Zc.add(g,g,[y,S]);const w=new Float32Array(p);De.vo(w,h.chunkToLayerTransform,p+1,m,p);const b=eh,{displayDimensionIndices:x}=this.navigationState.pose.displayDimensions.value;_C(b,w,h.modelTransform,x),this.translateDataPointByViewportPixels(b,b,g[0],g[1]),VC(w,b,h.modelTransform,x);const E=new Float32Array(p);De.vo(E,h.layerToChunkTransform,p+1,w,p);const D=d.updateViaRepresentativePoint(c,E,u);a.source.update(l,D)},v=>{a.source.commit(l),l.dispose()})}}),Z(t,"delete-annotation",()=>{const{mouseState:s}=this.viewer,r=s.pickedAnnotationId,o=s.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&r!==void 0){const a=o.source.getReference(r);try{o.source.delete(a)}finally{a.dispose()}}}),Z(t,"zoom-via-touchpinch",s=>{this.context.flagContinuousCameraMotion();const{detail:r}=s;this.handleMouseMove(r.centerX,r.centerY);const o=r.prevDistance/r.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){const{gl:e}=this;for(const t of this.pickRequests){const{sync:n}=t;n!==null&&e.deleteSync(n),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){const{gl:t}=this;let{buffer:n}=e;n===null?(n=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,32*je*je,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n);const{renderViewport:s}=this,r=this.mouseX-s.visibleLeftFraction*s.logicalWidth,o=s.height-(this.mouseY-s.visibleTopFraction*s.logicalHeight);this.issuePickRequest(r,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=r,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;const{pickRequests:a}=this;e!==a[0]&&(a[1]=a[0],a[0]=e),this.nextPickRequestTime=Date.now()+CO}completePickInternal(e){const{gl:t}=this,{pickBufferContents:n}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,n),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);const{pickingData:s}=this,{frameNumber:r}=e;this.completePickRequest(e.glWindowX,e.glWindowY,n,s[0].frameNumber===r?s[0]:s[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let n=this.context.frameNumber,s=-1;e&&(--n,s=n-1);const{pickRequests:r}=this,{gl:o}=this;let a=!1,l=!1,c;for(const u of r){const{sync:h}=u;if(h===null)continue;const{frameNumber:p}=u;if(!l&&p>=n-1){if(t||o.getSyncParameter(h,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(u),l=!0;else if(p!==s){a=!0;continue}}o.deleteSync(h),u.sync=null,c=u}const{pickTimerId:d}=this;a&&d===-1?this.scheduleCheckForPickRequestCompletion():!a&&d!==-1&&(window.clearTimeout(d),this.pickTimerId=-1),!e&&c!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(c)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){const{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);const{pickingData:n}=this;n[0]=n[1];const s=this.context.frameNumber,r=n[1];if(r.frameNumber=s,r.viewportWidth=e,r.viewportHeight=t,r.pickIDs.clear(),!this.drawWithPicking(r)){r.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){const e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:n}=this;return e<t?(n===-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;const e=this.context.frameNumber,{gl:t}=this,{pickRequests:n}=this;for(const s of n){const{sync:r}=s;if(r!==null)if(s.frameNumber<e-1)t.deleteSync(r);else continue;this.issuePickRequestInternal(s);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}const n=this.context.frameNumber,s=this.pickingData[1];s.frameNumber!==n||this.renderViewport.width!==s.viewportWidth||this.renderViewport.height!==s.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){const{element:n}=this,s=n.getBoundingClientRect(),r=e-(s.left+n.clientLeft),o=t-(s.top+n.clientTop),{mouseState:a}=this.viewer;a.pageX=e+window.scrollX,a.pageY=t+window.scrollY,a.setForcer(this.mouseStateForcer),this.updateMousePosition(r,o)}onMousemove(e,t=!0){const{element:n}=this;t&&e.target!==n||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){const{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;const{clientX:n,clientY:s}=e.targetTouches[0];this.handleMouseMove(n,s)}disposed(){const{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);const{gl:t}=this;this.cancelPickRequests();const{pendingPickRequestTimerId:n}=this;n!==-1&&window.clearTimeout(n);for(const s of this.pickRequests)t.deleteBuffer(s.buffer);super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wO=[1.5,2,3,5,7.5,10],Xs=[{unit:"km",lengthInNanometers:1e12},{unit:"m",lengthInNanometers:1e9},{unit:"mm",lengthInNanometers:1e6},{unit:"\xB5m",lengthInNanometers:1e3},{unit:"nm",lengthInNanometers:1},{unit:"pm",lengthInNanometers:.001}];function C2(i){const e=Xs.length;let t=Xs[e-1];for(let n=0;n<e;++n){const s=Xs[n];if(i>=s.lengthInNanometers){t=s;break}}return t}function w2(i){const e=Xs.length;let t=Xs[e-1];for(let n=0;n<e;++n){const s=Xs[n];if(i>=s.lengthInNanometers**3){t=s;break}}return t}class xO{constructor(){this.allowedSignificands=wO,this.targetLengthInPixels=0,this.physicalSizePerPixel=0,this.prevPhysicalSizePerPixel=0,this.prevTargetLengthInPixels=0,this.prevPhysicalUnit="\0"}update(){const{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;const n=t*e,s=Math.floor(Math.log10(n)),r=10**s,o=n/r;let a=1;for(const d of this.allowedSignificands)if(Math.abs(d-o)<Math.abs(a-o))a=d;else break;const l=a*r,c=Rh(l);return this.lengthInPixels=Math.round(l/e),this.physicalUnit=`${c.prefix}${this.physicalBaseUnit}`,this.physicalLength=a*10**(s-c.exponent),!0}}function EO(i,e,t,n,s){const r=document.createElement("canvas"),o=r.getContext("2d"),a=s.textHeightInPixels*s.scaleFactor,l=`bold ${a}px ${s.fontName}`;o.font=l,o.fillStyle="white";const c=`${n}${i.physicalLength} ${i.physicalUnit}`,d=o.measureText(c),u=Math.max(i.lengthInPixels,d.width),h=s.barHeightInPixels*s.scaleFactor,p=s.barTopMarginInPixels*s.scaleFactor,m=h+p+a,g=s.paddingInPixels*s.scaleFactor,v=m+2*g,y=u+2*g;return r.width=y,r.height=v,o.font=l,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,y,v),o.fillStyle="white",o.fillText(c,y/2,v-g-h-p),o.fillRect(g,v-g-h,i.lengthInPixels,h),yw(e,t,r),{width:y,height:v}}class TO extends T.O8{constructor(e,t=new xO){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){const{dimensions:t,label:n}=this;let{texture:s}=this;if(!t.update()&&s!==null&&e===this.priorOptions&&n===this.prevLabel)return;s===null&&(s=this.texture=this.gl.createTexture());const{width:r,height:o}=EO(t,this.gl,s,n,e);this.priorOptions=e,this.prevLabel=n,this.width=r,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class mb extends T.O8{constructor(e){super(),this.gl=e,this.scaleBarCopyHelper=this.registerDisposer(Dn.get(this.gl)),this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new TO(e)))}draw(e,t,n,s,r){const{scaleBars:o}=this,{displayRank:a,displayDimensionIndices:l,canonicalVoxelFactors:c,globalDimensionNames:d,displayDimensionUnits:u,displayDimensionScales:h}=t,{factors:p}=n,m=Math.min(r.maxWidthFraction*e.logicalWidth,r.maxWidthInPixels*r.scaleFactor);let g=0;for(let w=0;w<a;++w){const b=l[w],x=u[w],E=p[b];let D,I,L;for(D=0;D<g&&(I=o[D],L=I.dimensions,!(L.physicalBaseUnit===x&&I.factor===E));++D);D===g&&(++g,I=o[D],I.label="",L=I.dimensions,I.factor=E,L.physicalBaseUnit=x,L.targetLengthInPixels=m,L.physicalSizePerPixel=h[w]*s/c[w]),I.label+=`${d[b]} `}const{gl:v,scaleBarCopyHelper:y}=this;let S=r.bottomPixelOffset*r.scaleFactor;for(let w=g-1;w>=0;--w){const b=o[w];g===1?b.label="":b.label+=": ",b.update(r),v.viewport(r.leftPixelOffset*r.scaleFactor-e.visibleLeftFraction*e.logicalWidth,S-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,b.width,b.height),y.draw(b.texture),S+=b.height+r.marginPixelsBetweenScaleBars*r.scaleFactor}}}const vb={...{scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function DO(i){const e={...vb};for(const t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])(0,f.cQ)(i,t,n=>{n!==void 0&&(e[t]=(0,f._D)(n))});return(0,f.cQ)(i,"fontName",t=>{t!==void 0&&(e.fontName=(0,f.zr)(t))}),e}class IO extends _.DN{constructor(){super(vb,DO)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var LO=(i=>(i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES",i))(LO||{}),RO=(i=>(i[i.TRANSPARENT=0]="TRANSPARENT",i[i.VOLUME_RENDERING=1]="VOLUME_RENDERING",i[i.MAX_PROJECTION=2]="MAX_PROJECTION",i))(RO||{});const kO=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,th=[`
float computeOITWeight(float alpha, float depth) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -depth * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,`
void emitAccumAndRevealage(vec4 accum, float revealage, highp uint pickId) {
  v4f_fragData0 = vec4(accum.rgb, revealage);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a, gl_FragCoord.z);
  vec4 accum = color * weight;
  emitAccumAndRevealage(accum, color.a, pickId);
}
`];function nh(i){i.addOutputBuffer("vec4","out_color",0),i.addOutputBuffer("highp vec4","out_z",1),i.addOutputBuffer("highp vec4","out_pickId",2),i.addFragmentCode(kO)}function ih(i){i.addOutputBuffer("vec4","v4f_fragData0",0),i.addOutputBuffer("vec4","v4f_fragData1",1),i.addFragmentCode(th)}function sh(i){i.addOutputBuffer("vec4","out_color",0),i.addOutputBuffer("highp vec4","out_z",1),i.addOutputBuffer("highp vec4","out_intensity",2),i.addOutputBuffer("highp vec4","out_pickId",3),i.addFragmentCode(`
void emit(vec4 color, float depth, float intensity, highp uint pickId) {
  float pickIdFloat = float(pickId);
  float bufferDepth = 1.0 - depth;
  out_color = color;
  out_z = vec4(bufferDepth, bufferDepth, bufferDepth, 1.0);
  out_intensity = vec4(intensity, intensity, intensity, 1.0);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}`)}const ti=C.eR.create(),yb=C.ln.create(),PO=C.pB.create();function AO(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}function MO(i){i.addOutputBuffer("vec4","v4f_fragData0",0),i.addOutputBuffer("vec4","v4f_fragData1",1),i.addFragmentCode(th),i.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

emitAccumAndRevealage(accum, 1.0 - revealage, 0u);
`)}function NO(i){i.addOutputBuffer("vec4","v4f_fragData0",0),i.addOutputBuffer("vec4","v4f_fragData1",1),i.addFragmentCode(th),i.setFragmentMain(`
vec4 color = getValue0();
float bufferDepth = getValue1().r;
float weight = computeOITWeight(color.a, 1.0 - bufferDepth);
vec4 accum = color * weight;
float revealage = color.a;

emitAccumAndRevealage(accum, revealage, 0u);
`)}function OO(i){i.addOutputBuffer("vec4","out_color",0),i.addOutputBuffer("highp vec4","out_z",1),i.addOutputBuffer("highp vec4","out_pickId",2),i.setFragmentMain(`
out_color = vec4(0.0);
out_z = getValue0();
out_pickId = getValue1();
`)}function _O(i){i.addOutputBuffer("highp vec4","out_z",0),i.addOutputBuffer("highp vec4","out_pickId",1),i.setFragmentMain(`
out_z = getValue0();
out_pickId = getValue2();
gl_FragDepth = getValue1().r;
`)}const VO=ar(hn);class BO extends VO{constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new So(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class rh extends gb{constructor(e,t,n){super(e,t,n),this.hasVolumeRendering=!1,this.frameRateCalculator=new HC(6,8,8,60),this.isContinuousCameraMotionInProgress=!1,this.sliceViews=this.registerDisposer(new rc((r,o,a)=>{r.registerDisposer(a),r.registerDisposer(a.visibility.add(this.visibility))})),this.axesLineHelper=this.registerDisposer(vl.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(ia.get(this.gl,nh)),this.offscreenFramebuffer=this.registerDisposer(new $n(this.gl,{colorBuffers:[new gn(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new gn(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new gn(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new xo(this.gl)})),this.offscreenCopyHelper=this.registerDisposer(Dn.get(this.gl)),this.transparencyCopyHelper=this.registerDisposer(Dn.get(this.gl,AO,2)),this.transparentToTransparentCopyHelper=this.registerDisposer(Dn.get(this.gl,MO,2)),this.maxProjectionColorCopyHelper=this.registerDisposer(Dn.get(this.gl,NO,2)),this.maxProjectionPickCopyHelper=this.registerDisposer(Dn.get(this.gl,OO,2)),this.maxProjectionToPickCopyHelper=this.registerDisposer(Dn.get(this.gl,_O,3)),this.scaleBars=this.registerDisposer(new mb(this.gl)),this.projectionParameters=this.registerDisposer(new yp({navigationState:this.navigationState,update:(r,o)=>{const{invViewMatrix:a,projectionMat:l,logicalWidth:c,logicalHeight:d}=r,u=c/d,h=Math.PI/4;let{relativeDepthRange:p}=o,g=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){const v=Math.max(.1,1-p),y=1+p;C.pB.ortho(l,-u,u,-1,1,v,y)}else{const v=1/Math.tan(h/2);p/=v;const y=Math.max(.1,1-p),S=1+p;g*=v,C.pB.perspective(l,h,u,y,S)}ip(r,l),o.pose.toMat4(a,g),C.pB.scale(a,a,C.eR.set(ti,1,-1,-1)),C.pB.translate(a,a,C.T2[2]),ap(r)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());const s=this.sharedObject=this.registerDisposer(new BO(this));if(s.RPC_TYPE_ID=hO.l,s.initializeCounterpart(n.rpc,{}),s.visibility.add(this.visibility),this.visibleLayerTracker=_g(this.viewer.layerManager,Gi,this.viewer.visibleLayerRoles,this),this.registerDisposer(this.context.continuousCameraMotionFinished.add(()=>{this.isContinuousCameraMotionInProgress=!1,this.hasVolumeRendering&&(this.scheduleRedraw(),this.frameRateCalculator.resetForNewFrameSet())})),this.registerDisposer(this.context.continuousCameraMotionStarted.add(()=>{this.isContinuousCameraMotionInProgress=!0})),Z(t,"rotate-via-mouse-drag",r=>{zt(r.detail,(o,a,l)=>{this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateRelative(C.T2[1],a/4*Math.PI/180),this.navigationState.pose.rotateRelative(C.T2[0],-l/4*Math.PI/180)})}),Z(t,"rotate-in-plane-via-touchrotate",r=>{this.context.flagContinuousCameraMotion();const{detail:o}=r;this.navigationState.pose.rotateRelative(C.T2[2],o.angle-o.prevAngle)}),Z(t,"rotate-out-of-plane-via-touchtranslate",r=>{this.context.flagContinuousCameraMotion();const{detail:o}=r;this.navigationState.pose.rotateRelative(C.T2[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(C.T2[0],-o.deltaY/4*Math.PI/180)}),n.showSliceViewsCheckbox){const r=this.registerDisposer(new pn(n.showSliceViews));r.element.className="perspective-panel-show-slice-views neuroglancer-noselect";const o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(r.element),this.element.appendChild(o)}this.registerDisposer(n.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(n.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get shouldDownsample(){return this.viewer.enableAdaptiveDownsampling.value&&this.isContinuousCameraMotionInProgress&&this.hasVolumeRendering}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){const n=ti,{viewProjectionMat:s,invViewProjectionMat:r,logicalWidth:o,logicalHeight:a}=this.projectionParameters.value,{pose:l}=this.viewer.navigationState;l.updateDisplayPosition(c=>{C.eR.transformMat4(n,c,s),n[0]+=-2*e/o,n[1]+=2*t/a,C.eR.transformMat4(c,n,r)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(const[o,a]of this.sliceViews)if((a||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();const{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;const s={projectionParameters:this.projectionParameters.value},{visibleLayers:r}=this.visibleLayerTracker;for(const[o,a]of r)if(!o.isReady(s,a))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;const{offscreenFramebuffer:e,renderViewport:{width:t,height:n}}=this,s=t*n,r=new Float32Array(s*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,n,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,r)}finally{e.framebuffer.unbind()}const o=new Float32Array(s);for(let a=0;a<s;++a)o[a]=r[a*4];return o}issuePickRequest(e,t){const{offscreenFramebuffer:n}=this;n.readPixelFloat32IntoBuffer(1,e-Et,t-Et,0,je,je),n.readPixelFloat32IntoBuffer(2,e-Et,t-Et,16*je*je,je,je)}completePickRequest(e,t,n,s){const{mouseState:r}=this.viewer;r.pickedRenderLayer=null,fb(n,0,4,e,t,s.viewportWidth,s.viewportHeight);const o=yl.length;for(let a=0;a<o;++a){const l=yl[a],c=n[4*l];if(c===0)continue;const d=l%je,u=(l-d)/je,h=1-c;ti[0]=2*(e+d-Et)/s.viewportWidth-1,ti[1]=2*(t+u-Et)/s.viewportHeight-1,ti[2]=2*h-1,C.eR.transformMat4(ti,ti,s.invTransform);let{position:p,unsnappedPosition:m}=r;const{value:g}=this.navigationState.position,v=g.length;p.length!==v&&(p=r.position=new Float32Array(v)),m.length!==v&&(m=r.unsnappedPosition=new Float32Array(v)),p.set(g),r.coordinateSpace=this.navigationState.coordinateSpace.value;const y=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:S}=y;for(let b=0,x=S.length;b<x;++b)p[S[b]]=ti[b];m.set(p);const w=n[4*je*je+4*l];s.pickIDs.setMouseState(r,w),r.displayDimensions=y,r.setActive(!0);return}r.setActive(!1)}translateDataPointByViewportPixels(e,t,n,s){const r=ti,{viewProjectionMat:o,invViewProjectionMat:a,width:l,height:c}=this.projectionParameters.value;return C.eR.transformMat4(r,t,o),r[0]+=2*n/l,r[1]+=-2*s/c,C.eR.transformMat4(e,r,a)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new $n(this.gl,{colorBuffers:vs(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}get volumeRenderingConfiguration(){let e=this.volumeRenderingConfiguration_;return e===void 0&&(e=this.volumeRenderingConfiguration_=this.registerDisposer(new $n(this.gl,{colorBuffers:vs(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:new xo(this.gl)}))),e}get maxProjectionConfiguration(){let e=this.maxProjectionConfiguration_;return e===void 0&&(e=this.maxProjectionConfiguration_=this.registerDisposer(new $n(this.gl,{colorBuffers:[new gn(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new gn(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new gn(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new gn(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new xo(this.gl)}))),e}get maxProjectionPickConfiguration(){let e=this.maxProjectionPickConfiguration_;return e===void 0&&(e=this.maxProjectionPickConfiguration_=this.registerDisposer(new $n(this.gl,{colorBuffers:vs(this.gl,2,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),depthBuffer:new xo(this.gl)}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;const{width:t,height:n}=this.renderViewport,s=this.viewer.showSliceViews.value;for(const[w,b]of this.sliceViews)(b||s)&&w.updateRendering();const r=this.gl,o=()=>{r.drawBuffers(this.offscreenFramebuffer.singleAttachmentList)},a=()=>{this.offscreenFramebuffer.bind(t,n)};a(),r.disable(r.SCISSOR_TEST),r.enable(WebGL2RenderingContext.STENCIL_TEST),r.stencilMask(4294967295),r.clearStencil(0),r.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),r.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);const l=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(l[0],l[1],l[2],0),r.clear(r.DEPTH_BUFFER_BIT),r.clearBufferfv(WebGL2RenderingContext.COLOR,0,[l[0],l[1],l[2],0]),r.clearBufferfv(WebGL2RenderingContext.COLOR,1,C.yb),r.clearBufferfv(WebGL2RenderingContext.COLOR,2,C.yb),r.enable(r.DEPTH_TEST);const c=this.projectionParameters.value,d=C.eR.create();C.eR.transformQuat(d,C.T2[2],this.navigationState.pose.orientation.orientation),C.eR.scale(d,d,-1);const u=.2,h=1-u,p={wireFrame:this.viewer.wireFrame.value,projectionParameters:c,lightDirection:d,ambientLighting:u,directionalLighting:h,pickIDs:e.pickIDs,emitter:nh,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1,bindFramebuffer:a,frameNumber:this.context.frameNumber,sliceViewsPresent:this.sliceViews.size>0,isContinuousCameraMotionInProgress:this.isContinuousCameraMotionInProgress};C.pB.copy(e.invTransform,c.invViewProjectionMat);const{visibleLayers:m}=this.visibleLayerTracker;let g=!1,v=!1,y=!1,S=!1;for(const[w,b]of m)w.isTransparent?(g=!0,w.isVolumeRendering&&(S=!0,v=v||!this.isContinuousCameraMotionInProgress||dS(w))):w.isAnnotation?y=!0:w.draw(p,b);if(this.hasVolumeRendering=S,this.drawSliceViews(p),y){r.enable(WebGL2RenderingContext.BLEND),r.depthFunc(WebGL2RenderingContext.LEQUAL),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const[w,b]of m)if(w.isAnnotation){const x=w;x.base.state.displayState.disablePicking.value?(o(),x.draw(p,b),p.bindFramebuffer()):x.draw(p,b)}r.depthFunc(WebGL2RenderingContext.LESS),r.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),g){let w=t,b=n;if(this.shouldDownsample){this.frameRateCalculator.setFrameDeltas(this.context.getLastFrameTimesInMs(this.frameRateCalculator.numberOfStoredFrameDeltas));const N=this.frameRateCalculator.calculateDownsamplingRate(np.MEAN);if(N>1){const k=t/n;w=Math.round(t/N),b=Math.round(w/k)}}let x=()=>{},E=()=>{},D=()=>{};if(this.hasVolumeRendering){p.maxProjectionEmit=sh;const{maxProjectionConfiguration:N}=this;x=()=>{N.bind(w,b)},r.depthMask(!0),x(),p.bindMaxProjectionBuffer=x,r.clearColor(0,0,0,0),r.clearDepth(0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT);const{maxProjectionPickConfiguration:k}=this;E=()=>{k.bind(w,b)},E(),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT),D=()=>{this.volumeRenderingConfiguration.bind(w,b)},D(),p.bindVolumeRenderingBuffer=D,r.clearDepth(1),r.clearColor(0,0,0,1),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT)}const{transparentConfiguration:I}=this;p.bindFramebuffer=()=>{I.bind(t,n)},p.bindFramebuffer(),r.depthMask(!1),r.enable(WebGL2RenderingContext.BLEND),r.clearColor(0,0,0,1),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),p.emitter=ih,r.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),p.emitPickID=!1;let L=0;for(const[N,k]of m)if(N.isVolumeRendering){p.depthBufferTexture=this.offscreenFramebuffer.colorBuffers[1].texture;const O=dS(N),V=!O&&!this.isContinuousCameraMotionInProgress&&!p.wireFrame;if(O?(r.depthMask(!0),r.disable(WebGL2RenderingContext.BLEND),r.depthFunc(WebGL2RenderingContext.GREATER),L!==2&&(p.emitter=sh,x())):(L!==1&&(p.emitter=ih,D()),r.disable(WebGL2RenderingContext.DEPTH_TEST),L=1),N.draw(p,k),r.enable(WebGL2RenderingContext.DEPTH_TEST),!V&&!O)continue;E(),this.maxProjectionToPickCopyHelper.draw(this.maxProjectionConfiguration.colorBuffers[1].texture,this.maxProjectionConfiguration.colorBuffers[2].texture,this.maxProjectionConfiguration.colorBuffers[3].texture),r.enable(WebGL2RenderingContext.BLEND),r.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),O&&(D(),r.depthMask(!1),r.disable(WebGL2RenderingContext.DEPTH_TEST),this.maxProjectionColorCopyHelper.draw(this.maxProjectionConfiguration.colorBuffers[0].texture,this.maxProjectionConfiguration.colorBuffers[1].texture)),x(),p.emitter=sh,r.depthMask(!0),r.clearColor(0,0,0,0),r.clearDepth(0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT),r.clearDepth(1),r.clearColor(0,0,0,1),r.depthMask(!1),r.enable(WebGL2RenderingContext.DEPTH_TEST),r.depthFunc(WebGL2RenderingContext.LESS),L=2}else N.isTransparent&&(L!==0&&(p.emitter=ih,p.bindFramebuffer()),L=0,N.draw(p,k));r.disable(WebGL2RenderingContext.DEPTH_TEST),S&&(p.bindFramebuffer(),this.transparentToTransparentCopyHelper.draw(this.volumeRenderingConfiguration.colorBuffers[0].texture,this.volumeRenderingConfiguration.colorBuffers[1].texture)),r.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.offscreenFramebuffer.bindSingle(0),this.transparencyCopyHelper.draw(I.colorBuffers[0].texture,I.colorBuffers[1].texture),r.depthMask(!0),r.disable(WebGL2RenderingContext.BLEND),r.enable(WebGL2RenderingContext.DEPTH_TEST),p.bindFramebuffer=a,a(),r.enable(WebGL2RenderingContext.STENCIL_TEST),r.drawBuffers([r.NONE,r.COLOR_ATTACHMENT1,r.COLOR_ATTACHMENT2]),p.emitter=nh,p.emitPickID=!0,p.emitColor=!1,r.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),r.stencilMask(2),v&&this.maxProjectionPickCopyHelper.draw(this.maxProjectionPickConfiguration.colorBuffers[0].texture,this.maxProjectionPickConfiguration.colorBuffers[1].texture);for(const[N,k]of m)!N.isTransparent||!N.transparentPickEnabled||N.isVolumeRendering||N.draw(p,k);r.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),r.stencilMask(0);for(const[N,k]of m)!N.isTransparent||N.transparentPickEnabled||N.draw(p,k)}if(r.stencilMask(4294967295),r.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){r.drawBuffers([r.COLOR_ATTACHMENT0]),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.enable(WebGL2RenderingContext.BLEND),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);const{scaleBars:w}=this,b=this.viewer.scaleBarOptions.value;w.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,b),r.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){const{sliceViewRenderHelper:t}=this,{lightDirection:n,ambientLighting:s,directionalLighting:r,projectionParameters:{viewProjectionMat:o}}=e,a=this.viewer.showSliceViews.value;for(const[l,c]of this.sliceViews){if(!c&&!a)continue;const{width:d,height:u,invViewMatrix:h,viewportNormalInCanonicalCoordinates:p}=l.projectionParameters.value;if(d===0||u===0||!l.valid)continue;const m=Math.abs(C.eR.dot(n,p)),g=s+m*r,v=PO;C.pB.identity(v),v[0]=d/2,v[5]=-u/2,C.pB.multiply(v,h,v),C.pB.multiply(v,o,v);const y=yb,S=this.viewer.crossSectionBackgroundColor.value;y[0]=S[0],y[1]=S[1],y[2]=S[2],y[3]=1,t.draw(l.offscreenFramebuffer.colorBuffers[0].texture,v,C.ln.fromValues(g,g,g,1),yb,0,0,1,1)}}drawAxisLines(){const{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,n=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,s=e*n,{gl:r}=this;r.drawBuffers([r.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(ob(t,s),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var FO=(i=>(i[i.COLOR=0]="COLOR",i[i.PICK=1]="PICK",i[i.NUM_TEXTURES=2]="NUM_TEXTURES",i))(FO||{});function UO(i){i.addOutputBuffer("vec4","out_fragColor",0),i.addOutputBuffer("highp vec4","out_pickId",1),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function $O(i){i.addOutputBuffer("vec4","out_fragColor",null),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}const os=C.eR.create(),GO=C.eR.create(),zO=C.ln.create();class Sl extends gb{constructor(e,t,n,s){super(e,t,s),this.sliceView=n,this.axesLineHelper=this.registerDisposer(vl.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(ia.get(this.gl,$O)),this.colorFactor=C.ln.fromValues(1,1,1,1),this.pickIDs=new lb,this.offscreenFramebuffer=this.registerDisposer(new $n(this.gl,{colorBuffers:[new gn(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new gn(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(Dn.get(this.gl)),this.scaleBars=this.registerDisposer(new mb(this.gl)),s.wireFrame.changed.add(()=>this.scheduleRedraw()),Z(t,"rotate-via-mouse-drag",r=>{const{mouseState:o}=this.viewer;if(o.updateUnconditionally()){const a=Float32Array.from(o.position);zt(r.detail,(l,c,d)=>{this.context.flagContinuousCameraMotion();const{pose:u}=this.navigationState,h=C.eR.transformQuat(os,C.T2[0],u.orientation.orientation),p=C.eR.transformQuat(GO,C.T2[1],u.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(p,-c/4*Math.PI/180,a),this.viewer.navigationState.pose.rotateAbsolute(h,-d/4*Math.PI/180,a)})}}),Z(t,"rotate-in-plane-via-touchrotate",r=>{const{detail:o}=r,{mouseState:a}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),a.updateUnconditionally()&&(this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,a.position))}),this.registerDisposer(n),this.visibleLayerTracker=_g(this.viewer.layerManager,Fi,this.viewer.visibleLayerRoles,this),this.registerDisposer(s.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.visibility.add(this.visibility)),this.registerDisposer(n.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(s.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(s.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(s.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){const{pose:n}=this.viewer.navigationState;n.updateDisplayPosition(s=>{C.eR.set(s,-e,-t,0),C.eR.transformMat4(s,s,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,n,s){const r=this.sliceView.projectionParameters.value;return C.eR.transformMat4(e,t,r.viewMatrix),C.eR.set(e,e[0]+n,e[1]+s,e[2]),C.eR.transformMat4(e,e,r.invViewMatrix),e}isReady(){if(!this.visible)return!1;const{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;const t={projectionParameters:e.projectionParameters.value,sliceView:e};for(const[n,s]of this.visibleLayerTracker.visibleLayers)if(!n.isReady(t,s))return!1;return!0}drawWithPicking(e){const{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();const n=t.projectionParameters.value,{width:s,height:r,invViewProjectionMat:o}=n;C.pB.copy(e.invTransform,o);const{gl:a}=this;this.offscreenFramebuffer.bind(s,r),a.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const l=zO,c=this.viewer.crossSectionBackgroundColor.value;l[0]=c[0],l[1]=c[1],l[2]=c[2],l[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,C.r3,this.colorFactor,l,0,0,1,1);const{visibleLayers:d}=this.visibleLayerTracker,{pickIDs:u}=this;u.clear();const h=()=>{a.disable(WebGL2RenderingContext.SCISSOR_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.offscreenFramebuffer.bind(s,r)};h();const p={wireFrame:this.viewer.wireFrame.value,projectionParameters:n,pickIDs:u,emitter:UO,emitColor:!0,emitPickID:!0,sliceView:t,bindFramebuffer:h,frameNumber:this.context.frameNumber};for(const[m,g]of d)m.draw(p,g);if(a.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){const m=Math.min(n.logicalWidth,n.logicalHeight)/4*1.5,{zoomFactor:{value:g}}=this.viewer.navigationState;this.axesLineHelper.draw((0,C.Qi)(ob(n,m*g)))}this.viewer.showScaleBar.value&&(a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(n,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),a.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){const{offscreenFramebuffer:n}=this;n.readPixelFloat32IntoBuffer(1,e-Et,t-Et,0,je,je)}completePickRequest(e,t,n,s){const{mouseState:r}=this.viewer;r.pickedRenderLayer=null,fb(n,0,4,e,t,s.viewportWidth,s.viewportHeight);const{viewportWidth:o,viewportHeight:a}=s,l=yl.length,{value:c}=this.navigationState.position,d=c.length,u=this.navigationState.pose.displayDimensions.value,{displayRank:h,displayDimensionIndices:p}=u,m=(y,S,w)=>{const b=e+y,x=t+S;os[0]=2*b/o-1,os[1]=2*x/a-1,os[2]=0,C.eR.transformMat4(os,os,s.invTransform),w.set(c);for(let E=0;E<h;++E)w[p[E]]=os[E]};let{unsnappedPosition:g}=r;g.length!==d&&(g=r.unsnappedPosition=new Float32Array(d)),r.coordinateSpace=this.navigationState.coordinateSpace.value,r.displayDimensions=u,m(0,0,g);const v=(y,S,w)=>{let{position:b}=r;b.length!==d&&(b=r.position=new Float32Array(d)),m(y-Et,S-Et,b),this.pickIDs.setMouseState(r,w),r.setActive(!0)};for(let y=0;y<l;++y){const S=yl[y],w=n[4*y];if(w===0)continue;const b=S%je,x=(S-b)/je;v(b,x,w);return}v(Et,Et,0)}zoomByMouse(e){const{navigationState:t}=this;if(!t.valid)return;const{sliceView:n}=this,{width:s,height:r,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:a,displayRank:l}}=n.projectionParameters.value;let{mouseX:c,mouseY:d}=this;c-=s/2,d-=r/2;const u=this.navigationState.position.value;for(let h=0;h<l;++h){const p=a[h],m=o[h]*c+o[4+h]*d;u[p]+=m*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const WO=["#f00","#0f0","#99f"],Sb=Ae.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function HO(i){if(i<1||i>1024){const e=Math.log2(i)|0,t=i/2**e;return`${rm(t,1)}p${e}`}return i.toString()}const JO=[i=>i.name,i=>i.scaleFactor],jO=2e3;class YO extends T.O8{constructor(e,t,n,s="px"){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=n,this.displayUnit=s,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=Array.from(Array(3),(g,v)=>{const y=document.createElement("div");y.classList.add("neuroglancer-display-dimensions-widget-dimension"),y.style.display="contents",Z(y,"adjust-via-wheel",D=>{const I=D.detail,{deltaY:L}=I;L!==0&&this.zoomDimension(v,Math.sign(L))});const S=document.createElement("input");S.classList.add("neuroglancer-display-dimensions-widget-name"),S.title="Change display dimensions",S.spellcheck=!1,S.autocomplete="off",S.style.color=WO[v],S.style.gridColumn="1",S.style.gridRow=`${v+1}`,S.addEventListener("focus",()=>{S.select()}),y.appendChild(S);const w=document.createElement("span");w.classList.add("neuroglancer-display-dimensions-widget-scale-factor");const b=document.createElement("input");b.spellcheck=!1,b.title="Change relative scale at which dimension is displayed",b.autocomplete="off",w.style.gridColumn="2",w.style.gridRow=`${v+1}`,b.addEventListener("focus",()=>{b.select()}),w.appendChild(b),y.appendChild(w);const x=document.createElement("span");x.classList.add("neuroglancer-display-dimensions-widget-scale"),x.style.gridColumn="3",x.style.gridRow=`${v+1}`,y.appendChild(x),this.dimensionGridContainer.appendChild(y);const E={name:S,container:y,scaleFactor:b,scale:x,scaleFactorModified:!1};S.addEventListener("input",()=>{$t(S),this.updateNameValidity()}),Z(S,"commit",()=>{this.updateNames()}),S.addEventListener("blur",D=>{const{relatedTarget:I}=D;this.dimensionElements.some(L=>L.name===I)||this.updateNames()||this.updateView()}),w.addEventListener("click",D=>{const{target:I}=D;I!==b&&(b.focus(),D.preventDefault())}),b.addEventListener("input",()=>{$t(b),E.scaleFactorModified=!0}),Z(b,"commit",()=>{this.updateScaleFactors()}),b.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(const D of JO)Z(D(E),"move-up",()=>{v!==0&&D(this.dimensionElements[v-1]).focus()}),Z(D(E),"move-down",()=>{v!==2&&D(this.dimensionElements[v+1]).focus()});return E}),this.scheduleUpdateView=(0,Qe.t)(()=>this.updateView());const{element:r,dimensionGridContainer:o,defaultCheckbox:a}=this,l=document.createElement("label"),c=this.registerCancellable((0,Fe.A)(()=>{r.dataset.active="false"},jO)),d=()=>{r.dataset.active="true",c()};this.registerDisposer(t.changed.add(d)),this.registerDisposer(e.relativeDisplayScales.changed.add(d)),this.registerDisposer(n.changed.add(d)),r.classList.add("neuroglancer-display-dimensions-widget"),r.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),r.addEventListener("pointerleave",()=>{const g=document.activeElement;g instanceof HTMLElement&&r.contains(g)&&g.blur()}),a.type="checkbox",l.appendChild(a),l.appendChild(document.createTextNode("Default")),l.title="Display first 3 dimensions",l.classList.add("neuroglancer-display-dimensions-widget-default"),a.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(l),this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));const u=this.registerDisposer(new yn(r,Sb));u.allShortcutsAreGlobal=!0,this.registerDisposer(new tn(r,Sb)),Z(o,"cancel",()=>{this.updateView();const g=document.activeElement;g instanceof HTMLElement&&r.contains(g)&&g.blur()});const{depthGridContainer:h}=this;h.classList.add("neuroglancer-depth-range-widget-grid"),r.appendChild(h);const p=document.createElement("label"),m=document.createElement("input");m.type="checkbox",p.classList.add("neuroglancer-depth-range-relative-checkbox-label"),m.classList.add("neuroglancer-depth-range-relative-checkbox"),p.appendChild(m),p.appendChild(document.createTextNode("Zoom-relative")),m.addEventListener("change",()=>{const g=m.checked;let v=this.depthRange.value;g!==v<0&&(g?v=-v/this.zoom.value:v=-v*this.zoom.value,this.depthRange.value=v)}),p.title="Depth range is multiplied by scale",r.appendChild(p),Z(h,"adjust-via-wheel",g=>{const v=g.detail,{deltaY:y}=v;if(y===0)return;const S=this.depthRange.value;this.depthRange.value=S*2**Math.sign(y)}),this.registerDisposer((0,_.no)((g,v,{factors:y})=>{Me(h);const{displayRank:S,globalDimensionNames:w,displayDimensionIndices:b,displayDimensionUnits:x,displayDimensionScales:E,canonicalVoxelFactors:D}=v,I=[],L=()=>{m.checked=this.depthRange.value<0;let O=this.depthRange.value;O<0&&(O*=-this.zoom.value);for(const V of I){const{input:z}=V;z.value=Ri(O*V.scale,V.unit,{precision:2,elide1:!1}),$t(z)}},N=O=>{const V=sr(O.input.value);if(V===void 0||V.unit!==O.unit)return!1;let z=V.scale/O.scale;return this.depthRange.value<0&&(z=-z/this.zoom.value),this.depthRange.value=z,!0};for(let O=0;O<S;++O){const V=b[O],z=w[V],Y=x[O],Q=y[V];let X=I.find(ce=>ce.unit===Y&&ce.factor===Q);if(X===void 0){const ce=document.createElement("div");ce.title="Visible depth range",ce.style.display="contents",h.appendChild(ce);const oe=document.createElement("span");oe.textContent="\xB1",ce.appendChild(oe);const Se=document.createElement("input");Se.spellcheck=!1,Se.autocomplete="off",Se.addEventListener("focus",()=>{Se.select()}),Z(Se,"commit",()=>{N(X)}),Se.addEventListener("change",()=>{N(X)||L()}),Se.addEventListener("input",()=>{$t(Se)}),ce.appendChild(Se);const Ke=document.createElement("span");Ke.classList.add("neuroglancer-depth-range-widget-dimension-names"),ce.appendChild(Ke),X={unit:Y,factor:Q,dimensionNames:[],input:Se,label:Ke,scale:E[O]/D[O]},I.push(X)}X.dimensionNames.push(z)}for(const O of I)O.dimensionNames.length!==S&&(O.label.textContent=O.dimensionNames.join(" "));g.registerDisposer(Z(h,"cancel",()=>{L();const O=document.activeElement;O instanceof HTMLElement&&h.contains(O)&&O.blur()}));const k=g.registerCancellable((0,Qe.t)(L));g.registerDisposer(this.depthRange.changed.add(k)),g.registerDisposer(this.zoom.changed.add(k)),L()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();const{displayDimensions:n}=this,{relativeDisplayScales:s}=this,{displayDimensionIndices:r}=n.value,o=r[e];if(o===-1)return;const{factors:a}=s.value,l=new Float64Array(a);l[o]*=2**-t,s.setFactors(l)}updateNameValidity(){const{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,n=e.map(l=>l.name.value),s=jl(n),r=this.displayDimensions.coordinateSpace.value,{names:o}=r,a=n.length;for(let l=0;l<a;++l){let c=s[l];const d=n[l];let u=-1;d.length===0?c=!0:(u=o.indexOf(d),u===-1&&(c=!1));const h=e[l];h.name.dataset.isValid=c.toString(),h.container.dataset.isModified=(u!==t[l]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){const e=this.dimensionElements.map(a=>a.name.value).filter(a=>a.length>0);if(!ho(e))return!1;const{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;const n=new Int32Array(3);n.fill(-1);const s=t.coordinateSpace.value,{names:r}=s,o=e.length;for(let a=0;a<o;++a){const l=r.indexOf(e[a]);if(l===-1)return!1;n[a]=l}return(0,F.r1)(n,t.value.displayDimensionIndices)||t.setDimensionIndices(o,n),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){const{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:n,displayRank:s}=e.value,{factors:r}=t.value,{dimensionElements:o}=this,a=new Float64Array(r);for(let l=0;l<s;++l){const c=o[l];if(!c.scaleFactorModified)continue;const d=Number(c.scaleFactor.value),u=n[l];!Number.isFinite(d)||d<=0||(a[u]=d)}return(0,F.r1)(a,r)||t.setFactors(a),!0}updateView(){const{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:n,canonicalVoxelFactors:s,displayDimensionUnits:r,displayDimensionScales:o,globalDimensionNames:a}=this.displayDimensionRenderInfo.value,{factors:l}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;const c=this.zoom.value,d=n[0];let u=!0;if(d!==-1){const h=r[0],p=l[d];for(let m=1;m<3;++m){const g=n[m];if(g!==-1&&(r[m]!==h||l[g]!==p)){u=!1;break}}}for(let h=0;h<3;++h){const p=n[h],m=e[h];if(m.name.dataset.isValid=void 0,m.container.dataset.isModified=(p===-1).toString(),p===-1)m.name.value="",m.scale.textContent="",m.scaleFactor.value="";else{m.name.value=a[p];const g=o[h]*c/s[h];if(h===0||!u){const v=Ri(g,r[h],{precision:2,elide1:!1});m.scale.textContent=`${v}/${this.displayUnit}`}else m.scale.textContent="";m.scaleFactor.value=HO(l[p])}$t(m.name),$t(m.scaleFactor)}}disposed(){at(this.element),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class QO{constructor(){this.perspectiveView=new Ae,this.sliceView=new Ae}}const bb=new Map([["xy",void 0],["xz",C.Yu.rotateX(C.Yu.create(),C.Yu.create(),Math.PI/2)],["yz",C.Yu.rotateY(C.Yu.create(),C.Yu.create(),Math.PI/2)]]),Cb="\u25FB",oh=new Map([["4panel","\u25F1"],["3d",Cb]]);function KO(i,e){let t;return e===void 0?t=i.navigationState.addRef():t=new ws(new Cs(i.navigationState.pose.position.addRef(),i.navigationState.pose.displayDimensionRenderInfo.addRef(),bs.makeRelative(i.navigationState.pose.orientation,e)),i.navigationState.zoomFactor.addRef(),i.navigationState.depthRange.addRef()),new na(i.chunkManager,i.layerManager,t,i.wireFrame)}function so(i,e){return KO(i,bb.get(e))}function qO(i){return new Map([["xy",so(i,"xy")],["xz",so(i,"xz")],["yz",so(i,"yz")]])}function wb(i){return{crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor,selectionDetailsState:i.selectionDetailsState,mouseState:i.mouseState,layerManager:i.layerManager,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,enableAdaptiveDownsampling:i.enableAdaptiveDownsampling,visibleLayerRoles:i.visibleLayerRoles,selectedLayer:i.selectedLayer,visibility:i.visibility,scaleBarOptions:i.scaleBarOptions}}function ah(i){const{viewer:e}=i;return{...wb(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:i.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function bl(i){return{...wb(i),navigationState:i.navigationState,inputEventMap:i.inputEventBindings.sliceView}}function Zs(i,e){const{navigationState:t}=e;e.element.appendChild(i.registerDisposer(new YO(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof Sl?"px":"vh")).element)}function er(i,e,t){const n=document.createElement("div");n.className="neuroglancer-data-panel-layout-controls",i.registerDisposer(()=>at(n));for(let s=0;s<2;++s){const r=t[Math.min(t.length-1,s)];i.registerDisposer(Z(e.element,s===0?"toggle-layout":"toggle-layout-alternative",o=>{i.container.name=r,o.stopPropagation()}))}for(const s of t){const r=document.createElement("button"),o=document.createElement("div");r.appendChild(o),o.textContent=oh.get(s),r.title=`Switch to ${s} layout.`,r.addEventListener("click",()=>{i.container.name=s}),n.appendChild(r)}e.element.appendChild(n)}function XO(i,e){const t=new na(i.chunkManager,i.layerManager,e.navigationState.addRef(),i.wireFrame),n=()=>{const{width:{value:s},height:{value:r}}=e;t.projectionParameters.setViewport({width:s,height:r,logicalWidth:s,logicalHeight:r,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(n)),t.registerDisposer(e.height.changed.add(n)),n(),t}function lh(i,e,t){const n=new Map;(()=>{const r=new Set;for(const o of t.values()){if(r.add(o),n.has(o))continue;const a=XO(i,o);e.sliceViews.set(a,!0),n.set(o,a)}for(const[o,a]of n)r.has(o)||e.sliceViews.delete(a)})()}class ZO extends T.O8{constructor(e,t,n,s){super(),this.container=e,this.rootElement=t,this.viewer=n;const r=qO(n),{display:o}=n,a={...ah(e),showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},l={...bl(n),showScaleBar:n.showScaleBar},c={...bl(n),showScaleBar:new nt(!1,!1)},d=(h,p,m,g)=>{const v=this.registerDisposer(new Sl(o,p,r.get(h),m));return g&&Zs(this,v),er(this,v,[h,`${h}-3d`]),v},u=[dn(1,rs("column",[dn(1,rs("row",[dn(1,h=>{d("xy",h,l,!0)}),dn(1,h=>{d("xz",h,c,!1)})])),dn(1,rs("row",[dn(1,h=>{const p=this.registerDisposer(new rh(o,h,a));for(const m of r.values())p.sliceViews.set(m.addRef(),!1);Zs(this,p),lh(n,p,s),er(this,p,["3d"])}),dn(1,h=>{d("yz",h,c,!1)})]))]))];rs("row",u)(t)}disposed(){Me(this.rootElement),super.disposed()}}class e_ extends T.O8{constructor(e,t,n,s,r,o){super(),this.container=e,this.rootElement=t,this.viewer=n,this.direction=s;const a=so(n,r),{display:l}=n,c={...ah(e),showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},d={...bl(n),showScaleBar:n.showScaleBar};dn(1,rs(s,[dn(1,u=>{const h=this.registerDisposer(new Sl(l,u,a,d));Zs(this,h),er(this,h,[r,"4panel"])}),dn(1,u=>{const h=this.registerDisposer(new rh(l,u,c));h.sliceViews.set(a.addRef(),!1),lh(n,h,o),Zs(this,h),er(this,h,["3d","4panel"])})]))(t)}disposed(){Me(this.rootElement),super.disposed()}}class t_ extends T.O8{constructor(e,t,n,s){super(),this.container=e,this.rootElement=t,this.viewer=n;const r=so(n,s),o={...bl(n),showScaleBar:n.showScaleBar};rs("row",[dn(1,a=>{const l=this.registerDisposer(new Sl(n.display,a,r,o));Zs(this,l),er(this,l,["4panel",`${s}-3d`])})])(t)}disposed(){Me(this.rootElement),super.disposed()}}class n_ extends T.O8{constructor(e,t,n,s){super(),this.container=e,this.rootElement=t,this.viewer=n;const r={...ah(e),showSliceViews:new nt(!1,!1)};rs("row",[dn(1,o=>{const a=this.registerDisposer(new rh(n.display,o,r));lh(n,a,s),Zs(this,a),er(this,a,["4panel"])})])(t)}disposed(){Me(this.rootElement),super.disposed()}}const ch=new Map([["4panel",{factory:(i,e,t,n)=>new ZO(i,e,t,n)}],["3d",{factory:(i,e,t,n)=>new n_(i,e,t,n)}]]);for(const i of bb.keys()){ch.set(i,{factory:(t,n,s)=>new t_(t,n,s,i)});const e=`${i}-3d`;oh.set(i,Cb),oh.set(e,"\u25EB"),ch.set(e,{factory:(t,n,s,r)=>new e_(t,n,s,"row",i,r)})}function xb(i){const e=ch.get(i);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(i)}.`);return e}function i_(i){return xb(i),i}class s_ extends T.O8{constructor(e){super(),this.width=new _.DN(1e3,f.We),this.height=new _.DN(1e3,f.We),this.changed=new j.IY,this.position=new Yp(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new vc(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new yc(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new ws(new Cs(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){(0,f.Rf)(e),Mt(e,"width",this.width),Mt(e,"height",this.height),Mt(e,"position",vr(this.position)),Mt(e,"orientation",this.orientation),Mt(e,"scale",this.scale),Mt(e,"zoom",vr(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class r_ extends rc{constructor(e){super((t,n)=>t.registerDisposer(t.registerDisposer(n).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){(0,f.Rf)(e);for(const t of Object.keys(e)){const n=new s_(this.parentNavigationState);try{this.set(t,n.addRef()),n.restoreState(e[t])}finally{n.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;const e={};for(const[t,n]of this)e[t]=n.toJSON();return e}}class o_ extends T.O8{constructor(e,t){super(),this.changed=new j.IY,this.orthographicProjection=new nt(!1),this.type=new _.DN(t,i_),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new r_(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):((0,f.Rf)(e),(0,f.cQ)(e,"type",t=>this.type.restoreState(t)),(0,f.cQ)(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),(0,f.cQ)(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){const{type:e,crossSections:t,orthographicProjection:n}=this,s=n.toJSON();return t.size===0&&s===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:s}}}class a_ extends T.O8{constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new o_(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";const n=this.registerCancellable((0,Fe.A)(()=>this.updateLayout(),0));this.specification.type.changed.add(n),Z(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>n.flush())),n()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){const{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=xb(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}const l_=typeof{cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}}<"u"&&Object.keys({cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}}).length>0;class c_ extends T.O8{constructor(e){if(super(),this.element=document.createElement("div"),this.button=Ne({text:"Share",title:"Share State"}),typeof{cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}}>"u")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys({cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}}).length>1){const t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{const n=e.selectedStateServer.value;Object.values({cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}}).map(s=>s.url).includes(n)&&(t.value=n)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(const[n,s]of Object.entries({cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}})){const r=document.createElement("option");r.textContent=n,r.value=s.url,r.selected=!!s.default,t.appendChild(r)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{const t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values({cave:{url:"middleauth+https://global.daf-apis.com/nglstate/api/v1/post",default:!0}})[0].url,n=new URL(t).protocol,{url:s,credentialsProvider:r}=wn(t,Zn);pe.forPromise(Nt(r,s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},ke.cj).then(o=>{const a=new URL(o).protocol,l=o.substring(a.length),c=`${window.location.origin}/#!${n}${l}`;navigator.clipboard.writeText(c).then(()=>{pe.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{pe.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function d_(i){return i.startsWith("key")?i.substring(3):i.startsWith("digit")||i.startsWith("arrow")?i.substring(5):i}function u_(i){return i.split("+").map(d_).join("+")}const h_={...Ui,side:"left",row:1};class p_{constructor(){this.location=new Si(h_)}get changed(){return this.location.changed}toJSON(){return(0,f.Zu)(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class f_ extends ji{constructor(e,t,n,s,r){super(e,t.location),this.bindings=n,this.toolBinder=r,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});const o=document.createElement("div");o.classList.add("neuroglancer-help-body");const{scroll:a}=this;a.classList.add("neuroglancer-help-scroll-container"),o.appendChild(a),this.addBody(o);const l=this.registerCancellable((0,Qe.t)(()=>this.updateView()));this.registerDisposer(r.changed.add(l)),this.registerDisposer(s.layersChanged.add(l)),this.updateView()}updateView(){const{scroll:e,bindings:t,toolBinder:n}=this;if(Me(e),typeof NEUROGLANCER_BUILD_INFO<"u"){const d=document.createElement("h2");d.textContent="Build info";const u=document.createElement("div");u.classList.add("neuroglancer-build-info");const h=document.createElement("a"),{tag:p,url:m,timestamp:g}=NEUROGLANCER_BUILD_INFO;if(h.textContent=p,h.target="_blank",m!==void 0&&(h.href=m),e.appendChild(d),u.appendChild(h),g!==void 0){const v=document.createElement("div");v.classList.add("neuroglancer-build-timestamp");const y=Intl.DateTimeFormat("en",{hour12:!1,dateStyle:"medium",timeStyle:"long"}).format(new Date(g));v.textContent=`Built at ${y}`,u.append(v)}e.appendChild(u)}const s=new Map;function r(d,u){for(const h of d.parents)h.label!==void 0?o(h.label,h):r(h,u);for(const[h,p]of d.bindings.entries()){const m=h.indexOf(":"),g=h.substring(m+1);u.set(g,p.action)}}function o(d,u){if(s.has(u))return;const h={label:d,entries:new Map};r(u,h.entries),s.set(u,h)}for(const[d,u]of t)o(d,u);const a=(d,u)=>{const h=document.createElement("h2");h.textContent=d,e.appendChild(h);for(const[p,m]of u){const g=document.createElement("div");g.className="dt",g.textContent=u_(p);const v=document.createElement("div");v.className="dd",v.textContent=m,e.appendChild(g),e.appendChild(v)}},l=new Map;for(const[d,u]of n.bindings)if(u.context instanceof Rn){let h=l.get(u.context);h===void 0&&(h=[],l.set(u.context,h)),h.push([`shift+key${d.toLowerCase()}`,u.description])}const c=Array.from(l.entries());c.length>0&&(c[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),c.sort((d,u)=>d[0].managedLayer.nonArchivedLayerIndex-u[0].managedLayer.nonArchivedLayerIndex));for(const[d,u]of c)u.sort(),a(`Tool bindings for layer ${d.managedLayer.nonArchivedLayerIndex+1}: ${d.managedLayer.name}`,u);for(const d of s.values())a(d.label,d.entries)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function g_(i,e){i.style.display="block";const{offsetWidth:t,offsetHeight:n}=i,s=document.documentElement.clientWidth,r=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(s-t,e.clientX),a=document.documentElement.scrollTop+Math.min(r-n,e.clientY);i.style.left=o+"px",i.style.top=a+"px"}class m_ extends T.O8{constructor(e){super(),this.element=document.createElement("div"),this.parentDisposers=new Map,this.disabledValue=!1,this.opened=new j.IY,this.closed=new j.IY;const{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){const{parentDisposers:t}=this;t.has(e)||t.set(e,(0,T.K6)(e,"contextmenu",n=>{this.show(n),n.stopPropagation(),n.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();const{element:t}=this,n=(0,T.K6)(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),s=(0,T.K6)(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),r=()=>{s(),n(),t.style.display="none"};this.opened.dispatch(),g_(t,e),this.menuDisposer=r}unregisterParent(e){const{parentDisposers:t}=this,n=t.get(e);n!==void 0&&(n(),t.delete(e))}disposed(){const{parentDisposers:e}=this;for(const t of e.values())t();e.clear(),at(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Eb(i){return Le(new TextEncoder().encode(i))}function v_(i){return new TextDecoder().decode(We(i))}function T2(i,e){return i+Eb(JSON.stringify(e))}function y_(i,e){if(i.startsWith(e))try{const t=v_(i.substring(e.length));return JSON.parse(t)}catch{return}}function S_(i,e){return i+Eb(JSON.stringify(e))}function b_(i,e){for(const t of i){const n=y_(t,e);if(n!==void 0)return{parameters:n,dragType:t}}}let Tb;function dh(i,e){return i.dataTransfer.dropEffect=e,Tb=e,e}function uh(){return Tb}function C_(i){return i.draggable=!0,(0,T.K6)(i,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Db="neuroglancer-layer\0";let un;function Ib(i,e){i.dataTransfer.setData(S_(Db,e.layers.map(s=>({name:s.name,visible:s.visible}))),JSON.stringify({layers:e.layers.map(s=>s.toJSON()),layout:e.layoutSpec})),un!==void 0&&un.disposer();let t;const n=()=>{e.manager.unregisterDisposer(n);for(const s of e.layers)s.dispose();e.manager.dispose(),un===t&&(un=void 0)};un=t={manager:e.manager.addRef(),layers:e.layers.map(s=>s.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:e.isLayerListPanel??!1,disposer:n}}function Cl(i="none"){if(un!==void 0){if(i==="move"){const e=new Set(un.layers);un.manager.layerManager.filter(t=>!e.has(t))}un.disposer()}}function wl(i){return b_(i.dataTransfer.types,Db)}function Lb(i){if(un!==void 0&&un.manager.rootLayers===i.rootLayers)return un}class Rb{initializeExternalLayers(e){const{dragType:t}=this;if(t!==void 0)try{const{layers:n,layout:s}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(n)||this.numSourceLayers!==n.length)throw new Error("Invalid layer drop data");this.layoutSpec=s;for(const[r,o]of this.layers)WT(r,n[o])}catch{return!1}return!0}updateArchiveStates(e){const{targetIsLayerListPanel:t}=this,n=e.dataTransfer.dropEffect;for(const s of this.layers.keys()){let r=t;t&&!s.archived&&n!=="copy"&&this.sourceIsLayerListPanel&&(r=!1),(s.archived!==r||r&&s.visible)&&(s.archived=r,r&&(s.visible=!1),s.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}}function kb(i,e,t){let n;i.shiftKey?n="copy":i.ctrlKey&&t?n="move":n=e;let s="";const r=o=>{s!==""&&(s+=", "),s+=o};return e!=="none"&&n!==e&&(i.shiftKey?r(`release SHIFT to ${e}`):r(`release CONTROL to ${e}`)),n!=="copy"&&r("hold SHIFT to copy"),n!=="move"&&t&&e!=="move"&&r("hold CONTROL to move"),{dropEffect:n,dropEffectMessage:s}}function Pb(i,e,t,n){const s=Lb(e);let r=!1,o;return s===void 0?o="copy":n?(s.isLayerListPanel||(r=!0),o="link"):s.manager===e&&s.isLayerListPanel===t?(o="move",r=!0):t?o="none":(s.isLayerListPanel||(r=!0),o="link"),kb(i,o,r)}function w_(i,e,t,n){const s=Pb(i,e,t,n);return dh(i,s.dropEffect),s}function hh(i,e,t){const{forceCopy:n,newTarget:s,isLayerListPanel:r=!1}=t,o=Lb(e);if(!n&&o!==void 0){const l=!s&&o.manager===e&&(o.isLayerListPanel===r||o.isLayerListPanel),c=new Rb;return c.manager=e,c.numSourceLayers=o.layers.length,c.sourceManager=o.manager,c.targetIsLayerListPanel=r,c.sourceIsLayerListPanel=o.isLayerListPanel,c.moveSupported=l,c.layers=new Map,c.forceCopy=!1,c.layoutSpec=o.layoutSpec,l?o.layers.forEach((d,u)=>{c.layers.set(d,u)}):o.layers.forEach((d,u)=>{(s||!e.layerManager.has(d))&&c.layers.set(d.addRef(),u)}),c}const a=wl(i);if(a!==void 0)try{const l=(0,f.$v)(a.parameters,(d,u)=>{const h=(0,f.cQ)(d,"name",f.zr);let p=(0,f.cQ)(d,"visible",f.aO);const m=new Kc(h,e);return r&&(p=!1),m.visible=p,m.archived=r,[m,u]}),c=new Rb;return c.numSourceLayers=l.length,c.targetIsLayerListPanel=r,c.sourceIsLayerListPanel=!1,c.sourceManager=void 0,c.moveSupported=!1,c.forceCopy=o!==void 0,c.manager=e,c.dragType=a.dragType,c.layers=new Map(l),c}catch{}}function ph(i,e){return i.moveSupported?!1:(i.manager.layerManager.filter(t=>!i.layers.has(t)),e!==void 0&&i.layers.has(e))}function xl(i,e,t,n=!1){function s(r,o){let a=i.dropLayers;const{dropEffect:l,dropEffectMessage:c}=o?Pb(r,i.manager,n,!1):{dropEffect:uh(),dropEffectMessage:""};if(l===void 0)return;dh(r,l);let d=!0;if(!(a!==void 0&&!a.compatibleWithMethod(l)&&(i.dropLayers=void 0,ph(a,t)))){if(a===void 0){if(a=i.dropLayers=hh(r,i.manager,{forceCopy:l==="copy",newTarget:!1,isLayerListPanel:n}),a===void 0)return;d=a.method==="move"}if(t!==void 0&&a.layers.has(t))return{dropLayers:a,dropEffect:l,dropEffectMessage:c};if(d){const{layerManager:u}=i.manager,h=new Set;let p=Number.POSITIVE_INFINITY;const m=u.managedLayers=u.managedLayers.filter((v,y)=>a.layers.has(v)?(p===Number.POSITIVE_INFINITY&&(p=y),h.add(v),!1):!0);let g;t!==void 0?(g=m.indexOf(t),p<=g&&++g):g=m.length;for(const v of a.layers.keys())h.has(v)||a.layers.delete(v);m.splice(g,0,...a.layers.keys()),u.layersChanged.dispatch()}else{let u;t!==void 0&&(u=i.manager.layerManager.managedLayers.indexOf(t));for(const h of a.layers.keys())i.manager.add(h,u)}return{dropLayers:a,dropEffect:l,dropEffectMessage:c}}}e.addEventListener("dragenter",r=>{s(r,!0)!==void 0?r.preventDefault():kt(i.element,"drop")}),e.addEventListener("drop",r=>{r.preventDefault(),i.dragEnterCount=0,kt(i.element,"drop");const o=s(r,!1)?.dropLayers;if(i.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(r)){ph(o);return}o.updateArchiveStates(r),Cl(o.method==="move"?void 0:r.dataTransfer.dropEffect)}}),e.addEventListener("dragover",r=>{const o=s(r,!0);if(o===void 0){kt(i.element,"drop");return}const{dropLayers:a,dropEffect:l,dropEffectMessage:c}=o,d=a.layers.size;let u="";const h=a.numSourceLayers===1?"":"s",p=a.numSourceLayers;if(l==="none")u=`Cannot link dragged layer${h} here`;else{const m=p===d?`${p}`:`${d}/${p}`;u=`Drop to ${l} ${m} layer${h}`}c&&(u+=` (${c})`),Cn(i.element,"drop",u),r.preventDefault(),r.stopPropagation()})}function Ab(i,e,t,n){e.draggable=!0,e.addEventListener("dragstart",s=>{Cn(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),Ib(s,{manager:i.manager,layers:[t],layoutSpec:n.getLayoutSpec(),isLayerListPanel:n.isLayerListPanel}),s.stopPropagation()}),e.addEventListener("dragend",()=>{kt(e,"drag"),Cl()})}function Mb(i){i.element.addEventListener("dragenter",()=>{++i.dragEnterCount}),i.element.addEventListener("dragleave",()=>{if(--i.dragEnterCount!==0)return;kt(i.element,"drop");const{dropLayers:e}=i;e!==void 0&&(ph(e),i.manager.layerManager.layersChanged.dispatch(),i.dropLayers=void 0)})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class x_ extends T.O8{constructor(e,t){super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";const{element:n,labelElement:s,layerNumberElement:r,valueElement:o,visibleProgress:a,prefetchProgress:l,labelElementText:c}=this;n.className="neuroglancer-layer-item neuroglancer-noselect",n.appendChild(a),n.appendChild(l),s.className="neuroglancer-layer-item-label",s.appendChild(c),this.registerDisposer(e.readyStateChanged.add(()=>{if(console.log("layer is ready",e.isReady()),e.isReady()&&e.layer instanceof Ct){const g=e.layer.graphConnection,v=Ne({text:"\u{1F558}",title:"Share State"});v.addEventListener("click",w=>{if(w.stopPropagation(),g.value instanceof is){const{timestamp:b}=g.value.state;b.reset()}});let y;const S=()=>{if(y&&y(),g.value instanceof is){n.appendChild(v);const{timestamp:w}=g.value.state,b=()=>{v.style.display=w.value>0?"inherit":"none"};y=this.registerDisposer(w.changed.add(b)),b()}else n.contains(v)&&n.removeChild(v)};S(),this.registerDisposer(g.changed.add(S))}})),a.className="neuroglancer-layer-item-visible-progress",l.className="neuroglancer-layer-item-prefetch-progress",r.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";const d=document.createElement("div");d.className="neuroglancer-layer-item-value-container";const u=document.createElement("div");u.className="neuroglancer-layer-item-button-container";const h=No();h.title="Remove layer from this layer group",h.addEventListener("click",g=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),g.stopPropagation()});const p=Mn();p.title="Delete this layer",p.addEventListener("click",g=>{Ms(this.layer),g.stopPropagation()}),n.appendChild(r),d.appendChild(o),d.appendChild(u),u.appendChild(h),u.appendChild(p),n.appendChild(s),n.appendChild(d);const m=this.registerDisposer(new xs(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1,velocity:e.localVelocity,getToolBinder:()=>e.layer?.toolBinder}));n.appendChild(m.element),m.element.addEventListener("click",g=>{g.stopPropagation()}),m.element.addEventListener("dblclick",g=>{g.stopPropagation()}),n.addEventListener("click",g=>{g.ctrlKey?t.selectedLayer.toggle(e):g.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),n.addEventListener("contextmenu",g=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,g.stopPropagation(),g.preventDefault()}),Ab(t,n,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),xl(this.panel,n,this.layer)}update(){const{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let n=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(n+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),n+=", drag to move, shift+drag to copy",t.title=n}disposed(){this.element.remove(),super.disposed()}}class E_ extends T.O8{constructor(e,t,n){super(),this.layerGroupViewer=e,this.getLayoutSpecForDrag=t,this.showLayerHoverValues=n,this.layerWidgets=new Map,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.positionWidget=this.registerDisposer(new xs(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner,{velocity:this.viewerNavigationState.velocity.velocity,getToolBinder:()=>this.layerGroupViewer.toolBinder})),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable((0,Qe.t)(()=>this.update()));const{element:s,manager:r,selectedLayer:o}=this;s.className="neuroglancer-layer-panel",this.registerDisposer(r.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(r.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(n.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);const a=Ne({svg:Fa,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});a.classList.add("neuroglancer-layer-add-button");const l=this.dropZone=document.createElement("div");l.className="neuroglancer-layer-panel-drop-zone";const c=u=>{if(u.ctrlKey||u.metaKey||u.type==="contextmenu"){const h=$g(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(h),this.selectedLayer.layer=h,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(a,"click",c),this.registerEventListener(a,"contextmenu",c),s.appendChild(a),s.appendChild(l),this.registerDisposer(C_(a)),s.appendChild(this.positionWidget.element);const d=()=>{const u=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=u===Ro.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(d)),d(),this.update(),this.updateChunkStatistics(),Mb(this),xl(this,l,void 0),this.registerDisposer(this.display.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(r.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable((0,Qe.t)(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}get manager(){return this.layerGroupViewer.layerSpecification}get display(){return this.layerGroupViewer.display}get selectedLayer(){return this.layerGroupViewer.selectedLayer}get viewerNavigationState(){return this.layerGroupViewer.viewerNavigationState}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,at(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;const e=this.manager.layerSelectedValues;for(const[t,n]of this.layerWidgets){const s=t.layer;let r="";if(s!==null){const o=e.get(s);if(o!==void 0){const{value:a}=o;a!==void 0&&(r=""+a)}}if(r!==n.prevValueText){if(n.prevValueText=r,r.length>n.maxLength){const o=n.maxLength=r.length;n.valueElement.style.width=`${o}ch`}n.valueElement.textContent=r}}}updateChunkStatistics(){for(const[e,t]of this.layerWidgets){let n=0,s=0,r=0,o=0;const a=e.layer;if(a!==null)for(const{layerChunkProgressInfo:l}of a.renderLayers)n+=l.numVisibleChunksNeeded,s+=l.numVisibleChunksAvailable,r+=l.numPrefetchChunksNeeded,o+=l.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${s/Math.max(1,n)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,r)*100}%`}}updateLayers(){if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;const e=this.element,t=new Set;let n=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(const s of this.manager.layerManager.managedLayers){if(s.archived&&!this.dropLayers?.layers.has(s))continue;t.add(s);let r=this.layerWidgets.get(s);const o=s.nonArchivedLayerIndex;r===void 0&&(r=new x_(s,this),this.layerWidgets.set(s,r)),r.layerNumberElement.textContent=""+(1+o),r.update();const{element:a}=r;a!==n&&e.insertBefore(r.element,n),n=a.nextElementSibling}for(const[s,r]of this.layerWidgets)t.has(s)||(this.layerWidgets.delete(s),r.dispose())}addLayerMenu(){Qg(this.manager,this.selectedLayer)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Nb(i,e){const t=(0,T.K6)(i,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(Fo)!==-1){o.stopPropagation();const a=(0,f.Rf)(JSON.parse(o.dataTransfer.getData(Fo))),l=(0,f.cQ)(a,"dimensions",Yl),c=(0,f.cQ)(a,"position",p=>(0,f.$v)(p,f.zo));if(c.length!==l.length)throw new Error("length mismatch between position and dimensions");const d=c.length,{coordinateSpace:{value:{names:u}},value:h}=e;for(let p=0;p<d;++p){const m=u.indexOf(l[p]);m!==-1&&(h[m]=c[p])}e.changed.dispatch()}}),n=o=>{o.dataTransfer.types.indexOf(Fo)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},s=(0,T.K6)(i,"dragenter",n),r=(0,T.K6)(i,"dragover",n);return()=>{s(),r(),t()}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fh="neuroglancer-layer-group-viewer";function Ob(i){return i.dataTransfer.types.indexOf(fh)!==-1}let _n;function T_(i){if(_n&&_n.viewer.layerSpecification.rootLayers===i.rootLayers)return _n.viewer}function D_(i,e){const t=T_(e);let n,s=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?n="copy":(s=!0,n="move"),kb(i,n,s)}class I_ extends T.O8{constructor(e){super(),this.relativeDisplayScales=new Kw(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new Xw(e.navigationState.pose.displayDimensions.addRef()),this.position=new Yp(e.navigationState.position.addRef()),this.velocity=this.registerDisposer(new Yw(e.velocity,this.position.link)),this.crossSectionOrientation=new vc(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new Zp(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new yc(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new nf(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new nf(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new ws(new Cs(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new vc(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new yc(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new ws(new Cs(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(const e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.velocity,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",vr(this.position)),e.add("velocity",this.velocity),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}function L_(i,e){const t=new m_(i),n=t.element;n.classList.add("neuroglancer-layer-group-viewer-context-menu");const s=document.createElement("button");s.textContent="Remove layer group",n.appendChild(s),t.registerEventListener(s,"click",()=>{e.layerSpecification.layerManager.clear()});const{viewerNavigationState:r}=e;for(const[o,a]of[["Render scale factors",r.relativeDisplayScales.link],["Render dimensions",r.displayDimensions.link],["Position",r.position.link],["Cross-section orientation",r.crossSectionOrientation.link],["Cross-section zoom",r.crossSectionScale.link],["Cross-section depth range",r.crossSectionDepthRange.link],["3-D projection orientation",r.projectionOrientation.link],["3-D projection zoom",r.projectionScale.link],["3-D projection depth range",r.projectionDepthRange.link]]){const l=t.registerDisposer(new Bo(a)),c=document.createElement("label");c.style.display="flex",c.style.flexDirection="row",c.style.whiteSpace="nowrap",c.textContent=o,c.appendChild(l.element),n.appendChild(c)}return t}class ro extends T.O8{constructor(e,t,n={}){super(),this.element=e,this.viewerState=t,this.state=new fr,this.options={showLayerPanel:new nt(!0),showViewerMenu:!1,showLayerHoverValues:new nt(!0),...n},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.toolBinder=this.registerDisposer(new Dc(this,this.layerSpecification.root.toolBinder)),this.viewerNavigationState=this.registerDisposer(new I_(t)),this.viewerNavigationState.register(this.state),this.registerDisposer((0,_.no)((s,r)=>{r===Ro.UNLINKED&&s.registerDisposer(new mc(this.layerSpecification.root.display,this.viewerNavigationState.position.value,this.viewerNavigationState.velocity.velocity))},this.viewerNavigationState.position.link)),this.layerSpecification instanceof zg?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(s=>s.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new za(e)),this.layout=this.registerDisposer(new a_(this,"xy")),this.state.add("layout",this.layout),this.state.add("toolBindings",this.toolBinder),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(Nb(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,Fe.A)(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get enableAdaptiveDownsampling(){return this.viewerState.enableAdaptiveDownsampling}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(Z(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),Mt(e,"crossSectionZoom",vr(this.viewerNavigationState.crossSectionScale)),Mt(e,"perspectiveZoom",vr(this.viewerNavigationState.projectionScale)),Mt(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){const{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){const n=this.layerPanel=new E_(this,()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(n.registerDisposer(L_(n.element,this)),n.element.title="Right click for options, drag to move/copy layer group."):n.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS<"u"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{const r=document.createElement("button");r.textContent="Clear segments",r.title='De-select all objects ("x")',r.addEventListener("click",o=>{af(o,o,{action:"clear-segments"})}),n.element.appendChild(r)}for(const r of["3d","xy","xz","yz"]){const o=document.createElement("button");o.textContent=r,o.title=`Switch to ${r} layout`,o.addEventListener("click",()=>{let a;this.layout.name===r?r!=="3d"?a=`${r}-3d`:a="4panel":a=r,this.layout.name=a}),n.element.appendChild(o)}}n.element.draggable=!0;const s=n.element;s.addEventListener("dragstart",r=>{Cn(n.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),Ib(r,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});const o=()=>{_n&&_n.viewer===this&&(_n=void 0),this.unregisterDisposer(o)};_n={viewer:this,disposer:o},this.registerDisposer(o);const a=this.toJSON();a.layers=void 0,r.dataTransfer.setData(fh,JSON.stringify(a)),n.element.style.backgroundColor="black",setTimeout(()=>{n.element.style.backgroundColor=""},0)}),n.element.addEventListener("dragend",()=>{kt(s,"drag"),Cl(),_n!==void 0&&_n.viewer===this&&_n.disposer()}),this.element.insertBefore(s,this.element.firstChild)}}disposed(){Me(this.element);const{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _b=Symbol("layoutComponentContainer");class tr extends T.O8{constructor(e,t,n){super(),this.viewer=e,this.parent=n,this.changed=new j.IY,this.flex=new _.DN(1,f.Mo),this.element=document.createElement("div");const{element:s}=this;s.style.display="flex",s.style.flex="1",s.style.position="relative",s.style.alignItems="stretch",s[_b]=this,this.flex.changed.add(()=>{s.style.flexGrow=""+this.flex.value,this.changed.dispatch()}),this.setSpecification(t);const r=[],o=l=>{const c=document.createElement("div");c.className="neuroglancer-layout-split-drop-zone";let d;switch(c.style[l]="0",l){case"left":case"right":d="row",c.style.width="10px",c.style.height="100%";break;case"top":case"bottom":d="column",c.style.height="10px",c.style.width="100%";break}c.style.display="none",r.push({element:c,direction:d,orientation:l}),s.appendChild(c),Bb(c,this.viewer.layerSpecification,()=>this.split(l).newContainer.component,d==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let a=!1;s.addEventListener("dragenter",l=>{if(!a&&wl(l)!==void 0){a=!0;for(const{element:c,direction:d,orientation:u}of r){if(n!==void 0&&d===n.direction&&((u==="left"||u==="top")&&n.get(0)!==this||(u==="bottom"||u==="right")&&n.get(n.length-1)!==this))continue;const{component:h}=this;h instanceof El&&h.direction===d||(c.style.display="block")}}},!0),s.addEventListener("drop",l=>{if(a){a=!1;for(const{element:c}of r)c.style.display="none"}},!0),s.addEventListener("dragleave",l=>{const{relatedTarget:c}=l;if(a&&!(c instanceof HTMLElement&&this.element.contains(c))){a=!1;for(const{element:d}of r)d.style.display="none"}},!0)}unsetComponent(){const e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof ro){const{layerManager:t}=e,n=e.registerCancellable((0,Fe.A)(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&n()})),n()}else if(e instanceof El){const t=e.registerCancellable((0,Fe.A)(()=>{const{length:n}=e;if(n===0&&this.parent!==void 0)this.dispose();else if(n===1){const s=e.get(0).component;let r;if(this.parent===void 0&&s instanceof ro){r=s.layout.specification.toJSON(),s.viewerNavigationState.copyToParent();const o=s.layerManager.managedLayers,a=new Set(o),{layerSpecification:l}=s;l.rootLayers.filter(u=>a.has(u)||u.archived);const c=[],{managedLayers:d}=l.rootLayers;for(let u=0,h=d.length;u<h;++u)a.has(d[u])&&c.push(u);for(let u=0,h=o.length;u<h;++u)d[c[u]]=o[u];l.rootLayers.layersChanged.dispatch()}else r=s.toJSON();this.setSpecification(r)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){const e=this.component.toJSON();return this.parent instanceof El&&(e.flex=this.flex.toJSON()),e}setSpecification(e){this.setComponent(R_(this,e)),this.flex.value=(0,f.MM)(e,"flex",f.Mo,1)}static getFromElement(e){return e[_b]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){const t={type:"viewer"},{parent:n}=this;if(n!==void 0){if(e==="left"&&n.direction==="row"||e==="top"&&n.direction==="column")return{newContainer:n.insertChild(t,this),existingContainer:this};if(e==="right"&&n.direction==="row"||e==="bottom"&&n.direction==="column")return{newContainer:n.insertChild(t),existingContainer:this}}let s;const r=this.component;r instanceof gh?s=r.layerGroupViewer.toJSON():s=r.toJSON();let o,a;const l=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:l,children:[t,s]},a=0;break;case"right":case"bottom":o={type:l,children:[s,t]},a=1;break}this.setSpecification(o);const c=this.component;return{newContainer:c.get(a),existingContainer:c.get(1-a)}}}function Vb(i){return{mouseState:i.mouseState,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,enableAdaptiveDownsampling:i.enableAdaptiveDownsampling,showScaleBar:i.showScaleBar,scaleBarOptions:i.scaleBarOptions,showPerspectiveSliceViews:i.showPerspectiveSliceViews,inputEventBindings:i.inputEventBindings,visibility:i.visibility,selectedLayer:i.selectedLayer,visibleLayerRoles:i.visibleLayerRoles,navigationState:i.navigationState.addRef(),perspectiveNavigationState:i.perspectiveNavigationState.addRef(),velocity:i.velocity.addRef(),crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor}}class gh extends T.O8{constructor(e,t,n){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new ro(e,{display:n.display,layerSpecification:n.layerSpecification.addRef(),...Vb(n)},{showLayerPanel:n.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:n.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function Bb(i,e,t,n){i.addEventListener("dragenter",s=>{wl(s)!==void 0&&i.classList.add("neuroglancer-drag-over")}),i.addEventListener("dragleave",()=>{kt(i,"drop"),i.classList.remove("neuroglancer-drag-over")}),i.addEventListener("dragover",s=>{const r=(o,a)=>{o.dropEffectMessage&&(a+=` (${o.dropEffectMessage})`),Cn(i,"drop",a),s.stopPropagation(),s.preventDefault()};if(Ob(s)){const o=D_(s,e);dh(s,o.dropEffect),r(o,`Drop to ${o.dropEffect} layer group as new ${n}`);return}if(wl(s)!==void 0){const o=w_(s,e,!1,!0);r(o,`Drop to ${o.dropEffect} layer as new ${n}`);return}}),i.addEventListener("drop",s=>{i.classList.remove("neuroglancer-drag-over"),kt(i,"drop");let r,o;if(Ob(s)){s.stopPropagation();try{o=JSON.parse(s.dataTransfer.getData(fh))}catch{return}if(r=hh(s,e,{forceCopy:!1,newTarget:!0}),r===void 0)return}else{if(r=hh(s,e,{forceCopy:uh()==="copy",newTarget:!0}),r===void 0)return;o=r.layoutSpec}if(!r.initializeExternalLayers(s)){if(!r.moveSupported)for(const c of r.layers.keys())c.dispose();return}s.preventDefault();const a=s.dataTransfer.dropEffect=uh();Cl(a);const l=t();r.updateArchiveStates(s);for(const c of r.layers.keys())l.layerSpecification.add(c);try{l.restoreState(o)}catch{l.layout.reset()}})}class El extends T.O8{constructor(e,t,n,s){super(),this.element=e,this.direction=t,this.container=s,this.changed=new j.IY,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(const r of n)this.insertChild(r)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){const t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",Bb(t,this.viewer.layerSpecification,()=>{const n=t.nextElementSibling;let s;return n!==null&&(s=tr.getFromElement(n)),this.insertChild({type:"viewer",layers:[]},s).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{at(t)}),t.addEventListener("pointerdown",n=>{if("button"in n&&n.button!==0)return;const s=t.nextElementSibling;if(s===null)return;const r=tr.getFromElement(s),o=t.previousElementSibling;if(o===null)return;const a=tr.getFromElement(o);n.preventDefault();const l=()=>{Cn(t,"drag",`Drag to resize, current ${Ji[this.direction]} ratio is ${a.flex.value} : ${r.flex.value}`)};l(),zt(n,c=>{const d=a.element.getBoundingClientRect(),u=r.element.getBoundingClientRect(),h=Math.max(.1,Math.min(.9,this.direction==="column"?(c.clientY-d.top)/(u.bottom-d.top):(c.clientX-d.left)/(u.right-d.left))),p=Number(a.flex.value)+Number(r.flex.value);a.flex.value=Math.round(h*p*100)/100,r.flex.value=Math.round((1-h)*p*100)/100,l()},()=>{kt(t,"drag")})}),t}get viewer(){return this.container.viewer}get(e){return tr.getFromElement(this.element.children[e*2+1])}insertChild(e,t){const n=new tr(this.viewer,e,this),s=this.makeDropPlaceholder(n);n.element.classList.add("neuroglancer-stack-layout-child"),n.registerDisposer(n.changed.add(this.changed.dispatch)),n.registerDisposer(()=>{this.element.removeChild(n.element),this.changed.dispatch()});const r=t!==void 0?t.element:null;return this.element.insertBefore(n.element,r),this.element.insertBefore(s,r),this.changed.dispatch(),n}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){const{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}}function R_(i,e){const t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(i.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new gh(t,e,i.viewer)}(0,f.Rf)(e);const n=(0,f.cQ)(e,"type",f.zr);switch(n){case"row":case"column":return new El(t,n,(0,f.cQ)(e,"children",s=>{const r=(0,f.$v)(s,o=>o);if(i.parent===void 0&&r.length===0)throw new Error("Stack layout requires at least one child.");return r}),i);case"viewer":{const s=i.viewer,r=new zg(s.layerSpecification.addRef()),o=new ro(t,{display:s.display,layerSpecification:r,...Vb(s)},{showLayerPanel:s.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:s.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(a){throw o.dispose(),a}return o}default:return new gh(t,e,i.viewer)}}class k_ extends T.O8{constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new tr(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}var P_=G(1152),A_=G(5093);/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const M_=Ae.fromObject({escape:{action:"cancel"}});class Fb extends T.O8{constructor(e){super(),this.layer=e,this.element=document.createElement("input");const{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";const n=this.registerDisposer(new yn(t,M_));n.allShortcutsAreGlobal=!0,Z(t,"cancel",s=>{this.updateView(),t.blur(),s.stopPropagation(),s.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){Jg(this.layer,this.element.value)}}class N_ extends T.O8{constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");const{element:t,measureElement:n}=this;t.classList.add("neuroglancer-layer-side-panel-type"),n.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(n);for(const[s,r]of Mr){if(r.type!==s)continue;const o=document.createElement("option");o.textContent=r.typeAbbreviation,o.value=s,t.appendChild(o)}t.addEventListener("change",()=>{const s=t.value,r=Mr.get(s);Zc(this.layer.managedLayer,r)}),this.updateView()}updateView(){const e=this.layer.type,{element:t,measureElement:n}=this;n.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${n.offsetWidth}px`}disposed(){this.measureElement.remove()}}class Tl extends ji{constructor(e,t){super(e,t.location),this.panelState=t;const n=this.layer=t.layer,{element:s}=this,{titleBar:r}=this.addTitleBar({});r.classList.add("neuroglancer-layer-side-panel-title"),r.appendChild(this.registerDisposer(new N_(n)).element),r.appendChild(this.registerDisposer(new Fb(n.managedLayer)).element),this.registerDisposer((0,_.W1)(l=>{s.dataset.neuroglancerLayerVisible=l.toString()},{get value(){return n.managedLayer.visible},changed:n.managedLayer.layerChanged}));const o=this.registerDisposer(new rn({get value(){return n.managedLayer.pickEnabled},set value(l){n.managedLayer.pickEnabled=l},changed:n.managedLayer.layerChanged},{svg:A_,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new en({get value(){return n.managedLayer.supportsPickOption},changed:n.managedLayer.layerChanged},o.element)),r.appendChild(o.element);const a={get value(){return t!==n.panels.panels[0]},set value(l){l?t.pin():t.unpin()},changed:n.manager.root.layerManager.layersChanged};r.appendChild(this.registerDisposer(new rn(a,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer((0,_.W1)(l=>{s.dataset.neuroglancerLayerPanelPinned=l.toString()},a)),r.appendChild(Mn({title:"Delete layer",onClick:()=>{Ms(this.layer.managedLayer)}})),this.tabView=new gx({makeTab:l=>n.tabs.options.get(l).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new _.pz({get value(){return t.tabs.map(l=>{const{label:c,hidden:d}=n.tabs.options.get(l);return{id:l,label:c,hidden:d?.value||!1}})},changed:t.tabsChanged})),handleTabElement:(l,c)=>{c.draggable=!0,c.addEventListener("dragstart",d=>{d.stopPropagation(),d.dataTransfer.setData("neuroglancer-side-panel","");let u="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(p=>p!==t&&p.location.visible)&&(u+=`, or move tab to other ${JSON.stringify(n.managedLayer.name)} panel`),Cn(c,"drag",u),this.sidePanelManager.startDrag({dropAsNewPanel:p=>{this.panelState.splitOffTab(l,{...Tg,...p})},canDropAsTabs:p=>p instanceof Tl&&p.layer===this.layer&&p!==this?1:0,dropAsTab:p=>{this.panelState.moveTabTo(l,p.panelState)}},d)}),c.addEventListener("dragend",d=>{kt(c,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof Tl&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){const e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{const{dragSource:n}=this.sidePanelManager,s=n?.canDropAsTabs?.(this);s&&(e.classList.add(_s),Cn(e,"drop",`Move ${s} ${s===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{kt(e,"drop"),e.classList.remove(_s)}),e.addEventListener("dragover",t=>{const{dragSource:n}=this.sidePanelManager;n?.canDropAsTabs?.(this)&&t.preventDefault()}),e.addEventListener("drop",t=>{kt(e,"drop");const{dragSource:n}=this.sidePanelManager;n?.canDropAsTabs?.(this)&&(e.classList.remove(_s),n.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class O_ extends T.O8{constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new Map,this.generation=0,this.layersNeedUpdate=!0;const n=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(n)),this.registerDisposer(t.layerManager.layersChanged.add(n)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){return this.selectedLayerState.layer?.layer??void 0}update(){if(!this.layersNeedUpdate)return;const{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;const{layerSidePanels:n}=this,s=r=>{let o=n.get(r);o===void 0?(o={generation:t,unregister:this.sidePanelManager.registerPanel({location:r.location,makePanel:()=>new Tl(this.sidePanelManager,r)})},n.set(r,o)):o.generation=t};{const r=this.getSelectedUserLayer(),{location:o}=this.selectedLayerState;if(r===void 0||!o.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:o,makePanel:()=>new ji(this.sidePanelManager,o)}));else{this.placeholderSelectedLayerPanel?.(),this.placeholderSelectedLayerPanel=void 0;const a=r.panels.panels[0];a.location.value=o.value,s(a)}}for(const r of e.managedLayers){const o=r.layer;if(o===null)continue;const{panels:a}=o.panels;for(let l=1,c=a.length;l<c;++l)s(a[l])}for(const[r,o]of n)o.generation!==t&&(o.unregister(),n.delete(r))}disposed(){this.placeholderSelectedLayerPanel?.();for(const{unregister:e}of this.layerSidePanels.values())e()}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const __={...Ui,side:"left",row:0};class V_{constructor(){this.location=new Si(__)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return(0,f.Zu)(this.location.toJSON())}}class B_ extends T.O8{constructor(e){super(),this.layer=e,this.element=document.createElement("div");const{element:t}=this,n=Ne({svg:P_,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),s=Ne({svg:_m,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(s),t.appendChild(n);const r=()=>{const o=this.layer.visible;n.style.display=o?"":"none",s.style.display=o?"none":""};r(),this.registerDisposer(e.layerChanged.add(r))}}function F_(i){const{selectedLayer:e}=i.manager.root,t=new rn({get value(){return e.layer===i&&e.visible},set value(n){n?(e.layer=i,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:rb});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}class U_ extends T.O8{constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;const{element:n,numberElement:s}=this;n.classList.add("neuroglancer-layer-list-panel-item"),s.classList.add("neuroglancer-layer-list-panel-item-number"),n.appendChild(this.registerDisposer(new pn({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),n.appendChild(s),n.appendChild(this.registerDisposer(new B_(t)).element),n.appendChild(this.registerDisposer(new Fb(t)).element),n.appendChild(this.registerDisposer(F_(t)).element);const r=Mn({title:"Delete layer",onClick:()=>{Ms(this.layer)}});r.classList.add("neuroglancer-layer-list-panel-item-delete"),n.appendChild(r),Ab(e,n,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),xl(e,n,t,!0),n.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),n.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}}class $_ extends ji{constructor(e,t,n){super(e,n.location),this.manager=t,this.state=n,this.items=new Map,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;const{itemContainer:s,layerDropZone:r}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,s.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(s),r.style.flex="1";const a=this.registerCancellable((0,Qe.t)(()=>this.render()));this.visibility.changed.add(a),this.registerDisposer(this.layerManager.layersChanged.add(a)),this.registerDisposer(this.selectedLayer.changed.add(a)),Mb(this),xl(this,r,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){const e=this,t=this.selectedLayer.layer,n=++this.generation;let s=0,r=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*a(){const{items:c}=e;let d=0;for(const h of e.layerManager.managedLayers)h.archived||++d;const u=`${(d+1).toString().length}ch`;for(const h of e.layerManager.managedLayers){h.visible?++s:h.archived?++o:++r;let p=c.get(h);p===void 0&&(p=e.registerDisposer(new U_(e,h)),c.set(h,p)),p.generation=n;const{nonArchivedLayerIndex:m}=h;p.numberElement.style.width=u,m===-1?p.numberElement.style.visibility="hidden":(p.numberElement.style.visibility="",p.numberElement.textContent=`${m+1}`),p.element.dataset.selected=(h===t).toString(),p.element.dataset.archived=h.archived.toString(),yield p.element}for(const[h,p]of c)n!==p.generation&&(c.delete(h),e.unregisterDisposer(p),p.dispose());yield e.layerDropZone}nn(this.itemContainer,a());let l="Layers";if(s||r||o){l+=" (";let c="";s+r&&(l+=`${s}/${r+s} visible`,c=", "),o&&(l+=`${c}${o} archived`),l+=")"}this.titleElement.textContent=l}}class G_ extends T.O8{constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");const t=this.registerCancellable((0,Qe.t)(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0;const{managedLayers:t}=this.layerManager;for(const s of t)s.archived&&++e;const{element:n}=this;if(e!==0){const s=t.length;n.textContent=`${s-e}/${s}`}else n.textContent=""}}var D2=G(6792),I2=G(8948),L2=G(1274),R2=G(795);/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const z_=100;class W_ extends Jr{constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=(0,Fe.A)(()=>{const r=this.textEditor.getValue();try{const o=JSON.parse(r);this.parsedValue=o,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(o){this.parsedValue=null,this.applyButton.disabled=!0;let a=0,l=0,c="Unknown parse error";if(o instanceof Error){const d=o.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(d!==null){c=d[1];const u=parseInt(d[2],10),p=r.substring(0,u).split(`
`);a=p.length-1,l=p[p.length-1].length}else c=o.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:c,severity:"error",from:Ti().Pos(a,l)}]})}},z_),this.content.classList.add("neuroglancer-state-editor");const t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;const n=this.closeButton=document.createElement("button");n.classList.add("close-button"),n.textContent="Close",this.content.appendChild(n),n.addEventListener("click",()=>this.dispose());const s=this.downloadButton=document.createElement("button");s.textContent="Download",s.title="Download state as a JSON file",this.content.appendChild(s),s.addEventListener("click",()=>this.downloadState()),this.textEditor=Ti()(r=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){const e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),n=URL.createObjectURL(t);e.href=n,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(Lo(this.viewer.state).value,null,"  ")}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const H_={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class J_{constructor(){this.location=new Si(H_)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return(0,f.Zu)(this.location.toJSON())}}function j_(i){const e=new Map;function t(n,s){if(n==null||typeof n!="object"){e.set(s,""+n);return}for(const r of Object.keys(n))t(n[r],s+"."+r)}return t(i,""),e}function Y_(i){const e=new Set;e.add(".type");const t=new Set;function n(s,r){for(const o of e)if(i[s].get(o)!==i[r].get(o))return!0;return!1}for(let s=0,r=i.length;s<r;++s){for(const a of i[s].keys())t.add(a);let o=[];for(let a=0;a<s;++a)n(s,a)||o.push(a);for(;o.length>0;){let a=o,l;for(const c of t){if(e.has(c))continue;const d=[];for(const u of o)i[u].get(c)===i[s].get(c)&&d.push(u);if(d.length<a.length&&(a=d,l=c),d.length===0)break}if(l===void 0)break;o=a,e.add(l)}}return Array.from(e)}function Q_(i,e){const t={};for(const n of e){const s=i.get(n);if(s!==void 0){if(n==="")return s;t[n]=s}}return JSON.stringify(t)}function K_(i){return Object.assign({type:i.RPC_TYPE_ID},i.key||{})}function q_(i){const e=i.map(j_),t=Y_(e);return e.map(n=>Q_(n,t))}const X_=1e3,mh=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:i=>{let e=0;for(let t=0;t<Xl;++t)e+=i[Pi(t,ri.VISIBLE)*Un+oi.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:i=>i[Pi(Ue.DOWNLOADING,ri.VISIBLE)*Un+oi.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:i=>i[Pi(Ue.SYSTEM_MEMORY,ri.VISIBLE)*Un+oi.numChunks]+i[Pi(Ue.SYSTEM_MEMORY_WORKER,ri.VISIBLE)*Un+oi.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:i=>i[Pi(Ue.GPU_MEMORY,ri.VISIBLE)*Un+oi.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:i=>i[Pi(Ue.FAILED,ri.VISIBLE)*Un+oi.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:i=>i[Pi(Ue.GPU_MEMORY,ri.VISIBLE)*Un+oi.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:i=>i[tp(ec.totalTime)]/i[tp(ec.totalChunks)]}];class Z_ extends ji{constructor(e,t,n){super(e,n.location),this.chunkQueueManager=t,this.displayState=n,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable((0,Fe.A)(()=>this.updateView(),0));const{body:s}=this;s.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(s),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;const{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},X_)})}updateView(){const{data:e}=this;if(e===void 0)return;const t=document.createElement("table"),n=[];for(const[a,l]of e){const c=[a];for(const{getter:d}of mh)c.push(d(l));n.push(c)}const s=q_(n.map(a=>K_(a[0]))),r=new Map;s.forEach((a,l)=>{r.set(n[l][0],a)});{const a=document.createElement("thead");let l=document.createElement("tr");a.appendChild(l);const c=u=>{const h=document.createElement("td");h.textContent=u,l.appendChild(h)};c("Name");let d;for(const{label:u}of mh){const h=u.indexOf("/");let p=u;if(h!==-1){if(p=u.substring(0,h),p===d){++l.lastElementChild.colSpan;continue}d=p}c(p)}l=document.createElement("tr"),a.appendChild(l);{const u=document.createElement("td");l.appendChild(u)}for(const{label:u}of mh){const h=u.indexOf("/");let p="";h!==-1&&(p=u.substring(h+1));const m=document.createElement("td");m.textContent=p,l.appendChild(m)}t.appendChild(a)}const o=document.createElement("tbody");for(const[a,...l]of n){const c=document.createElement("tr"),d=u=>{const h=document.createElement("td");h.textContent=u,c.appendChild(h)};d(r.get(a));for(const u of l)d(""+u);o.appendChild(c)}t.appendChild(o),Me(this.body),this.body.appendChild(t)}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const eV={...Ui,side:"left",row:2};class tV{constructor(){this.location=new Si(eV)}get changed(){return this.location.changed}toJSON(){return(0,f.Zu)(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class nV extends ji{constructor(e,t,n){super(e,t.location),this.addTitleBar({title:"Settings"});const s=document.createElement("div");s.classList.add("neuroglancer-settings-body");const r=document.createElement("div");r.classList.add("neuroglancer-settings-scroll-container"),s.appendChild(r),this.addBody(s);{const c=this.registerDisposer(new lm(n.title));c.element.placeholder="Title",c.element.classList.add("neuroglancer-settings-title"),r.appendChild(c.element)}const o=(c,d)=>{const u=this.registerDisposer(new Ic(d,{label:c}));u.element.classList.add("neuroglancer-settings-limit-widget"),r.appendChild(u.element)};o("GPU memory limit",n.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",n.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",n.chunkQueueManager.capacities.download.itemLimit);const a=(c,d)=>{const u=document.createElement("label");u.textContent=c;const h=this.registerDisposer(new pn(d));u.appendChild(h.element),r.appendChild(u)};a("Show axis lines",n.showAxisLines),a("Show scale bar",n.showScaleBar),a("Show cross sections in 3-d",n.showPerspectiveSliceViews),a("Show default annotations",n.showDefaultAnnotations),a("Show chunk statistics",n.statisticsDisplayState.location.watchableVisible),a("Wire frame rendering",n.wireFrame),a("Enable prefetching",n.chunkQueueManager.enablePrefetch),a("Enable adaptive downsampling",n.enableAdaptiveDownsampling);const l=(c,d)=>{const u=document.createElement("label");u.textContent=c;const h=this.registerDisposer(new hi(d));u.appendChild(h.element),r.appendChild(u)};l("Cross-section background",n.crossSectionBackgroundColor),l("Projection background",n.perspectiveViewBackgroundColor)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iV extends T.O8{constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable((0,Qe.t)(()=>{let{viewContext:s}=this;s!==void 0&&(this.unregisterDisposer(s),s.dispose()),this.viewContext=s=this.registerDisposer(new T.O8),Me(this.element);const{selectedTool:r}=this;r!==void 0&&this.element.appendChild(this.makeWidget(s,r));const o=Array.from(this.toolBinder.bindings);o.sort(([a],[l])=>(0,kr.e)(a,l));for(const[,a]of o)this.element.appendChild(this.makeWidget(s,a))}));const{element:n}=this;n.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){const e=this.selectedLayer.layer;if(e===void 0)return;const t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){const{unbindPreviousLayer:e}=this;e!==void 0&&e();const t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){const{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){const n=document.createElement("div");n.title="dblclick \u2192 unbind",t instanceof Oo&&(n.title+=", click \u2192 bind key"),n.className="neuroglancer-annotation-tool-status-widget";const s=document.createElement("div");s.className="neuroglancer-annotation-tool-status-widget-layer-number";const r=document.createElement("div");if(r.className="neuroglancer-annotation-tool-status-widget-description",r.textContent=t.description,n.addEventListener("dblclick",()=>{t instanceof Df?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Oo){const a=document.createElement("div");a.className="neuroglancer-annotation-tool-status-widget-key",a.textContent=t.keyBinding,n.appendChild(a),Rf(e,n,l=>t.localBinder.set(l,t.addRef()))}const o=t.context;if(o instanceof Rn){const{managedLayer:a}=o;a.manager.rootLayers.updateNonArchivedLayerIndices();const l=a.nonArchivedLayerIndex;s.textContent=(l+1).toString(),n.appendChild(s)}return n.appendChild(r),n}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sV extends T.O8{constructor(e,t){super(),this.gl=e,this.frameNumberCounter=t,this.worker=new Worker(new URL(G.p+G.u(717),G.b),{type:"module"}),this.chunkQueueManager=this.registerDisposer(new Vc(new ZC(this.worker,!0),this.gl,this.frameNumberCounter,{gpuMemory:new Zo({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Zo({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Zo({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Zo({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Bc(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}}class k2 extends QO{constructor(){super(...arguments),this.global=new Ae}}const Ub=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],$b=[...Ub,"showLayerPanel","showLayerHoverValues"],Gb=[...$b,"showUIControls","showPanelBorders"];function rV(){return Object.fromEntries(Gb.map(i=>[i,new nt(!0)]))}function oV(i,e){for(const t of Gb){const n=e[t];n!==void 0&&(i[t].value=n)}}const aV=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS<"u"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class lV extends fr{constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("velocity",e.velocity),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("enableAdaptiveDownsampling",e.enableAdaptiveDownsampling),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer),this.add("toolBindings",e.toolBinder)}restoreState(e){const{viewer:t}=this;super.restoreState(e),(0,f.MM)(e,"navigation",n=>{(0,f.Rf)(n),(0,f.MM)(n,"pose",s=>{(0,f.Rf)(s),(0,f.MM)(s,"position",r=>{(0,f.Rf)(r),Mt(r,"voxelCoordinates",t.position),(0,f.MM)(r,"voxelSize",o=>{const a=(0,f.Xu)(new Float64Array(3),o,f.Mo);for(let l=0;l<3;++l)a[l]*=1e-9;t.coordinateSpace.value=Oe({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:a})})}),Mt(s,"orientation",t.crossSectionOrientation)}),Mt(n,"zoomFactor",t.crossSectionScale.legacyJsonView)}),Mt(e,"perspectiveOrientation",t.projectionOrientation),Mt(e,"perspectiveZoom",t.projectionScale.legacyJsonView),Mt(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}class zb extends T.O8{constructor(e,t={}){super(),this.display=e,this.title=new _.DN(void 0,f.zr),this.coordinateSpace=new zl,this.position=this.registerDisposer(new ui(this.coordinateSpace)),this.velocity=this.registerDisposer(new gc(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new Qp(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new ef(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new Zp(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new bs),this.crossSectionScale=this.registerDisposer(new Zw(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new bs),this.crossSectionDepthRange=this.registerDisposer(new Sc(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new Sc(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new ex(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new ws(new Cs(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new ws(new Cs(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new OT,this.layerManager=this.registerDisposer(new Mg),this.selectedLayer=this.registerDisposer(new GT(this.layerManager.addRef())),this.showAxisLines=new nt(!0,!0),this.wireFrame=new nt(!1,!1),this.enableAdaptiveDownsampling=new nt(!0,!0),this.showScaleBar=new nt(!0,!0),this.showPerspectiveSliceViews=new nt(!0,!0),this.visibleLayerRoles=aw(),this.showDefaultAnnotations=new nt(!0,!0),this.crossSectionBackgroundColor=new q(C.eR.fromValues(.5,.5,.5)),this.perspectiveViewBackgroundColor=new q(C.eR.fromValues(0,0,0)),this.scaleBarOptions=new IO,this.partialViewport=new YC,this.statisticsDisplayState=new J_,this.helpPanelState=new p_,this.settingsPanelState=new tV,this.layerSelectedValues=this.registerDisposer(new _T(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new VT(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new _.DN("",f.zr),this.layerListPanelState=new V_,this.resetInitiated=new j.IY,this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(p,m)=>{m.registerDisposer(this.inputEventBindings.sliceView.addParent(p,Number.POSITIVE_INFINITY)),m.registerDisposer(this.inputEventBindings.perspectiveView.addParent(p,Number.POSITIVE_INFINITY))},this.globalToolBinder=this.registerDisposer(new Rx(this.toolInputEventMapBinder)),this.toolBinder=this.registerDisposer(new Dc(this,this.globalToolBinder));const{dataContext:n=new sV(e.gl,e),visibility:s=new vt(vt.VISIBLE),inputEventBindings:r={global:new Ae,sliceView:new Ae,perspectiveView:new Ae},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:a=LP({credentialsManager:Zn}),uiConfiguration:l=rV()}=t;this.visibility=s,this.inputEventBindings=r,this.element=o,this.dataSourceProvider=a,this.uiConfiguration=l,this.registerDisposer((0,_.W1)(p=>{this.display.applyWindowedViewportToElement(o,p)},this.partialViewport)),this.registerDisposer(()=>at(this.element)),this.dataContext=this.registerDisposer(n),oV(l,t);const c={...aV,...t},{resetStateWhenEmpty:d,showLayerDialog:u}=c;for(const p of $b)this.uiControlVisibility[p]=this.makeUiControlVisibilityState(p);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=u,this.resetStateWhenEmpty=d,this.layerSpecification=new HT(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.globalToolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(li.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(li.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));const h=this.registerCancellable((0,Fe.A)(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!au&&this.showLayerDialog&&this.visibility.visible&&Qg(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(h),h(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(Nb(o,this.navigationState.position)),this.state=new lV(this),this.registerDisposer(new mc(this.display,this.position,this.velocity))}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}makeUiControlVisibilityState(e){const t=this.uiConfiguration.showUIControls,n=this.uiConfiguration[e];return this.registerDisposer((0,_.Kk)((s,r)=>s&&r,t,n))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){const{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){const e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";const n=this.registerDisposer(new xs(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner,{velocity:this.velocity,getToolBinder:()=>this.toolBinder}));this.registerDisposer(new en(this.uiControlVisibility.showLocation,n.element)),t.appendChild(n.element);const s=this.registerDisposer(new Bx(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(s.element.style.flex="1",s.element.style.alignSelf="center",this.registerDisposer(new en(this.uiControlVisibility.showLocation,s.element)),t.appendChild(s.element),typeof NEUROGLANCER_CREDIT_LINK<"u"){let a=NEUROGLANCER_CREDIT_LINK;Array.isArray(a)||(a=[a]);for(const{url:l,text:c}of a){const d=document.createElement("a");d.style.marginRight="5px",d.href=l,d.textContent=c,d.style.fontFamily="sans-serif",d.style.color="yellow",d.target="_blank",t.appendChild(d)}}const r=this.registerDisposer(new iV(this.selectedLayer,this.globalToolBinder));if(t.appendChild(r.element),this.registerDisposer(new en(this.uiControlVisibility.showAnnotationToolStatus,r.element)),l_){const a=this.registerDisposer(new c_(this));t.appendChild(a.element)}{const{layerListPanelState:a}=this,l=this.registerDisposer(new rn(a.location.watchableVisible,{svg:lO,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));l.element.insertAdjacentElement("afterbegin",this.registerDisposer(new G_(this.layerManager)).element),this.registerDisposer(new en(this.uiControlVisibility.showLayerListPanelButton,l.element)),t.appendChild(l.element)}{const{selectionDetailsState:a}=this,l=this.registerDisposer(new rn(a.location.watchableVisible,{svg:cO,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new en(this.uiControlVisibility.showSelectionPanelButton,l.element)),t.appendChild(l.element)}{const{selectedLayer:a}=this,l=this.registerDisposer(new rn({get value(){return a.visible},set value(c){a.visible=c},changed:a.location.locationChanged},{svg:rb,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new en(this.uiControlVisibility.showLayerSidePanelButton,l.element)),t.appendChild(l.element)}{const a=Ne({text:"{}",title:"Edit JSON state"});this.registerEventListener(a,"click",()=>{this.editJsonState()}),this.registerDisposer(new en(this.uiControlVisibility.showEditStateButton,a)),t.appendChild(a)}{const{helpPanelState:a}=this,l=this.registerDisposer(new rn(a.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new en(this.uiControlVisibility.showHelpButton,l.element)),t.appendChild(l.element)}{const{settingsPanelState:a}=this,l=this.registerDisposer(new rn(a.location.watchableVisible,{svg:dO,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new en(this.uiControlVisibility.showSettingsButton,l.element)),t.appendChild(l.element)}this.registerDisposer(new en((0,_.Kk)((...a)=>a.reduce((l,c)=>l||c,!1),...Ub.map(a=>this.uiControlVisibility[a])),t)),e.appendChild(t),this.layout=this.registerDisposer(new k_(this,"4panel")),this.sidePanelManager=this.registerDisposer(new ND(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new $_(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new O_(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new OD(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new Z_(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{const{inputEventBindings:a}=this;return new f_(this.sidePanelManager,this.helpPanelState,[["Global",a.global],["Cross section view",a.sliceView],["3-D projection view",a.perspectiveView]],this.layerManager,this.globalToolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new nV(this.sidePanelManager,this.settingsPanelState,this)}));const o=()=>{const a=this.visibility.visible;a!==this.visible&&(e.style.visibility=a?"inherit":"hidden",this.visible=a)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){const{element:e}=this;this.registerDisposer(new yn(e,this.inputEventMap)),this.registerDisposer(new za(e))}bindAction(e,t){this.registerDisposer(Z(this.element,e,t))}registerActionListeners(){for(const t of["recolor","clear-segments"])this.bindAction(t,()=>{this.layerManager.invokeAction(t)});const e=t=>{const n=this.selectedLayer.layer?.layer;n&&n.dispatchLayerEvent(t)};this.bindAction("select-previous",()=>{e("select-previous")}),this.bindAction("select-next",()=>{e("select-next")});for(const t of["select","star"])this.bindAction(t,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(t)});this.bindAction("help",()=>this.toggleHelpPanel());for(let t=1;t<=9;++t)this.bindAction(`toggle-layer-${t}`,()=>{const n=this.layerManager.getLayerByNonArchivedIndex(t-1);n!==void 0&&n.setVisible(!n.visible)}),this.bindAction(`toggle-pick-layer-${t}`,()=>{const n=this.layerManager.getLayerByNonArchivedIndex(t-1);n!==void 0&&(n.pickEnabled=!n.pickEnabled)}),this.bindAction(`select-layer-${t}`,()=>{const n=this.layerManager.getLayerByNonArchivedIndex(t-1);n!==void 0&&(this.selectedLayer.layer=n,this.selectedLayer.visible=!0)});for(let t=0;t<26;++t){const n=String.fromCharCode(65+t);this.bindAction(`tool-${n}`,()=>{this.activateTool(n)})}this.bindAction("annotate",()=>{const t=this.selectedLayer.layer;if(t===void 0){pe.showTemporaryMessage("The annotate command requires a layer to be selected.");return}const n=t.layer;if(n===null||n.tool.value===void 0){pe.showTemporaryMessage(`The selected layer (${JSON.stringify(t.name)}) does not have an active annotation tool.`);return}n.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e,t){this.globalToolBinder.activate(e,t)}editJsonState(){new W_(this)}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){const{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}isReady(){if(this.chunkQueueManager.flushPendingChunkUpdates(),!this.display.isReady())return!1;for(const e of this.layerManager.managedLayers)if(!e.isReady())return!1;return!0}}$x(zb),zx(ro),Gx(Rn);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function cV(i={}){try{let{target:e=document.getElementById("neuroglancer-container")}=i;e===null&&(e=document.createElement("div"),e.id="neuroglancer-container",document.body.appendChild(e));const t=new QC(e);return new zb(t,i)}catch(e){throw pe.showMessage(`Error: ${e.message}`),e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function dV(i){return YN(),QN(),cV(i)}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uV(i){const e=(0,Qe.t)(()=>{const n=i.value?.trim();n?document.title=`${n} - neuroglancer`:document.title="neuroglancer"}),t=i.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hV(i){return encodeURI(i).replace(/[!'()*;,]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())}class pV extends T.O8{constructor(e,t,n={}){super(),this.root=e,this.credentialsManager=t,this.parseError=new _.B0(void 0);const{updateDelayMilliseconds:s=200,defaultFragment:r="{}"}=n;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());const o=(0,Fe.A)(()=>this.setUrlHash(),s,{maxWait:s*2});this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=r}setUrlHash(){const e=Lo(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;const n=hV(JSON.stringify(e.value));n!==this.prevStateString&&(this.prevStateString=n,decodeURIComponent(n)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+n))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){const t=e.substring(2),{url:n,credentialsProvider:s}=wn(t,this.credentialsManager);pe.forPromise(Nt(s,n,{},ke.cj).then(r=>{(0,f.Rf)(r),this.root.reset(),this.root.restoreState(r)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);const t=(0,f.Sf)(e);(0,f.Rf)(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();const t=(0,f.Sf)(e);(0,f.Rf)(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fV=typeof{keym:{layer:"segmentation",tool:"grapheneMergeSegments",provider:"graphene"},keyc:{layer:"segmentation",tool:"grapheneMulticutSegments",provider:"graphene"},keyf:{layer:"segmentation",tool:"grapheneFindPath",provider:"graphene"},keyx:!1,"control+shift+keyx":"clear-segments",bracketleft:"select-previous",bracketright:"select-next"}<"u"&&Object.keys({keym:{layer:"segmentation",tool:"grapheneMergeSegments",provider:"graphene"},keyc:{layer:"segmentation",tool:"grapheneMulticutSegments",provider:"graphene"},keyf:{layer:"segmentation",tool:"grapheneFindPath",provider:"graphene"},keyx:!1,"control+shift+keyx":"clear-segments",bracketleft:"select-previous",bracketright:"select-next"}).length>0;function gV(){const i=window.viewer=dV();RD(i.inputEventBindings);const e=(n,s,r,o)=>{let a,l;typeof n=="string"&&(n={type:n}),(0,f.Rf)(n);const c=(0,f.cQ)(n,"type",f.zr);i.bindAction(`tool-${c}`,()=>{const d=i.layerManager.managedLayers.filter(u=>{const h=u.layer instanceof r;if(o&&h){for(const p of u.layer?.dataSources||[])if(i.dataSourceProvider.getProvider(p.spec.url)[2]===o)return!0;return!1}else return h});if(d.length>0){const u=d[0].layer;u&&(u!==l&&(a=Tc(u,n),l=u),a&&i.activateTool(s,a))}})};if(fV){const n=(s,r)=>{s.delete(r);for(const o of s.parents)n(o,r)};for(const[s,r]of Object.entries({keym:{layer:"segmentation",tool:"grapheneMergeSegments",provider:"graphene"},keyc:{layer:"segmentation",tool:"grapheneMulticutSegments",provider:"graphene"},keyf:{layer:"segmentation",tool:"grapheneFindPath",provider:"graphene"},keyx:!1,"control+shift+keyx":"clear-segments",bracketleft:"select-previous",bracketright:"select-next"}))if(n(i.inputEventBindings.global,s),n(i.inputEventBindings.perspectiveView,s),n(i.inputEventBindings.sliceView,s),typeof r=="string")i.inputEventBindings.global.set(s,r);else if(typeof r!="boolean"){i.inputEventBindings.global.set(s,`tool-${r.tool}`);const o=Mr.get(r.layer);if(o){const a=s.charAt(s.length-1).toUpperCase();e(r.tool,a,o,r.provider)}}}const t=i.registerDisposer(new pV(i.state,i.dataSourceProvider.credentialsManager,{defaultFragment:typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT<"u"?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));return i.registerDisposer(t.parseError.changed.add(()=>{const{value:n}=t.parseError;n!==void 0&&(new pe().setErrorMessage(`Error parsing state: ${n.message}`),console.log("Error parsing state",n)),t.parseError})),t.updateFromUrlHash(),i.registerDisposer(uV(i.title)),HN(i),jN(i),i}var P2=G(8626);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */gV()}},Hb={};function _e(se){var Ee=Hb[se];if(Ee!==void 0)return Ee.exports;var G=Hb[se]={exports:{}};return Wb[se].call(G.exports,G,G.exports,_e),G.exports}_e.m=Wb,_e.x=()=>{var se=_e.O(void 0,[562,993,367],()=>_e(4320));return se=_e.O(se),se},(()=>{var se=[];_e.O=(Ee,G,_,F)=>{if(G){F=F||0;for(var fe=se.length;fe>0&&se[fe-1][2]>F;fe--)se[fe]=se[fe-1];se[fe]=[G,_,F];return}for(var C=1/0,fe=0;fe<se.length;fe++){for(var[G,_,F]=se[fe],ye=!0,Le=0;Le<G.length;Le++)(F&!1||C>=F)&&Object.keys(_e.O).every(tt=>_e.O[tt](G[Le]))?G.splice(Le--,1):(ye=!1,F<C&&(C=F));if(ye){se.splice(fe--,1);var We=_();We!==void 0&&(Ee=We)}}return Ee}})(),_e.n=se=>{var Ee=se&&se.__esModule?()=>se.default:()=>se;return _e.d(Ee,{a:Ee}),Ee},_e.d=(se,Ee)=>{for(var G in Ee)_e.o(Ee,G)&&!_e.o(se,G)&&Object.defineProperty(se,G,{enumerable:!0,get:Ee[G]})},_e.f={},_e.e=se=>Promise.all(Object.keys(_e.f).reduce((Ee,G)=>(_e.f[G](se,Ee),Ee),[])),_e.u=se=>se===717?"neuroglancer_chunk_worker.6de531489d574d806f47.js":""+se+"."+{367:"ad6071abcab399305157",562:"1d0cecad9cc0725955f0",993:"ca23372ceee17151541a"}[se]+".js",_e.miniCssF=se=>{},_e.o=(se,Ee)=>Object.prototype.hasOwnProperty.call(se,Ee),_e.r=se=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(se,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(se,"__esModule",{value:!0})},(()=>{var se;if(typeof import.meta.url=="string"&&(se=import.meta.url),!se)throw new Error("Automatic publicPath is not supported in this browser");se=se.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),_e.p=se})(),(()=>{_e.b=new URL("./",import.meta.url);var se={792:0},Ee=G=>{var{ids:_,modules:F,runtime:fe}=G,C,ye,Le=0;for(C in F)_e.o(F,C)&&(_e.m[C]=F[C]);for(fe&&fe(_e);Le<_.length;Le++)ye=_[Le],_e.o(se,ye)&&se[ye]&&se[ye][0](),se[_[Le]]=0;_e.O()};_e.f.j=(G,_)=>{var F=_e.o(se,G)?se[G]:void 0;if(F!==0)if(F)_.push(F[1]);else{var fe=import("./"+_e.u(G)).then(Ee,C=>{throw se[G]!==0&&(se[G]=void 0),C}),fe=Promise.race([fe,new Promise(C=>F=se[G]=[C])]);_.push(F[1]=fe)}},_e.O.j=G=>se[G]===0})(),(()=>{var se=_e.x;_e.x=()=>Promise.all([562,993,367].map(_e.e,_e)).then(se)})();var N2=_e.x();

//# sourceMappingURL=main.cb26101b553ed6b82856.js.map