(()=>{"use strict";var e={8522:function(e,t,r){e.exports=r.p+"09f21dcf7b4f13e8.wasm"},4066:function(e,t,r){r.d(t,{BA:function(){return s}});var i,n=r(9754);var s=((i={})[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED",i);new n.E(0xffffffff,0xffffffff)},3719:function(e,t,r){r.d(t,{SN:function(){return a},TU:function(){return o},Uw:function(){return l}});var i=r(2902),n=r(106),s=r(566);class a{value_;get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}changed;constructor(e){this.value_=e,this.changed=new s.K_}}class o extends a{validator;defaultValue;constructor(e,t,r=e){super(e),this.validator=t,this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(void 0!==e){let{validator:t}=this;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}function l(e,...t){let r=t.map(e=>e.value),s=t.length,a=new n.gj,o=e(a,...r),u=(0,i.Z)(()=>{let i=!1;for(let e=0;e<s;++e){let n=t[e].value;r[e]!==n&&(r[e]=n,i=!0)}i&&(a.dispose(),o=e(a=new n.gj,...r))},0),h=t.map(e=>e.changed.add(u));return{flush(){u.flush()},dispose(){u.cancel(),(0,n.k1)(h),a.dispose()},get value(){return u.flush(),o}}}n.gj,n.gj,n.gj,n.gj,n.gj,Symbol.iterator},106:function(e,t,r){r.d(t,{IF:function(){return s},gj:function(){return n},k1:function(){return i}});function i(e){for(let r=e.length;r>0;--r){var t;"object"==typeof(t=e[r-1])?t.dispose():t()}}class n{refCount=1;wasDisposed;disposers;addRef(){return++this.refCount,this}disposedStacks;dispose(){if(0==--this.refCount)this.refCountReachedZero()}[Symbol.dispose](){this.dispose()}refCountReachedZero(){this.disposed();let{disposers:e}=this;void 0!==e&&(i(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return null==t?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(null!=t){let r=t.indexOf(e);-1!==r&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){var n,s,a,o;this.registerDisposer((n=e,s=t,a=r,o=i,n.addEventListener(s,a,o),()=>n.removeEventListener(s,a,o)))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class s extends n{value;constructor(e){super(),this.value=e}}},3783:function(e,t,r){r.d(t,{$k:function(){return h},Fi:function(){return g},R3:function(){return n},Rq:function(){return v},V2:function(){return S},_E:function(){return i},_Z:function(){return p},b$:function(){return l},bZ:function(){return y},e6:function(){return w},gf:function(){return a},iG:function(){return b},m0:function(){return c},n_:function(){return d},rn:function(){return u},th:function(){return m},vh:function(){return s},vx:function(){return f},wO:function(){return o}});var i=r(5975),n=r(7160),s=r(8333),a=r(2945),o=r(5600);i.create(),n.fromValues(1,0,0),n.fromValues(0,1,0),n.fromValues(0,0,1);let l=n.fromValues(0,0,0);s.fromValues(0,0,0,0);let u=n.fromValues(1,1,1),h=n.fromValues(1/0,1/0,1/0);function d(e){return e[0]*e[1]*e[2]}function c(e){return`${e[0]},${e[1]},${e[2]}`}function f(e,t,r){let i=t[0],n=t[1],s=t[2];return e[0]=r[0]*i+r[4]*n+r[8]*s,e[1]=r[1]*i+r[5]*n+r[9]*s,e[2]=r[2]*i+r[6]*n+r[10]*s,e}function p(e,t,r){let i=t[0],n=t[1],s=t[2];return e[0]=r[0]*i+r[1]*n+r[2]*s,e[1]=r[4]*i+r[5]*n+r[6]*s,e[2]=r[8]*i+r[9]*n+r[10]*s,e}function g(e,t,r,n,s){return e[0]=n[0],e[1]=n[1],e[2]=n[2]*s,i.fromRotationTranslationScale(e,r,t,e)}function y(e,t){let r=t[0],i=t[1],n=t[2],s=t[4],a=t[5],o=t[6],l=t[8],u=t[9],h=t[10];return e[0]=r,e[1]=i,e[2]=n,e[3]=s,e[4]=a,e[5]=o,e[6]=l,e[7]=u,e[8]=h,e}function m(e,t){let r=t[0],i=t[1],n=t[2],s=t[3],a=t[4],o=t[5],l=t[6],u=t[7],h=t[8],d=t[9],c=t[10],f=t[11],p=t[12],g=t[13],y=t[14],m=t[15];e[0]=s+r,e[1]=u+a,e[2]=f+h,e[3]=m+p,e[4]=s-r,e[5]=u-a,e[6]=f-h,e[7]=m-p,e[8]=s+i,e[9]=u+o,e[10]=f+d,e[11]=m+g,e[12]=s-i,e[13]=u-o,e[14]=f-d,e[15]=m-g;let v=s+n,b=u+l,w=f+c,S=s-n,k=u-l,E=f-c,I=Math.sqrt(v**2+b**2+w**2);e[16]=v/I,e[17]=b/I,e[18]=w/I,e[19]=(m+y)/I;let M=Math.sqrt(S**2+k**2+E**2);return e[20]=S/M,e[21]=k/M,e[22]=E/M,e[23]=(m-y)/M,e}function v(e,t,r,i,n,s,a){for(let o=0;o<6;++o){let l=a[4*o],u=a[4*o+1],h=a[4*o+2];if(Math.max(l*e,l*i)+Math.max(u*t,u*n)+Math.max(h*r,h*s)+a[4*o+3]<0)return!1}return!0}function b(e,t,r,i,n,s,a){for(let o=0;o<4;++o){let l=a[4*o],u=a[4*o+1],h=a[4*o+2];if(Math.max(l*e,l*i)+Math.max(u*t,u*n)+Math.max(h*r,h*s)+a[4*o+3]<0)return!1}{let o=a[20],l=a[21],u=a[22],h=a[23],d=Math.max(o*e,o*i)+Math.max(l*t,l*n)+Math.max(u*r,u*s),c=1e-6*Math.abs(h);if(Math.min(o*e,o*i)+Math.min(l*t,l*n)+Math.min(u*r,u*s)>-h+c||d<-h-c)return!1}return!0}function w(e){if(1===e[15]){let t=2/Math.abs(e[10]),r=2/Math.abs(e[0]);return r*(2/Math.abs(e[5]))*t}let t=e[10],r=2*e[14]/(2*t-2);return 4/(e[0]*e[5])/3*(Math.abs((t-1)*r/(t+1))**3-Math.abs(r)**3)}function S(e){if(1===e[15])return 2/Math.abs(e[10]);let t=e[10],r=2*e[14]/(2*t-2);return Math.abs((t-1)*r/(t+1)-r)}a.create(),n.create()},290:function(e,t,r){function i(e){let t=typeof e;if("number"===t||"string"===t){let t=parseFloat(""+e);if(!Number.isNaN(t))return t}throw Error(`Expected floating-point number, but received: ${JSON.stringify(e)}.`)}function n(e){let t=i(e);if(Number.isFinite(t))return t;throw Error(`Expected finite floating-point number, but received: ${t}.`)}function s(e){let t=i(e);if(Number.isFinite(t)&&t>=0)return t;throw Error(`Expected finite non-negative floating-point number, but received: ${t}.`)}function a(e){let t=n(e);if(t>0)return t;throw Error(`Expected positive finite floating-point number, but received: ${t}.`)}function o(e,t){let r=e.length;if(!Array.isArray(t)||t.length!==r)throw Error("Incompatible sizes");for(let e=0;e<r;++e)if(!Number.isFinite(parseFloat(t[e])))throw Error("Non-finite value.");for(let i=0;i<r;++i)e[i]=parseFloat(t[i]);return e}r.d(t,{C$:function(){return m},CT:function(){return E},Iw:function(){return g},JG:function(){return C},Kh:function(){return S},PT:function(){return y},Qu:function(){return M},ZE:function(){return v},_b:function(){return o},c6:function(){return c},f6:function(){return f},hd:function(){return function e(t){if("object"==typeof t){if(null===t)return"null";if(Array.isArray(t)){let r="[",i=t.length,n=0;if(0<i)for(r+=e(t[n]);++n<i;)r+=",",r+=e(t[n]);return r+="]"}let r="{",i=Object.keys(t).sort(),n=0,s=i.length;if(n<s){let a=i[n];for(r+=JSON.stringify(a),r+=":",r+=e(t[a]);++n<s;)r+=",",r+=JSON.stringify(a=i[n]),r+=":",r+=e(t[a])}return r+="}"}return JSON.stringify(t)}},j2:function(){return k},jz:function(){return n},kt:function(){return b},lu:function(){return s},m7:function(){return p},nH:function(){return i},o7:function(){return a},uq:function(){return w},zE:function(){return I}}),r(3783);let l=/('(?:[^'\\]|(?:\\.))*')/,u=/("(?:[^"\\]|(?:\\.))*")/,h=RegExp(`${l.source}|${u.source}`);RegExp(`${u.source}|${l.source}`);let d=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/;function c(e){return JSON.parse(function(e){let t="";for(;e.length>0;){let r,i;let n=e.match(h);if(null===n)r=e,e="",i="";else{r=e.substr(0,n.index),e=e.substr(n.index+n[0].length);let t=n[1];if(void 0!==t)i=function(e,t,r,i){if(e.length>=2&&"'"===e.charAt(0)&&e.charAt(e.length-1)===t){let n=e.substr(1,e.length-2),s='"';for(;n.length>0;){let e=n.match(i);if(null===e){s+=n;break}s+=e[1],e[2]===r?(s+="\\",s+=r):s+=t,n=n.substr(e.index+e[0].length)}return s+=r}return e}(t,"'",'"',d);else i=n[2]}t+=r.replace(/\(/g,"[").replace(/\)/g,"]").replace("True","true").replace("False","false").replace(/,\s*([}\]])/g,"$1"),t+=i}return t}(e))}function f(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);if(void 0!==t&&e.length!==t)throw Error(`Expected array of length ${t}, but received: ${JSON.stringify(e)}.`);return e}function p(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);return e.map(t)}function g(e,t,r){let i=e.length;if(!Array.isArray(t)||t.length!==i)throw Error(`Expected length ${i} array, but received: ${JSON.stringify(t)}.`);for(let n=0;n<i;++n)e[n]=r(t[n],n);return e}function y(e){if("object"!=typeof e||null==e||Array.isArray(e))throw Error(`Expected JSON object, but received: ${JSON.stringify(e)}.`);return e}function m(e){let t=parseInt(e,10);if(!Number.isInteger(t))throw Error(`Expected integer, but received: ${JSON.stringify(e)}.`);return t}function v(e){if("string"!=typeof e)throw Error(`Expected string, but received: ${JSON.stringify(e)}.`);return e}function b(e){if(void 0!==e)return v(e)}function w(e,t,r){let i=Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0;try{return r(i)}catch(e){throw Error(`Error parsing ${JSON.stringify(t)} property: ${e.message}`)}}function S(e,t,r,i){return w(e,t,e=>void 0===e?i:r(e))}function k(e){if("number"!=typeof e||!Number.isFinite(e)||e<0||e>1)throw Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(e)}.`);return e}function E(e,t,r=/^[a-zA-Z]/){if("string"==typeof e&&null!==e.match(r)){let r=e.toUpperCase();if(Object.prototype.hasOwnProperty.call(t,r))return t[r]}throw Error(`Invalid enum value: ${JSON.stringify(e)}.`)}function I(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if("string"!=typeof t)throw Error(`Expected string, received: ${JSON.stringify(t)}.`);return e}function M(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if(!Number.isInteger(t))throw Error(`Expected integer, received: ${JSON.stringify(t)}.`);return e}function C(e){if("boolean"!=typeof e)throw Error(`Expected boolean, received: ${JSON.stringify(e)}`);return e}},3853:function(e,t,r){let i;r.d(t,{SO:function(){return s},XD:function(){return n}});function n(e,t,r=t){return function(e,t,r){for(let i=0;i<r;++i){let n=t*i;e.fill(0,n,n+r),e[n+i]=1}return e}(new e(t*r),t,Math.min(t,r))}function s(e,t,r,n,s){return!function(e,t,r,i,n,s){for(let a=0;a<s;++a){let s=a*i,o=a*t;for(let t=0;t<n;++t)e[o+t]=r[s+t]};}(e,t,r,n,s,s),function(e,t,r){let n=1;(void 0===i||i.length<r)&&(i=new Uint32Array(r));for(let e=0;e<r;++e)i[e]=e;for(let s=0;s<r;++s){let a=t*s,o=s;{let t=Math.abs(e[a+s]);for(let i=s+1;i<r;++i){let r=Math.abs(e[a+i]);r>t&&(t=r,o=i)}}if(s!==o){n*=-1;for(let i=0;i<r;++i){let r=t*i,n=e[r+s];e[r+s]=e[r+o],e[r+o]=n}{let e=i[s];i[s]=i[o],i[o]=e}}let l=e[a+s],u=1/l;n*=l;for(let i=0;i<r;++i)e[t*i+s]*=u;e[a+s]=u;for(let i=0;i<r;++i){if(i===s)continue;let n=-e[t*s+i];for(let a=0;a<r;++a){let r=t*a;e[r+i]+=n*e[r+s]}e[t*s+i]=n*u}}for(let n=0;n<r;++n){let s=i[n];for(;s!==n;){let a=t*n,o=t*s;for(let t=0;t<r;++t){let r=a+t,i=o+t,n=e[r];e[r]=e[i],e[i]=n}let l=i[n]=i[s];i[s]=s,s=l}}return n}(e,t,s)}},566:function(e,t,r){r.d(t,{K_:function(){return n},MZ:function(){return i}});class i{handlers=new Set;count=0;constructor(){let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(e=>{e.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}addOnce(e){let{handlers:t}=this;t.add(function r(...i){t.delete(r),e(...i)})}remove(e){return this.handlers.delete(e)}dispatch;dispose(){this.handlers=void 0}}class n extends i{}},2689:function(e,t,r){let i,n,s,a,o,l;r("2374");var u,h,d,c,f,p,g,y,m,v,b,w,S,k,E,I,M,C,T,x,P=r("3719");function R(e,t){if(void 0!==e){if(e.aborted){t(e.reason);return}return e.addEventListener("abort",r,{once:!0}),{[Symbol.dispose](){e.removeEventListener("abort",r)}}}function r(){t(this.reason)}}class N{consumers=new Map;controller=new AbortController;retainCount=0;get signal(){return this.controller.signal}addConsumer(e){if(!this.controller.signal.aborted){if(void 0!==e){if(e.aborted)return;let t=this;e.addEventListener("abort",function e(){t.consumers.delete(e),0==--t.retainCount&&(t.controller.abort(),t[Symbol.dispose]())},{once:!0})}++this.retainCount}}[Symbol.dispose](){for(let[e,t]of this.consumers)t.removeEventListener("abort",e);this.consumers.clear(),this.retainCount=0}start(){0===this.retainCount&&this.controller.abort()}}function O(e,t){return void 0===t?e:t.aborted?Promise.reject(t.reason):new Promise((r,i)=>{let n=R(t,e=>{i(e)});e.then(e=>{n?.[Symbol.dispose](),r(e)},e=>{n?.[Symbol.dispose](),i(e)})})}var A=r("106");let _=!("undefined"!=typeof Window&&self instanceof Window),$="rpc.promise.response",L="rpc.promise.cancel",D="rpc.ready",U=new Map;function z(e,t){U.set(e,t)}class j extends Error{name;message;constructor(e,t){super(t),this.name=e,this.message=t}}function F(e,t){z(e,function(e){let r=e.id,i=new AbortController,n=t.call(this,e,i.signal);this.set(r,{promise:n,abortController:i}),n.then(({value:e,transfers:t})=>{this.delete(r),this.invoke($,{id:r,value:e},t)},e=>{this.delete(r),this.invoke($,{id:r,error:e.message,errorName:e.name})})})}z(L,function(e){let t=e.id,r=this.get(t);if(void 0!==r){let{abortController:e}=r;e.abort()}}),z($,function(e){let t=e.id,{resolve:r,reject:i}=this.get(t);this.delete(t),Object.prototype.hasOwnProperty.call(e,"value")?r(e.value):i(new j(e.errorName,e.error))}),z(D,function(e){this.onPeerReady()});let B=_?-1:0;class V extends A.gj{rpc=null;rpcId=null;isOwner;unreferencedGeneration;referencedGeneration;initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){!0===this.isOwner?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():!1===this.isOwner?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,0===this.refCount&&e===this.referencedGeneration&&this.ownerDispose()}}function G(e,t,r={}){null!=t&&e.initializeSharedObject(t,r.id)}class q extends V{constructor(e,t={}){super(),G(this,e,t)}}z("SharedObject.dispose",function(e){let t=this.get(e.id);if(0!==t.refCount)throw Error("Attempted to dispose object with non-zero reference count.");t.disposed(),this.delete(t.rpcId),t.rpcId=null,t.rpc=null}),z("SharedObject.refCountReachedZero",function(e){let t=this.get(e.id),r=e.gen;t.counterpartRefCountReachedZero(r)});let Y=new Map;function J(e){return t=>{if(void 0!==e)t.prototype.RPC_TYPE_ID=e;else if(void 0===(e=t.prototype.RPC_TYPE_ID))throw Error("RPC_TYPE_ID should have already been defined");Y.set(e,t)}}z("SharedObject.new",function(e){let t=e.type,r=new(Y.get(t))(this,e);--r.refCount});let K="SharedWatchableValue.changed";class W extends q{base;updatingValue_=!1;constructor(e,t={}){super(e,t),void 0!==e&&(this.base=new P.SN(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;null!==e&&e.invoke(K,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new W;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return W.makeFromExisting(e,new P.SN(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}}W=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J("SharedWatchableValue")],W),z(K,function(e){let t=this.get(e.id);t.updatingValue_=!0,t.base.value=e.value,t.updatingValue_=!1});var Q=r("8709");var H=((u={})[u.GPU_MEMORY=0]="GPU_MEMORY",u[u.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",u[u.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",u[u.DOWNLOADING=3]="DOWNLOADING",u[u.QUEUED=4]="QUEUED",u[u.NEW=5]="NEW",u[u.FAILED=6]="FAILED",u[u.EXPIRED=7]="EXPIRED",u);var Z=((h={})[h.FIRST_TIER=0]="FIRST_TIER",h[h.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",h[h.VISIBLE=0]="VISIBLE",h[h.PREFETCH=1]="PREFETCH",h[h.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",h[h.RECENT=2]="RECENT",h[h.LAST_TIER=2]="LAST_TIER",h);var X=((d={})[d.totalTime=0]="totalTime",d[d.totalChunks=1]="totalChunks",d);var ee=((c={})[c.numChunks=0]="numChunks",c[c.systemMemoryBytes=1]="systemMemoryBytes",c[c.gpuMemoryBytes=2]="gpuMemoryBytes",c);let et=74;function er(e){return 72+e}var ei=r("1064");let en=class{static insertAfter(e,t){let r=e.next1;t.next1=r,t.prev1=e,e.next1=t,r.prev1=t}static insertBefore(e,t){let r=e.prev1;t.prev1=r,t.next1=e,e.prev1=t,r.next1=t}static front(e){let t=e.next1;return t===e?null:t}static back(e){let t=e.prev1;return t===e?null:t}static pop(e){let t=e.next1,r=e.prev1;return t.prev1=r,r.next1=t,e.next1=null,e.prev1=null,e}static*iterator(e){for(let t=e.next1;t!==e;t=t.next1)yield t}static*reverseIterator(e){for(let t=e.prev1;t!==e;t=t.prev1)yield t}static initializeHead(e){e.next1=e.prev1=e}};var es=r("4571");class ea{compare;constructor(e){this.compare=e}meld(e,t){if(null===t)return e;if(null===e)return t;let{compare:r}=this;if(r(t,e)){let r=e;e=t,t=r}let i=e.child0;return t.next0=i,t.prev0=e,null!==i&&(i.prev0=t),e.child0=t,e}combineChildren(e){let t=e.child0;if(null===t)return null;let r=null;for(;;){let e,i;let n=t.next0;if(null===n?(e=null,i=t):(e=n.next0,i=this.meld(t,n)),i.next0=r,r=i,null===e)break;t=e}let i=r;for(r=r.next0;null!==r;){;let e=r.next0;i=this.meld(i,r),r=e}return i.prev0=null,i.next0=null,i}removeMin(e){let t=this.combineChildren(e);return e.next0=null,e.prev0=null,e.child0=null,t}remove(e,t){if(e===t)return this.removeMin(e);let r=t.prev0,i=t.next0;r.child0===t?r.child0=i:r.next0=i,null!==i&&(i.prev0=r);let n=this.meld(e,this.combineChildren(t));return t.next0=null,t.prev0=null,t.child0=null,n}*entries(e){if(null!==e){let t=e.child0;for(yield e;null!==t;){let e=t.next0;yield*this.entries(t),t=e}}}*removedEntries(e){if(null!==e){let t=e.child0;for(e.child0=null,e.next0=null,e.prev0=null,yield e;null!==t;){let e=t.next0;t.child0=null,t.next0=null,t.prev0=null,yield*this.entries(t),t=e}}}}class eo{compare;constructor(e){this.compare=e}meld(e,t){if(null===t)return e;if(null===e)return t;let{compare:r}=this;if(r(t,e)){let r=e;e=t,t=r}let i=e.child1;return t.next1=i,t.prev1=e,null!==i&&(i.prev1=t),e.child1=t,e}combineChildren(e){let t=e.child1;if(null===t)return null;let r=null;for(;;){let e,i;let n=t.next1;if(null===n?(e=null,i=t):(e=n.next1,i=this.meld(t,n)),i.next1=r,r=i,null===e)break;t=e}let i=r;for(r=r.next1;null!==r;){;let e=r.next1;i=this.meld(i,r),r=e}return i.prev1=null,i.next1=null,i}removeMin(e){let t=this.combineChildren(e);return e.next1=null,e.prev1=null,e.child1=null,t}remove(e,t){if(e===t)return this.removeMin(e);let r=t.prev1,i=t.next1;r.child1===t?r.child1=i:r.next1=i,null!==i&&(i.prev1=r);let n=this.meld(e,this.combineChildren(t));return t.next1=null,t.prev1=null,t.child1=null,n}*entries(e){if(null!==e){let t=e.child1;for(yield e;null!==t;){let e=t.next1;yield*this.entries(t),t=e}}}*removedEntries(e){if(null!==e){let t=e.child1;for(e.child1=null,e.next1=null,e.prev1=null,yield e;null!==t;){let e=t.next1;t.child1=null,t.next1=null,t.prev1=null,yield*this.entries(t),t=e}}}}var el=r("566");function eu(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let eh=0;class ed{child0=null;next0=null;prev0=null;child1=null;next1=null;prev1=null;source=null;key=null;state_=H.NEW;error=null;markGeneration=-1;priority=0;newPriority=0;priorityTier=Z.RECENT;newPriorityTier=Z.RECENT;systemMemoryBytes_=0;gpuMemoryBytes_=0;downloadSlots_=1;isComputational=!1;requestedState=H.NEW;newRequestedState=H.NEW;downloadAbortController=void 0;initialize(e){this.key=e,this.priority=Number.NEGATIVE_INFINITY,this.priorityTier=Z.RECENT,this.newPriority=Number.NEGATIVE_INFINITY,this.newPriorityTier=Z.RECENT,this.error=null,this.state=H.NEW,this.requestedState=H.NEW,this.newRequestedState=H.NEW}updatePriorityProperties(){this.priorityTier=this.newPriorityTier,this.priority=this.newPriority,this.newPriorityTier=Z.RECENT,this.newPriority=Number.NEGATIVE_INFINITY,this.requestedState=this.newRequestedState,this.newRequestedState=H.NEW}dispose(){this.source=null,this.error=null}get chunkManager(){return this.source.chunkManager}get queueManager(){return this.source.chunkManager.queueManager}downloadFailed(e){this.error=e,this.queueManager.updateChunkState(this,H.FAILED)}downloadSucceeded(){this.requestedState===H.SYSTEM_MEMORY?(this.queueManager.moveChunkToFrontend(this),this.queueManager.updateChunkState(this,H.SYSTEM_MEMORY)):this.queueManager.updateChunkState(this,H.SYSTEM_MEMORY_WORKER)}freeSystemMemory(){}serialize(e,t){e.id=this.key,e.source=this.source.rpcId,e.new=!0}toString(){return this.key}set state(e){if(e===this.state_)return;let t=this.state_;this.state_=e,this.source.chunkStateChanged(this,t)}get state(){return this.state_}set systemMemoryBytes(e){ef(this,-1),this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!1),this.systemMemoryBytes_=e,this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!0),ef(this,1),this.chunkManager.queueManager.scheduleUpdate()}get systemMemoryBytes(){return this.systemMemoryBytes_}set gpuMemoryBytes(e){ef(this,-1),this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!1),this.gpuMemoryBytes_=e,this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!0),ef(this,1),this.chunkManager.queueManager.scheduleUpdate()}get gpuMemoryBytes(){return this.gpuMemoryBytes_}get downloadSlots(){return this.downloadSlots_}set downloadSlots(e){e!==this.downloadSlots_&&(ef(this,-1),this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!1),this.downloadSlots_=e,this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!0),ef(this,1),this.chunkManager.queueManager.scheduleUpdate())}registerListener(e){return!!this.source&&this.source.registerChunkListener(this.key,e)}unregisterListener(e){return!!this.source&&this.source.unregisterChunkListener(this.key,e)}static priorityLess(e,t){return e.priority<t.priority}static priorityGreater(e,t){return e.priority>t.priority}}class ec extends V{chunkManager;listeners_;chunks;freeChunks;statistics;sourceQueueLevel;constructor(e){super(),this.chunkManager=e,this.listeners_=new Map,this.chunks=new Map,this.freeChunks=[],this.statistics=new Float64Array(et),this.sourceQueueLevel=0,e.queueManager.sources.add(this)}disposed(){this.chunkManager.queueManager.sources.delete(this),super.disposed()}getNewChunk_(e){let t=this.freeChunks,r=t.length;if(r>0){let e=t[r-1];return t.length=r-1,e.source=this,e}let i=new e;return i.source=this,i}addChunk(e){let{chunks:t}=this;0===t.size&&this.addRef(),t.set(e.key,e),ef(e,1)}removeChunk(e){let{chunks:t,freeChunks:r}=this;t.delete(e.key),e.dispose(),r[r.length]=e,0===t.size&&this.dispose()}registerChunkListener(e,t){return this.listeners_.has(e)?this.listeners_.get(e).push(t):this.listeners_.set(e,[t]),!0}unregisterChunkListener(e,t){if(!this.listeners_.has(e))return!1;let r=this.listeners_.get(e),i=r.indexOf(t);return!(i<0)&&(r.splice(i,1),0===r.length&&this.listeners_.delete(e),!0)}chunkStateChanged(e,t){let{key:r}=e;if(null===r)return;let i=this.listeners_.get(r);if(void 0!==i)for(let r of i.slice())r(e,t)}}function ef(e,t){var r;let{statistics:i}=e.source,{systemMemoryBytes:n,gpuMemoryBytes:s}=e;let a=(r=e.state,3*r+e.priorityTier);i[3*a+ee.numChunks]+=t,i[3*a+ee.systemMemoryBytes]+=t*n,i[3*a+ee.gpuMemoryBytes]+=t*s}class ep extends ec{constructor(e,t){super(e.get(t.chunkManager)),G(this,e,t)}}function eg(e){let t=e.downloadAbortController;e.downloadAbortController=void 0,t.abort()}class ey{heapOperations;linkedListOperations;heapRoots;recentHead;constructor(e,t){this.heapOperations=e,this.linkedListOperations=t,this.heapRoots=[null,null],this.recentHead=new ed,t.initializeHead(this.recentHead)}add(e){let t=e.priorityTier;if(t===Z.RECENT)this.linkedListOperations.insertAfter(this.recentHead,e);else{let{heapRoots:r}=this;r[t]=this.heapOperations.meld(r[t],e)}}*candidates(){if(this.heapOperations.compare===ed.priorityLess){let{linkedListOperations:e,recentHead:t}=this;for(;;){let r=e.back(t);if(null==r)break;yield r}let{heapRoots:r}=this;for(let e=Z.LAST_ORDERED_TIER;e>=Z.FIRST_ORDERED_TIER;--e)for(;;){let t=r[e];if(null==t)break;yield t}}else{let e=this.heapRoots;for(let t=Z.FIRST_ORDERED_TIER;t<=Z.LAST_ORDERED_TIER;++t)for(;;){let r=e[t];if(null==r)break;yield r}let{linkedListOperations:t,recentHead:r}=this;for(;;){let e=t.front(r);if(null==e)break;yield e}}}delete(e){let t=e.priorityTier;if(t===Z.RECENT)this.linkedListOperations.pop(e);else{let r=this.heapRoots;r[t]=this.heapOperations.remove(r[t],e)}}}function em(e){return new ey(new eo(e),en)}function ev(e,t,r,i,n,s){for(;t.availableItems<1||t.availableSize<e;){let e=n.next().value;if(void 0===e)return!1;let t=e.priorityTier;if(t<r||t===r&&e.priority>=i)return!1;s(e)}return!0}class eb extends A.gj{itemLimit;sizeLimit;currentSize;currentItems;capacityChanged;constructor(e,t){super(),this.itemLimit=e,this.sizeLimit=t,this.currentSize=0,this.currentItems=0,this.capacityChanged=new el.K_,this.registerDisposer(e.changed.add(this.capacityChanged.dispatch)),this.registerDisposer(t.changed.add(this.capacityChanged.dispatch))}adjust(e,t){this.currentItems-=e,this.currentSize-=t}get availableSize(){return this.sizeLimit.value-this.currentSize}get availableItems(){return this.itemLimit.value-this.currentItems}toString(){return`bytes=${this.currentSize}/${this.sizeLimit.value},items=${this.currentItems}/${this.itemLimit.value}`}}class ew extends q{gpuMemoryCapacity;systemMemoryCapacity;downloadCapacity;computeCapacity;enablePrefetch;sources=new Set;queuedDownloadPromotionQueue=[em(ed.priorityGreater),em(ed.priorityGreater)];queuedComputePromotionQueue=em(ed.priorityGreater);downloadEvictionQueue=[em(ed.priorityLess),em(ed.priorityLess)];computeEvictionQueue=em(ed.priorityLess);systemMemoryEvictionQueue=new ey(new ea(ed.priorityLess),ei.Z);gpuMemoryPromotionQueue=em(ed.priorityGreater);gpuMemoryEvictionQueue=em(ed.priorityLess);updatePending=null;gpuMemoryChanged=new el.K_;numQueued=0;numFailed=0;gpuMemoryGeneration=0;constructor(e,t){super(e,t);let r=t=>{let r=this.registerDisposer(new eb(e.get(t.itemLimit),e.get(t.sizeLimit)));return r.capacityChanged.add(()=>this.scheduleUpdate()),r};this.gpuMemoryCapacity=r(t.gpuMemoryCapacity),this.systemMemoryCapacity=r(t.systemMemoryCapacity),this.enablePrefetch=e.get(t.enablePrefetch),this.downloadCapacity=[r(t.downloadCapacity),r(t.downloadCapacity)],this.computeCapacity=r(t.computeCapacity)}scheduleUpdate(){null===this.updatePending&&(this.updatePending=setTimeout(this.process.bind(this),0))}*chunkQueuesForChunk(e){switch(e.state){case H.QUEUED:e.isComputational?yield this.queuedComputePromotionQueue:yield this.queuedDownloadPromotionQueue[e.source.sourceQueueLevel];break;case H.DOWNLOADING:e.isComputational?yield this.computeEvictionQueue:(yield this.downloadEvictionQueue[e.source.sourceQueueLevel],yield this.systemMemoryEvictionQueue);break;case H.SYSTEM_MEMORY_WORKER:case H.SYSTEM_MEMORY:yield this.systemMemoryEvictionQueue,e.requestedState===H.GPU_MEMORY&&(yield this.gpuMemoryPromotionQueue);break;case H.GPU_MEMORY:yield this.systemMemoryEvictionQueue,yield this.gpuMemoryEvictionQueue}}adjustCapacitiesForChunk(e,t){let r=t?-1:1;switch(e.state){case H.FAILED:this.numFailed-=r;break;case H.QUEUED:this.numQueued-=r;break;case H.DOWNLOADING:(e.isComputational?this.computeCapacity:this.downloadCapacity[e.source.sourceQueueLevel]).adjust(r*e.downloadSlots,r*e.systemMemoryBytes),this.systemMemoryCapacity.adjust(r,r*e.systemMemoryBytes);break;case H.SYSTEM_MEMORY:case H.SYSTEM_MEMORY_WORKER:this.systemMemoryCapacity.adjust(r,r*e.systemMemoryBytes);break;case H.GPU_MEMORY:this.systemMemoryCapacity.adjust(r,r*e.systemMemoryBytes),this.gpuMemoryCapacity.adjust(r,r*e.gpuMemoryBytes)}}removeChunkFromQueues_(e){for(let t of(ef(e,-1),this.chunkQueuesForChunk(e)))t.delete(e)}addChunkToQueues_(e){if(e.state===H.QUEUED&&e.priorityTier===Z.RECENT){let{source:t}=e;return t.removeChunk(e),this.adjustCapacitiesForChunk(e,!1),!1}for(let t of(ef(e,1),this.chunkQueuesForChunk(e)))t.add(e);return!0}performChunkPriorityUpdate(e){if(e.priorityTier===e.newPriorityTier&&e.priority===e.newPriority){e.newPriorityTier=Z.RECENT,e.newPriority=Number.NEGATIVE_INFINITY;return}this.removeChunkFromQueues_(e),e.updatePriorityProperties(),e.state===H.NEW&&(e.state=H.QUEUED,this.adjustCapacitiesForChunk(e,!0)),this.addChunkToQueues_(e)}updateChunkState(e,t){if(t!==e.state)this.adjustCapacitiesForChunk(e,!1),this.removeChunkFromQueues_(e),e.state=t,this.adjustCapacitiesForChunk(e,!0),this.addChunkToQueues_(e),this.scheduleUpdate()}processGPUPromotions_(){let e=this;function t(t){e.freeChunkGPUMemory(t),t.source.chunkManager.queueManager.updateChunkState(t,H.SYSTEM_MEMORY)}let r=this.gpuMemoryPromotionQueue.candidates(),i=this.gpuMemoryEvictionQueue.candidates(),n=this.gpuMemoryCapacity;for(;;){let e=r.next().value;if(void 0===e)break;let s=e.priorityTier,a=e.priority;if(!ev(e.gpuMemoryBytes,n,s,a,i,t))break;this.copyChunkToGPU(e),this.updateChunkState(e,H.GPU_MEMORY)}}freeChunkGPUMemory(e){++this.gpuMemoryGeneration,this.rpc.invoke("Chunk.update",{id:e.key,state:H.SYSTEM_MEMORY,source:e.source.rpcId})}freeChunkSystemMemory(e){e.state===H.SYSTEM_MEMORY_WORKER?e.freeSystemMemory():this.rpc.invoke("Chunk.update",{id:e.key,state:H.EXPIRED,source:e.source.rpcId})}retrieveChunkData(e){return this.rpc.promiseInvoke("Chunk.retrieve",{key:e.key,source:e.source.rpcId})}copyChunkToGPU(e){++this.gpuMemoryGeneration;let t=this.rpc;if(e.state===H.SYSTEM_MEMORY)t.invoke("Chunk.update",{id:e.key,source:e.source.rpcId,state:H.GPU_MEMORY});else{let r={},i=[];e.serialize(r,i),r.state=H.GPU_MEMORY,t.invoke("Chunk.update",r,i)}}moveChunkToFrontend(e){let t=this.rpc,r={},i=[];e.serialize(r,i),r.state=H.SYSTEM_MEMORY,t.invoke("Chunk.update",r,i)}processQueuePromotions_(){let e=e=>{switch(e.state){case H.DOWNLOADING:eg(e);break;case H.GPU_MEMORY:this.freeChunkGPUMemory(e);case H.SYSTEM_MEMORY_WORKER:case H.SYSTEM_MEMORY:this.freeChunkSystemMemory(e)}this.updateChunkState(e,H.QUEUED)},t=(t,r,i)=>{let n=this.systemMemoryEvictionQueue.candidates(),s=this.systemMemoryCapacity;for(;;){let a=t.next();if(a.done)return;let o=a.value,l=o.priorityTier,u=o.priority;if(!ev(0,i,l,u,r,e)||!ev(0,s,l,u,n,e))return;this.updateChunkState(o,H.DOWNLOADING),!function(e){let t=e.downloadAbortController=new AbortController,r=Date.now();e.source.download(e,t.signal).then(()=>{if(e.downloadAbortController===t){e.downloadAbortController=void 0;let t=Date.now(),{statistics:i}=e.source;i[72+X.totalTime]+=t-r,++i[72+X.totalChunks],e.downloadSucceeded()}},r=>{e.downloadAbortController===t&&(e.downloadAbortController=void 0,e.downloadFailed(r),console.log(`Error retrieving chunk ${e}: ${r}`))})}(o)}};for(let e=0;e<2;++e)t(this.queuedDownloadPromotionQueue[e].candidates(),this.downloadEvictionQueue[e].candidates(),this.downloadCapacity[e]);t(this.queuedComputePromotionQueue.candidates(),this.computeEvictionQueue.candidates(),this.computeCapacity)}process(){if(!this.updatePending)return;this.updatePending=null;let e=this.gpuMemoryGeneration;this.processGPUPromotions_(),this.processQueuePromotions_(),this.logStatistics(),this.gpuMemoryGeneration!==e&&this.gpuMemoryChanged.dispatch()}logStatistics(){}invalidateSourceCache(e){for(let t of e.chunks.values()){switch(t.state){case H.DOWNLOADING:eg(t);break;case H.SYSTEM_MEMORY_WORKER:t.freeSystemMemory()}this.updateChunkState(t,H.QUEUED)}this.rpc.invoke("Chunk.update",{source:e.rpcId}),this.scheduleUpdate()}}ew=eu([J("ChunkQueueManager")],ew);class eS extends q{chunkManagerGeneration=-1;numVisibleChunksNeeded=0;numVisibleChunksAvailable=0;numPrefetchChunksNeeded=0;numPrefetchChunksAvailable=0}class ek extends q{queueManager;existingTierChunks=[];newTierChunks=[];updatePending=null;recomputeChunkPriorities=new el.K_;recomputeChunkPrioritiesLate=new el.K_;memoize=new es.O;layers=[];sendLayerChunkStatistics=this.registerCancellable((0,Q.Z)(()=>{this.rpc.invoke("ChunkManager.chunkLayerStatistics",{id:this.rpcId,layers:this.layers.map(e=>({id:e.rpcId,numVisibleChunksAvailable:e.numVisibleChunksAvailable,numVisibleChunksNeeded:e.numVisibleChunksNeeded,numPrefetchChunksAvailable:e.numPrefetchChunksAvailable,numPrefetchChunksNeeded:e.numPrefetchChunksNeeded}))})},200));constructor(e,t){super(e,t),this.queueManager=e.get(t.chunkQueueManager).addRef(),this.registerDisposer(this.queueManager.gpuMemoryChanged.add(this.registerCancellable((0,Q.Z)(()=>this.scheduleUpdateChunkPriorities(),200,{leading:!1,trailing:!0}))));for(let e=Z.FIRST_TIER;e<=Z.LAST_TIER;++e){if(e!==Z.RECENT)this.existingTierChunks[e]=[]}}scheduleUpdateChunkPriorities(){null===this.updatePending&&(this.updatePending=setTimeout(this.recomputeChunkPriorities_.bind(this),0))}registerLayer(e){let t=this.recomputeChunkPriorities.count;e.chunkManagerGeneration!==t&&(e.chunkManagerGeneration=t,this.layers.push(e),e.numVisibleChunksAvailable=0,e.numVisibleChunksNeeded=0,e.numPrefetchChunksAvailable=0,e.numPrefetchChunksNeeded=0)}recomputeChunkPriorities_(){this.updatePending=null,this.layers.length=0,this.recomputeChunkPriorities.dispatch(),this.recomputeChunkPrioritiesLate.dispatch(),this.updateQueueState([Z.VISIBLE,Z.PREFETCH]),this.sendLayerChunkStatistics()}requestChunk(e,t,r,i=H.GPU_MEMORY){if(Number.isNaN(r))return;if(t===Z.RECENT)throw Error("Not going to request a chunk with the RECENT tier");e.newRequestedState=Math.min(e.newRequestedState,i),e.newPriorityTier===Z.RECENT&&this.newTierChunks.push(e);let n=e.newPriorityTier;(t<n||t===n&&r>e.newPriority)&&(e.newPriorityTier=t,e.newPriority=r)}updateQueueState(e){let t=this.existingTierChunks,r=this.queueManager;for(let i of e){let e=t[i];for(let t of e)t.newPriorityTier===Z.RECENT&&r.performChunkPriorityUpdate(t);e.length=0}let i=this.newTierChunks;for(let e of i)r.performChunkPriorityUpdate(e),t[e.priorityTier].push(e);i.length=0,this.queueManager.scheduleUpdate()}}function eE(e,t){var r;class i extends e{parameters;constructor(...e){super(...e);let t=e[1];this.parameters=t.parameters}}return i=eu([(r=t.RPC_ID,e=>{e.prototype.RPC_TYPE_ID=r})],i)}function eI(e){return class extends e{chunkManager;constructor(...e){super(...e);let t=e[0],r=e[1];this.chunkManager=t.get(r.chunkManager)}}}ek=eu([J("ChunkManager")],ek),z("ChunkSource.invalidate",function(e){let t=this.get(e.id);t.chunkManager.queueManager.invalidateSourceCache(t)}),F("ChunkQueueManager.requestChunkStatistics",function(e){let t=this.get(e.queue),r=new Map;for(let e of t.sources)r.set(e.rpcId,e.statistics);return Promise.resolve({value:r})});var eM=r("1395");class eC extends A.gj{view;state;constructor(e){super(),this.view=e,this.state=void 0}}class eT extends eS{attachments=new Map;attach(e){}}z(eM.ny,function(e){let t=this.get(e.view),r=this.get(e.layer),i=new eC(t);r.attachments.set(t,i),r.attach(i)}),z(eM.ti,function(e){let t=this.get(e.view),r=this.get(e.layer),i=r.attachments.get(t);r.attachments.delete(t),i.dispose()});class ex extends q{value;oldValue;changed=new el.MZ;constructor(e,t){super(e,t),this.value=t.value,this.oldValue=Object.assign({},this.value)}}ex=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J(eM.rC)],ex),z(eM.uH,function(e){let t=this.get(e.id),{value:r,oldValue:i}=t;Object.assign(i,r),Object.assign(r,e.value),t.changed.dispatch(i,r)});function eP(e,t){let r=e.length;if(t.length!==r)return!1;for(let i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}var eR=r("3783"),eN=r("290");let eO=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xb5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"},{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],eA=[{prefix:"u",exponent:-6},...eO],e_=new Map;e_.set("",{unit:"",exponent:0});let e$=new Map;for(let{prefix:e,exponent:t}of eA)for(let r of(e$.set(t,e),["m","s","Hz","rad/s"]))e_.set(`${e}${r}`,{unit:r,exponent:t});let eL=new Float32Array(0),eD=new Float64Array(0);function eU(e){let{names:t,units:r,scales:i}=e,{valid:n=!0,rank:s=t.length,timestamps:a=t.map(()=>Number.NEGATIVE_INFINITY),ids:o=t.map((e,t)=>-t),boundingBoxes:l=[]}=e,{coordinateArrays:u=Array(s)}=e,{bounds:h=function(e,t){let r=new Float64Array(t),i=new Float64Array(t);r.fill(Number.NEGATIVE_INFINITY),i.fill(Number.POSITIVE_INFINITY);let n=Array(t);n.fill(0);let s=Array(t);for(let a of(s.fill(0),e))for(let e=0;e<t;++e){let o=function(e,t,r){let{box:{lowerBounds:i,upperBounds:n},transform:s}=e,a=i.length,o=s[r*a+t],l=o,u=o,h=!1;for(let e=0;e<a;++e){let a=s[r*e+t];if(0===a)continue;let o=a*i[e],d=a*n[e];l+=Math.min(o,d),u+=Math.max(o,d),h=!0}if(h)return{lower:l,upper:u}}(a,e,t);if(void 0===o)continue;let{lower:l,upper:u}=o;if(Number.isFinite(l)&&Number.isFinite(u)){let t=Math.floor(l),r=Math.floor(u);t===l&&r===u?++s[e]:l-t==.5&&u-r==.5&&++n[e]}r[e]=r[e]===Number.NEGATIVE_INFINITY?l:Math.min(r[e],l),i[e]=i[e]===Number.POSITIVE_INFINITY?u:Math.max(i[e],u)}return{lowerBounds:r,upperBounds:i,voxelCenterAtIntegerCoordinates:s.map((e,t)=>n[t]>0&&0===e)}}(l,s)}=e;return{valid:n,rank:s,names:t,timestamps:a,ids:o,units:r,scales:i,boundingBoxes:l,bounds:h,coordinateArrays:u}}Float64Array.of(1,1,1);let ez=eU({valid:!1,names:[],units:[],scales:eD,boundingBoxes:[]});function ej(e,t){let r=(e+t)/2;return!Number.isFinite(r)&&(r=Math.min(Math.max(0,e),t)),r}eU({valid:!0,names:[],units:[],scales:eD,boundingBoxes:[]});function eF(e,t=!1){if(t){let t=Number(e);if(Number.isInteger(t)&&t>=0)return!0}return null!==e.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)}new WeakMap;var eB=r("5580");var eV=((f={})[f.LINKED=0]="LINKED",f[f.RELATIVE=1]="RELATIVE",f[f.UNLINKED=2]="UNLINKED",f);class eG extends eB.B{constructor(e=0){super(eV,e)}}eR.R3.create();let eq=eR.gf.create();function eY(e,t,r,i){let n,s=!1;e.registerDisposer(t);let a=2,o=()=>{let s=r.value;if(s!==a)switch(s){case 2:n=void 0;break;case 0:n=void 0,i.assign(e,t);break;case 1:n=i.difference(e,t)}a=s,e.changed.dispatch()};return e.registerDisposer(e.changed.add(()=>{if(!s)switch(r.value){case 2:break;case 0:i.assign(t,e);break;case 1:i.subtract(t,e,n)}})),e.registerDisposer(t.changed.add(()=>{switch(s=!0,r.value){case 2:if(i.isValid(e))break;case 0:i.assign(e,t);break;case 1:i.add(e,t,n)}s=!1})),e.registerDisposer(r.changed.add(o)),o(),e}class eJ extends A.gj{coordinateSpace;coordinates_;curCoordinateSpace;changed;constructor(e){super(),this.coordinateSpace=e,this.coordinates_=eL,this.changed=new el.K_,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=eL,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(void 0===t||!t.valid||t.rank!==e.length)return;let{coordinates_:r}=this;r.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:r}=e;if(!e.valid)return;if(void 0===t||!t.valid){let{coordinates_:t}=this;if(void 0!==t&&t.length===r);else{!function(e,t){let{lowerBounds:r,upperBounds:i}=t,n=e.length;for(let t=0;t<n;++t)e[t]=ej(r[t],i[t]);}(t=this.coordinates_=new Float32Array(r),e.bounds);let{voxelCenterAtIntegerCoordinates:i}=e.bounds;for(let e=0;e<r;++e)i[e]?t[e]=Math.round(t[e]):t[e]=Math.floor(t[e])+.5}this.changed.dispatch();return}let i=new Float32Array(r),n=this.coordinates_,{ids:s,scales:a}=e,{ids:o,scales:l}=t;for(let t=0;t<r;++t){let r=s[t],u=o.indexOf(r);-1===u?i[t]=ej(e.bounds.lowerBounds[t],e.bounds.upperBounds[t]):i[t]=n[u]*(l[u]/a[t])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid&&0===this.coordinates_.length)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(0!==e.length)return Array.from(e)}restoreState(e){if(void 0===e){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from((0,eN.m7)(e,eN.jz)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{bounds:{voxelCenterAtIntegerCoordinates:e}}=this.coordinateSpace.value,{coordinates_:t}=this,r=t.length;for(let i=0;i<r;++i)e[i]?t[i]=Math.round(t[i]):t[i]=Math.floor(t[i])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:r}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){let r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return function(e,t,r){let i=e.length;for(let n=0;n<i;++n)e[n]=t[n]-r[n];return e}(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();let{value:n}=t;void 0!==r&&n.length===r.length&&(!function(e,t,r,i){let n=e.length;for(let s=0;s<n;++s)e[s]=t[s]+r[s]*i;}(e.value,n,r,i),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset(){e.reset()},restoreState(t){var r,i,n;if(void 0===t||Array.isArray(t)){e.restoreState(t);return}(0,eN.PT)(t),r=t,i="voxelCoordinates",n=e,(0,eN.Kh)(r,i,e=>n.restoreState(e))}}}}class eK{peer;link;value;get changed(){return this.value.changed}constructor(e,t=new eG){this.peer=e,this.link=t}toJSON(){let{link:e}=this;if(0!==e.value)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){!function(e,t,r){if(void 0===r||0===Object.keys(r).length){e.value=0;return}(0,eN.PT)(r),e.value=2,(0,eN.uq)(r,"value",e=>{void 0!==e&&t.restoreState(e)}),(0,eN.uq)(r,"link",t=>e.restoreState(t))}(this.link,this.value,e)}copyToPeer(){0!==this.link.value&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}}class eW extends A.gj{orientation;changed=new el.K_;constructor(e){super(),null==e&&(e=eR.gf.create()),this.orientation=e}toJSON(){var e;let{orientation:t}=this;if(eR.gf.normalize(this.orientation,this.orientation),0!==(e=t)[0]||0!==e[1]||0!==e[2]||1!==e[3])return Array.prototype.slice.call(this.orientation)}restoreState(e){try{(0,eN._b)(this.orientation,e),eR.gf.normalize(this.orientation,this.orientation)}catch{eR.gf.identity(this.orientation)}this.changed.dispatch()}reset(){eR.gf.identity(this.orientation),this.changed.dispatch()}snap(){let e=eR.wO.create();eR.wO.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,n=0;for(let s=0;s<3;++s){let a=e[3*r+s];if(e[3*r+s]=0,!t[s])Math.abs(a)>Math.abs(i)&&(i=a,n=s)}e[3*r+n]=Math.sign(i),t[n]=!0}eR.gf.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new eW(eR.gf.multiply(eR.gf.create(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{!i&&(n=!0,eR.gf.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),n=!1)}));let n=!1,s=eR.gf.invert(eR.gf.create(),t);return r.registerDisposer(r.changed.add(()=>{!n&&(i=!0,eR.gf.multiply(e.orientation,r.orientation,s),e.changed.dispatch(),i=!1)})),r}assign(e){eR.gf.copy(this.orientation,e.orientation),this.changed.dispatch()}}class eQ extends A.gj{coordinateSpace;changed;curCoordinateSpace;value_;constructor(e){super(),this.coordinateSpace=e,this.changed=new el.K_,this.curCoordinateSpace=ez,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=ez,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:r}=this,{factors:i}=r,{names:n,rank:s}=this.curCoordinateSpace;for(let r=0;r<s;++r){let s=i[r];1!==s&&(e[n[r]]=s,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:r,rank:i}=t,n=new Float64Array(i);if(n.fill(-1),void 0!==e){let t=(0,eN.PT)(e);for(let e=0;e<i;++e)n[e]=(0,eN.uq)(t,r[e],e=>void 0===e?1:(0,eN.o7)(e))}this.value_={factors:n},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:r}=this;if(r===e)return t;let{ids:i}=r,{ids:n,rank:s}=e,a=t.factors,o=new Float64Array(s);o.fill(1);for(let e=0;e<s;++e){let t=n[e],r=i.indexOf(t);-1!==r&&(o[e]=a[r])}return eP(o,a)?t:(t=this.value_={factors:o},this.curCoordinateSpace=e,this.changed.dispatch(),t)}assign(e){this.setFactors(e.value.factors)}}function eH(e,t,r,i,n){if(r===i)return t;let{ids:s}=r,{rank:a,ids:o}=i,l=new e(a);for(let e=0;e<a;++e){let r=o[e],i=s.indexOf(r);l[e]=-1===i?n(e):t[i]}return l}function eZ(e,t){var r,i;let n=e.displayDimensionRenderInfo;if(n===t)return!0;return r=n,i=t,!!(eP(r.globalDimensionNames,i.globalDimensionNames)&&eP(r.displayDimensionIndices,i.displayDimensionIndices)&&eP(r.canonicalVoxelFactors,i.canonicalVoxelFactors)&&eP(r.voxelPhysicalScales,i.voxelPhysicalScales)&&r.canonicalVoxelPhysicalSize===i.canonicalVoxelPhysicalSize&&eP(r.displayDimensionUnits,i.displayDimensionUnits)&&eP(r.displayDimensionScales,i.displayDimensionScales))&&(e.displayDimensionRenderInfo=t,!0)}class eX extends A.gj{coordinateSpace;changed;default_;value_;constructor(e){super(),this.coordinateSpace=e,this.changed=new el.K_,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(void 0!==t&&t.coordinateSpace===e)return;if(void 0===t||this.default_){this.setToDefault(e);return}let r=new Int32Array(3),{ids:i}=t.coordinateSpace,{ids:n}=e,s=t.displayDimensionIndices,a=t.displayRank,o=0;for(let e=0;e<a;++e){let t=n.indexOf(i[s[e]]);-1!==t&&(r[o]=t,++o)}if(r.fill(-1,o),0===o){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,o,r),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let e=0;e<t;++e)r[e]=e;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(void 0===e){this.reset();return}let t=function(e,t=!1){let r=(0,eN.m7)(e,e=>(function(e,t=!1){let r=(0,eN.ZE)(e);if(!eF(r,t))throw Error(`Invalid dimension name: ${JSON.stringify(r)}`);return r})(e,t));if(!function(e,t=!1){let r=new Set;for(let i of e){if(!eF(i,t)||r.has(i))return!1;r.add(i)}return!0}(r,t))throw Error(`Invalid dimensions: ${JSON.stringify(r)}`);return r}(e);if(t.length>3)throw Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:r}}=this,i=new Int32Array(3);i.fill(-1);let{names:n}=r,s=0;for(let e of t){let t=n.indexOf(e);-1!==t&&(i[s++]=t)}if(0===s){this.reset();return}this.default_=!1,this.assignValue(r,s,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:r,displayDimensionIndices:i,coordinateSpace:{names:n}}=e;if(0!==r){for(let e=0;e<r;++e)t[e]=n[i[e]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:r}=e.value;this.setDimensionIndices(t,r)}}}var e0=r("2902");r("5901"),r("9652");class e1{width=0;height=0;logicalWidth=0;logicalHeight=0;visibleLeftFraction=0;visibleTopFraction=0;visibleWidthFraction=0;visibleHeightFraction=0}class e2 extends A.gj{context;element;visibility;gl;boundsGeneration;canvasRelativeClippedLeft;canvasRelativeClippedTop;canvasRelativeLogicalLeft;canvasRelativeLogicalTop;renderViewport;monitorState;constructor(e,t,r){super(),this.context=e,this.element=t,this.visibility=r,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new e1,this.monitorState={isIntersecting:!0},this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:r}=this,i=r.getBoundingClientRect();e.ensureMonitorPanel(r,this.monitorState,i);let n=e.container,s=e.canvasRect,{canvas:a}=e,{width:o,height:l}=a,u=o/s.width,h=l/s.height,d=s.left,c=s.top,f=this.canvasRelativeLogicalLeft=Math.round((i.left-d)*u+r.clientLeft),p=this.canvasRelativeLogicalTop=Math.round((i.top-c)*h+r.clientTop),g=r.clientWidth,y=r.clientHeight,m=f+g,v=p+y,b=p,w=f,S=m,k=v;for(let e=r.parentElement;null!==e&&e!==n;e=e.parentElement){let t=e.getBoundingClientRect();if(0!==t.x||0!==t.y||0!==t.width||0!==t.height)w=Math.max(w,(t.left-d)*u),b=Math.max(b,(t.top-c)*h),S=Math.min(S,(t.right-d)*u),k=Math.min(k,(t.bottom-c)*h)}b=this.canvasRelativeClippedTop=Math.round(Math.max(b,0)),w=this.canvasRelativeClippedLeft=Math.round(Math.max(w,0)),S=Math.round(Math.min(S,o)),k=Math.round(Math.min(k,l));let E=this.renderViewport,I=E.width=Math.max(0,S-w),M=E.height=Math.max(0,k-b);E.logicalWidth=g,E.logicalHeight=y,E.visibleLeftFraction=(w-f)/g,E.visibleTopFraction=(b-p)/y,E.visibleWidthFraction=I/g,E.visibleHeightFraction=M/y}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:r,renderViewport:{width:i,height:n}}=this,s=t+n;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let a=this.context.canvas.height-s;e.viewport(r,a,i,n),e.scissor(r,a,i,n)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:r,logicalWidth:i,logicalHeight:n}}=this,s=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,s-(this.canvasRelativeLogicalTop+n),i,n),e.scissor(this.canvasRelativeClippedLeft,s-(this.canvasRelativeClippedTop+r),t,r)}disposed(){this.context.unmonitorPanel(this.element,this.monitorState),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return 0!==e.clientWidth&&0!==e.clientHeight&&0!==e.offsetWidth&&0!==e.offsetHeight&&!0}get drawOrder(){return 0}}new Uint32Array(0),new Uint32Array(0);var e3=r("9023");var e4=((m={})[m.UINT8=0]="UINT8",m[m.INT8=1]="INT8",m[m.UINT16=2]="UINT16",m[m.INT16=3]="INT16",m[m.UINT32=4]="UINT32",m[m.INT32=5]="INT32",m[m.UINT64=6]="UINT64",m[m.FLOAT32=7]="FLOAT32",m);let e6={0:1,1:1,2:2,3:2,4:4,5:4,6:8,7:4},e5={0:Uint8Array,1:Int8Array,2:Uint16Array,3:Int16Array,4:Uint32Array,5:Int32Array,6:Uint32Array,7:Float32Array},e8={0:1,1:1,2:1,3:1,4:1,5:1,6:2,7:1};function e7(e,t,r=0,i=t.byteLength){let n=e6[e],s=e8[e];return new e5[e](t,r,i/n*s)}let e9=eR._E.create();function te(e,t,r){let{curPositionInChunks:i,fixedPositionWithinChunk:n}=e,{nonDisplayLowerClipBound:s,nonDisplayUpperClipBound:a}=e,{rank:o,chunkDataSize:l}=e.source.spec;if(!function(e,t,r,i,n){let s=t.length,a=r.length,o=e.length,l=!0;for(let u=0;u<i;++u){let h=u,d=0;for(let e=0;e<s;++e)d+=n[h+e*i]*t[e];h+=s*i;for(let e=0;e<a;++e)d+=n[h+e*i]*r[e];d+=n[h+a*i],u<o?e[u]=d:(d<0||d>=1)&&(l=!1)}return l}(i,t,r,e.layerRank,e.fixedLayerToChunkTransform))return!1;for(let e=0;e<o;++e){let t=i[e];if(t<s[e]||t>=a[e])return!1;let r=l[e],o=i[e]=Math.floor(t/r);n[e]=t-o*r}return!0}let tt=new e3.d(eR.R3.create(),eR._E.create(),0);class tr extends V{projectionParameters;visibleLayers;visibleSourcesStale;constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new Map,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((e,t)=>{(function(e,t){if(e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo||e.pixelSize!==t.pixelSize)return!0;let{viewMatrix:r}=e,{viewMatrix:i}=t;for(let e=0;e<12;++e)if(r[e]!==i[e])return!0;return!1})(e,t)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,i]of t){let{allSources:t,visibleSources:n}=i;if(n.length=0,0===t.length||!eZ(i,e))continue;let s=function(e,t){let r=t.length,i=0;if(r>1){let n=0;for(let s=0;s<r;++s){let{chunkLayout:r}=t[s],a=function(e,t){let r=0,i=Math.abs(e.detTransform),{transform:n,size:s}=e;for(let e=0;e<3;++e){let a=0;for(let r=0;r<3;++r)a+=t[4*r+2]*n[4*e+r];let o=s[e];r+=Math.abs(a)*o,i*=o}return i/r}(r,e);a>n&&(n=a,i=s)}}return i}(this.projectionParameters.value.viewMatrix,t.map(e=>e[0])),a=t[s];for(let e of r.filterVisibleSources(this,a))n.push(e);n.reverse()}}}let ti=new Float32Array(3),tn=new Float32Array(3),ts=eR._E.create(),ta=new Float32Array(24);function to(e,t,r,i){let{lowerChunkDisplayBound:n,upperChunkDisplayBound:s}=t;for(let e=0;e<3;++e)ti[e]=Math.max(ti[e],n[e]),tn[e]=Math.min(tn[e],s[e]);let{curPositionInChunks:a,chunkDisplayDimensionIndices:o}=t;!function t(){if(!i(ti[0],ti[1],ti[2],tn[0],tn[1],tn[2],e))return;let n=0,s=Math.max(0,tn[0]-ti[0]),l=s;for(let e=1;e<3;++e){let t=Math.max(0,tn[e]-ti[e]);l*=t,t>s&&(s=t,n=e)}if(0===l)return;if(1===l){a[o[0]]=ti[0],a[o[1]]=ti[1],a[o[2]]=ti[2],r(ti,e);return}let u=ti[n],h=tn[n],d=Math.floor(.5*(u+h));tn[n]=d,t(),tn[n]=h,ti[n]=d,t(),ti[n]=u}()}function tl(e,t,r,i){if(!te(r,e.globalPosition,t))return;let{size:n}=r.chunkLayout,s=eR._E.multiply(ts,e.viewProjectionMat,r.chunkLayout.transform);for(let e=0;e<3;++e){let t=n[e];for(let r=0;r<4;++r)s[4*e+r]*=t}(0,eR.th)(ta,s);ti.fill(Number.NEGATIVE_INFINITY),tn.fill(Number.POSITIVE_INFINITY),to(ta,r,i,eR.Rq)}function tu(e,t,r,i,n){if(!te(r,e.globalPosition,t))return;let{size:s}=i,a=eR._E.multiply(ts,e.viewProjectionMat,i.transform);for(let e=0;e<3;++e){let t=s[e];for(let r=0;r<4;++r)a[4*e+r]*=t}eR._E.invert(e9,a);for(let e=0;e<3;++e){let t=e9[12+e]+.001/s[e],r=Math.abs(e9[e]),i=Math.abs(e9[4+e]);ti[e]=Math.floor(t-r-i),tn[e]=Math.floor(t+r+i+1)}for(let e=0;e<3;++e){let t=a[4*e],r=a[4*e+1],i=a[4*e+2];ta[e]=t,ta[4+e]=-t,ta[8+e]=+r,ta[12+e]=-r,ta[16+e]=+i,ta[20+e]=-i}{let e=a[12],t=a[13],r=a[14];ta[3]=1+e,ta[7]=1-e,ta[11]=1+t,ta[15]=1-t,ta[19]=r,ta[23]=-r}to(ta,r,n,eR.iG)}function th(e,t){let{finiteRank:r}=t;if(3===r)return t;tt.finiteRank=r,eR.R3.copy(tt.size,t.size);let i=eR._E.copy(tt.transform,t.transform),n=eR._E.copy(tt.invTransform,t.invTransform);tt.detTransform=t.detTransform;let{invViewMatrix:s,width:a,height:o}=e,l=(0,eR.V2)(e.projectionMat);for(let e=r;e<3;++e){let t=s[12+e],r=t,n=t,u=Math.abs(s[e]*a);r-=u,n+=u;let h=Math.abs(s[e+4]*o);r-=h,n+=h;let d=Math.abs(s[e+8]*l);r-=d;let c=Math.max(1,(n+=d)-r);i[12+e]=r,i[5*e]=c}return eR._E.invert(n,i),tt}class td{velocityHalfLifeMilliseconds;modelHalfLifeMilliseconds;lastTime;rank;numSamples;prevPosition;velocity;mean;variance;constructor(e=50,t=1e3){this.velocityHalfLifeMilliseconds=e,this.modelHalfLifeMilliseconds=t,this.lastTime=Number.NEGATIVE_INFINITY,this.rank=0,this.numSamples=0,this.prevPosition=new Float32Array,this.velocity=new Float32Array,this.mean=new Float32Array,this.variance=new Float32Array}reset(e){this.lastTime=Number.NEGATIVE_INFINITY,this.rank=e,this.numSamples=0,this.velocity=new Float32Array(e),this.prevPosition=new Float32Array(e),this.mean=new Float32Array(e),this.variance=new Float32Array(e)}addSample(e,t=Date.now()){let r=e.length;r!==this.rank&&this.reset(r);let i=this.numSamples;if(++this.numSamples,0===this.numSamples){this.prevPosition.set(e),this.lastTime=t;return}let n=t-this.lastTime;this.lastTime=t;let s=1-2**-(n/this.velocityHalfLifeMilliseconds),a=1-2**-(n/this.modelHalfLifeMilliseconds),{velocity:o,prevPosition:l,mean:u,variance:h}=this;for(let t=0;t<r;++t){let r=(e[t]-l[t])/Math.max(n,1);l[t]=e[t];let d=o[t],c=o[t]=d+s*(r-d);if(1===i)u[t]=c;else{let e=u[t],r=h[t],i=c-e;u[t]=e+a*i,h[t]=(1-a)*(r+a*i*i)}}}}function tc(e){return class extends e{visibility;constructor(...e){super(...e);let t=e[0],r=e[1];this.visibility=t.get(r.visibility),this.registerDisposer(this.visibility.changed.add(()=>this.chunkManager.scheduleUpdateChunkPriorities()))}}}function tf(e){return e===Number.POSITIVE_INFINITY?Z.VISIBLE:Z.PREFETCH}function tp(e){return e===Number.POSITIVE_INFINITY?0:1e13*e}function tg(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let ty=eR.R3.create(),tm=eR.R3.create(),tv=eR.R3.create();function tb(e){for(let t of e)for(let e of t)e.source.dispose()}let tw=tc(eI(class e extends tr{constructor(e,t){super(e.get(t.projectionParameters)),this.initializeSharedObject(e,t.id)}}));class tS extends tw{velocityEstimator=new td;constructor(e,t){super(e,t),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateVisibleChunks()})),this.registerDisposer(this.projectionParameters.changed.add(()=>{this.velocityEstimator.addSample(this.projectionParameters.value.globalPosition)}))}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.chunkManager.scheduleUpdateChunkPriorities()}handleLayerChanged=()=>{this.chunkManager.scheduleUpdateChunkPriorities()};updateVisibleChunks(){let e=this.projectionParameters.value,t=this.chunkManager,r=this.visibility.value;if(r===Number.NEGATIVE_INFINITY)return;this.updateVisibleSources();let{centerDataPosition:i}=e,n=tf(r),s=tp(r);s+=-1e12;let a=[];for(let[r,o]of(this.velocityEstimator.addSample(this.projectionParameters.value.globalPosition),this.visibleLayers)){t.registerLayer(r);let{visibleSources:l}=o;for(let o=0,u=l.length;o<u;++o){let u=l[o],h=t.queueManager.enablePrefetch.value?function(e,t){let r=[],i=e.rank,{combinedGlobalLocalToChunkTransform:n,layerRank:s}=t,{rank:a,chunkDataSize:o}=t.source.spec,{mean:l,variance:u}=e;for(let e=0;e<a;++e){let a=t.chunkDisplayDimensionIndices.includes(e),h=0,d=0;for(let t=0;t<i;++t){let r=l[t],i=u[t],a=n[t*s+e];h+=a*r,d+=a*a*i}if(h>.1)continue;let c=o[e],f=a?0:t.fixedPositionWithinChunk[e]/c,p=h/c*2e3,g=Math.sqrt(2*d)/c*2e3;if(.001>Math.abs(p)&&g<.001)continue;g=Math.max(1e-6,g);let y=e=>.5*(1+function(e){let t=1/(1+.3275911*Math.abs(e)),r=1-((((1.061405429*t+-1.453152027)*t+1.421413741)*t+-.284496736)*t+.254829592)*t*Math.exp(-e*e);return Math.sign(e)*r}((e-p)/g)),m=t.curPositionInChunks[e],v=Math.floor(t.lowerClipBound[e]/c),b=Math.ceil(t.upperClipBound[e]/c)-1,w=r.length;for(let t=1;t<=32&&(a||!(m+t>b));++t){let i=1-y(t-f);if(i<.05)break;r.push(e,t,v,b,i,0)}let S=r.length;for(let e=w,t=r.length;e<t;e+=tC)r[e+tC-1]=S;w=S;for(let t=1;t<=32&&(a||!(m-t<v));++t){let i=y(-t+1-f);if(i<.05)break;r.push(e,-t,v,b,i,0)}S=r.length;for(let e=w,t=r.length;e<t;e+=tC)r[e+tC-1]=S}return r}(this.velocityEstimator,u):[],{chunkLayout:d}=u;d.globalToLocalSpatial(tm,i);let{size:c,finiteRank:f}=d;eR.R3.copy(tv,c);for(let e=f;e<3;++e)tv[e]=0,tm[e]=0;let p=s+1e9*o;a.length=0;let g=++eh;if(tu(e,u.renderLayer.localPosition.value,u,th(e,u.chunkLayout),e=>{eR.R3.multiply(ty,e,tv);let i=-eR.R3.distance(tm,ty),{curPositionInChunks:s}=u,o=u.source.getChunk(s);t.requestChunk(o,n,p+i),++r.numVisibleChunksNeeded,o.state===H.GPU_MEMORY&&++r.numVisibleChunksAvailable,a.push(o),o.markGeneration=g}),0!==h.length){let{curPositionInChunks:e}=u;for(let i of a){e.set(i.chunkGridPosition);for(let i=0,n=h.length;i<n;){let n=h[i],s=h[i+2],a=h[i+3],o=h[i+4],l=h[i+5],d=e[n],c=d+h[i+1];if(c<s||c>a){i=l;continue}e[n]=c;let f=u.source.getChunk(e);if(e[n]=d,f.markGeneration===g){i=l;continue}t.requestChunk(f,Z.PREFETCH,p+o),++r.numPrefetchChunksNeeded,f.state===H.GPU_MEMORY&&++r.numPrefetchChunksAvailable,i+=tC}}}}}}removeVisibleLayer(e){let{visibleLayers:t}=this,r=t.get(e);t.delete(e),tb(r.allSources),e.renderScaleTarget.changed.remove(this.invalidateVisibleSources),e.localPosition.changed.remove(this.handleLayerChanged),this.invalidateVisibleSources()}addVisibleLayer(e,t,r){let i=this.visibleLayers.get(e);void 0===i?(i={allSources:t,visibleSources:[],displayDimensionRenderInfo:r},this.visibleLayers.set(e,i),e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()),e.localPosition.changed.add(this.handleLayerChanged)):(tb(i.allSources),i.allSources=t,i.visibleSources.length=0,i.displayDimensionRenderInfo=r),this.invalidateVisibleSources()}disposed(){for(let e of this.visibleLayers.keys())this.removeVisibleLayer(e);super.disposed()}invalidateVisibleSources(){super.invalidateVisibleSources(),this.chunkManager.scheduleUpdateChunkPriorities()}}function tk(e,t,r){return t.map(t=>t.map(t=>{let i=e.getRef(t.source),n=t.chunkLayout,{rank:s}=i.spec;return{renderLayer:r,source:i,chunkLayout:e3.d.fromObject(n),layerRank:t.layerRank,nonDisplayLowerClipBound:t.nonDisplayLowerClipBound,nonDisplayUpperClipBound:t.nonDisplayUpperClipBound,lowerClipBound:t.lowerClipBound,upperClipBound:t.upperClipBound,lowerClipDisplayBound:t.lowerClipDisplayBound,upperClipDisplayBound:t.upperClipDisplayBound,lowerChunkDisplayBound:t.lowerChunkDisplayBound,upperChunkDisplayBound:t.upperChunkDisplayBound,effectiveVoxelSize:t.effectiveVoxelSize,chunkDisplayDimensionIndices:t.chunkDisplayDimensionIndices,fixedLayerToChunkTransform:t.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:t.combinedGlobalLocalToChunkTransform,curPositionInChunks:new Float32Array(s),fixedPositionWithinChunk:new Uint32Array(s)}}))}tS=tg([J("SliceView")],tS),z("SliceView.addVisibleLayer",function(e){let t=this.get(e.id),r=this.get(e.layerId),i=tk(this,e.sources,r);t.addVisibleLayer(r,i,e.displayDimensionRenderInfo)}),z("SliceView.removeVisibleLayer",function(e){let t=this.get(e.id),r=this.get(e.layerId);t.removeVisibleLayer(r)});class tE extends ed{chunkGridPosition;source=null;initializeVolumeChunk(e,t){super.initialize(e),this.chunkGridPosition=Float32Array.from(t)}serialize(e,t){super.serialize(e,t),e.chunkGridPosition=this.chunkGridPosition}downloadSucceeded(){super.downloadSucceeded()}freeSystemMemory(){}toString(){return this.source.toString()+":"+(0,eR.m0)(this.chunkGridPosition)}}class tI extends ep{spec;constructor(e,t){super(e,t),this.spec=t.spec}getChunk(e){let t=e.join(),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(this.chunkConstructor)).initializeVolumeChunk(t,e),this.addChunk(r)),r}}class tM extends q{renderScaleTarget;localPosition;numVisibleChunksNeeded;numVisibleChunksAvailable;numPrefetchChunksNeeded;numPrefetchChunksAvailable;chunkManagerGeneration;constructor(e,t){super(e,t),this.renderScaleTarget=e.get(t.renderScaleTarget),this.localPosition=e.get(t.localPosition),this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.chunkManagerGeneration=-1}filterVisibleSources(e,t){return function*(e,t,r){let i;let n=1.1*e.projectionParameters.value.pixelSize,s=r[0].effectiveVoxelSize,a=t.renderScaleTarget.value,o=e=>{let t=n*a;for(let r=0;r<3;++r){let i=e[r];if(i>t&&i>1.01*s[r])return!0}return!1},l=(e,t)=>{let r=n*a;for(let i=0;i<3;++i){let n=e[i],s=t[i];if(Math.abs(r-n)<Math.abs(r-s)&&n<1.01*s)return!0}return!1},u=r.length-1;for(;;){let e=r[u];if(void 0!==i&&!l(e.effectiveVoxelSize,i))break;if(yield e,0===u||!o(e.effectiveVoxelSize))break;i=e.effectiveVoxelSize,--u}}(e,this,t)}}tM=tg([J("sliceview/RenderLayer")],tM);let tC=6;F("ChunkManager.requestChunk",async function(e,t){let r;let i=this.get(e.source),{chunkManager:n}=i,s=i.getChunk(e.chunkGridPosition),a=s.key;if(s.state<=H.SYSTEM_MEMORY)return{value:void 0};if(s.state===H.FAILED)throw s.error;let o=n.recomputeChunkPriorities.add(()=>{n.requestChunk(s,Z.VISIBLE,Number.POSITIVE_INFINITY,H.SYSTEM_MEMORY)});n.scheduleUpdateChunkPriorities();let l=new Promise((e,t)=>{r=r=>{if(r.state===H.FAILED){t(r.error);return}r.state<=H.SYSTEM_MEMORY&&e()}});i.registerChunkListener(a,r);try{return await O(l,t),{value:void 0}}finally{i.unregisterChunkListener(a,r),o(),n.scheduleUpdateChunkPriorities()}});var tT=r("9443");class tx extends q{visibility;projectionParameters;constructor(...e){super(...e);let t=e[0],r=e[1];this.visibility=t.get(r.visibility),this.projectionParameters=t.get(r.projectionParameters)}}tx=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J(tT.w)],tx);class tP extends eT{}let tR=eR.wO.create(),tN=eR.R3.create(),tO=eR.R3.create(),tA=eR.R3.create(),t_=eR.R3.create();class t$ extends eI(eT){localPosition;renderScaleTarget;constructor(e,t){super(e,t),this.renderScaleTarget=e.get(t.renderScaleTarget),this.localPosition=e.get(t.localPosition);let r=()=>this.chunkManager.scheduleUpdateChunkPriorities();this.registerDisposer(this.localPosition.changed.add(r)),this.registerDisposer(this.renderScaleTarget.changed.add(r)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(t),e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.state={displayDimensionRenderInfo:r.projectionParameters.value.displayDimensionRenderInfo,transformedSources:[]}}recomputeChunkPriorities(){for(let e of this.attachments.values()){let t;let{view:r}=e,i=r.visibility.value;if(i===Number.NEGATIVE_INFINITY)continue;let n=e.state,{transformedSources:s}=n;if(0===s.length||!eZ(n,r.projectionParameters.value.displayDimensionRenderInfo))continue;let a=r.projectionParameters.value,o=tf(i),l=tp(i);l+=-1e12;let{globalPosition:u,displayDimensionRenderInfo:{displayDimensionIndices:h}}=a;for(let e=0;e<3;++e){let t=h[e];t_[e]=-1===t?0:u[t]}let{chunkManager:d}=this;d.registerLayer(this),!function(e,t,r,i,n,s){if(0===i.length)return;let{viewMatrix:a,projectionMat:o,displayDimensionRenderInfo:l}=e,{voxelPhysicalScales:u}=l,h=(0,eR.n_)(u),d=(0,eR.V2)(o),c=(d/r)**3,f=eR.wO.determinant((0,eR.bZ)(tR,a)),p={spatialScales:new Map,activeIndex:-1},g=e=>Math.abs(i[e].chunkLayout.detTransform*f),y=i.length-1,m=g(y);for(let e=y;e>=0;--e){let t=g(e),r=Math.cbrt(t*h/f),i=d/Math.cbrt(t);p.spatialScales.set(r,i),t-c>=0&&(m=t,y=e),p.activeIndex=y}let v=Math.cbrt(m*h/f),b=d/Math.cbrt(m),w=!0,S=i[y];tl(e,t,S,(e,t)=>{w&&(n(S,y,v,b,t,p),w=!1),s(S,y,e)})}(a,this.localPosition.value,this.renderScaleTarget.value,s[0],(e,r)=>{let{chunkLayout:i}=e;i.globalToLocalSpatial(tO,t_);let{size:n,finiteRank:a}=i;eR.R3.copy(tA,n);for(let e=a;e<3;++e)tA[e]=0,tO[e]=0;let o=s[0].length-1-r;t=l+1e9*o},(e,r,i)=>{eR.R3.multiply(tN,i,tA);let n=-eR.R3.distance(tO,tN),s=e.source.getChunk(e.curPositionInChunks);++this.numVisibleChunksNeeded,d.requestChunk(s,o,t+n),s.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable})}}}t$=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J("volume_rendering/VolumeRenderingRenderLayer")],t$),z("volume_rendering/VolumeRenderingRenderLayer/update",function(e){let t=this.get(e.view),r=this.get(e.layer),i=r.attachments.get(t);i.state.transformedSources=tk(this,e.sources,r),i.state.displayDimensionRenderInfo=e.displayDimensionRenderInfo,r.chunkManager.scheduleUpdateChunkPriorities()});let tL="annotation.commit",tD=eR.wO.create();var tU=r("5931");function tz(e){try{if("string"!=typeof e)throw Error(`Expected string, but received ${JSON.stringify(e)}.`);let t=document.createElement("canvas").getContext("2d");t.fillStyle=e;let r=function(e){{let t=e.match(/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/);if(null!==t)return[parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3],10),parseFloat(t[4])]}{let t=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/);if(null!==t)return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1]}throw Error(`Invalid serialized color: ${JSON.stringify(e)}.`)}(t.fillStyle);return eR.vh.fromValues(r[0]/255,r[1]/255,r[2]/255,r[3])}catch(e){throw Error(`Failed to parse color specification: ${e.message}`)}}function tj(e){let t=void 0===e[3]?3:4,r=0;for(let i=0;i<t;i++)r=(r<<8>>>0)+Math.min(255,Math.max(0,Math.round(255*e[t-1-i])));return r}function tF(e){if(void 0===e[3]||1===e[3]){let t="#";for(let r=0;r<3;++r)t+=("0"+Math.min(255,Math.max(0,Math.round(255*e[r]))).toString(16)).slice(-2);return t}let t="rgba(";for(let r=0;r<3;++r)0!==r&&(t+=", "),t+=Math.min(255,Math.max(0,Math.round(255*e[r])));return t+=`, ${(0,tU.i)(e[3])})`}var tB=((v={})[v.LITTLE=0]="LITTLE",v[v.BIG=1]="BIG",v);let tV=17===new Uint8Array(Uint16Array.of(4386).buffer)[0]?1:0;function tG(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=2){let r=t[e];t[e]=t[e+1],t[e+1]=r}}function tq(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=4){let r=t[e];t[e]=t[e+3],t[e+3]=r,r=t[e+1],t[e+1]=t[e+2],t[e+2]=r}}function tY(e,t,r=tV){t!==r&&tq(e)}function tJ(e,t,r,i=tV){if(t!==i&&1!==r)switch(r){case 2:tG(e);break;case 4:tq(e);break;case 8:!function(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=8){let r=t[e];t[e]=t[e+7],t[e+7]=r,r=t[e+1],t[e+1]=t[e+6],t[e+6]=r,r=t[e+2],t[e+2]=t[e+5],t[e+5]=r,r=t[e+3],t[e+3]=t[e+4],t[e+4]=r}}(e)}}new Uint32Array(new Float64Array(1).buffer);var tK=r("9754");function tW(e=128){let t=Math.ceil(e/32),r=new Uint32Array(t);crypto.getRandomValues(r);let i="";for(let e=0;e<t;++e)i+=("00000000"+r[e].toString(16)).slice(-8);return i}e4.UINT8,e4.INT8,e4.UINT16,e4.INT16,e4.UINT32,e4.INT32,e4.UINT64,tK.E.ZERO,new tK.E(0xffffffff,0xffffffff),e4.FLOAT32,new tK.E,new tK.E;class tQ extends A.gj{id;changed;value;constructor(e){super(),this.id=e,this.changed=new el.K_}}var tH=((b={})[b.POINT=0]="POINT",b[b.LINE=1]="LINE",b[b.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",b[b.ELLIPSOID=3]="ELLIPSOID",b);let tZ=[0,1,2,3];e4.FLOAT32,e4.UINT32,e4.INT32,e4.UINT16,e4.INT16,e4.UINT8,e4.INT8;let tX={rgb:{serializedBytes:()=>3,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, true);dv.setUint8(${t} + 2, ${e} >>> 16);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, true) | (dv.getUint8(${t} + 2) << 16);`,deserializeJson:e=>tj(tz(e).subarray(0,3)),serializeJson:e=>{var t;return tF((t=e,eR.R3.fromValues((t>>>0&255)/255,(t>>>8&255)/255,(t>>>16&255)/255)))}},rgba:{serializedBytes:()=>4,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, true);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, true);`,deserializeJson:e=>tj(tz(e)),serializeJson:e=>{var t;return tF((t=e,eR.vh.fromValues((t>>>0&255)/255,(t>>>8&255)/255,(t>>>16&255)/255,(t>>>24&255)/255)))}},float32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setFloat32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getFloat32(${t}, isLittleEndian);`,deserializeJson:e=>(0,eN.nH)(e),serializeJson:e=>e},uint32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, isLittleEndian);`,deserializeJson:e=>(0,eN.C$)(e),serializeJson:e=>e},int32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setInt32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt32(${t}, isLittleEndian);`,deserializeJson:e=>(0,eN.C$)(e),serializeJson:e=>e},uint16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, isLittleEndian);`,deserializeJson:e=>(0,eN.C$)(e),serializeJson:e=>e},int16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setInt16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt16(${t}, isLittleEndian);`,deserializeJson:e=>(0,eN.C$)(e),serializeJson:e=>e},uint8:{serializedBytes:()=>1,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getUint8(${t});`,deserializeJson:e=>(0,eN.C$)(e),serializeJson:e=>e},int8:{serializedBytes:()=>2,alignment:()=>1,serializeCode:(e,t)=>`dv.setInt8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getInt8(${t});`,deserializeJson:e=>(0,eN.C$)(e),serializeJson:e=>e}};class t0{rank;firstGroupInitialOffset;propertySpecs;serializedBytes;serialize;deserialize;propertyGroupBytes;constructor(e,t,r){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=r,0===r.length){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:i,offsets:n,propertyGroupBytes:s}=function(e,t,r){let i=0,n=r.length,s=Array(n),a=[];for(let e=0;e<n;++e)s[e]=e;let o=t=>tX[r[t].type].alignment(e);s.sort((e,t)=>o(t)-o(e));let l=0,u=Array(n),h=t,d=()=>{h+=(4-h%4)%4,i+=h,a[l]=h,h=0,++l};for(let t=0;t<n;++t){let i=s[t],n=tX[r[i].type],a=n.serializedBytes(e),o=n.alignment(e),c=(o-h%o)%o,f=h+c+a;f+(4-f%4)%4<=255?h+=c:d(),u[i]={offset:h,group:l},h+=a}return d(),{serializedBytes:i,offsets:u,propertyGroupBytes:a}}(e,t,r);this.propertyGroupBytes=s;let a="let groupOffset0 = offset;";for(let e=1;e<s.length;++e)a+=`let groupOffset${e} = groupOffset${e-1} + ${s[e-1]}*annotationCount;`;for(let e=0;e<s.length;++e)a+=`groupOffset${e} += ${s[e]}*annotationIndex;`;let o=a,l=a,u=r.length;for(let t=0;t<u;++t){let{group:i,offset:s}=n[t],a=tX[r[t].type],u=`properties[${t}]`,h=`groupOffset${i} + ${s}`;o+=a.serializeCode(u,h,e),l+=a.deserializeCode(u,h,e)}this.serializedBytes=i,this.serialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",o),this.deserialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",l)}}function t1(e,t){let r=[];for(let i of tZ){let n=t5[i];r[i]=new t0(e,n.serializedBytes(e),t)}return r}function t2(e,t,r,i,n){for(let s=0;s<i;++s)e.setFloat32(t,n[s],r),t+=4;return t}function t3(e,t,r,i,n,s){return t=t2(e,t,r,i,n),t=t2(e,t,r,i,s)}function t4(e,t,r,i,n){for(let s=0;s<i;++s)n[s]=e.getFloat32(t,r),t+=4;return t}function t6(e,t,r,i,n,s){return t=t4(e,t,r,i,n),t=t4(e,t,r,i,s)}let t5={1:{icon:"",description:"Line",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState(e,t,r){e.pointA=(0,eN.uq)(t,"pointA",e=>(0,eN.Iw)(new Float32Array(r),e,eN.jz)),e.pointB=(0,eN.uq)(t,"pointB",e=>(0,eN.Iw)(new Float32Array(r),e,eN.jz))},serializedBytes:e=>8*e,serialize(e,t,r,i,n){t3(e,t,r,i,n.pointA,n.pointB)},deserialize:(e,t,r,i,n)=>{let s=new Float32Array(i),a=new Float32Array(i);return t6(e,t,r,i,s,a),{type:1,pointA:s,pointB:a,id:n,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},0:{icon:"",description:"Point",toJSON:e=>({point:Array.from(e.point)}),restoreState:(e,t,r)=>{e.point=(0,eN.uq)(t,"point",e=>(0,eN.Iw)(new Float32Array(r),e,eN.jz))},serializedBytes:e=>4*e,serialize:(e,t,r,i,n)=>{t2(e,t,r,i,n.point)},deserialize:(e,t,r,i,n)=>{let s=new Float32Array(i);return t4(e,t,r,i,s),{type:0,point:s,id:n,properties:[]}},visitGeometry(e,t){t(e.point,!1)}},2:{icon:"",description:"Bounding Box",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState:(e,t,r)=>{e.pointA=(0,eN.uq)(t,"pointA",e=>(0,eN.Iw)(new Float32Array(r),e,eN.jz)),e.pointB=(0,eN.uq)(t,"pointB",e=>(0,eN.Iw)(new Float32Array(r),e,eN.jz))},serializedBytes:e=>8*e,serialize(e,t,r,i,n){t3(e,t,r,i,n.pointA,n.pointB)},deserialize:(e,t,r,i,n)=>{let s=new Float32Array(i),a=new Float32Array(i);return t6(e,t,r,i,s,a),{type:2,pointA:s,pointB:a,id:n,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},3:{icon:"",description:"Ellipsoid",toJSON:e=>({center:Array.from(e.center),radii:Array.from(e.radii)}),restoreState:(e,t,r)=>{e.center=(0,eN.uq)(t,"center",e=>(0,eN.Iw)(new Float32Array(r),e,eN.jz)),e.radii=(0,eN.uq)(t,"radii",e=>(0,eN.Iw)(new Float32Array(r),e,eN.lu))},serializedBytes:e=>8*e,serialize(e,t,r,i,n){t3(e,t,r,i,n.center,n.radii)},deserialize:(e,t,r,i,n)=>{let s=new Float32Array(i),a=new Float32Array(i);return t6(e,t,r,i,s,a),{type:3,center:s,radii:a,id:n,properties:[]}},visitGeometry(e,t){t(e.center,!1),t(e.radii,!0)}}};function t8(){return tW(160)}A.gj,Symbol.iterator;class t7{propertySerializers;annotations;constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return function(e,t){let r=0,i=[];for(let n of tZ){let s=t[n].serializedBytes;i[n]=r,r+=s*e[n].length}let n=[],s=[],a=new ArrayBuffer(r),o=new DataView(a),l=tV===tB.LITTLE;for(let r of tZ){let a=t[r],{rank:u}=a,h=a.serialize,d=e[r];n[r]=d.map(e=>e.id),s[r]=new Map(d.map((e,t)=>[e.id,t]));let c=t5[r].serialize,f=i[r],p=a.propertyGroupBytes[0];for(let e=0,t=d.length;e<t;++e){let r=d[e];c(o,f+e*p,l,u,r),h(o,f,e,t,l,r.properties)}}return{data:new Uint8Array(a),typeToIds:n,typeToOffset:i,typeToIdMaps:s}}(this.annotations,this.propertySerializers)}}var t9=r("658");let re="DisjointUint64Sets.add",rt="DisjointUint64Sets.clear",rr="DisjointUint64Sets.highBitRepresentativeChanged",ri="DisjointUint64Sets.deleteSet";class rn extends q{disjointSets=new t9.D;changed=new el.K_;get value(){return this}static makeWithCounterpart(e,t){let r=new rn;return r.disjointSets.visibleSegmentEquivalencePolicy=t,r.registerDisposer(t.changed.add(()=>{ro(r)})),r.initializeCounterpart(e),t.value&&ro(r),r}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(re,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(rt,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(ri,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(void 0!==e){let t=[new tK.E,new tK.E];(0,eN.m7)(e,e=>{(0,eN.m7)(e,(e,r)=>{t[r%2].parseString(String(e),10),0!==r&&this.link(t[0],t[1])})})}}assignFrom(e){for(let[t,r]of(this.clear(),e instanceof rn&&(e=e.disjointSets),e))this.link(t,r)}}rn=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J("DisjointUint64Sets")],rn);let rs=new tK.E,ra=new tK.E;function ro(e){e.rpc.invoke(rr,{id:e.rpcId,value:e.disjointSets.visibleSegmentEquivalencePolicy.value})}z(re,function(e){let t=this.get(e.id);rs.low=e.al,rs.high=e.ah,ra.low=e.bl,ra.high=e.bh,t.disjointSets.link(rs,ra)&&t.changed.dispatch()}),z(rt,function(e){let t=this.get(e.id);t.disjointSets.clear()&&t.changed.dispatch()}),z(rr,function(e){this.get(e.id).disjointSets.visibleSegmentEquivalencePolicy.value=e.value}),z(ri,function(e){let t=this.get(e.id);rs.low=e.l,rs.high=e.h,t.disjointSets.deleteSet(rs)&&t.changed.dispatch()});var rl=r("1425");let ru=0,rh=0,rd=0,rc=0;class rf{hashSeeds;loadFactor;size;table;tableSize;emptyLow;emptyHigh;maxRehashAttempts;maxAttempts;capacity;generation;mungedEmptyKey;constructor(e=rf.generateHashSeeds(3)){this.hashSeeds=e,this.loadFactor=.8,this.size=0,this.emptyLow=0xffffffff,this.emptyHigh=0xffffffff,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=rf.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=Array(t);for(let e=0;e<t;++e)r[e]=this.getHash(e,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:i}=this;if(-1===i)e:for(;;){i=0x1000000*Math.random()>>>0;for(let e=0;e<t;++e){let n=this.getHash(e,i,i);for(let e=0;e<t;++e)if(r[e]===n)continue e}this.mungedEmptyKey=i;break}let{table:n,emptyLow:s,emptyHigh:a}=this;for(let e=0;e<t;++e){let t=r[e];n[t]===s&&n[t+1]===a&&(n[t]=i,n[t+1]=i)}try{e(n)}finally{for(let e=0;e<t;++e){let t=r[e];n[t]===i&&n[t+1]===i&&(n[t]=s,n[t+1]=a)}}}static generateHashSeeds(e=3){return function(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=65536)crypto.getRandomValues(t.subarray(e,Math.min(r,e+65536)));return e}(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=(0,rl.B)(i,t),i=(0,rl.B)(i,r),this.entryStride*(i&this.tableSize-1)}*keys(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let n=0,s=i.length;n<s;n+=r){let r=i[n],s=i[n+1];(r!==e||s!==t)&&(yield new tK.E(r,s))}}*unsafeKeys(e=new tK.E){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:n}=this;for(let s=0,a=n.length;s<a;s+=i){let i=n[s],a=n[s+1];(i!==t||a!==r)&&(e.low=i,e.high=a,yield e)}}indexOfPair(e,t){let{table:r,emptyLow:i,emptyHigh:n}=this;if(e===i&&t===n)return -1;for(let i=0,n=this.hashSeeds.length;i<n;++i){let n=this.getHash(i,e,t);if(r[n]===e&&r[n+1]===t)return n}return -1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let e,t;let{emptyLow:r,emptyHigh:i,table:n,entryStride:s}=this;for(;;){if(e=0x100000000*Math.random()>>>0,t=0x100000000*Math.random()>>>0,!(e===r&&t===i||this.hasPair(e,t)))break}this.emptyLow=e,this.emptyHigh=t;for(let a=0,o=n.length;a<o;a+=s)n[a]===r&&n[a+1]===i&&(n[a]=e,n[a+1]=t)}has(e){return -1!==this.indexOf(e)}hasPair(e,t){return -1!==this.indexOfPair(e,t)}delete(e){let t=this.indexOf(e);if(-1!==t){let{table:e}=this;return e[t]=this.emptyLow,e[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:r,emptyHigh:i}=this,n=e.length;for(let s=0;s<n;s+=t)e[s]=r,e[s+1]=i}clear(){return 0!==this.size&&(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return!!(e>this.capacity)&&(this.backupPending(),this.grow(e),this.restorePending(),!0)}swapPending(e,t){let r=ru,i=rh;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){ru=e[t],rh=e[t+1]}backupPending(){rd=ru,rc=rh}restorePending(){ru=rd,rh=rc}tryToInsert(){let e=0,{emptyLow:t,emptyHigh:r,maxAttempts:i,table:n}=this,s=this.hashSeeds.length,a=Math.floor(Math.random()*s);for(;;){let o=this.getHash(a,ru,rh);if(this.swapPending(n,o),ru===t&&rh===r)return!0;if(++e===i)break;a=(a+Math.floor(Math.random()*(s-1))+1)%s}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:r,emptyHigh:i,entryStride:n}=this;for(let t=0,s=e.length;t<s;t+=n){let n=e[t],s=e[t+1];if((n!==r||s!==i)&&(this.storePending(e,t),!this.tryToInsert()))return!1}return!0}grow(e){let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let e=0;e<this.maxRehashAttempts;++e)if(this.rehash(t,r))return;r*=2}}insertInternal(){for(++this.generation,ru===this.emptyLow&&rh===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(2*this.tableSize),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class rp extends rf{add(e){let{low:t,high:r}=e;return!this.hasPair(t,r)&&(ru=t,rh=r,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}}rp.prototype.entryStride=2;let rg=0,ry=0,rm=0,rv=0;class rb extends rf{set(e,t){let{low:r,high:i}=e;return!this.hasPair(r,i)&&(ru=r,rh=i,rg=t.low,ry=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(-1===r)return!1;let{table:i}=this;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=rg,i=ry;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),rg=e[t+2],ry=e[t+3]}backupPending(){super.backupPending(),rm=rg,rv=ry}restorePending(){super.restorePending(),rg=rm,ry=rv}[Symbol.iterator](){return this.unsafeEntries()}*entries(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let n=0,s=i.length;n<s;n+=r){let r=i[n],s=i[n+1];if(r!==e||s!==t){let e=new tK.E(r,s),t=new tK.E(i[n+2],i[n+3]);yield[e,t]}}}*unsafeEntries(e=[new tK.E,new tK.E]){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:n}=this,[s,a]=e;for(let o=0,l=n.length;o<l;o+=i){let i=n[o],l=n[o+1];(i!==t||l!==r)&&(s.low=i,s.high=l,a.low=n[o+2],a.high=n[o+3],yield e)}}}rb.prototype.entryStride=4;class rw extends q{hashTable=new rb;changed=new el.MZ;get value(){return this}static makeWithCounterpart(e){let t=new rw;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){for(let[t,r]of(this.clear(),e.unsafeEntries()))this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.unsafeEntries())e[t.toString()]=r.toString();return e}}rw=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J("Uint64Map")],rw),z("Uint64Map.set",function(e){let t=this.get(e.id);t.set_(e.key,e.value)&&t.changed.dispatch()}),z("Uint64Map.delete",function(e){let t=this.get(e.id);t.delete_(e.key)&&t.changed.dispatch()}),z("Uint64Map.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});class rS extends q{hashTable=new rp;changed=new el.MZ;get value(){return this}static makeWithCounterpart(e){let t=new rS;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let r of e)t=this.hashTable.add(r)||t;return t}add(e){let t=[].concat(e);if(this.add_(t)){let{rpc:r}=this;r&&r.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(e){let t=!1;for(let r of e)t=this.hashTable.delete(r)||t;return t}delete(e){let t=[].concat(e);if(this.delete_([].concat(e))){let{rpc:r}=this;r&&r.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=[];for(let t of this.unsafeKeys())e.push(t.toString());return e.sort(),e}assignFrom(e){for(let t of(this.clear(),e.unsafeKeys()))this.add(t)}}rS=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J("Uint64Set")],rS),z("Uint64Set.reserve",function(e){let t=this.get(e.id);t.reserve_(e.value)&&t.changed.dispatch()}),z("Uint64Set.add",function(e){let t=this.get(e.id);t.add_(e.value)&&t.changed.dispatch()}),z("Uint64Set.delete",function(e){let t=this.get(e.id);t.delete_(e.value)&&t.changed.dispatch()}),z("Uint64Set.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});var rk=r("4066");let rE=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function rI(e,t,r){e.registerDisposer(t.visibleSegments.changed.add(r)),e.registerDisposer(t.segmentEquivalences.changed.add(r))}function rM(e,t,r){e.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),e.registerDisposer(t.temporarySegmentEquivalences.changed.add(r)),e.registerDisposer(t.useTemporaryVisibleSegments.changed.add(r)),e.registerDisposer(t.useTemporarySegmentEquivalences.changed.add(r))}function rC(e){return`${e.low},${e.high}`}function rT(e,t){var r,i;let n=(r=e).useTemporaryVisibleSegments.value?r.temporaryVisibleSegments:r.visibleSegments;let s=(i=e).useTemporarySegmentEquivalences.value?i.temporarySegmentEquivalences:i.segmentEquivalences,a=s.disjointSets.visibleSegmentEquivalencePolicy.value;for(let e of n.unsafeKeys())if(a&rk.BA.NONREPRESENTATIVE_EXCLUDED){let r=s.get(e);t(e,r)}else{if(!s.disjointSets.isMinElement(e))continue;for(let r of s.setElements(e)){if(!(a&rk.BA.REPRESENTATIVE_EXCLUDED)||!(a&rk.BA.MAX_REPRESENTATIVE)||!(r.high>>>31))t(r,e)}}}function rx(e,t,r={}){for(let i of rE)r[i]=e.get(t[i]);return r}let rP=e=>class extends e{timestamp;visibleSegments;selectedSegments;segmentEquivalences;temporaryVisibleSegments;temporarySegmentEquivalences;useTemporaryVisibleSegments;useTemporarySegmentEquivalences;transform;renderScaleTarget;constructor(...e){let[t,r]=e;super(t,r),rx(t,r,this),this.transform=t.get(r.transform),this.renderScaleTarget=t.get(r.renderScaleTarget);let i=()=>{this.chunkManager.scheduleUpdateChunkPriorities()};rM(this,this,i),rI(this,this,i),this.registerDisposer(this.transform.changed.add(i)),this.registerDisposer(this.renderScaleTarget.changed.add(i))}};class rR extends ep{properties;constructor(e,t){super(e,t),this.properties=t.properties}}function rN(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class rO extends ed{annotation;freeSystemMemory(){this.annotation=void 0}serialize(e,t){super.serialize(e,t),e.annotation=this.annotation}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=0,super.downloadSucceeded()}}class rA{data;typeToOffset;typeToIds;typeToIdMaps;serialize(e,t){e.data=this.data,e.typeToOffset=this.typeToOffset,e.typeToIds=this.typeToIds,e.typeToIdMaps=this.typeToIdMaps,t.push(this.data.buffer)}get numBytes(){return this.data.byteLength}}function r_(e){return class t extends e{data;serialize(e,t){super.serialize(e,t);let{data:r}=this;void 0!==r&&(r.serialize(e,t),this.data=void 0)}downloadSucceeded(){let{data:e}=this;this.systemMemoryBytes=this.gpuMemoryBytes=void 0===e?0:e.numBytes,super.downloadSucceeded()}freeSystemMemory(){this.data=void 0}}}class r$ extends r_(tE){}class rL extends r_(ed){objectId}class rD extends ep{parent=void 0;getChunk(e){let{chunks:t}=this,r=t.get(e);return void 0===r&&((r=this.getNewChunk_(rO)).initialize(e),this.addChunk(r)),r}download(e,t){return this.parent.downloadMetadata(e,t)}}rD=rN([J("annotation.MetadataChunkSource")],rD);class rU extends tI{parent;constructor(e,t){super(e,t),this.parent=e.get(t.parent)}}rU.prototype.chunkConstructor=r$;class rz extends ep{parent=void 0;relationshipIndex;getChunk(e){let t=rC(e),{chunks:r}=this,i=r.get(t);return void 0===i&&((i=this.getNewChunk_(rL)).initialize(t),i.objectId=e.clone(),this.addChunk(i)),i}download(e,t){return this.parent.downloadSegmentFilteredGeometry(e,this.relationshipIndex,t)}}rz=rN([J("annotation.SubsetGeometryChunkSource")],rz);class rj extends q{references=new Set;chunkManager;metadataChunkSource;segmentFilteredSources;constructor(e,t){super(e,t);let r=this.chunkManager=e.get(t.chunkManager),i=this.metadataChunkSource=this.registerDisposer(e.getRef(t.metadataChunkSource));this.segmentFilteredSources=t.segmentFilteredSource.map((t,r)=>{let i=this.registerDisposer(e.getRef(t));return i.parent=this,i.relationshipIndex=r,i}),i.parent=this,this.registerDisposer(r.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}recomputeChunkPriorities(){let{chunkManager:e,metadataChunkSource:t}=this;for(let r of this.references)e.requestChunk(t.getChunk(r),Z.VISIBLE,200)}add(e){throw Error("Not implemented")}delete(e){throw Error("Not implemented")}update(e,t){throw Error("Not implemented")}}z("annotation.reference.add",function(e){let t=this.get(e.id);t.references.add(e.annotation),t.chunkManager.scheduleUpdateChunkPriorities()}),z("annotation.reference.delete",function(e){let t=this.get(e.id);t.references.delete(e.annotation),t.chunkManager.scheduleUpdateChunkPriorities()}),z("annotation.commit",function(e){let t;let r=this.get(e.id),i=e.annotationId,n=function(e){if(null==e)return e;let{relatedSegments:t}=e;if(void 0!==t)for(let e=0,r=t.length;e<r;++e){let r=t[e];void 0!==r&&(t[e]=r.map(e=>new tK.E(e.low,e.high)))}return e}(e.newAnnotation);(t=void 0===i?r.add(n).then(e=>({...n,id:e})):null===n?r.delete(i).then(()=>null):r.update(i,n).then(()=>n)).then(e=>{!r.wasDisposed&&this.invoke(tL,{id:r.rpcId,annotationId:i||n.id,newAnnotation:e})},e=>{!r.wasDisposed&&this.invoke(tL,{id:r.rpcId,annotationId:i||n?.id,error:e.message})})});class rF extends eI(eT){localPosition;renderScaleTarget;constructor(e,t){super(e,t),this.renderScaleTarget=e.get(t.renderScaleTarget),this.localPosition=e.get(t.localPosition);let r=()=>this.chunkManager.scheduleUpdateChunkPriorities();this.registerDisposer(this.localPosition.changed.add(r)),this.registerDisposer(this.renderScaleTarget.changed.add(r)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(t),e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.state={displayDimensionRenderInfo:r.projectionParameters.value.displayDimensionRenderInfo,transformedSources:[]}}recomputeChunkPriorities(){for(let e of(this.chunkManager.registerLayer(this),this.attachments.values())){let{view:t}=e,r=t.visibility.value;if(r===Number.NEGATIVE_INFINITY)continue;let i=e.state,{transformedSources:n}=i;if(0===n.length||!eZ(i,t.projectionParameters.value.displayDimensionRenderInfo))continue;let s=tf(r),a=tp(r),o=t.projectionParameters.value,{chunkManager:l}=this;!function(e,t,r,i,n,s){let{displayDimensionRenderInfo:a,viewMatrix:o,projectionMat:l,width:u,height:h}=e,{voxelPhysicalScales:d}=a,c=Math.abs(eR.wO.determinant((0,eR.bZ)(tD,o))),f=(0,eR.n_)(d),p=(0,eR.e6)(l)/c*f;if(0===i.length)return;let g=i[0],y=Math.abs(g.chunkLayout.detTransform)*f,{lowerClipDisplayBound:m,upperClipDisplayBound:v}=g;for(let e=0;e<3;++e)y*=v[e]-m[e];let b=Math.min(y,p),w=u*h,S=w/r**2/b,k=0;for(let r=i.length-1;r>=0&&k<S;--r){let a=i[r],o=a.source.spec,{chunkLayout:l}=a,u=(0,eR.n_)(l.size)*Math.abs(l.detTransform)*f,{limit:h,rank:d}=o,{nonDisplayLowerClipBound:c,nonDisplayUpperClipBound:p}=a,g=1;for(let e=0;e<d;++e){let t=p[e]-c[e];Number.isFinite(t)&&(g/=t)}let y=!0,m=k+h*g/u,v=(1/m)**(1/3),E=Math.sqrt(w/(m*b)),I=Math.min(1,(S-k)*u/g/o.limit);tl(e,t,a,()=>{y&&(n(a,r),y=!1),s(a,r,I,v,E)}),k=m}}(o,this.localPosition.value,this.renderScaleTarget.value,n[0],()=>{},(e,t)=>{let r=e.source.getChunk(e.curPositionInChunks);++this.numVisibleChunksNeeded,r.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable;l.requestChunk(r,s,a+0+1e9*t)})}}}rF=rN([J("annotation/SpatiallyIndexedRenderLayer")],rF),z("annotation/PerspectiveRenderLayer:updateSources",function(e){let t=this.get(e.view),r=this.get(e.layer),i=r.attachments.get(t);i.state.transformedSources=tk(this,e.sources,r),i.state.displayDimensionRenderInfo=e.displayDimensionRenderInfo,r.chunkManager.scheduleUpdateChunkPriorities()});class rB extends tc(eI(eS)){source;segmentationStates;constructor(e,t){super(e,t),this.source=e.get(t.source),this.segmentationStates=new P.SN(this.getSegmentationState(t.segmentationStates));let r=()=>this.chunkManager.scheduleUpdateChunkPriorities();this.registerDisposer((0,P.Uw)((e,t)=>{if(void 0!==t){for(let i of t)null!=i&&(rI(e,i,r),rM(e,i,r));r()}},this.segmentationStates)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}recomputeChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;let{segmentationStates:{value:t},source:{segmentFilteredSources:r}}=this;if(void 0===t)return;let{chunkManager:i}=this;i.registerLayer(this);let n=t.length;for(let s=0;s<n;++s){let n=t[s];if(null==n)continue;let a=tf(e),o=tp(e),l=r[s];rT(n,e=>{let t=l.getChunk(e);++this.numVisibleChunksNeeded,t.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable,i.requestChunk(t,a,o+60)})}}getSegmentationState(e){if(void 0!==e)return e.map(e=>null==e?e:rx(this.rpc,e))}}rB=rN([J("annotation/RenderLayer")],rB),z("annotation/RenderLayer.updateSegmentation",function(e){let t=this.get(e.id);t.segmentationStates.value=t.getSegmentationState(e.segmentationStates)});var rV=r("5898");class rG extends q{get=(w=(e,t)=>this.rpc.promiseInvoke(rV.L,{providerId:this.rpcId,invalidCredentials:e},t),(e,t)=>void 0!==a&&(void 0===s||void 0===e||s.generation!==e.generation)?(void 0===s&&o.addConsumer(t),O(a,t)):(s=void 0,a=w(e,(o=new N).signal).then(e=>(s=e,o[Symbol.dispose](),o=void 0,e),e=>{throw o[Symbol.dispose](),o?.signal.aborted&&(o=void 0,a=void 0),e})))}function rq(){return e=>class extends e{credentialsProvider;constructor(...e){super(...e);let t=e[1];this.credentialsProvider=this.rpc.getOptionalRef(t.credentialsProvider)}}}rG=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J(rV.y)],rG);class rY extends Error{url;status;statusText;response;constructor(e,t,r,i){let n=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;r&&(n+=`: ${r}`),super(n+="."),this.name="HttpError",this.message=n,this.url=e,this.status=t,this.statusText=r,i&&(this.response=i)}static fromResponse(e){return new rY(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let t;return new rY(t="string"==typeof e?e:e.url,0,"Network or CORS error")}return t}}function rJ(e){return Math.min(2**e*500,5e3)*(1+Math.random())}async function rK(e,t){for(let r=0;;){let i;t?.signal?.throwIfAborted();try{i=await fetch(e,t)}catch(t){throw rY.fromRequestError(e,t)}if(!i.ok){let{status:e}=i;if((429===e||503===e||504===e)&&32!=++r){await new Promise(e=>setTimeout(e,rJ(r-1)));continue}throw rY.fromResponse(i)}return i}}let rW=new tK.E;function rQ(e){return e instanceof rY&&(0===e.status||403===e.status||404===e.status)}async function rH(e,t,r,i,n){let s;for(let a=0;;){r.signal?.throwIfAborted(),a>1&&await new Promise(e=>setTimeout(e,rJ(a-2))),s=await e.get(s,r.signal??void 0);try{return await rK("function"==typeof t?t(s.credentials):t,i(s.credentials,r))}catch(e){if(e instanceof rY&&await n(e,s.credentials)==="refresh"){if(3==++a)throw e;continue}throw e}}}async function rZ(e,t,r){return rK(t,r).catch(i=>{if(500!==i.status&&401!==i.status&&403!==i.status&&504!==i.status)throw i;return rH(e,t,r,e=>{let t=new Headers(r.headers);return t.set("Authorization",`Bearer ${e}`),{...r,headers:t}},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e})})}var rX=r("5675"),r0=r("7688");let r1=0;function r2(e){return(e>>>2)*3}function r3(e){return 3&e}function r4(e){return e>>>1}function r6(e){return 1+(e+1>>>1)}function r5(e){return 2-e}function r8(e,t,r,i,n,s,a){let o=Math.max(t,r,i),l=0,u=0,h=!1;function d(t){u|=(1&t)<<l,32==++l&&(e.low=u>>>0,u=0,l=0,h=!0)}for(let e=0;e<o;++e)e<t&&d(n>>e&1),e<r&&d(s>>e&1),e<i&&d(a>>e&1);return h?e.high=u>>>0:(e.high=0,e.low=u>>>0),e}function r7(e,t){return e<t&&e<(e^t)}function r9(e,t,r,i,n,s){var a,o,l,u;let h=r,d=s;if((a=h^d)<(o=t^n)&&a<(a^o))h=t,d=n;if((l=h^d)<(u=e^i)&&l<(l^u))h=e,d=i;return h<d}function ie(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class it extends ed{objectId=new tK.E;fragmentIds;initializeManifestChunk(e,t){super.initialize(e),this.objectId.assign(t)}freeSystemMemory(){this.fragmentIds=null}serialize(e,t){super.serialize(e,t),e.fragmentIds=this.fragmentIds}downloadSucceeded(){this.systemMemoryBytes=100,this.gpuMemoryBytes=0,super.downloadSucceeded(),this.priorityTier<Z.RECENT&&this.source.chunkManager.scheduleUpdateChunkPriorities()}toString(){return this.objectId.toString()}}function ir(e,t,r){let{vertexPositions:i,indices:n,vertexNormals:s,strips:a}=e;t.vertexPositions=i,t.indices=n,t.strips=a,t.vertexNormals=s;let o=i.buffer;r.push(o);let l=n.buffer;l!==o&&r.push(l),r.push(s.buffer)}function ii(e){let{vertexPositions:t,indices:r,vertexNormals:i}=e;return t.byteLength+r.byteLength+i.byteLength}class is extends ed{manifestChunk=null;fragmentId=null;meshData=null;initializeFragmentChunk(e,t,r){super.initialize(e),this.manifestChunk=t,this.fragmentId=r}freeSystemMemory(){this.manifestChunk=null,this.meshData=null,this.fragmentId=null}serialize(e,t){super.serialize(e,t),ir(this.meshData,e,t),this.meshData=null}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=ii(this.meshData),super.downloadSucceeded()}}function ia(e,t,r){(0,eN.PT)(t),e.fragmentIds=(0,eN.uq)(t,r,eN.zE)}function io(e,t){let r=eR.R3.create(),i=eR.R3.create(),n=eR.R3.create(),s=new Float32Array(e.length),a=t.length;for(let o=0;o<a;o+=3){let a=3*t[o],l=3*t[o+1],u=3*t[o+2];for(let t=0;t<3;++t)i[t]=e[l+t]-e[a+t],n[t]=e[u+t]-e[l+t];eR.R3.cross(r,i,n),eR.R3.normalize(r,r);for(let e=0;e<3;++e){let i=3*t[o+e];for(let e=0;e<3;++e)s[i+e]+=r[e]}}let o=s.length;for(let e=0;e<o;e+=3){let t=s.subarray(e,e+3);eR.R3.normalize(t,t)}return s}function il(e){return Math.min(Math.max(-127,127*e+.5),127)>>>0}function iu(e){return e<0?-1:1}function ih(e,t,r,i,n,s,a){let o;let l=new Float32Array(t,i,3*n);tY(l,r),void 0===s&&(s=i+12*n),void 0!==a&&(o=a*e);let u=void 0===o?new Uint32Array(t,s):new Uint32Array(t,s,o);if(u.length%e!=0)throw Error(`Number of indices is not a multiple of ${e}: ${u.length}.`);return tY(u,r),{vertexPositions:l,indices:u}}function id(e,t,r,i,n,s){return ih(3,e,t,r,i,n,s)}class ic extends ep{fragmentSource;constructor(e,t){super(e,t),(this.fragmentSource=this.registerDisposer(e.getRef(t.fragmentSource))).meshSource=this}getChunk(e){let t=rC(e),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(it)).initializeManifestChunk(t,e),this.addChunk(r)),r}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}getFragmentChunk(e,t){let r=this.fragmentSource,{key:i,fragmentId:n}=this.getFragmentKey(e.key,t),s=r.chunks.get(i);return void 0===s&&((s=r.getNewChunk_(is)).initializeFragmentChunk(i,e,n),r.addChunk(s)),s}}class ip extends ep{meshSource=null;download(e,t){return this.meshSource.downloadFragment(e,t)}}ip=ie([J(r0.q7)],ip);class ig extends rP(tc(eI(tP))){source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}attach(e){let t=()=>{this.chunkManager.scheduleUpdateChunkPriorities()},{view:r}=e;e.registerDisposer(r.visibility.changed.add(t)),e.registerDisposer(t),t()}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;this.chunkManager.registerLayer(this);let t=tf(e),r=tp(e),{source:i,chunkManager:n}=this;rT(this,e=>{let s=i.getChunk(e);++this.numVisibleChunksNeeded,n.requestChunk(s,t,r+100);let a=s.state;if(a===H.SYSTEM_MEMORY_WORKER||a===H.SYSTEM_MEMORY||a===H.GPU_MEMORY)for(let e of(++this.numVisibleChunksAvailable,s.fragmentIds)){let a=i.getFragmentChunk(s,e);++this.numVisibleChunksNeeded,n.requestChunk(a,t,r+50),a.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable}})}}ig=ie([J(r0.ve)],ig);class iy extends ed{objectId=new tK.E;manifest;initializeManifestChunk(e,t){super.initialize(e),this.objectId.assign(t)}freeSystemMemory(){this.manifest=void 0}serialize(e,t){super.serialize(e,t),e.manifest=this.manifest}downloadSucceeded(){this.systemMemoryBytes=this.manifest.octree.byteLength,this.gpuMemoryBytes=0,super.downloadSucceeded(),this.priorityTier<Z.RECENT&&this.source.chunkManager.scheduleUpdateChunkPriorities()}toString(){return this.objectId.toString()}}class im extends ed{subChunkOffsets=null;meshData=null;lod=0;chunkIndex=0;manifestChunk=null;freeSystemMemory(){this.meshData=this.subChunkOffsets=null}serialize(e,t){super.serialize(e,t),ir(this.meshData,e,t);let{subChunkOffsets:r}=this;e.subChunkOffsets=r,t.push(r.buffer),this.meshData=this.subChunkOffsets=null}downloadSucceeded(){let{subChunkOffsets:e}=this;this.systemMemoryBytes=this.gpuMemoryBytes=ii(this.meshData),this.systemMemoryBytes+=e.byteLength,super.downloadSucceeded()}}class iv extends ep{fragmentSource;format;constructor(e,t){super(e,t);let r=this.fragmentSource=this.registerDisposer(e.getRef(t.fragmentSource));this.format=t.format,r.meshSource=this}getChunk(e){let t=rC(e),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(iy)).initializeManifestChunk(t,e),this.addChunk(r)),r}getFragmentChunk(e,t,r){let i=`${e.key}/${t}:${r}`,n=this.fragmentSource,s=n.chunks.get(i);return void 0===s&&((s=n.getNewChunk_(im)).initialize(i),s.lod=t,s.chunkIndex=r,s.manifestChunk=e,n.addChunk(s)),s}}class ib extends ep{meshSource=null;download(e,t){return this.meshSource.downloadFragment(e,t)}}ib=ie([J(r0.Ff)],ib);let iw=eR._E.create();class iS extends rP(tc(eI(tP))){source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.registerDisposer(t),t()}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;let{transform:{value:t}}=this;if(void 0!==t.error)return;let r=[];this.chunkManager.registerLayer(this);{let t=tf(e),i=tp(e),{source:n,chunkManager:s}=this;rT(this,e=>{let a=n.getChunk(e);++this.numVisibleChunksNeeded,s.requestChunk(a,t,i+100);let o=a.state;(o===H.SYSTEM_MEMORY_WORKER||o===H.SYSTEM_MEMORY||o===H.GPU_MEMORY)&&(r.push(a),++this.numVisibleChunksAvailable)})}if(0===r.length)return;let{source:i,chunkManager:n}=this;for(let{view:e}of this.attachments.values()){let s=e.visibility.value;if(s===Number.NEGATIVE_INFINITY)continue;let a=tf(s),o=tp(s),l=e.projectionParameters.value;try{!function(e,t,r){e.fill(0),e[15]=1;let i=!0,{displayDimensionIndices:n}=t,{globalToRenderLayerDimensions:s,modelToRenderLayerTransform:a}=r,o=r.rank;for(let t=0;t<3;++t){let r=n[t];if(-1===r){i=!1;continue}let l=s[r];if(-1===l){i=!1;continue}e[t+12]=a[l+o*(o+1)];for(let r=0;r<3;++r)e[t+4*r]=a[l+(o+1)*r]}if(!i){let{globalDimensionNames:e}=t,i=Array.from(n.filter(e=>-1!==e),t=>e[t]).join(",\xa0");throw Error(`Transform from model dimensions (${r.modelDimensionNames.join(",\xa0")}) to display dimensions (${i}) does not have full rank`)}}(iw,l.displayDimensionRenderInfo,t)}catch{continue}eR._E.multiply(iw,l.viewProjectionMat,iw);let u=(0,eR.th)(new Float32Array(24),iw),h=this.renderScaleTarget.value;for(let e of r){let t=e.manifest.lodScales.length-1;!function(e,t,r,i,n,s,a){let{octree:o,lodScales:l,chunkGridSpatialOrigin:u,chunkShape:h}=e,d=l.length-1,c=t[0],f=t[4],p=t[8],g=t[1],y=t[5],m=t[9],v=t[3],b=t[7],w=t[11],S=t[15],k=v>0?0:1,E=b>0?0:1,I=w>0?0:1,M=r[16],C=r[17],T=r[18],x=r[19];function P(e,t,r){return v*e+b*t+w*r+S}let R=-x*M*v+-x*C*b+-x*T*w+S,N=e.clipLowerBound[0],O=e.clipLowerBound[1],A=e.clipLowerBound[2],_=e.clipUpperBound[0],$=e.clipUpperBound[1],L=e.clipUpperBound[2],D=Math.max(Math.sqrt((c*n)**2+(g*s)**2),Math.sqrt((f*n)**2+(y*s)**2),Math.sqrt((p*n)**2+(m*s)**2));!function e(t,n,s){let d=1<<t,c=5*n,f=o[c],p=o[c+1],g=o[c+2],y=o[c+3],m=o[c+4],M=f*d*h[0]+u[0],C=p*d*h[1]+u[1],T=g*d*h[2]+u[2],x=M+d*h[0],P=C+d*h[1],U=T+d*h[2];if(M=Math.max(M,N),C=Math.max(C,O),T=Math.max(T,A),x=Math.min(x,_),P=Math.min(P,$),U=Math.min(U,L),(0,eR.Rq)(M,C,T,x,P,U,r)){let r=Math.max(R,function(e,t,r,i,n,s){return v*(e+k*(i-e))+b*(t+E*(n-t))+w*(r+I*(s-r))+S}(M,C,T,x,P,U))/D;if(0===s||r*i<s){let o=l[t];if(0!==o&&a(t,n,o/r,m>>>31),t>0&&(0===o||r*i<o)){let r=0===o?s:o,i=(0x7fffffff&m)>>>0;for(let n=y;n<i;++n)e(t-1,n,r)}}}}(d,o.length/5-1,0)}(e.manifest,iw,u,h,l.width,l.height,(r,s,l,u)=>{if(u)return;let h=i.getFragmentChunk(e,r,s);++this.numVisibleChunksNeeded,n.requestChunk(h,a,o+50-t+r),h.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable})}}}}function ik(e,t){let r,i,n;let s=io(e.vertexPositions,e.indices),a=new Uint8Array(s.length/3*2);if(!function(e,t){let r=t.length,i=0;for(let n=0;n<r;n+=3){let r=t[n],s=t[n+1],a=t[n+2],o=1/(Math.abs(r)+Math.abs(s)+Math.abs(a));if(a<0)e[i]=il((1-Math.abs(s*o))*(r<0?-1:1)),e[i+1]=il((1-Math.abs(r*o))*(s<0?-1:1));else e[i]=il(r*o),e[i+1]=il(s*o);i+=2}}(a,s),4===e.indices.BYTES_PER_ELEMENT&&e.vertexPositions.length/3<65535?(r=new Uint16Array(e.indices.length)).set(e.indices):r=e.indices,i=!1,t===r0.k_.uint10){let t=e.vertexPositions,r=t.length/3;n=new Uint32Array(r);for(let e=0,i=0;i<r;e+=3,++i)n[i]=1023&t[e]|(1023&t[e+1])<<10|(1023&t[e+2])<<20}else if(t===r0.k_.uint16){let t=e.vertexPositions;2===t.BYTES_PER_ELEMENT?n=t:(n=new Uint16Array(t.length)).set(t)}else n=e.vertexPositions;return{vertexPositions:n,vertexNormals:a,indices:r,strips:i}}function iE(e,t,r=r0.k_.float32){e.meshData=ik(t,r)}function iI(e,t,r){e.meshData=ik(t,r),e.subChunkOffsets=t.subChunkOffsets}function iM(e,t,r){let i=r;for(let r=0;r<3;++r)e[5*i+r]=e[5*t+r]>>>1;e[5*i+3]=t;for(let n=t+1;n<r;++n){let t=e[5*n]>>>1,r=e[5*n+1]>>>1,s=e[5*n+2]>>>1;(t!==e[5*i]||r!==e[5*i+1]||s!==e[5*i+2])&&(e[5*i+4]=n,e[5*++i]=t,e[5*i+1]=r,e[5*i+2]=s,e[5*i+3]=n)}return e[5*i+4]=r,++i}iS=ie([J(r0.nL)],iS);function iC(e){return{id:e}}let iT={id:"encodeCompressedSegmentationUint32"},ix={id:"encodeCompressedSegmentationUint64"},iP=0,iR=[],iN=new Map,iO=new Map,iA=void 0===navigator.hardwareConcurrency?4:Math.min(12,navigator.hardwareConcurrency),i_=0;function i$(e){for(let[t,r]of iN){iN.delete(t),r.cleanup?.(),e.postMessage(r.msg,r.transfer);return}iR.push(e)}function iL(e,t,i,...n){let s=i_++,a={t:e.id,id:s,args:n};t?.throwIfAborted();let o=new Promise((e,t)=>{iO.set(s,{resolve:e,reject:t})});if(0!==iR.length)iR.pop().postMessage(a,i);else{let e;if(void 0!==t){function l(){iN.delete(s);let e=iO.get(s);iO.delete(s),e.reject(t.reason)}t.addEventListener("abort",l,{once:!0}),e=()=>{t.removeEventListener("abort",l)}}iN.set(s,{msg:a,transfer:i,cleanup:e}),iO.size>iP&&iP<iA&&!function(){++iP;let e=new Worker(new URL(r.p+r.u("67"),r.b),Object.assign({},{type:"module"},{type:void 0})),t=!1;e.onmessage=r=>{if(!t){t=!0,i$(e);return}let{id:i,value:n,error:s}=r.data;i$(e);let a=iO.get(i);iO.delete(i),void 0!==a&&(void 0!==s?a.reject(Error(s)):a.resolve(n))}}()}return o}async function iD(e,t,r){let{spec:i}=e.source;if(void 0!==i.compressedSegmentationBlockSize){let{dataType:n}=i,s=e.chunkDataSize,a=[s[0],s[1],s[2],s[3]||1];switch(n){case e4.UINT32:e.data=await iL(iT,t,[r.buffer],r,a,i.compressedSegmentationBlockSize);break;case e4.UINT64:e.data=await iL(ix,t,[r.buffer],r,a,i.compressedSegmentationBlockSize);break;default:throw Error(`Unsupported data type for compressed segmentation: ${e4[n]}`)}}else e.data=r}async function iU(e,t,r){try{let i=new Response(e).body.pipeThrough(new DecompressionStream(t),{signal:r});return await new Response(i).arrayBuffer()}catch{throw r?.throwIfAborted(),Error(`Failed to decode ${t}`)}}let iz=new Map;for(let[e,t]of(iz.set("|u1",{endianness:tB.LITTLE,dataType:e4.UINT8}),iz.set("|i1",{endianness:tB.LITTLE,dataType:e4.INT8}),[["<",tB.LITTLE],[">",tB.BIG]])){for(let r of["u","i"])iz.set(`${e}${r}8`,{endianness:t,dataType:e4.UINT64});iz.set(`${e}u2`,{endianness:t,dataType:e4.UINT16}),iz.set(`${e}i2`,{endianness:t,dataType:e4.INT16}),iz.set(`${e}u4`,{endianness:t,dataType:e4.UINT32}),iz.set(`${e}i4`,{endianness:t,dataType:e4.INT32}),iz.set(`${e}f4`,{endianness:t,dataType:e4.FLOAT32})}class ij{data;shape;dataType;fortranOrder;constructor(e,t,r,i){this.data=e,this.shape=t,this.dataType=r,this.fortranOrder=i}}async function iF(e,t,r){let i=function(e){let t;if(147!==e[0]||78!==e[1]||85!==e[2]||77!==e[3]||80!==e[4]||89!==e[5])throw Error("Data does not match npy format.");let r=e[6],i=e[7];if(1!==r||0!==i)throw Error(`Unsupported npy version ${r}.${i}`);let n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(8,!0),s=new TextDecoder("utf-8").decode(e.subarray(10,n+10)),a=n+10;try{t=(0,eN.c6)(s)}catch(e){throw Error(`Failed to parse npy header: ${e}`)}let o=t.descr,l=t.shape,u=1;if(!Array.isArray(l))throw Error("Invalid shape ${JSON.stringify(shape)}");for(let e of l){if("number"!=typeof e)throw Error("Invalid shape ${JSON.stringify(shape)}");u*=e}let{dataType:h,endianness:d}=function(e){let t=iz.get(e);if(void 0===t)throw Error(`Unsupported numpy data type: ${JSON.stringify(e)}`);return t}(o),c=e6[h],f=e8[h],p=e5[h],g=f*u;if(c*u+a!==e.byteLength)throw Error("Expected length does not match length of data");let y=new p(e.buffer,e.byteOffset+a,g);return tJ(y,d,c),new ij(y,l,h,!0===t.fortran_order)}(new Uint8Array(await iU(r,"deflate"))),n=e.chunkDataSize,s=e.source,{shape:a}=i;if(3!==a.length||a[0]!==n[2]||a[1]!==n[1]||a[2]!==n[0])throw Error(`Shape ${JSON.stringify(a)} does not match chunkDataSize ${(0,eR.m0)(n)}`);let o=i.dataType,{spec:l}=s;if(o!==l.dataType)throw Error(`Data type ${e4[o]} does not match expected data type ${e4[l.dataType]}`);await iD(e,t,i.data)}let iB={id:"decodeJpeg"};async function iV(e,t,r){let i=e.chunkDataSize,{uint8Array:n}=await iL(iB,t,[r],new Uint8Array(r),void 0,void 0,i[0]*i[1]*i[2],i[3]||1,!1);await iD(e,t,n)}function iG(e,t){let{spec:r,tempChunkDataSize:i,tempChunkPosition:n}=e,{upperVoxelBound:s,rank:a,baseVoxelOffset:o}=r,l=r.chunkDataSize,u=function(e,t,r){let i=e.length;for(let n=0;n<i;++n)e[n]=t[n]*r[n];return e}(n,t.chunkGridPosition,l),h=!1;for(let e=0;e<a;++e){let t=Math.min(s[e],u[e]+l[e]);(i[e]=t-u[e])!==l[e]&&(h=!0)}return!function(e,t,r){let i=e.length;for(let n=0;n<i;++n)e[n]=t[n]+r[n];}(u,u,o),h?t.chunkDataSize=Uint32Array.from(i):t.chunkDataSize=l,u}class iq extends tI{tempChunkDataSize;tempChunkPosition;constructor(e,t){super(e,t);let r=this.spec.rank;this.tempChunkDataSize=new Uint32Array(r),this.tempChunkPosition=new Float32Array(r)}computeChunkBounds(e){return iG(this,e)}}function iY(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}iq.prototype.chunkConstructor=class e extends tE{source=null;data;chunkDataSize;initializeVolumeChunk(e,t){super.initializeVolumeChunk(e,t),this.chunkDataSize=null,this.data=null}serialize(e,t){super.serialize(e,t);let r=this.chunkDataSize;r!==this.source.spec.chunkDataSize&&(e.chunkDataSize=r);let i=e.data=this.data;null!==i&&t.push(i.buffer),this.data=null}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=this.data?.byteLength??0,super.downloadSucceeded()}freeSystemMemory(){this.data=null}};let iJ=new Map;iJ.set("npz",iF),iJ.set("jpeg",iV);let iK=new Map;function iW(e,t){return eE(rq()(e),t)}iK.set("npz","application/npygz"),iK.set("jpeg","image/jpeg");class iQ extends iW(iq,rX.Yz){chunkDecoder=iJ.get(this.parameters.encoding);async download(e,t){let{parameters:r}=this,i=`${r.baseUrl}/latest/cutout/${r.collection}/${r.experiment}/${r.channel}/${r.resolution}`;{let t=this.computeChunkBounds(e),r=e.chunkDataSize;for(let e=0;e<3;++e)i+=`/${t[e]}:${t[e]+r[e]}`}i+="/",void 0!==r.window&&(i+=`?window=${r.window[0]},${r.window[1]}`);let n=await rZ(this.credentialsProvider,i,{signal:t,headers:{Accept:iK.get(r.encoding)}});await this.chunkDecoder(e,t,await n.arrayBuffer())}}iQ=iY([J()],iQ);class iH extends iW(ic,rX.i6){download(e,t){let{parameters:r}=this;return rZ(this.credentialsProvider,`${r.baseUrl}${e.objectId}`,{signal:t}).then(e=>e.arrayBuffer()).then(t=>ia(e,t,"fragments"))}downloadFragment(e,t){let{parameters:r}=this;return rZ(this.credentialsProvider,`${r.baseUrl}${e.fragmentId}`,{signal:t}).then(e=>e.arrayBuffer()).then(t=>(function(e,t){var r,i,n,s,a;let o=new DataView(t).getUint32(0,!0);iE(e,(r=t,i=tB.LITTLE,n=4,ih(3,r,i,4,o,void 0,void 0)))})(e,t))}}function iZ(e,t,r){return void 0===e?rK(t,r):rH(e,t,r,(e,t)=>{if(!e.accessToken)return t;let r=new Headers(t.headers);return r.set("Authorization",`${e.tokenType} ${e.accessToken}`),{...t,headers:r}},e.errorHandler)}function iX(e,t,r){return iZ(t,`${e.serverUrl}${r.path}`,{signal:r.signal,method:r.method,body:r.payload})}iH=iY([J()],iH);var i0=r("3488"),i1=r("5105");class i2 extends ed{objectId=new tK.E;vertexPositions=null;vertexAttributes=null;indices=null;initializeSkeletonChunk(e,t){super.initialize(e),this.objectId.assign(t)}freeSystemMemory(){this.vertexPositions=this.indices=null}getVertexAttributeBytes(){let e=this.vertexPositions.byteLength,{vertexAttributes:t}=this;return null!=t&&t.forEach(t=>{e+=t.byteLength}),e}serialize(e,t){super.serialize(e,t);let r=this.vertexPositions,i=this.indices;e.numVertices=r.length/3,e.indices=i,t.push(i.buffer);let{vertexAttributes:n}=this;if(null!=n&&n.length>0){let i=new Uint8Array(this.getVertexAttributeBytes());i.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength));let s=e.vertexAttributeOffsets=new Uint32Array(n.length+1);s[0]=0;let a=r.byteLength;n.forEach((e,t)=>{s[t+1]=a,i.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a),a+=e.byteLength}),t.push(i.buffer),e.vertexAttributes=i}else e.vertexAttributes=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),e.vertexAttributeOffsets=Uint32Array.of(0),r.buffer!==t[0]&&t.push(r.buffer);this.vertexPositions=this.indices=this.vertexAttributes=null}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=this.indices.byteLength+this.getVertexAttributeBytes(),super.downloadSucceeded()}}class i3 extends ep{getChunk(e){let t=rC(e),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(i2)).initializeSkeletonChunk(t,e),this.addChunk(r)),r}}class i4 extends rP(tc(eI(eS))){source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;this.chunkManager.registerLayer(this);let t=tf(e),r=tp(e),{source:i,chunkManager:n}=this;rT(this,e=>{let s=i.getChunk(e);++this.numVisibleChunksNeeded,s.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable,n.requestChunk(s,t,r+60)})}}function i6(e,t,r,i,n,s,a){let o=ih(2,t,r,i,n,s,a);e.vertexPositions=o.vertexPositions,e.indices=o.indices}async function i5(e,t,r){e.data=new Uint32Array(r)}async function i8(e,t,r,i=tV,n=0,s=r.byteLength){let{spec:a}=e.source,{dataType:o}=a,l=function(e){let t=1;for(let r=0,i=e.length;r<i;++r)t*=e[r];return t}(e.chunkDataSize),u=e6[o],h=l*u;if(h!==s)throw Error(`Raw-format chunk is ${s} bytes, but ${l} * ${u} = ${h} bytes are expected.`);let d=e7(o,r,n,s);tJ(d,i,u),await iD(e,t,d)}i4=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J(i1.f)],i4);var i7=r("6235");function i9(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let ne=new Map([[i0.ke.RAW,i8],[i0.ke.JPEG,iV],[i0.ke.COMPRESSED_SEGMENTATION,i5]]);function nt(e,t){if(!!e)t.change_spec={change_stack_id:e.changeStackId},e.timeStamp&&(t.change_spec.time_stamp=e.timeStamp),e.skipEquivalences&&(t.change_spec.skip_equivalences=e.skipEquivalences)}function nr(e,t){return eE(rq()(e),t)}let ni=new tK.E;class nn extends nr(iq,i0.LV){chunkDecoder=ne.get(this.parameters.encoding);applyEncodingParams(e){let{encoding:t}=this.parameters;switch(t){case i0.ke.RAW:e.subvolume_format="RAW";break;case i0.ke.JPEG:e.subvolume_format="SINGLE_IMAGE",e.image_format_options={image_format:"JPEG",jpeg_quality:this.parameters.jpegQuality};return;case i0.ke.COMPRESSED_SEGMENTATION:e.subvolume_format="RAW",e.image_format_options={compressed_segmentation_block_size:(0,eR.m0)(this.spec.compressedSegmentationBlockSize)};break;default:throw Error(`Invalid encoding: ${t}`)}}async download(e,t){let{parameters:r}=this,i=this.computeChunkBounds(e),n=e.chunkDataSize,s=`/v1/volumes/${r.volumeId}/subvolume:binary`,a={geometry:{corner:(0,eR.m0)(i),size:(0,eR.m0)(n),scale:r.scaleIndex}};this.applyEncodingParams(a),nt(r.changeSpec,a);let o=await iX(r.instance,this.credentialsProvider,{method:"POST",payload:JSON.stringify(a),path:s,signal:t});await this.chunkDecoder(e,t,await o.arrayBuffer())}}nn=i9([J()],nn);function ns(e,t){let r=e.byteLength,i=0,n=new DataView(e);for(;i<r;){if(i+32>r)throw Error("Invalid batch mesh fragment response.");let s=n.getUint32(i,!0),a=n.getUint32(i+4,!0),o=new tK.E(s,a).toString()+"\0";i+=8;let l=n.getUint32(i,!0),u=n.getUint32(i+4,!0);if(i+=8,0!==u||i+l+8+8>r)throw Error("Invalid batch mesh fragment response.");let h=o+new TextDecoder().decode(new Uint8Array(e,i,l));i+=l;let d=n.getUint32(i,!0),c=n.getUint32(i+4,!0);i+=8;let f=n.getUint32(i,!0),p=n.getUint32(i+4,!0);if(i+=8,0!==c||0!==p)throw Error("Invalid batch mesh fragment response.");let g=i+12*f+12*d;if(g>r)throw Error("Invalid batch mesh fragment response.");t({fullKey:h,buffer:e,verticesOffset:i,numVertices:d,indicesOffset:i+12*d,numIndices:3*f}),i=g}}function na(e){let t=0,r=0;for(let i of e)t+=i.numVertices,r+=i.numIndices;let i=new Float32Array(3*t),n=new Uint32Array(r),s=0,a=0;for(let t of e){i.set(new Float32Array(t.buffer,t.verticesOffset,3*t.numVertices),3*s);let{numIndices:e}=t,r=new Uint32Array(t.buffer,t.indicesOffset,e);tY(r,tB.LITTLE);for(let t=0;t<e;++t)n[a++]=r[t]+s;s+=t.numVertices}return tY(i,tB.LITTLE),{vertexPositions:i,indices:n}}async function no(e,t,r,i){let n;let s=[],a=0,o=new Map;for(let[e,t]of r){o.set(e,t),r.delete(e);let i=e.indexOf("\0"),l=e.substring(0,i),u=e.substring(i+1);if(l!==n&&s.push({object_id:l,fragment_keys:[]}),s[s.length-1].fragment_keys.push(u),255==++a)break}let l={volume_id:t.volumeId,mesh_name:t.meshName,batches:s};try{return await (await iX(t.instance,e,{method:"POST",path:"/v1/objects/meshes:batch",payload:JSON.stringify(l),signal:i})).arrayBuffer()}finally{for(let[e,t]of o)r.set(e,t)}}class nl extends nr(iv,i0.f5){listFragmentsParams=(()=>{let{parameters:e}=this,{changeSpec:t}=e;return void 0!==t?`&header.changeStackId=${t.changeStackId}`:""})();download(e,t){let{parameters:r}=this,i=`/v1/objects/${r.volumeId}/meshes/${r.info.lods[0].info.name}:listfragments?object_id=${e.objectId}&return_supervoxel_ids=true`+this.listFragmentsParams;return iX(r.instance,this.credentialsProvider,{method:"GET",path:i,signal:t}).then(e=>e.json()).then(t=>(function(e,t){let r,i,n;(0,eN.PT)(t);let s=e.source,a=(0,eN.uq)(t,"fragmentKey",eN.zE),o=(0,eN.uq)(t,"supervoxelId",eN.zE),l=a.length;if(l!==o.length)throw Error("Expected fragmentKey and supervoxelId arrays to have the same length.");let u=new Map;a.forEach((e,t)=>{let r=u.get(e);void 0===r&&(r=[],u.set(e,r)),r.push(o[t])});let{chunkShape:h}=s.parameters.info,d=s.parameters.info.lods[0].gridShape,c=Math.ceil(Math.log2(d[0])),f=Math.ceil(Math.log2(d[1])),p=Math.ceil(Math.log2(d[2])),g=Array.from(u.entries()).map(([e,t])=>({fragmentId:e,corner:function(e,t,r,i){let n=new tK.E;if(!n.tryParseString(e,16))throw Error(`Couldn't parse fragmentId ${e} as hex-encoded Uint64`);return function(e,t,r,i){let n=Math.max(t,r,i),s=0,a=e.low,o=0,l=0,u=0;for(let h=0;h<n;++h)h<t&&(o|=(a>>>s&1)<<h,31===s?(s=0,a=e.high):++s),h<r&&(l|=(a>>>s&1)<<h,31===s?(s=0,a=e.high):++s),h<i&&(u|=(a>>>s&1)<<h,31===s?(s=0,a=e.high):++s);return Uint32Array.of(o,l,u)}(n,t,r,i)}(e,c,f,p),supervoxelIds:t}));g.sort((e,t)=>r9(e.corner[0],e.corner[1],e.corner[2],t.corner[0],t.corner[1],t.corner[2])?-1:1);let y=0;if(0===l)r=i=eR.b$,n=Uint32Array.of(0,0,0,0,0x80000000);else{let e=eR.R3.clone(eR.$k),t=eR.R3.clone(eR.b$);for(g.forEach(r=>{let{corner:i}=r;for(let r=0;r<3;++r)e[r]=Math.min(e[r],i[r]),t[r]=Math.max(t[r],i[r])}),y=1;t[0]>>>y-1!=e[0]>>>y-1||t[1]>>>y-1!=e[1]>>>y-1||t[2]>>>y-1!=e[2]>>>y-1;)++y;r=eR.R3.multiply(e,e,h),i=eR.R3.add(t,eR.R3.multiply(t,t,h),h)}let{lods:m}=s.parameters.info,v=new Float32Array(Math.max(m.length,y));for(let e=0;e<m.length;++e)v[e]=m[e].scale;if(0!==l){let e=new Uint32Array(g.length*v.length*5);g.forEach((t,r)=>{e.set(t.corner,5*r),e[5*r]=t.corner[0]});let t=0,r=g.length;for(let i=1;i<v.length;++i){let i=iM(e,t,r);t=r,r=i}n=e.slice(0,5*r)}let b={chunkShape:h,chunkGridSpatialOrigin:eR.b$,clipLowerBound:r,clipUpperBound:i,octree:n,lodScales:v,vertexOffsets:new Float32Array(3*v.length)};e.manifest=b,e.fragmentSupervoxelIds=g})(e,t))}async downloadFragment(e,t){let{parameters:r}=this,i=e.manifestChunk,{fragmentSupervoxelIds:n}=i,s=i.manifest,{lod:a}=e,{octree:o}=s,l=n.length,u=e.chunkIndex,h=u;for(;h>=l;)h=o[5*h+3];let d=u+1;for(;d>l;)d=0x7fffffff&o[5*d-1];let{relativeBlockShape:c,gridShape:f}=r.info.lods[a],p=Math.ceil(Math.log2(f[0])),g=Math.ceil(Math.log2(f[1])),y=Math.ceil(Math.log2(f[2])),m=new Map;for(let e=h;e<d;++e){let t=Math.floor(o[5*e]/c[0]),r=Math.floor(o[5*e+1]/c[1]),i=r8(ni,p,g,y,t,r,Math.floor(o[5*e+2]/c[2])).toString(16).padStart(16,"0");for(let t of n[e].supervoxelIds)m.set(t+"\0"+i,e)}let v=Math.max(0,a-1),b=[],w=Array.from(m);w.sort((e,t)=>(0,i7.B)(e[0],t[0])),m=new Map(w);let S=r.info.lods[a].info.name;await new Promise((i,n)=>{let s=0,a=!1,o=()=>{if(!a){for(;0!==m.size;)++s,no(this.credentialsProvider,{instance:r.instance,volumeId:r.volumeId,meshName:S},m,t).then(e=>{--s,ns(e,e=>{let t=m.get(e.fullKey);if(!m.delete(e.fullKey))throw Error(`Received unexpected fragment key: ${JSON.stringify(e.fullKey)}.`);e.chunkIndex=t,b.push(e)}),o()}).catch(e=>{a=!0,n(e)});if(e.downloadSlots=Math.max(1,s),0===s){i(void 0);return}}};o()}),b.sort((e,t)=>e.chunkIndex-t.chunkIndex);let k=0,E=1<<3*(a-v),I=new Uint32Array(E+1),M=0;for(let e of b){var C,T;let t=e.chunkIndex;let r=(C=o[5*t]>>>v,T=o[5*t+1]>>>v,(1&C|T<<1&2|o[5*t+2]>>>v<<2&4)&E-1);I.fill(k,M+1,r+1),M=r,k+=e.numIndices}I.fill(k,M+1,E+1),iI(e,{...na(b),subChunkOffsets:I},r0.k_.float32)}}nl=i9([J()],nl);class nu extends nr(ic,i0.i6){listFragmentsParams=(()=>{let{parameters:e}=this,{changeSpec:t}=e;return void 0!==t?`&header.changeStackId=${t.changeStackId}`:""})();download(e,t){let{parameters:r}=this,i=`/v1/objects/${r.volumeId}/meshes/${r.meshName}:listfragments?object_id=${e.objectId}&return_supervoxel_ids=true`+this.listFragmentsParams;return iX(r.instance,this.credentialsProvider,{signal:t,method:"GET",path:i}).then(e=>e.json()).then(t=>(function(e,t){(0,eN.PT)(t);let r=(0,eN.uq)(t,"fragmentKey",eN.zE),i=(0,eN.uq)(t,"supervoxelId",eN.zE);if(r.length!==i.length)throw Error("Expected fragmentKey and supervoxelId arrays to have the same length.");let n=i.map((e,t)=>e+"\0"+r[t]);e.fragmentIds=function(e){let t=[],r=0,i=e.length;for(;r<i;)t.push(JSON.stringify(e.slice(r,r+255))),r+=255;return t}(n)})(e,t))}async downloadFragment(e,t){let{parameters:r}=this,i=new Map;for(let t of JSON.parse(e.fragmentId))i.set(t,null);let n=[],{credentialsProvider:s}=this;for(;0!==i.size;)ns(await no(s,r,i,t),e=>{if(!i.delete(e.fullKey))throw Error(`Received unexpected fragment key: ${JSON.stringify(e.fullKey)}.`);n.push(e)});iE(e,na(n))}}nu=i9([J()],nu);class nh extends nr(i3,i0.zT){download(e,t){let{parameters:r}=this,i={object_id:`${e.objectId}`},n=`/v1/objects/${r.volumeId}/meshes/${r.meshName}/skeleton:binary`;return nt(r.changeSpec,i),iX(r.instance,this.credentialsProvider,{method:"POST",path:n,payload:JSON.stringify(i),signal:t}).then(e=>e.arrayBuffer()).then(t=>(function(e,t){let r=new DataView(t),i=r.getUint32(0,!0);if(0!==r.getUint32(4,!0))throw Error("The number of vertices should not exceed 2^32-1.");let n=r.getUint32(8,!0);if(0!==r.getUint32(12,!0))throw Error("The number of edges should not exceed 2^32-1.");i6(e,t,tB.LITTLE,16,i,void 0,n)})(e,t))}}nh=i9([J()],nh);let nd=["LOCATION","LINE","VOLUME"];function nc(e){let t=e.match(/(-?[0-9]+),(-?[0-9]+),(-?[0-9]+)/);if(null===t)throw Error(`Error parsing number triplet: ${JSON.stringify(e)}.`);return eR.R3.fromValues(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]))}function nf(e){return e.volumeId+":"+e.changestack+":"}function np(e,t){if(!t.startsWith(e))throw Error(`Received annotation id ${JSON.stringify(t)} does not have expected prefix of ${JSON.stringify(e)}.`);return t.substring(e.length)}function ng(e){if(null!=e)return[(0,eN.m7)(e,e=>tK.E.parseString(""+e,10))]}function ny(e,t,r){let i=(0,eN.uq)(e,"corner",e=>nc((0,eN.ZE)(e))),n=(0,eN.uq)(e,"size",e=>nc((0,eN.ZE)(e))),s=(0,eN.uq)(e,"payload",eN.kt),a=(0,eN.uq)(e,"type",eN.ZE),o=(0,eN.uq)(e,"id",eN.ZE),l=np(t,o),u=(0,eN.uq)(e,"objectLabels",ng);if(void 0!==r&&l!==r)throw Error(`Received annotation has unexpected id ${JSON.stringify(o)}.`);switch(a){case"LOCATION":{if(eR.R3.equals(n,eR.b$))return{type:tH.POINT,id:l,point:i,description:s,relatedSegments:u,properties:[]};let e=eR.R3.scale(eR.R3.create(),n,.5),t=eR.R3.add(eR.R3.create(),i,e);return{type:tH.ELLIPSOID,id:l,center:t,radii:e,description:s,relatedSegments:u,properties:[]}}case"LINE":return{type:tH.LINE,id:l,pointA:i,pointB:eR.R3.add(eR.R3.create(),i,n),description:s,relatedSegments:u,properties:[]};case"VOLUME":return{type:tH.AXIS_ALIGNED_BOUNDING_BOX,id:l,pointA:i,pointB:eR.R3.add(eR.R3.create(),i,n),description:s,relatedSegments:u,properties:[]};default:throw Error(`Unknown spatial annotation type: ${JSON.stringify(a)}.`)}}let nm=t1(3,[]);function nv(e,t){let r=new t7(nm),i=nf(e.source.parent.parameters);t.forEach((e,t)=>{try{(0,eN.PT)(e);let t=(0,eN.uq)(e,"annotations",e=>void 0===e?[]:e);if(!Array.isArray(t))throw Error(`Expected array, but received ${JSON.stringify(typeof t)}.`);for(let e of t)try{r.add(ny(e,i))}catch(e){throw Error(`Error parsing annotation: ${e.message}`)}}catch(e){throw Error(`Error parsing ${nd[t]} annotations: ${e.message}`)}}),e.data=Object.assign(new rA,r.serialize())}function nb(e){let t=e.indexOf(".");return e.substring(0,t)}function nw(e){return`${Math.round(e[0])},${Math.round(e[1])},${Math.round(e[2])}`}function nS(e,t){return`${e.volumeId}:${e.changestack}:${t}`}function nk(e){let t=e.description||"",r=void 0===e.relatedSegments?void 0:e.relatedSegments[0].map(e=>e.toString());switch(e.type){case tH.LINE:{let{pointA:i,pointB:n}=e,s=eR.R3.subtract(eR.R3.create(),n,i);return{type:"LINE",corner:nw(i),size:nw(s),object_labels:r,payload:t}}case tH.AXIS_ALIGNED_BOUNDING_BOX:{let{pointA:i,pointB:n}=e,s=function(e,t,r){let i=e.length;for(let n=0;n<i;++n)e[n]=Math.min(t[n],r[n]);return e}(eR.R3.create(),i,n),a=function(e,t,r){let i=e.length;for(let n=0;n<i;++n)e[n]=Math.max(t[n],r[n]);return e}(eR.R3.create(),i,n),o=eR.R3.subtract(a,a,s);return{type:"VOLUME",corner:nw(s),size:nw(o),object_labels:r,payload:t}}case tH.POINT:return{type:"LOCATION",corner:nw(e.point),size:"0,0,0",object_labels:r,payload:t};case tH.ELLIPSOID:{let i=eR.R3.subtract(eR.R3.create(),e.center,e.radii),n=eR.R3.scale(eR.R3.create(),e.radii,2);return{type:"LOCATION",corner:nw(i),size:nw(n),object_labels:r,payload:t}}}}class nE extends nr(rU,i0.WM){async download(e,t){let{parameters:r}=this;return Promise.all(nd.map(e=>iX(r.instance,this.credentialsProvider,{signal:t,method:"POST",path:`/v1/changes/${r.volumeId}/${r.changestack}/spatials:get`,payload:JSON.stringify({type:e,ignore_payload:!0})}).then(e=>e.json()))).then(t=>{nv(e,t)})}}nE=i9([J()],nE);class nI extends nr(rj,i0.Jb){downloadSegmentFilteredGeometry(e,t,r){let{parameters:i}=this;return Promise.all(nd.map(t=>iX(i.instance,this.credentialsProvider,{signal:r,method:"POST",path:`/v1/changes/${i.volumeId}/${i.changestack}/spatials:get`,payload:JSON.stringify({type:t,object_labels:[e.objectId.toString()],ignore_payload:!0})}).then(e=>e.json()))).then(t=>{nv(e,t)})}downloadMetadata(e,t){let{parameters:r}=this,i=e.key;return iX(r.instance,this.credentialsProvider,{signal:t,method:"POST",path:`/v1/changes/${r.volumeId}/${r.changestack}/spatials:get`,payload:JSON.stringify({type:nb(i),id:nS(r,i)})}).then(e=>e.json()).then(t=>{var n,s,a;e.annotation=(n=t,s=nf(r),a=i,(0,eN.PT)(n),ny((0,eN.uq)(n,"annotations",e=>(0,eN.Iw)([void 0],e,eN.PT))[0],s,a))},()=>{e.annotation=null})}add(e){let{parameters:t}=this,r=nk(e);return iX(t.instance,this.credentialsProvider,{method:"POST",path:`/v1/changes/${t.volumeId}/${t.changestack}/spatials:push`,payload:JSON.stringify({annotations:[r]})}).then(e=>e.json()).then(e=>{(0,eN.PT)(e);let t=(0,eN.uq)(e,"ids",eN.zE);if(1!==t.length)throw Error(`Expected list of 1 id, but received ${JSON.stringify(t)}.`);return np(nf(this.parameters),t[0])})}update(e,t){let{parameters:r}=this,i=nk(t);return i.id=nS(r,e),iX(r.instance,this.credentialsProvider,{method:"POST",path:`/v1/changes/${r.volumeId}/${r.changestack}/spatials:push`,payload:JSON.stringify({annotations:[i]})}).then(e=>e.json())}delete(e){let{parameters:t}=this;return iX(t.instance,this.credentialsProvider,{method:"POST",path:`/v1/changes/${t.volumeId}/${t.changestack}/spatials:delete`,payload:JSON.stringify({type:nb(e),ids:[nS(t,e)]})}).then(e=>e.json())}}nI=i9([J()],nI);let nM={id:"decodePng"};var nC=r("7484");async function nT(e,t,r){let i=function(e){let t=e.match(/^([^:/]+):\/\/([^/]+)((?:\/.*)?)$/);if(null===t)throw Error(`Invalid URL: ${JSON.stringify(e)}`);return{protocol:t[1],host:t[2],path:t[3]}}(t);switch(i.protocol){case"gs":return iZ(e,`https://www.googleapis.com/storage/v1/b/${i.host}/o/${encodeURIComponent(i.path.substring(1))}?alt=media&neuroglancer=${tW()}`,r);case"gs+xml":return iZ(e,`https://storage.googleapis.com/${i.host}${i.path}?neuroglancer=${tW()}`,r);case"s3":var n,s;return n=i.host,s=i.path,rK(`https://${n}.s3.amazonaws.com${s}`,r);default:return iZ(e,t,r)}}class nx extends eE(rq()(iq),nC.j){gridShape=(()=>{let e=new Uint32Array(2),{upperVoxelBound:t,chunkDataSize:r}=this.spec;for(let i=0;i<2;++i)e[i]=Math.ceil(t[i]/r[i]);return e})();async download(e,t){let{parameters:r}=this,{tilesize:i,overlap:n,encoding:s}=r,[a,o]=e.chunkGridPosition,l=0===a?0:n,u=0===o?0:n,h=`${r.url}/${a}_${o}.${r.format}`;try{let r;let n=await (await nT(this.credentialsProvider,h,{signal:t})).arrayBuffer(),a=0,o=0;switch(s){case nC.W.PNG:{let e=await iL(nM,t,[n],new Uint8Array(n),void 0,void 0,void 0,3,1,!1);({width:a,height:o}=e),r=function(e,t,r){let i=new e.constructor(e.length);for(let n=0;n<3*t;n+=r)for(let s=0;s<r;s++)i[s*t+n/r]=e[n+s];return i}(e.uint8Array,a*o,3);break}case nC.W.JPG:case nC.W.JPEG:{let e=await iL(iB,t,[n],new Uint8Array(n),void 0,void 0,void 0,3,!1);({uint8Array:r,width:a,height:o}=e)}}if(void 0!==r){let t=i*i,n=a*o,s=e.data=new Uint8Array(3*t);for(let e=0;e<3;e++)for(let h=0;h<o;h++)for(let o=0;o<a;o++)s[o+h*i+e*t]=r[o+l+(h+u)*a+e*n]}}catch(e){if(!rQ(e))throw e}}}nx=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J()],nx);class nP{baseUrl;nodeKey;constructor(e,t){this.baseUrl=e,this.nodeKey=t}getNodeApiUrl(e=""){return`${this.baseUrl}/api/node/${this.nodeKey}${e}`}getRepoInfoUrl(){return`${this.baseUrl}/api/repos/info`}getKeyValueUrl(e,t){return`${this.getNodeApiUrl()}/${e}/key/${t}`}getKeyValueRangeUrl(e,t,r){return`${this.getNodeApiUrl()}/${e}/keyrange/${t}/${r}`}getKeyValuesUrl(e){return`${this.getNodeApiUrl()}/${e}/keyvalues?jsontar=false`}}function nR(e,t){return e.includes("?")?e+="&":e+="?",e+="app=Neuroglancer",t&&(e+=`&u=${t}`),e}function nN(e,t,r){return rH(e,t,r,(e,t)=>{let r={...t};return e.token&&(r.headers={...r.headers,Authorization:`Bearer ${e}`}),r},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e})}var nO=r("2600");class nA{type;x;y;z;radius;parent}function n_(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}function n$(e,t){return eE(rq()(e),t)}class nL extends n$(i3,nO.zT){download(e,t){let{parameters:r}=this,i=`${e.objectId}`,n=`${r.baseUrl}/api/node/${r.nodeKey}/${r.dataInstanceKey}/key/`+i+"_swc";return nN(this.credentialsProvider,nR(n,r.user),{signal:t}).then(e=>e.arrayBuffer()).then(t=>{!function(e,t){let r=function(e){let t=e.split("\n"),r=[],i="-?\\d*(?:\\.\\d+)?",n=RegExp("^[ \\t]*("+["\\d+","\\d+",i,i,i,i,"-1|\\d+"].join(")[ \\t]+(")+")[ \\t]*$");return t.forEach(e=>{let t=e.match(n);if(t){let e=r[parseInt(t[1],10)]=new nA;e.type=parseInt(t[2],10),e.x=parseFloat(t[3]),e.y=parseFloat(t[4]),e.z=parseFloat(t[5]),e.radius=parseFloat(t[6]),e.parent=parseInt(t[7],10)}}),r}(t);if(r.length<1)throw Error("ERROR parsing swc data");let i=new Uint32Array(r.length),n=0,s=0;r.forEach((e,t)=>{e&&(i[t]=n++,e.parent>=0&&++s)});let a=new Float32Array(3*n),o=new Uint32Array(2*s),l=0,u=0;r.forEach(e=>{e&&(a[3*l]=e.x,a[3*l+1]=e.y,a[3*l+2]=e.z,e.parent>=0&&(o[2*u]=l,o[2*u+1]=i[e.parent],++u),++l)}),e.indices=o,e.vertexPositions=a}(e,new TextDecoder("utf-8").decode(t))})}}nL=n_([J()],nL);class nD extends n$(ic,nO.i6){download(e){return e.fragmentIds=[`${e.objectId}`],Promise.resolve(void 0)}downloadFragment(e,t){let{parameters:r}=this,i=new nP(r.baseUrl,r.nodeKey).getKeyValueUrl(r.dataInstanceKey,`${e.fragmentId}.ngmesh`);return nN(this.credentialsProvider,nR(i,r.user),{signal:t}).then(e=>e.arrayBuffer()).then(t=>(function(e,t){var r,i,n,s,a;let o=new DataView(t).getUint32(0,!0);iE(e,(r=t,i=tB.LITTLE,n=4,ih(3,r,i,4,o,void 0,void 0)))})(e,t))}}nD=n_([J()],nD);class nU extends n$(iq,nO.Yz){async download(e,t){let r;let i=this.parameters;{let t=this.computeChunkBounds(e),i=e.chunkDataSize;r=this.getPath(t,i)}let n=this.getDecoder(i),s=await nN(this.credentialsProvider,nR(`${i.baseUrl}${r}`,i.user),{signal:t}).then(e=>e.arrayBuffer());await n(e,t,i.encoding===nO.ke.JPEG?s.slice(16):s)}getPath(e,t){let r=this.parameters;return r.encoding===nO.ke.JPEG?`/api/node/${r.nodeKey}/${r.dataInstanceKey}/subvolblocks/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}`:r.encoding===nO.ke.RAW?`/api/node/${r.nodeKey}/${r.dataInstanceKey}/raw/0_1_2/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}/jpeg`:r.encoding===nO.ke.COMPRESSED_SEGMENTATIONARRAY?`/api/node/${r.nodeKey}/${r.dataInstanceKey}/raw/0_1_2/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}?compression=googlegzip&scale=${r.dataScale}`:`/api/node/${r.nodeKey}/${r.dataInstanceKey}/raw/0_1_2/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}?compression=googlegzip`}getDecoder(e){return e.encoding===nO.ke.JPEG||e.encoding===nO.ke.RAW?iV:i5}}nU=n_([J()],nU);class nz{url;static RPC_ID="graphene/ChunkedGraphSource"}class nj{manifestUrl;fragmentUrl;lod;sharding;nBitsForLayerId;static RPC_ID="graphene/MeshSource"}function nF(e,t){let r=tK.E.rshift(new tK.E,e,64-t);return tK.E.equal(r,tK.E.ONE)}var nB=r("7927");class nV extends ed{decodedKey;data;requesters;initialize(e){super.initialize(e),this.requesters=new Set}downloadSucceeded(){super.downloadSucceeded();let{requesters:e,data:t}=this;for(let r of(this.requesters=void 0,e))r.resolve(t)}downloadFailed(e){super.downloadFailed(e);let{requesters:t}=this;for(let r of(this.requesters=void 0,t))r.reject(e)}freeSystemMemory(){this.data=void 0}}class nG extends ec{encodeKeyFunction;downloadFunction;constructor(e,t){super(e),this.registerDisposer(e);let{encodeKey:r=eN.hd}=t;this.downloadFunction=t.download,this.encodeKeyFunction=r;let{sourceQueueLevel:i=0}=t;this.sourceQueueLevel=i,this.registerDisposer(this.chunkManager.recomputeChunkPrioritiesLate.add(()=>{this.updateChunkPriorities()}))}updateChunkPriorities(){let{chunkManager:e}=this;for(let t of this.chunks.values()){let{requesters:r}=t;if(void 0!==r)for(let i of r){let{priorityTier:r,priority:n}=i.getPriority();r!==Z.RECENT&&e.requestChunk(t,r,n,H.SYSTEM_MEMORY_WORKER)}}}async download(e,t){let{size:r,data:i}=await this.downloadFunction(e.decodedKey,t);e.systemMemoryBytes=r,e.data=i}getData(e,t,r){let i=this.encodeKeyFunction(e),n=this.chunks.get(i);return void 0===n&&((n=this.getNewChunk_(nV)).decodedKey=e,n.initialize(i),this.addChunk(n)),new Promise((e,i)=>{switch(n.state){case H.FAILED:i(n.error);return;case H.SYSTEM_MEMORY_WORKER:e(n.data);return}function s(){let{requesters:e}=n;void 0!==e&&(e.delete(a),n.chunkManager.scheduleUpdateChunkPriorities()),i(r.reason)}let a={resolve:e,reject:i,getPriority:t,cleanup:()=>r.removeEventListener("abort",s)};n.requesters.add(a),r.addEventListener("abort",s,{once:!0}),this.chunkManager.scheduleUpdateChunkPriorities()})}static get(e,t,r){return e.memoize.get(`getFileSource:${t}`,()=>new nG(e.addRef(),r))}static getData(e,t,r,i,n,s){let a=nG.get(e,t,r),o=a.getData(i,n,s);return a.dispose(),o}static getUrl(e,t,r,i,n,s){return nG.getData(e,`${(0,nB.M)(r)}`,{download:(e,i)=>nT(t,e,{signal:i}).then(e=>e.arrayBuffer()).then(e=>r(e,i))},i,n,s)}}class nq extends ed{promise;outstandingRequests=0;sharedAbortController;initialize(e){super.initialize(e)}freeSystemMemory(){this.promise=void 0}}class nY extends ec{constructor(e,t){super(e),this.registerDisposer(e),this.downloadFunction=t.get,this.encodeKeyFunction=t.encodeKey??eN.hd}encodeKeyFunction;downloadFunction;get(e,t){let r=this.encodeKeyFunction(e),i=this.chunks.get(r);if(void 0===i&&((i=this.getNewChunk_(nq)).initialize(r),this.addChunk(i)),void 0===i.promise||i.sharedAbortController?.signal.aborted){let t=!1,r=i.sharedAbortController=new N;r.signal.addEventListener("abort",()=>{!t&&(i.promise=void 0)}),i.promise=(async()=>{try{let{data:t,size:n}=await this.downloadFunction(e,r.signal);return i.systemMemoryBytes=n,i.queueManager.updateChunkState(i,H.SYSTEM_MEMORY),t}catch(e){throw i.queueManager.updateChunkState(i,H.FAILED),e}finally{t=!0,r[Symbol.dispose]()}})()}return i.sharedAbortController.addConsumer(t),i.sharedAbortController.start(),O(i.promise,t)}}var nJ=r("602");let nK=0,nW={emscripten_notify_memory_growth:e=>{},neuroglancer_draco_receive_decoded_mesh:(e,t,r,n,s)=>{let a=i.exports.memory,o=new Uint32Array(a.buffer,r,3*e).slice(),u=new Uint32Array(a.buffer,n,3*t).slice(),h=new Uint32Array(a.buffer,s,nK+1).slice();l={indices:o,vertexPositions:u,subChunkOffsets:h}},proc_exit:e=>{throw`proc exit: ${e}`}};function nQ(){return void 0==n&&(n=(async()=>{let e=i=(await WebAssembly.instantiateStreaming(fetch(new URL(r(8522),r.b)),{env:nW,wasi_snapshot_preview1:nW})).instance;return e.exports._initialize(),e})()),n}async function nH(e,t,r){let i=await nQ(),n=i.exports.malloc(e.byteLength);new Uint8Array(i.exports.memory.buffer).set(e,n),nK=r?8:1;let s=i.exports.neuroglancer_draco_decode(n,e.byteLength,r,t,!0);if(0===s){let e=l;if(l=void 0,e instanceof Error)throw e;return e}throw Error(`Failed to decode draco mesh: ${s}`)}async function nZ(e){let t=await nQ(),r=t.exports.malloc(e.byteLength);new Uint8Array(t.exports.memory.buffer).set(e,r);let i=t.exports.neuroglancer_draco_decode(r,e.byteLength,!1,0,!1);if(0===i){let e=l;if(l=void 0,e instanceof Error)throw e;return e.vertexPositions=new Float32Array(e.vertexPositions.buffer),e}throw Error(`Failed to decode draco mesh: ${i}`)}let nX={id:"decodeCompresso"};async function n0(e,t,r){let i=await iL(nX,t,[r],new Uint8Array(r));await i8(e,t,i.buffer)}let n1={id:"decodeJxl"};async function n2(e,t,r){let i=e.chunkDataSize,{uint8Array:n}=await iL(n1,t,[r],new Uint8Array(r),i[0]*i[1]*i[2],i[3]||1,1);await iD(e,t,n)}async function n3(e,t,r){let i=e.chunkDataSize,n=e.source.spec.dataType,{uint8Array:s}=await iL(nM,t,[r],new Uint8Array(r),void 0,void 0,i[0]*i[1]*i[2],i[3]||1,e6[n],!1);await i8(e,t,s.buffer)}let n4=-1!==navigator.userAgent.indexOf("Chrome")?"no-store":"default";function n6(e,t,r,i,n){var s,a;let o;return nT(e,t,{headers:(s=r,"number"==typeof(a=i)?o=`${a-1}`:(tK.E.decrement(rW,a),o=rW.toString()),{Range:`bytes=${s}-${o}`}),cache:n4,signal:n}).then(e=>e.arrayBuffer())}function n5(e){return e^=e>>>16,e=Math.imul(e,0x85ebca6b),e^=e>>>13,e=Math.imul(e,0xc2b2ae35),e^=e>>>16}function n8(e,t){return e<<t|e>>>32-t}function n7(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let n9=new Map([[nJ.wC.MURMURHASH3_X86_128,e=>{var t,r,i,n;let s,a,o,l,u,h;t=e,r=0,i=e.low,n=e.high,s=0,a=r,o=r,l=r,a^=u=Math.imul(u=n8(u=Math.imul(n,0xab0e9789),16),0x38b34ae5),s^=h=Math.imul(h=n8(h=Math.imul(i,0x239b961b),15),0xab0e9789),s^=8,a^=8,o^=8,l^=8,s=(s=(s=s+a>>>0)+o>>>0)+l>>>0,a=a+s>>>0,o=o+s>>>0,l=l+s>>>0,s=n5(s),a=n5(a),o=n5(o),l=n5(l),s=(s=(s=s+a>>>0)+o>>>0)+l>>>0,a=a+s>>>0,t.low=s,t.high=a}],[nJ.wC.IDENTITY,e=>{}]]);function se(e,t,r){let{url:i,sharding:n}=r;if(void 0===n)return;let s=nG.get(e,(0,eN.hd)({type:"precomputed:shardedDataSource",url:i,sharding:n,credentialsProvider:(0,nB.M)(t)}),{download:async(e,r)=>{let s;let a=tK.E.lowMask(new tK.E,n.minishardBits);tK.E.and(a,a,e);let o=tK.E.lowMask(new tK.E,n.shardBits),l=new tK.E;tK.E.rshift(l,e,n.minishardBits),tK.E.and(o,o,l);let u=`${i}/${o.toString(16).padStart(Math.ceil(n.shardBits/4),"0")}.shard`,h=new tK.E(16);tK.E.lshift(h,h,n.minishardBits);let d=tK.E.lshift(new tK.E,a,4),c=tK.E.addUint32(new tK.E,d,16);try{s=await n6(t,u,d,c,r)}catch(e){if(rQ(e))return{data:void 0,size:0};throw e}if(16!==s.byteLength)throw Error("Failed to retrieve minishard offset");let f=new DataView(s),p=new tK.E(f.getUint32(0,!0),f.getUint32(4,!0)),g=new tK.E(f.getUint32(8,!0),f.getUint32(12,!0));if(tK.E.equal(p,g))return{data:void 0,size:0};tK.E.add(p,p,h),tK.E.add(g,g,h);let y=await n6(t,u,p,g,r);if(n.minishardIndexEncoding===nJ.qm.GZIP&&(y=await iU(y,"gzip")),y.byteLength%24!=0)throw Error(`Invalid minishard index length: ${y.byteLength}`);let m=new Uint32Array(y);tY(m,tB.LITTLE);let v=m.byteLength/24,b=0,w=0,S=h.low,k=h.high;for(let e=0;e<v;++e){let t=b+m[2*e],r=w+m[2*e+1];t>=0x100000000&&(t-=0x100000000,r+=1),b=m[2*e]=t,w=m[2*e+1]=r;let i=S+m[(v+e)*2],n=k+m[(v+e)*2+1];i>=0x100000000&&(i-=0x100000000,n+=1),m[(v+e)*2]=i,m[(v+e)*2+1]=n;let s=m[(2*v+e)*2],a=m[(2*v+e)*2+1],o=i+s,l=n+a;o>=0x100000000&&(o-=0x100000000,l+=1),S=o,k=l,m[(2*v+e)*2]=o,m[(2*v+e)*2+1]=l}return{data:{data:m,shardUrl:u},size:m.byteLength}},encodeKey:e=>e.toString(),sourceQueueLevel:1});return s.sharding=n,s.credentialsProvider=t,s}async function st(e,t,r,i){let{sharding:n}=e,s=n9.get(n.hash),a=tK.E.rshift(new tK.E,r,n.preshiftBits);s(a);let o=tK.E.lowMask(new tK.E,n.minishardBits+n.shardBits);tK.E.and(o,o,a);let l=await e.getData(o,()=>({priorityTier:t.priorityTier,priority:t.priority}),i);if(void 0===l)return;let u=function(e,t){let r=e.data,i=r.length/6,n=t.low,s=t.high;for(let e=0;e<i;++e){if(r[2*e]!==n||r[2*e+1]!==s)continue;let t=new tK.E(r[(i+e)*2],r[(i+e)*2+1]);return{startOffset:t,endOffset:new tK.E(r[(2*i+e)*2],r[(2*i+e)*2+1])}}}(l,r);if(void 0===u)return;let{startOffset:h,endOffset:d}=u,c=await n6(e.credentialsProvider,l.shardUrl,h,d,i);return e.sharding.dataEncoding===nJ.qm.GZIP&&(c=await iU(c,"gzip")),{data:c,shardInfo:{shardUrl:l.shardUrl,offset:h}}}function sr(e){if(void 0===e)throw Error("not found");return e}let si=new Map;si.set(nJ.ke.RAW,i8),si.set(nJ.ke.JPEG,iV),si.set(nJ.ke.COMPRESSED_SEGMENTATION,i5),si.set(nJ.ke.COMPRESSO,n0),si.set(nJ.ke.PNG,n3),si.set(nJ.ke.JXL,n2);class sn extends eE(rq()(iq),nJ.Yz){chunkDecoder=si.get(this.parameters.encoding);minishardIndexSource=se(this.chunkManager,this.credentialsProvider,this.parameters);gridShape=(()=>{let e=new Uint32Array(3),{upperVoxelBound:t,chunkDataSize:r}=this.spec;for(let i=0;i<3;++i)e[i]=Math.ceil(t[i]/r[i]);return e})();async download(e,t){let r;let{parameters:i}=this,{minishardIndexSource:n}=this;if(void 0===n){let n;{let t=this.computeChunkBounds(e),r=e.chunkDataSize;n=`${i.url}/${t[0]}-${t[0]+r[0]}_${t[1]}-${t[1]+r[1]}_${t[2]}-${t[2]+r[2]}`}try{r=await nT(this.credentialsProvider,n,{signal:t}).then(e=>e.arrayBuffer())}catch(e){if(rQ(e))r=void 0;else throw e}}else{this.computeChunkBounds(e);let{gridShape:i}=this,{chunkGridPosition:s}=e,a=Math.ceil(Math.log2(i[0])),o=Math.ceil(Math.log2(i[1])),l=Math.ceil(Math.log2(i[2])),u=r8(new tK.E,a,o,l,s[0],s[1],s[2]);r=(await st(n,e,u,t))?.data}void 0!==r&&await this.chunkDecoder(e,t,r)}}function ss(e,t){return ia(e,t,"fragments")}sn=n7([J()],sn);class sa extends eE(rq()(ic),nJ.i6){async download(e,t){let{parameters:r}=this,i=await nT(this.credentialsProvider,`${r.url}/${e.objectId}:${r.lod}`,{signal:t});ss(e,await i.json())}async downloadFragment(e,t){let{parameters:r}=this,i=await nT(this.credentialsProvider,`${r.url}/${e.fragmentId}`,{signal:t});!function(e,t){var r,i,n,s,a;let o=new DataView(t).getUint32(0,!0);iE(e,(r=t,i=tB.LITTLE,n=4,ih(3,r,i,4,o,void 0,void 0)))}(e,await i.arrayBuffer())}}sa=n7([J()],sa);async function so(e,t){let{lod:r}=e,i=e.manifestChunk.source;iI(e,await nH(new Uint8Array(t),i.parameters.metadata.vertexQuantizationBits,0!==r),i.format.vertexPositionFormat)}class sl extends eE(rq()(iv),nJ.f5){minishardIndexSource=se(this.chunkManager,this.credentialsProvider,{url:this.parameters.url,sharding:this.parameters.metadata.sharding});async download(e,t){let r;let{parameters:i,minishardIndexSource:n}=this;void 0===n?r=await nT(this.credentialsProvider,`${i.url}/${e.objectId}.index`,{signal:t}).then(e=>e.arrayBuffer()):{data:r,shardInfo:e.shardInfo}=sr(await st(n,e,e.objectId,t)),!function(e,t){let r;if(t.byteLength<28||t.byteLength%4!=0)throw Error(`Invalid index file size: ${t.byteLength}`);let i=new DataView(t),n=0,s=eR.R3.fromValues(i.getFloat32(n,!0),i.getFloat32(n+4,!0),i.getFloat32(n+8,!0));n+=12;let a=eR.R3.fromValues(i.getFloat32(n,!0),i.getFloat32(n+4,!0),i.getFloat32(n+8,!0));n+=12;let o=i.getUint32(n,!0);if(n+=4,t.byteLength<n+20*o)throw Error(`Invalid index file size for ${o} lods: ${t.byteLength}`);let l=new Float32Array(t,n,o);n+=4*o,tY(l,tB.LITTLE);let u=new Float32Array(t,n,3*o);tY(u,tB.LITTLE);let h=new Uint32Array(t,n+=12*o,o);n+=4*o,tY(h,tB.LITTLE);let d=h.reduce((e,t)=>e+t);if(t.byteLength!==n+16*d)throw Error(`Invalid index file size for ${o} lods and ${d} total fragments: ${t.byteLength}`);let c=new Uint32Array(t,n);tY(c,tB.LITTLE);let f=eR.R3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),p=eR.R3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),g=Math.max(1,l.length);{let e=0;for(let t=0;t<o;++t){let r=h[t];for(let i=0;i<3;++i){let n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=e+r*i;for(let e=0;e<r;++e){let t=c[a+e];n=Math.max(n,t),s=Math.min(s,t)}if(0!==r){for(;n>>>g-t-1!=s>>>g-t-1;)++g;0===t&&(f[i]=Math.min(f[i],(1<<t)*s),p[i]=Math.max(p[i],(1<<t)*(n+1)))}}e+=4*r}}let y=0;{let e=0,t=0;for(let r=0;r<o;++r){let i=h[r];y+=e*(r-t),t=r,e=i,y+=i}y+=(g-1-t)*e}let m=new Uint32Array(5*y),v=new Float64Array(y+1);{let t=0,i=0,n=0,s=0;for(let e=0;e<o;++e){let r=h[e];for(let e=0;e<r;++e){for(let t=0;t<3;++t)m[5*(i+e)+t]=c[s+e+t*r];let t=c[s+e+3*r];n+=t,v[i+e+1]=n,0===t&&(m[5*(i+e)+4]=0x80000000)}for(s+=4*r,0!==e&&!function(e,t,r,i){let n=t;for(let t=r;t<i;++t){let i=e[5*t],s=e[5*t+1],a=e[5*t+2];for(;n<r;){let t=e[5*n]>>>1,r=e[5*n+1]>>>1;if(!r9(t,r,e[5*n+2]>>>1,i,s,a))break;++n}for(e[5*t+3]=n;n<r;){let t=e[5*n]>>>1,r=e[5*n+1]>>>1,o=e[5*n+2]>>>1;if(t!==i||r!==s||o!==a)break;++n}e[5*t+4]+=n}}(m,t,i,i+r),t=i,i+=r;e+1<g&&(e+1>=l.length||0===l[e+1]);){let r=iM(m,t,i);v.fill(n,i+1,r+1),t=i,i=r,++e}}r=m.slice(0,5*i),e.offsets=v.slice(0,i+1)}let{lodScaleMultiplier:b}=e.source.parameters.metadata,w=new Float32Array(g);w.set(l,0);for(let e=0;e<l.length;++e)w[e]*=b;e.manifest={chunkShape:s,chunkGridSpatialOrigin:a,clipLowerBound:eR.R3.add(f,a,eR.R3.multiply(f,f,s)),clipUpperBound:eR.R3.add(p,a,eR.R3.multiply(p,p,s)),octree:r,lodScales:w,vertexOffsets:u}}(e,r)}async downloadFragment(e,t){let r,i,n;let{parameters:s}=this,a=e.manifestChunk,o=e.chunkIndex,{shardInfo:l,offsets:u}=a,h=u[o],d=u[o+1];if(void 0!==l){r=l.shardUrl;let e=u[u.length-1],t=l.offset.low-e+h,s=l.offset.high,a=t+d-h,o=s;for(;t<0;)t+=0x100000000,s-=1;for(;a<0;)a+=0x100000000,o-=1;for(;a>0x100000000;)a-=0x100000000,o+=1;i=new tK.E(t,s),n=new tK.E(a,o)}else r=`${s.url}/${a.objectId}`,i=h,n=d;let c=await n6(this.credentialsProvider,r,i,n,t);await so(e,c)}}async function su(e,t,r,i,n,s){if(void 0===i)try{return await nT(e,`${t}/${n}`,{signal:s}).then(e=>e.arrayBuffer())}catch(e){if(rQ(e))return;throw e}let a=await st(i,r,n,s);if(void 0!==a)return a.data}sl=n7([J()],sl);class sh extends eE(rq()(i3),nJ.zT){minishardIndexSource=se(this.chunkManager,this.credentialsProvider,{url:this.parameters.url,sharding:this.parameters.metadata.sharding});async download(e,t){let{parameters:r}=this,i=sr(await su(this.credentialsProvider,r.url,e,this.minishardIndexSource,e.objectId,t));!function(e,t,r){let i=new DataView(t),n=i.getUint32(0,!0),s=i.getUint32(4,!0),a=8+12*n;i6(e,t,tB.LITTLE,8,n,a,s),a+=8*s;let o=[];for(let e of r.values()){let r=e6[e.dataType]*e.numComponents,i=r*n,s=new Uint8Array(t,a,i);switch(r){case 2:!function(e,t,r=tV){t!==r&&tG(e)}(s,tB.LITTLE);break;case 4:case 8:tY(s,tB.LITTLE)}o.push(s),a+=i}e.vertexAttributes=o}(e,i,r.metadata.vertexAttributes)}}function sd(e,t,r){let i;let n=new DataView(e);if(e.byteLength<=8)throw Error("Expected at least 8 bytes");let s=n.getUint32(0,!0);if(0!==n.getUint32(4,!0))throw Error("Annotation count too high");let a=r.serializedBytes,o=8+(a+8)*s;if(e.byteLength!==o)throw Error(`Expected ${o} bytes, but received: ${e.byteLength} bytes`);let l=8+a*s,u=new tK.E,h=Array(s);for(let e=0;e<s;++e)u.low=n.getUint32(l+8*e,!0),u.high=n.getUint32(l+8*e+4,!0),h[e]=u.toString();let d=new rA,c=new Uint8Array(e,8,a*s),{propertyGroupBytes:f}=r;if(f.length>1){i=new Uint8Array(c.length);let e=0,t=0;for(let r=0;r<f.length;++r){let n=f[r];for(let r=0;r<s;++r){let s=e+r*a,o=t+r*n;for(let e=0;e<n;++e)i[o+e]=c[s+e]}e+=n,t+=n*s}}else i=c;d.data=i;let p=d.typeToOffset=Array(tZ.length);p.fill(0),p[t.type]=0;let g=d.typeToIds=Array(tZ.length),y=d.typeToIdMaps=Array(tZ.length);return g.fill([]),g[t.type]=h,y.fill(new Map),y[t.type]=new Map(h.map((e,t)=>[e,t])),d}sh=n7([J()],sh);class sc extends eE(rq()(rU),nJ.WM){minishardIndexSource=se(this.chunkManager,this.credentialsProvider,this.parameters);async download(e,t){let r;let{parameters:i}=this,{minishardIndexSource:n}=this,{parent:s}=this,{chunkGridPosition:a}=e;if(void 0===n){let e=`${i.url}/${a.join("_")}`;try{r=await nT(this.credentialsProvider,e,{signal:t}).then(e=>e.arrayBuffer())}catch(e){if(!rQ(e))throw e}}else{let{upperChunkBound:i}=this.spec,{chunkGridPosition:s}=e,a=function(e,t,r){let i=0,n=t.length,s=0,a=!1;for(let l=0;l<32;++l)for(let u=0;u<n;++u)if(r[u]-1>>>l){var o;o=t[u]>>>l,s|=(1&o)<<i,32==++i&&(e.low=s>>>0,s=0,i=0,a=!0)}return a?e.high=s>>>0:(e.high=0,e.low=s>>>0),e}(new tK.E,s,i),o=await st(n,e,a,t);void 0!==o&&(r=o.data)}void 0!==r&&(e.data=sd(r,s.parameters,s.annotationPropertySerializer))}}sc=n7([J()],sc);class sf extends eE(rq()(rj),nJ.Jb){byIdMinishardIndexSource=se(this.chunkManager,this.credentialsProvider,this.parameters.byId);relationshipIndexSource=this.parameters.relationships.map(e=>se(this.chunkManager,this.credentialsProvider,e));annotationPropertySerializer=new t0(this.parameters.rank,t5[this.parameters.type].serializedBytes(this.parameters.rank),this.parameters.properties);async downloadSegmentFilteredGeometry(e,t,r){let{parameters:i}=this,n=await su(this.credentialsProvider,i.relationships[t].url,e,this.relationshipIndexSource[t],e.objectId,r);void 0!==n&&(e.data=sd(n,this.parameters,this.annotationPropertySerializer))}async downloadMetadata(e,t){let{parameters:r}=this,i=tK.E.parseString(e.key),n=await su(this.credentialsProvider,r.byId.url,e,this.byIdMinishardIndexSource,i,t);void 0===n?e.annotation=null:e.annotation=function(e,t,r,i){let n=t5[t.type],s=r.serializedBytes,a=t.relationships.length,o=s+4*a;if(e.byteLength<o)throw Error(`Expected at least ${o} bytes, but received: ${e.byteLength}`);let l=new DataView(e),u=n.deserialize(l,0,!0,t.rank,i);r.deserialize(l,0,0,1,!0,u.properties=Array(t.properties.length));let h=s,d=u.relatedSegments=[];d.length=a;for(let t=0;t<a;++t){let r=l.getUint32(h,!0);if(e.byteLength<o+8*r)throw Error(`Expected at least ${o} bytes, but received: ${e.byteLength}`);h+=4;let i=d[t]=[];for(let e=0;e<r;++e)i[e]=new tK.E(l.getUint32(h,!0),l.getUint32(h+4,!0)),h+=8}if(h!==e.byteLength)throw Error(`Expected ${h} bytes, but received: ${e.byteLength}`);return u}(n,this.parameters,this.annotationPropertySerializer,e.key)}}sf=n7([J()],sf);class sp extends eE(rq()(rR),nJ.S0){minishardIndexSource=se(this.chunkManager,this.credentialsProvider,this.parameters)}function sg(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}sp=n7([J()],sp);async function sy(e,t){iE(e,await nZ(new Uint8Array(t)))}class sm extends eE(rq()(ic),nj){manifestRequestCount=new Map;newSegments=new rS;addNewSegment(e){let{newSegments:t}=this;t.add(e);setTimeout(()=>{t.delete(e)},6e5)}async download(e,t){let{parameters:r,newSegments:i,manifestRequestCount:n}=this;if(nF(e.objectId,r.nBitsForLayerId))return ss(e,{fragments:[]});let s=`${r.manifestUrl}/manifest`,a=`${s}/${e.objectId}:${r.lod}?verify=1&prepend_seg_ids=1`;await nT(this.credentialsProvider,a,{signal:t}).then(e=>e.json()).then(t=>{if(i.has(e.objectId)){let t=(n.get(a)||0)+1;n.set(a,t),setTimeout(()=>{this.chunkManager.queueManager.updateChunkState(e,H.QUEUED)},2**t*1e3)}else n.delete(a);return ss(e,t)})}async downloadFragment(e,t){var r,i,n,s;let a,{parameters:o}=this;let l=await (r=void 0,i=e,n=o,s=t,a=n.sharding?function(e,t,r,i){if(t.fragmentId&&"~"===t.fragmentId.charAt(0)){let n=t.fragmentId.substr(1).split(":"),s=Number(n[1]),a=s+Number(n[2]);return n6(e,`${r.fragmentUrl}/initial/${n[0]}`,s,a,i)}return nT(e,`${r.fragmentUrl}/dynamic/${t.fragmentId}`,{signal:i}).then(e=>e.arrayBuffer())}(r,i,n,s):nT(r,`${n.fragmentUrl}/${i.fragmentId}`,{signal:s}).then(e=>e.arrayBuffer()));await sy(e,l)}getFragmentKey(e,t){return function(e){if("~"===e.charAt(0)){let t=e.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}return{key:e,fragmentId:e}}(t)}}sm=sg([J()],sm);class sv extends ed{chunkGridPosition;source=null;segment;leaves=[];chunkDataSize;initializeVolumeChunk(e,t){super.initialize(e),this.chunkGridPosition=Float32Array.from(t)}initializeChunkedGraphChunk(e,t,r){this.initializeVolumeChunk(e,t),this.chunkDataSize=null,this.systemMemoryBytes=16,this.gpuMemoryBytes=0,this.segment=r}downloadSucceeded(){this.systemMemoryBytes=16,this.systemMemoryBytes+=16*this.leaves.length,this.queueManager.updateChunkState(this,H.SYSTEM_MEMORY_WORKER),this.priorityTier<Z.RECENT&&this.source.chunkManager.scheduleUpdateChunkPriorities(),super.downloadSucceeded()}freeSystemMemory(){this.leaves=[]}}class sb extends eE(rq()(ep),nz){spec;tempChunkDataSize;tempChunkPosition;constructor(e,t){super(e,t),this.spec=t.spec;let r=this.spec.rank;this.tempChunkDataSize=new Uint32Array(r),this.tempChunkPosition=new Float32Array(r)}async download(e,t){let{parameters:r}=this,i=this.computeChunkBounds(e),n=e.chunkDataSize,s=`${i[0]}-${i[0]+n[0]}_${i[1]}-${i[1]+n[1]}_${i[2]}-${i[2]+n[2]}`,a=nT(this.credentialsProvider,`${r.url}/${e.segment}/leaves?int64_as_str=1&bounds=${s}`,{signal:t});await this.withErrorMessage(a,`Fetching leaves of segment ${e.segment} in region ${s}: `).then(e=>e.json()).then(t=>{e.leaves=function(e){let t=Array(e.length);for(let r=0;r<t.length;++r)t[r]=tK.E.parseString(e[r]);return t}(t.leaf_ids)}).catch(e=>console.error(e))}getChunk(e,t){let r=`${(0,eR.m0)(e)}-${t}`,i=this.chunks.get(r);return void 0===i&&((i=this.getNewChunk_(sv)).initializeChunkedGraphChunk(r,e,t),this.addChunk(i)),i}computeChunkBounds(e){return iG(this,e)}async withErrorMessage(e,t){let r;let i=await e;if(i.ok)return i;try{r=(await i.json()).message}catch{r=await i.text()}throw Error(`[${i.status}] ${t}${r}`)}}sb=sg([J()],sb);let sw=eR.R3.create(),sS=eR.R3.create(),sk=eR.R3.create();class sE extends rP(tc(eI(eT))){source;localPosition;leafRequestsActive;nBitsForLayerId;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.localPosition=e.get(t.localPosition),this.leafRequestsActive=e.get(t.leafRequestsActive),this.nBitsForLayerId=e.get(t.nBitsForLayerId),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities(),this.debouncedupdateDisplayState()}))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(t),e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.state={displayDimensionRenderInfo:r.projectionParameters.value.displayDimensionRenderInfo}}get renderRatioLimit(){return 5}updateChunkPriorities(){let{source:e,chunkManager:t}=this;for(let r of(t.registerLayer(this),this.attachments.values())){let{view:i}=r,n=i.visibility.value;if(n===Number.NEGATIVE_INFINITY)continue;let{transformedSource:s}=r.state,a=i.projectionParameters.value;if(!s)continue;let o=1.1*a.pixelSize,l=s.effectiveVoxelSize;if(this.leafRequestsActive.value=this.renderRatioLimit>=o/Math.min(...l),!this.leafRequestsActive.value)continue;let u=tf(n),h=tp(n),{chunkLayout:d}=s,{size:c,finiteRank:f}=d;eR.R3.copy(sk,c);for(let e=f;e<3;++e)sk[e]=0,sS[e]=0;let{centerDataPosition:p}=a;d.globalToLocalSpatial(sS,p),tu(a,this.localPosition.value,s,th(a,d),r=>{eR.R3.multiply(sw,r,sk);let i=-eR.R3.distance(sS,sw),{curPositionInChunks:n}=s;rT(this,(r,s)=>{if(nF(r,this.nBitsForLayerId.value))return;let a=e.getChunk(n,r.clone());t.requestChunk(a,u,h+i,H.SYSTEM_MEMORY_WORKER),++this.numVisibleChunksNeeded,a.state===H.GPU_MEMORY&&++this.numVisibleChunksAvailable})})}}forEachSelectedRootWithLeaves(e){let{source:t}=this;for(let r of t.chunks.values())r.state===H.SYSTEM_MEMORY_WORKER&&r.priorityTier<Z.RECENT&&this.visibleSegments.has(r.segment)&&r.leaves.length&&e(r.segment.toString(),r.leaves)}debouncedupdateDisplayState=(0,e0.Z)(()=>{this.updateDisplayState()},100);updateDisplayState(){let e=new Map,t=new Map;for(let[r,i]of(this.forEachSelectedRootWithLeaves((e,r)=>{t.has(e)?t.set(e,t.get(e)+r.length):t.set(e,r.length)}),this.forEachSelectedRootWithLeaves((r,i)=>{!e.has(r)&&(e.set(r,new rS),e.get(r).reserve(t.get(r)),e.get(r).add(tK.E.parseString(r))),e.get(r).add(i)}),e)){let e=[...i].filter(e=>!this.segmentEquivalences.has(e)),t=tK.E.parseString(r);for(let r of e)this.segmentEquivalences.link(t,r)}}}sE=sg([J("ChunkedGraphLayer")],sE),z("ChunkedGraphLayer:updateSources",function(e){let t=this.get(e.view),r=this.get(e.layer),i=r.attachments.get(t);i.state.transformedSource=tk(this,e.sources,r)[0][0],i.state.displayDimensionRenderInfo=e.displayDimensionRenderInfo,r.chunkManager.scheduleUpdateChunkPriorities()}),z("GrapheneMeshSource:NewSegment",function(e){this.get(e.rpcId).addNewSegment(tK.E.parseString(e.segment))});let sI={id:"decodeBlosc"},sM={id:"decodeZstd"};var sC=r("835");async function sT(e,t,r,i){let n=new DataView(r),s=n.getUint16(0,!1);if(0!==s)throw Error(`Unsupported mode: ${s}.`);let a=n.getUint16(2,!1);if(a!==e.source.spec.rank)throw Error("Number of dimensions must be 3.");let o=4,l=new Uint32Array(a);for(let e=0;e<a;++e)l[e]=n.getUint32(o,!1),o+=4;e.chunkDataSize=l;let u=new Uint8Array(r,o);switch(i){case sC.k.ZLIB:u=new Uint8Array(await iU(u,"deflate"));break;case sC.k.GZIP:u=new Uint8Array(await iU(u,"gzip"));break;case sC.k.BLOSC:u=await iL(sI,t,[u.buffer],u);break;case sC.k.ZSTD:u=await iL(sM,t,[u.buffer],u)}await i8(e,t,u.buffer,tB.BIG,u.byteOffset,u.byteLength)}class sx extends eE(rq()(iq),sC.Y){async download(e,t){let{parameters:r}=this,{chunkGridPosition:i}=e,n=r.url,s=this.spec.rank;for(let e=0;e<s;++e)n+=`/${i[e]}`;try{let i=await nT(this.credentialsProvider,n,{signal:t});await sT(e,t,await i.arrayBuffer(),r.encoding)}catch(e){if(!rQ(e))throw e}}}sx=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J()],sx);var sP=r("8551"),sR=r("2147"),sN=r("3853");class sO{uncompressedData;header}async function sA(e,t){(0,sP.isCompressed)(e)&&(e=await iU(e,"gzip"));let r=new sO;r.uncompressedData=e;let i=(0,sP.readHeader)(e);if(null===i)throw Error("Failed to parse NIFTI header.");return r.header=i,{data:r,size:e.byteLength}}function s_(e,t,r,i,n){return nG.getUrl(e,t,sA,r,i,n)}async function s$(e,t,r,i){return(await s_(e,t,r,()=>({priorityTier:Z.VISIBLE,priority:1e3}),i)).header}var sL=((S=sL||{})[S.NONE=0]="NONE",S[S.BINARY=1]="BINARY",S[S.UINT8=2]="UINT8",S[S.INT16=4]="INT16",S[S.INT32=8]="INT32",S[S.FLOAT32=16]="FLOAT32",S[S.COMPLEX64=32]="COMPLEX64",S[S.FLOAT64=64]="FLOAT64",S[S.RGB24=128]="RGB24",S[S.INT8=256]="INT8",S[S.UINT16=512]="UINT16",S[S.UINT32=768]="UINT32",S[S.INT64=1024]="INT64",S[S.UINT64=1280]="UINT64",S[S.FLOAT128=1536]="FLOAT128",S[S.COMPLEX128=1792]="COMPLEX128",S[S.COMPLEX256=2048]="COMPLEX256",S);let sD=new Map([[256,{dataType:e4.INT8}],[2,{dataType:e4.UINT8}],[4,{dataType:e4.INT16}],[512,{dataType:e4.UINT16}],[8,{dataType:e4.INT32}],[768,{dataType:e4.UINT32}],[1024,{dataType:e4.UINT64}],[1280,{dataType:e4.UINT64}],[16,{dataType:e4.FLOAT32}]]);F(sR._,async function(e,t){let r=this.getRef(e.chunkManager),i=this.getOptionalRef(e.credentialsProvider);try{var n;let s=await s$(r,i,e.url,t),a=sD.get(s.datatypeCode);if(void 0===a)throw Error(`Unsupported data type: ${sL[s.datatypeCode]||s.datatypeCode}.`);let o=1,l="";switch(s.xyzt_units&sP.NIFTI1.SPATIAL_UNITS_MASK){case sP.NIFTI1.UNITS_METER:o=1,l="m";break;case sP.NIFTI1.UNITS_MM:o=1e3,l="m";break;case sP.NIFTI1.UNITS_MICRON:o=1e6,l="m"}let u="",h=1;switch(s.xyzt_units&sP.NIFTI1.TEMPORAL_UNITS_MASK){case sP.NIFTI1.UNITS_SEC:u="s",h=1;break;case sP.NIFTI1.UNITS_MSEC:u="s",h=1e3;break;case sP.NIFTI1.UNITS_USEC:u="s",h=1e6;break;case sP.NIFTI1.UNITS_HZ:u="Hz",h=1;break;case sP.NIFTI1.UNITS_RADS:u="rad/s",h=1}let d=[l,l,l,u,"","",""],c=Float64Array.of(s.pixDims[1]/o,s.pixDims[2]/o,s.pixDims[3]/o,s.pixDims[4]/h,s.pixDims[5],s.pixDims[6],s.pixDims[7]),f=Float64Array.of(1/o,1/o,1/o,1/h,1,1,1),p=["i","j","k","m","c^","c1^","c2^"],g=["x","y","z","t","c^","c1^","c2^"],y=s.dims[0];p=p.slice(0,y),g=g.slice(0,y),d=d.slice(0,y),c=c.slice(0,y),f=f.slice(0,y);let{quatern_b:m,quatern_c:v,quatern_d:b}=s,w=Math.sqrt(1-m*m-v*v-b*b),S=-1===s.pixDims[0]?-1:1,k=eR.R3.fromValues(s.qoffset_x,s.qoffset_y,s.qoffset_z);n=s.affine,eR._E.fromValues(n[0][0],n[1][0],n[2][0],n[3][0],n[0][1],n[1][1],n[2][1],n[3][1],n[0][2],n[1][2],n[2][2],n[3][2],n[0][3],n[1][3],n[2][3],n[3][3]);let E=(0,eR.Fi)(eR._E.create(),k,eR.gf.fromValues(m,v,b,w),eR.rn,S),I=sN.XD(Float64Array,y+1),M=Math.min(3,y);for(let e=0;e<M;++e){for(let t=0;t<M;++t)I[t*(y+1)+e]=E[4*t+e];I[y*(y+1)+e]=E[12+e]}return{value:{rank:y,sourceNames:p,viewNames:g,units:d,sourceScales:c,viewScales:f,description:s.description,transform:I,dataType:a.dataType,volumeSize:Uint32Array.from(s.dims.slice(1,1+y))}}}finally{r.dispose(),i?.dispose()}});class sU extends eE(rq()(iq),sR.L){async download(e,t){e.chunkDataSize=this.spec.chunkDataSize;let r=await s_(this.chunkManager,this.credentialsProvider,this.parameters.url,()=>({priorityTier:e.priorityTier,priority:e.priority}),t),i=(0,sP.readImage)(r.header,r.uncompressedData);await i8(e,t,i,r.header.littleEndian?tB.LITTLE:tB.BIG)}}sU=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J()],sU);let sz={id:"parseOBJFromArrayBuffer"};var sj=r("8956");function sF(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class sB extends ed{data=null;freeSystemMemory(){this.data=null}serialize(e,t){super.serialize(e,t);let{vertexPositions:r,indices:i,vertexNormals:n,vertexAttributes:s}=this.data;e.vertexPositions=r,e.indices=i,e.vertexNormals=n,e.vertexAttributes=s;let a=new Set;for(let e of(a.add(r.buffer),a.add(i.buffer),a.add(n.buffer),s))a.add(e.buffer);t.push(...a),this.data=null}downloadSucceeded(){let{vertexPositions:e,indices:t,vertexNormals:r,vertexAttributes:i}=this.data,n=this.gpuMemoryBytes=e.byteLength+t.byteLength+r.byteLength;for(let e of i)n+=e.byteLength;this.systemMemoryBytes=this.gpuMemoryBytes=n,super.downloadSucceeded()}}let sV=new Map;function sG(e,t){sV.set(e,t)}let sq=/^(?:([a-zA-Z-+_]+):\/\/)?(.*)$/;function sY(e,t,r,i,n){return function(e,t,r,i,n){let[s,a]=function(e,t){let r=t.match(sq);if(null===r||void 0===r[1])throw Error('Data source URL must have the form "<protocol>://<path>".');let i=r[1],n=e.get(i);if(void 0===n)throw Error(`Unsupported data source: ${JSON.stringify(i)}.`);return[n,r[2],i]}(sV,r);return s.getMesh(e,t,a,i,n)}(e,t,r.meshSourceUrl,i,n)}class sJ extends eE(rq()(ep),sj.J6){getChunk(){let e=sj.Sk,t=this.chunks.get(e);return void 0===t&&((t=this.getNewChunk_(sB)).initialize(e),this.addChunk(t)),t}download(e,t){return sY(this.chunkManager,this.credentialsProvider,this.parameters,()=>({priorityTier:e.priorityTier,priority:e.priority}),t).then(t=>{if((0,eN.hd)(t.info)!==(0,eN.hd)(this.parameters.info))throw Error("Mesh info has changed.");void 0===t.vertexNormals&&(t.vertexNormals=io(t.vertexPositions,t.indices)),e.data=t})}}sJ=sF([J()],sJ);let sK=tc(eI(q));class sW extends sK{source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;let t=tf(e),r=tp(e),{source:i,chunkManager:n}=this,s=i.getChunk();n.requestChunk(s,t,r+50)}}sW=sF([J(sj.V4)],sW);function sQ(e,t){return iL(sz,t,[e],e)}F(sj.Wl,async function(e,t){let r=this.getRef(e.chunkManager),i=this.getOptionalRef(e.credentialsProvider);try{let n=e.parameters;return{value:(await sY(r,i,n,()=>({priorityTier:Z.VISIBLE,priority:1e3}),t)).info}}finally{r.dispose(),i?.dispose()}}),k="obj",E={description:"OBJ",getMesh:(e,t,r,i,n)=>nG.getUrl(e,t,sQ,r,i,n)},sV.set("obj",E);var sH=r("3074");let sZ=new Map;sZ.set("jpg",async(e,t,r)=>{let i=e.chunkDataSize,{uint8Array:n}=await iL(iB,t,[r],new Uint8Array(r),void 0,void 0,i[0]*i[1]*i[2],3,!0);await iD(e,t,n)}),sZ.set("raw16",(e,t,r)=>i8(e,t,r,tB.BIG));class sX extends eE(iq,sH.xd){chunkDecoder=sZ.get(this.parameters.encoding);queryString=(()=>{let{parameters:e}=this,t=[];return void 0!==e.channel&&t.push("channels="+e.channel),void 0!==e.minIntensity&&t.push(`minIntensity=${JSON.stringify(e.minIntensity)}`),void 0!==e.maxIntensity&&t.push(`maxIntensity=${JSON.stringify(e.maxIntensity)}`),void 0!==e.maxTileSpecsToRender&&t.push(`maxTileSpecsToRender=${JSON.stringify(e.maxTileSpecsToRender)}`),void 0!==e.filter&&t.push(`filter=${JSON.stringify(e.filter)}`),t.join("&")})();async download(e,t){let r;let{parameters:i}=this,{chunkGridPosition:n}=e,s=1/2**i.level;e.chunkDataSize=this.spec.chunkDataSize;let a=e.chunkDataSize[0]*2**i.level,o=e.chunkDataSize[1]*2**i.level,l=eR.R3.create();l[0]=n[0]*a,l[1]=n[1]*o,l[2]=n[2],r="raw16"===i.encoding?"raw16-image":"jpeg-image";let u=`/render-ws/v1/owner/${i.owner}/project/${i.project}/stack/${i.stack}/z/${l[2]}/box/${l[0]},${l[1]},${a},${o},${s}/${r}`,h=await rK(`${i.baseUrl}${u}?${this.queryString}`,{signal:t});await this.chunkDecoder(e,t,await h.arrayBuffer())}}sX=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J()],sX);let s0={id:"parseVTKFromArrayBuffer"};function s1(e,t){return iL(s0,t,[e],e)}I="vtk",M={description:"VTK",getMesh:(e,t,r,i,n)=>nG.getUrl(e,t,s1,r,i,n).then(e=>{let t={info:{numTriangles:e.numTriangles,numVertices:e.numVertices,vertexAttributes:[]},indices:e.indices,vertexPositions:e.vertexPositions,vertexAttributes:[]};for(let r of e.vertexAttributes)t.info.vertexAttributes.push({name:r.name,dataType:e4.FLOAT32,numComponents:r.numComponents}),t.vertexAttributes.push(r.data);return t})},sV.set("vtk",M);var s2=r("6363");let s3={[s2.i.arrayToArray]:new Map,[s2.i.arrayToBytes]:new Map,[s2.i.bytesToBytes]:new Map,sharding:new Map};function s4(e){e.kind===s2.i.arrayToBytes&&"getShardedKvStore"in e?s3.sharding.set(e.name,e):s3[e.kind].set(e.name,e)}async function s6(e,t,r){let i;let n=e[s2.i.bytesToBytes];for(let e=n.length;e--;){let i=n[e],s=s3[s2.i.bytesToBytes].get(i.name);if(void 0===s)throw Error(`Unsupported codec: ${JSON.stringify(i.name)}`);t=await s.decode(i.configuration,t,r)}{let n=e[s2.i.arrayToBytes],s=s3[s2.i.arrayToBytes].get(n.name);if(void 0===s)throw Error(`Unsupported codec: ${JSON.stringify(n.name)}`);i=await s.decode(n.configuration,e.arrayInfo[e.arrayInfo.length-1],t,r)}let s=e[s2.i.arrayToArray];for(let t=s.length;t--;){let n=s[t],a=s3[s2.i.arrayToArray].get(n.name);if(void 0===a)throw Error(`Unsupported codec: ${JSON.stringify(n.name)}`);i=await a.decode(n.configuration,e.arrayInfo[t],i,r)}return i}s4({name:"blosc",kind:s2.i.bytesToBytes,decode:(e,t,r)=>iL(sI,r,[t.buffer],t)}),s4({name:"zstd",kind:s2.i.bytesToBytes,decode:(e,t,r)=>iL(sM,r,[t.buffer],t)}),s4({name:"bytes",kind:s2.i.arrayToBytes,async decode(e,t,r,i){let{dataType:n,chunkShape:s}=t,a=s.reduce((e,t)=>e*t,1),o=e6[n],l=a*o;if(r.byteLength!==l)throw Error(`Raw-format chunk is ${r.byteLength} bytes, but ${a} * ${o} = ${l} bytes are expected.`);let u=e7(n,r.buffer,r.byteOffset,r.byteLength);return tJ(u,e.endian,o),u}});s4({name:"crc32c",kind:s2.i.bytesToBytes,async decode(e,t,r){if(t.length<4)throw Error(`Expected buffer of size at least 4 bytes but received: ${t.length} bytes`);return t.subarray(0,t.length-4)}});var s5=r("6758");for(let[e,t]of[["gzip","gzip"],["zlib","deflate"]])s4({name:e,kind:s2.i.bytesToBytes,decode:async(e,r,i)=>new Uint8Array(await iU(r,t,i))});function s8(e){let{name:t,configuration:r}=function(e,t,r){(0,eN.PT)(e);let i=(0,eN.uq)(e,"name",e=>t((0,eN.ZE)(e))),n=(0,eN.uq)(e,"configuration",e=>(void 0===e?e={}:(0,eN.PT)(e),r(e,i)));return{name:i,configuration:n}}(e,e=>{let t=s7.get(e);if(void 0===t)throw Error(`Unknown codec: ${JSON.stringify(e)}`);return t},e=>e);return{resolver:t,configuration:r}}let s7=new Map;function s9(e,t){let r=[],i=[],n=[],s=[];i.push(t);let a=(0,eN.m7)(e,s8),o=a.length,l=0;for(;l<o;++l){let{resolver:e,configuration:n}=a[l];if(e.kind!==s2.i.arrayToArray)break;let{configuration:s,encodedArrayInfo:o}=e.resolve(n,t);i.push(o),t=o,r.push({kind:s2.i.arrayToArray,name:e.name,configuration:s})}if(l===o||a[l].resolver.kind!==s2.i.arrayToBytes)throw Error("Missing array -> bytes codec");let{codecSpec:u,layoutInfo:h,encodedSize:d,shardingInfo:c}=(()=>{let{resolver:e,configuration:r}=a[l],{configuration:i,shardingInfo:n,encodedSize:s}=e.resolve(r,t);if(void 0!==n&&l+1!==o)throw Error("bytes -> bytes codecs not supported following sharding codec");let u=e.getDecodedArrayLayoutInfo(i,t);return{codecSpec:{name:e.name,kind:s2.i.arrayToBytes,configuration:i},layoutInfo:u,encodedSize:s,shardingInfo:n}})();n[l]=h,s.push(d);let f=[];for(++l;l<o;){let{resolver:e,configuration:t}=a[l];if(e.kind!==s2.i.bytesToBytes)throw Error(`Expected bytes -> bytes codec, but received ${JSON.stringify(e.name)} of kind ${s2.i[e.kind]}`);let{configuration:r,encodedSize:i}=e.resolve(t,d);f.push({name:e.name,kind:e.kind,configuration:r}),s.push(i),++l}for(let e=r.length-1;e>=0;--e)n[e]=a[e].resolver.getDecodedArrayLayoutInfo(r[e].configuration,i[e],n[e+1]);return{[s2.i.arrayToArray]:r,[s2.i.arrayToBytes]:u,[s2.i.bytesToBytes]:f,arrayInfo:i,layoutInfo:n,shardingInfo:c,encodedSize:s}}let ae=new Map([["",{unit:"",scale:1}],["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:3600}],["day",{unit:"s",scale:86400}]]);for(let e of["meter","second"])for(let t of eO){let{longPrefix:r,prefix:i}=t;if(void 0===r)continue;let n={unit:e[0],scale:10**t.exponent};ae.set(`${r}${e}`,n),ae.set(`${i}${e[0]}`,n)}var at=((C={})[C.START=0]="START",C[C.END=1]="END",C);function ar(e,t){if(void 0===t)return{outer:e,inner:{offset:0,length:e.length}};if("suffixLength"in t){let r=Math.min(e.length,t.suffixLength);return{outer:{offset:e.offset+(e.length-r),length:r},inner:{offset:e.length-r,length:r}}}if(t.offset+t.length>e.length)throw Error(`Requested byte range ${JSON.stringify(t)} not valid for value of length ${e.length}`);return{outer:{offset:e.offset+t.offset,length:t.length},inner:t}}T={name:"sharding_indexed",kind:s2.i.arrayToBytes,resolve(e,t){(0,eN.PT)(e);let r=(0,eN.uq)(e,"chunk_shape",e=>{var r,i;return r=e,i=t.chunkShape.length,(0,eN.Iw)(Array(i),r,e=>{if("number"!=typeof e||!Number.isInteger(e)||e<=0)throw Error(`Expected positive integer, but received: ${JSON.stringify(e)}`);return e})}),i=(0,eN.Kh)(e,"index_location",e=>(0,eN.CT)(e,at,/^[a-z]+$/),1),n=Array.from(t.chunkShape,(e,i)=>{let n=r[i];if(e%n!=0)throw Error(`sub-chunk shape of ${JSON.stringify(n)} does not evenly divide outer chunk shape of ${JSON.stringify(t.chunkShape)}`);return e/n}),s=Array.from(n);s.push(2);let a=(0,eN.uq)(e,"index_codecs",e=>s9(e,{dataType:e4.UINT64,chunkShape:s}));if(void 0===a.encodedSize[a.encodedSize.length-1])throw Error("index_codecs must specify fixed-size encoding");let o=(0,eN.uq)(e,"codecs",e=>s9(e,{dataType:t.dataType,chunkShape:r}));return{configuration:{indexCodecs:a,subChunkCodecs:o,subChunkShape:r,subChunkGridShape:n,indexLocation:i},shardingInfo:{subChunkShape:r,subChunkGridShape:n,subChunkCodecs:o}}},getDecodedArrayLayoutInfo:(e,t)=>e.subChunkCodecs.layoutInfo[0]},s7.set(T.name,T);let ai=BigInt("18446744073709551615");class an extends A.gj{configuration;base;indexCache;indexStrides;constructor(e,t,r){super(),this.configuration=e,this.base=r,this.indexCache=this.registerDisposer(new nY(t.addRef(),{get:async(t,i)=>{let n;let{indexCodecs:s}=e,a=s.encodedSize[s.encodedSize.length-1];switch(e.indexLocation){case at.START:n={offset:0,length:a};break;case at.END:n={suffixLength:a}}let o=await r.read(t,{abortSignal:i,byteRange:n});if(void 0===o)return{size:0,data:void 0};let l=await s6(e.indexCodecs,o.data,i);return{size:l.byteLength,data:new BigUint64Array(l.buffer,l.byteOffset,l.byteLength/8)}}}));let{subChunkGridShape:i}=this.configuration,n=i.length,s=this.configuration.indexCodecs.layoutInfo[0].physicalToLogicalDimension,a=this.indexStrides=Array(n+1),o=1;for(let e=n;e>=0;--e){let t=s[e];a[t]=o,o*=t===n?2:i[t]}}async read(e,t){let r=await this.indexCache.get(e.base,t.abortSignal);if(void 0===r)return;let i=this.configuration.subChunkShape.length,{subChunk:n}=e,{indexStrides:s}=this,a=0;for(let e=0;e<i;++e)a+=n[e]*s[e];let o=r[a],l=r[a+s[i]];if(o===ai&&l===ai)return;let u={offset:Number(o),length:Number(l)},{outer:h,inner:d}=ar(u,t.byteRange);if(0===h.length)return{data:new Uint8Array(0),dataRange:d,totalSize:u.length};let c=await this.base.read(e.base,{abortSignal:t.abortSignal,byteRange:h});if(void 0!==c){if(c.dataRange.offset!==h.offset||c.dataRange.length!==h.length)throw Error(`Received truncated response, expected ${JSON.stringify(h)} but received ${JSON.stringify(c.dataRange)}`);return{data:c.data,dataRange:d,totalSize:u.length}}}}s4({name:"sharding_indexed",kind:s2.i.arrayToBytes,getShardedKvStore:(e,t,r)=>new an(e,t,r)}),s4({name:"transpose",kind:s2.i.arrayToArray,decode:async(e,t,r,i)=>r});var as=r("6252");let aa=-1!==navigator.userAgent.indexOf("Chrome")?"no-store":"default";class ao{credentialsProvider;baseUrl;constructor(e,t){this.credentialsProvider=e,this.baseUrl=t}async getObjectLength(e,t){let r=await nT(this.credentialsProvider,e,{method:"HEAD",signal:t.abortSignal});if(200!==r.status)throw Error("Failed to determine total size in order to fetch suffix");let i=r.headers.get("content-length");if(void 0===i)throw Error("Failed to determine total size in order to fetch suffix");return Number(i)}async read(e,t){let{byteRange:r}=t,i=this.baseUrl+e;try{let e,n;if(void 0!==r&&"suffixLength"in r){let e=await this.getObjectLength(i,t);r=ar({offset:0,length:e},r).outer}let s={signal:t.abortSignal},a=function(e){if(void 0!==e)return"suffixLength"in e?`bytes=-${e.suffixLength}`:`bytes=${e.offset}-${e.offset+e.length-1}`}(r);void 0!==a&&(s.headers={range:a},s.cache=aa);let o=await nT(this.credentialsProvider,i,s),l=await o.arrayBuffer();if(206===o.status){let t=o.headers.get("content-range");if(null===t){if(void 0!==r)n={offset:r.offset,length:l.byteLength};else throw Error("Unexpected HTTP 206 response when no byte range specified.")}if(null!==t){let r=t.match(/bytes ([0-9]+)-([0-9]+)\/([0-9]+|\*)/);if(null===r)throw Error(`Invalid content-range header: ${JSON.stringify(t)}`);let i=parseInt(r[1],10);if(parseInt(r[2],10)!==i+l.byteLength-1)throw Error(`Length in content-range header ${JSON.stringify(t)} does not match content length ${l.byteLength}`);"*"!==r[3]&&(e=parseInt(r[3],10)),n={offset:i,length:l.byteLength}}}return void 0===n&&(n={offset:0,length:l.byteLength},e=l.byteLength),{data:new Uint8Array(l),dataRange:n,totalSize:e}}catch(e){if(rQ(e))return;throw e}}}class al extends eE(rq()(iq),s5.Y){chunkKvStore=(function(e,t,r){let i=r,n=t;for(;;){let{shardingInfo:t}=n;if(void 0===t)break;let r=n[s2.i.arrayToBytes],s=s3.sharding.get(r.name);if(void 0===s)throw Error(`Unsupported codec: ${JSON.stringify(r.name)}`);i=s.getShardedKvStore(r.configuration,e,i),n=t.subChunkCodecs}let s=n;return{kvStore:i,getChunkKey:function(e,r){let i=r,n=e.length,s=t;for(;void 0!==s.shardingInfo;){let{physicalToLogicalDimension:r,readChunkShape:a}=t.layoutInfo[t.layoutInfo.length-1],{subChunkShape:o,subChunkGridShape:l,subChunkCodecs:u}=s.shardingInfo,h=Array(n);for(let t=0;t<n;++t){let i=r[n-1-t];h[i]=Math.floor(e[t]*a[i]/o[i])%l[i]}i={base:i,subChunk:h},s=u}return i},decodeCodecs:s}})(this.chunkManager,this.parameters.metadata.codecs,(x=this.credentialsProvider,new ao(x,this.parameters.url+"/")));async download(e,t){let r;e.chunkDataSize=this.spec.chunkDataSize;let{parameters:i}=this,{chunkGridPosition:n}=e,{metadata:s}=i,a="",o=this.spec.rank,{physicalToLogicalDimension:l}=s.codecs.layoutInfo[0];s.chunkKeyEncoding===as.$.DEFAULT?(a+="c",r=s.dimensionSeparator):(r="",0===o&&(a+="0"));let u=Array(o),{readChunkShape:h}=s.codecs.layoutInfo[0],{chunkShape:d}=s;for(let e=0;e<o;++e){let t=l[o-1-e];u[t]=Math.floor(n[e]*h[t]/d[t])}for(let e=0;e<o;++e)a+=`${r}${u[e]}`,r=s.dimensionSeparator;let{chunkKvStore:c}=this,f=await c.kvStore.read(c.getChunkKey(n,a),{abortSignal:t});if(void 0!==f){let r=await s6(c.decodeCodecs,f.data,t);await iD(e,t,r)}}}al=function(e,t,r,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,r,a):n(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([J()],al);let au=new class e{target;objects;nextId;queue;constructor(e,t){this.target=e,this.objects=new Map,this.nextId=B,t&&(this.queue=[]),e.onmessage=e=>{let t=e.data;U.get(t.functionName).call(this,t)}}sendReady(){this.invoke(D,{})}onPeerReady(){let{queue:e}=this;if(void 0!==e)for(let{data:t,transfers:r}of(this.queue=void 0,e))this.target.postMessage(t,r)}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(void 0===e)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e;let{queue:i}=this;if(void 0!==i){i.push({data:t,transfers:r});return}this.target.postMessage(t,r)}promiseInvoke(e,t,r,i){if(r?.aborted)return Promise.reject(r.reason);let n=t.id=this.newId();this.invoke(e,t,i);let{promise:s,resolve:a,reject:o}=void 0===r?Promise.withResolvers():function(e,t){let{promise:r,resolve:i,reject:n}=Promise.withResolvers(),s=R(e,t);return{promise:r,resolve:e=>{s?.[Symbol.dispose](),i(e)},reject:e=>{s?.[Symbol.dispose](),n(e)}}}(r,()=>{this.invoke(L,{id:n})});return this.set(n,{resolve:a,reject:o}),s}newId(){return _?this.nextId--:this.nextId++}}(self,!1);au.sendReady(),globalThis.rpc=au}},t={};function r(i){var n=t[i];if(void 0!==n)return n.exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,r),s.exports}r.m=e,r.x=()=>{var e=r.O(void 0,["822","213","110","103"],function(){return r("2689")});return e=r.O(e)},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,{a:t}),t},r.d=function(e,t){for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=function(e){return Promise.all(Object.keys(r.f).reduce(function(t,i){return r.f[i](e,t),t},[]))},r.u=function(e){return"110"===e?"110.67f228429128ecef.js":"67"===e?"67.b9c069848ffd6550.js":""+e+"."+({103:"7abc221a7699b0a6",213:"bb58e32f2c165c75",822:"a8386f86d1765bd7"})[e]+".js"},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e=[];r.O=function(t,i,n,s){if(i){s=s||0;for(var a=e.length;a>0&&e[a-1][2]>s;a--)e[a]=e[a-1];e[a]=[i,n,s];return}for(var o=1/0,a=0;a<e.length;a++){for(var i=e[a][0],n=e[a][1],s=e[a][2],l=!0,u=0;u<i.length;u++)(!1&s||o>=s)&&Object.keys(r.O).every(function(e){return r.O[e](i[u])})?i.splice(u--,1):(l=!1,s<o&&(o=s));if(l){e.splice(a--,1);var h=n();void 0!==h&&(t=h)}}return t}})(),r.rv=function(){return"1.1.6"},(()=>{var e=r.x;r.x=function(){return Promise.all(["822","213","110","103"].map(r.e,r)).then(e)}})(),(()=>{r.g.importScripts&&(e=r.g.location+"");var e,t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length){for(var n=i.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=i[n--].src}}if(!e)throw Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{r.b=self.location+"";var e={525:1};r.f.i=function(t,i){!e[t]&&importScripts(r.p+r.u(t))};var t=globalThis.webpackChunkneuroglancer=globalThis.webpackChunkneuroglancer||[],i=t.push.bind(t);t.push=function(t){var n=t[0],s=t[1],a=t[2];for(var o in s)r.o(s,o)&&(r.m[o]=s[o]);for(a&&a(r);n.length;)e[n.pop()]=1;i(t)}})(),r.ruid="bundler=rspack@1.1.6",r.x()})();
//# sourceMappingURL=525.39e34f67e29b25a1.js.map