(()=>{var e={2338:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg=="},9110:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJFhQXEbhTg7YAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAMklEQVQI12NkgIIvJ3QXMjAwdDN+OaEbysDA4MPAwNDNwMCwiOHLCd1zX07o6kBVGQEAKBANtobskNMAAAAASUVORK5CYII="},5554:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAHCAMAAADzjKfhAAAACVBMVEUAAAAAAAC/v7914kyHAAAAAXRSTlMAQObYZgAAACNJREFUeNo1ioEJAAAIwmz/H90iFFSGJgFMe3gaLZ0od+9/AQZ0ADosbYraAAAAAElFTkSuQmCC"},772:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAHlBMVEW7AAC7AACxAAC7AAC7AAAAAAC4AAC5AAD///+7AAAUdclpAAAABnRSTlMXnORSiwCK0ZKSAAAATUlEQVR42mWPOQ7AQAgDuQLx/z8csYRmPRIFIwRGnosRrpamvkKi0FTIiMASR3hhKW+hAN6/tIWhu9PDWiTGNEkTtIOucA5Oyr9ckPgAWm0GPBog6v4AAAAASUVORK5CYII="},4052:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAANlBMVEX/uwDvrwD/uwD/uwD/uwD/uwD/uwD/uwD/uwD6twD/uwAAAADurwD2tQD7uAD+ugAAAAD/uwDhmeTRAAAADHRSTlMJ8mN1EYcbmiixgACm7WbuAAAAVklEQVR42n3PUQqAIBBFUU1LLc3u/jdbOJoW1P08DA9Gba8+YWJ6gNJoNYIBzAA2chBth5kLmG9YUoG0NHAUwFXwO9LuBQL1giCQb8gC9Oro2vp5rncCIY8L8uEx5ZkAAAAASUVORK5CYII="},2959:function(e,t,i){"use strict";e.exports=i.p+"bossauth.html"},7984:function(e,t,i){"use strict";e.exports=i.p+"google_oauth2_redirect.html"},4066:function(e,t,i){"use strict";i.d(t,{BA:function(){return s},Lr:function(){return a},tr:function(){return o}});var n,r=i(9754);var s=((n={})[n.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",n[n.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",n[n.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",n[n.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED",n);function a(e){return!(e.high>>>31)}let o=new r.E(0xffffffff,0xffffffff)},3719:function(e,t,i){"use strict";i.d(t,{GF:function(){return f},Jk:function(){return S},SN:function(){return a},S_:function(){return d},TU:function(){return o},Uw:function(){return v},ip:function(){return w},kp:function(){return C},mJ:function(){return h},mo:function(){return p},ne:function(){return b},ny:function(){return g},og:function(){return c},w:function(){return y},x2:function(){return m}});var n=i(2902),r=i(106),s=i(566);class a{value_;get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}changed;constructor(e){this.value_=e,this.changed=new s.K_}}class o extends a{validator;defaultValue;constructor(e,t,i=e){super(e),this.validator=t,this.defaultValue=i}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(void 0!==e){let{validator:t}=this;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}class l extends r.gj{changed=new s.K_;get value(){return this.f(...this.ws.map(e=>e.value))}f;ws;constructor(e,t){for(let i of(super(),this.f=e,this.ws=t,t))this.registerDisposer(i.changed.add(this.changed.dispatch))}}function d(e,...t){return new l(e,t)}class u extends r.gj{changed=new s.K_;value_;valueGeneration=-1;get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(e=>e.value)),this.valueGeneration=e),this.value_}f;ws;constructor(e,t){for(let i of(super(),this.f=e,this.ws=t,t))this.registerDisposer(i.changed.add(this.changed.dispatch))}}function c(e,...t){return new u(e,t)}class h extends r.gj{changed=new s.MZ;value;constructor(e,t=(e,t)=>e===t){super(),this.value=e.value,this.registerDisposer(e.changed.add(()=>{let i=e.value;!t(this.value,i)&&(this.value=i,this.changed.dispatch())}))}}function p(e,t,i){let n=new l(e,t),r=new h(n,i);return r.registerDisposer(n),r}class g extends r.gj{changed=new s.K_;value;constructor(e){super();let t=e(this),i=Object.keys(t),n=()=>{let e=Array.isArray(t)?[]:{};for(let n of i)e[n]=t[n].value;this.value=e,this.changed.dispatch()};for(let e of(n(),i)){let i=t[e];this.registerDisposer(i.changed.add(()=>n()))}}}class m extends r.gj{f;get value(){return this.f()}changed;constructor(e,...t){for(let i of(super(),this.f=e,this.changed=new s.K_,t))this.registerDisposer(i.add(this.changed.dispatch))}}r.gj;class f{changed=new s.MZ;values;constructor(e){void 0===e?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return!t.has(e)&&(t.add(e),this.changed.dispatch(e,!0)),this}delete(e){let{values:t}=this;return!!t.delete(e)&&(this.changed.dispatch(e,!1),!0)}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch(null,!1))}}function v(e,...t){let i=t.map(e=>e.value),s=t.length,a=new r.gj,o=e(a,...i),l=(0,n.Z)(()=>{let n=!1;for(let e=0;e<s;++e){let r=t[e].value;i[e]!==r&&(i[e]=r,n=!0)}n&&(a.dispose(),o=e(a=new r.gj,...i))},0),d=t.map(e=>e.changed.add(l));return{flush(){l.flush()},dispose(){l.cancel(),(0,r.k1)(d),a.dispose()},get value(){return l.flush(),o}}}function y(e,...t){let i=t.map(e=>e.value),n=t.length,s=new r.gj,a=e(s,...i),o=()=>{let o=!1;for(let e=0;e<n;++e){let n=t[e].value;i[e]!==n&&(i[e]=n,o=!0)}o&&(s.dispose(),a=e(s=new r.gj,...i))},l=t.map(e=>e.changed.add(o));return{dispose(){(0,r.k1)(l),s.dispose()},get value(){return a}}}function b(e){return{changed:s.LP,value:e}}function S(e,t){return e(t.value),t.changed.add(()=>e(t.value))}class w{outer;getInner;inner;changed;disposer;update;constructor(e,t){this.outer=e,this.getInner=t,this.changed=new s.K_,this.update=()=>{let{disposer:e,outer:t}=this;void 0!==e&&e();let i=this.inner=this.getInner(t.value);this.disposer=i.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class C extends w{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}},1471:function(e,t,i){"use strict";function n(e,t){let i=e.length,n=0;for(let r=0;r<i;++r)t(e[r],r,e)&&(e[n]=e[r],++n);e.length=n}function r(e,t){if(e.length===t)return e;let i=new e.constructor(t);return i.set(e),i}function s(e,t,i,n){let r=e.length/t,s=e.length*i*n,a=new e.constructor(s),o=e.length*n,l=t*n;for(let s=0;s<r;++s)for(let r=0;r<t;++r){let d=e[s*t+r],u=s*l+r;for(let e=0;e<i;++e)for(let i=0;i<n;++i)a[e*o+i*t+u]=d}return a}function a(e,t,i,n=0,r=e.length){for(;n<r;){let s=n+r-1>>1,a=i(t,e[s]);if(a>0)n=s+1;else{if(!(a<0))return s;r=s}}return~n}function o(e,t,i,n=0,r=e.length){let s=-1,a=1/0;for(;n<r;){let o=n+r-1>>1,l=i(t,e[o]);if(l>0)n=o+1;else{if(!(l<0))return o;r=o}let d=Math.abs(l);d<a&&(a=d,s=o)}return s}function l(e,t,i){let n=t-e;for(;n>0;){let t=Math.floor(n/2),r=e+t;i(r)?n=t:(e=r+1,n-=t+1)}return e}function d(e,t){let i=[];for(let n=0,r=e.length;n<r;++n)e[n]===t&&i.push(n);return i}function u(e,t){let i=e.length;if(t.length!==i)return!1;for(let n=0;n<i;++n)if(e[n]!==t[n])return!1;return!0}function c(e,t,i=(e,t)=>e===t){let n=e.length;if(t.length!==n)return!1;for(let r=0;r<n;++r)if(!i(e[r],t[r]))return!1;return!0}function h(e,t,i){let n=[];if(i===t){for(let t=0;t<e;++t)n[t]=t;return n}n[i]=t;for(let r=0,s=0;r<e;){if(r===t){++r;continue}s===i&&++s,n[s++]=r++}return n}function p(e,t,i){for(let n=0,r=i.length;n<r;++n){let r=i[n];-1!==r&&(e[n]=t[r])}return e}function g(e){let t=[];for(let i=0,n=e.length;i<n;++i){let n=e[i];for(let e=0,i=n.length;e<i;++e){let i=t[e];void 0===i&&(i=t[e]=[]),i.push(n[e])}}return t}function m(e,t){let i=[],n=0;for(let r=0,s=t.length;r<s;++r){let{retainCount:s,deleteCount:a,insertCount:o}=t[r];0!==s&&(i.push(e.slice(n,n+s)),n+=s),n+=a,0!==o&&i.push(Array(o))}return n!==e.length&&i.push(e.slice(n)),[].concat(...i)}function f(e,t,i){let n=[],r=0,s=0,a=e.length,o=t.length;for(;r<a;){let l=0;for(;r<a&&s<o&&i(e[r],t[s]);)++l,++r,++s;0!==l&&n.push({retainCount:l,deleteCount:0,insertCount:0});let d=0;for(;r<a&&(s===o||!i(e[r],t[s]));)++d,++r;0!==d&&n.push({retainCount:0,deleteCount:d,insertCount:0})}return s!==o&&n.push({retainCount:0,deleteCount:0,insertCount:o-s}),n}function v(e,t,i,n,r,s){let a=0,o=0;if(0!==e&&0!==t)for(;;){let l=i(a,o);if(l<0){if(n(a),++a===e)break}else if(l>0){if(r(o),++o===t)break}else if(s(a,o),++a,++o,a===e||o===t)break}for(;a<e;)n(a),++a;for(;o<t;)r(o),++o}i.d(t,{BP:function(){return h},FD:function(){return v},Kq:function(){return l},PK:function(){return g},W0:function(){return d},X9:function(){return s},bm:function(){return o},cO:function(){return u},dr:function(){return n},eK:function(){return c},ry:function(){return a},wG:function(){return f},x:function(){return m},x0:function(){return r},zV:function(){return p}})},106:function(e,t,i){"use strict";i.d(t,{H0:function(){return s},IF:function(){return o},gj:function(){return a},k1:function(){return r},oq:function(){return l}});function n(e){"object"==typeof e?e.dispose():e()}function r(e){for(let t=e.length;t>0;--t)n(e[t-1])}function s(e,t,i,n){return e.addEventListener(t,i,n),()=>e.removeEventListener(t,i,n)}class a{refCount=1;wasDisposed;disposers;addRef(){return++this.refCount,this}disposedStacks;dispose(){if(0==--this.refCount)this.refCountReachedZero()}[Symbol.dispose](){this.dispose()}refCountReachedZero(){this.disposed();let{disposers:e}=this;void 0!==e&&(r(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return null==t?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(null!=t){let i=t.indexOf(e);-1!==i&&t.splice(i,1)}return e}registerEventListener(e,t,i,n){this.registerDisposer(s(e,t,i,n))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class o extends a{value;constructor(e){super(),this.value=e}}function l(e){return()=>{if(void 0!==e){let t=e;e=void 0,n(t)}}}},3783:function(e,t,i){"use strict";i.d(t,{Dv:function(){return p},Jc:function(){return T},K4:function(){return d},Mb:function(){return I},Mz:function(){return E},R3:function(){return r},Rq:function(){return C},TL:function(){return u},V2:function(){return D},_E:function(){return n},_Z:function(){return y},_r:function(){return b},ad:function(){return P},bZ:function(){return S},e6:function(){return k},gf:function(){return a},iG:function(){return x},lA:function(){return c},m0:function(){return f},n_:function(){return m},nn:function(){return h},rn:function(){return g},th:function(){return w},vh:function(){return s},vx:function(){return v},wO:function(){return l}});var n=i(5975),r=i(7160),s=i(8333),a=i(2945),o=i(1471),l=i(5600),d=i(1437);let u=n.create(),c=["x","y","z"],h=[r.fromValues(1,0,0),r.fromValues(0,1,0),r.fromValues(0,0,1)];r.fromValues(0,0,0);let p=s.fromValues(0,0,0,0),g=r.fromValues(1,1,1);function m(e){return e[0]*e[1]*e[2]}function f(e){return`${e[0]},${e[1]},${e[2]}`}function v(e,t,i){let n=t[0],r=t[1],s=t[2];return e[0]=i[0]*n+i[4]*r+i[8]*s,e[1]=i[1]*n+i[5]*r+i[9]*s,e[2]=i[2]*n+i[6]*r+i[10]*s,e}function y(e,t,i){let n=t[0],r=t[1],s=t[2];return e[0]=i[0]*n+i[1]*r+i[2]*s,e[1]=i[4]*n+i[5]*r+i[6]*s,e[2]=i[8]*n+i[9]*r+i[10]*s,e}r.fromValues(1/0,1/0,1/0),a.create();function b(e,t,i,n){let r=e.length,s=function(e,t,i){let n=i.length,r=0;for(let i=0;i<n;++i)r+=(e[i]-t[i])**2;let s=0;for(let r=0;r<n;++r){let n=e[r];s-=(n-i[r])*(t[r]-n)}return s/Math.max(r,1e-6)}(t,i,n);s=Math.max(0,Math.min(1,s));for(let n=0;n<r;++n){let r=t[n];e[n]=r+s*(i[n]-r)}return e}function S(e,t){let i=t[0],n=t[1],r=t[2],s=t[4],a=t[5],o=t[6],l=t[8],d=t[9],u=t[10];return e[0]=i,e[1]=n,e[2]=r,e[3]=s,e[4]=a,e[5]=o,e[6]=l,e[7]=d,e[8]=u,e}function w(e,t){let i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=t[6],d=t[7],u=t[8],c=t[9],h=t[10],p=t[11],g=t[12],m=t[13],f=t[14],v=t[15];e[0]=s+i,e[1]=d+a,e[2]=p+u,e[3]=v+g,e[4]=s-i,e[5]=d-a,e[6]=p-u,e[7]=v-g,e[8]=s+n,e[9]=d+o,e[10]=p+c,e[11]=v+m,e[12]=s-n,e[13]=d-o,e[14]=p-c,e[15]=v-m;let y=s+r,b=d+l,S=p+h,w=s-r,C=d-l,x=p-h,E=Math.sqrt(y**2+b**2+S**2);e[16]=y/E,e[17]=b/E,e[18]=S/E,e[19]=(v+f)/E;let T=Math.sqrt(w**2+C**2+x**2);return e[20]=w/T,e[21]=C/T,e[22]=x/T,e[23]=(v-f)/T,e}function C(e,t,i,n,r,s,a){for(let o=0;o<6;++o){let l=a[4*o],d=a[4*o+1],u=a[4*o+2];if(Math.max(l*e,l*n)+Math.max(d*t,d*r)+Math.max(u*i,u*s)+a[4*o+3]<0)return!1}return!0}function x(e,t,i,n,r,s,a){for(let o=0;o<4;++o){let l=a[4*o],d=a[4*o+1],u=a[4*o+2];if(Math.max(l*e,l*n)+Math.max(d*t,d*r)+Math.max(u*i,u*s)+a[4*o+3]<0)return!1}{let o=a[20],l=a[21],d=a[22],u=a[23],c=Math.max(o*e,o*n)+Math.max(l*t,l*r)+Math.max(d*i,d*s),h=1e-6*Math.abs(u);if(Math.min(o*e,o*n)+Math.min(l*t,l*r)+Math.min(d*i,d*s)>-u+h||c<-u-h)return!1}return!0}function E(e,t,i,n=!1){let r=i.length,s=[],a=n?1:t+1,l=n?t+1:1;for(let n=0;n<r;++n){let r=i[n];for(let i=0;i<t;++i)0!==e[i*a+r*l]&&(s[i]=!0)}return(0,o.W0)(s,!0)}function T(e,t,i){for(let n=0;n<3;++n){let r=i[n];for(let i=0;i<3;++i)e[n+3*i]=r*t[n+3*i]}return e}function k(e){if(1===e[15]){let t=2/Math.abs(e[10]),i=2/Math.abs(e[0]);return i*(2/Math.abs(e[5]))*t}let t=e[10],i=2*e[14]/(2*t-2);return 4/(e[0]*e[5])/3*(Math.abs((t-1)*i/(t+1))**3-Math.abs(i)**3)}function D(e){if(1===e[15])return 2/Math.abs(e[10]);let t=e[10],i=2*e[14]/(2*t-2);return Math.abs((t-1)*i/(t+1)-i)}function P(e){return e[2]=0,e[6]=0,e[10]=0,e[14]=0,e}let L=r.create();function I(e,t){t[0]=t[1]=t[2]=Number.POSITIVE_INFINITY,t[3]=t[4]=t[5]=Number.NEGATIVE_INFINITY;for(let i=0;i<8;++i){L[0]=2*(1&i)-1,L[1]=2*(i>>>1&1)-1,L[2]=2*(i>>>2&1)-1,r.transformMat4(L,L,e);for(let e=0;e<3;++e){let i=L[e];t[e]=Math.min(t[e],i),t[e+3]=Math.max(t[e+3],i)}}}},4465:function(){if("undefined"!=typeof NEUROGLANCER_GOOGLE_TAG_MANAGER){let e="dataLayer",t=NEUROGLANCER_GOOGLE_TAG_MANAGER;window[e]=window[e]||[],window[e].push({"gtm.start":new Date().getTime(),event:"gtm.js"});let i=document.createElement("script");i.async=!0,i.src=`https://www.googletagmanager.com/gtm.js?id=${t}`,document.head.appendChild(i)}},290:function(e,t,i){"use strict";i.d(t,{$Z:function(){return W},C$:function(){return x},CT:function(){return _},DY:function(){return k},ET:function(){return F},Im:function(){return l},Iq:function(){return T},Iw:function(){return w},JG:function(){return j},Kh:function(){return A},OD:function(){return y},PT:function(){return C},Qu:function(){return G},Re:function(){return V},Sc:function(){return E},V3:function(){return d},ZE:function(){return D},ZI:function(){return M},_b:function(){return u},_s:function(){return c},a6:function(){return L},ah:function(){return H},bW:function(){return z},ds:function(){return I},et:function(){return B},f6:function(){return b},gV:function(){return U},hd:function(){return function e(t){if("object"==typeof t){if(null===t)return"null";if(Array.isArray(t)){let i="[",n=t.length,r=0;if(0<n)for(i+=e(t[r]);++r<n;)i+=",",i+=e(t[r]);return i+="]"}let i="{",n=Object.keys(t).sort(),r=0,s=n.length;if(r<s){let a=n[r];for(i+=JSON.stringify(a),i+=":",i+=e(t[a]);++r<s;)i+=",",i+=JSON.stringify(a=n[r]),i+=":",i+=e(t[a])}return i+="}"}return JSON.stringify(t)}},j2:function(){return N},j5:function(){return q},jz:function(){return s},kt:function(){return P},lu:function(){return a},m7:function(){return S},nH:function(){return r},o7:function(){return o},qs:function(){return O},uq:function(){return R},zE:function(){return $}});var n=i(3783);function r(e){let t=typeof e;if("number"===t||"string"===t){let t=parseFloat(""+e);if(!Number.isNaN(t))return t}throw Error(`Expected floating-point number, but received: ${JSON.stringify(e)}.`)}function s(e){let t=r(e);if(Number.isFinite(t))return t;throw Error(`Expected finite floating-point number, but received: ${t}.`)}function a(e){let t=r(e);if(Number.isFinite(t)&&t>=0)return t;throw Error(`Expected finite non-negative floating-point number, but received: ${t}.`)}function o(e){let t=s(e);if(t>0)return t;throw Error(`Expected positive finite floating-point number, but received: ${t}.`)}function l(e,t){return i=>{let n=r(i);if(n>=e&&n<=t)return n;throw Error(`Expected floating-point number in range [${e}, ${t}], but received: ${n}.`)}}function d(e,t,i=r){for(let n of(C(t),e[0]=e[1]=e[2]=0,Object.keys(t)))switch(n){case"x":e[0]=i(t[n]);break;case"y":e[1]=i(t[n]);break;case"z":e[2]=i(t[n]);break;default:throw Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(t)}.`)}return e}function u(e,t){let i=e.length;if(!Array.isArray(t)||t.length!==i)throw Error("Incompatible sizes");for(let e=0;e<i;++e)if(!Number.isFinite(parseFloat(t[e])))throw Error("Non-finite value.");for(let n=0;n<i;++n)e[n]=parseFloat(t[n]);return e}function c(e,t){let i=e.length;if(!Array.isArray(t)||t.length!==i)throw Error("Incompatible sizes.");for(let e=0;e<i;++e)if(!Number.isInteger(parseInt(t[e],void 0)))throw Error("Non-integer value.");for(let n=0;n<i;++n)e[n]=parseInt(t[n],void 0);return e}let h=/('(?:[^'\\]|(?:\\.))*')/,p=/("(?:[^"\\]|(?:\\.))*")/,g=RegExp(`${h.source}|${p.source}`),m=RegExp(`${p.source}|${h.source}`),f=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,v=/^((?:[^"'\\]|(?:\\.))*)'/;function y(e){return JSON.parse(function(e,t,i){let n,r,s;let a=/[&_,]/g;n="'",r=f,s=g;let o="";for(;e.length>0;){let t,l;let d=e.match(s);if(null===d)t=e,e="",l="";else{t=e.substr(0,d.index),e=e.substr(d.index+d[0].length);let s=d[1];l=void 0!==s?function(e,t,i,n){if(e.length>=2&&e.charAt(0)===t&&e.charAt(e.length-1)===t){let r=e.substr(1,e.length-2),s=i;for(;r.length>0;){let e=r.match(n);if(null===e){s+=r;break}s+=e[1],e[2]===i?(s+="\\",s+=i):s+=t,r=r.substr(e.index+e[0].length)}return s+=i}return e}(s,n,i,r):d[2]}o+=t.replace(a,","),o+=l}return o}(e,",",'"'))}function b(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);if(void 0!==t&&e.length!==t)throw Error(`Expected array of length ${t}, but received: ${JSON.stringify(e)}.`);return e}function S(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);return e.map(t)}function w(e,t,i){let n=e.length;if(!Array.isArray(t)||t.length!==n)throw Error(`Expected length ${n} array, but received: ${JSON.stringify(t)}.`);for(let r=0;r<n;++r)e[r]=i(t[r],r);return e}function C(e){if("object"!=typeof e||null==e||Array.isArray(e))throw Error(`Expected JSON object, but received: ${JSON.stringify(e)}.`);return e}function x(e){let t=parseInt(e,10);if(!Number.isInteger(t))throw Error(`Expected integer, but received: ${JSON.stringify(e)}.`);return t}function E(e){let t=x(e);if(t<=0)throw Error(`Expected positive integer, but received: ${t}.`);return t}function T(e){let t=x(e);if(t<0)throw Error(`Expected non-negative integer, but received: ${t}.`);return t}function k(e,t){let i=t.get(e);if(void 0===i)throw Error(`Expected one of ${JSON.stringify(Array.from(t.keys()))}, but received: ${JSON.stringify(e)}.`);return i}function D(e){if("string"!=typeof e)throw Error(`Expected string, but received: ${JSON.stringify(e)}.`);return e}function P(e){if(void 0!==e)return D(e)}function L(e){if(void 0!==e)return x(e)}function I(e){if(void 0!==e){if("boolean"==typeof e)return e;if("true"===e)return!0;if("false"===e)return!1;throw Error(`Expected string or boolean but received: ${JSON.stringify(e)}`)}}function R(e,t,i){let n=Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0;try{return i(n)}catch(e){throw Error(`Error parsing ${JSON.stringify(t)} property: ${e.message}`)}}function A(e,t,i,n){return R(e,t,e=>void 0===e?n:i(e))}function M(e,t){C(e);let i=new Map;for(let n of Object.keys(e))try{i.set(n,t(e[n]))}catch(e){throw Error(`Error parsing value associated with key ${JSON.stringify(n)}: ${e.message}`)}return i}function N(e){if("number"!=typeof e||!Number.isFinite(e)||e<0||e>1)throw Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(e)}.`);return e}function V(e){if(""===e)return{};if(e.startsWith("{"))return y(e);let t={};for(let i of e.split(/[&;]/)){let e=i.match(/^([^=&;]+)=([^&;]*)$/);if(null===e)throw Error(`Invalid query string part: ${JSON.stringify(i)}.`);t[e[1]]=decodeURIComponent(e[2])}return t}function O(e){if(void 0===e)return"";let t=Object.keys(e);return 0===t.length?"":t.some(t=>"string"!=typeof e[t])?JSON.stringify(e):t.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}function _(e,t,i=/^[a-zA-Z]/){if("string"==typeof e&&null!==e.match(i)){let i=e.toUpperCase();if(Object.prototype.hasOwnProperty.call(t,i))return t[i]}throw Error(`Invalid enum value: ${JSON.stringify(e)}.`)}function F(e){return w(n.R3.create(),e,s)}function B(e){return w(n.R3.create(),e,o)}function U(e){return w(n.R3.create(),e,E)}function $(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if("string"!=typeof t)throw Error(`Expected string, received: ${JSON.stringify(t)}.`);return e}function G(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if(!Number.isInteger(t))throw Error(`Expected integer, received: ${JSON.stringify(t)}.`);return e}function z(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)r(t);return e}function j(e){if("boolean"!=typeof e)throw Error(`Expected boolean, received: ${JSON.stringify(e)}`);return e}function W(e){for(let t in e)return e}function q(e,t){if(e!==t)throw Error(`Expected ${JSON.stringify(t)}, but received: ${JSON.stringify(e)}`);return t}function H(e,t){if(void 0===e){let e=Array(t);return e.fill(null),e}return w(Array(t),e,e=>{if(null!==e&&"string"!=typeof e)throw Error(`Expected string or null, but received: ${JSON.stringify(name)}`);return e})}},3853:function(e,t,i){"use strict";let n;function r(e,t,i,n,r,s,a,o,l){for(let d=0;d<a;++d)for(let a=0;a<l;++a){let l=0;for(let e=0;e<o;++e)l+=i[d+n*e]*r[e+s*a];e[d+t*a]=l}return e}i.d(t,{DC:function(){return p},Dg:function(){return h},GU:function(){return l},JG:function(){return d},Jp:function(){return r},Kt:function(){return a},SO:function(){return c},XD:function(){return s},Z4:function(){return o},lU:function(){return g},pb:function(){return m},w9:function(){return u}});function s(e,t,i=t){return function(e,t,i){for(let n=0;n<i;++n){let r=t*n;e.fill(0,r,r+i),e[r+n]=1}return e}(new e(t*i),t,Math.min(t,i))}function a(e,t,i=!0){let n=t.length,r=i?n+1:n,s=new e(r*(n+1));i&&(s[s.length-1]=1);for(let e=0;e<n;++e)s[(r+1)*e]=t[e];return s}function o(e,t,i=!0){let n=t.length,r=i?n+1:n,a=s(e,r,n+1);for(let e=0;e<n;++e)a[r*n+e]=t[e];return a}function l(e,t,i){for(let n=0;n<i;++n)for(let r=0;r<i;++r)if(e[n*t+r]!==(n===r?1:0))return!1;return!0}function d(e,t,i,n,r,s){for(let a=0;a<s;++a){let s=a*n,o=a*t;for(let t=0;t<r;++t)e[o+t]=i[s+t]}return e}function u(e,t,i,n){d(e,t+1,i,n+1,n,n);for(let r=0;r<n;++r)e[(t+1)*t+r]=i[(n+1)*n+r];e[e.length-1]=1;for(let i=n;i<t;++i)e[(t+1)*i+i]=1;return e}function c(e,t,i,r,s){return d(e,t,i,r,s,s),function(e,t,i){let r=1;(void 0===n||n.length<i)&&(n=new Uint32Array(i));for(let e=0;e<i;++e)n[e]=e;for(let s=0;s<i;++s){let a=t*s,o=s;{let t=Math.abs(e[a+s]);for(let n=s+1;n<i;++n){let i=Math.abs(e[a+n]);i>t&&(t=i,o=n)}}if(s!==o){r*=-1;for(let n=0;n<i;++n){let i=t*n,r=e[i+s];e[i+s]=e[i+o],e[i+o]=r}{let e=n[s];n[s]=n[o],n[o]=e}}let l=e[a+s],d=1/l;r*=l;for(let n=0;n<i;++n)e[t*n+s]*=d;e[a+s]=d;for(let n=0;n<i;++n){if(n===s)continue;let r=-e[t*s+n];for(let a=0;a<i;++a){let i=t*a;e[i+n]+=r*e[i+s]}e[t*s+n]=r*d}}for(let r=0;r<i;++r){let s=n[r];for(;s!==r;){let a=t*r,o=t*s;for(let t=0;t<i;++t){let i=a+t,n=o+t,r=e[i];e[i]=e[n],e[n]=r}let l=n[r]=n[s];n[s]=s,s=l}}return r}(e,t,s)}function h(e,t,i,n,r,s){for(let a=0;a<s;++a){let s=t*a,o=n*a;for(let t=0;t<r;++t)if(e[s+t]!==i[o+t])return!1}return!0}function p(e,t,i,n,r){for(let s=0;s<r;++s){let a=t[i*r+s];for(let e=0;e<r;++e)a+=t[i*e+s]*n[e];e[s]=a}return e}function g(e,t,i,n,r){for(let s=0;s<r;++s){let a=0;for(let e=0;e<r;++e)a+=t[i*e+s]*n[e];e[s]=a}return e}function m(e,t,i,n,r,s){let a=r.length;for(let o=0;o<a;++o){let a=r[o];for(let r=0;r<s;++r)e[r*t+o]=i[r*n+a]}return e}},566:function(e,t,i){"use strict";i.d(t,{K_:function(){return r},LP:function(){return s},MZ:function(){return n}});class n{handlers=new Set;count=0;constructor(){let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(e=>{e.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}addOnce(e){let{handlers:t}=this;t.add(function i(...n){t.delete(i),e(...n)})}remove(e){return this.handlers.delete(e)}dispatch;dispose(){this.handlers=void 0}}class r extends n{}let s={count:0,add:e=>()=>{},addOnce(e){},remove:e=>!1}},4886:function(e,t,i){"use strict";e.exports={}},8512:function(e,t,i){"use strict";e.exports={}},7671:function(e,t,i){"use strict";e.exports={}},1167:function(e,t,i){"use strict";e.exports={}},8611:function(e,t,i){"use strict";e.exports={}},5941:function(e,t,i){"use strict";e.exports={}},3372:function(e,t,i){"use strict";e.exports={}},320:function(e,t,i){"use strict";e.exports={}},447:function(e,t,i){"use strict";e.exports={}},9760:function(e,t,i){"use strict";e.exports={}},5256:function(e,t,i){"use strict";e.exports={}},4003:function(e,t,i){"use strict";e.exports={}},7550:function(e,t,i){"use strict";e.exports={}},8213:function(e,t,i){"use strict";e.exports={}},5125:function(e,t,i){"use strict";e.exports={}},444:function(e,t,i){"use strict";e.exports={}},9651:function(e,t,i){"use strict";e.exports={}},9547:function(e,t,i){"use strict";e.exports={}},6866:function(e,t,i){"use strict";e.exports={}},2950:function(e,t,i){"use strict";e.exports={}},6700:function(e,t,i){"use strict";e.exports={}},6549:function(e,t,i){"use strict";e.exports={}},9308:function(e,t,i){"use strict";e.exports={}},7422:function(e,t,i){"use strict";e.exports={}},8263:function(e,t,i){"use strict";e.exports={}},6921:function(e,t,i){"use strict";e.exports={}},4504:function(e,t,i){"use strict";e.exports={}},532:function(e,t,i){"use strict";e.exports={}},5214:function(e,t,i){"use strict";e.exports={}},7980:function(e,t,i){"use strict";e.exports={}},3938:function(e,t,i){"use strict";e.exports={}},3395:function(e,t,i){"use strict";e.exports={}},3278:function(e,t,i){"use strict";e.exports={}},1808:function(e,t,i){"use strict";e.exports={}},4636:function(e,t,i){"use strict";e.exports={}},5584:function(e,t,i){"use strict";e.exports={}},6674:function(e,t,i){"use strict";e.exports={}},677:function(e,t,i){"use strict";e.exports={}},5995:function(e,t,i){"use strict";e.exports={}},4226:function(e,t,i){"use strict";e.exports={}},8468:function(e,t,i){"use strict";e.exports={}},9215:function(e,t,i){"use strict";e.exports={}},4685:function(e,t,i){"use strict";e.exports={}},5029:function(e,t,i){"use strict";e.exports={}},5621:function(e,t,i){"use strict";e.exports={}},6054:function(e,t,i){"use strict";e.exports={}},4939:function(e,t,i){"use strict";e.exports={}},389:function(e,t,i){"use strict";e.exports={}},5838:function(e,t,i){"use strict";e.exports={}},9177:function(e,t,i){"use strict";e.exports={}},4282:function(e,t,i){"use strict";e.exports={}},1069:function(e,t,i){"use strict";e.exports={}},7665:function(e,t,i){"use strict";e.exports={}},1682:function(e,t,i){"use strict";e.exports={}},200:function(e,t,i){"use strict";e.exports={}},284:function(e,t,i){"use strict";e.exports={}},1146:function(e,t,i){"use strict";let n,r,s,a,o,l,d,u,c,h,p,g,m,f;i("2374"),i("3372");var v,y,b,S,w,C,x,E,T,k,D,P,L,I,R,A,M,N,V,O,_,F,B,U,$,G,z,j,W,q,H,J,K,Z=i("3719"),Y=i("1471"),X=i("5931"),Q=i("3783");function ee(e){return("0"+e.toString(16)).slice(-2)}function et(e){try{if("string"!=typeof e)throw Error(`Expected string, but received ${JSON.stringify(e)}.`);let t=document.createElement("canvas").getContext("2d");t.fillStyle=e;let i=function(e){{let t=e.match(/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/);if(null!==t)return[parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3],10),parseFloat(t[4])]}{let t=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/);if(null!==t)return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1]}throw Error(`Invalid serialized color: ${JSON.stringify(e)}.`)}(t.fillStyle);return Q.vh.fromValues(i[0]/255,i[1]/255,i[2]/255,i[3])}catch(e){throw Error(`Failed to parse color specification: ${e.message}`)}}function ei(e){return et(e).subarray(0,3)}function en(e){let t=void 0===e[3]?3:4,i=0;for(let n=0;n<t;n++)i=(i<<8>>>0)+Math.min(255,Math.max(0,Math.round(255*e[t-1-n])));return i}function er(e){return Q.R3.fromValues((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255)}function es(e){return Q.vh.fromValues((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255,(e>>>24&255)/255)}function ea(e){if(void 0===e[3]||1===e[3]){let t="#";for(let i=0;i<3;++i)t+=ee(Math.min(255,Math.max(0,Math.round(255*e[i]))));return t}let t="rgba(";for(let i=0;i<3;++i)0!==i&&(t+=", "),t+=Math.min(255,Math.max(0,Math.round(255*e[i])));return t+=`, ${(0,X.i)(e[3])})`}function eo(e){return e<=.03928?e/12.92:((e+.055)/1.055)**2.4}function el(e){return .179>=function(e){let[t,i,n]=e;return .2126*eo(t)+.7152*eo(i)+.0722*eo(n)}(e)}class ed extends Z.SN{defaultValue;constructor(e){super(Q.R3.clone(e)),this.defaultValue=e}toString(){return ea(this.value)}toJSON(){if(!Q.R3.equals(this.value,this.defaultValue))return ea(this.value)}reset(){this.value=Q.R3.clone(this.defaultValue)}restoreState(e){if(void 0===e){this.reset();return}let{value:t}=this,i=ei(e);!Q.R3.equals(t,i)&&(this.value=i)}}class eu extends Z.SN{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(void 0!==e)return ea(e)}reset(){this.value=void 0}restoreState(e){if(void 0===e){this.reset();return}let{value:t}=this,i=ei(e);(void 0===t||!Q.R3.equals(t,i))&&(this.value=i)}}var ec=((v={})[v.UINT8=0]="UINT8",v[v.INT8=1]="INT8",v[v.UINT16=2]="UINT16",v[v.INT16=3]="INT16",v[v.UINT32=4]="UINT32",v[v.INT32=5]="INT32",v[v.UINT64=6]="UINT64",v[v.FLOAT32=7]="FLOAT32",v);let eh={0:!1,1:!0,2:!1,3:!0,4:!1,5:!0,6:!1,7:void 0},ep={0:1,1:1,2:2,3:2,4:4,5:4,6:8,7:4},eg={0:Uint8Array,1:Int8Array,2:Uint16Array,3:Int16Array,4:Uint32Array,5:Int32Array,6:Uint32Array,7:Float32Array},em={0:1,1:1,2:1,3:1,4:1,5:1,6:2,7:1};var ef=i("106");var ev=((y={})[y.LITTLE=0]="LITTLE",y[y.BIG=1]="BIG",y);let ey=17===new Uint8Array(Uint16Array.of(4386).buffer)[0]?1:0;var eb=i("290");let eS=new Float64Array(1),ew=new Uint32Array(eS.buffer);var eC=i("9754");let ex={[ec.UINT8]:[0,255],[ec.INT8]:[-128,127],[ec.UINT16]:[0,65535],[ec.INT16]:[-32768,32767],[ec.UINT32]:[0,0xffffffff],[ec.INT32]:[-0x80000000,0x7fffffff],[ec.UINT64]:[eC.E.ZERO,new eC.E(0xffffffff,0xffffffff)],[ec.FLOAT32]:[0,1]};function eE(e,t){let i;if("number"==typeof t){let i=e[0];return(t-i)/(e[1]-i)}let n=e[0],r=e[1];i=0>eC.E.compare(t,n)?-eC.E.subtract(eR,n,t).toNumber():eC.E.subtract(eR,t,n).toNumber();let s=eC.E.absDifference(eR,r,n).toNumber();return eC.E.compare(n,r)>0&&(s*=-1),i/s}function eT(e,t,i){if("number"==typeof e[0]){let n=e[0],r=n*(1-i)+e[1]*i;if(t!==ec.FLOAT32){let e=ex[t];r=Math.round(r),r=Math.max(e[0],r),r=Math.min(e[1],r)}return r}let n=e[0],r=e[1];eC.E.compare(n,r)>0&&([n,r]=[r,n],i=1-i);let s=eC.E.subtract(eR,r,n).toNumber(),a=new eC.E;return i<=0?(eR.setFromNumber(-(s*i)),eC.E.subtract(a,n,eC.E.min(eR,n))):i>=1?(eR.setFromNumber(s*(i-1)),eC.E.add(a,r,eR),eC.E.less(a,r)&&(a.low=a.high=0xffffffff)):(eR.setFromNumber(s*i),eC.E.add(a,n,eR),eC.E.less(a,n)&&(a.low=a.high=0xffffffff)),a}function ek(e,t){return"number"==typeof t?Math.min(Math.max(e[0],t),e[1]):eC.E.min(eC.E.max(e[0],t),e[1])}function eD(e,t){return[ek(e,t[0]),ek(e,t[1])]}function eP(e){if(0>=eI(e[0],e[1]))return e;throw Error(`Invalid interval: [${e[0]}, ${e[1]}]`)}function eL(e){return 0>=eI(e[0],e[1])?e:[e[1],e[0]]}function eI(e,t){return"number"==typeof e?e-t:eC.E.compare(e,t)}let eR=new eC.E,eA=new eC.E;function eM(e,t){let i;switch(i="string"!=typeof t?""+t:t,e){case ec.UINT64:return eC.E.parseString(i);case ec.FLOAT32:{let e=parseFloat(i);if(!Number.isFinite(e))throw Error(`Invalid float32 value: ${JSON.stringify(i)}`);return e}default:{let t=parseInt(i),n=ex[e];if(!Number.isInteger(t)||t<n[0]||t>n[1])throw Error(`Invalid ${ec[e].toLowerCase()} value: ${JSON.stringify(i)}`);return t}}}function eN(e,t){return(0,eb.Iw)([,,],e,e=>eM(t,e))}function eV(e){return(0,eb.Iw)([,,],e,e=>(function(e){if("number"==typeof e)return e;if("string"==typeof e){let t=new eC.E,i=Number(e);if(t.tryParseString(e))return i.toString()===t.toString()?i:t;if(!Number.isFinite(i))throw Error(`Invalid value: ${JSON.stringify(e)}`);return i}throw Error(`Invalid value: ${JSON.stringify(e)}`)})(e))}function eO(e,t,i){return e===ec.UINT64?eC.E.equal(t[0],i[0])&&eC.E.equal(t[1],i[1]):t[0]===i[0]&&t[1]===i[1]}function e_(e,t,i=ex[t]){if(!eO(t,e,i))return t===ec.UINT64?[e[0].toString(),e[1].toString()]:e}function eF(e,t,i){switch(e){case ec.FLOAT32:return function(e,t){if(Number.isNaN(e)||Number.isNaN(t))return NaN;if(e===t)return t;if(0===e)return t<0?-5e-324:5e-324;eS[0]=e;let i=ey===ev.LITTLE?0:1,n=1-i;return t>e==e>0?0xffffffff===ew[i]?(ew[i]=0,ew[n]+=1):ew[i]+=1:0===ew[i]?(ew[i]=0xffffffff,ew[n]-=1):ew[i]-=1,eS[0]}(t,1/0*i);case ec.UINT64:if(-1===i){if(0===t.low&&0===t.high)return t;return eC.E.decrement(new eC.E,t)}if(0xffffffff===t.low&&0xffffffff===t.high)return t;return eC.E.increment(new eC.E,t);default:{let n=ex[e];return Math.max(n[0],Math.min(n[1],t+i))}}}function eB(e,t){switch(e){case ec.FLOAT32:return 1;case ec.UINT64:{let e=eC.E.absDifference(eR,t[0],t[1]).toNumber();return e/(e+1)}default:{let e=Math.abs(t[0]-t[1]);return e/(e+1)}}}function eU(e,t){if(void 0===e)return ex[t];let[i,n]=e;if(t===ec.UINT64)return"number"==typeof i&&(i=eC.E.fromNumber(i)),"number"==typeof n&&(n=eC.E.fromNumber(n)),[i,n];if("number"!=typeof i&&(i=i.toNumber()),"number"!=typeof n&&(n=n.toNumber()),t!==ec.FLOAT32){i=Math.round(i),n=Math.round(n);let e=ex[t];i=Number.isFinite(i)?Math.min(Math.max(e[0],i),e[1]):e[0],n=Number.isFinite(n)?Math.min(Math.max(e[0],n),e[1]):e[1]}return[i,n]}function e$(e=128){let t=Math.ceil(e/32),i=new Uint32Array(t);crypto.getRandomValues(i);let n="";for(let e=0;e<t;++e)n+=("00000000"+i[e].toString(16)).slice(-8);return n}function eG(){let e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}var ez=i("566");class ej extends ef.gj{id;changed;value;constructor(e){super(),this.id=e,this.changed=new ez.K_}}var eW=((b={})[b.POINT=0]="POINT",b[b.LINE=1]="LINE",b[b.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",b[b.ELLIPSOID=3]="ELLIPSOID",b);let eq=[0,1,2,3],eH={float32:ec.FLOAT32,uint32:ec.UINT32,int32:ec.INT32,uint16:ec.UINT16,int16:ec.INT16,uint8:ec.UINT8,int8:ec.INT8,rgb:void 0,rgba:void 0};function eJ(e){return"uint8"===e.type&&void 0!==e.tag}let eK={rgb:{serializedBytes:()=>3,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, true);dv.setUint8(${t} + 2, ${e} >>> 16);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, true) | (dv.getUint8(${t} + 2) << 16);`,deserializeJson:e=>en(ei(e)),serializeJson:e=>ea(er(e))},rgba:{serializedBytes:()=>4,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, true);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, true);`,deserializeJson:e=>en(et(e)),serializeJson:e=>ea(es(e))},float32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setFloat32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getFloat32(${t}, isLittleEndian);`,deserializeJson:e=>(0,eb.nH)(e),serializeJson:e=>e},uint32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, isLittleEndian);`,deserializeJson:e=>(0,eb.C$)(e),serializeJson:e=>e},int32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setInt32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt32(${t}, isLittleEndian);`,deserializeJson:e=>(0,eb.C$)(e),serializeJson:e=>e},uint16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, isLittleEndian);`,deserializeJson:e=>(0,eb.C$)(e),serializeJson:e=>e},int16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setInt16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt16(${t}, isLittleEndian);`,deserializeJson:e=>(0,eb.C$)(e),serializeJson:e=>e},uint8:{serializedBytes:()=>1,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getUint8(${t});`,deserializeJson:e=>(0,eb.C$)(e),serializeJson:e=>e},int8:{serializedBytes:()=>2,alignment:()=>1,serializeCode:(e,t)=>`dv.setInt8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getInt8(${t});`,deserializeJson:e=>(0,eb.C$)(e),serializeJson:e=>e}};function eZ(e,t,i){let n=0,r=i.length,s=Array(r),a=[];for(let e=0;e<r;++e)s[e]=e;let o=t=>eK[i[t].type].alignment(e);s.sort((e,t)=>o(t)-o(e));let l=0,d=Array(r),u=t,c=()=>{u+=(4-u%4)%4,n+=u,a[l]=u,u=0,++l};for(let t=0;t<r;++t){let n=s[t],r=eK[i[n].type],a=r.serializedBytes(e),o=r.alignment(e),h=(o-u%o)%o,p=u+h+a;p+(4-p%4)%4<=255?u+=h:c(),d[n]={offset:u,group:l},u+=a}return c(),{serializedBytes:n,offsets:d,propertyGroupBytes:a}}class eY{rank;firstGroupInitialOffset;propertySpecs;serializedBytes;serialize;deserialize;propertyGroupBytes;constructor(e,t,i){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=i,0===i.length){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:n,offsets:r,propertyGroupBytes:s}=eZ(e,t,i);this.propertyGroupBytes=s;let a="let groupOffset0 = offset;";for(let e=1;e<s.length;++e)a+=`let groupOffset${e} = groupOffset${e-1} + ${s[e-1]}*annotationCount;`;for(let e=0;e<s.length;++e)a+=`groupOffset${e} += ${s[e]}*annotationIndex;`;let o=a,l=a,d=i.length;for(let t=0;t<d;++t){let{group:n,offset:s}=r[t],a=eK[i[t].type],d=`properties[${t}]`,u=`groupOffset${n} + ${s}`;o+=a.serializeCode(d,u,e),l+=a.deserializeCode(d,u,e)}this.serializedBytes=n,this.serialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",o),this.deserialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",l)}}function eX(e,t){let i=[];for(let n of eq){let r=e9[n];i[n]=new eY(e,r.serializedBytes(e),t)}return i}function eQ(e,t){let i="float32"===e.type?t.toPrecision(6):t.toString(),{enumValues:n,enumLabels:r}=e;if(void 0!==n){let e=n.indexOf(t);if(-1!==e)return`${r[e]} (${i})`}return i}function e0(e){let t=(0,eb.ZE)(e);if(null===t.match(/^[a-z][a-zA-Z0-9_]*$/))throw Error(`Invalid property identifier: ${JSON.stringify(e)}`);return t}function e1(e){if((0,eb.ZE)(e),!Object.prototype.hasOwnProperty.call(eK,e))throw Error("Unsupported property type: $JSON.stringify(obj)}");return e}function e2(e){let t,i,n;(0,eb.PT)(e);let r=(0,eb.uq)(e,"id",e0),s=(0,eb.uq)(e,"type",e1),a=(0,eb.Kh)(e,"description",eb.ZE),o=(0,eb.Kh)(e,"default",e=>eK[s].deserializeJson(e),0);switch(s){case"rgb":case"rgba":break;default:{let r=ec[s.toUpperCase()];void 0!==(t=(0,eb.Kh)(e,"enum_values",e=>(0,eb.m7)(e,e=>eM(r,e))))&&(i=(0,eb.uq)(e,"enum_labels",e=>(0,eb.Iw)(Array(t.length),e,eb.ZE))),n=(0,eb.Kh)(e,"tag",eb.ZE)}}return{type:s,identifier:r,description:a,default:o,enumValues:t,enumLabels:i,tag:n}}function e3(e){var t;let i=e.default;let n="rgb"!==(t=e).type&&"rgba"!==t.type,r=n?e.tag:void 0,s=n?e.enumValues:void 0,a=n?e.enumLabels:void 0;return{id:e.identifier,description:e.description,type:e.type,tag:r,enum_values:s,enum_labels:a,default:0===i?void 0:eK[e.type].serializeJson(i)}}function e4(e){if(void 0===e)return[];let t=(0,eb.m7)(e,e2);return!function(e){let t=new Set;for(let i of e){if(t.has(i.identifier))throw Error(`Duplicate property identifier: ${i.identifier}`);t.add(i.identifier)}}(t),t}function e6(e,t,i,n,r){for(let s=0;s<n;++s)e.setFloat32(t,r[s],i),t+=4;return t}function e5(e,t,i,n,r,s){return t=e6(e,t,i,n,r),t=e6(e,t,i,n,s)}function e8(e,t,i,n,r){for(let s=0;s<n;++s)r[s]=e.getFloat32(t,i),t+=4;return t}function e7(e,t,i,n,r,s){return t=e8(e,t,i,n,r),t=e8(e,t,i,n,s)}let e9={1:{icon:"ꕹ",description:"Line",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState(e,t,i){e.pointA=(0,eb.uq)(t,"pointA",e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz)),e.pointB=(0,eb.uq)(t,"pointB",e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz))},serializedBytes:e=>8*e,serialize(e,t,i,n,r){e5(e,t,i,n,r.pointA,r.pointB)},deserialize:(e,t,i,n,r)=>{let s=new Float32Array(n),a=new Float32Array(n);return e7(e,t,i,n,s,a),{type:1,pointA:s,pointB:a,id:r,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},0:{icon:"⚬",description:"Point",toJSON:e=>({point:Array.from(e.point)}),restoreState:(e,t,i)=>{e.point=(0,eb.uq)(t,"point",e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz))},serializedBytes:e=>4*e,serialize:(e,t,i,n,r)=>{e6(e,t,i,n,r.point)},deserialize:(e,t,i,n,r)=>{let s=new Float32Array(n);return e8(e,t,i,n,s),{type:0,point:s,id:r,properties:[]}},visitGeometry(e,t){t(e.point,!1)}},2:{icon:"❑",description:"Bounding Box",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState:(e,t,i)=>{e.pointA=(0,eb.uq)(t,"pointA",e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz)),e.pointB=(0,eb.uq)(t,"pointB",e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz))},serializedBytes:e=>8*e,serialize(e,t,i,n,r){e5(e,t,i,n,r.pointA,r.pointB)},deserialize:(e,t,i,n,r)=>{let s=new Float32Array(n),a=new Float32Array(n);return e7(e,t,i,n,s,a),{type:2,pointA:s,pointB:a,id:r,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},3:{icon:"◎",description:"Ellipsoid",toJSON:e=>({center:Array.from(e.center),radii:Array.from(e.radii)}),restoreState:(e,t,i)=>{e.center=(0,eb.uq)(t,"center",e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz)),e.radii=(0,eb.uq)(t,"radii",e=>(0,eb.Iw)(new Float32Array(i),e,eb.lu))},serializedBytes:e=>8*e,serialize(e,t,i,n,r){e5(e,t,i,n,r.center,r.radii)},deserialize:(e,t,i,n,r)=>{let s=new Float32Array(n),a=new Float32Array(n);return e7(e,t,i,n,s,a),{type:3,center:s,radii:a,id:r,properties:[]}},visitGeometry(e,t){t(e.center,!1),t(e.radii,!0)}}};function te(e,t){let i=e9[e.type].toJSON(e,t.rank);i.type=eW[e.type].toLowerCase(),i.id=e.id,i.description=e.description||void 0;let{relatedSegments:n}=e;n?.some(e=>0!==e.length)&&(i.segments=n.map(e=>e.map(e=>e.toString())));let r=t.properties.value;return 0!==r.length&&(i.props=e.properties.map((e,t)=>eK[r[t].type].serializeJson(e))),i}class tt extends ef.gj{relationships;properties;annotationMap;changed;readonly;childAdded;childUpdated;childCommitted;childDeleted;pending;rank_;get rank(){return this.rank_}annotationPropertySerializers;constructor(e,t=[],i=new Z.SN([])){super(),this.relationships=t,this.properties=i,this.annotationMap=new Map,this.changed=new ez.K_,this.readonly=!1,this.childAdded=new ez.MZ,this.childUpdated=new ez.MZ,this.childCommitted=new ez.MZ,this.childDeleted=new ez.MZ,this.pending=new Set,this.references=new Map,this.rank_=e,this.annotationPropertySerializers=eX(e,i.value)}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),e.id){if(this.annotationMap.has(e.id))throw Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`)}else e.id=tn();return this.annotationMap.set(e.id,e),!t&&this.pending.add(e.id),this.changed.dispatch(),this.childAdded.dispatch(e),t&&this.childCommitted.dispatch(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch(),this.childCommitted.dispatch(t)}update(e,t){if(this.ensureUpdated(),null===e.value)throw Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){if(null!==e.value)e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id)}getReference(e){let t=this.references.get(e);return void 0!==t?t.addRef():((t=new ej(e)).value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}references;ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let i of this){if(!t.has(i.id))e.push(te(i,this))}return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;for(let i of(t.clear(),this.pending.clear(),void 0!==e&&(0,eb.m7)(e,e=>{let i=function(e,t,i=!1){(0,eb.PT)(e);let n=(0,eb.uq)(e,"type",e=>(0,eb.CT)(e,eW)),r=(0,eb.uq)(e,"id",i?eb.kt:eb.ZE)||tn(),s=(0,eb.uq)(e,"segments",e=>{if(void 0===e)return t.relationships.map(()=>[]);let i=(0,eb.f6)(e);return 0===i.length?t.relationships.map(()=>[]):1!==t.relationships.length||Array.isArray(i[0])?(0,eb.m7)((0,eb.f6)(e,t.relationships.length),e=>(0,eb.m7)(e,e=>eC.E.parseString(e))):[(0,eb.m7)(i,e=>eC.E.parseString(e))]}),a=(0,eb.uq)(e,"props",e=>{let i=t.properties.value;return void 0===e?i.map(e=>e.default):(0,eb.m7)((0,eb.f6)(e,i.length),(e,t)=>eK[i[t].type].deserializeJson(e))}),o={id:r,description:(0,eb.uq)(e,"description",eb.kt),relatedSegments:s,properties:a,type:n};return e9[n].restoreState(o,e,t.rank),o}(e,this);t.set(i.id,i)}),this.references.values())){let{id:e}=i,n=t.get(e);i.value=n||null,i.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class ti extends tt{watchableTransform;properties;curCoordinateTransform;get rank(){return this.ensureUpdated(),this.rank_}constructor(e,t=new Z.SN([]),i){super(e.value.sourceRank,i,t),this.watchableTransform=e,this.properties=t,this.getTagProperties=()=>{let{properties:e}=this;return e.value.filter(eJ)},this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated())),this.registerDisposer(t.changed.add(()=>{this.updateAnnotationPropertySerializers(),this.changed.dispatch()}))}updateAnnotationPropertySerializers(){this.annotationPropertySerializers=eX(this.rank_,this.properties.value)}addProperty(e){for(let t of(this.properties.value.push(e),this))t.properties.push(e.default);this.properties.changed.dispatch()}removeProperty(e){let t=this.properties.value.findIndex(t=>t.identifier===e);for(let e of(this.properties.value.splice(t,1),this))e.properties.splice(t,1);this.properties.changed.dispatch()}getTagProperties;ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let i=e.sourceRank,n=t.sourceRank;if(n===i&&(t.inputSpace===e.inputSpace||(0,Y.cO)(t.inputSpace.ids.slice(0,i),e.inputSpace.ids.slice(0,i))))return;let{ids:r}=e.inputSpace,s=t.inputSpace.ids,a=[];for(let e=0;e<i;++e){let t=s.indexOf(r[e]);t>=n&&(t=-1),a.push(t)}let o=e=>{let t=new Float32Array(i);for(let n=0;n<i;++n){let i=a[n];t[n]=-1===i?0:e[n]}return t};for(let e of this.annotationMap.values())switch(e.type){case 0:e.point=o(e.point);break;case 1:case 2:e.pointA=o(e.pointA),e.pointB=o(e.pointB);break;case 3:e.center=o(e.center),e.radii=o(e.radii)}this.rank_!==i&&(this.rank_=i,this.updateAnnotationPropertySerializers()),this.changed.dispatch()}}function tn(){return e$(160)}function tr(e){var t;let i=new tt(e.lowerBounds.length);return i.readonly=!0,i.add({type:2,id:"data-bounds",description:"Data Bounds",pointA:new Float32Array((t=e).lowerBounds),pointB:new Float32Array(t.upperBounds),properties:[]}),i}class ts{propertySerializers;annotations;constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return function(e,t){let i=0,n=[];for(let r of eq){let s=t[r].serializedBytes;n[r]=i,i+=s*e[r].length}let r=[],s=[],a=new ArrayBuffer(i),o=new DataView(a),l=ey===ev.LITTLE;for(let i of eq){let a=t[i],{rank:d}=a,u=a.serialize,c=e[i];r[i]=c.map(e=>e.id),s[i]=new Map(c.map((e,t)=>[e.id,t]));let h=e9[i].serialize,p=n[i],g=a.propertyGroupBytes[0];for(let e=0,t=c.length;e<t;++e){let i=c[e];h(o,p+e*g,l,d,i),u(o,p,e,t,l,i.properties)}}return{data:new Uint8Array(a),typeToIds:r,typeToOffset:n,typeToIdMaps:s}}(this.annotations,this.propertySerializers)}}function ta(e){if(null==e)return e;let{relatedSegments:t}=e;if(void 0!==t)for(let e=0,i=t.length;e<i;++e){let i=t[e];void 0!==i&&(t[e]=i.map(e=>new eC.E(e.low,e.high)))}return e}var to=i("3853");let tl=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xb5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"}],td=[...tl,{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],tu=[{prefix:"u",exponent:-6},...td],tc=new Map;tc.set("",{unit:"",exponent:0});let th=new Map;for(let{prefix:e,exponent:t}of tu)for(let i of(th.set(t,e),["m","s","Hz","rad/s"]))tc.set(`${e}${i}`,{unit:i,exponent:t});function tp(e){let t=Math.log10(e),i=tl.length;return tl[Math.min((0,Y.Kq)(0,i,e=>tl[e].exponent<=t),i-1)]}function tg(e,t,i={}){let n;let{precision:r=6,elide1:s=!0}=i,a=e,o="";if(""!==t){let t=tp(e);o=t.prefix,a=ty(e,-t.exponent)}if(s&&1===a)return{scale:"",unit:t,prefix:o};if(0!==r){let e,t;let i=(n=a<1||a>=1e3?a.toPrecision(r):a.toFixed(r)).indexOf("e");-1!==i?(e=n.substring(0,i),t=n.substring(i)):(e=n,t="");let s=e.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);null!==s&&((e=e.substring(0,e.length-s[1].length)).endsWith(".")&&(e=e.substring(0,e.length-1)),n=e+t)}else n=a.toString();return{scale:n,unit:t,prefix:o}}function tm(e,t,i){let{scale:n,unit:r,prefix:s}=tg(e,t,i);return`${n}${s}${r}`}function tf(e){if(""===e)return{scale:1,unit:""};let t=e.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(null===t)return;let i=t[1],n=void 0===i?1:Number(i);if(Number.isNaN(n))return;let r="";if(void 0!==t[2]){let e=tc.get(t[2]);if(void 0===e)return;r=e.unit,e.exponent>0?n*=10**e.exponent:n/=10**-e.exponent}if(!(n<=0)&&Number.isFinite(n))return{scale:n,unit:r}}function tv(e){let t=tc.get(e);if(void 0===t)throw Error(`Invalid unit: ${JSON.stringify(e)}`);return t}function ty(e,t){return t>=0?e*10**t:e/10**-t}function tb(e,t,i){let n=e.length;for(let r=0;r<n;++r)e[r]=t[r]+i[r];return e}function tS(e,t,i){let n=e.length;for(let r=0;r<n;++r)e[r]=t[r]-i[r];return e}function tw(e){let t=1;for(let i=0,n=e.length;i<n;++i)t*=e[i];return t}let tC=new Float32Array(0),tx=new Float64Array(0);Float64Array.of(1,1,1);let tE=0;function tT(){return++tE}function tk(e,t){return void 0===e?void 0===t:void 0!==t&&e.explicit===t.explicit&&(0,Y.cO)(e.coordinates,t.coordinates)&&(0,Y.cO)(e.labels,t.labels)}function tD(e){if(1===e.length)return e[0];let t=new Map,i=!1;for(let n of e){n.explicit&&(i=!0);let{coordinates:e,labels:r}=n;for(let i=0,n=e.length;i<n;++i)t.set(e[i],r[i])}let n=Array.from(t.keys());n.sort((e,t)=>e-t);let r=Array.from(n,e=>t.get(e));return{explicit:i,coordinates:n,labels:r}}function tP(e){if(0!==(e=e.filter(e=>void 0!==e)).length)return tD(e)}function tL(e,t){var i,n;return(0,Y.cO)(e.transform,t.transform)&&(i=e.box,n=t.box,(0,Y.cO)(i.lowerBounds,n.lowerBounds)&&(0,Y.cO)(i.upperBounds,n.upperBounds))}function tI(e,t){return e.valid===t.valid&&e.rank===t.rank&&(0,Y.cO)(e.names,t.names)&&(0,Y.cO)(e.ids,t.ids)&&(0,Y.cO)(e.timestamps,t.timestamps)&&(0,Y.cO)(e.units,t.units)&&(0,Y.cO)(e.scales,t.scales)&&(0,Y.eK)(e.boundingBoxes,t.boundingBoxes,tL)&&(0,Y.eK)(e.coordinateArrays,t.coordinateArrays,tk)}function tR(e){let{names:t,units:i,scales:n}=e,{valid:r=!0,rank:s=t.length,timestamps:a=t.map(()=>Number.NEGATIVE_INFINITY),ids:o=t.map((e,t)=>-t),boundingBoxes:l=[]}=e,{coordinateArrays:d=Array(s)}=e,{bounds:u=function(e,t){let i=new Float64Array(t),n=new Float64Array(t);i.fill(Number.NEGATIVE_INFINITY),n.fill(Number.POSITIVE_INFINITY);let r=Array(t);r.fill(0);let s=Array(t);for(let a of(s.fill(0),e))for(let e=0;e<t;++e){let o=t$(a,e,t);if(void 0===o)continue;let{lower:l,upper:d}=o;if(Number.isFinite(l)&&Number.isFinite(d)){let t=Math.floor(l),i=Math.floor(d);t===l&&i===d?++s[e]:l-t==.5&&d-i==.5&&++r[e]}i[e]=i[e]===Number.NEGATIVE_INFINITY?l:Math.min(i[e],l),n[e]=n[e]===Number.POSITIVE_INFINITY?d:Math.max(n[e],d)}return{lowerBounds:i,upperBounds:n,voxelCenterAtIntegerCoordinates:s.map((e,t)=>r[t]>0&&0===e)}}(l,s)}=e;return{valid:r,rank:s,names:t,timestamps:a,ids:o,units:i,scales:n,boundingBoxes:l,bounds:u,coordinateArrays:d}}let tA=tR({valid:!1,names:[],units:[],scales:tx,boundingBoxes:[]}),tM=tR({valid:!0,names:[],units:[],scales:tx,boundingBoxes:[]});function tN(e,t=!1){if(void 0===e)return tA;(0,eb.PT)(e);let i=t3(Object.keys(e),t),n=i.length,r=Array(n),s=new Float64Array(n),a=Array(n);for(let t=0;t<n;++t)(0,eb.uq)(e,i[t],e=>{if(Array.isArray(e)){let{unit:i,scale:n}=function(e){let[t,i]=(0,eb.f6)(e,2),n=(0,eb.o7)(t),r=(0,eb.ZE)(i),s=tc.get(r);if(void 0===s)throw Error(`Invalid unit: ${JSON.stringify(r)}`);return{unit:s.unit,scale:ty(n,s.exponent)}}(e);r[t]=i,s[t]=n}else{(0,eb.PT)(e);let i=(0,eb.uq)(e,"coordinates",eb.Qu),n=(0,eb.uq)(e,"labels",eb.zE),o=i.length;if(o!==n.length)throw Error(`Length of coordinates array (${o}) does not match length of labels array (${n.length})`);r[t]="",s[t]=1,a[t]={explicit:!0,...function(e,t){let i=new Map;for(let n=0,r=e.length;n<r;++n)i.set(e[n],t[n]);return(e=Array.from(i.keys())).sort((e,t)=>e-t),t=Array.from(e,e=>i.get(e)),{coordinates:e,labels:t}}(i,n)}}});return tR({valid:!1,names:i,units:r,scales:s,coordinateArrays:a})}function tV(e){let{rank:t}=e;if(0===t)return;let{names:i,units:n,scales:r,coordinateArrays:s}=e,a={};for(let e=0;e<t;++e){let t=i[e],o=s[e];o?.explicit?a[t]={coordinates:Array.from(o.coordinates),labels:o.labels}:a[t]=[r[e],n[e]]}return a}class tO extends Z.SN{constructor(){super(tA)}toJSON(){return tV(this.value)}reset(){this.value=tA}restoreState(e){this.value=tN(e)}}function t_(e,t){let i=e.lowerBounds[t],n=e.upperBounds[t];return e.voxelCenterAtIntegerCoordinates[t]&&(i+=.5,n+=.5),[i,n]}function tF(e,t,i){var n,r,s;return i=function(e,t,i){let n=e.upperBounds[t];Number.isFinite(n)&&(i=Math.min(i,n-1));let r=e.lowerBounds[t];return Number.isFinite(r)&&(i=Math.max(i,r)),i}(e,t,i),n=e,r=t,s=i,s=n.voxelCenterAtIntegerCoordinates[r]?Math.round(s):Math.floor(s)+.5}function tB(e,t){let i=(e+t)/2;return!Number.isFinite(i)&&(i=Math.min(Math.max(0,e),t)),i}function tU(e){let t=e.lowerBounds.length;return{box:e,transform:to.XD(Float64Array,t,t+1)}}function t$(e,t,i){let{box:{lowerBounds:n,upperBounds:r},transform:s}=e,a=n.length,o=s[i*a+t],l=o,d=o,u=!1;for(let e=0;e<a;++e){let a=s[i*e+t];if(0===a)continue;let o=a*n[e],c=a*r[e];l+=Math.min(o,c),d+=Math.max(o,c),u=!0}if(u)return{lower:l,upper:d}}function tG(e,t){let i={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},n=new Float64Array(2*e);return n[t]=1,{transform:n,box:i}}function tz(e,t,i){if(t===i)return e;let{box:n}=e,r=n.lowerBounds.length,s=new Float64Array((r+1)*i);return to.JG(s,i,e.transform,t,t,r+1),{box:n,transform:s}}function tj(e){return{rank:e.rank,sourceRank:e.rank,inputSpace:e,outputSpace:e,transform:to.XD(Float64Array,e.rank+1)}}function tW(e,t,i){return e.boundingBoxes.map(n=>(function(e,t,i,n){let{transform:r,box:s}=e,a=e.box.lowerBounds.length,o=n.length,l=new Float64Array((a+1)*o);for(let e=0;e<o;++e){let s=n[e];for(let n=0;n<a;++n){let a=0;for(let l=0;l<o;++l){let d=i[l];a+=t[(o+1)*l+e]*r[o*n+l]*(d/s)}l[o*n+e]=a}let d=t[(o+1)*o+e];for(let n=0;n<o;++n){let l=i[n];d+=t[(o+1)*n+e]*r[o*a+n]*(l/s)}l[a*o+e]=d}return{transform:l,box:s}})(n,t,e.scales,i))}function tq(e,t,i){let n=tR({valid:e.valid,rank:i.rank,ids:i.ids,names:i.names,timestamps:i.timestamps,scales:i.scales,units:i.units,boundingBoxes:tW(e,t,i.scales),coordinateArrays:i.coordinateArrays});return tI(n,i)?i:n}function tH(e,t=!1){if(t){let t=Number(e);if(Number.isInteger(t)&&t>=0)return!0}return null!==e.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)}function tJ(e,t=!1){let i=new Set;for(let n of e){if(!tH(n,t)||i.has(n))return!1;i.add(n)}return!0}function tK(e){let t=e.length,i=Array(t);i.fill(!0);for(let n=0;n<t;++n){let t=e[n];if(!tH(t)){i[n]=!1;continue}let r=e.indexOf(t,n+1);-1!==r&&(i[n]=!1,i[r]=!1)}return i}function tZ(e){return e.endsWith("'")}function tY(e){return e.endsWith("'")||e.endsWith("^")}function tX(e){return e.endsWith("^")}function tQ(e){return!tY(e)}function t0(e,t,i,n,r,s){if(!to.Dg(e,t+1,n,r+1,t,t))return!1;for(let a=0;a<t;++a){let o=e[(t+1)*t+a],l=n[(r+1)*r+a];if(o*(i[a]/s[a])!==l)return!1}for(let e=t;e<r;++e)if(0!==n[(r+1)*r+e])return!1;for(let e=t;e<r;++e){for(let i=0;i<t;++i)if(0!==n[(r+1)*i+e])return!1;for(let t=0;t<r;++t){let i=n[(r+1)*e+t];if(e===t){if(1!==i)return!1}else if(0!==i)return!1}}return!0}function t1(e){let t=tq(e.inputSpace,e.transform,e.outputSpace);return t===e.outputSpace?e:{rank:e.rank,sourceRank:e.sourceRank,inputSpace:e.inputSpace,transform:e.transform,outputSpace:t}}class t2{mutableSourceRank;value_;outputSpace;inputSpace;changed;inputSpaceChanged;defaultTransform;constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new ez.K_,this.inputSpaceChanged=new ez.K_,this.defaultTransform=t1(e);let i=this;this.outputSpace={changed:i.changed,get value(){return i.value.outputSpace},set value(newOutputSpace){let{value:e}=i;if(tI(e.outputSpace,newOutputSpace)||e.rank!==newOutputSpace.rank)return;let t=function(e,t,i){let n=new Float64Array(e),r=t.length,s=(r+1)*r;for(let e=0;e<r;++e)n[s+e]*=t[e]/i[e];return n}(e.transform,e.outputSpace.scales,newOutputSpace.scales);i.value_={sourceRank:e.sourceRank,rank:e.rank,inputSpace:e.inputSpace,outputSpace:tq(e.inputSpace,t,newOutputSpace),transform:t},i.changed.dispatch()}},this.inputSpace={changed:i.inputSpaceChanged,get value(){return i.value.inputSpace},set value(newInputSpace){let{value:e}=i;if(tI(e.inputSpace,newInputSpace))return;i.value_=function(e,t){let{inputSpace:i,transform:n}=e,{ids:r,rank:s}=i,{rank:a,names:o,units:l,scales:d}=t,u=Array(s);u.fill(!0);let c=[],h=t.ids.map((e,t)=>{let i=r.indexOf(e);return -1!==i?u[i]=!1:c.push(t),i}),{outputSpace:p}=e,{names:g,units:m,scales:f,ids:v,timestamps:y,coordinateArrays:b}=p,S=[],w=[],C=new Float64Array(a),x=[],E=[],T=Array(a),k=0,D=new Float64Array((a+1)**2);D[D.length-1]=1;for(let e=0;e<s;++e)if(!u[e]){S[k]=g[e],x[k]=v[e],w[k]=m[e],C[k]=f[e],E[k]=y[e],T[k]=b[e];for(let t=0;t<a;++t){let i=h[t];-1!==i&&(D[t*(a+1)+k]=n[i*(s+1)+e])}D[a*(a+1)+k]=n[s*(s+1)+e],++k}for(let e of c)x[k]=++tE,S[k]=function(e,t){if(!t.includes(e))return e;let[,i,n]=e.match(/^([^']*)('?)$/);for(let e=0;;++e){let r=`${i}${e}${n}`;if(!t.includes(r))return r}}(o[e],S),C[k]=d[e],w[k]=l[e],D[e*(a+1)+k]=1,++k;let P=tR({valid:t.valid,rank:a,names:S,ids:x,timestamps:E,units:w,scales:C,boundingBoxes:tW(t,D,C),coordinateArrays:T});return{rank:a,sourceRank:e.sourceRank,inputSpace:t,outputSpace:P,transform:D}}(e,newInputSpace),i.inputSpaceChanged.dispatch(),i.changed.dispatch()}}}set value(e){let t=this.value;e!==t&&(this.value_=t1(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return void 0===e&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:i,inputSpace:n,outputSpace:r,sourceRank:s}=e,{defaultTransform:a,mutableSourceRank:o}=this,{inputSpace:l,rank:d,transform:u,outputSpace:c}=a,{units:h,scales:p}=n,g=s===t&&(0,Y.cO)(p,o?r.scales:l.scales)&&(0,Y.cO)(h,o?r.units:l.units),m=t0(u,d,c.scales,i,t,r.scales),f=(0,Y.cO)(c.names,r.names);if(!m||!f||!g)return{sourceRank:s,transform:m?void 0:i,outputSpace:e.outputSpace,inputSpace:g?void 0:n}}set transform(e){let{value:t}=this,{inputSpace:i}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:i,transform:e,outputSpace:tq(i,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(void 0===e){this.reset();return}if(this.mutableSourceRank){let t=e.inputSpace||e.outputSpace,i=t.rank,n=tR({rank:i,names:t.names.map((e,t)=>`${t}`),units:t.units,scales:t.scales,coordinateArrays:t.coordinateArrays});this.value={rank:i,transform:e.transform||to.XD(Float64Array,i+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:n};return}let{inputSpace:t,sourceRank:i,outputSpace:n,transform:r,rank:s}=this.defaultTransform,{inputSpace:a,sourceRank:o,outputSpace:l,transform:d}=e,u=e.outputSpace.rank,c=t.names,h=void 0!==a?a.names:c,p=Array(i);for(let e=0;e<i;++e){let t=h.indexOf(c[e]);t>=o&&(t=-1),p[e]=t}let g=u-o+i;for(let e=o;e<u;++e)p[i+e-o]=e;let m=new Float64Array(g),f=Array(g),v=[];for(let e=0;e<i;++e){let i=p[e];-1===i||void 0===a?(m[e]=t.scales[e],v[e]=t.units[e],f[e]=t.coordinateArrays[e]):(m[e]=a.scales[i],v[e]=a.units[i],f[e]=tP([t.coordinateArrays[e],a.coordinateArrays[i]]))}let y=a||l,b=c.slice(0,i),S=n.names.slice(0,i),w=n.coordinateArrays.slice(0,i),C=new Float64Array(g),x=[];for(let e=0;e<g;++e){let t=p[e];-1===t?(C[e]=n.scales[e],x[e]=n.units[e],w[e]=n.coordinateArrays[e]):(S[e]=l.names[t],x[e]=l.units[t],C[e]=l.scales[t],w[e]=l.coordinateArrays[t])}if(!tJ(S)){this.reset();return}for(let e=i;e<g;++e){let t=e-i+o;m[e]=y.scales[t],v[e]=y.units[t],b[e]=`${e}`}let E=new Float64Array((g+1)**2);E[E.length-1]=1;for(let e=0;e<g;++e){let t;let a=p[e];t=-1===a||void 0===d?e>=i?0:r[s*(s+1)+e]*(n.scales[e]/C[e]):d[u*(u+1)+a],E[g*(g+1)+e]=t;for(let t=0;t<g;++t){let n;let o=p[t];n=-1===a!=(-1===o)?0:-1===a||void 0===d?a>=i||o>=i?a===o?1:0:r[t*(s+1)+e]:d[o*(u+1)+a],E[t*(g+1)+e]=n}}let T=t.boundingBoxes.map(e=>tz(e,s,g));for(let e=i;e<g;++e)T.push(tG(g,e));for(let e=0;e<g;++e){let t;if(0!==E[g*(g+1)+e])continue;for(let i=0;i<g;++i){let n=E[i*(g+1)+e];if(0!==n){if(1===n){if(void 0===t)t=i;else{t=null;break}}else{t=null;break}}}if(null==t)continue;let i=f[t];void 0!==i&&(i.explicit&&(i={...i,explicit:!1}),w[e]=tP([i,w[e]]))}this.value={rank:g,transform:E,sourceRank:i,outputSpace:tR({rank:g,names:S,scales:C,units:x,coordinateArrays:w}),inputSpace:tR({rank:g,names:b,scales:m,units:v,coordinateArrays:f,boundingBoxes:T})}}toJSON(){return t7(this.spec)}restoreState(e){this.spec=t8(e)}}function t3(e,t=!1){let i=(0,eb.m7)(e,e=>(function(e,t=!1){let i=(0,eb.ZE)(e);if(!tH(i,t))throw Error(`Invalid dimension name: ${JSON.stringify(i)}`);return i})(e,t));if(!tJ(i,t))throw Error(`Invalid dimensions: ${JSON.stringify(i)}`);return i}class t4{combined;bindings;retainCount;prevCombined;dimensionRefCounts;getRenameValidity(e){let t=this.combined.value.names,i=tK(e),n=e.length;for(let r=0;r<n;++r){if(!i[r])continue;let n=e[r];if(t.includes(n))continue;let s=!0;for(let e of this.bindings)if(e.space.value.names.includes(n)){s=!1;break}i[r]=s}return i}includeDimensionPredicate_;get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}constructor(e,t){this.combined=e,this.bindings=new Set,this.retainCount=0,this.dimensionRefCounts=new Map,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t,this.prevCombined=this.combined.value}update(){let{combined:e,bindings:t}=this,i=this.retainCount>0?1:0;if(0===t.size&&!i){e.value=tA;return}let n=this.includeDimensionPredicate_,r=e.value,s=Array.from(r.names),a=Array.from(r.units),o=Array.from(r.scales),l=Array.from(r.ids),d=Array.from(r.timestamps),u=r.names.map(()=>i?1:0),c=[],h=!1;for(let e of t){let{space:{value:t},prevValue:r,mappedDimensionIds:p}=e;h=h||t.valid;let{names:g,units:m,scales:f,ids:v,timestamps:y}=t,b=[],S=[];c.push(S),e.mappedDimensionIds=b,e.prevValue=t;let w=g.length;for(let e=0;e<w;++e){let t=g[e];if(!n(t))continue;if(void 0!==r){let i=v[e],n=r.ids.indexOf(i);if(-1!==n){let i=p[n];if(void 0!==i){let n=l.indexOf(i);if(-1!==n){b[e]=i,++u[n],S[e]=n;let r=y[e];void 0!==r&&!(r<=d[n])&&(s[n]=t,o[n]=f[e],a[n]=m[e],d[n]=r);continue}}}}let c=s.indexOf(t);if(-1!==c){b[e]=l[c],++u[c],S[e]=c;continue}c=s.length,S[e]=c,u[c]=1+i,s[c]=t,a[c]=m[e],o[c]=f[e],d[c]=y[e];let h=++tE;l[c]=h,b[e]=h}}let{dimensionRefCounts:p}=this;p.clear();let g=0,m=s.length;for(let e of t){let{space:{value:t}}=e,i=c[g++],{rank:n}=t,r=Array.from(t.names),l=Array.from(t.timestamps),u=Float64Array.from(t.scales),h=Array.from(t.units);for(let e=0;e<n;++e){let t=i[e];void 0!==t&&(h[e]=a[t],u[e]=o[t],l[e]=d[t],r[e]=s[t])}for(let e of r){let t=p.get(e);void 0===t?t=1:++t,p.set(e,t)}if(!(0,Y.cO)(h,t.units)||!(0,Y.cO)(u,t.scales)||!(0,Y.cO)(r,t.names)||!(0,Y.cO)(l,t.timestamps)){let i=tR({valid:t.valid,ids:t.ids,scales:u,units:h,names:r,timestamps:l,boundingBoxes:t.boundingBoxes,coordinateArrays:t.coordinateArrays});e.prevValue=i,e.space.value=i}}{for(let e=0;e<m;++e)!n(s[e])&&(u[e]=0);let e=(e,t)=>0!==u[t];s=s.filter(e),a=a.filter(e),o=o.filter(e),l=l.filter(e),d=d.filter(e),u=u.filter(e),m=s.length}let f=[],v=Array(m);for(let e=0,t=r.rank;e<t;++e){let t=r.coordinateArrays[e];if(!t?.explicit)continue;let i=l.indexOf(r.ids[e]);-1!==i&&(v[i]=[t])}for(let e of t){let{space:{value:t}}=e,{rank:i,boundingBoxes:n,coordinateArrays:r}=t,a=t.names.map(e=>s.indexOf(e));for(let e of n)f.push(function(e,t,i){let{transform:n,box:r}=e,s=i.length,a=r.lowerBounds.length,o=new Float64Array((a+1)*t);for(let e=0;e<s;++e){let r=i[e];if(-1!==r)for(let i=0;i<=a;++i)o[i*t+r]=n[i*s+e]}return{transform:o,box:r}}(e,m,a));for(let e=0;e<i;++e){let t=r[e];if(void 0===t)continue;let i=a[e],n=v[i];void 0===n?v[i]=[t]:n.push(t)}}let y=Array(m);for(let e=0;e<m;++e){let t=v[e];void 0!==t&&(y[e]=tD(t))}let b=tR({valid:h,ids:l,names:s,units:a,scales:new Float64Array(o),boundingBoxes:f,coordinateArrays:y});if(i)for(let e=0;e<m;++e)--u[e];!tI(r,b)&&(this.prevCombined=b,e.value=b)}handleCombinedChanged;retain(){return++this.retainCount,()=>{0==--this.retainCount&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:i}=this;0===i.size&&this.combined.changed.add(this.handleCombinedChanged),i.add(t);let n=e.changed.add(()=>{e.value!==t.prevValue&&this.update()});return this.update(),()=>{n();let{bindings:e}=this;e.delete(t),0===e.size&&this.combined.changed.remove(this.handleCombinedChanged),this.update()}}}function t6(e,t,i,n,r){let s=r.length,a=new e((s+1)**2);a[a.length-1]=1;for(let e=0;e<s;++e){let o=n[e];a[(s+1)*s+e]=t[(i+1)*i+o];for(let n=0;n<s;++n){let l=r[n];a[(s+1)*n+e]=t[(i+1)*l+o]}}return a}function t5(e){if(void 0===e)return;let t=new Float64Array(16);if(Array.isArray(e)){if(16===e.length)for(let i=0;i<4;++i)for(let n=0;n<4;++n)t[4*i+n]=(0,eb.jz)(e[4*n+i]);else{(0,eb.f6)(e,4);for(let i=0;i<4;++i){let n=(0,eb.f6)(e[i],4);for(let e=0;e<4;++e)t[4*e+i]=(0,eb.jz)(n[e])}}}else{(0,eb.PT)(e);let i=Q.gf.create(),n=Q.R3.create(),r=Q.R3.fromValues(1,1,1);(0,eb.Kh)(e,"rotation",e=>{(0,eb._b)(i,e),Q.gf.normalize(i,i)}),(0,eb.Kh)(e,"translation",e=>{(0,eb._b)(n,e)}),(0,eb.Kh)(e,"scale",e=>{(0,eb._b)(r,e)});let s=Q._E.create();Q._E.fromRotationTranslationScale(s,i,n,r),t.set(s)}return{sourceRank:3,transform:t,outputSpace:tR({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function t8(e){if(void 0===e)return;let t=(0,eb.PT)(e),i=(0,eb.uq)(t,"outputDimensions",tN),n=i.rank,r=(0,eb.uq)(t,"sourceRank",e=>{if(void 0===e)return n;if(!Number.isInteger(e)||e<0||e>n)throw Error(`Expected integer in range [0, ${n}] but received: ${JSON.stringify(e)}`);return e}),s=(0,eb.Kh)(t,"inputDimensions",e=>{let t=tN(e,!0);if(t.rank!==n)throw Error(`Expected rank of ${n}, but received rank of: ${t.rank}`);return t});return{transform:(0,eb.Kh)(t,"matrix",e=>{let t=new Float64Array((n+1)**2),i=(0,eb.f6)(e,n);t[t.length-1]=1;for(let e=0;e<n;++e)try{let r=(0,eb.f6)(i[e],n+1);for(let i=0;i<=n;++i)t[(n+1)*i+e]=(0,eb.jz)(r[i])}catch(t){throw Error(`Error in row ${e}: ${t.message}`)}return t}),outputSpace:i,inputSpace:s,sourceRank:r}}function t7(e){let t;if(void 0===e)return;let{transform:i,outputSpace:n,inputSpace:r,sourceRank:s}=e,a=n.rank;if(void 0!==i){t=[];for(let e=0;e<a;++e){let n=[];t[e]=n;for(let t=0;t<=a;++t)n[t]=i[(a+1)*t+e]}}return{sourceRank:s===a?void 0:s,matrix:t,outputDimensions:tV(n),inputDimensions:void 0===r?void 0:tV(r)}}function t9(e,t){let{ids:i,names:n,scales:r,units:s,timestamps:a,coordinateArrays:o}=e;return tR({rank:t.length,valid:e.valid,ids:t.map(e=>i[e]),names:t.map(e=>n[e]),timestamps:t.map(e=>a[e]),scales:Float64Array.from(t,e=>r[e]),units:t.map(e=>s[e]),coordinateArrays:t.map(e=>o[e]),boundingBoxes:e.boundingBoxes.map(i=>(function(e,t,i){let{box:n,transform:r}=e,s=e.box.lowerBounds.length,a=t.length,o=new Float64Array((s+1)*a);if(to.pb(o,a,r,i,t,s+1),!o.every(e=>0===e))return{transform:o,box:n}})(i,t,e.rank)).filter(e=>void 0!==e)})}function ie(e,t,i){return t===i?e:t9(e,(0,Y.BP)(e.rank,i,t))}function it(e,t){let{transform:i,rank:n}=e,r=(0,Q.Mz)(i,n,[t]);if(1!==r.length)return;let[s]=r,a=Math.abs(i[(n+1)*s+t]),{inputSpace:o}=e;return{scale:o.scales[s]*a,unit:o.units[s]}}function ii(e,t){let{scales:i,units:n}=e.defaultInputSpace;return t<i.length?{scale:i[t],unit:n[t]}:void 0}new Uint32Array(0),new Uint32Array(0);function ir(e,t,i,n,r,s){let{scales:a}=i,{scales:o,rank:l}=r,d=t+1;for(let i=0;i<l;++i){let r=s[i];if(-1===r)continue;let l=o[i];for(let i=0;i<t;++i){let t=a[n[i]];e[d*i+r]*=t/l}}}function is(e,t){return e===t||void 0===e.error&&void 0===t.error&&(0,Y.cO)(e.modelDimensionNames,t.modelDimensionNames)&&(0,Y.cO)(e.layerDimensionNames,t.layerDimensionNames)&&(0,Y.cO)(e.globalToRenderLayerDimensions,t.globalToRenderLayerDimensions)&&(0,Y.cO)(e.localToRenderLayerDimensions,t.localToRenderLayerDimensions)&&(0,Y.cO)(e.channelToRenderLayerDimensions,t.channelToRenderLayerDimensions)&&(0,Y.cO)(e.modelToRenderLayerTransform,t.modelToRenderLayerTransform)&&(0,Y.cO)(e.channelSpaceShape,t.channelSpaceShape)}function ia(e,t,i,n,r){return(0,Z.mo)((e,t,i,r)=>(function(e,t,i,n,r=tM){let s;let{inputSpace:a,rank:o,sourceRank:l,outputSpace:d,transform:u}=i,{names:c}=a,{names:h}=d;if(void 0!==n)s=Array.from(n.modelSubspaceDimensionIndices);else{s=[];for(let e=0;e<l;++e)s[e]=e}let p=s.length;for(let e=l;e<o;++e)s.push(e);let g=(0,Q.Mz)(i.transform,o,s,!0),m=s.length,f=s.map(e=>c[e]||`${e}`),v=g.map(e=>h[e]);if(m!==g.length)return{error:"Rank mismatch between model subspace dimensions ("+f.join(", ")+") and corresponding layer/global dimensions ("+v.join(", ")+")"};let y=t6(Float32Array,u,o,g,s),b=g.map(e=>h[e]),S=t.names.map(e=>b.indexOf(e)),w=e.names.map(e=>b.indexOf(e));ir(y,m,a,s,e,w),ir(y,m,a,s,t,S);let C=r.names.map(e=>b.indexOf(e));ir(y,m,a,s,r,C);let x=[],E=r.rank;if(void 0!==n){let{subsourceToModelSubspaceTransform:e}=n;p!==m&&(e=to.w9(new Float32Array((m+1)**2),m,e,p)),y=to.Jp(new Float32Array((m+1)**2),m+1,y,m+1,e,m+1,m+1,m+1,m+1)}let T=new Uint32Array(E),{lowerBounds:k,upperBounds:D,voxelCenterAtIntegerCoordinates:P}=r.bounds;for(let e=0;e<E;++e){let t=k[e],i=D[e];if(P[e]&&(t+=.5,i+=.5),0!==t||!Number.isInteger(i)||i<=0||i>=0x100000000)return{error:`Channel dimension ${r.names[e]} must have lower bound of 0 and positive integer upper bound; current bounds are [${t}, ${i}]`};T[e]=i;let n=C[e],s=-1;if(-1!==n)for(let e=0;e<m;++e){let t=y[n+e*(m+1)];if(0!==t){if(1!==t||-1!==s)return{error:`Channel dimension ${v[n]} must map to a single source dimension`};s=e}}x[e]=s}return{rank:m,unpaddedRank:p,modelDimensionNames:f,layerDimensionNames:v,localToRenderLayerDimensions:S,globalToRenderLayerDimensions:w,channelToRenderLayerDimensions:C,modelToRenderLayerTransform:y,channelToModelDimensions:x,channelSpaceShape:T}})(e,t,i,n,r),[e,t,i,void 0===r?(0,Z.ne)(void 0):r],is)}function io(e,t){let i;let n=e.rank,r=e.unpaddedRank;r!==n&&void 0!==t&&(t=to.w9(new Float32Array((n+1)**2),n,t,r)),void 0!==t?(i=new Float32Array((n+1)*(n+1)),to.Jp(i,n+1,e.modelToRenderLayerTransform,n+1,t,n+1,n+1,n+1,n+1)):i=e.modelToRenderLayerTransform;let s=new Float32Array((n+1)*(n+1)),a=to.SO(s,n+1,i,n+1,n+1);if(0===a)throw Error("Transform is singular");let{globalToRenderLayerDimensions:o,localToRenderLayerDimensions:l,channelToRenderLayerDimensions:d}=e,u=o.length,c=l.length,h=u+c,p=new Float32Array((h+1)*n);for(let e=0;e<n;++e){for(let t=0;t<u;++t){let i=o[t];-1!==i&&(p[e+t*n]=s[e+i*(n+1)])}for(let t=0;t<c;++t){let i=l[t];-1!==i&&(p[e+(u+t)*n]=s[e+i*(n+1)])}p[e+h*n]=s[e+n*(n+1)]}let g=d.length,m=Array(g),f=[];for(let t=0;t<g;++t){let r=d[t],s=-1;if(-1!==r){for(let t=0;t<n;++t){let a=i[r+t*(n+1)];if(0!==a){if(1!==a||-1!==s)throw Error(`Channel dimension ${e.layerDimensionNames[r]} must map with stride 1 to a single data chunk dimensions`);s=t}}if(-1!==s){let t=i[r+n*(n+1)];if(0!==t&&-.5!==t)throw Error(`Channel dimension ${e.layerDimensionNames[r]} must have an offset of 0 in the chunk coordinate space; current offset is ${t}`);f.push(s)}}m[t]=s}let{channelSpaceShape:v}=e,y=tw(v),b=f.length,S=new Uint32Array(y*b);for(let e=0;e<y;++e){let t=e,i=0;for(let n=0;n<g;++n){let r=t%v[n];t=(t-r)/v[n],-1!==m[n]&&(S[e*b+i]=r,++i)}}return{layerRank:n,modelTransform:e,chunkToLayerTransform:i,layerToChunkTransform:s,chunkToLayerTransformDet:a,combinedGlobalLocalRank:h,combinedGlobalLocalToChunkTransform:p,channelToChunkDimensionIndices:m,chunkChannelDimensionIndices:f,numChannels:y,chunkChannelCoordinates:S,channelSpaceShape:v}}function il(e,t){let{globalToRenderLayerDimensions:i}=e,n=[],r=[];for(let e=0;e<3;++e){let s=t[e];if(-1===s)continue;let a=i[s];r.push(a),-1!==a&&n.push(a)}for(let e=r.length;e<3;++e)r[e]=-1;return{layerDisplayDimensionIndices:n,displayToLayerDimensionIndices:r}}function id(e,t){let{chunkToLayerTransform:i,modelTransform:n}=e,r=n.rank,{layerDisplayDimensionIndices:s,displayToLayerDimensionIndices:a}=t,o=s.length,l=(0,Q.Mz)(i,r,s);if(l.length!==o){let{modelDimensionNames:e,layerDimensionNames:t}=n;throw Error(`Rank mismatch between displayed layer dimensions (${Array.from(s,e=>t[e]).join(",\xa0")}) and corresponding chunk dimensions (${Array.from(l,t=>e[t]).join(",\xa0")})`)}let d=Q._E.create();for(let e=0;e<3;++e){let t=a[e];if(-1!==t){for(let n=0;n<o;++n){let s=l[n];d[4*n+e]=i[s*(r+1)+t]}d[12+e]=i[r*(r+1)+t]}}let u=Q._E.create();Q._E.invert(u,d);for(let e=l.length;e<3;++e)l[e]=-1;return{modelTransform:e.modelTransform,chunkTransform:e,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:u,chunkDisplayDimensionIndices:l,numChunkDisplayDims:o}}function iu(e,t,i,n,r){let s=t.length,a=i.length,o=e.length,l=!0;for(let d=0;d<n;++d){let u=d,c=0;for(let e=0;e<s;++e)c+=r[u+e*n]*t[e];u+=s*n;for(let e=0;e<a;++e)c+=r[u+e*n]*i[e];c+=r[u+a*n],d<o?e[d]=c:(c<0||c>=1)&&(l=!1)}return l}var ic=i("2902");var ih=((S={})[S.GPU_MEMORY=0]="GPU_MEMORY",S[S.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",S[S.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",S[S.DOWNLOADING=3]="DOWNLOADING",S[S.QUEUED=4]="QUEUED",S[S.NEW=5]="NEW",S[S.FAILED=6]="FAILED",S[S.EXPIRED=7]="EXPIRED",S);var ip=((w={})[w.FIRST_TIER=0]="FIRST_TIER",w[w.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",w[w.VISIBLE=0]="VISIBLE",w[w.PREFETCH=1]="PREFETCH",w[w.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",w[w.RECENT=2]="RECENT",w[w.LAST_TIER=2]="LAST_TIER",w);var ig=((C={})[C.totalTime=0]="totalTime",C[C.totalChunks=1]="totalChunks",C);var im=((x={})[x.numChunks=0]="numChunks",x[x.systemMemoryBytes=1]="systemMemoryBytes",x[x.gpuMemoryBytes=2]="gpuMemoryBytes",x);function iv(e,t){return 3*e+t}function iy(e){return 72+e}class ib{numVisibleChunksNeeded=0;numVisibleChunksAvailable=0;numPrefetchChunksNeeded=0;numPrefetchChunksAvailable=0}var iS=i("5901");var iw=((E={})[E.MEDIAN=0]="MEDIAN",E[E.MEAN=1]="MEAN",E[E.MAX=2]="MAX",E);class iC{numStoredTimes;queryPoolSize;timeElapsedQueries;warnedAboutMissingExtension;storedTimeDeltas;constructor(e=10,t=10){if(this.numStoredTimes=e,this.queryPoolSize=t,this.timeElapsedQueries=[],this.warnedAboutMissingExtension=!1,this.storedTimeDeltas=[],this.queryPoolSize<1)throw Error(`Query pool size must be at least 1, but got ${t}.`)}getTimingExtension(e){let t=e.getExtension("EXT_disjoint_timer_query_webgl2");return null===t&&!this.warnedAboutMissingExtension&&(console.log("EXT_disjoint_timer_query_webgl2 extension not available. Cannot measure frame time."),this.warnedAboutMissingExtension=!0),t}getOldestQueryIndexByFrameNumber(){if(0===this.timeElapsedQueries.length)return;let e=0;for(let t=1;t<this.timeElapsedQueries.length;t++){let i=this.timeElapsedQueries[e];this.timeElapsedQueries[t].frameNumber<i.frameNumber&&(e=t)}return e}startFrameTimeQuery(e,t,i){if(null===t)return null;let n=e.createQuery(),r=this.timeElapsedQueries[this.timeElapsedQueries.length-1];if(null!==n&&r!==n){if(e.beginQuery(t.TIME_ELAPSED_EXT,n),this.timeElapsedQueries.length>=this.queryPoolSize){let t=this.getOldestQueryIndexByFrameNumber();if(void 0!==t){let i=this.timeElapsedQueries.splice(t,1)[0];e.deleteQuery(i.glQuery)}}this.timeElapsedQueries.push({glQuery:n,frameNumber:i,wasStarted:!0,wasEnded:!1})}return n}endLastTimeQuery(e,t){if(null!==t){let i=this.timeElapsedQueries[this.timeElapsedQueries.length-1];!i.wasEnded&&i.wasStarted&&(e.endQuery(t.TIME_ELAPSED_EXT),i.wasEnded=!0)}}grabAnyFinishedQueryResults(e){let t=[];for(let i=0;i<this.timeElapsedQueries.length;i++){let n=this.timeElapsedQueries[i];if(n.wasEnded&&n.wasStarted){let r=e.getQueryParameter(n.glQuery,e.QUERY_RESULT_AVAILABLE);if(null===r)e.deleteQuery(n.glQuery),t.push(i);else if(r){let r=e.getQueryParameter(n.glQuery,e.QUERY_RESULT)/1e6;this.storedTimeDeltas.push({frameDelta:r,frameNumber:n.frameNumber}),e.deleteQuery(n.glQuery),t.push(i)}}else e.deleteQuery(n.glQuery),t.push(i)}this.timeElapsedQueries=this.timeElapsedQueries.filter((e,i)=>!t.includes(i)),this.storedTimeDeltas.length>this.numStoredTimes&&(this.storedTimeDeltas=this.storedTimeDeltas.slice(-this.numStoredTimes))}getLastFrameTimesInMs(e=10){return this.storedTimeDeltas.slice(-e).map(e=>e.frameDelta)}getQueries(){return this.timeElapsedQueries}}class ix{numberOfStoredFrameDeltas;maxDownsamplingFactor;desiredFrameTimingMs;downsamplingPersistenceDurationInFrames;lastFrameTime;frameDeltas;downsamplingRates;frameCount;constructor(e=10,t=8,i=1e3/60,n=15){this.numberOfStoredFrameDeltas=e,this.maxDownsamplingFactor=t,this.desiredFrameTimingMs=i,this.downsamplingPersistenceDurationInFrames=n,this.lastFrameTime=null,this.frameDeltas=[],this.downsamplingRates=new Map,this.frameCount=0,this.validateConstructorArguments();for(let e=1;e<=this.maxDownsamplingFactor;e*=2)this.downsamplingRates.set(e,-1/0)}validateConstructorArguments(){this.numberOfStoredFrameDeltas=Math.max(1,Math.round(this.numberOfStoredFrameDeltas)),this.maxDownsamplingFactor=Math.max(2,Math.round(this.maxDownsamplingFactor))}storeFrameDelta(e){this.frameDeltas.push(e),this.frameDeltas.length>this.numberOfStoredFrameDeltas&&this.frameDeltas.shift()}calculateMeanFrameTime(){return this.frameDeltas.reduce((e,t)=>e+t,0)/this.frameDeltas.length}calculateMedianFrameTime(){let e=this.frameDeltas.slice().sort((e,t)=>e-t),t=Math.floor(e.length/2);return e.length%2==1?e[t]:(e[t-1]+e[t])/2}calculateMaxFrameTime(){return Math.max(...this.frameDeltas)}updateMaxTrackedDownsamplingRate(e){this.downsamplingRates.set(e,this.frameCount);let t=1;for(let[e,i]of this.downsamplingRates)this.frameCount-i<=this.downsamplingPersistenceDurationInFrames&&(t=e);return t}resetForNewFrameSet(){this.lastFrameTime=null,this.frameCount=0,this.downsamplingRates.forEach((e,t)=>{this.downsamplingRates.set(t,-1/0)})}addFrame(e=Date.now()){if(null!==this.lastFrameTime){let t=e-this.lastFrameTime;t>0&&this.storeFrameDelta(t)}this.lastFrameTime=e,this.frameCount++}calculateFrameTimeInMs(e=2){if(0===this.frameDeltas.length)return 0;switch(e){case 0:return this.calculateMedianFrameTime();case 1:return this.calculateMeanFrameTime();case 2:return this.calculateMaxFrameTime()}}calculateDownsamplingRate(e=1){let t=this.calculateFrameTimeInMs(e);if(0===t)return Math.min(4,this.maxDownsamplingFactor);let i=Math.max(t/this.desiredFrameTimingMs,1);return i=Math.min(Math.pow(2,Math.round(Math.log2(i))),this.maxDownsamplingFactor),this.updateMaxTrackedDownsamplingRate(i)}getFrameDeltas(){return this.frameDeltas}getFrameCount(){return this.frameCount}getDownsamplingRates(){return this.downsamplingRates}setFrameDeltas(e,t=!0){this.frameDeltas=e.slice(-this.numberOfStoredFrameDeltas),t&&this.frameCount++}}var iE=i("9652");class iT{width=0;height=0;logicalWidth=0;logicalHeight=0;visibleLeftFraction=0;visibleTopFraction=0;visibleWidthFraction=0;visibleHeightFraction=0}function ik(e,t){let i=1/e.visibleWidthFraction,n=1/e.visibleHeightFraction,r=-1-(-1+2*e.visibleLeftFraction)*i,s=-1-(-1+2*e.visibleTopFraction)*n;s=-s,t[0]=t[0]*i+t[3]*r,t[4]=t[4]*i+t[7]*r,t[8]=t[8]*i+t[11]*r,t[12]=t[12]*i+t[15]*r,t[1]=t[1]*n+t[3]*s,t[5]=t[5]*n+t[7]*s,t[9]=t[9]*n+t[11]*s,t[13]=t[13]*n+t[15]*s}function iD(e,t){return e.width===t.width&&e.height===t.height&&e.logicalWidth===t.logicalWidth&&e.logicalHeight===t.logicalHeight&&e.visibleLeftFraction===t.visibleLeftFraction&&e.visibleTopFraction===t.visibleTopFraction}class iP extends ef.gj{context;element;visibility;gl;boundsGeneration;canvasRelativeClippedLeft;canvasRelativeClippedTop;canvasRelativeLogicalLeft;canvasRelativeLogicalTop;renderViewport;monitorState;constructor(e,t,i){super(),this.context=e,this.element=t,this.visibility=i,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new iT,this.monitorState={isIntersecting:!0},this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:i}=this,n=i.getBoundingClientRect();e.ensureMonitorPanel(i,this.monitorState,n);let r=e.container,s=e.canvasRect,{canvas:a}=e,{width:o,height:l}=a,d=o/s.width,u=l/s.height,c=s.left,h=s.top,p=this.canvasRelativeLogicalLeft=Math.round((n.left-c)*d+i.clientLeft),g=this.canvasRelativeLogicalTop=Math.round((n.top-h)*u+i.clientTop),m=i.clientWidth,f=i.clientHeight,v=p+m,y=g+f,b=g,S=p,w=v,C=y;for(let e=i.parentElement;null!==e&&e!==r;e=e.parentElement){let t=e.getBoundingClientRect();if(0!==t.x||0!==t.y||0!==t.width||0!==t.height)S=Math.max(S,(t.left-c)*d),b=Math.max(b,(t.top-h)*u),w=Math.min(w,(t.right-c)*d),C=Math.min(C,(t.bottom-h)*u)}b=this.canvasRelativeClippedTop=Math.round(Math.max(b,0)),S=this.canvasRelativeClippedLeft=Math.round(Math.max(S,0)),w=Math.round(Math.min(w,o)),C=Math.round(Math.min(C,l));let x=this.renderViewport,E=x.width=Math.max(0,w-S),T=x.height=Math.max(0,C-b);x.logicalWidth=m,x.logicalHeight=f,x.visibleLeftFraction=(S-p)/m,x.visibleTopFraction=(b-g)/f,x.visibleWidthFraction=E/m,x.visibleHeightFraction=T/f}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:i,renderViewport:{width:n,height:r}}=this,s=t+r;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let a=this.context.canvas.height-s;e.viewport(i,a,n,r),e.scissor(i,a,n,r)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:i,logicalWidth:n,logicalHeight:r}}=this,s=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,s-(this.canvasRelativeLogicalTop+r),n,r),e.scissor(this.canvasRelativeClippedLeft,s-(this.canvasRelativeClippedTop+i),t,i)}disposed(){this.context.unmonitorPanel(this.element,this.monitorState),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return 0!==e.clientWidth&&0!==e.clientHeight&&0!==e.offsetWidth&&0!==e.offsetHeight&&!0}get drawOrder(){return 0}}class iL extends iP{canvas=document.createElement("canvas");canvasRenderingContext=this.canvas.getContext("2d");constructor(e,t,i){super(e,t,i);let{canvas:n}=this;t.appendChild(n),t.style.position="relative",n.style.position="absolute",n.style.left="0",n.style.right="0",n.style.top="0",n.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:i,logicalHeight:n}=e;t.width=i,t.height=n;let{canvasRenderingContext:r}=this;r?.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,i,n,0,0,i,n)}}class iI extends Z.TU{constructor(){super(Float64Array.of(0,0,1,1),e=>(0,eb.Iw)(new Float64Array(4),e,eb.j2))}toJSON(){let{value:e}=this,[t,i,n,r]=e;if(0!==t||0!==i||1!==n||1!==r)return Array.from(e)}}class iR extends ef.gj{container;canvas;gl;updateStarted;updateFinished;continuousCameraMotionStarted;continuousCameraMotionFinished;changed;panels;canvasRect;rootRect;resizeGeneration;boundsGeneration;force3DHistogramForAutoRange;framerateMonitor;continuousCameraMotionInProgress;orderedPanels;frameNumber;resizeCallback;ensureMonitorPanel(e,t,i){let n;if(!t.addedToResizeObserver&&(this.resizeObserver.observe(e),t.addedToResizeObserver=!0),t.isIntersecting){let e=this.rootRect,t=e.top-i.top,r=e.left-i.left,s=i.right-e.right,a=i.bottom-e.bottom;n=`${t}px ${s}px ${a}px ${r}px`}else n="";if(t.intersectionObserverMargin!==n){t.intersectionObserverMargin=n,t.intersectionObserver?.disconnect();let i=Array(101);for(let e=0;e<=100;++e)i[e]=.01*e;(t.intersectionObserver=new IntersectionObserver(e=>{let i=e[e.length-1];t.isIntersecting=i.isIntersecting,this.resizeCallback()},{root:this.container,rootMargin:n,threshold:i})).observe(e)}}unmonitorPanel(e,t){t.addedToResizeObserver&&this.resizeObserver.unobserve(e),t.intersectionObserver?.disconnect()}resizeObserver;debouncedEndContinuousCameraMotion;flagContinuousCameraMotion(){!this.continuousCameraMotionInProgress&&this.continuousCameraMotionStarted.dispatch(),this.continuousCameraMotionInProgress=!0,this.debouncedEndContinuousCameraMotion()}get isContinuousCameraMotionInProgress(){return this.continuousCameraMotionInProgress}constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new ez.K_,this.updateFinished=new ez.K_,this.continuousCameraMotionStarted=new ez.K_,this.continuousCameraMotionFinished=new ez.K_,this.changed=this.updateFinished,this.panels=new Set,this.resizeGeneration=0,this.boundsGeneration=-1,this.force3DHistogramForAutoRange=!1,this.framerateMonitor=new iC,this.continuousCameraMotionInProgress=!1,this.orderedPanels=[],this.frameNumber=0,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.debouncedEndContinuousCameraMotion=this.registerCancellable((0,ic.Z)(()=>{this.continuousCameraMotionInProgress=!1,this.continuousCameraMotionFinished.dispatch()},300)),this.scheduleRedraw=this.registerCancellable((0,iS.H)(()=>this.draw()));let{canvas:t,resizeObserver:i}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",i.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",e=>{console.log(`Lost WebGL context: ${e.statusMessage}`),e.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=(0,iE.B)(t)}applyWindowedViewportToElement(e,t){let[i,n,r,s]=t,a=1/r,o=1/s;e.style.position="absolute",e.style.top=`${-o*n*100}%`,e.style.left=`${-a*i*100}%`,e.style.width=`${100*a}%`,e.style.height=`${100*o}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels){if(!!e.visible){if(!e.isReady())return!1}}return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}scheduleRedraw;ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.rootRect=this.container.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl,t=this.framerateMonitor.getTimingExtension(e);this.framerateMonitor.startFrameTimeQuery(e,t,this.frameNumber),this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:i,panels:n}=this;for(let e of(i.length!==n.size&&(i.push(...n),i.sort((e,t)=>e.drawOrder-t.drawOrder)),i)){if(!e.shouldDraw)continue;e.ensureBoundsUpdated();let{renderViewport:t}=e;0!==t.width&&0!==t.height&&e.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch(),this.framerateMonitor.endLastTimeQuery(e,t),this.framerateMonitor.grabAnyFinishedQueryResults(e)}getDepthArray(){let{width:e,height:t}=this.canvas,i=new Float32Array(e*t);for(let e of this.panels){if(!e.shouldDraw)continue;let t=e.getDepthArray();if(void 0===t)continue;let{canvasRelativeClippedTop:n,canvasRelativeClippedLeft:r,renderViewport:{width:s,height:a}}=e;for(let e=0;e<a;++e){let o=(a-1-e)*s;i.set(t.subarray(o,o+s),(n+e)*s+r)}}return i}getLastFrameTimesInMs(e=10){return this.framerateMonitor.getLastFrameTimesInMs(e)}}class iA extends iT{displayDimensionRenderInfo;globalPosition=tC;projectionMat=Q._E.create();viewMatrix=Q._E.create();invViewMatrix=Q._E.create();viewProjectionMat=Q._E.create();invViewProjectionMat=Q._E.create()}function iM(e,t){return e.displayDimensionRenderInfo===t.displayDimensionRenderInfo&&iD(e,t)&&(0,Y.cO)(e.globalPosition,t.globalPosition)&&(0,Y.cO)(e.projectionMat,t.projectionMat)&&(0,Y.cO)(e.viewMatrix,t.viewMatrix)}function iN(e){let{viewMatrix:t,viewProjectionMat:i}=e;Q._E.invert(t,e.invViewMatrix),Q._E.multiply(i,e.projectionMat,t),Q._E.invert(e.invViewProjectionMat,i)}var iV=i("1395");var iO=((T={})[T.info=0]="info",T[T.warning=1]="warning",T[T.error=2]="error",T);class i_{changed=new ez.K_;messages=[];children=[];addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;0!==e.length&&(e.length=0,this.changed.dispatch())}isEmpty(){return 0===this.messages.length&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),!e.isEmpty()&&this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),!e.isEmpty()&&this.changed.dispatch()}}*[Symbol.iterator](){for(let e of(yield*this.messages,this.children))yield*e}}function iF(e,t){if(void 0!==e){if(e.aborted){t(e.reason);return}return e.addEventListener("abort",i,{once:!0}),{[Symbol.dispose](){e.removeEventListener("abort",i)}}}function i(){t(this.reason)}}class iB{consumers=new Map;controller=new AbortController;retainCount=0;get signal(){return this.controller.signal}addConsumer(e){if(!this.controller.signal.aborted){if(void 0!==e){if(e.aborted)return;let t=this;e.addEventListener("abort",function e(){t.consumers.delete(e),0==--t.retainCount&&(t.controller.abort(),t[Symbol.dispose]())},{once:!0})}++this.retainCount}}[Symbol.dispose](){for(let[e,t]of this.consumers)t.removeEventListener("abort",e);this.consumers.clear(),this.retainCount=0}start(){0===this.retainCount&&this.controller.abort()}}function iU(e,t){return void 0===t?e:t.aborted?Promise.reject(t.reason):new Promise((i,n)=>{let r=iF(t,e=>{n(e)});e.then(e=>{r?.[Symbol.dispose](),i(e)},e=>{r?.[Symbol.dispose](),n(e)})})}let i$=!("undefined"!=typeof Window&&self instanceof Window),iG="rpc.promise.response",iz="rpc.promise.cancel",ij="rpc.ready",iW=new Map;function iq(e,t){iW.set(e,t)}class iH extends Error{name;message;constructor(e,t){super(t),this.name=e,this.message=t}}function iJ(e,t){iq(e,function(e){let i=e.id,n=new AbortController,r=t.call(this,e,n.signal);this.set(i,{promise:r,abortController:n}),r.then(({value:e,transfers:t})=>{this.delete(i),this.invoke(iG,{id:i,value:e},t)},e=>{this.delete(i),this.invoke(iG,{id:i,error:e.message,errorName:e.name})})})}iq(iz,function(e){let t=e.id,i=this.get(t);if(void 0!==i){let{abortController:e}=i;e.abort()}}),iq(iG,function(e){let t=e.id,{resolve:i,reject:n}=this.get(t);this.delete(t),Object.prototype.hasOwnProperty.call(e,"value")?i(e.value):n(new iH(e.errorName,e.error))}),iq(ij,function(e){this.onPeerReady()});let iK=i$?-1:0;class iZ{target;objects;nextId;queue;constructor(e,t){this.target=e,this.objects=new Map,this.nextId=iK,t&&(this.queue=[]),e.onmessage=e=>{let t=e.data;iW.get(t.functionName).call(this,t)}}sendReady(){this.invoke(ij,{})}onPeerReady(){let{queue:e}=this;if(void 0!==e)for(let{data:t,transfers:i}of(this.queue=void 0,e))this.target.postMessage(t,i)}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,i=this.get(t);return i.referencedGeneration=e.gen,i.addRef(),i}getOptionalRef(e){if(void 0===e)return;let t=e.id,i=this.get(t);return i.referencedGeneration=e.gen,i.addRef(),i}invoke(e,t,i){t.functionName=e;let{queue:n}=this;if(void 0!==n){n.push({data:t,transfers:i});return}this.target.postMessage(t,i)}promiseInvoke(e,t,i,n){if(i?.aborted)return Promise.reject(i.reason);let r=t.id=this.newId();this.invoke(e,t,n);let{promise:s,resolve:a,reject:o}=void 0===i?Promise.withResolvers():function(e,t){let{promise:i,resolve:n,reject:r}=Promise.withResolvers(),s=iF(e,t);return{promise:i,resolve:e=>{s?.[Symbol.dispose](),n(e)},reject:e=>{s?.[Symbol.dispose](),r(e)}}}(i,()=>{this.invoke(iz,{id:r})});return this.set(r,{resolve:a,reject:o}),s}newId(){return i$?this.nextId--:this.nextId++}}class iY extends ef.gj{rpc=null;rpcId=null;isOwner;unreferencedGeneration;referencedGeneration;initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){!0===this.isOwner?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():!1===this.isOwner?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,0===this.refCount&&e===this.referencedGeneration&&this.ownerDispose()}}class iX extends iY{constructor(e,t={}){super(),!function(e,t,i={}){null!=t&&e.initializeSharedObject(t,i.id)}(this,e,t)}}iq("SharedObject.dispose",function(e){let t=this.get(e.id);if(0!==t.refCount)throw Error("Attempted to dispose object with non-zero reference count.");t.disposed(),this.delete(t.rpcId),t.rpcId=null,t.rpc=null}),iq("SharedObject.refCountReachedZero",function(e){let t=this.get(e.id),i=e.gen;t.counterpartRefCountReachedZero(i)});let iQ=new Map;function i0(e){return t=>{t.prototype.RPC_TYPE_ID=e}}function i1(e){return t=>{if(void 0!==e)t.prototype.RPC_TYPE_ID=e;else if(void 0===(e=t.prototype.RPC_TYPE_ID))throw Error("RPC_TYPE_ID should have already been defined");iQ.set(e,t)}}iq("SharedObject.new",function(e){let t=e.type,i=new(iQ.get(t))(this,e);--i.refCount});let i2="SharedWatchableValue.changed";class i3 extends iX{base;updatingValue_=!1;constructor(e,t={}){super(e,t),void 0!==e&&(this.base=new Z.SN(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;null!==e&&e.invoke(i2,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let i=new i3;return i.base=t,i.setupChangedHandler(),i.initializeCounterpart(e),i}static make(e,t){return i3.makeFromExisting(e,new Z.SN(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}}i3=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i1("SharedWatchableValue")],i3),iq(i2,function(e){let t=this.get(e.id);t.updatingValue_=!0,t.base.value=e.value,t.updatingValue_=!1});class i4 extends Z.SN{constructor(e=Number.NEGATIVE_INFINITY){super(e)}static VISIBLE=Number.POSITIVE_INFINITY;static IGNORED=Number.NEGATIVE_INFINITY;get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}class i6 extends i4{contributors=new Map;add(e){let{contributors:t}=this,i=e.changed.add(()=>{this.update()}),n=()=>{t.delete(n),i(),this.update()};return t.set(n,e),this.update(),n}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function i5(e){return class extends e{visibility=new i6;initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(i3.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var i8=((k={})[k.DATA=0]="DATA",k[k.ANNOTATION=1]="ANNOTATION",k[k.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION",k);class i7 extends ef.gj{userLayer;role=0;messages=new i_;layerChanged=new ez.K_;redrawNeeded=new ez.K_;layerChunkProgressInfo=new ib;handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,i,n){}}class i9 extends i7{backend;visibility=new i6;attach(e){}}function ne(e,t,i){let{state:n}=i;if(void 0===n||n.transform!==e||n.displayDimensionRenderInfo!==t){if(i.messages.clearMessages(),n=i.state={transform:e,displayDimensionRenderInfo:t,modelTransform:void 0},void 0!==e.error){i.messages.addMessage({severity:iO.error,message:e.error});return}try{let i=Q._E.create();!function(e,t,i){e.fill(0),e[15]=1;let n=!0,{displayDimensionIndices:r}=t,{globalToRenderLayerDimensions:s,modelToRenderLayerTransform:a}=i,o=i.rank;for(let t=0;t<3;++t){let i=r[t];if(-1===i){n=!1;continue}let l=s[i];if(-1===l){n=!1;continue}e[t+12]=a[l+o*(o+1)];for(let i=0;i<3;++i)e[t+4*i]=a[l+(o+1)*i]}if(!n){let{globalDimensionNames:e}=t,n=Array.from(r.filter(e=>-1!==e),t=>e[t]).join(",\xa0");throw Error(`Transform from model dimensions (${i.modelDimensionNames.join(",\xa0")}) to display dimensions (${n}) does not have full rank`)}}(i,t,e),n.modelTransform=i}catch(e){i.messages.addMessage({severity:iO.error,message:e.message})}}return n.modelTransform}class nt extends ef.gj{oldValue_;value_;renderViewport=new iT;changed=new ez.MZ;constructor(e){super();let{parametersConstructor:t=iA,navigationState:i,update:n,isEqual:r=iM}=e;this.oldValue_=new t,this.value_=new t;let s=()=>{let{oldValue_:e,value_:t}=this;e.displayDimensionRenderInfo=i.displayDimensionRenderInfo.value,Object.assign(e,this.renderViewport);let{globalPosition:s}=e,a=i.position.value,o=a.length;s.length!==o&&(e.globalPosition=s=new Float32Array(o)),s.set(a),n(e,i),!r(e,t)&&(this.value_=e,this.oldValue_=t,this.changed.dispatch(t,e))},a=this.update=this.registerCancellable((0,ic.Z)(s,0));this.registerDisposer(i.changed.add(a)),s()}setViewport(e){!iD(e,this.renderViewport)&&(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}update}class ni extends iY{base;updateInterval;prevDisplayDimensionRenderInfo;constructor(e,t,i=10){super(),this.base=t,this.updateInterval=i,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable((0,ic.Z)((e,t)=>{let i;if(t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)i=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo;else{let{displayDimensionRenderInfo:e,...n}=t;i=n}this.rpc.invoke(iV.uH,{id:this.rpcId,value:i})},this.updateInterval)),this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}update}ni=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i0(iV.rC)],ni);class nn{value_;defaultValue;get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}changed;constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new ez.K_}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(!0===e||!1===e){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class nr extends ef.gj{model;element;constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");let{element:i}=this;i.type="checkbox";let n=()=>{let e=this.model.value;this.element.checked=e,(void 0!==t.enableTitle||void 0!==t.disableTitle)&&(this.element.title=(e?t.enableTitle:t.disableTitle)??"")};this.registerDisposer(e.changed.add(n)),n(),this.registerEventListener(i,"change",function(t){e.value=this.checked}),i.addEventListener("mousedown",e=>{e.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}}class ns extends ef.gj{model;element;initialDisplay;constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,ic.Z)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}function na(e){try{return e()}catch(e){return{error:e.message}}}function no(e){if(void 0!==e.error)throw Error(e.error);return e}class nl extends ef.gj{register;changed;map;disposerMap;constructor(e,t){if(super(),this.register=e,this.changed=new ez.K_,this.disposerMap=new Map,void 0===t)this.map=new Map;else{let i=this.map=new Map(t),{disposerMap:n}=this;for(let[t,r]of i){let i=new ef.gj;n.set(t,i),e(i,r,t)}}}get value(){return this.map}set(e,t){let{map:i,disposerMap:n}=this,r=n.get(e);return void 0!==r&&r.dispose(),r=new ef.gj,n.set(e,r),i.set(e,t),this.register(r,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:i}=this,n=i.get(e);return void 0!==n&&(n.dispose(),i.delete(e),t.delete(e),this.changed.dispatch(),!0)}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let e of t.values())e.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let e of t.values())e.dispose();e.clear(),t.clear(),super.disposed()}}var nd=i("7927");var nu=((D={})[D.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",D[D.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT",D);class nc extends Error{shaderType;source;log;errorMessages;constructor(e,t,i,n){let r=`Error compiling ${nu[e].toLowerCase()} shader: ${i}`;super(r),this.name="ShaderCompilationError",this.log=i,this.message=r,this.shaderType=e,this.source=t,this.errorMessages=n}}class nh extends Error{vertexSource;fragmentSource;log;constructor(e,t,i){let n=`Error linking shader: ${i}`;super(n),this.name="ShaderLinkError",this.log=i,this.message=n,this.vertexSource=e,this.fragmentSource=t}}function np(e,t,i){let n=e.createShader(i);if(e.shaderSource(n,t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS)){var r,s;let a=e.getShaderInfoLog(n)||"";throw new nc(i,t,a,function(e){e=e.replace("\0","");let t=[];for(let i of e.split("\n")){let e=i.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);null!==e?t.push({message:e[3].trim(),file:parseInt(e[1],10),line:parseInt(e[2],10)}):null!==(e=i.match(/^ERROR:\s*(.+)$/))?t.push({message:e[1]}):(i=i.trim())&&t.push({message:i})}return t}(a))}return n}class ng extends ef.gj{gl;vertexSource;fragmentSource;program;vertexShader;fragmentShader;attributes;uniforms;textureUnits;vertexShaderInputBinders;vertexDebugOutputs;transferFunctionTextures;constructor(e,t,i,n,r,s){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=i,this.attributes=new Map,this.uniforms=new Map,this.vertexShaderInputBinders={},this.transferFunctionTextures=new Map;let a=this.vertexShader=np(e,t,WebGL2RenderingContext.VERTEX_SHADER),o=this.fragmentShader=np(e,i,WebGL2RenderingContext.FRAGMENT_SHADER),l=e.createProgram();if(e.attachShader(l,a),e.attachShader(l,o),e.linkProgram(l),!e.getProgramParameter(l,e.LINK_STATUS))throw new nh(t,i,e.getProgramInfoLog(l)||"");this.program=l;let{uniforms:d,attributes:u}=this;if(n)for(let t of n)d.set(t,e.getUniformLocation(l,t));if(r)for(let t of r)u.set(t,e.getAttribLocation(l,t))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){n=this,this.gl.useProgram(this.program)}bindAndUpdateTransferFunctionTexture(e,t,i,n){let r=this.textureUnits.get(e);if(void 0===r)throw Error(`Invalid texture unit symbol: ${e.toString()}`);let s=this.transferFunctionTextures.get(e);if(void 0===s)throw Error(`Invalid transfer function texture symbol: ${e.toString()}`);return s.updateAndActivate({textureUnit:r,sortedControlPoints:t,dataType:i,lookupTableSize:n})}unbindTransferFunctionTextures(){let e=this.gl;for(let t of this.transferFunctionTextures.keys()){let i=this.textureUnits.get(t);void 0!==i&&(this.gl.activeTexture(e.TEXTURE0+i),this.gl.bindTexture(e.TEXTURE_2D,null))}}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0,this.transferFunctionTextures=void 0}}class nm{code="";parts=new Set;add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),Error("Invalid code type")}}toString(){return this.code}}let nf={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},nv={float:4,vec2:8,vec3:12,vec4:16};class ny{gl;nextSymbolID;nextTextureUnit;uniformsCode;attributesCode;varyingsCodeVS;varyingsCodeFS;fragmentExtensionsSet;fragmentExtensions;vertexCode;vertexMain;fragmentCode;outputBufferCode;fragmentMain;required;uniforms;attributes;initializers;textureUnits;vertexDebugOutputs;constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new Set,this.fragmentExtensions="",this.vertexCode=new nm,this.vertexMain="",this.fragmentCode=new nm,this.outputBufferCode="",this.fragmentMain="",this.required=new Set,this.uniforms=[],this.attributes=[],this.initializers=[],this.textureUnits=new Map,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw Error("Duplicate texture unit symbol: "+e.toString());let i=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,i),i}addTextureSampler(e,t,i,n){let r=this.allocateTextureUnit(i,n);return this.addUniform(`highp ${e}`,t,n),this.addInitializer(e=>{if(n){let i=new Int32Array(n);for(let e=0;e<n;++e)i[e]=e+r;e.gl.uniform1iv(e.uniform(t),i)}else e.gl.uniform1i(e.uniform(t),r)}),r}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,i){return this.attributes.push(t),void 0!==i&&(this.attributesCode+=`layout(location = ${i})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,i=""){this.varyingsCodeVS+=`${i} out ${e} ${t};
`,this.varyingsCodeFS+=`${i} in ${e} ${t};
`}addOutputBuffer(e,t,i){null!==i&&(this.outputBufferCode+=`layout(location = ${i}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,i){return this.uniforms.push(t),null!=i?this.uniformsCode+=`uniform ${e} ${t}[${i}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){if(!this.fragmentExtensionsSet.has(e))this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){if(!this.required.has(e))this.required.add(e),e(this)}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
float defaultMaxProjectionIntensity = 0.0;
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
float defaultMaxProjectionIntensity = 0.0;
${this.fragmentCode}
${this.fragmentMain}
`,i=new ng(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);i.textureUnits=this.textureUnits;let{initializers:n}=this;if(n.length>0)for(let e of(i.bind(),n))e(i);return i}}function nb(){return new Z.SN(void 0)}function nS(e){return new Z.TU(e,eb.ZE)}function nw(e,t,i){let n=new Map,{parameters:r,fallbackParameters:s,shaderError:a,encodeParameters:o=e=>e,extraParameters:l=(0,Z.ne)(void 0),encodeExtraParameters:d=e=>e,getContextKey:u,defineShader:c}=i;void 0!==a&&(a.value=void 0);let{encodeContext:h=u}=i,p=(0,eb.hd)(i.memoizeKey);function g(e,i,n){let r=JSON.stringify({id:p,context:h(e),parameters:o(i),extraParameters:d(n)});return t.memoize.get(r,()=>{let r=new ny(t);return c(r,e,i,n),r.build()})}return e.registerDisposer(()=>{for(let e of n.values()){let{shader:t}=e;null!==t&&t.dispose()}}),function(e){let t=u(e),i=n.get(t);void 0===i&&(i={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:r.value,extraParameters:l.value},n.set(t,i));let o=r.changed.count,d=l.changed.count;if(o===i.parametersGeneration&&d===i.extraParametersGeneration)return i;let c=i.parameters=r.value,h=i.extraParameters=l.value,p=i.shader;i.parametersGeneration=o,i.extraParametersGeneration=d;let m=null;try{m=g(e,c,h),i.fallback=!1,void 0!==s&&(s.value=c),void 0!==a&&(a.value=null)}catch(t){if(void 0!==a&&(a.value=t),void 0!==s)try{let t=s.value;m=g(e,t,h),i.parameters=t,i.fallback=!0}catch{}}return null!==p&&p.dispose(),i.shader=m,i}}function nC(e,t,i){return nw(e,t,{...i,getContextKey:e=>e,encodeContext:e=>(0,nd.M)(e),defineShader:(e,t,n,r)=>(e.require(t),i.defineShader(e,n,r))})}function nx(e,t=1,i=0){return`
#line ${i} ${t}
`+e}class nE{gl;bufferType;buffer;constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,i=WebGL2RenderingContext.FLOAT,n=!1,r=0,s=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,i,n,r,s)}bindToVertexAttribI(e,t,i=WebGL2RenderingContext.UNSIGNED_INT,n=0,r=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,i,n,r)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let i=this.gl;this.bind(),i.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,i,n){let r=new nE(e,i);return r.setData(t,n),r}}function nT(e,t,i,...n){return e.memoize.get((0,eb.hd)({id:"getMemoizedBuffer",getter:(0,nd.M)(i),args:n}),()=>{let r=new ef.IF(nE.fromData(e,i(...n),t,WebGL2RenderingContext.STATIC_DRAW));return r.registerDisposer(r.value),r})}function nk(e=-1,t=-1,i=1,n=1,r=1,s=1){return(0,Y.X9)(new Float32Array([e,t,e,n,i,n,i,t]),2,r,s)}function nD(e,t=-1,i=-1,n=1,r=1,s=1,a=1){return nT(e,WebGL2RenderingContext.ARRAY_BUFFER,nk,t,i,n,r,s,a).value}function nP(e){e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function nL(e){e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = getValue0();")}class nI extends ef.gj{width=Number.NaN;height=Number.NaN;hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){if(!this.hasSize(e,t))this.width=e,this.height=t,this.performResize()}}class nR extends nI{gl;internalformat;renderbuffer;constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class nA extends nR{gl;includeStencilBuffer;constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class nM extends nA{constructor(e){super(e,!0)}}class nN extends ef.gj{gl;framebuffer;constructor(e){super(),this.gl=e,this.framebuffer=e.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class nV extends nI{gl;internalFormat;format;dataType;texture;constructor(e,t,i,n){super(),this.gl=e,this.internalFormat=t,this.format=i,this.dataType=n,this.texture=e.createTexture()}performResize(){!function(e,t,i,n,r=WebGL2RenderingContext.RGBA8,s=WebGL2RenderingContext.RGBA,a=WebGL2RenderingContext.UNSIGNED_BYTE){e.activeTexture(WebGL2RenderingContext.TEXTURE0+e.tempTextureUnit),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),nP(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,i,n,0,s,a,null),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class nO extends nV{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,i=WebGL2RenderingContext.DEPTH_COMPONENT,n=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,i,n)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function n_(e,t,i=WebGL2RenderingContext.RGBA8,n=WebGL2RenderingContext.RGBA,r=WebGL2RenderingContext.UNSIGNED_BYTE){let s=[];for(let a=0;a<t;++a)s[a]=new nV(e,i,n,r);return s}class nF extends ef.gj{gl;width;height;colorBuffers;framebuffer;depthBuffer;fullAttachmentList;attachmentVerified;singleAttachmentList;constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=[],this.attachmentVerified=!1,this.singleAttachmentList=[WebGL2RenderingContext.COLOR_ATTACHMENT0];let{framebuffer:i=new nN(e),colorBuffers:n,depthBuffer:r}=t;this.framebuffer=this.registerDisposer(i),this.colorBuffers=n,this.depthBuffer=r,void 0!==r&&this.registerDisposer(r);let{fullAttachmentList:s}=this;n.forEach((t,i)=>{this.registerDisposer(t),s[i]=e.COLOR_ATTACHMENT0+i})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:i,depthBuffer:n}=this;void 0!==n?(n.resize(e,t),n.attachToFramebuffer()):i.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((n,r)=>{n.resize(e,t),n.attachToFramebuffer(i.COLOR_ATTACHMENT0+r)}),i.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),i.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),0!==e&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,i,n,r=1,s=1){let{gl:a}=this;try{this.bindSingle(e),a.readPixels(t,i,r,s,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,n)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class nB extends ef.gj{gl;shader;constructor(e,t){super(),this.gl=e,this.shader=t,this.registerDisposer(t),this.copyVertexPositionsBuffer=nD(e),this.copyTexCoordsBuffer=nD(e,0,0,1,1)}copyVertexPositionsBuffer;copyTexCoordsBuffer;draw(...e){let{gl:t,shader:i}=this;i.bind();let n=e.length;for(let i=0;i<n;++i)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,e[i]);t.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,Q.TL);let r=i.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(r,2);let s=i.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(s,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(r),t.disableVertexAttribArray(s);for(let e=0;e<n;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=nL,i=1){return e.memoize.get(`OffscreenCopyHelper:${i}:${(0,nd.M)(t)}`,()=>new nB(e,function(e,t=nL,i=1){return e.memoize.get(`elementWiseTextureShader:${i}:${(0,nd.M)(t)}`,()=>{let n=new ny(e);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler",i),n.addInitializer(t=>{let n=[];for(let e=0;e<i;++e)n[e]=e;e.uniform1iv(t.uniform("uSampler"),n)});for(let e=0;e<i;++e)n.addFragmentCode(`
vec4 getValue${e}() {
  return texture(uSampler[${e}], vTexCoord);
}
`);return n.addUniform("mat4","uProjectionMatrix"),n.require(t),n.addAttribute("vec4","aVertexPosition"),n.addAttribute("vec2","aTexCoord"),n.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),n.build()})}(e,t,i)))}}let nU=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,n$=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,nG=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,nz=[nG,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],nj=[nG,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],nW=[nG,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],nq=[nG,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],nH=[[nG,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],nW,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],nJ=[nq,nW,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],nK=[nG,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],nZ=[nG,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],nY=[nG,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],nX=[nG,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],nQ=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,n0=[nG,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],n1=[nG,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],n2=[nG,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],n3=[nG,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],n4=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,n6=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,n5=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,n8=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,n7=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,n9=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,re=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,rt=[n9,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],ri=[n9,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function rn(e,t=1){switch(e){case ec.FLOAT32:if(1===t)return"float";if(t>1&&t<=4)return`vec${t}`;break;case ec.UINT8:case ec.INT8:case ec.UINT16:case ec.INT16:case ec.UINT32:case ec.INT32:case ec.UINT64:{let i=eh[e]?"":"u",n=8*ep[e];if(1===t)return`${i}int${n}_t`;if(t>1&&t*n<=32)return`${i}int${n}x${t}_t`}}throw Error(`No shader type for ${ec[e]}[${t}].`)}let rr={[ec.UINT8]:nY,[ec.INT8]:nX,[ec.UINT16]:n0,[ec.INT16]:n1,[ec.UINT32]:n2,[ec.INT32]:n3,[ec.UINT64]:nG,[ec.FLOAT32]:nQ},rs={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function ra(e,t,i,n,r,s,a=1){let o=0,l=s*a;for(;l>0;){var d,u;let i=Math.min(4,l);let n=(d=t,1===(u=i)?d:"float"===d?`vec${u}`:`${d[0]}vec${u}`);l-=i,e.addAttribute("highp "+n,`a${r}${o}`),++o}l=s*a;let c="";for(let e=0;e<a;++e){c+=`highp ${t}[${s}] get${r}${e}() {
  highp ${t}[${s}] result;
`;for(let t=0;t<s;++t){let i=e*s+t,n=Math.floor(i/4),a=i%4;c+=`  result[${t}] = a${r}${n}`,(0!==a||i!==l-1)&&(c+=`[${a}]`),c+=";\n"}c+="  return result;\n}\n"}e.addVertexCode(c);let h=rs[i];e.addInitializer(e=>{let s=[];for(let t=0;t<o;++t)s[t]=e.attribute(`a${r}${t}`);e.vertexShaderInputBinders[r]={enable(t){let{gl:i}=e;for(let e=0;e<o;++e){let n=s[e];i.enableVertexAttribArray(n),i.vertexAttribDivisor(n,t)}},disable(){let{gl:t}=e;for(let e=0;e<o;++e){let i=s[e];t.vertexAttribDivisor(i,0),t.disableVertexAttribArray(i)}},bind(r,a){let{gl:d}=e;for(let e=0;e<o;++e){let o=s[e],u=Math.min(4,l-4*e);"float"===t?d.vertexAttribPointer(o,u,i,n,r,a):d.vertexAttribIPointer(o,Math.min(4,l-4*e),i,r,a),a+=h*u}}}})}class ro extends ef.gj{channels;properties;bounds;visibility;framebuffers;producerVisibility;frameNumber;constructor(e,t,i,n=new i6){super(),this.channels=e,this.properties=t,this.bounds=i,this.visibility=n,this.framebuffers=[],this.producerVisibility=new i6,this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this,i=this.bounds.value.length;for(;t.length<i;){let i=new nF(e,{colorBuffers:n_(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(i)}return t}get visibleHistograms(){return this.visibility.visible?this.bounds.value.length:0}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}}let rl=Symbol("histogramDataSamplerTextureUnit"),rd=Symbol("histogramDepthTextureUnit");class ru extends ef.gj{gl;shader;inputIndexBuffer;constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{let e=new ny(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",rl),e.addTextureSampler("sampler2D","uDepthSampler",rd),e.addVertexCode(n8),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})()),this.inputIndexBuffer=this.registerDisposer(nT(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(4096)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new ru(e))}compute(e,t,i,n,r){let{gl:s}=this,{shader:a}=this,o=n.getFramebuffers(s);a.bind(),s.enable(WebGL2RenderingContext.BLEND),s.disable(WebGL2RenderingContext.SCISSOR_TEST),s.disable(WebGL2RenderingContext.DEPTH_TEST),s.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(a.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let l=a.textureUnit(rl),d=a.textureUnit(rd);s.activeTexture(WebGL2RenderingContext.TEXTURE0+d),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),nP(s),s.activeTexture(WebGL2RenderingContext.TEXTURE0+l);let u=n.frameNumber;n.frameNumber=r;for(let t=0;t<e;++t)s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i[t].texture),nP(s),o[t].bind(256,1),r!==u&&(s.clearColor(0,0,0,0),s.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),s.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,4096,4);s.disable(WebGL2RenderingContext.BLEND)}}function rc(e){let t=new Float32Array(1024);e.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,t);let i=new Float32Array(256);for(let e=0;e<256;++e)i[e]=t[4*e];return i}let rh={[ec.UINT8]:"vec2",[ec.INT8]:"vec2",[ec.UINT16]:"vec2",[ec.INT16]:"vec2",[ec.FLOAT32]:"vec2",[ec.UINT32]:"Uint32LerpParameters",[ec.INT32]:"Int32LerpParameters",[ec.UINT64]:"Uint64LerpParameters"},rp={[ec.UINT8]:"",[ec.INT8]:"",[ec.UINT16]:"",[ec.INT16]:"",[ec.FLOAT32]:"",[ec.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[ec.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[ec.UINT64]:[nG,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]},rg=`
float computeInvlerp(float inputValue, vec2 p) {
  float outputValue = inputValue;
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;function rm(e){let t=rn(e),i=`
float computeInvlerp(${t} inputValue, vec2 p) {
  return computeInvlerp(float(toRaw(inputValue)), p);
}
`;return[rr[e],rg,i]}function rf(e){let t=rn(e),i=e===ec.INT32?"int":"uint",n=rh[e];return[rr[e],rp[e],`
float computeInvlerp(${i} v, ${n} p) {
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
float computeInvlerp(${t} inputValue, ${n} p) {
  return computeInvlerp(toRaw(inputValue), p);
}
`]}let rv={[ec.UINT8]:rm(ec.UINT8),[ec.INT8]:rm(ec.INT8),[ec.UINT16]:rm(ec.UINT16),[ec.INT16]:rm(ec.INT16),[ec.FLOAT32]:rg,[ec.UINT32]:rf(ec.UINT32),[ec.INT32]:rf(ec.INT32),[ec.UINT64]:[nG,nW,nq,nK,rp[ec.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function ry(e){let t=rn(e),i=`
${t} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return e===ec.FLOAT32?i+="return inputValue;\n":i+=`return ${ec[e].toLowerCase()}FromFloat(round(inputValue));
`,i+=`
}
`,[rr[e],i]}function rb(e){let t=rn(e),i=rh[e];return[rr[e],rp[e],n7,e===ec.UINT32?n9:rt,e===ec.UINT32?re:ri,`
${t} computeLerp(float inputValue, ${i} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${t}(addSaturate(p.offset, xShifted));
  } else {
    return ${t}(subtractSaturate(p.offset, xShifted));
  }
}
`]}let rS={[ec.UINT8]:ry(ec.UINT8),[ec.INT8]:ry(ec.INT8),[ec.UINT16]:ry(ec.UINT16),[ec.INT16]:ry(ec.INT16),[ec.FLOAT32]:ry(ec.FLOAT32),[ec.UINT32]:rb(ec.UINT32),[ec.INT32]:rb(ec.INT32),[ec.UINT64]:[nG,nW,nj,nH,nJ,nK,nZ,rp[ec.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function rw(e,t,i){let n=`uLerpParams_${t}`,r=`uLerpBounds_${t}`,s=`uLerpScalar_${t}`,a="";switch(i){case ec.INT8:case ec.UINT8:case ec.INT16:case ec.UINT16:case ec.FLOAT32:e.addUniform("vec2",n);break;case ec.INT32:case ec.UINT32:{let t=rh[i];e.addUniform(`${i===ec.INT32?"i":"u"}vec2`,r),e.addUniform("float",s),a+=`
#define ${n} ${t}(${r}[0], int(${r}[1]), ${s})
`;break}case ec.UINT64:e.addUniform("uvec3",r),e.addUniform("float",s),a+=`
#define ${n} Uint64LerpParameters(uint64_t(${r}.xy), int(${r}[2]), ${s})
`}return[rp[i],a]}function rC(e,t,i,n=!1){let r=rn(i),s=`
float ${t}(${r} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${t});
  ${n?"v = clamp(v, 0.0, 1.0);":""}
  defaultMaxProjectionIntensity = v;
  return v;
}
`;if(i!==ec.UINT64&&i!==ec.FLOAT32){let e=eh[i]?"int":"uint";s+=`
float ${t}(${e} inputValue) {
  return ${t}(${r}(inputValue));
}
`}return[rr[i],rw(e,t,i),rv[i],s]}let rx=new eC.E;function rE(e,t,i,n){let{gl:r}=e;switch(i){case ec.INT8:case ec.UINT8:case ec.INT16:case ec.UINT16:case ec.FLOAT32:r.uniform2f(e.uniform(`uLerpParams_${t}`),n[0],1/(n[1]-n[0]));break;case ec.INT32:case ec.UINT32:{let s=n[0],a=n[1]-s,o=Math.max(0,Math.ceil(Math.log2(Math.abs(a)))-24),l=2**o/a,d=e.uniform(`uLerpBounds_${t}`);i===ec.UINT32?r.uniform2ui(d,s,o):r.uniform2i(d,s,o),r.uniform1f(e.uniform(`uLerpScalar_${t}`),l);break}case ec.UINT64:{let i=n[0],s=n[1];eC.E.absDifference(rx,s,i);let a=Math.max(0,(rx.high>0?32+Math.ceil(Math.log2(rx.high)):Math.ceil(Math.log2(rx.low)))-24);eC.E.rshift(rx,rx,a);let o=1/rx.low;eC.E.compare(i,s)>0&&(o*=-1);let l=e.uniform(`uLerpBounds_${t}`);r.uniform3ui(l,i.low,i.high,a),r.uniform1f(e.uniform(`uLerpScalar_${t}`),o)}}}function rT(e,t,i){(0,eb.Kh)(e,t,e=>i.restoreState(e))}i("284");class rk extends ef.gj{children=new Map;changed=new ez.K_;add(e,t){let{children:i}=this;if(i.has(e))throw Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw Error(`Key ${JSON.stringify(e)} not registered.`);let i=t.get(e);this.children.delete(e),i.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){let e=this.baseJSON();for(let[t,i]of this.children)e[t]=i.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){for(let[t,i]of((0,eb.PT)(e),this.children))try{if(Object.prototype.hasOwnProperty.call(e,t)){let n=e[t];if(void 0===n)continue;i.restoreState(n)}}catch(e){throw Error(`Error restoring property ${JSON.stringify(t)}: ${e.message}`)}}}let rD=new WeakMap;function rP(e){let t,i=rD.get(e),n=e.changed.count;if(void 0!==i&&i.generation===n)return i;if(e instanceof rk)for(let[i,n]of(t=e.baseJSON(),e.children))t[i]=rP(n).value;else t=e.toJSON();return void 0===i?(i={generation:n,value:t},rD.set(e,i)):(i.generation=n,i.value=t),i}var rL=i("5580");var rI=((P={})[P.LINKED=0]="LINKED",P[P.RELATIVE=1]="RELATIVE",P[P.UNLINKED=2]="UNLINKED",P);class rR extends rL.B{constructor(e=0){super(rI,e)}}let rA=Q.R3.create(),rM=Q.gf.create();function rN(e,t,i,n){let r,s=!1;e.registerDisposer(t);let a=2,o=()=>{let s=i.value;if(s!==a)switch(s){case 2:r=void 0;break;case 0:r=void 0,n.assign(e,t);break;case 1:r=n.difference(e,t)}a=s,e.changed.dispatch()};return e.registerDisposer(e.changed.add(()=>{if(!s)switch(i.value){case 2:break;case 0:n.assign(t,e);break;case 1:n.subtract(t,e,r)}})),e.registerDisposer(t.changed.add(()=>{switch(s=!0,i.value){case 2:if(n.isValid(e))break;case 0:n.assign(e,t);break;case 1:n.add(e,t,r)}s=!1})),e.registerDisposer(i.changed.add(o)),o(),e}function rV(e,t,i,n){return rN(e,t,i,n)}class rO extends ef.gj{coordinateSpace;coordinates_;curCoordinateSpace;changed;constructor(e){super(),this.coordinateSpace=e,this.coordinates_=tC,this.changed=new ez.K_,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=tC,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(void 0===t||!t.valid||t.rank!==e.length)return;let{coordinates_:i}=this;i.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:i}=e;if(!e.valid)return;if(void 0===t||!t.valid){let{coordinates_:t}=this;if(void 0!==t&&t.length===i);else{!function(e,t){let{lowerBounds:i,upperBounds:n}=t,r=e.length;for(let t=0;t<r;++t)e[t]=tB(i[t],n[t]);}(t=this.coordinates_=new Float32Array(i),e.bounds);let{voxelCenterAtIntegerCoordinates:n}=e.bounds;for(let e=0;e<i;++e)n[e]?t[e]=Math.round(t[e]):t[e]=Math.floor(t[e])+.5}this.changed.dispatch();return}let n=new Float32Array(i),r=this.coordinates_,{ids:s,scales:a}=e,{ids:o,scales:l}=t;for(let t=0;t<i;++t){let i=s[t],d=o.indexOf(i);-1===d?n[t]=tB(e.bounds.lowerBounds[t],e.bounds.upperBounds[t]):n[t]=r[d]*(l[d]/a[t])}this.coordinates_=n,this.changed.dispatch()}toJSON(){if(!this.valid&&0===this.coordinates_.length)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(0!==e.length)return Array.from(e)}restoreState(e){if(void 0===e){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from((0,eb.m7)(e,eb.jz)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{bounds:{voxelCenterAtIntegerCoordinates:e}}=this.coordinateSpace.value,{coordinates_:t}=this,i=t.length;for(let n=0;n<i;++n)e[n]?t[n]=Math.round(t[n]):t[n]=Math.floor(t[n])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:i}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(i),this.changed.dispatch()}static getOffset(e,t){let i=e.coordinates_,n=t.coordinates_;if(i.length===n.length)return tS(new Float32Array(i.length),i,n)}static addOffset(e,t,i,n=1){e.handleCoordinateSpaceChanged();let{value:r}=t;void 0!==i&&r.length===i.length&&(!function(e,t,i,n){let r=e.length;for(let s=0;s<r;++s)e[s]=t[s]+i[s]*n;}(e.value,r,i,n),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset(){e.reset()},restoreState(t){if(void 0===t||Array.isArray(t)){e.restoreState(t);return}(0,eb.PT)(t),rT(t,"voxelCoordinates",e)}}}}var r_=((L={})[L.STOP=0]="STOP",L[L.LOOP=1]="LOOP",L[L.REVERSE=2]="REVERSE",L);class rF{velocity=10;atBoundary=2;paused=!0}function rB(e){return(0,eb.PT)(e),{velocity:(0,eb.Kh)(e,"velocity",eb.jz,10),atBoundary:(0,eb.Kh)(e,"atBoundary",e=>(0,eb.CT)(e,r_),0),paused:(0,eb.Kh)(e,"paused",eb.JG,!0)}}class rU extends ef.gj{coordinateSpace;velocities_;curCoordinateSpace;changed;constructor(e){super(),this.coordinateSpace=e,this.changed=new ez.K_,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()})),this.curCoordinateSpace=e.value,this.velocities_=Array(this.curCoordinateSpace?.rank??0)}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.velocities_}set value(e){let{curCoordinateSpace:t}=this;if(void 0!==t&&t.rank===e.length)this.velocities_=e,this.changed.dispatch()}get(e){let t=this.coordinateSpace.value?.ids;if(void 0===t)return;let i=t.indexOf(e);if(-1!==i)return this.value[i]}dimensionVelocity(e,t){let i=new ez.K_,n=-1,r=()=>{let e=this.coordinateSpace.value?.ids;void 0===e?n=-1:(-1===n||e[n]!==t)&&(n=e.indexOf(t))},s=()=>{if(r(),-1!==n)return this.value[n]},a=e=>{if(r(),-1===n)return;let t=this.value;t[n]!==e&&(t[n]=e,this.changed.dispatch())},o=s();return e.registerDisposer(this.changed.add(()=>{let e=s();e!==o&&(o=e,i.dispatch())})),{get value(){return s()},set value(newVelocity){a(newVelocity)},changed:i}}modifyDimension(e,t){let i=this.coordinateSpace.value?.ids;if(void 0===i)return;let n=i.indexOf(e);if(-1===n)return;let r=this.value,s=r[n],a=t(s);s!==a&&(r[n]=a,this.changed.dispatch())}togglePlayback(e,t){this.modifyDimension(e,(e=new rF)=>({...e,paused:t??!e.paused}))}playbackEnabled(e){let t=this;return{changed:this.changed,get value(){return void 0!==t.get(e)},set value(enabled){t.modifyDimension(e,e=>enabled?e??new rF:void 0)}}}multiplyVelocity(e,t){this.modifyDimension(e,(e=new rF)=>{let i=Math.round(e.velocity*t);return 0===i&&(i=Math.sign(e.velocity)||1),{...e,velocity:i}})}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:i}=e;if(!e.valid)return;if(void 0===t){let{velocities_:e}=this;e.length===i||(e=Array(i)),this.changed.dispatch();return}let n=Array(i),r=this.velocities_,{ids:s}=e,{ids:a}=t;for(let e=0;e<i;++e){let t=s[e],i=a.indexOf(t);-1!==i&&(n[e]=r[i])}this.velocities_=n,this.changed.dispatch()}toJSON(){this.handleCoordinateSpaceChanged();let{velocities_:e,curCoordinateSpace:t}=this;if(!t?.valid||!e.some(e=>void 0!==e))return;let i={},{names:n,rank:r}=t;for(let t=0;t<r;++t){let r=e[t];void 0!==r&&(i[n[t]]=function(e){let{velocity:t,atBoundary:i,paused:n}=e;return{velocity:t,atBoundary:0===i?void 0:r_[i].toLowerCase(),paused:!!n&&void 0}}(r))}return i}reset(){this.handleCoordinateSpaceChanged(),this.velocities_=Array(this.curCoordinateSpace?.rank??0)}restoreState(e){if(void 0===e){this.reset();return}(0,eb.PT)(e);let t=this.curCoordinateSpace=this.coordinateSpace.value;if(this.velocities_=Array(t?.rank??0),void 0===t)throw Error("Must specify dimensions in order to specify velocities");let i=this.velocities_=Array(t?.rank??0),{names:n}=t;for(let t of Object.keys(e)){let r=n.indexOf(t);if(-1===r)throw Error(`Invalid dimension name: ${JSON.stringify(t)}`);i[r]=(0,eb.uq)(e,t,rB)}this.changed.dispatch()}assign(e){let t=e.value,i=this.value,n=i.length,r=!1;for(let e=0;e<n;++e){let n=t[e],o=i[e];if(n!==o){var s,a;if(void 0===o||void 0===n||(s=o,a=n,s.velocity!==a.velocity||s.atBoundary!==a.atBoundary||s.paused!==a.paused))r=!0;i[e]=n}}r&&this.changed.dispatch()}}class r$ extends ef.gj{peer;positionLink;changed;velocity;constructor(e,t){super(),this.peer=e,this.positionLink=t,this.changed=new ez.K_,this.velocity=this.registerDisposer(new rU(e.coordinateSpace)),this.registerDisposer(e),this.velocity.changed.add(()=>{2===this.positionLink.value?this.changed.dispatch():this.peer.assign(this.velocity)});let i=()=>{2!==this.positionLink.value&&this.velocity.assign(this.peer)};this.registerDisposer(e.changed.add(i)),i()}toJSON(){if(2===this.positionLink.value)return this.velocity.toJSON()}reset(){2===this.positionLink.value&&this.velocity.reset()}restoreState(e){2===this.positionLink.value&&this.velocity.restoreState(e)}copyToPeer(){2===this.positionLink.value&&this.peer.assign(this.velocity)}}class rG extends ef.gj{display;position;velocity;dimensionStates;lastUpdateGeneration;unregisterUpdateStartedCallback;constructor(e,t,i){super(),this.display=e,this.position=t,this.velocity=i,this.dimensionStates=new Map,this.lastUpdateGeneration=0,this.handleVelocityChanged(),this.registerDisposer(i.changed.add(()=>this.handleVelocityChanged()))}disposed(){this.unregisterUpdateStartedCallback?.(),super.disposed()}handleVelocityChanged(){let{dimensionStates:e}=this,t=this.position.coordinateSpace.value?.ids??[],i=t.length,n=this.velocity.value,r=++this.lastUpdateGeneration,s=this.position.value,a=Date.now();for(let o=0;o<i;++o){let i=n[o];if(void 0===i||0===i.velocity||i.paused)continue;let l=t[o],d=e.get(l);void 0===d?e.set(l,{prevTime:a,dimensionIndex:o,prevCoordinate:s[o],generation:r}):(d.generation=r,d.dimensionIndex=o)}for(let[t,i]of e)i.generation!==r&&e.delete(t);if(0===e.size){let{unregisterUpdateStartedCallback:e}=this;void 0!==e&&(e(),this.unregisterUpdateStartedCallback=void 0)}else void 0===this.unregisterUpdateStartedCallback&&(this.unregisterUpdateStartedCallback=this.display.updateStarted.add(()=>this.updateStarted()),this.display.scheduleRedraw())}updateStarted(){let e=this.position.coordinateSpace.value;if(void 0===e)return;let t=e.ids,i=this.position.value,n=!1,r=!1,s=Date.now(),a=this.velocity.value,{bounds:{lowerBounds:o,upperBounds:l}}=e;for(let[e,d]of this.dimensionStates){let{dimensionIndex:u}=d;if(t[u]!==e)continue;let c=a[u];if(Math.floor(i[u])!==Math.floor(d.prevCoordinate)){c?.paused===!1&&(a[u]={...c,paused:!0},r=!0);continue}let h=s-d.prevTime,p=c?.velocity??0,g=h*p/1e3;if(0===g)continue;let m=i[u]+g,f=o[u],v=Math.ceil(l[u]-1),y=g>0?v:f,b=g>0?f:v,S=Math.sign(g);if(Number.isFinite(y)&&m*S>=y*S)switch(c.atBoundary){case 1:if(Number.isFinite(b)){m=b;break}case 0:a[u]={...c,paused:!0},r=!0,m=y;break;case 2:a[u]={...c,velocity:-p},r=!0,m=y}i[u]=m,d.prevCoordinate=i[u],d.prevTime=s,n=!0}n&&this.position.changed.dispatch(),r&&this.velocity.changed.dispatch(),this.display.scheduleRedraw()}}function rz(e,t,i){if(void 0===i||0===Object.keys(i).length){e.value=0;return}(0,eb.PT)(i),e.value=2,(0,eb.uq)(i,"value",e=>{void 0!==e&&t.restoreState(e)}),(0,eb.uq)(i,"link",t=>e.restoreState(t))}class rj{peer;link;value;get changed(){return this.value.changed}constructor(e,t=new rR){this.peer=e,this.link=t}toJSON(){let{link:e}=this;if(0!==e.value)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){rz(this.link,this.value,e)}copyToPeer(){0!==this.link.value&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}}class rW extends rj{}class rq extends rj{value=rN(new rO(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:rO.getOffset,add:rO.addOffset,subtract:(e,t,i)=>{rO.addOffset(e,t,i,-1)}})}class rH extends ef.gj{orientation;changed=new ez.K_;constructor(e){super(),null==e&&(e=Q.gf.create()),this.orientation=e}toJSON(){var e;let{orientation:t}=this;if(Q.gf.normalize(this.orientation,this.orientation),0!==(e=t)[0]||0!==e[1]||0!==e[2]||1!==e[3])return Array.prototype.slice.call(this.orientation)}restoreState(e){try{(0,eb._b)(this.orientation,e),Q.gf.normalize(this.orientation,this.orientation)}catch{Q.gf.identity(this.orientation)}this.changed.dispatch()}reset(){Q.gf.identity(this.orientation),this.changed.dispatch()}snap(){let e=Q.wO.create();Q.wO.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let i=0;i<3;++i){let n=0,r=0;for(let s=0;s<3;++s){let a=e[3*i+s];if(e[3*i+s]=0,!t[s])Math.abs(a)>Math.abs(n)&&(n=a,r=s)}e[3*i+r]=Math.sign(n),t[r]=!0}Q.gf.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let i=new rH(Q.gf.multiply(Q.gf.create(),e.orientation,t)),n=!1;i.registerDisposer(e.changed.add(()=>{!n&&(r=!0,Q.gf.multiply(i.orientation,e.orientation,t),i.changed.dispatch(),r=!1)}));let r=!1,s=Q.gf.invert(Q.gf.create(),t);return i.registerDisposer(i.changed.add(()=>{!r&&(n=!0,Q.gf.multiply(e.orientation,i.orientation,s),e.changed.dispatch(),n=!1)})),i}assign(e){Q.gf.copy(this.orientation,e.orientation),this.changed.dispatch()}}class rJ extends rj{value=rN(new rH,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let i=Q.gf.create();return Q.gf.multiply(i,Q.gf.invert(i,t.orientation),e.orientation)},add:(e,t,i)=>{Q.gf.multiply(e.orientation,t.orientation,i),e.changed.dispatch()},subtract:(e,t,i)=>{Q.gf.multiply(e.orientation,t.orientation,Q.gf.invert(rM,i)),e.changed.dispatch()}})}class rK extends ef.gj{coordinateSpace;changed;curCoordinateSpace;value_;constructor(e){super(),this.coordinateSpace=e,this.changed=new ez.K_,this.curCoordinateSpace=tA,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=tA,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:i}=this,{factors:n}=i,{names:r,rank:s}=this.curCoordinateSpace;for(let i=0;i<s;++i){let s=n[i];1!==s&&(e[r[i]]=s,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:i,rank:n}=t,r=new Float64Array(n);if(r.fill(-1),void 0!==e){let t=(0,eb.PT)(e);for(let e=0;e<n;++e)r[e]=(0,eb.uq)(t,i[e],e=>void 0===e?1:(0,eb.o7)(e))}this.value_={factors:r},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:i}=this;if(i===e)return t;let{ids:n}=i,{ids:r,rank:s}=e,a=t.factors,o=new Float64Array(s);o.fill(1);for(let e=0;e<s;++e){let t=r[e],i=n.indexOf(t);-1!==i&&(o[e]=a[i])}return(0,Y.cO)(o,a)?t:(t=this.value_={factors:o},this.curCoordinateSpace=e,this.changed.dispatch(),t)}assign(e){this.setFactors(e.value.factors)}}function rZ(e,t,i,n,r){if(i===n)return t;let{ids:s}=i,{rank:a,ids:o}=n,l=new e(a);for(let e=0;e<a;++e){let i=o[e],n=s.indexOf(i);l[e]=-1===n?r(e):t[n]}return l}class rY extends rj{value=rN(new rK(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:i}=e.value,n=e.coordinateSpace.value,r=t.value.factors;return{coordinateSpace:n,offsets:tS(new Float64Array(i.length),i,r)}},add:(e,t,i)=>{let n=rZ(Float64Array,i.offsets,i.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(tb(new Float64Array(n.length),n,t.value.factors))},subtract:(e,t,i)=>{let n=rZ(Float64Array,i.offsets,i.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(tS(new Float64Array(n.length),t.value.factors,n))},isValid:()=>!0})}function rX(e,t,i){let n;let{rank:r,names:s,units:a}=e,{displayRank:o,displayDimensionIndices:l}=t,d=new Float64Array(3),u=new Float64Array(3),{factors:c}=i,h=[,,,],p=new Float64Array(3);if(d.fill(1),u.fill(1),p.fill(1),h.fill(""),0===o)n=1;else{n=Number.POSITIVE_INFINITY;let{scales:t}=e;for(let e=0;e<o;++e){let i=l[e];n=Math.min(n,u[e]=c[i]*t[i]),h[e]=a[i],p[e]=t[i]}for(let e=0;e<o;++e)d[e]=u[e]/n}return{globalRank:r,globalDimensionNames:s,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:h,displayDimensionScales:p,canonicalVoxelFactors:d,voxelPhysicalScales:u,canonicalVoxelPhysicalSize:n}}function rQ(e,t){return(0,Y.cO)(e.globalDimensionNames,t.globalDimensionNames)&&(0,Y.cO)(e.displayDimensionIndices,t.displayDimensionIndices)&&(0,Y.cO)(e.canonicalVoxelFactors,t.canonicalVoxelFactors)&&(0,Y.cO)(e.voxelPhysicalScales,t.voxelPhysicalScales)&&e.canonicalVoxelPhysicalSize===t.canonicalVoxelPhysicalSize&&(0,Y.cO)(e.displayDimensionUnits,t.displayDimensionUnits)&&(0,Y.cO)(e.displayDimensionScales,t.displayDimensionScales)}class r0 extends ef.gj{relativeDisplayScales;displayDimensions;changed;curRelativeDisplayScales;curDisplayDimensions;curCoordinateSpace;value_;get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:i},curRelativeDisplayScales:n,curDisplayDimensions:r,curCoordinateSpace:s}=this,a=this.value_;if(n!==e||r!==i||s!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=i,this.curCoordinateSpace=t;let n=rX(t,i,e);!rQ(a,n)&&(this.value_=a=n,this.changed.dispatch())}return a}constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new ez.K_,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=rX(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);let i=()=>{this.value};this.registerDisposer(e.changed.add(i)),this.registerDisposer(t.changed.add(i))}}class r1 extends ef.gj{coordinateSpace;changed;default_;value_;constructor(e){super(),this.coordinateSpace=e,this.changed=new ez.K_,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(void 0!==t&&t.coordinateSpace===e)return;if(void 0===t||this.default_){this.setToDefault(e);return}let i=new Int32Array(3),{ids:n}=t.coordinateSpace,{ids:r}=e,s=t.displayDimensionIndices,a=t.displayRank,o=0;for(let e=0;e<a;++e){let t=r.indexOf(n[s[e]]);-1!==t&&(i[o]=t,++o)}if(i.fill(-1,o),0===o){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,o,i),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),i=new Int32Array(3);i.fill(-1);for(let e=0;e<t;++e)i[e]=e;this.assignValue(e,t,i)}assignValue(e,t,i){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:i},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(void 0===e){this.reset();return}let t=t3(e);if(t.length>3)throw Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:i}}=this,n=new Int32Array(3);n.fill(-1);let{names:r}=i,s=0;for(let e of t){let t=r.indexOf(e);-1!==t&&(n[s++]=t)}if(0===s){this.reset();return}this.default_=!1,this.assignValue(i,s,n)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:i,displayDimensionIndices:n,coordinateSpace:{names:r}}=e;if(0!==i){for(let e=0;e<i;++e)t[e]=r[n[e]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:i}=e.value;this.setDimensionIndices(t,i)}}}class r2 extends rW{value=(I=new r1(this.peer.coordinateSpace),R=this.peer,A=this.link,rN(I,R,A,{assign:(e,t)=>e.assign(t),isValid:()=>!0}))}class r3 extends ef.gj{position;displayDimensionRenderInfo;orientation;changed;get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}constructor(e,t,i){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=i,this.changed=new ez.K_,this.registerDisposer(e),this.registerDisposer(i),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(i.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=rA){let{coordinateSpace:{value:i},value:n}=this.position,{displayDimensionIndices:r,displayRank:s}=this.displayDimensions.value;if(void 0===i)return!1;t.fill(0);for(let e=0;e<s;++e){let i=r[e];t[e]=n[i]}if(!1!==e(t)){for(let e=0;e<s;++e)n[r[e]]=t[e];return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){Q._E.fromQuat(e,this.orientation.orientation);let{value:i}=this.position,{canonicalVoxelFactors:n,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value;for(let s=0;s<3;++s){let a=r[s],o=t/n[s];e[s]*=o,e[4+s]*=o,e[8+s]*=o,e[12+s]=i[a]||0}}toMat3(e,t){Q.wO.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:i,displayRank:n}=this.displayDimensionRenderInfo.value;for(let r=0;r<n;++r){let n=t/i[r];e[r]*=n,e[3+r]*=n,e[6+r]*=n}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:i}=this,{value:n}=i,{bounds:r}=i.coordinateSpace.value;n[e]=tF(r,e,n[e]+t),i.changed.dispatch()}translateVoxelsRelative(e){if(!this.valid)return;let t=Q.R3.transformQuat(rA,e,this.orientation.orientation),{position:i}=this,{value:n}=i,{displayDimensionIndices:r,displayRank:s}=this.displayDimensions.value,{bounds:a}=i.coordinateSpace.value;for(let e=0;e<s;++e){let i=r[e],s=t[e];0!==s&&(n[i]=tF(a,i,n[i]+s))}this.position.changed.dispatch()}rotateRelative(e,t){let i=Q.gf.create();Q.gf.setAxisAngle(i,e,t);let n=this.orientation.orientation;Q.gf.multiply(n,n,i),this.orientation.changed.dispatch()}rotateAbsolute(e,t,i){let{coordinateSpace:{value:n},value:r}=this.position;if(void 0===n)return;let{relativeDisplayScales:{value:{factors:s}},displayDimensions:{value:{displayDimensionIndices:a,displayRank:o}}}=this,{scales:l}=n,d=Q.gf.create();Q.gf.setAxisAngle(d,e,t);let u=this.orientation.orientation;rA.fill(0);for(let e=0;e<o;++e){let t=a[e],n=i[t]-r[t];rA[e]=n*l[t]*s[t]}let c=Q.gf.invert(rM,u);Q.R3.transformQuat(rA,rA,c),Q.gf.multiply(u,d,u),Q.R3.transformQuat(rA,rA,u);for(let e=0;e<o;++e){let t=a[e];r[t]=i[t]-rA[e]/(l[t]*s[t])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:i}=this.displayDimensions.value,{position:n}=this,r=n.coordinateSpace.value.rank;for(let n=0;n<r;++n)if(-1===i.indexOf(n)&&0==e--){this.translateDimensionRelative(n,t);return}}}class r4 extends rj{constructor(e,t){super(e),this.value=(()=>{let i=new e.constructor(t);return rN(i,this.peer,this.link,{assign:(e,t)=>{e.assign(t)},isValid:e=>e.coordinateSpaceValue.valid&&0!==e.canonicalVoxelPhysicalSize,difference:(e,t)=>e.value/t.value*(e.canonicalVoxelPhysicalSize/t.canonicalVoxelPhysicalSize),add:(e,t,i)=>{e.setPhysicalScale(t.value*i,t.canonicalVoxelPhysicalSize)},subtract:(e,t,i)=>{e.setPhysicalScale(t.value/i,t.canonicalVoxelPhysicalSize)}}),i})()}}function r6(e){return{changed:e.changed,toJSON:()=>e.toJSON(),restoreState(t){rz(e.link,e.value.legacyJsonView,t)},reset(){e.reset()}}}class r5 extends ef.gj{displayDimensionRenderInfo;changed;curCanonicalVoxelPhysicalSize;value_;legacyValue_;get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;if(!Object.is(e,this.value_)||t!==this.curCanonicalVoxelPhysicalSize)this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch()}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){!Object.is(e,this.legacyValue_)&&(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new ez.K_,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:i}}}}=this,{curCanonicalVoxelPhysicalSize:n}=this;if(!Number.isNaN(e)&&t===n)return;if(!Number.isNaN(e)){0!==n&&(this.value_=n/t*e,this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}if(!!i.valid&&0!==t)this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch()}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,void 0===e?this.value_=Number.NaN:this.value_=(0,eb.o7)(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset:()=>e.reset(),restoreState(t){e.legacyValue=(0,eb.o7)(t)}}}setPhysicalScale(e,t){let i=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=t/i*e}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class r8 extends r5{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return 1e-9*this.legacyValue_/t}}class r7 extends r5{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:t}=this;return 200*Math.tan(Math.PI/8)*1e-9*e/t}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:i}}}=this,{canonicalVoxelFactors:n,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value,s=n.reduce((e,n,s)=>{let a=r[s];return Math.max(e,(i[a]-t[a])*n)},0);return s=Number.isFinite(s)?2**Math.ceil(Math.log2(s)):1024}}class r9 extends ef.gj{defaultValue;displayDimensionRenderInfo;changed;constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new ez.K_,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}value_;canonicalVoxelPhysicalSize;get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,i=this.canonicalVoxelPhysicalSize;t!==i&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=i/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){"number"==typeof e&&Number.isFinite(e)&&0!==e?this.value=e:this.value=this.defaultValue}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:i}=this.displayDimensionRenderInfo.value;e=t/i*e}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class se extends rW{constructor(e,t){var i,n,r;super(e),this.value=(i=new r9(e.defaultValue,t),n=this.peer,r=this.link,rN(i,n,r,{assign:(e,t)=>e.assign(t),isValid:()=>!0}))}}class st extends ef.gj{pose;zoomFactor;depthRange;changed;constructor(e,t,i){super(),this.pose=e,this.zoomFactor=t,this.depthRange=i,this.changed=new ez.K_,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(i),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}function si(e,t,i,n){let r=ex[t];if(t!==ec.FLOAT32&&e===(n?r[1]:r[0]))return e;let s=t===ec.FLOAT32?i:Math.round(i),a=new eC.E,o=t===ec.UINT64?n?eC.E.add(a,e,eC.E.fromNumber(s)):eC.E.subtract(a,e,eC.E.fromNumber(s)):n?e+s:e-s;return t===ec.FLOAT32?o:ek(r,o)}function sn(e,t,i){return si(e,t,i,!1)}function sr(e,t,i){return si(e,t,i,!0)}function ss(e,t,i=0){if(t===ec.UINT64&&1!==i)return e;let n=e[0],r=e[1];return[si(n,t,i,!1),si(r,t,i,!0)]}class sa{parents=[];parentPriorities=[];bindings=new Map;constructor(e){if(void 0!==e)for(let[t,i]of(this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities),e.bindings))this.bindings.set(t,i)}addParent(e,t){let{parents:i,parentPriorities:n}=this,r=0,{length:s}=i;for(;r<s&&t<n[r];)++r;return i.splice(r,0,e),n.splice(r,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(-1===t)throw Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let t;let{parents:i,parentPriorities:n}=this,r=n.length,s=0;for(;s<r&&n[s]>0;++s)if(void 0!==(t=i[s].get(e)))return t;if(void 0!==(t=this.bindings.get(e)))return t;for(;s<r;++s)if(void 0!==(t=i[s].get(e)))return t}*getAll(e){let t;let{parents:i,parentPriorities:n}=this,r=n.length;for(;0<r&&n[0]>0;)void 0!==(t=i[0].get(e))&&(yield t);for(void 0!==(t=this.bindings.get(e))&&(yield t);0<r;)void 0!==(t=i[0].get(e))&&(yield t)}*entries(){let{parents:e,parentPriorities:t}=this,i=t.length,n=0;for(;n<i&&t[n]>0;++n)yield*e[n].entries();for(yield*this.bindings.entries();n<i;++n)yield*e[n].entries()}}var so=((M={})[M.CONTROL=1]="CONTROL",M[M.ALT=2]="ALT",M[M.META=4]="META",M[M.SHIFT=8]="SHIFT",M);function sl(e){return(e.ctrlKey?1:0)|(e.altKey?2:0)|(e.metaKey?4:0)|(e.shiftKey?8:0)}function sd(e,t){let i="";return 1&t&&(i+="control+"),2&t&&(i+="alt+"),4&t&&(i+="meta+"),8&t&&(i+="shift+"),i+=e}function su(e){let t,i;let n=e.indexOf(":");if(-1!==n&&"at"!==(t=e.substring(0,n))&&"bubble"!==t)throw Error(`Invalid event phase: ${JSON.stringify(t)}`);let r=e.substring(n+1).split("+"),s=0,a=0;e:for(let e of r)switch(e){case"control":s|=1;break;case"control?":a|=1;break;case"alt":s|=2;break;case"alt?":a|=2;break;case"meta":s|=4;break;case"meta?":a|=4;break;case"shift":s|=8;break;case"shift?":a|=8;break;default:if(void 0===i)i=e;else{i=void 0;break e}}if(void 0===i||s&a)throw Error(`Invalid event identifier: ${JSON.stringify(e)}`);return{phase:t,keyName:i,modifiers:s,optionalModifiers:a}}function*sc(e){let{phase:t}=e,i=function*(e,t,i){0===i&&(yield sd(e,t));for(let n=0;n<16;++n){if((n&(t|i))===n)(n&t)===t&&(yield sd(e,n))}}(e.keyName,e.modifiers,e.optionalModifiers);if(void 0===t)for(let e of i)yield`at:${e}`,yield`bubble:${e}`;else for(let e of i)yield`${t}:${e}`}class sh extends sa{label;static fromObject(e,t={}){let i=new sh;if(i.label=t.label,void 0!==t.parents)for(let[e,n]of t.parents)i.addParent(e,n);for(let t of Object.keys(e))i.set(t,e[t]);return i}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let i=su(e),n=function(e,t){var i,n,r;let s;let a=(i=e.keyName,n=e.modifiers,r=e.optionalModifiers,s="",1&n&&(s+="control+"),1&r&&(s+="control?+"),2&n&&(s+="alt+"),2&r&&(s+="alt?+"),4&n&&(s+="meta+"),4&r&&(s+="meta?+"),8&n&&(s+="shift+"),8&r&&(s+="shift?+"),s+=i);return"string"==typeof t?{action:t,originalEventIdentifier:a}:{...t,originalEventIdentifier:a}}(i,t);for(let e of sc(i))super.set(e,n)}delete(e){for(let t of sc(su(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,e]of this.entries())t.set(e.originalEventIdentifier,e.action);let i=new Map;for(let[e,r]of t){var n;let t=i.get(r);void 0===t&&(t=[],i.set(r,t)),t.push(n=(n=e).replace(/^(?:at|bubble|capture)|(?:(?:shift|control|alt|meta)\?\+)/g,""))}for(let[t,n]of i){let i=1===n.length?n[0]:`{${n.join(",")}}`;e.push(`${i}→${t}`)}return e.join(", ")}}function sp(e,t,i){if(void 0===i)return;!1!==i.stopPropagation&&e.stopPropagation();let n=new CustomEvent("action:"+i.action,{bubbles:!0,detail:t,cancelable:!0}),r=!e.target.dispatchEvent(n);(!1!==i.preventDefault||r)&&e.preventDefault()}let sg=[];function sm(e,t,i,n,r){let s=sg[i]+":"+e;sp(t,n,r.get(s))}function sf(e,t,i,n){sm(sd(e,sl(t)),t,t.eventPhase,i,n)}function sv(e,t,i,n){return(0,ef.H0)(e,`action:${t}`,i,n)}sg[Event.AT_TARGET]="at",sg[Event.CAPTURING_PHASE]="capture",sg[Event.BUBBLING_PHASE]="bubble";class sy extends ef.gj{target;eventMap;dispatch(e,t){!this.shouldIgnore?.(t)&&sf(e,t,t,this.eventMap)}shouldIgnore;constructor(e,t,i){super(),this.target=e,this.eventMap=t,this.shouldIgnore=void 0,this.registerEventListener(e,"wheel",e=>{void 0!==i&&i(e),this.dispatch("wheel",e)}),this.registerEventListener(e,"click",e=>{void 0!==i&&i(e),this.dispatch(`click${e.button}`,e)}),this.registerEventListener(e,"dblclick",e=>{void 0!==i&&i(e),this.dispatch(`dblclick${e.button}`,e)}),this.registerEventListener(e,"mousedown",e=>{void 0!==i&&i(e);let t=e.button;2===t&&(3&e.buttons)==1&&(t=0),this.dispatch(`mousedown${t}`,e)}),this.registerEventListener(e,"mouseup",e=>{void 0!==i&&i(e),this.dispatch(`mouseup${e.button}`,e)})}}function sb(e,t,i){let{document:n}=e.view,r=e.clientX,s=e.clientY,a=e=>{let i=e.clientX-r,n=e.clientY-s;r=e.clientX,s=e.clientY,t(e,i,n)},o=e.button,l=e=>{n.removeEventListener("pointermove",a,!0),n.removeEventListener("pointerup",d,!1),void 0!==i&&i(e,e.clientX-r,e.clientY-s)},d=e=>{e.button===o&&l(e)};n.addEventListener("pointermove",a,!0),n.addEventListener("pointerup",d,!1),n.addEventListener("pointercancel",l,!1)}function sS(e){let t=0,{deltaMode:i}=e;switch(i){case 0:t=.005;break;case 1:t=.1;break;case 2:t=2}return Math.exp(e.deltaY*t)}let sw=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function sC(e,t,i){e.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*t,i)}function sx(e,t=!1){e.addVertexCode(sw),e.addUniform("highp vec3","uLineParams"),e.addVarying("highp float","vLineCoord"),e.addVarying("highp float","vLineFeatherFraction"),t&&(e.addVarying("highp float","vEndpointFraction"),e.addVarying("highp float","vLineCoordT"),e.addVarying("highp float","vLineBorderStartFraction")),e.addVertexCode(n5),e.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${t?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${t?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${t?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${t?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${t?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${t?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${t?", borderWidth":""});
}
`),t&&e.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),e.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function sE(e,t,i){sC(e,t,i)}function sT(e,t,i){let{gl:n}=e;n.uniform3f(e.uniform("uLineParams"),1/t.width,1/t.height,i)}function sk(e,t,i,n){let r=Math.floor(t*=6),s=t-r,a=n*(1-i),o=n*(1-i*s),l=n*(1-i*(1-s));switch(r%6){case 0:e[0]=n,e[1]=l,e[2]=a;break;case 1:e[0]=o,e[1]=n,e[2]=a;break;case 2:e[0]=a,e[1]=n,e[2]=l;break;case 3:e[0]=a,e[1]=o,e[2]=n;break;case 4:e[0]=l,e[1]=a,e[2]=n;break;case 5:e[0]=n,e[1]=a,e[2]=o}return e}class sD extends ef.gj{model;getDefaultColor;element;unsetHandler;static template(){let e=document.createElement("input");return e.classList.add("neuroglancer-color-widget"),e.type="color",e}constructor(e,t=()=>Q.R3.fromValues(1,0,0),i=sD.template(),n=()=>{},r=!0){super(),this.model=e,this.getDefaultColor=t,this.element=i,this.unsetHandler=n,i.addEventListener("change",()=>this.updateModel()),i.addEventListener("input",()=>this.updateModel()),r&&i.addEventListener("wheel",e=>{e.stopPropagation(),e.preventDefault(),this.adjustHueViaWheel(e)}),i.addEventListener("mousedown",e=>{2===e.button&&(e.stopPropagation(),n())}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){return this.model.value??this.getDefaultColor()}updateView(){this.element.value=ea(this.getRGB())}updateModel(){this.model.value=ei(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),i=Q.R3.create();!function(e,t,i,n){let r=Math.max(Math.max(t,i),n),s=Math.min(Math.min(t,i),n);if(e[2]=r,s===r)e[0]=0,e[1]=0;else{let a=r-s;e[1]=a/r,t===r?e[0]=(i-n)/a:i===r?e[0]=2+(n-t)/a:e[0]=4+(t-i)/a,e[0]/=6,e[0]<0&&(e[0]+=1),e[0]>1&&(e[0]-=1)};}(i,t[0],t[1],t[2]);let{deltaY:n}=e,r=Math.round(256*i[0]);r+=n>0?1:n<0?-1:0,r=(r+256)%256,i[0]=r/256,sk(i,i[0],i[1],i[2]),this.model.value=i}}i("4685");var sP=i("5659"),sL=i("5966");function sI(e){for(;;){let t=e.firstChild;if(!t)break;e.removeChild(t)}}function sR(e){let{parentElement:t}=e;return!!t&&(t.removeChild(e),!0)}function sA(e,t=Math.max(1,e.value.length)){let i=`${t}ch`;e.style.width!==i&&(e.style.width="0px",e.offsetWidth,e.style.width=i)}function sM(e,t){let i=e.firstElementChild;for(let n of t)n!==i&&e.insertBefore(n,i),i=n.nextElementSibling;for(;null!==i;){let t=i.nextElementSibling;e.removeChild(i),i=t}}function sN(e){return e instanceof HTMLElement&&(!!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)||!!e.isContentEditable||null!==e.closest(".neuroglancer-sticky-focus"))}function sV(e){let t;let{title:i,onClick:n,href:r}=e;void 0!==r?((t=document.createElement("a")).href=r,t.target="_blank"):t=document.createElement("div"),void 0!==i&&(t.title=i),void 0!==n&&t.addEventListener("click",n);let{svg:s}=e;return t.className="neuroglancer-icon",void 0!==s&&(t.innerHTML=s),void 0!==e.text&&t.appendChild(document.createTextNode(e.text)),t}i("9215"),i("5029");class sO extends ef.gj{parent;autoRangeData;finished;element;constructor(e){super(),this.parent=e,this.autoRangeData={inputPercentileBounds:[0,1],autoComputeInProgress:!1,previouslyComputedRanges:[],numIterationsThisCompute:0,invertedInitialRange:!1,finishedLerpRange:null},this.finished=new ez.K_,this.makeAutoRangeButtons(()=>this.autoComputeRange(0,1),()=>this.autoComputeRange(.01,.99),()=>this.autoComputeRange(.05,.95))}get computedRange(){return this.autoRangeData.finishedLerpRange}wasInputInverted(){let{range:e}=this.parent.trackable.value;return void 0!==e&&eI(e[0],e[1])>0}autoComputeRange(e,t){if(!this.autoRangeData.autoComputeInProgress){let{autoRangeData:i}=this,{dataType:n,display:r}=this.parent;i.inputPercentileBounds=[e,t],this.resetAutoRangeData(i),i.invertedInitialRange=this.wasInputInverted(),r.force3DHistogramForAutoRange=!0;let s=n===ec.FLOAT32?[-65536,65536]:ex[n];this.setTrackableValue(s,s),r.scheduleRedraw()}}setTrackableValue(e,t){let i=void 0!==this.parent.trackable.value.range;i?this.parent.trackable.value={...this.parent.trackable.value,range:e,window:t}:this.parent.trackable.value={...this.parent.trackable.value,window:(e=>0===eI(e[0],e[1])?ex[this.parent.dataType]:e)(t)}}maybeAutoComputeRange(){if(!this.autoRangeData.autoComputeInProgress){this.parent.display.force3DHistogramForAutoRange=!1;return}let{autoRangeData:e}=this,{trackable:t,dataType:i,display:n,histogramSpecifications:r,histogramIndex:s}=this.parent,a=n.gl,{range:o}=t.value;void 0===o&&(o=t.value.window),r.getFramebuffers(a)[s].bind(256,1);let{range:l,window:d}=function(e,t=.05,i=.95,n,r){let s=n[0],a=n[1],o=function(e){let t=e.reduce((e,t)=>e+t,0);if(0===t)return null;let i=0;return e.map(e=>(i+=e)/t)}(e);if(null===o)return{range:n,window:n};let l=function(e,t,i){let n=e.length-2;if(i===ec.UINT64){let e=new eC.E,i=t[0],r=t[1];return eC.E.subtract(e,r,i),e.toNumber()/n}{let e=t[0];return(t[1]-e)/n}}(e,n,r),d=0;for(let e=0;e<o.length&&(d=e,!(o[e]>t));e++);let u=o.findIndex(e=>e>=i);if(u=-1===u?e.length-1:u,0===d){let e=l/2;r===ec.FLOAT32&&(e=Math.max(e,Math.max(1,Math.abs(s/2)))),s=si(s,r,e,!1)}else s=si(s,r,l*(d-1),!0);if(u===e.length-1){let e=l/2;r===ec.FLOAT32&&(e=Math.max(e,Math.max(1,Math.abs(a/2)))),a=si(a,r,e,!0)}else a=si(a,r,l*(e.length-2-u),!1);let c=[s,a],h=64*l;r!==ec.FLOAT32&&(h=Math.max(1,h));let p=ss(c,r,h);return{range:c,window:p}}(rc(a),e.inputPercentileBounds[0],e.inputPercentileBounds[1],o,i),u=!1;u=i!==ec.FLOAT32?e.previouslyComputedRanges.some(e=>eO(i,e,l)):e.previouslyComputedRanges.some(e=>.001>Math.abs(e[0]-l[0])&&.001>Math.abs(e[1]-l[1]));let c=0===eI(l[0],l[1]),h=e.numIterationsThisCompute>16;e.previouslyComputedRanges.push(l),++e.numIterationsThisCompute,u||h||c?(e.invertedInitialRange&&l.reverse(),this.resetAutoRangeData(e,!0),e.finishedLerpRange=l,this.setTrackableValue(l,d),this.finished.dispatch()):(n.force3DHistogramForAutoRange=!0,this.setTrackableValue(l,l))}resetAutoRangeData(e,t=!1){e.autoComputeInProgress=!t,e.previouslyComputedRanges=[],e.numIterationsThisCompute=0,t&&(e.invertedInitialRange=!1)}makeAutoRangeButtons(e,t,i){let n=this.parent.element;this.element=document.createElement("div");let r=this.element;r.classList.add("neuroglancer-invlerp-range-finder-button-container"),n.appendChild(r);let s=document.createElement("button");s.textContent="Min-Max",s.title="Set range to the minimum and maximum values",s.classList.add("neuroglancer-invlerp-range-finder-button"),s.addEventListener("click",e),r.appendChild(s);let a=document.createElement("button");a.textContent="1-99%",a.title="Set range to the 1st and 99th percentiles",a.classList.add("neuroglancer-invlerp-range-finder-button"),a.addEventListener("click",t),r.appendChild(a);let o=document.createElement("button");o.textContent="5-95%",o.title="Set range to the 5th and 95th percentiles",o.classList.add("neuroglancer-invlerp-range-finder-button"),o.addEventListener("click",i),r.appendChild(o)}}i("200");class s_ extends ef.gj{visibility;element;get visible(){return this.visibility.visible}constructor(e=new i4(i4.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}disposed(){sR(this.element),super.disposed()}}class sF extends ef.gj{changed=new ez.K_;options=new Map;optionsChanged=new ez.K_;selectedValue=void 0;defaultValue=void 0;get value(){let{selectedValue:e}=this;return void 0!==e?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){void 0!==e&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return void 0!==e&&this.options.has(e)?e:this.defaultValue}add(e,t){let{options:i}=this;if(i.has(e))throw Error(`Option already defined: ${JSON.stringify(e)}.`);i.set(e,t),this.optionsChanged.dispatch(),void 0===this.defaultValue&&(this.default=e)}remove(e){let{options:t}=this;if(!t.has(e))throw Error(`Option is not defined: ${JSON.stringify(e)}.`);t.delete(e),this.optionsChanged.dispatch()}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}ready_=!0;get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){"string"!=typeof e&&(e=void 0),this.value=e}}class sB extends ef.gj{getter;selected;visibility;invalidateByDefault;element;tabs;tabVisibilityChanged;displayedTab;get visible(){return this.visibility.visible}debouncedUpdateSelectedTab;flush(){this.debouncedUpdateSelectedTab.flush()}constructor(e,t,i=new i4(i4.VISIBLE),n=!1){super(),this.getter=e,this.selected=t,this.visibility=i,this.invalidateByDefault=n,this.element=document.createElement("div"),this.tabs=new Map,this.tabVisibilityChanged=new ez.MZ,this.debouncedUpdateSelectedTab=this.registerCancellable((0,iS.H)(()=>this.updateSelectedTab()));let{element:r}=this;r.className="neuroglancer-stack-view",this.registerDisposer(i.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}invalidate(e){let{tabs:t}=this,i=t.get(e);if(void 0!==i)i.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab())}hideTab(e){let t=this.tabs.get(e);void 0!==t&&(t.visibility.value=i4.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,i=t.get(e);void 0===i&&(i=this.getter(e),this.element.appendChild(i.element),t.set(e,i)),i.element.style.display="",i.visibility.value=i4.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;if(t===e&&(void 0===t||this.tabs.has(t)))return;if(void 0!==e&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,void 0!==t)this.showTab(t)}invalidateAll(e){let{tabs:t}=this;for(let[i,n]of t)!e?.(i)&&(t.delete(i),n.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),sR(this.element),super.disposed()}}class sU extends sF{}class s$ extends ef.gj{visibility;element;tabBar;tabs;selectedTab;handleTabElement;stack;tabLabels;tabsGeneration;get visible(){return this.visibility.visible}debouncedUpdateView;constructor(e,t=new i4(i4.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new Map,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable((0,iS.H)(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:i,tabBar:n}=this;i.className="neuroglancer-tab-view",n.className="neuroglancer-tab-view-bar",i.appendChild(n),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let r=this.stack=this.registerDisposer(new sB(e.makeTab,e.selectedTab,this.visibility));i.appendChild(r.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView));let s=this.selectedTab.value;this.registerDisposer(e.selectedTab.changed.add(()=>{let e=this.tabs.value.find(({id:e})=>e===s);e?.hidden?(this.tabs.changed.count++,this.debouncedUpdateView()):this.updateTabLabelStyles(),s=this.selectedTab.value})),this.updateTabs()}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,i]of this.tabLabels)!function(e,t){let i="neuroglancer-selected-tab-label";t?e.classList.add(i):e.classList.remove(i)}(i,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(-1!==this.tabsGeneration){if(this.tabLabels.clear(),this.visible){let e=this.tabs.value;this.stack.invalidateAll(t=>void 0!==e.find(({id:e})=>e===t))}else this.stack.invalidateAll();sI(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:i}=this;for(let{id:n,label:r,hidden:s}of this.tabs.value){if(s&&n!==this.selectedTab.value)continue;let a=document.createElement("div");a.classList.add("neuroglancer-tab-label"),a.textContent=r,a.addEventListener("click",()=>{this.selectedTab.value=n}),void 0!==i&&i(n,a),t.set(n,a),e.appendChild(a)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){sI(this.tabBar),this.tabLabels.clear(),sR(this.element),super.disposed()}}let sG=sh.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});function sz(e,t){let i=new ny(e);return sx(i),i.addTextureSampler("sampler2D","uHistogramSampler",t),i.addOutputBuffer("vec4","out_color",0),i.addAttribute("uint","aDataValue"),i.addUniform("float","uBoundsFraction"),i.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),i.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${sH-1} ? cumSum : total;
if (dataValue == ${sH-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),i.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),i.build()}class sj extends ef.gj{element;dataType;getModel;setModel;constructor(e,t,i,n){super(),this.element=e,this.dataType=t,this.getModel=i,this.setModel=n,e.title=sG.describe(),this.registerDisposer(new sy(e,sG)),sv(e,"set",e=>{var t,i;let n=e.detail,r=this.getModel(),s=this.getTargetValue(n);if(void 0===s)return;let a=(t=eD(r.window,r.range),"number"==typeof(i=s)?Math.abs(i-t[0])<Math.abs(i-t[1])?0:1:eC.E.less(eC.E.absDifference(eR,t[0],i),eC.E.absDifference(eA,t[1],i))?0:1),o=e=>{let t=this.getModel();this.setModel(sq(t,"range",a,e))};o(s),sb(n,e=>{let t=this.getTargetValue(e);void 0!==t&&o(t)})}),sv(e,"adjust-window-via-drag",e=>{let t=e.detail,i=this.getTargetFraction(t),n=this.getWindowLerp(i),r=i<.5?0:1,s=e=>{let t=this.getModel();this.setModel(sq(t,"window",r,e))};sb(t,e=>{let t=this.getModel().window,i=this.getTargetFraction(e);0===r?s(eT([n,t[1]],this.dataType,-i/(1-i))):s(eT([t[0],n],this.dataType,1/i))})}),sv(e,"zoom-via-wheel",e=>{let t=e.detail,i=sS(t),n=this.getTargetFraction(t),{dataType:r}=this,s=this.getModel(),a=eT(s.window,r,n*(1-i)),o=eT(s.window,r,(1-n)*i+n);this.setModel({...s,window:[a,o],range:s.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return eT(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(Number.isFinite(t))return this.getWindowLerp(t)}}let sW=Symbol("histogramSamplerTexture");function sq(e,t,i,n,r=!1){let s={...e},a=e[t];if(s[t]=[a[0],a[1]],s[t][i]=n,"window"===t&&eI(n,a[1-i])*(2*i-1)<0&&(s[t][1-i]=n),"range"===t&&r){let t=[e.window[0],e.window[1]];for(let e=0;e<2;++e)eI(n,t[e])*(2*e-1)>0&&(t[e]=n);s.window=t}return s}let sH=255;class sJ extends iL{parent;get drawOrder(){return 100}controller;constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.dataValuesBuffer=this.registerDisposer(nT(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(6*sH);for(let t=0;t<sH;++t)for(let i=0;i<6;++i)e[6*t+i]=t;return e})).value,this.lineShader=this.registerDisposer(sz(this.gl,sW)),this.regionCornersBuffer=nD(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{let e=new ny(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel"),this.controller=this.registerDisposer(new sj(t,e.dataType,()=>e.trackable.value,t=>{e.trackable.value=t}))}dataValuesBuffer;lineShader;regionCornersBuffer;regionShader;drawIndirect(){let{lineShader:e,gl:t,regionShader:i,parent:{dataType:n,trackable:{value:r}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{i.bind(),t.uniform4f(i.uniform("uColor"),.2,.2,.2,1);let e=eE(r.window,r.range[0]),s=eE(r.window,r.range[1]),a=eB(n,r.window);t.uniform2f(i.uniform("uBounds"),Math.min(e,s)*a,Math.max(e,s)*a+(1-a));let o=i.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(o,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(o)}if(this.parent.histogramSpecifications.producerVisibility.visible){var s;let{renderViewport:i}=this;e.bind(),sT(e,{width:i.logicalWidth,height:i.logicalHeight},1);let a=e.textureUnit(sW);t.uniform1f(e.uniform("uBoundsFraction"),eB(n,r.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+a),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),nP(t);let o=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(o,1,WebGL2RenderingContext.UNSIGNED_BYTE),s=1,sC(t,sH,1),t.disableVertexAttribArray(o),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function sK(){}class sZ extends iL{parent;shaderOptions;constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=nD(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let i=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=nC(this,this.gl,{...i,memoizeKey:{id:"colorLegendShader",base:i.memoizeKey},defineShader:(e,t,n)=>{var r,s,a;e.addOutputBuffer("vec4","v4f_fragData0",0),e.addAttribute("vec2","aVertexPosition"),e.addUniform("float","uLegendOffset"),e.addVarying("float","vLinearPosition"),e.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let o=this.parent.dataType,l=rn(o);e.addFragmentCode((r=e,s="ng_colorLegendLerp",[rr[a=o],rw(r,s,a),rS[a],`
${rn(a)} ${s}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${s});
}
`])),e.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${l} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${l} getDataValue(int dummyChannel) {
  return getDataValue();
}
${l} getInterpolatedDataValue() {
  return getDataValue();
}
${l} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),i.defineShader(e,t,n)}})}shaderGetter;cornersBuffer;drawIndirect(){let e=this.shaderGetter(sK),{shader:t}=e;if(null===t)return;this.setGLLogicalViewport();let{gl:i}=this;i.clearColor(0,0,0,0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),i.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:n}},dataType:r}=this.parent;rE(t,"ng_colorLegendLerp",this.parent.dataType,n);let s=function(e,t){switch(e){case ec.FLOAT32:return 0;case ec.UINT64:return .5/eC.E.absDifference(eR,t[0],t[1]).toNumber();default:return .5/Math.abs(t[0]-t[1])}}(r,n);i.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(s)?s:0),i.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),i.disable(WebGL2RenderingContext.DEPTH_TEST),i.disable(WebGL2RenderingContext.STENCIL_TEST);let a=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(a,2,WebGL2RenderingContext.FLOAT),i.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),i.disableVertexAttribArray(a)}isReady(){return!0}}function sY(e,t){let i=document.createElement("input");return i.addEventListener("focus",()=>{i.select()}),i.classList.add("neuroglancer-invlerp-widget-bound"),i.classList.add(`neuroglancer-invlerp-widget-${e}-bound`),i.type="text",i.spellcheck=!1,i.autocomplete="off",i.title="range"===e?`Data value that maps to ${t}`:`${0===t?"Lower":"Upper"} bound for distribution`,i}function sX(e,t,i){let n;let r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${e}-bounds`);let s=[sY(e,0),sY(e,1)];for(let n=0;n<2;++n){let r=s[n];r.addEventListener("input",()=>{sQ(r)}),r.addEventListener("change",()=>{let s=i.value,a=s[e];try{let a=eM(t,r.value);i.value=sq(s,e,n,a,!0)}catch{s0(r,a[n])}})}return r.appendChild(s[0]),r.appendChild(s[1]),"range"===e&&((n=[document.createElement("div"),document.createElement("div"),document.createElement("div")])[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(n[0],s[0]),r.insertBefore(n[1],s[1]),r.appendChild(n[2])),{container:r,inputs:s,spacers:n}}function sQ(e){sA(e,Math.max(1,e.value.length+.1))}function s0(e,t){let i;i=t instanceof eC.E||Number.isInteger(t)?t.toString():t.toPrecision(6),e.value=i,sQ(e)}function s1(e){let t=e.value,{range:i}=t;e.value={...t,range:[i[1],i[0]]}}class s2 extends s_{display;dataType;trackable;histogramSpecifications;histogramIndex;legendShaderOptions;cdfPanel;boundElements;invertArrows;autoRangeFinder;get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){s1(this.trackable)}constructor(e,t,i,n,r,s,a){super(e),this.display=t,this.dataType=i,this.trackable=n,this.histogramSpecifications=r,this.histogramIndex=s,this.legendShaderOptions=a,this.cdfPanel=this.registerDisposer(new sJ(this)),this.boundElements={range:sX("range",i,n),window:sX("window",i,n)},this.registerDisposer(r.visibility.add(this.visibility));let{element:o,boundElements:l}=this;if(void 0!==a){let e=this.registerDisposer(new sZ(this));o.appendChild(e.element)}let d=e=>{let t=sV({svg:e,title:"Invert range",onClick:()=>{this.invertRange()}});return l.range.spacers[1].appendChild(t),t};this.invertArrows=[d(sL),d(sP)],o.appendChild(l.range.container),o.appendChild(this.cdfPanel.element),o.classList.add("neuroglancer-invlerp-widget"),o.appendChild(l.window.container),this.autoRangeFinder=this.registerDisposer(new sO(this)),this.updateView(),this.registerDisposer(n.changed.add(this.registerCancellable((0,iS.H)(()=>this.updateView())))),this.registerDisposer(this.display.updateFinished.add(()=>{this.autoRangeFinder.maybeAutoComputeRange()}))}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:i}=this;for(let i=0;i<2;++i)s0(e.range.inputs[i],t.range[i]),s0(e.window.inputs[i],t.window[i]);let n=eI(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=n?"row-reverse":"row";let r=eD(t.window,t.range),s=e.range.spacers,a=eB(i,t.window),o=eE(t.window,r[n?1:0])*a,l=eE(t.window,r[n?0:1])*a+(1-a);s[n?2:0].style.width=`${100*o}%`,s[n?0:2].style.width=`${(1-l)*100}%`;let{invertArrows:d}=this;d[n?1:0].style.display="",d[n?0:1].style.display="none"}}class s3 extends s_{display;watchableDataType;trackable;histogramSpecifications;histogramIndex;legendShaderOptions;invlerpWidget;constructor(e,t,i,n,r,s,a){super(e),this.display=t,this.watchableDataType=i,this.trackable=n,this.histogramSpecifications=r,this.histogramIndex=s,this.legendShaderOptions=a,this.invlerpWidget=this.makeInvlerpWidget(),this.registerDisposer(i.changed.add(()=>{sI(this.element),this.invlerpWidget.dispose(),this.invlerpWidget=this.makeInvlerpWidget()}))}get dataType(){return this.watchableDataType.value}disposed(){this.invlerpWidget.dispose(),super.disposed()}makeInvlerpWidget(){let{dataType:e}=this,t=new s2(this.visibility,this.display,e,this.trackable,this.histogramSpecifications,this.histogramIndex,this.legendShaderOptions);return this.element.appendChild(t.element),t}}let s4=sh.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function s6(e,t){e.bindInputEventMap(s4),e.bindAction("adjust-contrast-via-wheel",e=>{e.stopPropagation();let i=sS(e.detail);!function(e,t,i){let n=t.value,r=eT(n.range,e,.5-i/2),s=eT(n.range,e,.5+i/2);t.value={...n,range:[r,s]}}(t.dataType,t.trackable,i)}),e.bindAction("adjust-via-drag",e=>{e.stopPropagation();let i=e.detail.screenX,n=e.detail.screenY,r=t.trackable.value.range,s=r,a=i,o=n;sb(e.detail,e=>{let l=t.trackable.value.range,d=e.screenX,u=e.screenY;!eO(t.dataType,l,s)&&(r=l,i=a,n=o),!function(e,t,i,n,r){let s=Math.exp(r),a=t.value,o=eT(i,e,.5-s/2+n),l=eT(i,e,.5+s/2+n);t.value={...a,range:[o,l]}}(t.dataType,t.trackable,r,(u-n)*2/screen.height,(d-i)*4/screen.width),s=t.trackable.value.range,a=d,o=u})}),e.bindAction("invert-range",e=>{e.stopPropagation(),s1(t.trackable)})}i("5838");var s5=i("5369"),s8=i("6434"),s7=i("9730");i("9651");var s9=i("5501");function ae(e={}){return sV({svg:s9,...e})}function at(){if(void 0===r){(r=document.createElement("ul")).id="neuroglancer-status-container";let e=document.getElementById("neuroglancer-container");e?e.appendChild(r):document.body.appendChild(r)}return r}class ai{element;modalElementWrapper;timer;visibility=!0;constructor(e=!1,t=!1){let i=document.createElement("li");this.element=i,!0===e&&(e=200),this.setModal(t),!1!==e?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null}[Symbol.dispose](){this.dispose()}dispose(){this.modalElementWrapper?s.removeChild(this.modalElementWrapper):r.removeChild(this.element),null!==this.timer&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setModal(e){if(e){if(void 0===this.modalElementWrapper){let e=document.createElement("div"),t=ae({title:"Dismiss",onClick:()=>{this.setModal(!1)}});t.classList.add("neuroglancer-dismiss-modal"),e.appendChild(t),e.appendChild(this.element),this.modalElementWrapper=e,this.applyVisibility(),(function(){if(void 0===s){(s=document.createElement("ul")).id="neuroglancer-status-container-modal";let e=document.getElementById("neuroglancer-container");e?e.appendChild(s):document.body.appendChild(s)}return s})().appendChild(e)}}else void 0!==this.modalElementWrapper?(s.removeChild(this.modalElementWrapper),this.modalElementWrapper=void 0,at().appendChild(this.element)):null===this.element.parentElement&&at().appendChild(this.element)}applyVisibility(){let e=this.visibility?"":"none";this.element.style.display=e;let{modalElementWrapper:t}=this;void 0!==t&&(t.style.display=e)}setVisible(e){null!==this.timer&&(clearTimeout(this.timer),this.timer=null),e!==this.visibility&&(this.visibility=e,this.applyVisibility())}static forPromise(e,t){let i=new ai(t.delay);i.setText(t.initialMessage);let n=i.dispose.bind(i);return e.then(n,e=>{let n;n=e instanceof Error?e.message:""+e;let{errorPrefix:r=""}=t;i.setErrorMessage(r+n),i.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new ai;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let i=ai.showMessage(e);return window.setTimeout(()=>i.dispose(),t),i}}i("6700");let an=[];function ar(e,t){let i=function(){if(void 0===a){let e=a=document.createElement("div");e.classList.add("neuroglancer-drag-status"),document.body.appendChild(e)}return a}();sI(i),0===e.clientX&&0===e.clientY||(e.clientX<window.innerWidth/2?(i.style.left="auto",i.style.right="0px"):(i.style.right="auto",i.style.left="0px")),"string"==typeof t?i.appendChild(document.createTextNode(t)):i.appendChild(t()),i.style.display=""}function as(e,t){(0,Y.dr)(an,i=>i.target!==e||i.operation!==t||(i.leaveHandler?.(),!1))}function aa(e,t,i,n,r){as(t,i),an.push({target:t,operation:i,status:n,leaveHandler:r}),ar(e,n)}function ao(e,t,i){as(t,i);let n=0===an.length?void 0:an[an.length-1];void 0===n?void 0!==a&&(sI(a),a.style.display="none"):ar(e,n.status)}i("3395");function al(e){f=e}function ad(e){f===e&&(f=void 0)}var au=i("2831"),ac=i("6235");let ah=/^(\s*)(?:(\+|-)|([a-zA-Z]+):(?:("(?:[^"\\]|\\.)*")|([^\s"/][^\s"]*)|\/((?:[^/\\]|\\.)*)\/)(?=$|\s))/;function ap(e){let t,i,n=0,r=e,s={clauses:[]},a=[],o=()=>{void 0!==t&&(0===t.terms.length?(!1===t.include&&a.push({range:{begin:t.range.begin,end:n},message:"Exclusion clause must have at least one term"}),t.range.end=n):t.range.end=t.terms[t.terms.length-1].range.end,s.clauses.push(t))};for(;;n=i){let r;let s=e.match(ah);if(null===s)break;let l=s[0].length;i=n+l,e=e.substring(l);let d=s[1].length,u=s[2];if(void 0!==u){o(),t={range:{begin:n+d,end:-1},include:"+"===u,terms:[]};continue}let c=s[3];void 0===t?t={range:{begin:n+d,end:-1},include:!0,terms:[]}:void 0!==t.terms.find(e=>e.property===c)&&a.push({range:{begin:n+d,end:n+d+c.length},message:`Property ${JSON.stringify(c)} cannot be constrained by more than one term in a clause`});let h=s[4];if(void 0!==h)r={equals:JSON.parse(h)};else{let e=s[5];if(void 0!==e)r={equals:e};else try{r={regexp:RegExp(s[6],"i")}}catch(e){a.push({range:{begin:n+d+c.length+2,end:i-1},message:e.message}),r={equals:""}}}t.terms.push({range:{begin:n+d,end:i},property:c,predicate:r})}o();{let t=e.match(/^\s*/);null!==t&&(n+=t[0].length)}return{raw:r,query:s,errors:a,endOffset:n}}function ag(e,t){return"equals"in e?e.equals===t:null!==t.match(e.regexp)}let am=/^([a-zA-Z]+):/;function af(e){let t=Array.from(e);return t.sort((e,t)=>(0,ac.B)(e[0],t[0])),t}function av(e,t){return e.dataTransfer.dropEffect=t,o=t,t}function ay(){return o}function ab(e,t,i){let n;n=e.shiftKey?"copy":e.ctrlKey&&i?"move":t;let r="",s=e=>{""!==r&&(r+=", "),r+=e};return"none"!==t&&n!==t&&s(e.shiftKey?`release SHIFT to ${t}`:`release CONTROL to ${t}`),"copy"!==n&&s("hold SHIFT to copy"),"move"!==n&&i&&"move"!==t&&s("hold CONTROL to move"),{dropEffect:n,dropEffectMessage:r}}let aS=/^[A-Z]$/;class aw extends ef.gj{tool;inputEventMapBinder;constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(sv(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){let{globalBinder:e}=this.tool;this===e.activeTool_&&e.deactivate_()}}class aC extends ef.gj{localBinder;toggle;changed;unbound;keyBinding;savedJsonString;get context(){return this.localBinder.context}get globalBinder(){return this.localBinder.globalBinder}constructor(e,t=!1){super(),this.localBinder=e,this.toggle=t,this.changed=new ez.MZ,this.unbound=new ez.MZ,this.keyBinding=void 0,this.savedJsonString=void 0}renderInPalette(e){}unbind(){let{keyBinding:e}=this;void 0!==e&&this.localBinder.set(e,void 0),this.unbound.dispatch()}}class ax extends aC{layer;constructor(e,t=!1){super(e.toolBinder,t),this.layer=e}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}renderInPalette(e){this.description;let t=document.createElement("div");return t.innerHTML=this.description,t}}class aE extends ef.gj{layer;changed;constructor(e){super(),this.layer=e,this.changed=new ez.MZ}get context(){return this.layer}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}}function aT(e,t){let i;if(void 0===t)return;"string"==typeof t&&(t={type:t}),(0,eb.PT)(t);let n=(0,eb.uq)(t,"type",eb.ZE),r=e;for(;;){if(null===(r=Object.getPrototypeOf(r)))return;if(void 0!==(i=aD.get(r)?.get(n)?.getter))break}return i(e,t)}let ak=new Map,aD=new Map;function aP(e,t){ak.set(e,t)}function aL(e,t,i,n){let{prototype:r}=e,s=aD.get(r);void 0===s&&(s=new Map,aD.set(r,s)),s.set(t,{getter:i,lister:n})}class aI extends ef.gj{layer;changed;value_;get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),void 0!==e&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;void 0!==e&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=function(e,t){if(void 0===t)return;"string"==typeof t&&(t={type:t}),(0,eb.PT)(t);let i=(0,eb.uq)(t,"type",eb.ZE),n=ak.get(i);if(void 0===n)throw Error(`Invalid tool type: ${JSON.stringify(t)}.`);return n(e,t)}(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(void 0!==e)return e.toJSON()}constructor(e){super(),this.layer=e,this.changed=new ez.MZ}}class aR extends ef.gj{inputEventMapBinder;toolPaletteState;bindings;changed;activeTool_;queuedTool;debounceDeactivate;localBinders;localBindersChanged;constructor(e,t){super(),this.inputEventMapBinder=e,this.toolPaletteState=t,this.bindings=new Map,this.changed=new ez.MZ,this.debounceDeactivate=this.registerCancellable((0,ic.Z)(()=>{this.deactivate_(),this.reactivateQueuedTool()},100)),this.localBinders=new Set,this.localBindersChanged=new ez.MZ}get(e){return this.bindings.get(e)}deleteBinding(e){let t=e.keyBinding;e.keyBinding=void 0,this.bindings.delete(t);let i=e.localBinder;i.bindings.delete(t);let{jsonToKey:n}=i,{savedJsonString:r}=e;n.get(r)===t&&n.delete(r),this.destroyTool(e)}toolJsonMaybeChanged(e){let{keyBinding:t}=e;if(void 0===t)return;let i=JSON.stringify(e.toJSON());if(i===e.savedJsonString)return;let n=e.localBinder;for(n.jsonToKey.delete(e.savedJsonString);;){let r=n.jsonToKey.get(i);if(n.jsonToKey.set(i,t),e.savedJsonString=i,void 0===(t=r))break;let s=JSON.stringify((e=n.bindings.get(t)).toJSON());if(s===i){this.deleteBinding(e);break}i=s}n.changed.dispatch(),this.changed.dispatch()}set(e,t){let{bindings:i}=this,n=i.get(e);if(void 0!==n&&(this.deleteBinding(n),n.localBinder.changed.dispatch()),void 0!==t){let n=t.localBinder,r=JSON.stringify(t.toJSON());t.savedJsonString=r;let s=n.jsonToKey.get(r);if(void 0!==s){let e=n.bindings.get(s);this.deleteBinding(e)}n.bindings.set(e,t),t.keyBinding=e,n.jsonToKey.set(r,e),i.set(e,t),n.changed.dispatch(),t.changed.add(()=>{this.toolJsonMaybeChanged(t)})}this.changed.dispatch()}activate(e,t){if(void 0===(t=t||this.get(e))){this.deactivate_();return}this.debounceDeactivate.cancel();let i=this.activeTool_;if(t.toJSON()===i?.tool.toJSON()){t.toggle&&this.deactivate_();return}void 0!==i&&(i.tool.toggle&&!t.toggle&&(this.queuedTool=i.tool),this.deactivate_());let n=new aw(t,this.inputEventMapBinder);if(this.activeTool_=n,!t.toggle){let t=`Key${e}`;n.registerEventListener(window,"keydown",e=>{e.stopPropagation(),e.preventDefault()}),n.registerEventListener(window,"keyup",e=>{e.code===t&&this.debounceDeactivate()}),n.registerEventListener(window,"blur",()=>{this.debounceDeactivate()})}return t.activate(n),t}reactivateQueuedTool(){if(this.queuedTool){let e=new aw(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){this.queuedTool===e&&(this.queuedTool=void 0),this.activeTool_?.tool===e&&this.deactivate_(),e.dispose()}disposed(){for(let e of(this.deactivate_(),super.disposed(),this.bindings.values()))e.dispose()}deactivate_(){this.debounceDeactivate.cancel();let e=this.activeTool_;void 0!==e&&(this.activeTool_=void 0,e.dispose())}}class aA extends ef.gj{context;globalBinder;bindings;jsonToKey;changed;constructor(e,t){super(),this.context=e,this.globalBinder=t,this.bindings=new Map,this.jsonToKey=new Map,this.changed=new ez.MZ,t.localBinders.add(this),t.localBindersChanged.dispatch()}getSortOrder(){return Number.NEGATIVE_INFINITY}disposed(){this.globalBinder.localBinders.delete(this),this.globalBinder.localBindersChanged.dispatch(),this.clear(),super.disposed()}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let i=aT(this.context,t);void 0!==i&&this.set(e,i)}removeJsonString(e){let t=this.jsonToKey.get(e);void 0!==t&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(0===e.size)return;let t={};for(let[i,n]of e)t[i]=n.toJSON();return t}getCommonToolProperties(){return{}}convertLocalJSONToPaletteJSON(e){return e}deleteTool(e){let{globalBinder:t,bindings:i,jsonToKey:n}=this,r=i.get(e);r&&(i.delete(e),t.bindings.delete(e),n.delete(JSON.stringify(r.toJSON())),t.destroyTool(r),t.changed.dispatch(),this.changed.dispatch())}clear(){let{globalBinder:e,bindings:t}=this;if(0!==t.size){for(let[i,n]of t)n.keyBinding=void 0,e.bindings.delete(i),e.destroyTool(n);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(void 0!==e)for(let[t,i]of((0,eb.PT)(e),Object.entries(e))){if(!t.match(aS))throw Error(`Invalid tool key: ${JSON.stringify(t)}`);let e=aT(this.context,i);if(void 0===e)return;this.set(t,e)}}}class aM extends aA{getCommonToolProperties(){return{layer:this.context.managedLayer.name,layerType:this.context.managedLayer.layer?.type}}convertLocalJSONToPaletteJSON(e){let t=e;return"string"==typeof t&&(t={type:t}),{layer:this.context.managedLayer.name,...t}}getSortOrder(){let{managedLayer:e}=this.context;return e.manager.layerManager.updateNonArchivedLayerIndices(),this.context.managedLayer.nonArchivedLayerIndex}}function aN(e,t,i=!1){let{paletteState:n,dragElement:r}=e;if(void 0===n||void 0===r)return;let s="neuroglancer-tool-to-be-removed";"move"===t&&!1===i?r.classList.add(s):r.classList.remove(s)}class aV extends ef.gj{localBinder;toolJson;dragElement;paletteState;element;toolJsonString;constructor(e,t,i,n){super(),this.localBinder=e,this.toolJson=t,this.dragElement=i,this.paletteState=n,this.element=document.createElement("div"),this.toolJsonString=JSON.stringify(t);let{element:r}=this;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.changed.add(this.registerCancellable((0,iS.H)(()=>this.updateView())))),this.updateView(),r.title="click → bind key, dbclick → unbind",r.addEventListener("dblclick",()=>{this.localBinder.removeJsonString(this.toolJsonString)}),aO(this,r,e=>this.localBinder.setJson(e,this.toolJson)),void 0!==i&&(i.draggable=!0,i.addEventListener("dragstart",e=>{var n;aa(e,i,"drag","Drag tool to another tool palette, or to the left/top/right/bottom edge of a layer group to create a new tool palette"),n=this,f=n;let{toolPaletteState:r}=this.localBinder.globalBinder,s=this;r.viewer.sidePanelManager.startDrag({dropAsNewPanel:(e,i)=>{if(r.addNew({location:e}).tools.insert(this.localBinder.convertLocalJSONToPaletteJSON(t)),"move"===i){let{paletteState:e}=this;e?.palette.state.queryDefined.value===!1&&e.palette.state.tools.remove(e.tool)}},getNewPanelDropEffect:e=>{let t=this.paletteState?.palette.state.queryDefined.value===!1,i=ab(e,t?"move":"copy",t);return aN(s,i.dropEffect,!1),{...i,description:"tool",leaveHandler:()=>{aN(s)}}}},e)}),i.addEventListener("dragend",e=>{ao(e,i,"drag"),ad(this);let{toolPaletteState:t}=this.localBinder.globalBinder;t.viewer.sidePanelManager.endDrag(),e.stopPropagation()}))}updateView(){let{localBinder:e}=this,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t??" "}}function aO(e,t,i){let n;t.addEventListener("mousedown",t=>{if(0===t.button&&void 0===n)t.preventDefault(),t.stopPropagation(),n=new ef.gj,e.registerDisposer(n),n.registerDisposer(new ai(!1)).setText("Press A-Z to bind key"),n.registerEventListener(window,"keydown",e=>{let{code:t}=e,n=t.match(/^Key([A-Z])$/);if(null!==n)e.stopPropagation(),e.preventDefault(),i(n[1])},{capture:!0}),n.registerEventListener(window,"mouseup",t=>{0===t.button&&void 0!==n&&(t.preventDefault(),t.stopPropagation(),e.unregisterDisposer(n),n.dispose(),n=void 0)})}),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation()})}function a_(e,t,i){let n=document.createElement("div");n.classList.add("neuroglancer-tool-button"),n.appendChild(e.registerDisposer(new aV(t,i.toolJson,i.dragElement??n)).element);let r=document.createElement("div");r.classList.add("neuroglancer-tool-button-label");let s=i.label;return void 0!==s&&(r.textContent=s),i.title&&(r.title=i.title),n.appendChild(r),n}function aF(e){let t=e.registerDisposer(new ai(!1));t.element.classList.add("neuroglancer-tool-status");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-content"),t.element.appendChild(i);let{inputEventMapBinder:n}=e;return e.inputEventMapBinder=(e,i)=>{let r=document.createElement("div");r.textContent=e.describe(),r.classList.add("neuroglancer-tool-status-bindings"),t.element.appendChild(r),n(e,i)},{message:t,content:i}}function aB(e){let{message:t,content:i}=aF(e),n=document.createElement("div");n.classList.add("neuroglancer-tool-status-header");let r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header-container"),r.appendChild(n),i.appendChild(r);let s=document.createElement("div");return s.classList.add("neuroglancer-tool-status-body"),i.appendChild(s),{message:t,body:s,header:n}}function*aU(e,t,i,n,r){for(let s of t(e.context,r))(function(e,t){for(let i of t){let t=e[i.property];if("string"!=typeof t||!ag(i.predicate,t))return!1}return!0})(s,i)&&(yield{...e.convertLocalJSONToPaletteJSON(s),...n})}function a$(e,t,i){let n=new Map,r=Array.from(e.localBinders);for(let e of(r.sort((e,t)=>e.getSortOrder()-t.getSortOrder()),r))for(let{include:r,terms:s}of t.clauses)for(let t of function*(e,t,i){let n=t.find(e=>"type"===e.property)?.predicate,r=void 0!==n&&"equals"in n?n.equals:void 0,s=e.getCommonToolProperties();for(let e of t){let{property:t}=e;if(t in s&&!ag(e.predicate,s[t]))return}let a=t.filter(e=>!(e.property in s)&&"type"!==e.property),{context:o}=e,l=o;for(;null!==(l=Object.getPrototypeOf(l));){;let t=aD.get(l);if(void 0!==t){if(void 0!==r){let n=t.get(r)?.lister;if(void 0===n)continue;yield*aU(e,n,a,s,i);break}for(let[r,{lister:o}]of t)if(void 0!==o){if(void 0!==n&&!ag(n,r))continue;yield*aU(e,o,a,s,i)}}}}(e,s,i)){let e=JSON.stringify(t);r?n.set(e,t):n.delete(e)}return n}function aG(e,t="text/plain"){let i=!1,n=(0,ef.H0)(document,"copy",n=>{let{clipboardData:r}=n;null!==r&&(r.setData(t,e),i=!0),n.stopPropagation(),n.preventDefault()},!0);try{document.execCommand("copy")}finally{n()}return i}let az=new Z.SN(0);window.addEventListener("keydown",e=>{az.value=sl(e)}),window.addEventListener("keyup",e=>{az.value=sl(e)});let aj=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),aW=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class aq extends ef.gj{target;eventMap;modifierShortcutsAreGlobal;allShortcutsAreGlobal;allowSpaceKeyOnButtons;shouldIgnore;constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.shouldIgnore=void 0,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){if(this.shouldIgnore?.(t))return!0;let i=t.target,{tagName:n}=i;if(i===this.target)return!1;let r="TEXTAREA"===n||"INPUT"===n||"BUTTON"===n||"SELECT"===n,s=!r&&(i.isContentEditable||i.ownerDocument&&"on"===i.ownerDocument.designMode);if(!r&&!s||this.allShortcutsAreGlobal||aj.has(e))return!1;if(s||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey))return!0;if("INPUT"===n&&aW.has(i.type))return"enter"!==e;if("INPUT"===n||"BUTTON"===n)return!this.allowSpaceKeyOnButtons&&"space"===e;return!0}handleKeyDown(e){let t=function(e){return e.code.toLowerCase()}(e);if(!this.shouldIgnoreEvent(t,e))sf(t,e,e,this.eventMap)}}i("677");class aH extends ef.gj{element;constructor(e,t){super(),this.element=sV({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add("dark"===t.backgroundScheme?"dark-background":"light-background");let i=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(i)),i()}}var aJ=i("6516");function aK(e={}){return sV({svg:aJ,...e})}class aZ extends ef.gj{redraw;constructor(e){super(),this.redraw=e}}class aY extends ef.gj{model;render;visibility;element;generation;currentViewDisposer;debouncedUpdateView;debouncedForceUpdateView;constructor(e,t,i=new i4(i4.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=i,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable((0,iS.H)(()=>this.updateView())),this.debouncedForceUpdateView=()=>{this.generation=-1,this.debouncedUpdateView()},this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(i.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.disposeCurrentView();let i=this.currentViewDisposer=new aZ(this.debouncedForceUpdateView);this.render(e.value,this.element,i),this.generation=t}disposeCurrentView(){let{currentViewDisposer:e}=this;void 0!==e&&e.dispose(),sI(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}class aX extends ef.gj{model;element;valueIndexMap;constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new Map;let{element:t,valueIndexMap:i}=this,n=0;for(let r of Object.keys(e.enumType))if(Number.isNaN(Number(r))){let s=document.createElement("option");s.textContent=s.value=r.toLowerCase(),t.appendChild(s),i.set(e.enumType[r],n),++n}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",e=>{e.preventDefault(),e.stopPropagation(),this.adjustViaWheel(e)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:i}=e;i>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):i<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}class aQ extends ef.gj{model;element;inputElement;validator;constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let{validator:i,label:n}=t,{element:r,inputElement:s}=this;void 0===i&&(i=e instanceof Z.TU?e.validator:e=>e),this.validator=i,void 0!==n&&(r.textContent=n),r.appendChild(s),r.className="neuroglancer-number-input",s.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(s,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){sR(this.element),super.disposed()}}function a0(e,t,i,n){return Math.floor((e-t)*(n-1)/(i-t))}i("389");class a1 extends ef.gj{position;dimensionId;orientation;element;visible;dragging;tickWidth;barWidth;barRightMargin;canvasWidth;constructor(e,t,i="column"){let n,r,s;super(),this.position=e,this.dimensionId=t,this.orientation=i,this.element=document.createElement("div"),this.visible=!0,this.dragging=new Z.SN(!1),this.tickWidth="column"===i?10:5,this.barWidth="column"===i?15:10,this.barRightMargin="column"===i?10:2,this.canvasWidth=this.tickWidth+this.barWidth+this.barRightMargin;let a=this.element;a.classList.add("neuroglancer-position-dimension-plot"),a.dataset.orientation=i;let o=document.createElement("canvas"),l=o.getContext("2d"),d=document.createElement("div"),u=document.createElement("div");u.appendChild(d);let c=document.createTextNode("");d.appendChild(c);let h=document.createElement("div"),p=document.createElement("div");u.classList.add("neuroglancer-position-dimension-plot-lowerbound"),h.classList.add("neuroglancer-position-dimension-plot-upperbound"),p.classList.add("neuroglancer-position-dimension-plot-hoverposition"),a.appendChild(u),a.appendChild(h),a.appendChild(p),a.appendChild(o);let g=()=>{let e,t,a,u;let g=this.position.coordinateSpace.value,m=g.ids.indexOf(this.dimensionId);if(-1===m)return;"column"===i?(e=100,o.width=this.canvasWidth,o.height=e,h.style.marginTop=`${e-1}px`):(e=o.clientWidth,o.width=e,o.height=this.canvasWidth);let f=function(e,t,i){let{boundingBoxes:n,bounds:r}=e,[s,a]=t_(r,t);if(s=Math.floor(s),a=Math.floor(a-1),!Number.isFinite(s)||!Number.isFinite(a))return;let o=[],l=e=>a0(e,s,a,i),{rank:d}=e;for(let e of n){let n=t$(e,t,d);void 0!==n&&(n.lower=Math.max(0,l(n.lower)),n.upper=Math.min(i-1,l(Math.ceil(n.upper-1))),o.push(n))}return o.sort((e,t)=>{let i=e.lower-t.lower;return 0!==i?i:t.upper-t.upper}),(0,Y.dr)(o,(e,t)=>{if(0===t)return!0;let i=o[t-1];return i.lower!==e.lower||i.upper!==e.upper}),{lowerBound:s,upperBound:a,normalizedBounds:o}}(g,m,e);if(void 0===f||g.bounds.lowerBounds[m]+1===g.bounds.upperBounds[m]){this.element.style.display="none",this.visible=!1;return}this.element.style.display="",this.visible=!0;let{lowerBound:v,upperBound:y}=f;n=v,r=y,c.textContent=v.toString(),h.textContent=y.toString(),"column"!==i&&(a=d.clientWidth,t=Math.max(a,u=h.clientWidth)/2,o.style.marginLeft=`${t}px`,o.style.marginRight=`${t}px`,h.style.position="relative",h.style.left=`${e+t-u/2}px`,d.style.marginLeft=`${t-a/2}px`),this.drawDimensionBounds(o,l,f);let b=this.position.value[m],S=(t,n)=>{if(void 0!==t&&t>=v&&Math.floor(t)<=y){l.fillStyle=n;let r=a0(t,v,y,e);return"column"===i?l.fillRect(0,r,this.canvasWidth,1):l.fillRect(r,0,1,this.canvasWidth),r}},w=S(b,"#f66"),C=this.dragging.value,x=C?w:S(s,"#66f");if(void 0!==x){let n,r,a;p.textContent=(C?Math.floor(b):s).toString();let o="column"===i?d.clientHeight:d.clientWidth,l="column"===i?h.clientHeight:h.clientWidth;if("column"!==i){n=p.clientWidth,x+=t,x-=n/2;let i=e+t-l/2-n;r=(x=Math.max(0,x))>t+o/2,a=x<i}else r=x>o,a=x<e-l;d.style.visibility=r?"":"hidden",h.style.visibility=a?"":"hidden",p.style.display="",p.style.visibility="visible","column"===i?p.style.marginTop=`${x}px`:p.style.marginLeft=`${x}px`}else d.style.visibility="",p.style.display="none",h.style.visibility=""},m=this.registerCancellable((0,iS.H)(g));this.registerDisposer(this.position.changed.add(m));let f=e=>{let t;if(void 0===n||void 0===r)return;let s=o.getBoundingClientRect();return Math.round((t=Math.min(1,t=Math.max(0,t="column"===i?(e.clientY-s.top)/s.height:(e.clientX-s.left)/s.width)))*(r-n))+n},v=e=>{let t=this.position.coordinateSpace.value,i=t.ids.indexOf(this.dimensionId);if(-1===i)return;let n=f(e);if(void 0===n)return;let{position:r}=this,s=r.value;!t.bounds.voxelCenterAtIntegerCoordinates[i]&&(n+=.5),s[i]=n,r.value=s};o.addEventListener("pointermove",e=>{s=f(e),m()}),o.addEventListener("pointerleave",()=>{s=void 0,m()}),o.addEventListener("pointerdown",e=>{if(e.preventDefault(),e.stopPropagation(),!e.ctrlKey&&!e.altKey&&!e.metaKey)sb(e,e=>{!this.wasDisposed&&(s=void 0,v(e),m(),this.dragging.value=!0)},()=>{this.dragging.value=!1,m()}),v(e)}),g(),"row"===i&&(o.style.maxWidth="100%",o.style.justifySelf="stretch",new ResizeObserver(g).observe(o))}drawDimensionBounds(e,t,i){let{orientation:n}=this;t.clearRect(0,0,e.width,e.height);let{normalizedBounds:r}=i,s="column"===n?e=>{t.fillRect(0,e,this.tickWidth,1)}:e=>{t.fillRect(e,0,1,this.tickWidth)};for(let{lower:e,upper:i}of(t.fillStyle="#fff",r))s(e),s(i);let a=r.length;t.fillStyle="#ccc";for(let e=0;e<a;++e){let{lower:i,upper:s}=r[e],o=Math.floor(e*this.barWidth/a),l=Math.max(1,this.barWidth/a);"column"===n?t.fillRect(o+this.tickWidth,i,l,s+1-i):t.fillRect(i,o+this.tickWidth,s+1-i,l)}}}let a2="neuroglancer-position",a3=sh.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},"alt+wheel":{action:"adjust-velocity-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),a4=[e=>e.nameElement,e=>e.coordinate,e=>e.scaleElement];function a6(e,t){let i=e.coordinateArrays[t];return void 0===i?i:""!==e.units[t]||1!==e.scales[t]?null:i}class a5{coordinateSpace;id;container;nameContainer;nameElement;scaleContainer;scaleElement;coordinate;coordinateLabel;playButton;pauseButton;coordinateLabelWidth;maxPositionWidth;maxPositionWidthSeen;dropdownOwner;modified;draggingPosition;hasFocus;dimensionIndex;constructor(e,t,i,n){this.coordinateSpace=e,this.id=t,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.playButton=document.createElement("div"),this.pauseButton=document.createElement("div"),this.coordinateLabelWidth=0,this.maxPositionWidth=0,this.maxPositionWidthSeen=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;let{container:r,scaleElement:s,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:d,coordinateLabel:u,playButton:c,pauseButton:h}=this;r.title="",r.classList.add("neuroglancer-position-dimension");let{allowFocus:p,showPlayback:g}=n;p&&(r.draggable=!0,r.tabIndex=-1),this.dimensionIndex=i,r.appendChild(d),r.appendChild(s),d.appendChild(l),d.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(s),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),s.classList.add("neuroglancer-position-dimension-scale"),s.disabled=!0,s.spellcheck=!1,s.autocomplete="off",r.appendChild(a),g&&(c.classList.add("neuroglancer-icon"),h.classList.add("neuroglancer-icon"),c.innerHTML=s8,h.innerHTML=s5,r.appendChild(c),r.appendChild(h)),r.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let m=a6(e,i);if(null!=m){let e=0;for(let t of m.labels)e=Math.max(e,t.length);this.coordinateLabelWidth=e,u.style.width=`${e+2}ch`,r.appendChild(u)}o.required=!0,o.placeholder=" ",u.classList.add("neuroglancer-position-dimension-coordinate-label"),p&&(d.addEventListener("dblclick",e=>{l.disabled=!1,l.focus(),l.select(),e.stopPropagation()}),a.addEventListener("dblclick",e=>{s.disabled=!1,s.focus(),s.select(),e.stopPropagation()}),o.addEventListener("focus",()=>{o.select()}),r.addEventListener("click",e=>{(!(e.target instanceof HTMLInputElement)||e.target.disabled)&&o.focus()}))}}function a8(e,t){let i=t.length;i>e.maxPositionWidthSeen&&(e.maxPositionWidthSeen=i),sA(e.coordinate,Math.max(Math.min(e.maxPositionWidth,e.maxPositionWidthSeen),i))}function a7(e){let{value:t}=e;sA(e),e.parentElement.dataset.isEmpty=""===t?"true":"false"}class a9 extends ef.gj{position;combiner;element;dimensionContainer;coordinateSpace;velocity;singleDimensionId;getToolBinder;allowFocus;showPlayback;showDropdown;dimensionWidgets;dimensionWidgetList;getDimensionIndex(e){return this.position.coordinateSpace.value.ids.indexOf(e)}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let i=e.dropdownOwner,n=this.getToolBinder?.();if(void 0!==n){let r=this.getDimensionIndex(e.id),s=a_(i,n,{toolJson:{type:ot,dimension:e.coordinateSpace.names[r]}});t.appendChild(s)}let r=i.registerDisposer(new a1(this.position,e.id));t.appendChild(r.element);let s=this.velocity?.dimensionVelocity(i,e.id);if(void 0!==s){let n=document.createElement("div");n.classList.add("neuroglancer-position-dimension-playback");let r=document.createElement("div");r.classList.add("neuroglancer-position-dimension-playback-header"),n.appendChild(r),r.appendChild(i.registerDisposer(new aH(this.velocity.playbackEnabled(e.id),{svg:s7,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),r.appendChild(document.createTextNode("Playback")),t.appendChild(n);let a=i.registerDisposer((0,Z.mo)(e=>void 0!==e,[s]));n.appendChild(i.registerDisposer(new aY(a,(e,t,i)=>{if(!e)return;let n=new Z.SN(0);n.changed.add(()=>{let e=n.value,t=s.value;if(void 0!==t)t.velocity!==e&&(s.value={...t,velocity:e})});let r=sV({text:"\xb1",title:"Negate velocity",onClick:()=>{n.value=-n.value}}),a=i.registerDisposer(new aQ(n));a.element.insertBefore(r,a.element.firstChild),a.element.title="Velocity in coordinates per second";let o=document.createElement("span");o.textContent="/s",a.element.appendChild(o),t.appendChild(a.element);let l=new rL.B(r_,r_.STOP),d=()=>{l.value=s.value?.atBoundary??r_.STOP,n.value=s.value?.velocity??0};d(),i.registerDisposer(s.changed.add(d)),l.changed.add(()=>{let e=l.value,t=s.value;if(void 0!==t)t.atBoundary!==e&&(s.value={...t,atBoundary:e})});let u=new aX(l).element;t.appendChild(u),u.title="Behavior when lower/upper bound is reached"})).element)}r.dragging.changed.add(()=>{!1===(e.draggingPosition=r.dragging.value)&&this.updateDropdownVisibility(e)})}openCoordinateArrayDropdown(e,t,i){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:n,labels:r}=i,s=[],a=n.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let i=0;i<a;++i){let a=document.createElement("div");a.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let o=document.createElement("div");o.classList.add("neuroglancer-dimension-dropdown-coordinate");let l=document.createElement("div");l.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),l.textContent=r[i],o.textContent=n[i].toString(),a.appendChild(o),a.appendChild(l),a.addEventListener("click",()=>{let t=this.getDimensionIndex(e.id);if(-1===t)return;let{position:r}=this,s=r.value;s[t]=n[i]+.5,e.modified=!1,r.value=s}),t.appendChild(a),s.push({entryElement:a,coordinateElement:o,labelElement:l})}}openDropdown(e){if(void 0!==e.dropdownOwner||!this.showDropdown)return;let t=this.getDimensionIndex(e.id);if(-1===t)return;this.closeDropdown();let i=e.dropdownOwner=new ef.gj,n=document.createElement("div");n.draggable=!0,n.addEventListener("dragstart",e=>{e.stopPropagation(),e.preventDefault()}),n.addEventListener("pointerenter",()=>{e.hasFocus=!0}),n.tabIndex=-1,e.container.appendChild(n);let r=a6(e.coordinateSpace,t);null==r?this.openRegularDropdown(e,n):this.openCoordinateArrayDropdown(e,n,r),this.widgetWithOpenDropdown=e,i.registerDisposer(()=>{sR(n),e.dropdownOwner=void 0,e.container.dataset.dropdownVisible=void 0,this.widgetWithOpenDropdown=void 0}),i.registerEventListener(document,"pointerdown",t=>{let{target:i}=t;if(!(i instanceof Node&&e.container.contains(i)))this.closeDropdown(e)},{capture:!0})}widgetWithOpenDropdown;closeDropdown(e=this.widgetWithOpenDropdown){if(void 0===e)return;let{dropdownOwner:t}=e;void 0!==t&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let i=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(null===i)break;if(void 0!==i[1]&&document.execCommand("insertText",void 0,i[1]),void 0!==i[2]){let{dimensionWidgetList:n}=this,r=n.indexOf(e);if(-1===r||r+1===n.length)break;let s=t.substring(i[0].length);e=n[r+1],t=s;continue}break}}dragSource;reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:i}=this.position;i.value=ie(i.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t,i){let n;let r=new a5(e,t,i,{allowFocus:this.allowFocus,showPlayback:this.showPlayback}),s=this.getToolBinder?.();if(void 0!==s){let e=this;n={localBinder:s,get toolJson(){return{type:ot,dimension:e.position.coordinateSpace.value.names[e.getDimensionIndex(t)]}}}}for(let e of(void 0===this.singleDimensionId&&(r.container.addEventListener("dragstart",e=>{if(this.dragSource=r,e.stopPropagation(),e.dataTransfer.setData("neuroglancer-dimension",""),aa(e,r.container,"drag","Drag to reorder dimensions, to an existing tool palette, or to the left/right/top/bottom of another panel to create a new tool palette"),void 0!==n)f=n}),r.container.addEventListener("dragenter",e=>{let{dragSource:t}=this;if(void 0===t||t===r)return;let{dimensionWidgetList:i}=this,n=i.indexOf(t),s=i.indexOf(r);-1!==n&&-1!==s&&(e.preventDefault(),this.reorderDimensionTo(s,n))}),r.container.addEventListener("dragend",e=>{this.dragSource===r&&(this.dragSource=void 0),ao(e,r.container,"drag"),void 0!==n&&ad(n)})),this.allowFocus?(r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",e=>{let{relatedTarget:t}=e;if(!(t instanceof Node&&r.container.contains(t)))r.hasFocus=!1,this.updateDropdownVisibility(r)}),r.coordinate.addEventListener("paste",e=>{let t=r.coordinate,i=t.value,{clipboardData:n}=e;if(null===n)return;let s=n.getData("text"),{selectionEnd:a,selectionStart:o}=t;if(0!==o||a!==i.length){null==o&&(o=0),null==a&&(a=0);let e=s.match(/[^\-0-9.]/);null!==e&&(s=s.substring(0,e.index)),s.length>0&&document.execCommand("insertText",void 0,s)}else this.pasteString(r,s);e.preventDefault(),e.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;let e=r.coordinate,t=e.value,{selectionDirection:i,selectionEnd:n,selectionStart:s}=e;null===s&&(s=0),null===n&&(n=s);let a="",o=/[^\-0-9.]/g,l=(a+=t.substring(0,s).replace(o,"")).length,d=(a+=t.substring(s,n).replace(o,"")).length;a+=t.substring(n).replace(o,""),e.value=a,e.selectionStart=l,e.selectionEnd=d,e.selectionDirection=i,a8(r,a),n===s&&n===t.length&&t.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{let{nameElement:e}=r;sA(e),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{let{scaleElement:e}=r;a7(e),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",e=>{let{relatedTarget:t}=e;if(!this.dimensionWidgetList.some(e=>e.coordinate===t))r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",e=>{r.nameElement.disabled=!0;let{relatedTarget:t}=e;if(!this.dimensionWidgetList.some(e=>e.nameElement===t))!this.updateNames()&&this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",e=>{r.scaleElement.disabled=!0;let{relatedTarget:t}=e;if(!this.dimensionWidgetList.some(e=>e.scaleElement===t))!this.updateScales()&&this.forceUpdateDimensions()})):r.coordinate.disabled=!0,sv(r.container,"adjust-via-wheel",e=>{let{deltaY:t}=e.detail;if(0!==t)this.adjustDimensionPosition(r.id,Math.sign(t))}),sv(r.container,"adjust-velocity-via-wheel",e=>{let t=e.detail;this.adjustDimensionVelocity(r,sS(t))}),sv(r.container,"adjust-up",()=>{this.adjustDimensionPosition(r.id,-1)}),sv(r.container,"adjust-down",()=>{this.adjustDimensionPosition(r.id,1)}),a4)){let t=e(r);sv(t,"maybe-tab-forward",t=>{this.handleLeftRightMovement(t,r,1,e)}),sv(t,"maybe-tab-backward",t=>{this.handleLeftRightMovement(t,r,-1,e)}),sv(t,"tab-forward",()=>{this.selectAdjacentField(r,1,e)}),sv(t,"tab-backward",()=>{this.selectAdjacentField(r,-1,e)})}if(sv(r.coordinate,"commit",()=>{this.updatePosition()}),sv(r.nameElement,"commit",()=>{this.updateNames()}),sv(r.scaleElement,"commit",()=>{this.updateScales()}),sv(r.coordinate,"delete-backward",e=>{e.stopPropagation();let{coordinate:t}=r;t.selectionStart===t.selectionEnd&&0===t.selectionStart&&(e.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),this.showPlayback){let e=e=>{this.velocity?.togglePlayback(r.id,e)};r.playButton.addEventListener("click",()=>e(!1)),r.pauseButton.addEventListener("click",()=>e(!0))}return r}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;!e.valid&&void 0===this.singleDimensionId&&(e=tA),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:i}=this;i.length=0;let{names:n,ids:r,scales:s,units:a,bounds:{lowerBounds:o,upperBounds:l}}=e,d=(r,d)=>{let u=o[d],c=l[d],h=Math.max(Number.isFinite(u)?Math.floor(u).toString().length:0,Number.isFinite(c)?Math.ceil(c).toString().length:0),p=t.get(r);void 0===p?(p=this.newDimension(e,r,d),t.set(r,p),p.maxPositionWidthSeen=h):(p.coordinateSpace=e,p.dimensionIndex=d),p.maxPositionWidth=h;let g=n[d];p.nameElement.value=g,p.nameElement.dataset.isValid=void 0,sA(p.nameElement);let m=a6(e,d);void 0===m?p.container.dataset.coordinateArray="none":null===m?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",null===m&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:f,prefix:v,unit:y}=tg(s[d],a[d]),b=`${f}${v}${y}`;return p.scaleElement.value=b,p.scaleElement.dataset.isValid=void 0,a7(p.scaleElement),i.push(p),p.container},{singleDimensionId:u}=this;if(void 0!==u){let e=this.getDimensionIndex(u);-1===e?sM(this.dimensionContainer,[]):sM(this.dimensionContainer,[d(u,e)])}else sM(this.dimensionContainer,r.map(d));for(let[i,n]of t)n.coordinateSpace!==e&&(this.closeDropdown(n),t.delete(i))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,i){let{dimensionWidgetList:n}=this,r=n.indexOf(e);if(-1!==r)for(;;){if((r+=t)<0||r>=n.length)return!1;let e=i(n[r]);if("none"!==e.style.display)return e.disabled=!1,e.focus(),e.selectionStart=0,e.selectionEnd=e.value.length,e.selectionDirection=1===t?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,e=>e.coordinate)}handleLeftRightMovement(e,t,i,n){e.stopPropagation();let r=n(t);if(r.selectionStart===r.selectionEnd&&r.selectionStart===(1===i?r.value.length:0))this.selectAdjacentField(t,i,n)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=Array.from(this.position.coordinateSpace.value.names);for(let i of e)t[i.dimensionIndex]=i.nameElement.value;let i=this.combiner.getRenameValidity(t);for(let t of e)t.nameElement.dataset.isValid=!1===i[t.dimensionIndex]?"false":"true"}updateScaleValidity(e){let t=void 0!==tf(e.scaleElement.value);e.scaleElement.dataset.isValid=t.toString()}constructor(e,t,{copyButton:i=!0,velocity:n,singleDimensionId:r,getToolBinder:s,allowFocus:a=!0,showPlayback:o=!0,showDropdown:l=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new Map,this.dimensionWidgetList=[],this.dragSource=void 0;let{element:d,dimensionContainer:u}=this;if(this.velocity=n,this.singleDimensionId=r,this.getToolBinder=s,this.allowFocus=a,this.showPlayback=o,this.showDropdown=l,this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable((0,iS.H)(()=>this.updateDimensions())))),d.className="neuroglancer-position-widget",u.style.display="contents",d.appendChild(u),i){let t=aK({title:"Copy position to clipboard",onClick:()=>{let e=aG(this.getPositionText());ai.showTemporaryMessage(e?"Position copied to clipboard":"Failed to copy position to clipboard")}});t.addEventListener("dragstart",t=>{t.dataTransfer.setData(a2,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),t.dataTransfer.setData("text",this.getPositionText()),t.stopPropagation()}),t.draggable=!0,d.appendChild(t)}let c=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(e.changed.add(c)),void 0!==n&&this.registerDisposer(n.changed.add(c));let h=e=>{let t=e.target;return!!(t instanceof Element&&t.matches(".neuroglancer-position-dimension-playback *"))||!1};if(a){let e=this.registerDisposer(new aq(d,a3));e.allShortcutsAreGlobal=!0,e.shouldIgnore=h}this.registerDisposer(new sy(d,a3)).shouldIgnore=h,this.registerDisposer(sv(d,"cancel",e=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:t}=e;t instanceof HTMLElement&&t.blur()})),this.updateView()}adjustDimensionPosition(e,t){let i=this.getDimensionIndex(e);if(-1===i)return;this.updatePosition();let{position:n}=this;if(!n.valid)return;let{bounds:r}=n.coordinateSpace.value,s=Float32Array.from(n.value);s[i]=tF(r,i,s[i]+t),this.position.value=s,this.updateView()}adjustDimensionVelocity(e,t){let{velocity:i}=this;void 0!==i&&i.multiplyVelocity(e.id,t)}updatePosition(){if(!this.allowFocus)return;let{position:e}=this,{value:t}=e,i=e.coordinateSpace.value;if(void 0===t)return;let n=!1;for(let e of this.dimensionWidgetList){let{dimensionIndex:r}=e;if(!e.modified)continue;e.modified=!1,n=!0;let s=e.coordinate.value,a=Number(s);Number.isFinite(a)&&(Number.isInteger(a)&&!s.includes(".")&&void 0!==i&&!i.bounds.voxelCenterAtIntegerCoordinates[r]&&(a+=.5),t[r]=a)}n&&(e.value=t)}updateNames(){if(!this.allowFocus)return;let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,i=t.value,n=Array.from(i.names);for(let t of e)n[t.dimensionIndex]=t.nameElement.value;if(this.combiner.getRenameValidity(n).includes(!1))return!1;let r=i.names;if((0,Y.cO)(r,n))return!1;let s=i.timestamps.map((e,t)=>r[t]===n[t]?e:Date.now()),a={...i,names:n,timestamps:s};return t.value=a,!0}updateScales(){if(!this.allowFocus)return;let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,i=t.value,{scales:n,units:r}=i,s=Float64Array.from(n),a=Array.from(r);for(let{dimensionIndex:t,scaleElement:i}of e){let e=tf(i.value);if(void 0===e)return!1;s[t]=e.scale,a[t]=e.unit}if((0,Y.cO)(n,s)&&(0,Y.cO)(r,a))return!1;let o=i.timestamps.map((e,t)=>s[t]===n[t]&&a[t]===r[t]?e:Date.now()),l=tR({valid:i.valid,rank:i.rank,scales:s,units:a,timestamps:o,ids:i.ids,names:i.names,boundingBoxes:i.boundingBoxes,coordinateArrays:i.coordinateArrays});return t.value=l,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(e=>Math.floor(e)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e}}=this;if(void 0===e)return;let t=this.coordinateSpace,{velocity:i}=this;for(let n of this.dimensionWidgetList){let{dimensionIndex:r}=n,s=n.coordinate,a=Math.floor(e[r]),o=a.toString();a8(n,o),s.value=o;let l=a6(t,r),d="";if(null!=l){let{coordinates:e}=l,t=(0,Y.ry)(e,a,(e,t)=>e-t);t!==e.length&&(d=l.labels[t])}if(n.coordinateLabel.textContent=d,this.showPlayback){let e=i?.value?.[r];if(void 0!==e){let t=e.paused;n.playButton.style.display=t?"":"none",n.pauseButton.style.display=t?"none":""}else n.playButton.style.display="none",n.pauseButton.style.display="none"}}}disposed(){this.closeDropdown(),sR(this.element),super.disposed()}}class oe extends ef.gj{element;mouseState;coordinateSpace;tempPosition;constructor(e,t,i){super(),this.element=e,this.mouseState=t,this.coordinateSpace=i,this.tempPosition=Q.R3.create(),e.className="neuroglancer-mouse-position-widget";let n=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(t.changed.add(n)),this.registerDisposer(i.changed.add(n))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:i}}=this;if(t.active&&void 0!==i){let n=t.position,{rank:r,names:s}=i;for(let t=0;t<r;++t)0!==t&&(e+="  "),e+=`${s[t]} ${Math.floor(n[t])}`}this.element.textContent=e}disposed(){sR(this.element),super.disposed()}}let ot="dimension",oi=sh.fromObject({"at:shift?+wheel":{action:"adjust-position-via-wheel"},"at:shift?+alt+wheel":{action:"adjust-velocity-via-wheel"},"shift?+alt?+space":{action:"toggle-playback"},"at:shift?+alt?+mousedown0":{action:"toggle-playback"}});class on extends aC{viewer;dimensionId;get position(){return this.viewer.position}get velocity(){return this.viewer.velocity}get coordinateSpace(){return this.viewer.coordinateSpaceCombiner.combined}activate(e){let{viewer:t}=this,{content:i}=aF(e),{positionWidget:n}=this.makeTool(e,i,!1);e.bindInputEventMap(oi),e.bindAction("adjust-position-via-wheel",e=>{e.stopPropagation();let{deltaY:t}=e.detail;if(0!==t)n.adjustDimensionPosition(this.dimensionId,Math.sign(t))}),e.bindAction("adjust-velocity-via-wheel",e=>{e.stopPropagation();let i=sS(e.detail);t.velocity.multiplyVelocity(this.dimensionId,i)}),e.bindAction("toggle-playback",e=>{e.stopPropagation(),t.velocity.togglePlayback(this.dimensionId)})}renderInPalette(e){let t=document.createElement("div");return this.makeTool(e,t,!0),t}makeTool(e,t,i){let{viewer:n}=this;i?t.classList.add("neuroglancer-position-tool-in-palette"):t.classList.add("neuroglancer-position-tool");let r=new a9(n.position,n.coordinateSpaceCombiner,{velocity:n.velocity,singleDimensionId:this.dimensionId,copyButton:!1,allowFocus:i,showPlayback:!1,showDropdown:!1});r.element.style.userSelect="none",t.appendChild(e.registerDisposer(r).element);let s=e.registerDisposer(new a1(n.position,this.dimensionId,"row"));s.element.style.flex="1",t.appendChild(s.element);let a=this.velocity.dimensionVelocity(e,this.dimensionId),o=e.registerDisposer((0,Z.mo)(e=>void 0!==e,[a]));return t.appendChild(e.registerDisposer(new aY(o,(e,t,i)=>{if(!e)return;t.classList.add("neuroglancer-position-dimension-playback");let r=document.createElement("div"),s=document.createElement("div");r.classList.add("neuroglancer-icon"),s.classList.add("neuroglancer-icon"),r.innerHTML=s8,s.innerHTML=s5,t.appendChild(r),t.appendChild(s);let o=()=>n.velocity.togglePlayback(this.dimensionId);r.addEventListener("click",o),s.addEventListener("click",o);let l=()=>{let e=a.value?.paused;r.style.display=e?"":"none",s.style.display=e?"none":""};i.registerDisposer(a.changed.add(l)),l();let d=new Z.SN(0);d.changed.add(()=>{let e=d.value,t=a.value;if(void 0!==t)t.velocity!==e&&(a.value={...t,velocity:e})});let u=sV({text:"\xb1",title:"Negate velocity",onClick:()=>{d.value=-d.value}}),c=i.registerDisposer(new aQ(d));c.inputElement.disabled=!0,c.element.insertBefore(u,c.element.firstChild),c.element.title="Velocity in coordinates per second";let h=document.createElement("span");h.textContent="/s",c.element.appendChild(h),t.appendChild(c.element);let p=new rL.B(r_,r_.STOP),g=()=>{p.value=a.value?.atBoundary??r_.STOP,d.value=a.value?.velocity??0};g(),i.registerDisposer(a.changed.add(g)),p.changed.add(()=>{let e=p.value,t=a.value;if(void 0!==t)t.atBoundary!==e&&(a.value={...t,atBoundary:e})});let m=new aX(p).element;t.appendChild(m),m.title="Behavior when lower/upper bound is reached"})).element),t.appendChild(e.registerDisposer(new aH(n.velocity.playbackEnabled(this.dimensionId),{svg:s7,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),{positionWidget:r}}savedDimensionName;get dimensionName(){let{dimensionId:e}=this,t=this.coordinateSpace.value,i=t.ids.indexOf(e);if(-1!==i)return t.names[i]}get description(){return`dim ${this.dimensionName}`}constructor(e,t){super(e.toolBinder),this.viewer=e,this.dimensionId=t,this.savedDimensionName="",this.savedDimensionName=this.dimensionName,this.registerDisposer(this.coordinateSpace.changed.add(()=>{let e=this.dimensionName;if(void 0===e){this.unbind();return}e!==this.savedDimensionName&&(this.savedDimensionName=e,this.changed.dispatch())}))}toJSON(){return{type:ot,dimension:this.dimensionName}}}function or(e,t){let i=(0,eb.uq)(t,"dimension",eb.ZE),n=e.coordinateSpaceCombiner.combined.value,r=n.names.indexOf(i);if(-1===r)throw Error(`Invalid dimension name: ${JSON.stringify(i)}`);return new on(e,n.ids[r])}function os(e,t){return void 0!==t&&e.changed.addOnce(t),e.value.names.map(e=>({type:ot,dimension:e}))}let oa=Symbol("transferFunctionSamplerTexture"),oo=Symbol("histogramSamplerTexture"),ol={[ec.UINT8]:256,[ec.INT8]:256,[ec.UINT16]:8192,[ec.INT16]:8192,[ec.UINT32]:8192,[ec.INT32]:8192,[ec.UINT64]:8192,[ec.FLOAT32]:8192};class od{inputValue;outputColor;constructor(e,t=Q.Dv){this.inputValue=e,this.outputColor=t}normalizedInput(e){return eE(e,this.inputValue)}transferFunctionIndex(e,t){return Math.floor(this.normalizedInput(e)*(t-1))}interpolateColor(e,t){let i=Q.vh.create();for(let n=0;n<4;++n)i[n]=eT([this.outputColor[n],e.outputColor[n]],ec.UINT8,t);return i}static copyFrom(e){let t=e.inputValue;return new od(t,Q.vh.clone(e.outputColor))}}class ou{controlPoints;dataType;autoComputeRange;range;constructor(e=[],t,i=!0){this.controlPoints=e,this.dataType=t,this.autoComputeRange=i,this.controlPoints=e,this.range=ex[t],this.sortAndComputeRange()}get length(){return this.controlPoints.length}setDefaultControlPoints(e,t){this.clear(),this.addPoint(new od(e[0],Q.Dv)),this.addPoint(new od(e[1],t))}clear(){this.controlPoints=[]}addPoint(e){let{inputValue:t,outputColor:i}=e,n=this.controlPoints.findIndex(e=>e.inputValue===t);-1!==n&&this.updatePointColor(n,i);let r=new od(t,i);this.controlPoints.push(r),this.sortAndComputeRange()}removePoint(e){this.controlPoints.splice(e,1),this.computeRange()}updatePoint(e,t){this.controlPoints[e]=t;let i=t.inputValue,n=t.outputColor;this.sortAndComputeRange();for(let e=0;e<this.controlPoints.length;++e)if(this.controlPoints[e].inputValue===i&&(0,Y.cO)(this.controlPoints[e].outputColor,n))return e;return -1}updatePointColor(e,t){let i=Q.vh.create();if(3===t.length){let n=this.controlPoints[e].outputColor[3];i=Q.vh.fromValues(t[0],t[1],t[2],n)}else i=Q.vh.clone(t);this.controlPoints[e].outputColor=i}findNearestControlPointIndex(e){let t=new od(e).normalizedInput(this.range);return this.findNearestControlPointIndexByNormalizedInput(t)}findNearestControlPointIndexByNormalizedInput(e){return(0,Y.bm)(this.controlPoints.map(e=>e.normalizedInput(this.range)),e,(e,t)=>e-t)}sortAndComputeRange(){this.controlPoints.sort((e,t)=>e.normalizedInput(this.range)-t.normalizedInput(this.range)),this.computeRange()}computeRange(){if(this.autoComputeRange){if(0==this.controlPoints.length)this.range=ex[this.dataType];else if(1===this.controlPoints.length){let e=ex[this.dataType][1];this.dataType===ec.FLOAT32&&e<=this.controlPoints[0].inputValue&&(e=this.controlPoints[0].inputValue+1),this.range=[this.controlPoints[0].inputValue,e]}else this.range=[this.controlPoints[0].inputValue,this.controlPoints[this.controlPoints.length-1].inputValue]}this.range[0]===this.range[1]&&(this.range=ex[this.dataType])}copy(){let e=new ou([],this.dataType,this.autoComputeRange);return e.range=this.range,e.controlPoints=this.controlPoints.map(e=>od.copyFrom(e)),e}}class oc{lookupTableSize;outputValues;constructor(e){this.lookupTableSize=e,this.outputValues=new Uint8Array(4*e).fill(0)}resize(e){this.lookupTableSize=e,this.outputValues=new Uint8Array(4*e).fill(0)}updateFromControlPoints(e,t){let i=t||e.range,{controlPoints:n}=e,r=this.outputValues,s=this.lookupTableSize;function a(e,t){r[e]=t[0],r[e+1]=t[1],r[e+2]=t[2],r[e+3]=t[3]}function o(e){return e.transferFunctionIndex(i,s)}if(0===n.length){r.fill(0);return}let l=o(n[0]);if(l>0){let e=Q.vh.fromValues(0,0,0,0);for(let t=0;t<l;++t)a(4*t,e)}let d=0;for(let e=l;e<s;++e){let t=n[d],i=4*e;if(d===n.length-1)a(i,t.outputColor);else{let r=n[d+1],s=o(t),l=o(r),u=(e-s)/(l-s);a(i,t.interpolateColor(r,u)),e>=l&&d++}}}static equal(e,t){return(0,Y.cO)(e.outputValues,t.outputValues)}copy(){let e=new oc(this.lookupTableSize);return e.outputValues.set(this.outputValues),e}}class oh extends ef.gj{dataType;trackable;lookupTable;autoPointUpdateEnabled;constructor(e,t,i=ol[e]){super(),this.dataType=e,this.trackable=t,this.autoPointUpdateEnabled=!0,this.lookupTable=new oc(i),this.updateLookupTable()}get sortedControlPoints(){return this.trackable.value.sortedControlPoints}get range(){return this.sortedControlPoints.range}get size(){return this.lookupTable.lookupTableSize}updateLookupTable(e){this.lookupTable.updateFromControlPoints(this.sortedControlPoints,e)}addPoint(e){this.sortedControlPoints.addPoint(e)}generateDefaultControlPoints(e=null,t){if(!this.autoPointUpdateEnabled)return;t=void 0!==t?t:this.trackable.value.window;let i=null!==e?e:[eT(t,this.dataType,.3),eT(t,this.dataType,.7)];i[0]===i[1]&&(i[0]=t[0],i[1]=t[1]);let n=this.trackable.value.defaultColor,r=Q.vh.fromValues(Math.round(255*n[0]),Math.round(255*n[1]),Math.round(255*n[2]),255);this.sortedControlPoints.setDefaultControlPoints(i,r)}generateDefaultWindow(e=null){let t=ss(null!==e?e:this.sortedControlPoints.range,this.dataType);this.trackable.value={...this.trackable.value,window:t}}updatePoint(e,t){return this.sortedControlPoints.updatePoint(e,t)}removePoint(e){this.sortedControlPoints.removePoint(e)}updatePointColor(e,t){this.sortedControlPoints.updatePointColor(e,t)}findNearestControlPointIndex(e,t){let i=eT(t,this.dataType,e);return this.sortedControlPoints.findNearestControlPointIndex(i)}}class op extends ef.gj{gl;texture;width;height;priorOptions;constructor(e){super(),this.gl=e,this.texture=null,this.height=1,this.priorOptions=void 0}updateAndActivate(e){let{gl:t}=this;if(null===t)return;let{texture:i}=this;function n(e,t){if(void 0===t)throw Error("Texture unit must be defined for transfer function texture");e.activeTexture(WebGL2RenderingContext.TEXTURE0+t),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i)}if(null!==i&&this.optionsEqual(e))return n(t,e.textureUnit),this.width*this.height;null===i&&(i=this.texture=t.createTexture()),n(t,e.textureUnit),nP(t);let r=this.createLookupTable(e);return t.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA,this.width,this.height,0,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,r.outputValues),this.setOptions(e),this.width*this.height}setTextureWidthAndHeightFromSize(e){this.width=e}disposed(){this.gl?.deleteTexture(this.texture),this.texture=null,this.priorOptions=void 0,super.disposed()}}class og extends op{gl;texture;constructor(e){super(e),this.gl=e,this.texture=null}optionsEqual(e){let t=this.priorOptions;if(void 0===t)return!1;let i=oc.equal(t.lookupTable,e.lookupTable),n=t.textureUnit===e.textureUnit;return i&&n}createLookupTable(e){return this.setTextureWidthAndHeightFromSize(e.lookupTable.lookupTableSize),e.lookupTable}setOptions(e){this.priorOptions={...e,lookupTable:e.lookupTable.copy()}}}class om extends op{gl;constructor(e){super(e),this.gl=e}optionsEqual(e){let t=this.priorOptions;if(void 0===t)return!1;let i=(0,Y.eK)(t.sortedControlPoints.controlPoints,e.sortedControlPoints.controlPoints,(e,t)=>e.inputValue===t.inputValue&&(0,Y.cO)(e.outputColor,t.outputColor)),n=t.textureUnit===e.textureUnit,r=t.dataType===e.dataType;return i&&n&&r}setOptions(e){this.priorOptions={...e,sortedControlPoints:e.sortedControlPoints.copy()}}createLookupTable(e){let t=this.ensureTextureSize(e.lookupTableSize);if(void 0===t)return new oc(0);this.setTextureWidthAndHeightFromSize(t);let i=new oc(t),n=e.sortedControlPoints;return i.updateFromControlPoints(n),i}ensureTextureSize(e){let t=this.gl;if(null!==t)return Math.min(e,t.getParameter(t.MAX_TEXTURE_SIZE))}}function of(){let e=new Uint8Array(6*sH);for(let t=0;t<sH;++t)for(let i=0;i<6;++i)e[6*t+i]=t;return e}function ov(){return function(e,t=-1,i=1,n=1,r=-1){let s=new Float32Array(6144),a=(i-t)/e,o=t;for(let t=0;t<e;++t){let e=12*t;s[e]=o,s[e+1]=n,s[e+2]=o+a,s[e+3]=n,s[e+4]=o+a,s[e+5]=r,s[e+6]=o,s[e+7]=n,s[e+8]=o+a,s[e+9]=r,s[e+10]=o,s[e+11]=r,o+=a}return s}(512)}class oy extends iL{parent;texture;textureVertexBuffer;controlPointsVertexBuffer;controlPointsPositionArray;controlPointsColorBuffer;controlPointsColorArray;linePositionBuffer;linePositionArray;get drawOrder(){return 1}transferFunction;controller;dataValuesBuffer;constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controlPointsPositionArray=new Float32Array,this.controlPointsColorArray=new Float32Array,this.linePositionArray=new Float32Array,this.histogramLineShader=this.registerDisposer(sz(this.gl,oo)),this.transferFunctionLineShader=this.registerDisposer((()=>{let e=new ny(this.gl);return sx(e),e.addAttribute("vec4","aLineStartEnd"),e.addOutputBuffer("vec4","out_color",0),e.addVarying("float","vColor"),e.setVertexMain(`
vec4 start = vec4(aLineStartEnd[0], aLineStartEnd[1], 0.0, 1.0);
vec4 end = vec4(aLineStartEnd[2], aLineStartEnd[3], 0.0, 1.0);
emitLine(start, end, 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.35, 0.35, 0.35, getLineAlpha());
`),e.build()})()),this.transferFunctionShader=this.registerDisposer((()=>{let e=new ny(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addVarying("vec2","vTexCoord"),e.addOutputBuffer("vec4","out_color",0),e.addTextureSampler("sampler2D","uSampler",oa),e.addUniform("float","uTransferFunctionEnd"),e.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vTexCoord = (aVertexPosition + 1.0) / 2.0;
`),e.setFragmentMain(`
ivec2 texel = ivec2(floor(vTexCoord.x * uTransferFunctionEnd), 0);
out_color = texelFetch(uSampler, texel, 0);
`),e.build()})()),this.controlPointsShader=this.registerDisposer((()=>{let e=new ny(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addAttribute("vec3","aVertexColor"),e.addVarying("vec3","vColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
gl_PointSize = 14.0;
vColor = aVertexColor;
`),e.setFragmentMain(`
float vColorSum = vColor.r + vColor.g + vColor.b;
vec3 bordercolor = vec3(0.0, 0.0, 0.0);
if (vColorSum < 0.4) {
  bordercolor = vec3(1.0, 1.0, 1.0);
}
float dist = distance(gl_PointCoord, vec2(0.5, 0.5));
float alpha = smoothstep(0.25, 0.4, dist);
vec4 tempColor = vec4(mix(vColor, bordercolor, alpha), 1.0);
alpha = 1.0 - smoothstep(0.4, 0.5, dist);
out_color = tempColor * alpha;
`),e.build()})());let{element:t,gl:i}=this;this.transferFunction=this.registerDisposer(new oh(e.dataType,e.trackable,512)),this.controller=this.registerDisposer(new oS(t,e.dataType,this.transferFunction,()=>e.trackable.value,t=>{e.trackable.value=t})),this.dataValuesBuffer=this.registerDisposer(nT(i,WebGL2RenderingContext.ARRAY_BUFFER,of)).value,t.classList.add("neuroglancer-transfer-function-panel"),this.texture=this.registerDisposer(new og(i)),this.textureVertexBuffer=this.registerDisposer(nT(i,WebGL2RenderingContext.ARRAY_BUFFER,ov)).value,this.controlPointsVertexBuffer=this.registerDisposer(new nE(i,WebGL2RenderingContext.ARRAY_BUFFER)),this.controlPointsColorBuffer=this.registerDisposer(new nE(i,WebGL2RenderingContext.ARRAY_BUFFER)),this.linePositionBuffer=this.registerDisposer(new nE(i,WebGL2RenderingContext.ARRAY_BUFFER))}updateTransferFunctionPointsAndLines(){let e=this.parent.trackable.value.window;function t(e){return e/255}function i(e,t,i){for(let n=0;n<6;++n)e[t++]=i[0],e[t++]=i[1],e[t++]=i[2],e[t++]=i[3];return t}function n(e){return e>=-1&&e<=1}let{transferFunction:r}=this,{controlPoints:s}=r.trackable.value.sortedControlPoints,a=Math.max(s.length-1,0),o=3,l=new Float32Array(s.length*o),d=new Float32Array(2*s.length),u=0,c=null,h=null,p=s.map(t=>{let i=2*eE(e,t.inputValue)-1;return{input:i,output:t.outputColor[3]/255*2-1}});if(s.length>0){let{firstPointIndexInWindow:e,lastPointIndexInWindow:t,pointClosestToLeftEdge:i,pointClosestToRightEdge:r}=function(){let e=null,t=null,i=null,r=null;for(let a=0;a<s.length;++a){let s=p[a];if(n(s.input)&&(e=e??a,t=a),s.input<-1)i=s;else if(s.input>1){r=s;break}}return{firstPointIndexInWindow:e,lastPointIndexInWindow:t,pointClosestToLeftEdge:i,pointClosestToRightEdge:r}}();if(null===e){let e=p[s.length-1].input<-1,t=p[0].input>1;e?function(){let e=s.length-1;a+=1;let t=p[e].output;c=Q.vh.fromValues(-1,t,1,t)}():!t&&s.length>1&&function(e,t){if(a+=1,null===e||null===t)throw Error("Could not find points closest to the left and right edges");let i=eE([e.input,t.input],-1),n=eE([e.input,t.input],1),r=eT([e.output,t.output],ec.FLOAT32,i),s=eT([e.output,t.output],ec.FLOAT32,n);c=Q.vh.fromValues(-1,r,1,s)}(i,r)}else{let i=p[e];i.input>-1&&(e>0?function(e,t){let i=p[e-1],n=eE([i.input,t.input],-1),r=eT([i.output,t.output],ec.FLOAT32,n);c=Q.vh.fromValues(-1,r,t.input,t.output)}(e,i):c=Q.vh.fromValues(i.input,-1,i.input,i.output),a+=1);let n=p[t];n.input<1&&(t<s.length-1?function(e,t){let i=p[e+1],n=eE([t.input,i.input],1),r=eT([t.output,i.output],ec.FLOAT32,n);h=Q.vh.fromValues(t.input,t.output,1,r)}(t,n):h=Q.vh.fromValues(n.input,n.output,1,n.output),a+=1)}}let g=[];for(let e=0;e<s.length;++e){let t=e*o,i=2*e,r=p[e].input,u=p[e].output,{outputColor:c}=s[e];if(l[t]=c[0]/255,l[t+1]=c[1]/255,l[t+2]=c[2]/255,d[i]=r,d[i+1]=u,e===s.length-1)break;if(!(n(r)&&n(u)))continue;a+=1;let h=Q.vh.fromValues(r,u,p[e+1].input,p[e+1].output);g.push(h)}let m=new Float32Array(24*a);for(let e of(null!==c&&(u=i(m,u,c)),g))u=i(m,u,e);null!==h&&i(m,u,h),this.controlPointsColorArray=l,this.controlPointsPositionArray=d,this.linePositionArray=m,this.controlPointsVertexBuffer.setData(this.controlPointsPositionArray),this.controlPointsColorBuffer.setData(this.controlPointsColorArray),this.linePositionBuffer.setData(this.linePositionArray)}histogramLineShader;transferFunctionLineShader;transferFunctionShader;controlPointsShader;drawIndirect(){var e,t,i,n;let{transferFunctionLineShader:r,gl:s,transferFunctionShader:a,controlPointsShader:o,histogramLineShader:l}=this;this.setGLLogicalViewport(),s.clearColor(0,0,0,0),s.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),s.enable(WebGL2RenderingContext.BLEND),s.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),s.disable(WebGL2RenderingContext.DEPTH_TEST),s.disable(WebGL2RenderingContext.STENCIL_TEST);{a.bind();let e=a.attribute("aVertexPosition");s.uniform1f(a.uniform("uTransferFunctionEnd"),511),this.textureVertexBuffer.bindToVertexAttrib(e,2,WebGL2RenderingContext.FLOAT);let t=a.textureUnit(oa);this.texture.updateAndActivate({lookupTable:this.transferFunction.lookupTable,textureUnit:t}),sC(this.gl,512,1),s.disableVertexAttribArray(e),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}if(this.parent.histogramSpecifications.producerVisibility.visible){;let{renderViewport:t}=this;l.bind(),sT(l,{width:t.logicalWidth,height:t.logicalHeight},1);let i=l.textureUnit(oo);s.uniform1f(l.uniform("uBoundsFraction"),eB(this.parent.dataType,this.parent.trackable.value.window)),s.activeTexture(WebGL2RenderingContext.TEXTURE0+i),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),nP(s);let n=l.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(n,1,WebGL2RenderingContext.UNSIGNED_BYTE),e=1,sC(s,sH,1),s.disableVertexAttribArray(n),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}if(this.controlPointsPositionArray.length>0){;let{renderViewport:e}=this;r.bind();let a=r.attribute("aLineStartEnd");this.linePositionBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT),sT(r,{width:e.logicalWidth,height:e.logicalHeight},1),t=s,i=this.linePositionArray.length/24,n=1,sC(t,i,1),s.disableVertexAttribArray(a),o.bind();let l=o.attribute("aVertexPosition");this.controlPointsVertexBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT);let d=o.attribute("aVertexColor");this.controlPointsColorBuffer.bindToVertexAttrib(d,3,WebGL2RenderingContext.FLOAT),s.drawArrays(s.POINTS,0,this.controlPointsPositionArray.length/2),s.disableVertexAttribArray(l),s.disableVertexAttribArray(d)}s.disable(WebGL2RenderingContext.BLEND)}update(){this.transferFunction.updateLookupTable(this.parent.trackable.value.window),this.updateTransferFunctionPointsAndLines()}isReady(){return!0}}let ob=sh.fromObject({"shift?+mousedown0":{action:"add-or-drag-point"},"shift+dblclick0":{action:"remove-point"},"shift?+mousedown2":{action:"change-point-color"},"shift?+wheel":{action:"zoom-via-wheel"}});class oS extends ef.gj{element;dataType;transferFunction;getModel;setModel;currentGrabbedControlPointIndex;constructor(e,t,i,n,r){super(),this.element=e,this.dataType=t,this.transferFunction=i,this.getModel=n,this.setModel=r,this.currentGrabbedControlPointIndex=-1,e.title=ob.describe(),this.registerDisposer(new sy(e,ob)),sv(e,"add-or-drag-point",e=>{let t=e.detail;this.updateValue(this.addControlPoint(t)),sb(t,e=>{this.updateValue(this.moveControlPoint(e))})}),sv(e,"remove-point",e=>{let t=e.detail,i=this.findControlPointIfNearCursor(t);-1!==i&&(this.transferFunction.removePoint(i),this.disableAutoPointUpdate(),this.updateValue({...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}))}),sv(e,"change-point-color",e=>{let t=e.detail,i=this.findControlPointIfNearCursor(t);if(-1!==i){let e=this.transferFunction.trackable.value.defaultColor,t=this.convertPanelSpaceColorToAbsoluteValue(e);this.transferFunction.updatePointColor(i,t),this.disableAutoPointUpdate(),this.updateValue({...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints})}}),sv(e,"zoom-via-wheel",e=>{let t=e.detail,i=sS(t),n=this.getTargetFraction(t),{dataType:r}=this,s=this.getModel(),a=eT(s.window,r,n*(1-i)),o=eT(s.window,r,(1-n)*i+n);if(a!==o){let e=[a,o];this.transferFunction.generateDefaultControlPoints(null,e),this.updateValue({...s,sortedControlPoints:this.transferFunction.sortedControlPoints,window:e})}})}disableAutoPointUpdate(){this.transferFunction.autoPointUpdateEnabled=!1}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}updateValue(e){void 0!==e&&this.setModel(e)}convertPanelSpaceInputToAbsoluteValue(e){return eT(this.transferFunction.trackable.value.window,this.dataType,e)}convertPanelSpaceColorToAbsoluteValue(e){return 3===e.length?Q.R3.fromValues(Math.round(255*e[0]),Math.round(255*e[1]),Math.round(255*e[2])):Q.vh.fromValues(Math.round(255*e[0]),Math.round(255*e[1]),Math.round(255*e[2]),Math.round(255*e[3]))}addControlPoint(e){let t=this.transferFunction.trackable.value.defaultColor,i=this.findControlPointIfNearCursor(e);if(-1!==i){this.currentGrabbedControlPointIndex=i;return}let n=this.getControlPointPosition(e);if(void 0===n)return;let{normalizedX:r,normalizedY:s}=n,a=Q.vh.fromValues(t[0],t[1],t[2],s);return this.disableAutoPointUpdate(),this.transferFunction.addPoint(new od(this.convertPanelSpaceInputToAbsoluteValue(r),this.convertPanelSpaceColorToAbsoluteValue(a))),this.currentGrabbedControlPointIndex=this.findControlPointIfNearCursor(e),{...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}}moveControlPoint(e){let{controlPoints:t}=this.transferFunction.sortedControlPoints;if(-1!==this.currentGrabbedControlPointIndex&&this.currentGrabbedControlPointIndex<t.length){let i=this.getControlPointPosition(e);if(void 0===i)return;let{normalizedX:n,normalizedY:r}=i,s=t[this.currentGrabbedControlPointIndex],a=this.convertPanelSpaceInputToAbsoluteValue(n);for(let e=0;e<t.length;e++)t[e].inputValue===a&&e!==this.currentGrabbedControlPointIndex&&(a=s.inputValue);let o=Q.vh.clone(s.outputColor);return o[3]=Math.round(255*r),this.disableAutoPointUpdate(),this.currentGrabbedControlPointIndex=this.transferFunction.updatePoint(this.currentGrabbedControlPointIndex,new od(a,o)),{...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}}}getControlPointPosition(e){let t=this.element.getBoundingClientRect(),i=(e.clientX-t.left)/t.width,n=(t.bottom-e.clientY)/t.height;if(!(i<0)&&!(i>1)&&!(n<0)&&!(n>1))return i<.05/3?i=0:i>1-.05/3&&(i=1),n<.05?n=0:n>.95&&(n=1),{normalizedX:i,normalizedY:n}}findControlPointIfNearCursor(e){let{transferFunction:t,dataType:i}=this,{window:n}=t.trackable.value,r=t.sortedControlPoints.controlPoints.length;function s(e){return e<0||e>=r?null:eE(n,t.sortedControlPoints.controlPoints[e].inputValue)}let a=this.getControlPointPosition(e);if(void 0===a)return -1;let o=a.normalizedX,l=a.normalizedY,d=t.findNearestControlPointIndex(o,n);if(-1===d)return -1;let u=s(d),c=function(){let e=0;if(i==ec.UINT64){let t=new eC.E;e=eC.E.subtract(t,n[1],n[0]).toNumber()}else e=i==ec.FLOAT32?20:n[1]-n[0];return Math.max(.05,1/e)}();return Math.abs(o-u)>c?-1:function(e){let i=[],n=t.sortedControlPoints.length;for(let d=0;d<n;d++){let n=s(d),u=null!==n?Math.abs(n-o):1/0;if(u<=e){var a;let e=(a=d)<0||a>=r?null:t.sortedControlPoints.controlPoints[a].outputColor[3]/255;i.push([d,Math.abs(e-l)+10*u])}}return 0===i.length?d:i.sort((e,t)=>e[1]-t[1])[0][0]}(c)}}class ow extends s_{display;dataType;trackable;histogramSpecifications;histogramIndex;transferFunctionPanel;autoRangeFinder;window;get autoPointUpdateEnabled(){return this.transferFunctionPanel.transferFunction.autoPointUpdateEnabled}set autoPointUpdateEnabled(e){this.transferFunctionPanel.transferFunction.autoPointUpdateEnabled=e}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}constructor(e,t,i,n,r,s){super(e),this.display=t,this.dataType=i,this.trackable=n,this.histogramSpecifications=r,this.histogramIndex=s,this.transferFunctionPanel=this.registerDisposer(new oy(this)),this.window=this.createWindowBoundInputs(),this.registerDisposer(r.visibility.add(this.visibility));let{element:a}=this;a.classList.add("neuroglancer-transfer-function-widget"),a.appendChild(this.transferFunctionPanel.element),a.appendChild(this.window.container),this.window.container.dispatchEvent(new Event("change")),this.autoRangeFinder=this.registerDisposer(new sO(this)),this.autoRangeFinder.element.appendChild(this.createClearButton()),this.autoRangeFinder.element.appendChild(this.createColorPicker(n));let o=this.trackable.value.window,l=ex[this.dataType],d=eO(this.dataType,o,l);0===this.trackable.value.sortedControlPoints.length&&d?this.autoRangeFinder.autoComputeRange(0,1):(this.autoPointUpdateEnabled=!1,this.trackable.value.sortedControlPoints.length>0&&d&&this.transferFunctionPanel.transferFunction.generateDefaultWindow()),this.updateControlPointsAndDraw(),this.registerDisposer(this.trackable.changed.add(()=>{this.updateControlPointsAndDraw()})),this.registerDisposer(this.display.updateFinished.add(()=>{this.autoRangeFinder.maybeAutoComputeRange()})),this.registerDisposer(this.autoRangeFinder.finished.add(()=>{this.generateDefaultControlPoints(this.autoRangeFinder.computedRange)}))}createClearButton(){let e=document.createElement("button");return e.classList.add("neuroglancer-transfer-function-clear-button"),e.textContent="Clear",e.title="Clear all control points",e.addEventListener("click",()=>{this.clearPoints()}),e}createColorPicker(e){let t=document.createElement("div");t.classList.add("neuroglancer-transfer-function-color-picker-container");let i=this.registerDisposer(new sD((0,Z.mo)(e=>e.defaultColor,[e]),()=>Q.R3.fromValues(1,1,1)));return i.element.classList.add("neuroglancer-transfer-function-color-picker"),i.element.title="Transfer function color picker",i.element.addEventListener("change",()=>{e.value={...this.trackable.value,defaultColor:i.model.value}}),i.element.addEventListener("input",()=>{e.value={...this.trackable.value,defaultColor:i.model.value}}),t.appendChild(i.element),t}createWindowBoundInputs(){let e=this.dataType,t=this.trackable;function i(e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-transfer-function-widget-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=`${0===e?"Lower":"Upper"} window for transfer function`,t}let n=document.createElement("div");n.classList.add("neuroglancer-transfer-function-window-bounds");let r=[i(0),i(1)];for(let i=0;i<2;++i){let n=r[i];n.addEventListener("input",()=>{sQ(n)}),n.addEventListener("change",()=>{let r=t.value.window,s={range:r,window:r};try{let r=eM(e,n.value),a=sq(s,"window",i,r,!0).window;if(a[0]===a[1])throw Error("Window bounds cannot be equal");this.transferFunctionPanel.transferFunction.generateDefaultControlPoints(null,a),t.value={...t.value,window:a}}catch{s0(n,r[i])}})}return n.appendChild(r[0]),n.appendChild(r[1]),{container:n,inputs:r}}updateView(){for(let e=0;e<2;++e)s0(this.window.inputs[e],this.trackable.value.window[e]);this.transferFunctionPanel.scheduleRedraw()}updateControlPointsAndDraw(){this.transferFunctionPanel.update(),this.updateView()}updateTrackable(e){this.trackable.value=e}generateDefaultControlPoints(e=null){let t=this.transferFunctionPanel.transferFunction;t.generateDefaultControlPoints(e),this.updateTrackable({...this.trackable.value,sortedControlPoints:t.sortedControlPoints})}clearPoints(){let e=this.transferFunctionPanel.transferFunction.sortedControlPoints;e.clear(),this.updateTrackable({...this.trackable.value,sortedControlPoints:e}),this.autoPointUpdateEnabled=!0}}function oC(e,t){"number"==typeof e&&(e=[e]);let i=Array(t);return(0,eb.Iw)(i,e,e=>{if(!Number.isInteger(e)||e<0)throw Error(`Expected non-negative integer, but received: ${JSON.stringify(e)}`);return e}),i}let ox=new Map([["slider",function(e,t){let i,n,r,s;let a=[];for(let[o,l]of("float"!==e&&"uint"!==e&&"int"!==e&&a.push("type must be float, int, or uint"),t)){let t=()=>{if("number"!=typeof l){a.push(`Expected ${o} argument to be a number`);return}return("int"===e||"uint"===e)&&(!Number.isInteger(l)&&a.push(`Expected ${o} argument to be an integer`),"uint"===e&&l<0&&a.push(`Expected ${o} argument to be an unsigned integer`)),l};"min"===o?i=t():"max"===o?n=t():"default"===o?s=t():"step"===o?r=t():a.push(`Invalid parameter: ${o}`)}return(void 0===i&&a.push("min must be specified"),void 0===n&&a.push("max must be specified"),void 0!==i&&void 0!==n&&(i>n&&a.push("min must be less than max"),void 0===r&&(r="float"===e?(n-i)/100:1),void 0!==s?(s<i||s>n)&&a.push("default must be within valid range"):s="float"===e?(i+n)/2:i),a.length>0)?{errors:a}:{control:{type:"slider",valueType:e,min:i,max:n,step:r,default:s},errors:void 0}}],["color",function(e,t){let i="white",n=[];for(let[r,s]of("vec3"!==e&&n.push("type must be vec3"),t))"default"===r?"string"!=typeof s?n.push("Expected default argument to be a string"):i=s:n.push(`Invalid parameter: ${r}`);return n.length>0?{errors:n}:{control:{type:"color",valueType:e,defaultString:i,default:ei(i)},errors:void 0}}],["invlerp",function(e,t,i){let{imageData:n,properties:r}=i;if(void 0!==n)return function(e,t,i){let n;let r=[];"invlerp"!==e&&r.push("type must be invlerp");let s=Array(i.channelRank).fill(0),{dataType:a}=i,o=!0,l=ex[a];for(let[e,i]of t)try{switch(e){case"range":l=eN(i,a);break;case"window":n=eP(eN(i,a));break;case"clamp":"boolean"!=typeof i?r.push(`Invalid clamp value: ${JSON.stringify(i)}`):o=i;break;case"channel":s=oC(i,s.length);break;default:r.push(`Invalid parameter: ${e}`)}}catch(t){r.push(`Invalid ${e} value: ${t.message}`)}return r.length>0?{errors:r}:{control:{type:"imageInvlerp",dataType:a,clamp:o,default:{range:l,window:n??eL(l),channel:s}},errors:void 0}}(e,t,n);if(void 0!==r)return function(e,t,i){let n,r,s;let a=[];"invlerp"!==e&&a.push("type must be invlerp");let o=!0;for(let[e,l]of t)try{switch(e){case"range":n=eV(l);break;case"window":r=eV(l);break;case"clamp":"boolean"!=typeof l?a.push(`Invalid clamp value: ${JSON.stringify(l)}`):o=l;break;case"property":{let e=(0,eb.ZE)(l);if(!i.has(e))throw Error(`Property not defined: ${JSON.stringify(s)}`);s=e;break}default:a.push(`Invalid parameter: ${e}`)}}catch(t){a.push(`Invalid ${e} value: ${t.message}`)}if(a.length>0)return{errors:a};if(void 0===s)for(let e of i.keys()){s=e;break}let l=i.get(s);return void 0!==n&&(n=eU(n,l)),void 0!==r&&(r=eU(r,l)),{control:{type:"propertyInvlerp",clamp:o,properties:i,default:{range:n,window:r,property:s,dataType:l}},errors:void 0}}(e,t,r);let s=[];return s.push("invlerp control not supported"),{errors:s}}],["checkbox",function(e,t){let i=!1,n=[];for(let[r,s]of("bool"!==e&&n.push("type must be bool"),t))if("default"===r){if("boolean"!=typeof s){n.push(`Expected ${r} argument to be a boolean`);continue}i=s}else n.push(`Invalid parameter: ${r}`);return n.length>0?{errors:n}:{control:{type:"checkbox",valueType:e,default:i},errors:void 0}}],["transferFunction",function(e,t,i){let n;let r=i.imageData,s=r?.dataType,a=r?.channelRank,o=[],l=Array(a).fill(0),d=Q.R3.fromValues(1,1,1),u=new ou([],void 0!==s?s:ec.FLOAT32);for(let[i,r]of("transferFunction"!==e&&o.push("type must be transferFunction"),void 0===s&&o.push("image data must be provided to use a transfer function"),t))try{switch(i){case"channel":l=oC(r,l.length);break;case"defaultColor":d=ei(r);break;case"window":void 0!==s&&(n=eP(eN(r,s)));break;case"controlPoints":void 0!==s&&(u=oA(r,s));break;default:o.push(`Invalid parameter: ${i}`)}}catch(e){o.push(`Invalid ${i} value: ${e.message}`)}return(void 0===n&&(n=u.range),o.length>0)?{errors:o}:{control:{type:"transferFunction",dataType:s,default:{sortedControlPoints:u,channel:l,defaultColor:d,window:n}},errors:void 0}}]]);function oE(e,t={}){e=e.replace(/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/gm,e=>e.startsWith("/")?e.replace(/[^\s]/g," "):e);let i=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,n=[],r=new Map,s=e.replace(/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/gm,(s,a,o)=>{let l=a.match(i),d=()=>Math.max(0,e.substring(0,o).split("\n").length-1);if(null===l)return n.push({line:d(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let u=l[1],c=l[2],h=l[3]??u,{parameters:p,errors:g}=function(e){let t=[],i=new Map;if(void 0===e)return{errors:t,parameters:i};let n=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;;){let r;if(0===(e=e.trim()).length)break;let s=e.match(n);if(null===s){t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=s[1],o=function(e){let t=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,i=0,n=e;t:for(;e.length;){let n=e.match(t);if(null===n)break;let r=n[0];switch(r.charAt(0)){case"[":case"{":++i;break;case"]":case"}":if(--i<0)return -1;break;case",":if(0===i)break t;break;default:if(0===i){e=e.substring(r.length);break t}}e=e.substring(r.length)}return 0!==i?-1:n.length-e.length}(e=e.substring(s[0].length));if(o<=0){t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}try{r=JSON.parse(e.substring(0,o))}catch{t.push(`Invalid #uicontrol parameter value for ${a}: ${r}`);break}i.has(a)?t.push(`Duplicate #uicontrol parameter: ${a}`):i.set(a,r),(e=(e=e.substring(o)).trim()).length>0&&!e.startsWith(",")&&t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),e=e.substring(1)}return{parameters:i,errors:t}}(l[4]);for(let e of g)n.push({line:d(),message:e});if(r.has(c)&&n.push({line:d(),message:`Duplicate definition for control ${c}`}),g.length>0)return"";let m=ox.get(h);if(void 0===m)return n.push({line:d(),message:`Invalid control type ${h}`}),"";let f=m(u,p,t);if(void 0!==f.errors){for(let e of f.errors)n.push({line:d(),message:e});return""}return r.set(c,f.control),""});return{source:e,code:s,errors:n,controls:r}}function oT(e){return`u_shaderControl_${e}`}function ok(e,t){let{builderValues:i}=e;for(let[n,r]of e.parseResult.controls){let e=oT(n),s=i[n];switch(r.type){case"imageInvlerp":{let i=[rC(t,e,r.dataType,r.clamp),`
float ${e}() {
  return ${e}(getDataValue(${s.channel.join(",")}));
}
`];t.addFragmentCode(i),t.addFragmentCode(`#define ${n} ${e}
`);break}case"propertyInvlerp":{let i=s.property,a=[rC(t,e,r.properties.get(i),r.clamp),`
float ${e}() {
  return ${e}(prop_${i}());
}
`];t.addVertexCode(a),t.addVertexCode(`#define ${n} ${e}
`);break}case"checkbox":{let e=`#define ${n} ${s.value}
`;t.addFragmentCode(e),t.addVertexCode(e);break}case"transferFunction":t.addFragmentCode(`#define ${n} ${e}
`),t.addFragmentCode(function(e,t,i,n){e.addUniform("highp float",`uTransferFunctionEnd_${t}`),e.addTextureSampler("sampler2D",`uTransferFunctionSampler_${t}`,`TransferFunction.${t}`);let r=rC(e,t,i,!0),s=rn(i),a=`
vec4 ${t}_(float inputValue) {
  int index = clamp(int(round(inputValue * uTransferFunctionEnd_${t})), 0, int(uTransferFunctionEnd_${t}));
  return texelFetch(uTransferFunctionSampler_${t}, ivec2(index, 0), 0);
}
vec4 ${t}(${s} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${t});
  defaultMaxProjectionIntensity = v;
  return v < 0.0 ? vec4(0.0, 0.0, 0.0, 0.0) : ${t}_(clamp(v, 0.0, 1.0));
}
vec4 ${t}() {
  return ${t}(getDataValue(${n.join(",")}));
}
`;if(i!==ec.UINT64&&i!==ec.FLOAT32){let e=eh[i]?"int":"uint";a+=`
vec4 ${t}(${e} inputValue) {
  return ${t}(${s}(inputValue));
}
`}return[r[0],r[1],r[2],a]}(t,e,r.dataType,s.channel));break;default:t.addUniform(`highp ${r.valueType}`,e),t.addVertexCode(`#define ${n} ${e}
`),t.addFragmentCode(`#define ${n} ${e}
`)}}}function oD(e,t){return t instanceof Map?Array.from(t.entries()):t}function oP(e){if(void 0!==e)return JSON.stringify(function(e){let t={};for(let[i,n]of e)t[i]=n;return t}(e),oD)}class oL{changed=new ez.K_;controls=void 0;get value(){return this.controls}set value(e){if(oP(e)!==oP(this.controls))this.controls=e,this.changed.dispatch()}}class oI extends Z.TU{dataType;defaultValue;constructor(e,t){super(t,i=>{var n,r,s;return n=i,r=e,s=t,void 0===n?s:((0,eb.PT)(n),{range:(0,eb.Kh)(n,"range",e=>eN(e,r),s.range),window:(0,eb.Kh)(n,"window",e=>eP(eN(e,r)),s.window),channel:(0,eb.Kh)(n,"channel",e=>oC(e,s.channel.length),s.channel)})}),this.dataType=e,this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:i},dataType:n,defaultValue:r}=this,s=e_(e,n,r.range),a=e_(t,n,r.window),o=(0,Y.cO)(r.channel,i)?void 0:i;if(void 0!==s||void 0!==a||void 0!==o)return{range:s,window:a,channel:o}}}class oR extends Z.TU{properties;defaultValue;constructor(e,t){super(t,i=>(function(e,t,i){if(void 0===e)return i;(0,eb.PT)(e);let n=(0,eb.Kh)(e,"property",e=>{if(e=(0,eb.ZE)(e),!t.has(e))throw Error(`Invalid value: ${JSON.stringify(e)}`);return e},i.property),r=t.get(n);return{property:n,dataType:r,range:(0,eb.Kh)(e,"range",e=>eN(e,r),i.range),window:(0,eb.Kh)(e,"window",e=>eP(eN(e,r)),i.window)}})(i,e,t)),this.properties=e,this.defaultValue=t}toJSON(){let{value:{range:e,window:t,property:i,dataType:n},defaultValue:r}=this,s=ex[n],a=e_(e??s,n,r.range??s),o=e_(t??s,n,r.window??s),l=i===r.property?void 0:i;if(void 0!==a||void 0!==o||void 0!==l)return{range:a,window:o,property:l}}}function oA(e,t){return new ou((0,eb.m7)(e,e=>{let i=t===ec.UINT64&&"string"==typeof e[0]||"number"==typeof e[0];if(3!==e.length||!i||"string"!=typeof e[1]||"number"!=typeof e[2])throw Error(`Expected array of length 3 (x, "#RRGGBB", A), but received: ${JSON.stringify(e)}`);let n=eM(t,e[0]);if(7!==e[1].length||"#"!==e[1][0])throw Error(`Expected #RRGGBB, but received: ${JSON.stringify(e[1])}`);if(e[2]<0||e[2]>1)throw Error(`Expected opacity in range [0, 1], but received: ${JSON.stringify(e[2])}`);let r=ei(e[1]);function s(e){return Math.min(255,Math.max(Math.round(255*e),0))}return new od(n,Q.vh.fromValues(s(r[0]),s(r[1]),s(r[2]),s(e[2])))}),t)}class oM extends Z.TU{dataType;defaultValue;constructor(e,t){var i;let n={...i=t,sortedControlPoints:i.sortedControlPoints.copy()};super(n,t=>(function(e,t,i){if(void 0===e)return i;(0,eb.PT)(e);let n=(0,eb.Kh)(e,"controlPoints",e=>oA(e,t),i.sortedControlPoints),r=(0,eb.Kh)(e,"window",e=>eN(e,t),i.window);return{sortedControlPoints:n,channel:(0,eb.Kh)(e,"channel",e=>oC(e,i.channel.length),i.channel),defaultColor:(0,eb.Kh)(e,"defaultColor",e=>ei(e),i.defaultColor),window:r}})(t,e,n)),this.dataType=e,this.defaultValue=t}controlPointsToJson(e,t){return e.map(e=>{var i;return[(i=e.inputValue,t===ec.UINT64?i.toJSON():i),ea(Q.R3.fromValues(e.outputColor[0]/255,e.outputColor[1]/255,e.outputColor[2]/255)),e.outputColor[3]/255]})}toJSON(){let{value:{channel:e,sortedControlPoints:t,defaultColor:i,window:n},dataType:r,defaultValue:s}=this,a=e_(n,r,s.window),o=(0,Y.cO)(s.channel,e)?void 0:e,l=(0,Y.cO)(s.defaultColor,i)?void 0:ea(i),d=(0,Y.eK)(s.sortedControlPoints.controlPoints,t.controlPoints,(e,t)=>(0,Y.cO)(e.outputColor,t.outputColor)&&e.inputValue===t.inputValue)?void 0:this.controlPointsToJson(t.controlPoints,r);if(void 0!==o||void 0!==l||void 0!==d||void 0!==a)return{channel:o,defaultColor:l,controlPoints:d,window:a}}}function oN(e){switch(e.type){case"slider":return{trackable:new Z.TU(e.default,t=>{let i;if((i="float"===e.valueType?(0,eb.jz)(t):(0,eb.C$)(t))<e.min||i>e.max)throw Error(`${JSON.stringify(t)} is outside valid range [${e.min}, ${e.max}]`);return i}),getBuilderValue:()=>null};case"color":return{trackable:new ed(e.default),getBuilderValue:()=>null};case"imageInvlerp":return{trackable:new oI(e.dataType,e.default),getBuilderValue:t=>({channel:t.channel,dataType:e.dataType})};case"propertyInvlerp":return{trackable:new oR(e.properties,e.default),getBuilderValue:e=>({property:e.property,dataType:e.dataType})};case"checkbox":return{trackable:new nn(e.default),getBuilderValue:e=>({value:e})};case"transferFunction":return{trackable:new oM(e.dataType,e.default),getBuilderValue:t=>({channel:t.channel,dataType:e.dataType})}}}function oV(e,t){return JSON.stringify(e)+"\0"+t.source}function oO(e){let t={},i=[];for(let[n,r]of e.controls){let{trackable:e,getBuilderValue:s}=oN(r),a=s(e.value);t[n]=a,"propertyInvlerp"===r.type&&i.push(a.property)}return{builderValues:t,parseResult:e,key:oV(t,e),referencedProperties:i}}class o_ extends ef.gj{fragmentMain;dataContext;channelCoordinateSpaceCombiner;changed;controls;parseErrors;processedFragmentMain;parseResult;builderState;histogramSpecifications;fragmentMainGeneration;dataContextGeneration;parseErrors_;processedFragmentMain_;parseResult_;controlsGeneration;parseResultChanged;constructor(e,t=(0,Z.ne)({}),i){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=i,this.changed=new ez.K_,this.controls=new oL,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new ez.K_,this.state_=new Map,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let n=this;this.parseErrors={changed:this.parseResultChanged,get value(){return n.handleFragmentMainChanged(),n.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return n.handleFragmentMainChanged(),n.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return n.parseResult_}},this.builderState=(0,Z.mo)((e,t)=>{let i={},n=[];for(let[e,{control:r,trackable:s,getBuilderValue:a}]of t){let t=a(s.value);i[e]=t,"propertyInvlerp"===r.type&&n.push(t.property)}return{key:oV(i,e),parseResult:e,builderValues:i,referencedProperties:n}},[this.parseResult,this],(e,t)=>e.key===t.key);let r=(0,Z.mo)(e=>{let t=[];for(let{control:i,trackable:n}of e.values())("imageInvlerp"===i.type||"transferFunction"===i.type)&&t.push({channel:n.value.channel});return t},[this],(e,t)=>(0,Y.eK)(e,t,(e,t)=>(0,Y.cO)(e.channel,t.channel))),s=(0,Z.mo)(e=>{let t=[];for(let{control:i,trackable:n}of e.values())"propertyInvlerp"===i.type&&t.push(n.value.property);return t},[this],Y.cO),a=(0,Z.og)(e=>{let t=[];for(let{control:i,trackable:n}of e.values())if("imageInvlerp"===i.type||"transferFunction"===i.type)t.push(n.value.window);else if("propertyInvlerp"===i.type){let{dataType:e,range:i,window:r}=n.value;t.push(r??i??ex[e])}return t},this);this.histogramSpecifications=this.registerDisposer(new ro(r,s,a))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let i=this.dataContext.value;if(null===i)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let e=this.parseResult_=oE(this.fragmentMain.value,i);this.parseErrors_=e.errors,this.processedFragmentMain_=e.code,0===e.errors.length&&(this.controls.value=e.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(void 0===t)return;let i=!1,{state_:n,unparsedJson:r}=this;for(let[e,r]of n)void 0===t.get(e)&&(r.trackable.changed.remove(this.changed.dispatch),n.delete(e),i=!0);for(let[e,s]of t){let t=n.get(e);if(void 0!==t&&JSON.stringify(t.control)!==JSON.stringify(s)&&(t.trackable.changed.remove(this.changed.dispatch),t=void 0),void 0===t){let{trackable:r,getBuilderValue:a}=oN(s);(t={control:s,trackable:r,getBuilderValue:a}).trackable.changed.add(this.changed.dispatch),n.set(e,t),i=!0}if(void 0!==r&&Object.prototype.hasOwnProperty.call(r,e)){i=!0;try{t.trackable.restoreState(r[e])}catch{}}}void 0!==r&&(i=!0),this.unparsedJson=void 0,i&&this.changed.dispatch()}state_;get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}unparsedJson;restoreState(e){if(void 0===e)return;let{state:t}=this;if((0,eb.PT)(e),void 0===this.controls.value){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,n]of t){let{trackable:t}=n;if(t.reset(),Object.prototype.hasOwnProperty.call(e,i))try{t.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();void 0!==this.unparsedJson&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(void 0!==t)return t;let i={},n=!0;for(let[t,r]of e){let e=r.trackable.toJSON();void 0!==e&&(i[t]=e,n=!1)}if(!n)return i}}function oF(e,t,i,n,r){let s=oT(i),a=t.uniform(s);switch(n.type){case"slider":switch(n.valueType){case"int":case"uint":e.uniform1i(a,r);break;case"float":e.uniform1f(a,r)}break;case"color":e.uniform3fv(a,r);break;case"imageInvlerp":rE(t,s,n.dataType,r.range);break;case"propertyInvlerp":{let{dataType:e}=r;rE(t,s,e,r.range??ex[e]);break}case"checkbox":break;case"transferFunction":!function(e,t,i,n,r=ol[i]){let{gl:s}=e;void 0===e.transferFunctionTextures.get(`TransferFunction.${t}`)&&e.transferFunctionTextures.set(`TransferFunction.${t}`,new om(s));let a=e.bindAndUpdateTransferFunctionTexture(`TransferFunction.${t}`,n,i,r);if(void 0===a)throw Error("Failed to create transfer function texture");s.uniform1f(e.uniform(`uTransferFunctionEnd_${t}`),a-1),rE(e,t,i,n.range)}(t,s,n.dataType,r.sortedControlPoints)}}function oB(e,t,i,n){let{state:r}=i;if(i.controls.value===n)for(let[i,n]of r)oF(e,t,i,n.control,n.trackable.value);else for(let[i,s]of n){let n=r.get(i),a=void 0!==n&&JSON.stringify(n.control)===JSON.stringify(s)?n.trackable.value:s.default;oF(e,t,i,s,a)}}class oU extends Z.SN{}class o$ extends nl{constructor(){super((e,{showMatches:t,segmentationState:i})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(i.changed.add(this.changed.dispatch)),e.registerDisposer((0,Z.Uw)((e,t)=>{if(null==t)return;let{segmentationGroupState:i}=t;e.registerDisposer(i.changed.add(this.changed.dispatch)),e.registerDisposer((0,Z.Uw)((e,t)=>{let{visibleSegments:i}=t,n=0===i.size;e.registerDisposer(i.changed.add(()=>{let e=0===i.size;e!==n&&(n=e,this.changed.dispatch())}))},i))},i))})}get(e){let t=super.get(e);return void 0===t&&(t={segmentationState:new Z.SN(void 0),showMatches:new nn(!1)},super.set(e,t)),t}}let oG=`
void main() {
  setColor(defaultColor());
}
`;class oz extends ef.gj{annotationProperties=new Z.SN(void 0);shader=nS(oG);shaderControls=new o_(this.shader,(0,Z.og)(e=>{let t=new Map;if(void 0===e)return null;for(let i of e){let e=eH[i.type];void 0!==e&&t.set(i.identifier,e)}return{properties:t}},this.annotationProperties));fallbackShaderControls=new Z.SN(oO(oE(oG)));shaderError=nb();color=new ed(Q.R3.fromValues(1,1,0));relationshipStates=this.registerDisposer(new o$);ignoreNullSegmentFilter=new nn(!0);swapVisibleSegmentsOnMove=new nn(!0);disablePicking=new Z.SN(!1);displayUnfiltered=(0,Z.og)((e,t)=>{for(let i of e.values())if(i.showMatches.value){if(!t)return!1;let e=i.segmentationState.value;if(null!=e&&e.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);hoverState=new oU(void 0)}class oj extends ef.gj{transform;localPosition;source;role;dataSource;subsourceId;subsourceIndex;displayState;subsubsourceId;chunkTransform;constructor(e){super();let{transform:t,localPosition:i,source:n,role:r=i8.ANNOTATION}=e;this.transform=t,this.localPosition=i,this.source=this.registerDisposer(n),this.role=r,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer((0,Z.og)(e=>na(()=>io(no(e))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex,this.subsubsourceId=e.subsubsourceId}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}}var oW=i("9023");let oq=Q._E.create();function oH(e,t,i){let{curPositionInChunks:n,fixedPositionWithinChunk:r}=e,{nonDisplayLowerClipBound:s,nonDisplayUpperClipBound:a}=e,{rank:o,chunkDataSize:l}=e.source.spec;if(!iu(n,t,i,e.layerRank,e.fixedLayerToChunkTransform))return!1;for(let e=0;e<o;++e){let t=n[e];if(t<s[e]||t>=a[e])return!1;let i=l[e],o=n[e]=Math.floor(t/i);r[e]=t-o*i}return!0}let oJ=new oW.d(Q.R3.create(),Q._E.create(),0);class oK extends iA{viewportNormalInGlobalCoordinates=Q.R3.create();viewportNormalInCanonicalCoordinates=Q.R3.create();centerDataPosition=Q.R3.create();pixelSize=0}class oZ extends iY{projectionParameters;visibleLayers;visibleSourcesStale;constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new Map,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((e,t)=>{(function(e,t){if(e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo||e.pixelSize!==t.pixelSize)return!0;let{viewMatrix:i}=e,{viewMatrix:n}=t;for(let e=0;e<12;++e)if(i[e]!==n[e])return!0;return!1})(e,t)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[i,n]of t){let{allSources:t,visibleSources:r}=n;if(r.length=0,0===t.length||!function(e,t){let i=e.displayDimensionRenderInfo;return i===t||!!rQ(i,t)&&(e.displayDimensionRenderInfo=t,!0)}(n,e))continue;let s=function(e,t){let i=t.length,n=0;if(i>1){let r=0;for(let s=0;s<i;++s){let{chunkLayout:i}=t[s],a=function(e,t){let i=0,n=Math.abs(e.detTransform),{transform:r,size:s}=e;for(let e=0;e<3;++e){let a=0;for(let i=0;i<3;++i)a+=t[4*i+2]*r[4*e+i];let o=s[e];i+=Math.abs(a)*o,n*=o}return n/i}(i,e);a>r&&(r=a,n=s)}}return n}(this.projectionParameters.value.viewMatrix,t.map(e=>e[0])),a=t[s];for(let e of i.filterVisibleSources(this,a))r.push(e);r.reverse()}}}function oY(e){let{rank:t,upperVoxelBound:i,maxVoxelsPerChunkLog2:n=18,chunkToViewTransform:r,displayRank:s,minBlockSize:a,maxBlockSize:o}=e,{lowerVoxelBound:l=new Uint32Array(t)}=e,d=new Float32Array(t);for(let e=0;e<t;++e){let t=0;for(let i=0;i<s;++i){let n=r[e*s+i];t+=n*n}d[e]=Math.sqrt(t)}let u=new Uint32Array(t);void 0!==a?u.set(a):u.fill(1);let c=Array(t);for(let e=0;e<t;++e){let t=Number.POSITIVE_INFINITY;0===d[e]?t=u[e]:(void 0!==i&&(t=2**Math.floor(Math.log2(i[e]-l[e]))),void 0!==o&&(t=Math.min(t,o[e]))),c[e]=t}n-=Math.log2(tw(u));for(let e=0;e<n;++e){let e=function(){let e=1/0,i=-1;for(let n=0;n<t;++n){if(u[n]>=c[n])continue;let t=u[n]*d[n];t<e&&(e=t,i=n)}return i}();if(-1===e)break;u[e]*=2}return u}var oX=((N={})[N.ISOTROPIC=0]="ISOTROPIC",N[N.FLAT=1]="FLAT",N);function oQ(e){let{rank:t,chunkDataSize:i,upperVoxelBound:n}=e,{lowerVoxelBound:r=new Float32Array(t)}=e,s=new Float32Array(t),a=new Float32Array(t);for(let e=0;e<t;++e)s[e]=Math.floor(r[e]/i[e]),a[e]=Math.floor((n[e]-1)/i[e]+1);return{rank:t,chunkDataSize:i,lowerChunkBound:s,upperChunkBound:a,lowerVoxelBound:r,upperVoxelBound:n}}let o0=new Float32Array(3),o1=new Float32Array(3),o2=Q._E.create(),o3=new Float32Array(24);function o4(e,t,i,n){let{lowerChunkDisplayBound:r,upperChunkDisplayBound:s}=t;for(let e=0;e<3;++e)o0[e]=Math.max(o0[e],r[e]),o1[e]=Math.min(o1[e],s[e]);let{curPositionInChunks:a,chunkDisplayDimensionIndices:o}=t;!function t(){if(!n(o0[0],o0[1],o0[2],o1[0],o1[1],o1[2],e))return;let r=0,s=Math.max(0,o1[0]-o0[0]),l=s;for(let e=1;e<3;++e){let t=Math.max(0,o1[e]-o0[e]);l*=t,t>s&&(s=t,r=e)}if(0===l)return;if(1===l){a[o[0]]=o0[0],a[o[1]]=o0[1],a[o[2]]=o0[2],i(o0,e);return}let d=o0[r],u=o1[r],c=Math.floor(.5*(d+u));o1[r]=c,t(),o1[r]=u,o0[r]=c,t(),o0[r]=d}()}function o6(e,t,i,n){if(!oH(i,e.globalPosition,t))return;let{size:r}=i.chunkLayout,s=Q._E.multiply(o2,e.viewProjectionMat,i.chunkLayout.transform);for(let e=0;e<3;++e){let t=r[e];for(let i=0;i<4;++i)s[4*e+i]*=t}(0,Q.th)(o3,s);o0.fill(Number.NEGATIVE_INFINITY),o1.fill(Number.POSITIVE_INFINITY),o4(o3,i,n,Q.Rq)}function o5(e,t){let{finiteRank:i}=t;if(3===i)return t;oJ.finiteRank=i,Q.R3.copy(oJ.size,t.size);let n=Q._E.copy(oJ.transform,t.transform),r=Q._E.copy(oJ.invTransform,t.invTransform);oJ.detTransform=t.detTransform;let{invViewMatrix:s,width:a,height:o}=e,l=(0,Q.V2)(e.projectionMat);for(let e=i;e<3;++e){let t=s[12+e],i=t,r=t,d=Math.abs(s[e]*a);i-=d,r+=d;let u=Math.abs(s[e+4]*o);i-=u,r+=u;let c=Math.abs(s[e+8]*l);i-=c;let h=Math.max(1,(r+=c)-i);n[12+e]=i,n[5*e]=h}return Q._E.invert(r,n),oJ}let o8=Q.wO.create();function o7(e,t,i,n,r,s){let{displayDimensionRenderInfo:a,viewMatrix:o,projectionMat:l,width:d,height:u}=e,{voxelPhysicalScales:c}=a,h=Math.abs(Q.wO.determinant((0,Q.bZ)(o8,o))),p=(0,Q.n_)(c),g=(0,Q.e6)(l)/h*p;if(0===n.length)return;let m=n[0],f=Math.abs(m.chunkLayout.detTransform)*p,{lowerClipDisplayBound:v,upperClipDisplayBound:y}=m;for(let e=0;e<3;++e)f*=y[e]-v[e];let b=Math.min(f,g),S=d*u,w=S/i**2/b,C=0;for(let i=n.length-1;i>=0&&C<w;--i){let a=n[i],o=a.source.spec,{chunkLayout:l}=a,d=(0,Q.n_)(l.size)*Math.abs(l.detTransform)*p,{limit:u,rank:c}=o,{nonDisplayLowerClipBound:h,nonDisplayUpperClipBound:g}=a,m=1;for(let e=0;e<c;++e){let t=g[e]-h[e];Number.isFinite(t)&&(m/=t)}let f=!0,v=C+u*m/d,y=(1/v)**(1/3),x=Math.sqrt(S/(v*b)),E=Math.min(1,(w-C)*d/m/o.limit);o6(e,t,a,()=>{f&&(r(a,i),f=!1),s(a,i,E,y,x)}),C=v}}let o9=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;function le(e,t){return{defineShader(i,n){let r=`prop_${n}`,s=`a_${r}`;i.addAttribute(`${e}`,s),i.addVertexCode(`${e} ${r}() { return ${s}; }`),i.addInitializer(e=>{let i=e.attribute(s),{gl:n}=e;e.vertexShaderInputBinders[r]=-1===i?{enable(){},disable(){},bind(){}}:{enable(e){n.enableVertexAttribArray(i),n.vertexAttribDivisor(i,e)},disable(){n.vertexAttribDivisor(i,0),n.disableVertexAttribArray(i)},bind(e,r){t(n,i,e,r)}}})}}}function lt(e,t,i,n){return le(e,(e,r,s,a)=>{e.vertexAttribPointer(r,t,i,n,s,a)})}function li(e,t,i){return le(e,(e,n,r,s)=>{e.vertexAttribIPointer(n,t,i,r,s)})}let ln={rgb:lt("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:lt("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:lt("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:li("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:li("highp int",1,WebGL2RenderingContext.INT),uint16:li("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:li("highp int",1,WebGL2RenderingContext.SHORT),uint8:li("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:li("highp int",1,WebGL2RenderingContext.BYTE)};class lr extends ef.gj{gl;annotationType;rank;properties;serializedBytesPerAnnotation;serializedGeometryBytesPerAnnotation;propertyOffsets;propertyGroupBytes;propertyGroupCumulativeBytes;geometryDataStride;constructor(e,t,i,n){super(),this.gl=e,this.annotationType=t,this.rank=i,this.properties=n;let r=this.serializedGeometryBytesPerAnnotation=e9[t].serializedBytes(i),{offsets:s,serializedBytes:a,propertyGroupBytes:o}=eZ(i,r,n);this.serializedBytesPerAnnotation=a,this.propertyOffsets=s,this.propertyGroupBytes=o,this.geometryDataStride=o[0];let l=this.propertyGroupCumulativeBytes=Array(o.length);l[0]=0;for(let e=1;e<o.length;++e)l[e]=l[e-1]+o[e-1]}defineProperties(e,t){let{properties:i,rank:n}=this;for(let r of t){let t=i[r];ln[t.type].defineShader(e,t.identifier,n)}let{propertyOffsets:r}=this,{propertyGroupBytes:s,propertyGroupCumulativeBytes:a}=this;e.addInitializer(e=>{let n=t.map(t=>e.vertexShaderInputBinders[`prop_${i[t].identifier}`]),o=n.length;e.vertexShaderInputBinders.properties={enable(e){for(let t=0;t<o;++t)n[t].enable(e)},bind(e,i){for(let l=0;l<o;++l){let{group:o,offset:d}=r[t[l]];n[l].bind(s[o],i+d+a[o]*e)}},disable(){for(let e=0;e<o;++e)n[e].disable()}}})}}class ls extends lr{shaderControlState;fallbackShaderParameters;shaderError;pickIdsPerInstance;targetIsSliceView;constructor(e,t,i,n,r,s,a){super(e,t,i,n),this.shaderControlState=r,this.fallbackShaderParameters=s,this.shaderError=a,this.histogramShaders=new Map}getDependentShader(e,t){return nC(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(e,i)=>{let{rank:n,properties:r}=this,s=[],a=i.referencedProperties,o=i.parseResult.code;for(let e=0,t=r.length;e<t;++e){let t=r[e],i=`prop_${t.identifier}`;if(!!a.includes(t.identifier)||!!o.match(RegExp(`\\b${i}\\b`)))s.push(e)}this.defineProperties(e,s),e.addUniform("highp vec3","uColor"),e.addUniform("highp uint","uSelectedIndex"),e.addVarying("highp vec4","vColor"),e.addUniform("highp vec3","uSubspaceMatrix",n),e.addUniform("highp mat4","uModelViewProjection"),e.addUniform("highp float","uModelClipBounds",2*n),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexCode(o9),e.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),e.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let l=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${n}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${n} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;for(let[t,r]of(e.addVertexCode(l),e.addFragmentCode(l),e.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${n}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${n}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${n} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${n} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${n}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${n} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),ok(i,e),e.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerColor(vec3 color) { setPointMarkerColor(vec4(color, 1.0)); }
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`),la))t!==this.annotationType&&r.defineShaderNoOpSetters(e);t(e),e.addVertexCode("\n#define main userMain\n"+nx(i.parseResult.code)+"\n#undef main\n")}})}setPartIndex(e,...t){let i=`
void setPartIndex(${t.map((e,t)=>`highp uint partIndex${t}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((e,t)=>`highp uint pickOffset${t} = pickBaseOffset + partIndex${t};`).join("\n")}
`;return 0===t.length&&(i+=`
  highp uint pickOffset0 = pickBaseOffset;
`),i+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((e,t)=>` || selectedIndex == pickOffset${t}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(i),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,i){let{shader:n,parameters:r}=e(t.renderContext.emitter);if(null===n)return;n.bind();let{gl:s}=this,{renderContext:a}=t,{annotationLayer:o}=t;if(oB(s,n,this.shaderControlState,r.parseResult.controls),s.uniform3fv(n.uniform("uSubspaceMatrix"),t.subspaceMatrix),s.uniform1fv(n.uniform("uModelClipBounds"),t.modelClipBounds),s.uniformMatrix4fv(n.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),a.emitPickID&&s.uniform1ui(n.uniform("uPickID"),t.basePickId),a.emitColor){let e=o.state.displayState.color.value;s.uniform3f(n.uniform("uColor"),e[0],e[1],e[2]),s.uniform1ui(n.uniform("uSelectedIndex"),t.selectedIndex)}let l=n.vertexShaderInputBinders.properties;l.enable(1),s.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),l.bind(t.count,t.bufferOffset),i(n),l.disable()}histogramShaders;getHistogramShader(e){let{histogramShaders:t}=this,i=t.get(e);if(void 0===i){let{gl:n}=this;i=n.memoize.get(JSON.stringify({t:"propertyHistogramGenerator",propertyType:e}),()=>{let t=new ny(n);return this.defineHistogramShader(t,e),t.build()}),t.set(e,i)}return i}defineHistogramShader(e,t){ln[t].defineShader(e,"histogram",0),e.addOutputBuffer("vec4","out_histogram",0);let i=eH[t];e.addVertexCode(rC(e,"invlerpForHistogram",i,!1)),e.setVertexMain(`
float x = invlerpForHistogram(prop_histogram());
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
gl_PointSize = 1.0;
`),e.setFragmentMain("out_histogram = vec4(1.0, 1.0, 1.0, 1.0);")}computeHistograms(e,t){let{histogramSpecifications:i}=this.shaderControlState,n=i.properties.value,r=n.length,{properties:s}=this,a=s.length,{propertyOffsets:o}=this,{propertyGroupBytes:l,propertyGroupCumulativeBytes:d}=this,{gl:u}=this;u.enable(WebGL2RenderingContext.BLEND),u.disable(WebGL2RenderingContext.SCISSOR_TEST),u.disable(WebGL2RenderingContext.DEPTH_TEST),u.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE);let c=i.getFramebuffers(u),h=i.frameNumber;i.frameNumber=t,u.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer);for(let p=0;p<r;++p){let r=n[p];for(let n=0;n<a;++n){let a=s[n];if(a.identifier!==r)continue;let g=a.type,m=eH[g],f=this.getHistogramShader(g);f.bind();let v=f.vertexShaderInputBinders.prop_histogram;v.enable(0);let{group:y,offset:b}=o[n];rE(f,"invlerpForHistogram",m,i.bounds.value[p]),v.bind(l[y],e.bufferOffset+b+d[y]*e.count),c[p].bind(256,1),t!==h&&(u.clearColor(0,0,0,0),u.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),u.drawArrays(WebGL2RenderingContext.POINTS,0,e.count);v.disable();break}}u.disable(WebGL2RenderingContext.BLEND)}}let la=new Map;function lo(e,t){la.set(e,t)}function ll(e){return la.get(e)}var ld=i("4571");function lu(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}class lc{source;state;constructor(e){this.source=e,this.state=ih.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=ih.GPU_MEMORY}freeGPUMemory(e){this.state=ih.SYSTEM_MEMORY}}function lh(e){if("number"!=typeof e||e<0)throw Error(`Expected non-negative number as limit, but received: ${JSON.stringify(e)}`);return e}class lp{sizeLimit;itemLimit;constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new Z.TU(t,lh),this.itemLimit=new Z.TU(e,lh)}}class lg extends iY{gl;frameNumberCounter;capacities;visibleChunksChanged;pendingChunkUpdates;pendingChunkUpdatesTail;chunkUpdateDeadline;chunkUpdateDelay;enablePrefetch;constructor(e,t,i,n){super(),this.gl=t,this.frameNumberCounter=i,this.capacities=n,this.visibleChunksChanged=new ez.K_,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new nn(!0,!0);let r=t=>({itemLimit:this.registerDisposer(i3.makeFromExisting(e,t.itemLimit)).rpcId,sizeLimit:this.registerDisposer(i3.makeFromExisting(e,t.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:r(n.gpuMemory),systemMemoryCapacity:r(n.systemMemory),downloadCapacity:r(n.download),computeCapacity:r(n.compute),enablePrefetch:this.registerDisposer(i3.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e;let t=this.chunkUpdateDeadline;e=null===t||Date.now()<t?0:this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;!e&&null===t&&(t=Date.now()+30);let i=!1,n=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let r=this.pendingChunkUpdates;if(null==r)break;try{this.applyChunkUpdate(r)&&(i=!0)}finally{if(++n,null==(this.pendingChunkUpdates=r.nextUpdate)){this.pendingChunkUpdatesTail=null;break}}}return i&&this.visibleChunksChanged.dispatch(),n}handleFetch_(e,t){let{resolve:i,reject:n,abortSignal:r}=t.promise;if(r.aborted){n(r.reason);return}let s=t.key,a=e.chunks.get(s);if(!a){n(Error(`No chunk found at ${s} for source ${e.constructor.name}`));return}let o=a.data;if(!o){n(Error(`At ${s} for source ${e.constructor.name}: chunk has no data`));return}i({value:o})}applyChunkUpdate(e){let t=!1,{rpc:i}=this,n=i.get(e.source);if(void 0!==n){if(void 0!==e.promise)this.handleFetch_(n,e);else if(void 0===e.id){for(let e of n.chunks.keys())n.deleteChunk(e);t=!0}else{let i=e.state;if(i===ih.EXPIRED)n.deleteChunk(e.id);else{let r;let s=e.id;e.new?(r=n.getChunk(e),n.addChunk(s,r)):r=n.chunks.get(s);let a=r.state;if(i!==a)switch(i){case ih.GPU_MEMORY:r.copyToGPU(this.gl),"ManifestChunk"!==r.constructor.name&&(t=!0);break;case ih.SYSTEM_MEMORY:a===ih.GPU_MEMORY&&r.freeGPUMemory(this.gl);break;default:throw Error(`INTERNAL ERROR: Invalid chunk state: ${ih[i]}`)}if(i<=ih.SYSTEM_MEMORY){let{chunkRequesters:e}=n;if(void 0!==e){let t=e.get(s);if(void 0!==t)for(let e of t)e(r)}}}}return t}}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke("ChunkQueueManager.requestChunkStatistics",{queue:this.rpcId}),i=new Map;for(let[n,r]of t){let t=e.get(n);void 0!==t&&i.set(t,r)}return i}}function lm(e,t){let i=e.get(t.source),n=i.chunkManager.chunkQueueManager;if(i.immediateChunkUpdates){n.applyChunkUpdate(t)&&n.visibleChunksChanged.dispatch();return}let r=n.pendingChunkUpdatesTail;null==r?(n.pendingChunkUpdates=t,n.pendingChunkUpdatesTail=t,n.scheduleChunkUpdate()):(r.nextUpdate=t,n.pendingChunkUpdatesTail=t)}lg=lu([i0("ChunkQueueManager")],lg),iq("Chunk.update",function(e){lm(this,e)}),iJ("Chunk.retrieve",function(e,t){return new Promise((i,n)=>{e.promise={resolve:i,reject:n,abortSignal:t},lm(this,e)})}),iq("ChunkManager.chunkLayerStatistics",function(e){let t=this.get(e.id);for(let e of t.prevStatisticsLayers)e.numVisibleChunksNeeded=0,e.numVisibleChunksAvailable=0,e.numPrefetchChunksNeeded=0,e.numPrefetchChunksAvailable=0;for(let i of(t.prevStatisticsLayers.length=0,e.layers)){let e=this.get(i.id);if(void 0===e)continue;let n=e.layerChunkProgressInfo;n.numVisibleChunksAvailable=i.numVisibleChunksAvailable,n.numVisibleChunksNeeded=i.numVisibleChunksNeeded,n.numPrefetchChunksAvailable=i.numPrefetchChunksAvailable,n.numPrefetchChunksNeeded=i.numPrefetchChunksNeeded,t.prevStatisticsLayers.push(n)}t.layerChunkStatisticsUpdated.dispatch()});class lf extends iY{chunkQueueManager;memoize;prevStatisticsLayers;layerChunkStatisticsUpdated;get gl(){return this.chunkQueueManager.gl}constructor(e){super(),this.chunkQueueManager=e,this.memoize=new ld.O,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new ez.K_,this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}getChunkSource(e,t){let i=e.encodeOptions(t);i.constructorId=(0,nd.M)(e);let n=(0,eb.hd)(i);return this.memoize.get(n,()=>{let n=new e(this,t);return n.initializeCounterpart(this.rpc,{}),n.key=i,n})}}lf=lu([i0("ChunkManager")],lf);class lv extends iY{chunkManager;chunks;chunkRequesters;immediateChunkUpdates;constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new Map,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===ih.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw Error("Not implemented.")}invalidateCache(){this.rpc.invoke("ChunkSource.invalidate",{id:this.rpcId})}static encodeOptions(e){return{}}}function ly(e,t){class i extends e{parameters;constructor(...e){super(...e);let t=e[1];this.parameters=t.parameters}initializeCounterpart(e,t){t.parameters=this.parameters,super.initializeCounterpart(e,t)}static encodeOptions(t){return Object.assign({parameters:t.parameters},e.encodeOptions(t))}}return i=lu([i0(t.RPC_ID)],i)}class lb extends iY{layerChunkProgressInfo;constructor(e){super(),this.layerChunkProgressInfo=e}}var lS=i("4066");let lw=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function lC(e){return`${e.low},${e.high}`}function lx(e){return e.useTemporaryVisibleSegments.value?e.temporaryVisibleSegments:e.visibleSegments}function lE(e,t){var i;let n=lx(e);let r=(i=e).useTemporarySegmentEquivalences.value?i.temporarySegmentEquivalences:i.segmentEquivalences,s=r.disjointSets.visibleSegmentEquivalencePolicy.value;for(let e of n.unsafeKeys())if(s&lS.BA.NONREPRESENTATIVE_EXCLUDED){let i=r.get(e);t(e,i)}else{if(!r.disjointSets.isMinElement(e))continue;for(let i of r.setElements(e)){if(!(s&lS.BA.REPRESENTATIVE_EXCLUDED)||!(s&lS.BA.MAX_REPRESENTATIVE)||!(i.high>>>31))t(i,e)}}}function lT(e,t=-4){return(Math.log2(e)-t)/.5}function lk(e,t=.0625,i){void 0===i&&(i=2**Math.round(16)-1);let n=(0,eb.Im)(t,i);return new Z.TU(e,n)}class lD{visibility=new i6;changed=new ez.K_;logScaleOrigin;constructor(e=-4){this.logScaleOrigin=e}frameNumber=-1;spatialScales=new Map;numHistogramRows=1;value=new Uint32Array(40*this.numHistogramRows*2);fakeChunkCount=0;begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.fakeChunkCount=0,this.changed.dispatch())}add(e,t,i,n,r=!1){let{spatialScales:s,numHistogramRows:a,value:o}=this,l=s.get(e);if(void 0===l&&(l=s.size,s.set(e,l)),l>=a){this.numHistogramRows=a*=2;let e=new Uint32Array(80*a);e.set(o),this.value=o=e}let d=80*l+Math.min(Math.max(0,Math.round(lT(t,this.logScaleOrigin))),39);o[d]+=i,o[d+40]+=n,r&&(this.fakeChunkCount=this.fakeChunkCount+n)}}class lP extends i7{chunkManager;multiscaleSource;rpcId;rpcTransfer;localPosition;channelCoordinateSpace;transform;renderScaleTarget;renderScaleHistogram;dataHistogramSpecifications;getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}visibleSources;visibleSourcesList_;getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:i}=this,n=i.get(e);void 0!==n?(++n.refCount,n.chunkTransform=t):(i.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,i=t.get(e);1!==i.refCount?--i.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(0===t.length&&0!==e.size){for(let i of e.values())t.push(i);t.sort((e,t)=>Math.abs(e.chunkTransform.chunkToLayerTransformDet)-Math.abs(t.chunkTransform.chunkToLayerTransformDet))}return t}constructor(e,t,i){super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new Map,this.visibleSourcesList_=[];let{renderScaleTarget:n=lk(1)}=i;this.renderScaleTarget=n,this.renderScaleHistogram=i.renderScaleHistogram,this.transform=i.transform,this.localPosition=i.localPosition,this.rpcTransfer=i.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer(i.dataHistogramSpecifications??new ro((0,Z.ne)([]),(0,Z.ne)([]),(0,Z.ne)([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}initializeCounterpart(){let e=this.registerDisposer(new lb(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(i3.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(i3.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return function*(e,t,i){let n;let r=1.1*e.projectionParameters.value.pixelSize,s=i[0].effectiveVoxelSize,a=t.renderScaleTarget.value,o=e=>{let t=r*a;for(let i=0;i<3;++i){let n=e[i];if(n>t&&n>1.01*s[i])return!0}return!1},l=(e,t)=>{let i=r*a;for(let n=0;n<3;++n){let r=e[n],s=t[n];if(Math.abs(i-r)<Math.abs(i-s)&&r<1.01*s)return!0}return!1},d=i.length-1;for(;;){let e=i[d];if(void 0!==n&&!l(e.effectiveVoxelSize,n))break;if(yield e,0===d||!o(e.effectiveVoxelSize))break;n=e.effectiveVoxelSize,--d}}(e,this,t)}}lP.prototype.RPC_TYPE_ID="sliceview/RenderLayer";class lL extends i9{draw(e,t){}isReady(e,t){return!0}}let lI=i5(class e extends oZ{});function lR(e){return{source:e.source.addCounterpartRef(),effectiveVoxelSize:e.effectiveVoxelSize,layerRank:e.layerRank,nonDisplayLowerClipBound:e.nonDisplayLowerClipBound,nonDisplayUpperClipBound:e.nonDisplayUpperClipBound,lowerClipBound:e.lowerClipBound,upperClipBound:e.upperClipBound,lowerClipDisplayBound:e.lowerClipDisplayBound,upperClipDisplayBound:e.upperClipDisplayBound,chunkDisplayDimensionIndices:e.chunkDisplayDimensionIndices,lowerChunkDisplayBound:e.lowerChunkDisplayBound,upperChunkDisplayBound:e.upperChunkDisplayBound,fixedLayerToChunkTransform:e.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:e.combinedGlobalLocalToChunkTransform,chunkLayout:e.chunkLayout.toObject()}}function lA(e){return e.map(e=>e.map(lR))}function lM(e,t){for(let i of t)for(let{source:t}of i)e.removeSource(t),t.dispose()}class lN extends lI{chunkManager;layerManager;navigationState;wireFrame;gl;viewChanged;renderingStale;visibleChunksStale;visibleLayerList;offscreenFramebuffer;histogramInputTextures;offscreenFramebuffersWithHistograms;get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}histogramGenerator;computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}sharedProjectionParameters;flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}constructor(e,t,i,n){super(new nt({parametersConstructor:oK,navigationState:i,update:(e,t)=>{let{invViewMatrix:i,centerDataPosition:n}=e;t.toMat4(i);let{canonicalVoxelFactors:r,voxelPhysicalScales:s}=e.displayDimensionRenderInfo;for(let e=0;e<3;++e)n[e]=i[12+e];let{logicalWidth:a,logicalHeight:o,projectionMat:l,viewportNormalInGlobalCoordinates:d,viewportNormalInCanonicalCoordinates:u}=e,{relativeDepthRange:c}=t;Q._E.ortho(l,-a/2,a/2,o/2,-o/2,-c,c),ik(e,l),iN(e);let{viewMatrix:h}=e;for(let e=0;e<3;++e){let t=d[e]=h[4*e+2];u[e]=t/r[e]}Q.R3.normalize(d,d),Q.R3.normalize(u,u);let p=0;for(let e=0;e<3;++e){let t=s[e];p+=(t*i[e])**2}p=Math.sqrt(p),e.pixelSize=p}})),this.chunkManager=e,this.layerManager=t,this.navigationState=i,this.wireFrame=n,this.viewChanged=new ez.K_,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=[],this.histogramInputTextures=[],this.updateVisibleLayers=this.registerCancellable((0,ic.Z)(()=>{this.updateVisibleLayersNow()},0)),this.gl=e.gl,this.offscreenFramebuffer=this.registerDisposer(new nF(this.gl,{colorBuffers:n_(this.gl,1),depthBuffer:new nO(this.gl)})),this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=ru.get(this.gl),this.registerDisposer(i),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((e,t)=>{e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let r=this.chunkManager.rpc,s=this.sharedProjectionParameters=this.registerDisposer(new ni(r,this.projectionParameters));this.initializeCounterpart(r,{chunkManager:e.rpcId,projectionParameters:s.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}forEachVisibleChunk(e,t,i){!function(e,t,i,n,r){if(!oH(i,e.globalPosition,t))return;let{size:s}=n,a=Q._E.multiply(o2,e.viewProjectionMat,n.transform);for(let e=0;e<3;++e){let t=s[e];for(let i=0;i<4;++i)a[4*e+i]*=t}Q._E.invert(oq,a);for(let e=0;e<3;++e){let t=oq[12+e]+.001/s[e],i=Math.abs(oq[e]),n=Math.abs(oq[4+e]);o0[e]=Math.floor(t-i-n),o1[e]=Math.floor(t+i+n+1)}for(let e=0;e<3;++e){let t=a[4*e],i=a[4*e+1],n=a[4*e+2];o3[e]=t,o3[4+e]=-t,o3[8+e]=+i,o3[12+e]=-i,o3[16+e]=+n,o3[20+e]=-n}{let e=a[12],t=a[13],i=a[14];o3[3]=1+e,o3[7]=1-e,o3[11]=1+t,o3[15]=1-t,o3[19]=i,o3[23]=-i}o4(o3,i,r,Q.iG)}(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{i(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:i}of this.visibleLayers.values())for(let n of i){let i=o5(this.projectionParameters.value,n.chunkLayout),{source:r}=n,{chunks:s}=r;this.forEachVisibleChunk(n,i,i=>{let n=s.get(i);++t,n&&n.state===ih.GPU_MEMORY&&++e})}return e===t}updateVisibleLayers;invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:i}=e;void 0!==i&&t.push(i.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:i}=this,{displayDimensionRenderInfo:n}=this.projectionParameters.value,r=this.rpc,s={id:this.rpcId},a=!1;for(let o of(i.length=0,this.layerManager.readyRenderLayers()))if(o instanceof lP){i.push(o);let l=t.get(o);if(void 0===l){let i=[],r=new i_;l={messages:r,allSources:this.getTransformedSources(o,r),transformGeneration:o.transform.changed.count,visibleSources:[],disposers:i,lastSeenGeneration:e,displayDimensionRenderInfo:n},i.push(o.messages.addChild(l.messages)),t.set(o.addRef(),l),this.bindVisibleRenderLayer(o,i)}else{l.lastSeenGeneration=e;let t=o.transform.changed.count;if(l.transformGeneration===t&&l.displayDimensionRenderInfo===n)continue;let i=l.allSources;l.allSources=this.getTransformedSources(o,l.messages),lM(o,i),l.visibleSources.length=0,l.displayDimensionRenderInfo=n,l.transformGeneration=t}s.layerId=o.rpcId,s.sources=lA(l.allSources),s.displayDimensionRenderInfo=n,this.flushBackendProjectionParameters(),r.invoke("SliceView.addVisibleLayer",s),a=!0}for(let[i,n]of t)n.lastSeenGeneration!==e&&(s.layerId=i.rpcId,r.invoke("SliceView.removeVisibleLayer",s),t.delete(i),lM(i,n.allSources),(0,ef.k1)(n.disposers),i.dispose(),a=!0);return a&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),a}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,i=t[e];if(void 0===i){let{gl:n,histogramInputTextures:r,offscreenFramebuffer:s}=this;r.length<e&&r.push(...n_(n,e-r.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let a=[s.colorBuffers[0].addRef()];for(let t=0;t<e;++t)a.push(r[t].addRef());i=this.registerDisposer(new nF(n,{colorBuffers:a,depthBuffer:s.depthBuffer.addRef()})),t[e]=i}return i}updateRendering(){let e=this.projectionParameters.value,{width:t,height:i}=e;if(!this.renderingStale||!this.valid||0===t||0===i)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:n,offscreenFramebuffer:r}=this;r.bind(t,i),n.disable(n.SCISSOR_TEST),n.clearColor(0,0,0,0),n.colorMask(!0,!0,!0,!0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let s=0,a=this.wireFrame.value,o={sliceView:this,projectionParameters:e,wireFrame:a};for(let e of this.visibleLayerList){let r=a?0:e.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(r).bind(t,i);for(let e=0;e<r;++e)n.clearBufferfv(WebGL2RenderingContext.COLOR,1+e,Q.Dv);n.enable(WebGL2RenderingContext.DEPTH_TEST),n.depthFunc(WebGL2RenderingContext.LESS),n.clearDepth(1),n.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),e.setGLBlendMode(n,s),e.draw(o),++s}n.disable(WebGL2RenderingContext.BLEND),n.disable(WebGL2RenderingContext.DEPTH_TEST),r.unbind()}disposed(){for(let[e,t]of this.visibleLayers)lM(e,t.allSources),(0,ef.k1)(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let i=lB(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,t=>e.getSources(t),t,e);for(let t of i)for(let i of t)e.addSource(i.source,i.chunkTransform);return i}}lN=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i0("SliceView")],lN);class lV extends lv{spec;constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=lv.encodeOptions(e);return t.spec=lV.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}async fetchChunk(e,t,i){let n;let r=e.join(),s=this.chunks.get(r);if(void 0!==s&&s.state<=ih.SYSTEM_MEMORY)return t(s);this.addRef();let{chunkRequesters:a}=this;void 0===a&&(a=this.chunkRequesters=new Map);let o=a.get(r);void 0===o&&(o=[],a.set(r,o));let l=new Promise(e=>{n=i=>e(t(i)),o.push(n)});try{return await this.rpc.promiseInvoke("ChunkManager.requestChunk",{source:this.rpcId,chunkGridPosition:e},i),await l}finally{let e=o.indexOf(n);o.splice(e,1),0===o.length&&a.delete(r),0===a.size&&(this.chunkRequesters=void 0),this.dispose()}}}class lO extends lc{chunkGridPosition;constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=ih.SYSTEM_MEMORY}}class l_ extends ef.gj{gl;copyVertexPositionsBuffer;shader;textureCoordinateAdjustment;constructor(e,t){super(),this.gl=e,this.textureCoordinateAdjustment=new Float32Array(4),this.copyVertexPositionsBuffer=nD(this.gl);let i=new ny(e);i.addVarying("vec2","vTexCoord"),i.addUniform("sampler2D","uSampler"),i.addInitializer(t=>{e.uniform1i(t.uniform("uSampler"),0)}),i.addUniform("vec4","uColorFactor"),i.addUniform("vec4","uBackgroundColor"),i.addUniform("mat4","uProjectionMatrix"),i.addUniform("vec4","uTextureCoordinateAdjustment"),i.require(t),i.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),i.addAttribute("vec4","aVertexPosition"),i.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(i.build())}draw(e,t,i,n,r,s,a,o){let{gl:l,shader:d,textureCoordinateAdjustment:u}=this;u[0]=r,u[1]=s,u[2]=a-r,u[3]=o-s,d.bind(),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,e),l.disable(WebGL2RenderingContext.BLEND),l.uniformMatrix4fv(d.uniform("uProjectionMatrix"),!1,t),l.uniform4fv(d.uniform("uColorFactor"),i),l.uniform4fv(d.uniform("uBackgroundColor"),n),l.uniform4fv(d.uniform("uTextureCoordinateAdjustment"),u);let c=d.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(c,2),l.drawArrays(l.TRIANGLE_FAN,0,4),l.disableVertexAttribArray(c),l.bindTexture(l.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${(0,nd.M)(t)}`,()=>new l_(e,t))}}class lF{chunkManager;constructor(e){this.chunkManager=e}}function lB(e,t,i,n,r){n.clearMessages();let s=e=>(n.addMessage({severity:iO.error,message:e}),[]);if(void 0!==t.error)return s(t.error);let a=t.rank,o=t.unpaddedRank,{displayDimensionIndices:l,displayRank:d,canonicalVoxelFactors:u}=e,c=il(t,l),{displayToLayerDimensionIndices:h}=c,p=new Float32Array(d*o),{modelToRenderLayerTransform:g}=t;for(let e=0;e<d;++e){let t=h[e];if(-1===t)continue;let i=u[e];for(let n=0;n<o;++n)p[d*n+e]=g[(a+1)*n+t]*i}let m=i({displayRank:d,multiscaleToViewTransform:p,modelChannelDimensionIndices:t.channelToRenderLayerDimensions}),{voxelPhysicalScales:f}=e;try{let e=e=>{let{chunkSource:i}=e,{spec:n}=i,{lowerClipBound:s=n.lowerVoxelBound,upperClipBound:a=n.upperVoxelBound}=e,l=io(t,e.chunkToMultiscaleTransform),{chunkDataSize:u}=n,{channelToChunkDimensionIndices:h}=l,p=new Float32Array(o),g=new Float32Array(o);p.set(s),g.set(a);let m=h.length,{channelSpaceShape:v}=t;for(let e=0;e<m;++e){let i=h[e];if(-1===i)continue;let n=v[e];if(u[i]!==n)throw Error("Channel dimension "+t.layerDimensionNames[t.channelToRenderLayerDimensions[e]]+` has extent ${n} but corresponding chunk dimension has extent `+`${u[i]}`);p[i]=Number.NEGATIVE_INFINITY,g[i]=Number.POSITIVE_INFINITY}let y=id(l,c),b=Q.R3.create(),S=Q.R3.create(),w=Q.R3.create(),C=Q.R3.create(),x=Q.R3.create(),{numChunkDisplayDims:E,chunkDisplayDimensionIndices:T}=y,{combinedGlobalLocalToChunkTransform:k,layerRank:D,combinedGlobalLocalRank:P}=l,L=new Float32Array(k);for(let e=0;e<E;++e){let t=T[e];for(let e=0;e<=P;++e)L[t+e*D]=0;t<o?(x[e]=n.chunkDataSize[t],b[e]=n.lowerChunkBound[t],S[e]=n.upperChunkBound[t],w[e]=s[t],C[e]=a[t],p[t]=Number.NEGATIVE_INFINITY,g[t]=Number.POSITIVE_INFINITY):(x[e]=1,b[e]=0,S[e]=1,w[e]=0,C[e]=1)}x.fill(1,E),b.fill(0,E),S.fill(1,E),w.fill(0,E),C.fill(1,E);let I=new oW.d(x,y.displaySubspaceModelMatrix,E),R=I.localSpatialVectorToGlobal(Q.R3.create(),Q.rn);for(let e=0;e<d;++e)R[e]=Math.abs(R[e]*f[e]);return R.fill(1,d),{layerRank:D,lowerClipBound:s,upperClipBound:a,nonDisplayLowerClipBound:p,nonDisplayUpperClipBound:g,renderLayer:r,source:i,lowerChunkDisplayBound:b,upperChunkDisplayBound:S,lowerClipDisplayBound:w,upperClipDisplayBound:C,effectiveVoxelSize:R,chunkLayout:I,chunkDisplayDimensionIndices:T,fixedLayerToChunkTransform:L,curPositionInChunks:new Float32Array(o),combinedGlobalLocalToChunkTransform:l.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(o),chunkTransform:l,chunkDisplayTransform:y}};return m.map(t=>t.map(t=>e(t)))}catch(n){for(let e of m)for(let{chunkSource:t}of e)t.dispose();let{globalDimensionNames:t}=e,i=Array.from(e.displayDimensionIndices.filter(e=>-1!==e),e=>t[e]).join(",\xa0");return s(`Cannot render (${i}) cross section: ${n.message}`)}}function lU(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}function l$(e){let t=0,{typeToIds:i}=e;for(let e of eq)t+=ll(e).pickIdsPerInstance*i[e].length;return t}class lG{buffer;bufferValid=!1;serializedAnnotations;numPickIds=0;constructor(e){this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;void 0!==t&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class lz extends lc{data;constructor(e,t){super(e),void 0!==t.data&&(this.data=new lG(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;void 0!==t&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class lj extends lO{data;constructor(e,t){super(e,t),void 0!==t.data&&(this.data=new lG(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;void 0!==t&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class lW extends lV{parent;immediateChunkUpdates=!0;multiscaleToChunkTransform;constructor(e,t){super(e,t),(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:n}=this.spec,r=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);to.SO(r,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let e=0;e<i;++e)for(let t=0;t<i+1;++t)r[(i+1)*t+e]/=n[e]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new lj(this,e)}}lW=lU([i0("annotation.GeometryChunkSource")],lW);class lq extends lv{parent;relationshipIndex;immediateChunkUpdates;constructor(e,t,i){super(e,{}),this.parent=t,this.relationshipIndex=i,this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new lz(this,e)}}lq=lU([i0("annotation.SubsetGeometryChunkSource")],lq);class lH extends lc{annotation;constructor(e,t){super(e),this.annotation=ta(t.annotation)}}class lJ extends lv{parent;constructor(e,t){super(e),this.parent=t}getChunk(e){return new lH(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:i}=this.parent,n=i.get(e);void 0!==n&&(n.value=t.annotation,n.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,i=t.get(e);void 0!==i&&(i.value=void 0,i.changed.dispatch())}}function lK(e,t,i,n){let r=new Uint8Array(e.data.length+n);for(let s of eq){if(s===i)continue;let a=e.typeToOffset[s],o=a;s>i&&(o+=n,e.typeToOffset[s]=o),r.set(e.data.subarray(a,a+e.typeToIds[s].length*t[s].serializedBytes),o)}return r}function lZ(e,t,i,n,r,s,a,o){let l=e.typeToOffset[i],d=l,u=l,{propertyGroupBytes:c}=t[i],h=c.length,p=e.typeToIds[i].length;for(let t=0;t<h;++t){let i=c[t];n.set(e.data.subarray(d+r*i,d+s*i),u+a*i),d+=i*p,u+=i*o}}function lY(e,t,i){let n=t.type,{rank:r}=i[n],{serializedAnnotations:s}=e,a=s.typeToIds[n],o=s.typeToIdMaps[n],l=e9[n],d=i[n].serializedBytes,u=o.get(t.id);if(void 0===u){u=o.size,o.set(t.id,u);let e=lK(s,i,n,d);lZ(s,i,n,e,0,u,0,u+1),a.push(t.id),s.data=e}let c=s.typeToOffset[n],h=new DataView(s.data.buffer,s.data.byteOffset,s.data.byteLength),p=ey===ev.LITTLE,g=i[n];l.serialize(h,c+g.propertyGroupBytes[0]*u,p,r,t),g.serialize(h,c,u,a.length,p,t.properties),e.bufferValid=!1}function lX(e,t,i,n){let{serializedAnnotations:r}=e,s=r.typeToIdMaps[t],a=s.get(i);if(void 0===a)return!1;let o=r.typeToIds[t],l=n[t].serializedBytes,d=lK(r,n,t,-l);lZ(r,n,t,d,0,a,0,o.length-1),lZ(r,n,t,d,a+1,o.length,a,o.length-1),o.splice(a,1),s.delete(i);for(let e=a,t=o.length;e<t;++e)s.set(o[e],e);return r.data=d,e.bufferValid=!1,!0}lJ=lU([i0("annotation.MetadataChunkSource")],lJ);class lQ extends iY{chunkManager;OPTIONS;key;metadataChunkSource;segmentFilteredSources;spatiallyIndexedSources;rank;relationships;properties;annotationPropertySerializers;constructor(e,t){super(),this.chunkManager=e,this.spatiallyIndexedSources=new Set,this.temporary=function(){let e=[],t=[],i=[];for(let n of eq)e[n]=[],t[n]=0,i[n]=new Map;return new lj(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:t,typeToIds:e,typeToIdMaps:i})}(),this.references=new Map,this.localUpdates=new Map,this.numCommitsInProgress=0,this.changed=new ez.K_,this.readonly=!1,this.metadataChunkSource=this.registerDisposer(new lJ(this.chunkManager,this)),this.rank=t.rank,this.properties=new Z.SN(t.properties),this.annotationPropertySerializers=eX(this.rank,this.properties.value);let i=this.segmentFilteredSources=[],{relationships:n}=t;this.relationships=n;for(let t=0,r=n.length;t<r;++t)i.push(this.registerDisposer(new lq(e,this,t)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw Error("not implemented")}temporary;references;localUpdates;initializeCounterpart(e,t){for(let t of(this.metadataChunkSource.initializeCounterpart(e,{}),this.segmentFilteredSources))t.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(e=>e.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=tn();let i=new ej(e.id);return i.value=e,this.references.set(i.id,i),i.registerDisposer(()=>{this.references.delete(i.id)}),this.applyLocalUpdate(i,!1,t,e),i}applyLocalUpdate(e,t,i,n){let{localUpdates:r}=this,{id:s}=e,a=this.localUpdates.get(s),o=e.value;if(null==o)throw Error("Cannot create local update from null annotation");if(void 0===a?(a={type:o.type,reference:e.addRef(),existingAnnotation:t?o:void 0,pendingCommit:void 0,commitInProgress:void 0},r.set(s,a),this.forEachPossibleChunk(o,e=>{let{data:t}=e;if(void 0!==t)lX(t,o.type,s,this.annotationPropertySerializers)}),null!==n&&lY(this.temporary.data,n,this.annotationPropertySerializers)):(null===n?lX(this.temporary.data,o.type,o.id,this.annotationPropertySerializers):lY(this.temporary.data,n,this.annotationPropertySerializers),e.value=n),i){if(void 0!==a.commitInProgress)a.pendingCommit=n;else{if(null===n&&void 0===a.existingAnnotation){r.delete(s),a.reference.dispose();return}this.sendCommitRequest(a,n)}}this.notifyChanged(e.id,n||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke("annotation.commit",{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let i=this.references.get(e),n=this.metadataChunkSource.chunks.get(e);void 0!==n&&(n.annotation=t||null),void 0!==i&&(i.value=t||null,i.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(void 0!==t)return t.addRef();t=new ej(e),this.references.set(e,t),this.rpc.invoke("annotation.reference.add",{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke("annotation.reference.delete",{id:this.rpcId,annotation:e})});let i=this.metadataChunkSource.chunks.get(e);return void 0!==i&&(t.value=i.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:i}=e;if(void 0!==i){let e=i.length,{segmentFilteredSources:n}=this;for(let r=0;r<e;++r){let e=i[r];if(void 0===e)return;let s=n[r];for(let i of e){let e=s.chunks.get(lC(i));if(void 0!==e)t(e)}}}let{rank:n}=this,r=new Float32Array(n),s=new Float32Array(n),a=new Float32Array(n);for(let i of this.spatiallyIndexedSources){switch(e.type){case eW.POINT:to.DC(r,i.multiscaleToChunkTransform,n+1,e.point,n),s.set(r);break;case eW.LINE:case eW.AXIS_ALIGNED_BOUNDING_BOX:to.DC(r,i.multiscaleToChunkTransform,n+1,e.pointA,n),to.DC(s,i.multiscaleToChunkTransform,n+1,e.pointB,n);break;case eW.ELLIPSOID:to.DC(r,i.multiscaleToChunkTransform,n+1,e.center,n),to.lU(s,i.multiscaleToChunkTransform,n+1,e.radii,n);for(let e=0;e<n;++e){let t=r[e],i=s[e];r[e]=t-i,s[e]=t+i}}let o=1;for(let e=0;e<n;++e){let t=r[e],i=s[e],n=Math.min(t,i),a=Math.max(t,i);r[e]=Math.ceil(n-1),s[e]=Math.floor(a+1),o*=s[e]-r[e]}let{chunks:l}=i;for(let e=0;e<o;++e){let i=e;for(let e=0;e<n;++e){let t=r[e],n=s[e]-t,o=a[e]=i%n;i=(i-o)/n}let o=l.get(a.join());void 0!==o&&t(o)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let i=this.localUpdates.get(e);if(void 0===i||void 0===i.commitInProgress)throw Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),null!==t&&i.reference.id!==t.id){if(null===i.commitInProgress)throw Error("Received invalid successful update notification");i.reference.id=t.id,this.references.delete(e),this.references.set(t.id,i.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,i),null!==i.reference.value&&(i.reference.value.id=t.id,lX(this.temporary.data,i.type,e,this.annotationPropertySerializers),lY(this.temporary.data,i.reference.value,this.annotationPropertySerializers)),i.reference.changed.dispatch()}i.existingAnnotation=t||void 0,i.commitInProgress=void 0;let{pendingCommit:n}=i;i.pendingCommit=void 0,null===t&&(n=void 0),void 0!==n?(null!==n&&(n.id=t.id),this.sendCommitRequest(i,n)):this.revertLocalUpdate(i)}numCommitsInProgress;commitStatus;disposed(){let{commitStatus:e}=this;void 0!==e&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,0===this.numCommitsInProgress?void 0!==this.commitStatus&&(this.commitStatus.dispose(),this.commitStatus=void 0):void 0===this.commitStatus&&(this.commitStatus=new ai(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let i=this.localUpdates.get(e);if(void 0===i||void 0===i.commitInProgress)throw Error("Received invalid update notification");new ai().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(i),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){lX(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);let{existingAnnotation:t}=e;void 0!==t&&this.forEachPossibleChunk(t,e=>{let{data:i}=e;void 0!==i&&lY(i,t,this.annotationPropertySerializers)});let{reference:i}=e,{id:n}=i;i.value=t||null,i.changed.dispatch(),i.dispose(),this.localUpdates.delete(n)}changed;*[Symbol.iterator](){}readonly;childAdded;childUpdated;childCommitted;childDeleted}iq("annotation.commit",function(e){let t=this.get(e.id),i=e.annotationId,n=e.error;if(void 0!==n)t.handleFailedUpdate(i,n);else{let n=ta(e.newAnnotation);t.handleSuccessfulUpdate(i,n)}});let l0={offset:0,completions:[]};function l1(e,t){return t.offset+=e,t}function l2(e,t){let i=[];for(let n of t)n.startsWith(e)&&i.push({value:n});return i.sort((e,t)=>(0,ac.B)(e.value,t.value)),i}function l3(e,t,i,n){let r=[];for(let s of t){let t=i(s);t.startsWith(e)&&r.push({value:t,description:n(s)})}return r.sort((e,t)=>(0,ac.B)(e.value,t.value)),r}async function l4(e,t,i){if(e.startsWith("{"))return l0;let n=e.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],r=e.length-n.length,s=n.indexOf("=");if(-1===s){let e=await t(n);return{offset:e.offset+r,completions:e.completions.map(e=>({...e,value:`${e.value}=`}))}}return l1(r+s+1,await i(n.substring(0,s),n.substring(s+1)))}async function l6(e,t){return l4(e,async e=>{let i=[];for(let n of t){let t=n.key;t.value.startsWith(e)&&i.push(t)}return{offset:0,completions:i}},async(e,i)=>{for(let n of t)if(n.key.value===e)return{offset:0,completions:n.values.filter(e=>e.value.startsWith(i))};return l0})}class l5 extends Error{redirectTarget;constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function l8(e,t){void 0===t&&(t=-1===e.indexOf("/")?":":"/");let i=e.lastIndexOf(t);return -1===i?0:i+1}var l7=((V={})[V.annotations=0]="annotations",V[V.equivalences=1]="equivalences",V);function l9(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}class de extends ef.gj{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}let dt="local://annotations",di="local://equivalences";class dn extends de{get description(){return"Local in-memory"}async get(e){switch(e.url){case dt:{let t;let{transform:i}=e;if(void 0===i){let{rank:i,names:n,scales:r,units:s}=e.globalCoordinateSpace.value,a=tR({rank:i,scales:r,units:s,names:n.map((e,t)=>`${t}`)}),o=tR({rank:i,scales:r,units:s,names:n});t={rank:i,sourceRank:i,inputSpace:a,outputSpace:o,transform:(0,to.XD)(Float64Array,i+1)}}else t=tj(tM);return{modelTransform:t,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case di:return{modelTransform:tj(tM),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:l3(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],e=>e.value,e=>e.description)}}}let dr=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class ds extends ef.gj{credentialsManager;constructor(e){super(),this.credentialsManager=e,this.dataSources=new Map([["local",new dn]])}dataSources;register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){let t=e.match(dr);if(null===t||void 0===t[1])throw Error('Data source URL must have the form "<protocol>://<path>".');let[,i,n]=t,r=this.dataSources.get(i);if(void 0===r)throw Error(`Unsupported data source: ${JSON.stringify(i)}.`);return[r,n,i]}async get(e){let t=new Set,{abortSignal:i}=e,n=e.url;for(;;){let[r,s,a]=this.getProvider(e.url);t.add(e.url);try{return r.get({...e,url:n,providerProtocol:a,providerUrl:s,registry:this,abortSignal:i??new AbortController().signal,credentialsManager:this.credentialsManager})}catch(e){if(e instanceof l5){let i=e.redirectTarget;if(t.has(i))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);n=i;continue}throw e}}}convertLegacyUrl(e){try{let[t,i,n]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:i,providerProtocol:n,registry:this})}catch{return e.url}}normalizeUrl(e){try{let[t,i,n]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:i,providerProtocol:n,registry:this})}catch{return e.url}}async completeUrl(e){let{url:t,abortSignal:i}=e,n=t.match(dr),r=n[1];if(void 0===r)return Promise.resolve({offset:0,completions:l3(t,this.dataSources,([e])=>`${e}://`,([,e])=>e.description)});let s=this.dataSources.get(r);if(void 0!==s){let a=await s.completeUrl({registry:this,url:t,providerUrl:n[2],chunkManager:e.chunkManager,abortSignal:i??new AbortController().signal,credentialsManager:this.credentialsManager});return l1(r.length+3,a)}throw null}suggestLayerName(e){let[t,i]=this.getProvider(e);i.endsWith("/")&&(i=i.substring(0,i.length-1));let n=t.suggestLayerName;return void 0!==n?n(i):function(e,t){let i=l8(e,void 0);return e.substring(i)}(i)}findSourceGroup(e){let[t,i,n]=this.getProvider(e);return(t.findSourceGroup||l8)(i)+n.length+3}}var da=i("8709");function dl(e){return"boolean"==typeof e?{enabled:e}:((0,eb.PT)(e),{enabled:(0,eb.Kh)(e,"enabled",eb.JG)})}function dd(e,t){return"string"==typeof e?{url:e,transform:t,enableDefaultSubsources:!0,subsources:new Map}:((0,eb.PT)(e),{url:(0,eb.uq)(e,"url",eb.ZE),transform:(0,eb.uq)(e,"transform",t8)||t,enableDefaultSubsources:(0,eb.Kh)(e,"enableDefaultSubsources",eb.JG,!0),subsources:(0,eb.Kh)(e,"subsources",e=>(0,eb.ZI)(e,dl),new Map),state:(0,eb.Kh)(e,"state",eb.PT)})}function du(e){let t=t7(e.transform),i={},n=!0;for(let[t,r]of e.subsources){let e=r.enabled;void 0!==e&&(i[t]=e,n=!1)}return void 0===t&&n&&!0===e.enableDefaultSubsources&&void 0===e.state?e.url:{url:e.url,transform:t,subsources:n?void 0:i,enableDefaultSubsources:!0===e.enableDefaultSubsources&&void 0,state:e.state}}class dc{loadedDataSource;subsourceEntry;subsourceSpec;subsourceIndex;subsourceToModelSubspaceTransform;modelSubspaceDimensionIndices;enabled;activated;guardValues;messages;isActiveChanged;constructor(e,t,i,n,r){let s;this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=i,this.subsourceIndex=n,this.activated=void 0,this.guardValues=[],this.messages=new i_,this.isActiveChanged=new ez.K_,s=void 0===i||void 0===i.enabled?t.default&&r:i.enabled;let a=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:o}=t;if(void 0===o){o=Array(a);for(let e=0;e<a;++e)o[e]=e}let{subsourceToModelSubspaceTransform:l=to.XD(Float32Array,o.length+1)}=t;this.enabled=s,this.subsourceToModelSubspaceTransform=l,this.modelSubspaceDimensionIndices=o,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),void 0!==this.activated){if((0,Y.cO)(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t,e(this.activated=new ef.gj),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:iO.error,message:e});let{activated:t}=this;void 0!==t&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:i,transform:n}=this.loadedDataSource;return t.registerDisposer(ia(i.manager.root.coordinateSpace,i.localPosition.coordinateSpace,n,this,e))}}class dh extends ef.gj{layerDataSource;dataSource;error;enabledSubsourcesChanged;activatedSubsourcesChanged;messages;transform;subsources;enableDefaultSubsources;get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}constructor(e,t,i){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new ez.K_,this.activatedSubsourcesChanged=new ez.K_,this.messages=new i_,t.canChangeModelSpaceRank?(this.transform=new t2(tj(tR({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new t2(t.modelTransform),void 0!==i.transform&&(this.transform.spec=i.transform);let n=i.subsources;this.enableDefaultSubsources=i.enableDefaultSubsources,this.subsources=t.subsources.map((e,t)=>new dc(this,e,n.get(e.id),t,this.enableDefaultSubsources))}disposed(){for(let e of this.subsources){let{activated:t}=e;void 0!==t&&(e.activated=void 0,t.dispose())}}}class dp extends ef.gj{layer;changed;messages;loadState_;spec_;specGeneration;refCounted_;constructor(e,t){super(),this.layer=e,this.changed=new ez.K_,this.messages=new i_,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),this.registerDisposer(e.messages.addChild(this.messages)),void 0===t?this.spec_=l9():this.spec=t}get spec(){let{loadState:e}=this;if(void 0!==e&&void 0===e.error){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let i=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==i?t.enabled:void 0}]})),state:this.spec.state})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),0===e.url.length){if(1!==t.dataSources.length){let e=t.dataSources.indexOf(this);if(-1!==e){t.dataSources.splice(e,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,void 0!==this.refCounted_&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let i=new ef.gj,n=i.registerDisposer((0,ef.oq)(t.markLoading()));void 0!==this.refCounted_&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=i,this.spec_=e;let r=t.manager.chunkManager,s=t.manager.dataSourceProviderRegistry,a=new AbortController;this.messages.addMessage({severity:iO.info,message:"Loading data source"}),s.get({chunkManager:r,url:e.url,abortSignal:a.signal,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform,state:e.state}).then(r=>{if(i.wasDisposed)return;this.messages.clearMessages();let s=i.registerDisposer(new dh(this,r,e));s.registerDisposer(t.addCoordinateSpace(s.transform.outputSpace)),s.registerDisposer(s.transform.changed.add(this.changed.dispatch)),this.loadState_=s,s.registerDisposer(s.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),r.state&&i.registerDisposer(r.state.changed.add(()=>{this.spec.state=r.state?.toJSON(),t.specificationChanged.dispatch()})),n()}).catch(e=>{!this.wasDisposed&&(this.loadState_={error:e},this.messages.clearMessages(),this.messages.addMessage({severity:iO.error,message:e.message}),this.changed.dispatch())}),i.registerDisposer(()=>{a.abort()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;void 0!==e&&e.dispose()}toJSON(){let{loadState:e}=this;return void 0===e||void 0!==e.error?du(this.spec):du({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let i=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==i?t.enabled:void 0}]})),state:this.spec.state})}}let dg={side:"right",col:0,row:1/0,flex:1,size:300,minSize:100,visible:!1};class dm{defaultValue;value;changed;locationChanged;watchableVisible;constructor(e=dg,t=e){this.defaultValue=e,this.value=t,this.changed=new ez.MZ,this.locationChanged=new ez.MZ,this.locationChanged.add(this.changed.dispatch);let i=this;this.watchableVisible={get value(){return i.visible},set value(value){i.visible=value},changed:i.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:i}=this;for(let n in i){if(i[n]!==e[n])t[n]=i[n]}return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(void 0===e)return;(0,eb.PT)(e);let i={side:(0,eb.Kh)(e,"side",e=>{if("left"!==e&&"right"!==e&&"top"!==e&&"bottom"!==e)throw Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(e)}`);return e},t.side),col:(0,eb.Kh)(e,"col",eb.jz,t.col),row:(0,eb.Kh)(e,"row",eb.jz,t.row),flex:(0,eb.Kh)(e,"flex",eb.jz,t.flex),size:(0,eb.Kh)(e,"size",eb.Sc,t.size),visible:(0,eb.Kh)(e,"visible",eb.JG,t.visible),minSize:t.minSize};this.value=i,this.locationChanged.dispatch()}}let df="tabs",dv="panels",dy={...dg,row:0},db={...dg,visible:!0,row:0};class dS extends ef.gj{panels;layer;location;constructor(e){super(),this.panels=e,this.location=new dm(db),this.tabsChanged=new ez.MZ,this.selectedTab=new Z.SN(void 0),this.tabs=[],this.layer=this.panels.layer}initialize(){let{panels:e}=this;for(let t of(this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:i}=t.manager.root;if(i.layer?.layer!==t||this!==t.panels.panels[0])return;let n=this.location.value;i.location.value!==n&&(i.location.value=n,i.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{if(!this.location.visible)this!==this.panels.panels[0]&&this.panels.removePanel(this)}),this.tabs)){let{hidden:e}=this.layer.tabs.options.get(t);e&&this.registerDisposer(e.changed.add(()=>{this.panels.updateTabs(),this.tabsChanged.dispatch()}))}}tabsChanged;selectedTab;explicitTabs;tabs;normalizeTabs(){let{tabs:e}=this;if(0===e.length){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,i=e=>t.get(e).order??0;e.sort((e,t)=>i(e)-i(t));let{selectedTab:n}=this,r=n.value;(void 0===r||!e.includes(r))&&(n.value=e[0])}pin(){let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(t.layer?.layer!==e||this!==e.panels.panels[0]||0===this.tabs.length)return;let{panels:i}=this,n=e.registerDisposer(new dS(i));i.panels.splice(0,1,n),i.panels.push(this),i.updateTabs(),n.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){let{panels:e}=this,t=e.panels.indexOf(this);if(-1===t||0===t)return;let{layer:i}=this,{selectedLayer:n}=i.manager.root,r=n.layer?.layer;n.visible&&null!=r&&r!==i&&r.panels.panels[0].pin(),e.panels.splice(t,1);let[s]=e.panels.splice(0,1,this);if(void 0===this.explicitTabs)i.unregisterDisposer(s);else{e.panels.push(s);for(let t=1,i=e.panels.length;t<i;++t){let i=e.panels[t];void 0===i.explicitTabs&&(i.explicitTabs=new Set(i.tabs))}}this.explicitTabs=void 0,e.updateTabs(),n.layer=i.managedLayer,n.location.value=this.location.value,n.location.locationChanged.dispatch(),n.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:i}=this;{let{explicitTabs:t}=this;void 0!==t&&t.delete(e)}let{layer:n}=this,r=n.registerDisposer(new dS(i));r.location.value=t,r.explicitTabs=new Set([e]),i.panels.splice(1,0,r),i.updateTabs(),r.initialize(),n.manager.root.layerManager.layersChanged.dispatch(),i.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:t}=this;void 0!==t&&t.delete(e)}{let{explicitTabs:i}=t;void 0!==i&&i.add(e)}let{panels:i}=this;i.updateTabs(),t.selectedTab.value=e,i.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(void 0!==t)for(let e of this.tabs)t.add(e);let{panels:i}=this;i.removePanel(this)}}class dw{layer;panels;specificationChanged;updating;constructor(e){this.layer=e,this.specificationChanged=new ez.MZ,this.updating=!1,this.panels=[e.registerDisposer(new dS(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=(0,eb.Kh)(e,"tab",eb.ZE);let{layer:i}=this,{tabs:n}=i,r=new Set(n.options.keys());(0,eb.Kh)(e,dv,e=>(0,eb.m7)(e,e=>{(0,eb.PT)(e);let n=new dS(this);if(n.location.restoreState(e),!!n.location.visible)n.selectedTab.value=(0,eb.Kh)(e,"tab",eb.ZE),n.explicitTabs=(0,eb.Kh)(e,df,e=>{let t=new Set;for(let i of(0,eb.zE)(e))r.has(i)&&(r.delete(i),t.add(i));return t}),void 0===n.explicitTabs?(n.tabs=Array.from(r),r.clear()):n.tabs=Array.from(n.explicitTabs),0!==n.tabs.length&&(n.normalizeTabs(),i.registerDisposer(n),n.initialize(),t.push(n))})),t[0].tabs=Array.from(r),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){let{layer:e}=this,{tabs:t}=e,i=new Set(t.options.keys()),{panels:n}=this;this.updating=!0;let r=e=>{let t=e.tabs;if(void 0===e.explicitTabs)e.tabs=Array.from(i),i.clear();else for(let t of(e.tabs=Array.from(e.explicitTabs),e.tabs))i.delete(t);!(0,Y.cO)(t,e.tabs)&&(e.normalizeTabs(),e.tabsChanged.dispatch())};for(let t=1;t<n.length;){let i=n[t];if(i.location.visible&&(r(i),0!==i.tabs.length)){++t;continue}n.splice(t,1),e.unregisterDisposer(i)}if(r(n[0]),0===n[0].tabs.length){let{selectedLayer:e}=this.layer.manager.root;e.layer?.layer===this.layer&&(e.location.visible=!1)}this.updating=!1}toJSON(){let{panels:e}=this,t={};if(t.tab=e[0].selectedTab.value,e.length>1){let i=[];for(let t=1,n=e.length;t<n;++t){let n=e[t],r=n.location.toJSON()??{};r.tab=n.selectedTab.value;let{explicitTabs:s}=n;void 0!==s&&(r[df]=Array.from(s)),i.push(r)}t[dv]=i}return t}}function dC(e,t){e.remove(t)}function dx(e,t){e.add(t)}let dE="tool",dT="toolBindings",dk="localPosition",dD="localVelocity",dP="localDimensions",dL="source",dI="pick";class dR{callbacks=[];defer(e){this.callbacks.push(e)}}let dA=[];class dM extends ef.gj{managedLayer;get localPosition(){return this.managedLayer.localPosition}get localVelocity(){return this.managedLayer.localVelocity}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}static type;static typeAbbreviation;get type(){return this.constructor.type}static supportsPickOption=!1;pick;selectionState;messages;layerEventListeners;dispatchLayerEvent(e){this.layerEventListeners.get(e)?.dispatch()}registerLayerEvent(e,t){let{layerEventListeners:i}=this,n=i.get(e);!n&&(n=new ez.MZ,i.set(e,n));let r=n.add(t);return()=>r()}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=tC,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let{rank:i}=e.localCoordinateSpace=this.localCoordinateSpace.value;if(0!==i){let n=(0,eb.Kh)(t,dk,e=>(0,eb.Iw)(new Float32Array(i),e,eb.jz));void 0===n?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=n)}void 0!==(e.annotationId=(0,eb.Kh)(t,"annotationId",eb.ZE))&&(e.annotationSourceIndex=(0,eb.Kh)(t,"annotationSource",eb.C$,0),e.annotationPartIndex=(0,eb.Kh)(t,"annotationPart",eb.C$),e.annotationSubsource=(0,eb.Kh)(t,"annotationSubsource",eb.ZE)),e.value=t.value}displaySelectionState(e,t,i){return!1}selectionStateToJson(e,t){let i={};if(e.localPositionValid){let{localPosition:t}=e;t.length>0&&(i.localPosition=Array.from(t))}return void 0!==e.annotationId&&(i.annotationId=e.annotationId,i.annotationPart=e.annotationPartIndex,i.annotationSource=e.annotationSourceIndex,i.annotationSubsource=e.annotationSubsource),null!=e.value&&(i.value=e.value),i}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let i=this.localPosition.value,{localPosition:n}=e;n.length!==i.length?e.localPosition=i.slice():n.set(i),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let i=t.localPosition,{localPosition:n}=e;n.length!==i.length?e.localPosition=i.slice():e.localPosition.set(i),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}layersChanged;readyStateChanged;specificationChanged;renderLayers;loadingCounter;get isReady(){return 0===this.loadingCounter}tabs;panels;tool;toolBinder;dataSourcesChanged;dataSources;get manager(){return this.managedLayer.manager}constructor(e){for(let t of(super(),this.managedLayer=e,this.pick=new nn(!0,!0),this.messages=new i_,this.layerEventListeners=new Map,this.layersChanged=new ez.K_,this.readyStateChanged=new ez.K_,this.specificationChanged=new ez.K_,this.renderLayers=[],this.loadingCounter=1,this.tabs=this.registerDisposer(new sU),this.panels=new dw(this),this.tool=this.registerDisposer(new aI(this)),this.dataSourcesChanged=new ez.K_,this.dataSources=[],this.toolBinder=this.registerDisposer(new aM(this,this.manager.root.toolBinder)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=tY,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.messages.changed.add(this.layersChanged.dispatch),dA))this.tabs.add(t.id,{label:t.label,order:t.order,getter:()=>t.getter(this)})}canAddDataSource(){return!0}addDataSource(e){let t=new dp(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){this.activateDataSubsources((function*(){for(let e of this.dataSources){let{loadState:t}=e;if(void 0!==t&&void 0===t.error)for(let e of t.subsources)if(e.enabled)yield e;else{let{activated:i}=e;e.messages.clearMessages(),void 0!==i&&(i.dispose(),e.activated=void 0,t.activatedSubsourcesChanged.dispatch())}}}).call(this))}decrementLoadingCounter(){0==--this.loadingCounter&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return 1==++this.loadingCounter&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),i=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),i()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,i,n){return void 0===e?[]:[dd(e,i)]}getDataSourceSpecifications(e){let t;let i=(0,eb.uq)(e,dL,e=>Array.isArray(e)?e.map(e=>dd(e)):"object"==typeof e?[dd(e)]:(t=e,[])),n=(0,eb.uq)(e,"transform",t5);return i.push(...this.getLegacyDataSourceSpecifications(t,e,n,i)),0===(i=i.filter(e=>e.url)).length&&i.push(l9()),i}restoreState(e){for(let t of(this.tool.restoreState(e[dE]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[dP]),this.localPosition.restoreState(e[dk]),this.localVelocity.restoreState(e[dD]),this.toolBinder.restoreState(e[dT]),this.constructor.supportsPickOption&&this.pick.restoreState(e[dI]),this.getDataSourceSpecifications(e)))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:i}=this,n=t.indexOf(e);if(-1===n)throw Error("Attempted to remove invalid RenderLayer");t.splice(n,1),e.layerChanged.remove(i.dispatch),e.userLayer=void 0,e.dispose(),i.dispatch()}disposed(){let{layersChanged:e}=this;for(let t of((0,ef.k1)(this.dataSources),this.renderLayers))t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let i;let{renderLayers:n}=this,{pickedRenderLayer:r}=t;if(null!==r&&-1!==n.indexOf(r)&&(i=r.transformPickedValue(t),null!=(i=this.transformPickedValue(i))))return i;for(let t of n)if(null!=(i=t.getValueAt(e)))break;return this.transformPickedValue(i)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[dL]:function(e){if(0!==e.length)return 1===e.length?e[0].toJSON():e.map(e=>e.toJSON())}(this.dataSources),[dE]:this.tool.toJSON(),[dT]:this.toolBinder.toJSON(),[dP]:this.localCoordinateSpace.toJSON(),[dk]:this.localPosition.toJSON(),[dD]:this.localVelocity.toJSON(),[dI]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:i}=this.manager.root,{localPosition:n}=this;(0,Y.zV)(i.value,t,e.globalToRenderLayerDimensions),(0,Y.zV)(n.value,t,e.localToRenderLayerDimensions),n.changed.dispatch(),i.changed.dispatch()}}class dN extends ef.gj{manager;localCoordinateSpace;localCoordinateSpaceCombiner;localPosition;localVelocity;nonArchivedLayerIndex;readyStateChanged;layerChanged;specificationChanged;containers;layer_;get layer(){return this.layer_}unregisterUserLayer;set layer(e){let t=this.layer_;if(null!=t&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,null!=e){let t=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{t.forEach(e=>e())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e?.isReady}name_;get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}visible;archived;get supportsPickOption(){let e=this.layer;return null!==e&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return null!==e&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;null!==t&&t.constructor.supportsPickOption&&(t.pick.value=e)}constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new tO,this.localCoordinateSpaceCombiner=new t4(this.localCoordinateSpace,tZ),this.localPosition=this.registerDisposer(new rO(this.localCoordinateSpace)),this.localVelocity=this.registerDisposer(new rU(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new ez.K_,this.layerChanged=new ez.K_,this.specificationChanged=new ez.K_,this.containers=new Set,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e,this.registerDisposer(new rG(this.manager.root.display,this.localPosition,this.localVelocity))}toJSON(){let e=this.layer;if(null===e)return;let t=e.toJSON();return t.name=this.name,!this.visible&&(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(!0===e)for(let{layerManager:e}of(this.visible=!1,this.archived=!0,this.manager.root.subsets))e.has(this)&&e.removeManagedLayer(this);else{for(let{layerManager:e}of this.manager.root.subsets)!e.has(this)&&e.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class dV extends ef.gj{managedLayers=[];layerSet=new Set;layersChanged=new ez.K_;readyStateChanged=new ez.K_;specificationChanged=new ez.K_;boundPositions=new WeakSet;numDirectUsers=0;nonArchivedLayerIndexGeneration=-1;renderLayerToManagedLayerMapGeneration=-1;renderLayerToManagedLayerMap_=new Map;constructor(){super(),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,ic.Z)(()=>this.removeLayersWithSingleRef(),0));updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let e of this.managedLayers)!e.archived&&(e.nonArchivedLayerIndex=t++);for(let e of this.managedLayers)e.archived&&(e.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let i of this.managedLayers)if(!i.archived){if(t===e)return i;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e)for(let i of(this.renderLayerToManagedLayerMapGeneration=e,t.clear(),this.managedLayers)){let e=i.layer;if(null!==e)for(let n of e.renderLayers)t.set(n,i)}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(i=>!!e(i)||(this.unbindManagedLayer(i),this.layerSet.delete(i),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){if(!(this.numDirectUsers>0))this.filter(e=>1!==e.refCount||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return 1==++this.numDirectUsers&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{0==--this.numDirectUsers&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,dx),this.layerSet.add(e),e.containers.add(this),void 0===t&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers){if(!!e.visible&&!!e.layer)yield*e.layer.renderLayers}}unbindManagedLayer(e){this.updateSignalBindings(e,dC),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.manager.rootLayers.specificationChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(-1===t)throw Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let i=this.managedLayers.length;if(e===t||e<0||e>=i||t<0||t>=i)return;let[n]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,n),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,i=0;for(;void 0!==this.getLayerByName(t);)t=e+ ++i;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers){if(null!==t.layer)for(let e of t.layer.renderLayers)yield e}}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers){if(null!==t.layer&&!!t.visible)for(let e of t.layer.renderLayers)yield e}}}}invokeAction(e){let t=new dR;for(let i of this.managedLayers){if(null===i.layer||!i.visible)continue;let n=i.layer;for(let i of(n.handleAction(e,t),n.renderLayers))i.handleAction(e)}for(let e of t.callbacks)e()}}class dO{changed=new ez.K_;coordinateSpace=tA;position=tC;unsnappedPosition=tC;active=!1;displayDimensions=void 0;pickedRenderLayer=null;pickedValue=new eC.E(0,0);pickedOffset=0;pickedAnnotationLayer=void 0;pickedAnnotationId=void 0;pickedAnnotationBuffer=void 0;pickedAnnotationBufferBaseOffset=void 0;pickedAnnotationIndex=void 0;pickedAnnotationCount=void 0;pickedAnnotationType=void 0;pageX;pageY;forcerFunction=void 0;removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,void 0===e&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return void 0!==e&&(e(),this.active)}setActive(e){(this.active!==e||!0===e)&&(this.active=e,this.changed.dispatch())}}class d_ extends ef.gj{layerManager;mouseState;changed;needsUpdate;constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new ez.K_,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let i of this.layerManager.managedLayers){let n=i.layer;if(i.visible&&null!==n){let{selectionState:i}=n;n.resetSelectionState(i),i.generation=t,n.captureSelectionState(i,e)}}}get(e){this.update();let{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let i=t.layer;if(i){let n=this.get(i);void 0!==n&&(e[t.name]=i.selectionStateToJson(n,!0))}}return e}}let dF={...dg,minSize:150,row:1},dB={...dF,visible:!0};class dU extends ef.gj{coordinateSpace;layerSelectedValues;changed;history;historyIndex;location;constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new ez.K_,this.history=[],this.historyIndex=0,this.location=new dm(dF),this.pin=new Z.SN(!0),this.registerDisposer((0,Z.Uw)((e,i)=>{!i&&(this.capture(!0),e.registerDisposer(t.changed.add(e.registerCancellable((0,da.Z)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}value_;pin;get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return!!this.pin.value&&this.historyIndex+1<this.history.length}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,void 0!==e&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>10&&t.splice(0,t.length-10),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,i=!0){if(!1===i&&(!this.location.visible||this.pin.value))return;let n={};e.initializeSelectionState(n),t(n)&&(this.location.visible=!0,!0===i?this.pin.value=!0:"toggle"===i&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:n}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let e;let{value:t}=this;if(this.location.visible){if(e=this.location.toJSON(dB),this.pin.value&&void 0!==t){let i={};for(let e of t.layers){let{layer:t}=e,n=t.selectionStateToJson(e.state,!1);0===Object.keys(n).length&&(n=void 0),i[e.layer.managedLayer.name]=n}void 0!==t.position&&(e.position=Array.from(t.position)),e.layers=i}}else e=this.location.toJSON(dF),void 0!==(e=(0,eb.$Z)(e))&&(e.visible=!1);return e}select(){let{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){let t=function(e){let{mouseState:t}=e;if(!t.active)return;let i=[];for(let t of e.layerManager.managedLayers){let n=t.layer;if(null===n)continue;let r=e.get(n);if(void 0===r)continue;let s={};n.initializeSelectionState(s),n.copySelectionState(s,r),i.push({layer:n,state:s})}return{position:t.position.slice(),coordinateSpace:t.coordinateSpace,layers:i}}(this.layerSelectedValues);(!e||void 0!==t)&&(this.value=t)}restoreState(e){if(void 0===e){this.pin.value=!0,this.value=void 0;return}if(null===e){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}(0,eb.PT)(e),this.location.restoreState(e,dB);let t=this.coordinateSpace.value,i=(0,eb.Kh)(e,"position",e=>(0,eb.Iw)(new Float32Array(t.rank),e,eb.jz)),n=[];(0,eb.Kh)(e,"layers",e=>{(0,eb.PT)(e);let{layerManager:t}=this.layerSelectedValues;for(let[i,r]of Object.entries(e)){let e=t.getLayerByName(i);if(void 0===e)return;let s=e.layer;if(null===s)return;(0,eb.PT)(r);let a={};s.initializeSelectionState(a),s.selectionStateFromJson(a,r),n.push({layer:s,state:a})}}),this.pin.value=n.length>0||void 0!==i,this.value={position:i,coordinateSpace:t,layers:n}}}class d$ extends ef.gj{view;messages;seenGeneration;state;constructor(e){super(),this.view=e,this.messages=new i_,this.seenGeneration=-1,this.state=void 0}}let dG=0;class dz extends ef.gj{layerManager;renderLayerType;view;roles;layerAdded;visibility;visibleLayers_;debouncedUpdateVisibleLayers;constructor(e,t,i,n,r,s){super(),this.layerManager=e,this.renderLayerType=t,this.view=i,this.roles=n,this.layerAdded=r,this.visibility=s,this.visibleLayers_=new Map,this.debouncedUpdateVisibleLayers=this.registerCancellable((0,ic.Z)(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(n.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++dG,{visibleLayers_:t,renderLayerType:i,layerAdded:n,roles:r}=this;for(let s of this.layerManager.readyRenderLayers())if(s instanceof i&&r.has(s.role)){let i=t.get(s);void 0===i&&((i=new d$(this.view)).registerDisposer(s.messages.addChild(i.messages)),i.registerDisposer(s.addRef()),i.registerDisposer(s.visibility.add(this.visibility)),t.set(s,i),n(s,i),s.attach(i)),i.seenGeneration=e}for(let[i,n]of t)n.seenGeneration!==e&&(t.delete(i),n.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function dj(e,t,i,n,r){return n.registerDisposer(new dz(e,t,n,i,(e,t)=>{t.registerDisposer(e.redrawNeeded.add(()=>n.scheduleRedraw()));let{backend:i}=e;i&&(i.rpc.invoke(iV.ny,{layer:i.rpcId,view:n.rpcId}),t.registerDisposer(()=>i.rpc.invoke(iV.ti,{layer:i.rpcId,view:n.rpcId}))),void 0!==r&&r(e,t),n.scheduleRedraw(),t.registerDisposer(()=>n.scheduleRedraw())},n.visibility))}class dW extends ef.gj{layerManager;changed;location;layer_;get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(!0===e&&void 0===t){let{managedLayers:i}=this.layerManager;i.length>0?t=this.layer=i[0]:e=!1}if(!0===e&&void 0!==t){let i=t.layer;(null===i||0===i.panels.panels[0].tabs.length)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&void 0!==t&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;null!==t&&t instanceof ui&&!t.dataSources.some(e=>0!==e.spec.url.length)&&d9(e)}existingLayerDisposer;constructor(e){super(),this.layerManager=e,this.changed=new ez.K_,this.location=new dm(dy),this.registerDisposer(e),this.location.changed.add(()=>{this.changed.dispatch();let e=this.layer?.layer??void 0;if(void 0!==e){let t=this.location.value;if(t.visible){let i=e.panels.panels[0];i.location.value!==t&&(i.location.value=t,i.location.locationChanged.dispatch())}}})}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(void 0!==t&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,void 0!==e){let t=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(t);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let n=e.layer;if(null!==n){let e=n.tool.value;void 0!==e&&e.deactivate()}e.unregisterDisposer(t),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return void 0!==this.layer&&(e.layer=this.layer.name),(0,eb.$Z)(e)}restoreState(e){if(void 0===e){this.reset();return}(0,eb.PT)(e),this.location.restoreState(e);let t=(0,eb.uq)(e,"layer",eb.kt),i=void 0!==t?this.layerManager.getLayerByName(t):void 0;void 0===i&&(this.visible=!1),this.layer=i}reset(){this.location.reset(),this.layer=void 0}}class dq extends ef.gj{layerManager;filter;layerName_;layer_;changed;constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new ez.K_,this.validate=(0,ic.Z)(()=>{let{layerName_:e}=this;if(void 0!==e){let t=this.layerManager.getLayerByName(e);void 0!==t&&this.filter(t)?this.layer_=t:(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch()}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:e}=this;if(void 0!==e){if(this.layerManager.layerSet.has(e)&&this.filter(e)){let{name:t}=e;t!==this.layerName_&&(this.layerName_=t,this.changed.dispatch())}else this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch()}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){if(this.layer_!==e)void 0!==e&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch()}set layerName(e){if(e!==this.layerName_)this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate()}validate;restoreState(e){let t=(0,eb.kt)(e);this.layerName=t}toJSON(){let{layer_:e}=this;return void 0!==e?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class dH extends ef.gj{layerManager;layer;predicate;getGroup;linkedLayers_;root_;changed;linkedLayersChanged;root;get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}constructor(e,t,i,n){super(),this.layerManager=e,this.layer=t,this.predicate=i,this.getGroup=n,this.linkedLayers_=new Set,this.changed=new ez.K_,this.linkedLayersChanged=new ez.K_,this.root_=t;let r=this;this.root={get value(){return r.root_},changed:r.changed}}reset(){this.isolate()}restoreState(e){if(void 0===e)return;let t=(0,eb.ZE)(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:i,root_:n}=this;if(n===i){let{linkedLayers_:e}=this;if(0!==e.size){for(let i of e){let e=t(i);e.root_=i,e.changed.dispatch()}e.clear(),this.linkedLayersChanged.dispatch()}return}let r=t(n);r.linkedLayers_.delete(i),r.linkedLayersChanged.dispatch(),this.root_=i,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:i}=t,{layerManager:n}=this,r=n.getLayerByName(e);if(void 0===r||r===i)return;let s=r.layer;if(null!==s)this.predicate(s)&&this.linkToLayer(s)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,i=t(e).root_;if(i===this.layer)return;let n=t(i);n.linkedLayers_.add(this.layer),n.linkedLayersChanged.dispatch(),this.root_=i,this.changed.dispatch()}disposed(){this.isolate(!1)}}function dJ(e,t){let i=(0,eb.Kh)(t,"type",eb.ZE,"auto");e.archived=(0,eb.Kh)(t,"archived",eb.JG,!1),e.archived?e.visible=!1:e.visible=(0,eb.Kh)(t,"visible",eb.JG,!0);let n=d1.get(i)||ui;return e.layer=new n(e),t}function dK(e,t){try{let i=e.layer;if(null===i)return;i.restoreState(t),i.initializationDone()}catch(t){throw d9(e),t}}function dZ(e,t){try{(0,eb.PT)(t),dJ(e,t),dK(e,t)}catch(t){throw d9(e),t}}function dY(e,t,i){let n=new dN(t,e);return dZ(n,i),n}class dX extends ef.gj{changed=new ez.K_}class dQ extends dX{display;dataSourceProviderRegistry;layerManager;chunkManager;selectionState;selectedLayer;coordinateSpace;globalPosition;toolBinder;get rpc(){return this.chunkManager.rpc}get root(){return this}coordinateSpaceCombiner;subsets;layerSelectedValues;constructor(e,t,i,n,r,s,a,o,l){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=i,this.chunkManager=n,this.selectionState=r,this.selectedLayer=s,this.coordinateSpace=a,this.globalPosition=o,this.toolBinder=l,this.subsets=new Set,this.coordinateSpaceCombiner=new t4(a,tQ),this.layerSelectedValues=r.layerSelectedValues,this.registerDisposer(i.layersChanged.add(this.changed.dispatch)),this.registerDisposer(i.specificationChanged.add(this.changed.dispatch))}reset(){this.layerManager.clear()}restoreState(e){let t;this.layerManager.clear(),Array.isArray(e)?t=e:((0,eb.PT)(e),t=Object.entries(e).map(([e,t])=>"string"==typeof t?{name:e,source:t}:((0,eb.PT)(t),{...t,name:e})));let i=[];for(let e of t){(0,eb.PT)(e);let t=this.layerManager.getUniqueLayerName((0,eb.uq)(e,"name",eb.ZE)),n=new dN(t,this);try{dJ(n,e),this.layerManager.addManagedLayer(n),i.push({managedLayer:n,spec:e})}catch(e){n.dispose(),new ai().setErrorMessage(`Error creating layer ${JSON.stringify(t)}: `+(e instanceof Error)?e.message:""+e)}}for(let{managedLayer:e,spec:t}of i)try{dK(e,t)}catch(e){new ai().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(e instanceof Error)?e.message:""+e)}}add(e,t){-1===this.layerManager.managedLayers.indexOf(e)&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let i of this.layerManager.managedLayers){let n=i.toJSON();null!=n&&(e.push(n),++t)}if(0!==t)return e}get rootLayers(){return this.layerManager}}class d0 extends dX{master;changed;get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}layerManager;constructor(e){super(),this.master=e,this.changed=new ez.K_,this.layerManager=this.registerDisposer(new dV),this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,i=[];for(let n of new Set((0,eb.m7)(e,eb.ZE))){let e=t.getLayerByName(n);if(void 0===e)throw Error(`Undefined layer referenced in subset specification: ${JSON.stringify(n)}`);!e.archived&&i.push(e)}for(let e of(this.layerManager.clear(),i))this.layerManager.addManagedLayer(e.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){-1===this.master.layerManager.managedLayers.indexOf(e)&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}let d1=new Map,d2=new Map,d3=[e=>{let{volume:t}=e;if(void 0===t)return;let i=d2.get(t.volumeType);if(void 0!==i)return{layerConstructor:i,priority:0}}];function d4(e,t=e.type){d1.set(t,e)}function d6(e){d3.push(e)}function d5(e,t){d2.set(e,t)}function d8(e,t){let i=e.layer;if(null===i)return;let n=i.toJSON(),r=new t(e);r.restoreState(n),r.initializationDone(),e.layer=r}function d7(e,t){return t!==e.name&&(t=e.manager.root.layerManager.getUniqueLayerName(t),e.name=t,e.layerChanged.dispatch(),!0)}function d9(e){if(!e.wasDisposed)for(let t of e.containers)t.removeManagedLayer(e)}function ue(e,t){return void 0===e?t:void 0===t?e:e.priority<t.priority?t:e}function ut(e){let t;for(let i of e){let{subsourceEntry:e}=i,{subsource:n}=e;t=ue(t,function(e){let t;for(let i of d3)t=ue(t,i(e));let{volume:i}=e;if(void 0!==i){let e=d2.get(i.volumeType);void 0!==e&&(t=ue(t,{layerConstructor:e,priority:0}))}return t}(n))}return t}class ui extends dM{static type="new";static typeAbbreviation="new";detectedLayerConstructor;activateDataSubsources(e){this.detectedLayerConstructor=ut(e)?.layerConstructor}}function un(e,t){let i=dY(e,"new layer",{type:"new"});e.add(i),t.layer=i,t.visible=!0}d4(ui),d4(class e extends dM{static type="auto";static typeAbbreviation="auto";activateDataSubsources(e){let t=ut(e)?.layerConstructor;void 0!==t&&d8(this.managedLayer,t)}}),i("447");let ur="selectedAlpha",us="notSelectedAlpha",ua="objectAlpha",uo="saturation",ul="hoverHighlight",ud="hideSegmentZero",uu="baseSegmentColoring",uc="ignoreNullVisibleSet",uh="segments",up="equivalences",ug="colorSeed",um="segmentColors",uf="meshRenderScale",uv="crossSectionRenderScale",uy="skeletonRendering",ub="segmentQuery",uS="meshSilhouetteRendering",uw="linkedSegmentationGroup",uC="linkedSegmentationColorGroup",ux="segmentDefaultColor",uE="anchorSegment",uT="skeletonShaderControl",uk="timestamp",uD="timestampOwner";function uP(e,t,i,n){let r=document.createElement("label");r.classList.add("neuroglancer-layer-control-container");let s=document.createElement("div");s.classList.add("neuroglancer-layer-control-label-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label"),s.appendChild(a);let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label-text-container"),o.appendChild(document.createTextNode(i.label)),a.appendChild(o),i.title&&(a.title=i.title),r.appendChild(s);let{control:l,controlElement:d}=i.makeControl(t,e,{labelContainer:s,labelTextContainer:o,display:t.manager.root.display,visibility:n});return d.classList.add("neuroglancer-layer-control-control"),d.draggable=!0,d.addEventListener("dragstart",e=>{e.stopPropagation(),e.preventDefault()}),r.appendChild(d),{controlContainer:r,label:a,labelContainer:s,labelTextContainer:o,control:l}}i("5621");class uL extends ax{options;constructor(e,t){super(e),this.options=t}isLoading(){return!1}activate(e){if(this.isLoading())return;let{options:t}=this,{layer:i}=this,{isValid:n}=t;if(void 0!==n&&!n(i).value)return;let{header:r,body:s}=aB(e),{controlContainer:a,control:o,labelContainer:l}=uP(e,i,t,new i4(i4.VISIBLE));r.appendChild(l),s.appendChild(a),t.activateTool(e,o)}renderInPalette(e){if(this.isLoading())return;let{controlContainer:t}=uP(e,this.layer,this.options,new i4(i4.VISIBLE));return t.classList.add("neuroglancer-layer-options-control-container"),t}get description(){let{options:e}=this;return e.toolDescription??e.label}toJSON(){return this.options.toolJson}}function uI(e,t,i,n){let{controlContainer:r,label:s}=uP(e,t,i,n);return r.classList.add("neuroglancer-layer-options-control-container"),s.prepend(e.registerDisposer(new aV(t.toolBinder,i.toolJson,r)).element),r}function uR(e,t,i,n){let{isValid:r}=n;return void 0===r?uI(e,t,n,i):e.registerDisposer(new aY(r(t),(e,r,s)=>{e&&r.appendChild(uI(s,t,n,i))},i)).element}function uA(e,t){let{toolJson:i}=t,n="string"==typeof i?i:i.type;aL(e,n,e=>new uL(e,t),(e,i)=>{let r=t.isValid?.(e);return(void 0!==r&&void 0!==i&&r.changed.addOnce(i),t.isValid?.(e).value===!1)?[]:[{type:n}]})}function uM(e){return{makeControl:(t,i)=>{let n=e(t),r=i.registerDisposer(new nr(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}let uN=sh.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function uV(e){return{makeControl:(t,i)=>{let n=e(t),r=i.registerDisposer(new aX(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(uN),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(e.detail)})}}}i("9177");class uO extends ef.gj{value;element;inputElement;numericInputElement;constructor(e,{min:t=0,max:i=1,step:n=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");let{element:r,inputElement:s,numericInputElement:a}=this;r.className="range-slider";let o=e=>{e.min=""+t,e.max=""+i,e.step=""+n,e.valueAsNumber=this.value.value,this.registerEventListener(e,"change",()=>this.inputValueChanged(e)),this.registerEventListener(e,"input",()=>this.inputValueChanged(e)),this.registerEventListener(e,"wheel",t=>{this.adjustViaWheel(e,t)})};s.type="range",o(s),a.type="number";let l=Math.max(t.toString().length,i.toString().length,Math.min(i,t+n).toString().length,Math.max(t,i-n).toString().length);a.style.width=l+2+"ch",o(a),r.appendChild(s),r.appendChild(a),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let i=this.inputElement,{deltaY:n}=t;n>0?(i.stepUp(),this.inputValueChanged(e)):n<0&&(i.stepDown(),this.inputValueChanged(e))}disposed(){sR(this.element),super.disposed()}}let u_=sh.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function uF(e){return{makeControl:(t,i)=>{let{value:n,options:r}=e(t),s=i.registerDisposer(new uO(n,r));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{e.bindInputEventMap(u_),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(t.inputElement,e.detail)})}}}function uB(e,t){let i="";for(let n=0;n<=t&&parseFloat(i=e.toFixed(n))!==e;++n);return i}i("4282");let uU=sh.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});class u$ extends ef.gj{histogram;target;label;element;canvas;legend;legendRenderScale;legendSpatialScale;legendChunks;logScaleOrigin;unitOfTarget;ctx;hoverTarget;throttledUpdateView;debouncedUpdateView;adjustViaWheel(e){let t=this.getWheelMoveValue(e);if(0===t)return;this.hoverTarget.value=void 0;let i=Math.round(this.logScaleOrigin+20),n=ek([2**this.logScaleOrigin,2**(i-1)],this.target.value*2**Math.sign(t));this.target.value=n,e.preventDefault()}constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.logScaleOrigin=-4,this.unitOfTarget="px",this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new Z.SN(void 0),this.throttledUpdateView=this.registerCancellable((0,da.Z)(()=>this.debouncedUpdateView(),200,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable((0,ic.Z)(()=>this.updateView(),0));let{canvas:i,label:n,element:r,legend:s,legendRenderScale:a,legendSpatialScale:o,legendChunks:l}=this;n.className="neuroglancer-render-scale-widget-prompt",r.className="neuroglancer-render-scale-widget",r.title=uU.describe(),s.className="neuroglancer-render-scale-widget-legend",r.appendChild(n),r.appendChild(i),r.appendChild(s),a.title="Target resolution of data in screen pixels",l.title="Number of chunks rendered",s.appendChild(a),s.appendChild(l),s.appendChild(o),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new sy(i,uU)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let d=e=>(function(e,t=-4){return 2**(.5*e+t)})(e.offsetX/i.width*40,this.logScaleOrigin);this.registerEventListener(i,"pointermove",e=>{this.hoverTarget.value=[d(e),e.offsetY]}),this.registerEventListener(i,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(sv(i,"set",e=>{this.target.value=d(e.detail)})),this.registerDisposer(sv(i,"adjust-via-wheel",e=>{this.adjustViaWheel(e.detail)})),this.registerDisposer(sv(i,"reset",e=>{this.reset(),e.preventDefault()}));let u=new ResizeObserver(()=>this.debouncedUpdateView());u.observe(i),this.registerDisposer(()=>u.disconnect()),this.updateView()}getWheelMoveValue(e){return e.deltaY}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let e,{ctx:t}=this,{canvas:i}=this,n=i.width=i.offsetWidth,r=i.height=i.offsetHeight,s=this.target.value,a=this.hoverTarget.value;{let{legendRenderScale:e}=this,t=function(e){if(e<1||e>1024){let t=0|Math.log2(e);return`${uB(e/2**t,1)}p${t}`}return Math.round(e)+""}(void 0===a?s:a[0]);e.textContent=t+" "+this.unitOfTarget}function o(e){return e*n/40}t.clearRect(0,0,n,r);let{histogram:l}=this,{value:d,spatialScales:u}=l;!l.visibility.visible&&d.fill(0);let c=Array.from(u.keys());c.sort();let h=Q.R3.create(),p=1,g=u.size,m=0,f=0;for(let e=0;e<40;++e){let t=0;for(let i=0;i<g;++i){let n=80*i+e,r=d[n],s=d[n+40];m+=r,f+=s,t+=r+s}p=Math.max(t,p)}f-=l.fakeChunkCount;let v=r/Math.log(1+p);function y(e){return r-Math.log(1+e)*v}if(void 0!==a){let t=Math.floor(lT(a[0],this.logScaleOrigin));if(t>=0&&t<40){let i=0,n=a[1];for(let r=g-1;r>=0;--r){let s=c[r],a=2*u.get(s)*40+t,o=d[a]+d[a+40];if(0===o)continue;let l=Math.round(y(i));if(Math.round(y(i+=o))<=n&&n<=l){e=s;break}}}}if(void 0!==e){m=0,f=0;let t=2*u.get(e)*40;for(let e=0;e<40;++e){let i=t+e;m+=d[i],f+=d[i+40]}Number.isFinite(e)?this.legendSpatialScale.textContent=tm(e,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${m}/${m+f}`;let b=c.map(t=>{let i;let n=t===e?.5:1;sk(h,i=Number.isFinite(t)?(.1*Math.log2(t)%1+1)%1:0,n,1);let r=ea(h);return sk(h,i,n,.5),[r,ea(h)]});for(let e=0;e<40;++e){let i=0;for(let r=g-1;r>=0;--r){let s=c[r],a=80*u.get(s)+e,o=d[a],l=d[a+40],h=o+l;if(0===h)continue;let p=Math.round(e*n/40),g=Math.round((e+1)*n/40),m=Math.round(y(i)),f=Math.round(y(i+=h)),v=(o*f+l*m)/h;t.fillStyle=b[r][1],t.fillRect(p,f,g-p,v-f),t.fillStyle=b[r][0],t.fillRect(p,v,g-p,m-v)}}{t.fillStyle="#fff";let e=lT(s,this.logScaleOrigin)*n/40;t.fillRect(Math.floor(e),0,1,r)}if(void 0!==a){let e=a[0];t.fillStyle="#888";let i=lT(e,this.logScaleOrigin)*n/40;t.fillRect(Math.floor(i),0,1,r)}}}let uG=sh.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function uz(e,t=u$){return{makeControl:(i,n)=>{let{histogram:r,target:s}=e(i),a=n.registerDisposer(new t(r,s));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(uG),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(e.detail)}),e.bindAction("reset",e=>{e.stopPropagation(),e.preventDefault(),t.reset()})}}}i("1069");var uj=i("1607");let uW=sh.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function uq(e){return{makeControl:(t,i)=>{let n=e(t),r=i.registerDisposer(new sD(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(uW),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustHueViaWheel(e.detail)})}}}let uH=sh.fromObject({escape:{action:"cancel"}});class uJ extends ef.gj{model;element;constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",t.spellcheck=!1,t.autocomplete="off",this.registerDisposer(new aq(t,uH)).allShortcutsAreGlobal=!0,sv(t,"cancel",e=>{this.updateView(),t.blur(),e.stopPropagation(),e.preventDefault()}),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"blur",()=>this.updateModel()),this.updateView()}disposed(){sR(this.element)}updateView(){this.element.value=(this.model.value??"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}function uK(e,t){t?e.displayState.segmentDefaultColor.value=Q.R3.fromValues(1,0,0):e.displayState.segmentDefaultColor.value=void 0}let uZ=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:ug,...function(){let e=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(t,i,{labelTextContainer:n})=>{let r=document.createElement("input");r.type="radio",r.addEventListener("change",()=>{uK(t,!r.checked)}),n.prepend(r);let s=document.createElement("div");s.classList.add("neuroglancer-segmentation-color-seed-control");let a=i.registerDisposer(new uJ(t.displayState.segmentColorHash));s.appendChild(a.element);let o=sV({svg:uj,title:"Randomize",onClick:()=>e(t)});return s.appendChild(o),i.registerDisposer((0,Z.Jk)(e=>{let t=void 0===e;s.style.visibility=t?"":"hidden",r.checked=t},t.displayState.segmentDefaultColor)),{controlElement:s,control:a}},activateTool:t=>{let{layer:i}=t.tool;uK(i,!1),e(i)}}}()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:ux,...function(){let e=uq(e=>e.displayState.segmentDefaultColor);return{...e,makeControl:(t,i,n)=>{let r=e.makeControl(t,i,n),{controlElement:s}=r,a=document.createElement("input");return a.type="radio",a.addEventListener("change",()=>{uK(t,a.checked),a.checked&&s.click()}),n.labelTextContainer.prepend(a),i.registerDisposer((0,Z.Jk)(e=>{let t=void 0!==e;s.style.visibility=t?"":"hidden",a.checked=t},t.displayState.segmentDefaultColor)),r},activateTool:(t,i)=>{uK(t.tool.layer,!0),e.activateTool(t,i)}}}()},{label:"Saturation",toolJson:uo,title:"Saturation of segment colors",...uF(e=>({value:e.displayState.saturation}))},{label:"Opacity (on)",toolJson:ur,isValid:e=>e.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...uF(e=>({value:e.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:us,isValid:e=>e.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...uF(e=>({value:e.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:uv,isValid:e=>e.has2dLayer,...uz(e=>({histogram:e.sliceViewRenderScaleHistogram,target:e.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:uf,isValid:e=>e.has3dLayer,...uz(e=>({histogram:e.displayState.renderScaleHistogram,target:e.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:ua,isValid:e=>e.has3dLayer,title:"Opacity of meshes and skeletons",...uF(e=>({value:e.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:uS,isValid:e=>e.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...uF(e=>({value:e.displayState.silhouetteRendering,options:{min:0,max:uY,step:.1}}))},{label:"Hide segment ID 0",toolJson:ud,title:"Disallow selection and display of segment id 0",...uM(e=>e.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:uu,title:"Color base segments individually",...uM(e=>e.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:uc,...uM(e=>e.displayState.ignoreNullVisibleSet)},{label:"Highlight on hover",toolJson:ul,title:"Highlight the segment under the mouse pointer",...uM(e=>e.displayState.hoverHighlight)},...uX("2d"),...uX("3d")],uY=10;function uX(e){return[{label:`Skeleton mode (${e})`,toolJson:`${uy}.mode${e}`,isValid:e=>e.hasSkeletonsLayer,...uV(t=>t.displayState.skeletonRenderingOptions[`params${e}`].mode)},{label:`Line width (${e})`,toolJson:`${uy}.lineWidth${e}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${e})`,title:`Skeleton line width (${e})`,...uF(t=>({value:t.displayState.skeletonRenderingOptions[`params${e}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var uQ=i("7688");function u0(e,t,i,n,r,s,a,o){let{lodScales:l}=e,d=0;for(;d+1<l.length&&0!==l[d+1];)++d;let u=[],c=0,h=0;function p(e,t){for(;;){if(0===c)return;let i=c-1,n=d-i,r=u[3*i],s=0===n?1:8,a=u[3*i+1],l=u[3*i+2];if(e===c){let e=t&s-1;h!==e&&-1!==r&&o(n,r,h,e,l),h=e+1;return}h!==s&&-1!==r&&o(n,r,h,s,l),h=a+1,--c}}let g=0,{octree:m}=e;!function(e,t,i,n,r,s,a){let{octree:o,lodScales:l,chunkGridSpatialOrigin:d,chunkShape:u}=e,c=l.length-1,h=t[0],p=t[4],g=t[8],m=t[1],f=t[5],v=t[9],y=t[3],b=t[7],S=t[11],w=t[15],C=y>0?0:1,x=b>0?0:1,E=S>0?0:1,T=i[16],k=i[17],D=i[18],P=i[19];function L(e,t,i){return y*e+b*t+S*i+w}let I=-P*T*y+-P*k*b+-P*D*S+w,R=e.clipLowerBound[0],A=e.clipLowerBound[1],M=e.clipLowerBound[2],N=e.clipUpperBound[0],V=e.clipUpperBound[1],O=e.clipUpperBound[2],_=Math.max(Math.sqrt((h*r)**2+(m*s)**2),Math.sqrt((p*r)**2+(f*s)**2),Math.sqrt((g*r)**2+(v*s)**2));!function e(t,r,s){let c=1<<t,h=5*r,p=o[h],g=o[h+1],m=o[h+2],f=o[h+3],v=o[h+4],T=p*c*u[0]+d[0],k=g*c*u[1]+d[1],D=m*c*u[2]+d[2],P=T+c*u[0],L=k+c*u[1],F=D+c*u[2];if(T=Math.max(T,R),k=Math.max(k,A),D=Math.max(D,M),P=Math.min(P,N),L=Math.min(L,V),F=Math.min(F,O),(0,Q.Rq)(T,k,D,P,L,F,i)){let i=Math.max(I,function(e,t,i,n,r,s){return y*(e+C*(n-e))+b*(t+x*(r-t))+S*(i+E*(s-i))+w}(T,k,D,P,L,F))/_;if(0===s||i*n<s){let o=l[t];if(0!==o&&a(t,r,o/i,v>>>31),t>0&&(0===o||i*n<o)){let i=0===o?s:o,n=(0x7fffffff&v)>>>0;for(let r=f;r<n;++r)e(t-1,r,i)}}}}(c,o.length/5-1,0)}(e,t,i,n,r,s,(e,t,i,n)=>{if(!n&&!a(e,t,i)){g=Math.max(e,g);return}if(e<g)return;g=0;let r=5*t,s=m[r],o=m[r+1],l=1&s|o<<1&2|m[r+2]<<2&4,f=d-e;p(f,l);let v=3*f;u[v]=n?-1:t,u[v+1]=l,u[v+2]=i,h=0,c=f+1}),p(0,0)}function u1(e,t,i){return`${e}/${t}:${i}`}class u2 extends i9{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}var u3=i("1425");let u4=0,u6=0,u5=0,u8=0;class u7{hashSeeds;loadFactor;size;table;tableSize;emptyLow;emptyHigh;maxRehashAttempts;maxAttempts;capacity;generation;mungedEmptyKey;constructor(e=u7.generateHashSeeds(3)){this.hashSeeds=e,this.loadFactor=.8,this.size=0,this.emptyLow=0xffffffff,this.emptyHigh=0xffffffff,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=u7.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,i=Array(t);for(let e=0;e<t;++e)i[e]=this.getHash(e,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:n}=this;if(-1===n)i:for(;;){n=0x1000000*Math.random()>>>0;for(let e=0;e<t;++e){let r=this.getHash(e,n,n);for(let e=0;e<t;++e)if(i[e]===r)continue i}this.mungedEmptyKey=n;break}let{table:r,emptyLow:s,emptyHigh:a}=this;for(let e=0;e<t;++e){let t=i[e];r[t]===s&&r[t+1]===a&&(r[t]=n,r[t+1]=n)}try{e(r)}finally{for(let e=0;e<t;++e){let t=i[e];r[t]===n&&r[t+1]===n&&(r[t]=s,r[t+1]=a)}}}static generateHashSeeds(e=3){return function(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,i=t.length;e<i;e+=65536)crypto.getRandomValues(t.subarray(e,Math.min(i,e+65536)));return e}(new Uint32Array(e))}getHash(e,t,i){let n=this.hashSeeds[e];return n=(0,u3.B)(n,t),n=(0,u3.B)(n,i),this.entryStride*(n&this.tableSize-1)}*keys(){let{emptyLow:e,emptyHigh:t,entryStride:i}=this,{table:n}=this;for(let r=0,s=n.length;r<s;r+=i){let i=n[r],s=n[r+1];(i!==e||s!==t)&&(yield new eC.E(i,s))}}*unsafeKeys(e=new eC.E){let{emptyLow:t,emptyHigh:i,entryStride:n}=this,{table:r}=this;for(let s=0,a=r.length;s<a;s+=n){let n=r[s],a=r[s+1];(n!==t||a!==i)&&(e.low=n,e.high=a,yield e)}}indexOfPair(e,t){let{table:i,emptyLow:n,emptyHigh:r}=this;if(e===n&&t===r)return -1;for(let n=0,r=this.hashSeeds.length;n<r;++n){let r=this.getHash(n,e,t);if(i[r]===e&&i[r+1]===t)return r}return -1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let e,t;let{emptyLow:i,emptyHigh:n,table:r,entryStride:s}=this;for(;;){if(e=0x100000000*Math.random()>>>0,t=0x100000000*Math.random()>>>0,!(e===i&&t===n||this.hasPair(e,t)))break}this.emptyLow=e,this.emptyHigh=t;for(let a=0,o=r.length;a<o;a+=s)r[a]===i&&r[a+1]===n&&(r[a]=e,r[a+1]=t)}has(e){return -1!==this.indexOf(e)}hasPair(e,t){return -1!==this.indexOfPair(e,t)}delete(e){let t=this.indexOf(e);if(-1!==t){let{table:e}=this;return e[t]=this.emptyLow,e[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:i,emptyHigh:n}=this,r=e.length;for(let s=0;s<r;s+=t)e[s]=i,e[s+1]=n}clear(){return 0!==this.size&&(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return!!(e>this.capacity)&&(this.backupPending(),this.grow(e),this.restorePending(),!0)}swapPending(e,t){let i=u4,n=u6;this.storePending(e,t),e[t]=i,e[t+1]=n}storePending(e,t){u4=e[t],u6=e[t+1]}backupPending(){u5=u4,u8=u6}restorePending(){u4=u5,u6=u8}tryToInsert(){let e=0,{emptyLow:t,emptyHigh:i,maxAttempts:n,table:r}=this,s=this.hashSeeds.length,a=Math.floor(Math.random()*s);for(;;){let o=this.getHash(a,u4,u6);if(this.swapPending(r,o),u4===t&&u6===i)return!0;if(++e===n)break;a=(a+Math.floor(Math.random()*(s-1))+1)%s}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:i,emptyHigh:n,entryStride:r}=this;for(let t=0,s=e.length;t<s;t+=r){let r=e[t],s=e[t+1];if((r!==i||s!==n)&&(this.storePending(e,t),!this.tryToInsert()))return!1}return!0}grow(e){let t=this.table,{tableSize:i}=this;for(;i<e;)i*=2;for(;;){for(let e=0;e<this.maxRehashAttempts;++e)if(this.rehash(t,i))return;i*=2}}insertInternal(){for(++this.generation,u4===this.emptyLow&&u6===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(2*this.tableSize),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class u9 extends u7{add(e){let{low:t,high:i}=e;return!this.hasPair(t,i)&&(u4=t,u6=i,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}}u9.prototype.entryStride=2;let ce=0,ct=0,ci=0,cn=0;class cr extends u7{set(e,t){let{low:i,high:n}=e;return!this.hasPair(i,n)&&(u4=i,u6=n,ce=t.low,ct=t.high,this.insertInternal(),!0)}get(e,t){let i=this.indexOf(e);if(-1===i)return!1;let{table:n}=this;return t.low=n[i+2],t.high=n[i+3],!0}swapPending(e,t){let i=ce,n=ct;super.swapPending(e,t),e[t+2]=i,e[t+3]=n}storePending(e,t){super.storePending(e,t),ce=e[t+2],ct=e[t+3]}backupPending(){super.backupPending(),ci=ce,cn=ct}restorePending(){super.restorePending(),ce=ci,ct=cn}[Symbol.iterator](){return this.unsafeEntries()}*entries(){let{emptyLow:e,emptyHigh:t,entryStride:i}=this,{table:n}=this;for(let r=0,s=n.length;r<s;r+=i){let i=n[r],s=n[r+1];if(i!==e||s!==t){let e=new eC.E(i,s),t=new eC.E(n[r+2],n[r+3]);yield[e,t]}}}*unsafeEntries(e=[new eC.E,new eC.E]){let{emptyLow:t,emptyHigh:i,entryStride:n}=this,{table:r}=this,[s,a]=e;for(let o=0,l=r.length;o<l;o+=n){let n=r[o],l=r[o+1];(n!==t||l!==i)&&(s.low=n,s.high=l,a.low=r[o+2],a.high=r[o+3],yield e)}}}cr.prototype.entryStride=4;class cs{texelsPerElement;textureInternalFormat;textureFormat;texelType;arrayElementsPerTexel;arrayConstructor;samplerPrefix}let ca=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],co=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],cl=["","r","rg","rgb","rgba"],cd=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],cu=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],cc=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],ch=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],cp=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],cg=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],cm=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function cf(e){return e===ec.FLOAT32?"":eh[e]?"i":"u"}function cv(e,t,i=1){switch(t){case ec.UINT8:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=cd[i],e.textureFormat=ca[i],e.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,e.arrayElementsPerTexel=i,e.arrayConstructor=Uint8Array,e.samplerPrefix="u",e;case ec.INT8:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=cu[i],e.textureFormat=ca[i],e.texelType=WebGL2RenderingContext.BYTE,e.arrayElementsPerTexel=i,e.arrayConstructor=Int8Array,e.samplerPrefix="i",e;case ec.UINT16:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=cc[i],e.textureFormat=ca[i],e.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,e.arrayElementsPerTexel=i,e.arrayConstructor=Uint16Array,e.samplerPrefix="u",e;case ec.INT16:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=ch[i],e.textureFormat=ca[i],e.texelType=WebGL2RenderingContext.SHORT,e.arrayElementsPerTexel=i,e.arrayConstructor=Int16Array,e.samplerPrefix="i",e;case ec.UINT32:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=cp[i],e.textureFormat=ca[i],e.texelType=WebGL2RenderingContext.UNSIGNED_INT,e.arrayElementsPerTexel=1,e.arrayConstructor=Uint32Array,e.samplerPrefix="u",e;case ec.INT32:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=cg[i],e.textureFormat=ca[i],e.texelType=WebGL2RenderingContext.INT,e.arrayElementsPerTexel=1,e.arrayConstructor=Int32Array,e.samplerPrefix="i",e;case ec.UINT64:if(i<1||i>2)break;return e.texelsPerElement=1,e.textureInternalFormat=cp[2*i],e.textureFormat=ca[2*i],e.texelType=WebGL2RenderingContext.UNSIGNED_INT,e.arrayElementsPerTexel=2*i,e.arrayConstructor=Uint32Array,e.samplerPrefix="u",e;case ec.FLOAT32:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=cm[i],e.textureFormat=co[i],e.texelType=WebGL2RenderingContext.FLOAT,e.arrayElementsPerTexel=i,e.arrayConstructor=Float32Array,e.samplerPrefix="",e}throw Error(`No supported texture format for ${ec[t]}[${i}].`)}function cy(e,t,i){let{arrayConstructor:n,arrayElementsPerTexel:r,textureInternalFormat:s,textureFormat:a,texelsPerElement:o}=t,{maxTextureSize:l}=e,d=i.length/r;if(d*o>l*l)throw Error("Number of elements exceeds maximum texture size: "+o+" * "+d);let u=Math.ceil(Math.log2(Math.ceil(d/l))),c=(1<<u)*o,h=Math.ceil(d/(1<<u));i.constructor!==n&&(i=new n(i.buffer,i.byteOffset,i.byteLength/n.BYTES_PER_ELEMENT));let p=(0,Y.x0)(i,c*h*r);e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),nP(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,c,h,0,a,t.texelType,p)}function cb(e,t,i,n,r,s){let a=rn(r,s),o=[function(e){switch(e){case ec.UINT8:return nY;case ec.INT8:return nX;case ec.UINT16:return n0;case ec.INT16:return n1;case ec.UINT32:return n2;case ec.INT32:return n3;case ec.UINT64:return nG;case ec.FLOAT32:return nQ}}(r)],l=`
${a} ${e}(${n} index) {
`;switch(r){case ec.UINT8:case ec.UINT16:case ec.UINT32:l+=`
  ${a} result;
  highp uvec4 temp;
  ${t}(${i}, index, temp);
  result.value = temp.${cl[s]};
  return result;
`;break;case ec.INT8:case ec.INT16:case ec.INT32:l+=`
  ${a} result;
  highp ivec4 temp;
  ${t}(${i}, index, temp);
  result.value = temp.${cl[s]};
  return result;
`;break;case ec.UINT64:o.push(nz),l+=`
  highp uvec4 temp;
  ${t}(${i}, index, temp);
  return unpackUint64leFromUint32(temp.${cl[2*s]});
`;break;case ec.FLOAT32:o.push(nQ),l+=`
  highp vec4 temp;
  ${t}(${i}, index, temp);
  return temp.${cl[s]};
`}return o.push(l+=`
}
`),o}class cS{key;readTextureValue;constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${e}`}defineShader(e){}getReadTextureValueCode(e,t){let i=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let n=0;n<e;++n)i+=`, out ${t}vec4 output${n}`;i+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let t=0;t<e;++t)i+=`
  output${t} = texelFetch(sampler, ivec2(x + ${t}, y), 0);
`;return[n6,i+=`
}
`]}getAccessor(e,t,i,n=1){let r=cf(i);return[this.getReadTextureValueCode(1,r),...cb(e,this.readTextureValue,t,"highp uint",i,n)]}}class cw{key;textureDims;readTextureValue;constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${e}`}getReadTextureValueCode(e,t){let{textureDims:i}=this,n=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${i} p`;for(let i=0;i<e;++i)n+=`, out ${t}vec4 output${i}`;n+=`) {
`;for(let t=0;t<e;++t)n+=`
  output${t} = texelFetch(sampler, ivec${i}(p.x * ${e} + ${t}, p.y
                                         ${3===i?", p.z":""}), 0);
`;return n+=`
}
`}getAccessor(e,t,i,n=1){let r=cf(i);return[this.getReadTextureValueCode(1,r),...cb(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,i,n)]}}let cC=[nG,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],cx=cv(new cs,ec.UINT64,1);class cE extends ef.gj{gl;hashTable;generation;texture;constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:i,texture:n}=this;this.generation=t,i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n),e.tableWithMungedEmptyKey(e=>{cy(this.gl,cx,e)}),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new cE(e,t))}}class cT{prefix;numAlternatives;textureUnitSymbol;accessHelper;samplerName;hashSeedsName;hashKeyMask;readTable;constructor(e,t=3){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`),this.accessHelper=new cS(`gpuhashtable_${this.prefix}`),this.samplerName=e+"_sampler",this.hashSeedsName=e+"_seeds",this.hashKeyMask=e+"_keyMask",this.readTable=e+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:i,numAlternatives:n,hashKeyMask:r}=this;e.addUniform("highp uint",t,n),e.addUniform("highp uint",r),e.addTextureSampler("usampler2D",i,this.textureUnitSymbol),e.addFragmentCode(cC),e.addFragmentCode(nG),e.addFragmentCode(nj),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,ec.UINT64,1));let s="";s+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let e=0;e<n;++e)s+=`
  {
    uint h = hashCombine(${t}[${e}], x) & ${r};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;s+=`
  return false;
}
`,e.addFragmentCode(s)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,i){i.copyToGPU();let n=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i.texture),e.uniform1ui(t.uniform(this.hashKeyMask),i.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),i.hashTable.hashSeeds)}disable(e,t){let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class ck extends cT{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:i,hashKeyMask:n}=this,r=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let e=0;e<t;++e)r+=`
  {
    uint h = hashCombine(${i}[${e}], x) & ${n};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;r+=`
  return false;
}
`,e.addFragmentCode(r)}get getFunctionName(){return`${this.prefix}_get`}}class cD{prefix;seedName;constructor(e){this.prefix=e,this.seedName=e+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(nG),e.addFragmentCode(cC),e.addFragmentCode(n$);let i=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec2 v;
`;for(let e=0;e<2;++e)i+=`
  v[${e}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;i+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(i)}enable(e,t,i){e.uniform1ui(t.uniform(this.seedName),i)}}let cP=new Float32Array(3);function cL(e){return`rgb(${100*e[0]}%,${100*e[1]}%,${100*e[2]}%)`}class cI{hashSeed;changed;constructor(e=eG()){this.hashSeed=e,this.changed=new ez.K_}static getDefault(){return new cI(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let i=(0,u3.B)(this.hashSeed,t.low),n=(255&(i=(0,u3.B)(i,t.high)))/255;return sk(e,n,.5+(i>>8&255)/255*.5,1),e}computeCssColor(e){return this.compute(cP,e),cL(cP)}randomize(){this.hashSeed=eG(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return 0===this.hashSeed?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class cR{prefix;hashMapShaderManager;constructor(e){this.prefix=e,this.hashMapShaderManager=new ck("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec4 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    value.a = float((uintValue & 0xff000000u) >> 24) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,i){this.hashMapShaderManager.enable(e,t,i)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}i("532");function cA(){return void 0===d&&(d=sh.fromObject({"control+mousedown2":"select-position"})),d}function cM(){return void 0===u&&(u=sh.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[cA(),0]]})),u}function cN(){return void 0===c&&(c=sh.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:shift+dblclick0":"star","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[cA(),0]]})),c}i("5214");let cV="neuroglancer-drag-over",cO={row:"row",column:"col"},c_={left:"right",right:"left",top:"bottom",bottom:"top"},cF={left:"column",right:"column",top:"row",bottom:"row"},cB={left:"row",right:"row",top:"column",bottom:"column"},cU={row:"width",column:"height"},c$={row:"left",column:"top"},cG={row:"right",column:"bottom"},cz={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},cj={left:-1,right:1,top:-1,bottom:1};class cW extends ef.gj{sidePanelManager;location;element;visibility;getDragDropDescription(){return"side panel"}constructor(e,t=new dm){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new i4(i4.VISIBLE);let{element:i}=this;i.classList.add("neuroglancer-side-panel"),i.draggable=!0,i.addEventListener("dragstart",e=>{this.sidePanelManager.startDrag(this.makeDragSource(),e),i.style.backgroundColor="black",setTimeout(()=>{i.style.backgroundColor=""},0),aa(e,i,"drag",`Drag ${this.getDragDropDescription()} to move it to the left/right/top/bottom of another panel`)}),i.addEventListener("dragend",e=>{this.sidePanelManager.endDrag(),ao(e,i,"drag")})}canCopy(){return!1}copyToNewLocation(e){}makeDragSource(){return{dropAsNewPanel:(e,t)=>{let i=this.location.value,n={...i,...e};if(console.log({oldLocation:i,newLocation:n}),"copy"===t){this.copyToNewLocation(n);return}this.location.value=n,this.location.locationChanged.dispatch()},getNewPanelDropEffect:e=>{let t=this.getDragDropDescription();return this.canCopy()?{description:t,...ab(e,"move",!0)}:{description:t,dropEffect:"move"}}}}close(){this.location.visible=!1}addTitleBar(e){let t;let i=document.createElement("div");i.classList.add("neuroglancer-side-panel-titlebar");let{title:n}=e;void 0!==n&&((t=document.createElement("div")).classList.add("neuroglancer-side-panel-title"),t.textContent=n,i.appendChild(t));let r=ae({title:"Close panel",onClick:()=>{this.close()}});return r.style.order="100",i.appendChild(r),this.element.appendChild(i),{titleBar:i,titleElement:t,closeButton:r}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",e=>{e.preventDefault(),e.stopPropagation()}),this.element.appendChild(e)}}class cq extends ef.gj{display;center;visibility;element;centerColumn;beforeRender;sides;registeredPanels;dragSource;layoutNeedsUpdate;get visible(){return this.visibility.visible}constructor(e,t,i=new i4(i4.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=i,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new ez.MZ,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new Set,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:n,centerColumn:r}=this;n.style.display="flex",n.style.flex="1",n.style.flexDirection="row",r.style.display="flex",r.style.flex="1",r.style.flexDirection="column",r.style.flexBasis="0px",r.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,cj[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return void 0!==this.dragSource}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,i,n,r=!1){let s=document.createElement("div");s.className="neuroglancer-side-panel-drop-zone";let a=cF[n],l=cB[n];s.style[cU[l]]="10px",s.style[cU[a]]="100%",r?(s.style.position="absolute",s.style[n]="50%",s.style[cz[n]]="-${size/2}px"):(s.style.position="relative",s.style[cz[c_[n]]]="-10px");let d=e=>{let{dragSource:t}=this;if(void 0===t)return!1;e.preventDefault();let{dropEffect:i,description:n,dropEffectMessage:r,leaveHandler:o}=t.getNewPanelDropEffect(e);av(e,i);let l=`Drop to ${i} ${n} to new ${a}`;return r&&(l+=` (${r})`),aa(e,s,"drop",l,o),!0};return s.addEventListener("dragenter",e=>{d(e)&&(s.classList.add(cV),e.preventDefault())}),s.addEventListener("dragleave",e=>{ao(e,s,"drop"),s.classList.remove(cV)}),s.addEventListener("dragover",e=>{d(e)&&e.preventDefault()}),s.addEventListener("drop",n=>{let{dragSource:r}=this;if(void 0===r)return;ao(n,s,"drop"),s.classList.remove(cV);let a=cF[e];r.dropAsNewPanel({side:e,row:"column"===a?i:t,col:"row"===a?i:t},o??"none"),this.dragSource=void 0,n.preventDefault(),n.stopPropagation()}),s}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),e.panel?.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e?.dispose();super.disposed()}invalidateLayout;render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let t of this.registeredPanels)e[t.location.value.side].push(t);let t=t=>this.renderSide(t,this.sides[t].flexGroups,e[t]),i=this;sM(this.element,function*(){yield i.sides.left.outerDropZoneElement,yield*t("left"),yield i.centerColumn,yield*t("right"),yield i.sides.right.outerDropZoneElement}());sM(this.centerColumn,function*(){yield i.sides.top.outerDropZoneElement,yield*t("top"),yield i.center,yield*t("bottom"),yield i.sides.bottom.outerDropZoneElement}())}makeCrossGutter(e,t){let i=document.createElement("div");i.style.position="relative";let n=cB[e];i.className=`neuroglancer-resize-gutter-${"row"===n?"horizontal":"vertical"}`,i.addEventListener("pointerdown",r=>{if("button"in r&&0!==r.button)return;r.preventDefault();let s=this.sides[e].flexGroups[t];if(void 0===s||!s.visible)return;let a=s.element.getBoundingClientRect()[cU[n]],o=s.minSize,l=()=>{aa(r,i,"drag",`Drag to resize, current ${cU[n]} is ${s.crossSize}px`)};l(),sb(r,(t,i,r)=>{a-=cj[e]*("row"===n?i:r),s.crossSize=Math.max(o,Math.round(a)),l(),this.invalidateLayout()},e=>{ao(e,i,"drag")})});let r=this.makeDropZone(e,t-.5*cj[e],0,e,!0);return i.appendChild(r),i}makeFlexGutter(e,t,i){let n=document.createElement("div");n.style.position="relative";let r=cF[e];n.className=`neuroglancer-resize-gutter-${"row"===r?"horizontal":"vertical"}`,n.addEventListener("pointerdown",s=>{if("button"in s&&0!==s.button)return;s.preventDefault();let a=this.sides[e].flexGroups[t];if(void 0===a||!a.visible)return;let{cells:o}=a,l=o[i];if(void 0===l||!l.registeredPanel.location.visible)return;let d=i+1;for(;d<o.length&&!o[d].registeredPanel.location.visible;)++d;if(d===o.length)return;let u=o[d],c=e=>{aa(e,n,"drag",`Drag to resize, current ${cU[r]} ratio is ${l.registeredPanel.location.value.flex} : ${u.registeredPanel.location.value.flex}`)};c(s),sb(s,e=>{let t=l.registeredPanel.panel,i=u.registeredPanel.panel;if(void 0===t||void 0===i)return;let n=t.element.getBoundingClientRect(),s=i.element.getBoundingClientRect(),a=Math.max(.1,Math.min(.9,"column"===r?(e.clientY-n.top)/(s.bottom-n.top):(e.clientX-n.left)/(s.right-n.left))),o=l.registeredPanel.location.value,d=u.registeredPanel.location.value,h=o.flex+d.flex;l.registeredPanel.location.value={...o,flex:Math.round(a*h*100)/100},u.registeredPanel.location.value={...d,flex:Math.round((1-a)*h*100)/100},c(e),l.registeredPanel.location.locationChanged.dispatch(),u.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},e=>{ao(e,n,"drag")})});let s=this.makeDropZone(e,t,i+.5,c$[cF[e]],!0);return n.appendChild(s),n}renderSide(e,t,i){let n=cO[cB[e]],r=cO[cF[e]];i.sort((e,t)=>{let i=e.location.value,s=t.location.value,a=i[r]-s[r];return 0!==a?a:i[n]-s[n]});let s=this;return function*(){let a=0,o=i.length,l=0;for(;a<o;){let d=i[a].location.value[r],u=a,c=0,h=0;do{let e=i[u].location.value;if(e[r]!==d)break;e.visible&&(++c,h=Math.max(h,e.minSize)),++u}while(u<o);let p=c>0,g=t[l];if(void 0===g){let i=s.makeCrossGutter(e,l),n=document.createElement("div");n.className=`neuroglancer-side-panel-${cF[e]}`,g=t[l]={element:n,gutterElement:i,cells:[],crossSize:-1,minSize:h,visible:p,beginDropZone:s.makeDropZone(e,l,-1/0,c$[cF[e]]),endDropZone:s.makeDropZone(e,l,Infinity,cG[cF[e]])}}else g.visible=p,g.minSize=h,g.crossSize=Math.max(g.crossSize,h);sM(g.element,function*(){yield g.beginDropZone;let t=0;for(let o=a,d=0;o<u;++o,++d){let a=i[o],u=g.cells[d];void 0===u?u=g.cells[d]={registeredPanel:a,gutterElement:void 0}:u.registeredPanel=a;let p=u.registeredPanel.location.value;-1===g.crossSize&&(g.crossSize=Math.max(h,p.size)),(p[r]!==l||p[n]!==d||p.visible&&p.size!==g.crossSize)&&(u.registeredPanel.location.value={...p,[r]:l,[n]:d,size:p.visible?g.crossSize:p.size},u.registeredPanel.location.changed.dispatch());let m=p.visible&&s.visibility.visible,{panel:f}=a;if(!m){void 0!==f&&(f.dispose(),a.panel=void 0);continue}++t,void 0===f&&(f=a.panel=a.makePanel()),f.element.style.flex=c>1?`${p.flex}`:"1",yield f.element,t===c?u.gutterElement=void 0:(void 0===u.gutterElement&&(u.gutterElement=s.makeFlexGutter(e,l,d)),yield u.gutterElement)}yield g.endDropZone}()),g.cells.length=u-a,p&&(g.element.style[cU[cB[e]]]=`${g.crossSize}px`,cj[e]>0?(yield g.gutterElement,yield g.element):(yield g.element,yield g.gutterElement)),a=u,++l}t.length=l}()}}function cH(e={}){return sV({text:"↗",...e})}function cJ(e){return e.closest(".neuroglancer-selection-details")}class cK extends cW{sidePanelManager;state;manager;selectedLayer;body;constructor(e,t,i,n){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=i,this.selectedLayer=n,this.body=document.createElement("div");let{element:r,body:s}=this;r.classList.add("neuroglancer-selection-details"),this.registerDisposer(new sy(this.element,cA()));let{titleBar:a}=this.addTitleBar({title:"Selection"}),o=sV({svg:sP,title:"Previous selection",onClick:()=>{this.state.goBack()}}),l=sV({svg:sL,title:"Next selection",onClick:()=>{this.state.goForward()}});a.appendChild(o),a.appendChild(l),a.appendChild(this.registerDisposer(new aH(t.pin,{text:"\uD83D\uDCCC︎",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),s.classList.add("neuroglancer-selection-details-body"),this.addBody(s),s.appendChild(this.registerDisposer(new aY(t,(e,i,n)=>{if(!t.location.visible)return;if(o.style.visibility=t.canGoBack()?"visible":"hidden",l.style.visibility=t.canGoForward()?"visible":"hidden",void 0===e)return;let{position:r}=e;if(void 0!==r){let t=document.createElement("div");t.classList.add("neuroglancer-selection-details-position");let n=aK({title:"Copy position",onClick:()=>{aG(a.map(e=>Math.floor(e)).join(", "))}});t.appendChild(n);let{coordinateSpace:{rank:r,names:s},position:a}=e;for(let e=0;e<r;++e){let i=document.createElement("span");i.classList.add("neuroglancer-selection-details-position-dimension");let n=document.createElement("span");n.classList.add("neuroglancer-selection-details-position-dimension-name"),n.textContent=s[e];let r=document.createElement("span");r.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),r.textContent=Math.floor(a[e]).toString(),i.appendChild(n),i.appendChild(r),t.appendChild(i)}let o=cH({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=a}});t.appendChild(o),i.appendChild(t)}for(let t of e.layers){let{layer:e}=t;i.appendChild(n.registerDisposer(new aY({value:void 0,changed:e.managedLayer.layerChanged},(i,n,r)=>{if(e.wasDisposed||!e.isReady)return;let s=document.createElement("div");if(s.classList.add("neuroglancer-selection-details-layer-body"),!e.displaySelectionState(t.state,s,r))return;let a=document.createElement("div");n.appendChild(a),a.classList.add("neuroglancer-selection-details-layer");let o=document.createElement("div");o.classList.add("neuroglancer-selection-details-layer-title"),o.textContent=e.managedLayer.name,o.addEventListener("click",()=>{this.selectedLayer.layer=e.managedLayer,this.selectedLayer.visible=!0}),o.title="Click to show layer side panel",a.appendChild(o),a.appendChild(s)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}i("8468");var cZ=i("8041");function cY(e={}){let t=sV({svg:cZ,...e});return t.classList.add("neuroglancer-eye-icon"),t}var cX=i("194");i("1682");var cQ=i("8086");function c0(e={}){let t=sV({svg:cQ,...e});return t.classList.add("neuroglancer-star-icon"),t}class c1{key;value;label;constructor(e,t,i){this.key=e,this.value=t,this.label=i}toString(){let e;let{key:t,value:i,label:n}=this;return(e=void 0===i?`${t}`:`${t}→${i}`,void 0===n)?e:`${e} ${n}`}}class c2 extends ef.gj{selectedSegment=new eC.E;baseSelectedSegment=new eC.E;hasSelectedSegment=!1;changed=new ez.K_;get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let i;let{selectedSegment:n,baseSelectedSegment:r}=this,s=0,a=0,o=0,l=0;if(null==e)i=!1;else if("number"==typeof e)s=o=e>>>0,a=l=e<0?0xffffffff:0,i=!0;else if(e instanceof c1){let t=e.value||e.key;s=t.low,a=t.high,o=e.key.low,l=e.key.high,i=!0}else e instanceof eC.E?(s=o=e.low,a=l=e.high,i=!0):i=!1;t&&0===s&&0===a&&(i=!1),i?i&&(!this.hasSelectedSegment||n.low!==s||n.high!==a||r.low!==o||r.high!==l)&&(n.low=s,n.high=a,r.low=o,r.high=l,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&eC.E.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let i,n=e.get(t);void 0!==n&&(i=n.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function c3(e){e.useTemporarySegmentEquivalences.value=!1,e.useTemporaryVisibleSegments.value=!1,e.temporaryVisibleSegments.clear(),e.temporarySegmentEquivalences.clear()}function c4(e,t,i=!1){let n,r,s;if(n="number"==typeof t?new eC.E(t>>>0,t<0?0xffffffff:0):"string"==typeof t?eC.E.parseString(t):i?t.clone():t,null==e)return n;let{segmentEquivalences:a,segmentPropertyMap:{value:o}}=e.segmentationGroupState.value;0!==a.size?(r=a.get(n),s=eC.E.equal(r,n)?void 0:r):r=n;let l=o?.getSegmentLabel(r);return void 0===l&&void 0===s?n:new c1(n,s,l)}function c6(e,t){if(t instanceof c1)return t;let i=c4(e,t);return i instanceof eC.E?new c1(i):i}function c5(e,t){let{length:i}=t;e.value<i&&(e.value=i)}function c8(e,t){return(0,Z.Jk)(e=>t.style.setProperty("--neuroglancer-segment-list-width",`${e}ch`),e.segmentationGroupState.value.maxIdLength)}let c7=(()=>{let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry");let t=document.createElement("div");t.classList.add("neuroglancer-segment-list-entry-sticky"),e.appendChild(t);let i=aK({title:"Copy segment ID"});i.classList.add("neuroglancer-segment-list-entry-copy");let n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry-copy-container");let r=n.childElementCount;n.appendChild(i);let s=t.childElementCount;t.appendChild(n);let a=t.childElementCount,o=cY({title:"Toggle segment visibility"});o.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),t.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-segment-list-entry-id-container");let d=t.childElementCount;t.appendChild(l);let u=document.createElement("div");u.classList.add("neuroglancer-segment-list-entry-id");let c=l.childElementCount;l.appendChild(u);let h=c0({title:"Star segment"});h.classList.add("neuroglancer-segment-list-entry-star");let p=t.childElementCount;t.appendChild(h);let g=document.createElement("span");g.classList.add("neuroglancer-segment-list-entry-name");let m=e.childElementCount;e.appendChild(g);let f=function(e={}){return sV({svg:cX,...e})}({title:"Filter by label"});f.classList.add("neuroglancer-segment-list-entry-filter");let v=e.childElementCount;e.appendChild(f);let y=e.childElementCount;return e.appendChild(sD.template()),{template:e,copyContainerIndex:s,copyIndex:r,visibleIndex:a,idContainerIndex:d,idIndex:c,labelIndex:m,filterIndex:v,starIndex:p,colorWidgetIndex:y,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),c9=(()=>{let e=c7.template.cloneNode(!0),t=e.children[0],i=t.children[c7.idContainerIndex],n=i.childElementCount,r=i.children[c7.idIndex].cloneNode(!0);r.classList.add("neuroglancer-segment-list-entry-unmapped-id"),i.appendChild(r);let s=t.children[c7.copyContainerIndex],a=s.childElementCount;return s.appendChild(s.children[c7.copyIndex].cloneNode(!0)),{...c7,template:e,unmappedIdIndex:n,unmappedCopyIndex:a}})(),he=new WeakMap;class ht{displayState;template;registerEventHandlers;constructor(e,t){if(this.displayState=e,this.template=t,void 0!==e){let t=he.get(e);void 0===t&&(t=function(e){let t=t=>{let i=t.currentTarget,n=i.dataset.id;hu.tryParseString(n),e.segmentSelectionState.set(hu),!cJ(i)&&e.selectSegment(hu,!1)},i=t=>{let i=t.currentTarget,n=i.dataset.id;hu.tryParseString(n),e.selectSegment(hu,!cJ(i)||"toggle")},n=()=>{e.segmentSelectionState.set(null)},r=e=>e.currentTarget.closest(".neuroglancer-segment-list-entry"),s=e=>{aG(r(e).dataset.id),e.stopPropagation()},a=e=>{aG(r(e).dataset.unmappedId),e.stopPropagation()},o=t=>{let i=r(t).dataset.id;hu.tryParseString(i);let{selectedSegments:n,visibleSegments:s}=e.segmentationGroupState.value,a=!s.has(hu);a&&n.add(hu),s.set(hu,a),t.stopPropagation(),t.preventDefault()},l=t=>{let i=r(t).dataset.id;hu.tryParseString(i),e.filterBySegmentLabel(hu),t.stopPropagation()},d=t=>{if(2!==t.button||t.ctrlKey||t.altKey||t.metaKey||t.shiftKey)return;let i=t.currentTarget.dataset.id;hu.tryParseString(i),e.moveToSegment(hu)};return(u,c)=>{let{children:h}=u,p=h[0].children;u.addEventListener("mousedown",d);let g=p[c.copyContainerIndex];-1!==c.unmappedCopyIndex&&g.children[c.unmappedCopyIndex].addEventListener("click",a),g.children[c.copyIndex].addEventListener("click",s),u.addEventListener("mouseenter",t),u.addEventListener("mouseleave",n),p[c.visibleIndex].addEventListener("click",o),h[c.filterIndex].addEventListener("click",l),u.addEventListener("action:select-position",i),p[c.starIndex].addEventListener("click",t=>{let i=r(t).dataset.id;hu.tryParseString(i);let{selectedSegments:n}=e.segmentationGroupState.value;n.set(hu,!n.has(hu))});let m=new ed(Q.R3.fromValues(0,0,0));m.changed.add(()=>{let t=new eC.E(en(m.value)),i=u.dataset.id;hu.tryParseString(i),e.segmentStatedColors.value.delete(hu),e.segmentStatedColors.value.set(hu,t)}),new sD(m,void 0,h[c.colorWidgetIndex],()=>{let t=u.dataset.id;hu.tryParseString(t),e.segmentStatedColors.value.delete(hu)},!1)}}(e),he.set(e,t)),this.registerEventHandlers=t}}static make(e,t){return new ht(e,t?c9:c7)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(c6(t,e))}getWithNormalizedId(e){let{displayState:t}=this,{template:i}=this,n=i.template.cloneNode(!0),r=e.key,s=e.value??r,a=s.toString();n.dataset.id=a;let{children:o}=n,l=o[0].children,d=l[i.idContainerIndex];d.children[i.idIndex].textContent=a;let{unmappedIdIndex:u}=i;if(void 0!==t?this.registerEventHandlers(n,i):l[i.visibleIndex].style.display="none",-1!==u){let e=d.children[u];if(eC.E.equal(r,s))e.style.display="none",l[i.copyContainerIndex].children[i.unmappedCopyIndex].style.display="none";else{let i=r.toString();n.dataset.unmappedId=i,e.textContent=i,void 0!==t&&c5(t.segmentationGroupState.value.maxIdLength,i)}}return o[i.labelIndex].textContent=e.label??"",void 0!==t&&(this.updateWithId(n,s),c5(t.segmentationGroupState.value.maxIdLength,a)),n}update(e){let t=e.dataset.id;void 0!==t&&(hu.parseString(t),this.updateWithId(e,hu))}updateWithId(e,t){let{children:i}=e,n=i[0].children,{template:r}=this,{displayState:s}=this,{segmentSelectionState:a}=s,{visibleSegments:o}=s.segmentationGroupState.value;n[r.visibleIndex].classList.toggle("neuroglancer-visible",o.has(t)),e.dataset.selected=(a.hasSelectedSegment&&eC.E.equal(a.selectedSegment,t)).toString();let{selectedSegments:l}=s.segmentationGroupState.value;n[r.starIndex].classList.toggle("neuroglancer-starred",l.has(t));let d=n[r.idContainerIndex],u=hh(this.displayState,t);hi(d.children[r.idIndex],u);let c=!!this.displayState?.segmentStatedColors.value.has(t);hn(i[r.colorWidgetIndex],u,c);let{unmappedIdIndex:h}=r;if(-1!==h){let n;s.baseSegmentColoring.value&&void 0!==(n=e.dataset.unmappedId)?(hu.parseString(n),u=hh(this.displayState,hu)):u=Q.rn,hi(d.children[h],u);let a=!!this.displayState?.segmentStatedColors.value.has(t);hn(i[r.colorWidgetIndex],u,a)}}}function hi(e,t){e.style.backgroundColor=cL(t),e.style.color=el(t)?"white":"black"}function hn(e,t,i){e.value=ea(t.subarray(0,3)),e.classList.toggle("overridden",i)}class hr extends ht{segmentPropertyMap;numericalProperties;numericalPropertyWidths;parentElement;constructor(e,t,i){let n=e.segmentationGroupState.value.segmentPropertyMap.value,r=(n?.numericalProperties??[]).filter(i);super(e,function(e){let t=c7.template.cloneNode(!0),i=[];for(let n=0;n<e;++n){i.push(t.childElementCount);let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-extra-property"),e.style.width=`max(var(--neuroglancer-column-${n}-width), var(--neuroglancer-column-${n}-label-width))`,t.appendChild(e)}return{...c7,template:t,numericalPropertyIndices:i}}(r.length)),this.parentElement=t,this.segmentPropertyMap=n,this.numericalProperties=r,(this.numericalPropertyWidths=Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){let t=super.getWithNormalizedId(e),{numericalProperties:i}=this,{numericalPropertyIndices:n}=this.template;if(n.length>0){let r=this.segmentPropertyMap?.getSegmentInlineIndex(e.value??e.key)??-1;if(-1!==r){let{numericalPropertyWidths:e}=this;for(let s=0,a=n.length;s<a;++s){let a=i[s].values[r];if(!Number.isNaN(a)){let i=a.toString(),r=i.length;r>e[s]&&(e[s]=r,this.parentElement.style.setProperty(`--neuroglancer-column-${s}-width`,`${r}ch`)),t.children[n[s]].textContent=i}}}}return t}makeHeaderLabel(e,t,i){let n=document.createElement("span");n.textContent=e,n.classList.add("neuroglancer-segment-list-header-label"),n.classList.add("neuroglancer-segment-list-header-label"),"label"===e&&(i.style.textAlign="left");let r=document.createElement("span");r.classList.add("neuroglancer-segment-list-header-label-sort"),n.appendChild(r),r.textContent="▲";let s=function(e){let t=e.cloneNode(!0);return t.style.position="absolute",document.body.appendChild(t),t.getBoundingClientRect()}(n).width;return this.parentElement.style.setProperty(t,`${s}px`),i.appendChild(n),{id:e,label:n,sortIcon:r}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:i}=t,n=i[0].children;n[e.copyContainerIndex].style.visibility="hidden",n[e.visibleIndex].style.visibility="hidden",i[e.filterIndex].style.visibility="hidden";let r=n[e.idContainerIndex],s=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",r.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",i[e.labelIndex])],{numericalProperties:a}=this,{numericalPropertyIndices:o}=this.template;for(let e=0,i=o.length;e<i;++e){let i=a[e],n=this.makeHeaderLabel(i.id,`--neuroglancer-column-${e}-label-width`,t.children[o[e]]),{description:r}=i;r&&(n.label.title=r),s.push(n)}return{container:t,propertyLabels:s}}}function hs(e,t){return ht.make(e??void 0,!0).getWithNormalizedId(t)}function ha(e,t,i){t.registerDisposer((0,Z.w)((e,t)=>{var n,r,s;n=e,r=t,s=i,n.registerDisposer(r.visibleSegments.changed.add(s)),n.registerDisposer(r.segmentEquivalences.changed.add(s))},e.segmentationGroupState)),t.registerDisposer((0,Z.w)((e,t)=>{e.registerDisposer(t.segmentColorHash.changed.add(i)),e.registerDisposer(t.segmentDefaultColor.changed.add(i))},e.segmentationColorGroupState)),t.registerDisposer(e.saturation.changed.add(i)),t.registerDisposer(e.segmentSelectionState.changed.add(i)),t.registerDisposer(e.baseSegmentColoring.changed.add(i)),t.registerDisposer(e.hoverHighlight.changed.add(i)),t.registerDisposer(e.segmentStatedColors.changed.add(i))}function ho(e,t){let i=t.redrawNeeded.dispatch;ha(e,t,i),t.registerDisposer((0,Z.w)((e,t)=>{var n,r,s;n=e,r=t,s=i,n.registerDisposer(r.temporaryVisibleSegments.changed.add(s)),n.registerDisposer(r.temporarySegmentEquivalences.changed.add(s)),n.registerDisposer(r.useTemporaryVisibleSegments.changed.add(s)),n.registerDisposer(r.useTemporarySegmentEquivalences.changed.add(s))},e.segmentationGroupState))}function hl(e,t){var i,n;ho(i=e,n=t),n.registerDisposer(i.objectAlpha.changed.add(n.redrawNeeded.dispatch)),t.registerDisposer(e.transform.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.renderScaleTarget.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.transparentPickEnabled.changed.add(t.redrawNeeded.dispatch))}let hd=Q.vh.create(),hu=new eC.E,hc=new eC.E;function hh(e,t,i=hd){if(null==e)return i.fill(1),i;let n=e.segmentationColorGroupState.value,{segmentStatedColors:r}=n;if(0!==r.size&&n.segmentStatedColors.get(t,hc))return i[0]=(255&hc.low)/255,i[1]=((65280&hc.low)>>>8)/255,i[2]=((0xff0000&hc.low)>>>16)/255,i;let s=n.segmentDefaultColor.value;return void 0!==s?(i[0]=s[0],i[1]=s[1],i[2]=s[2],i):(n.segmentColorHash.compute(i,t),i)}function hp(e,t={}){for(let i of lw)t[i]=e[i].rpcId;return t}let hg=i5(lb);class hm extends hg{chunkManager;displayState;constructor(e,t,i){super(i),this.chunkManager=e,this.displayState=t;let n=t.segmentationGroupState.value;for(let e of lw)this.registerDisposer(n[e].addRef())}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,hp(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(i3.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(i3.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function hf(e,t,i,n,r){let s=Math.min(1,e.objectAlpha.value),a=e.baseSegmentColoring.value;lE(e.segmentationGroupState.value,(o,l)=>{let d=n?.registerUint64(t,o),u=i?function(e,t,i=1){hd[3]=i,hh(e,t,hd);let n=e.saturation.value;e.hoverHighlight.value&&e.segmentSelectionState.isSelected(t)&&(n>.5?n=n-=.5:n+=.5);for(let e=0;e<3;++e)hd[e]=hd[e]*n+(1-n);return hd[0]*=i,hd[1]*=i,hd[2]*=i,hd}(e,a?o:l,s):void 0;r(o,u,d,l)})}function hv(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}let hy=Q._E.create(),hb=Q.wO.create();function hS(e,t){t.vertexBuffer=nE.fromData(e,t.meshData.vertexPositions,e.ARRAY_BUFFER,e.STATIC_DRAW),t.indexBuffer=nE.fromData(e,t.meshData.indices,e.ELEMENT_ARRAY_BUFFER,e.STATIC_DRAW),t.normalBuffer=nE.fromData(e,t.meshData.vertexNormals,e.ARRAY_BUFFER,e.STATIC_DRAW)}function hw(e){e.vertexBuffer.dispose(),e.indexBuffer.dispose(),e.normalBuffer.dispose()}let hC=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function hx(e){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(t,i,n){n.vertexBuffer.bindToVertexAttrib(i.attribute("aVertexPosition"),3,e,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}let hE={[uQ.k_.float32]:hx(WebGL2RenderingContext.FLOAT),[uQ.k_.uint16]:hx(WebGL2RenderingContext.UNSIGNED_SHORT),[uQ.k_.uint10]:{defineShader:e=>{e.addAttribute("highp uint","aVertexPosition"),e.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(e,t,i){i.vertexBuffer.bindToVertexAttribI(t.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}};class hT{fragmentRelativeVertices;vertexPositionFormat;tempLightVec;vertexPositionHandler;constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=hE[t]}beginLayer(e,t,i,n){let{lightDirection:r,ambientLighting:s,directionalLighting:a}=i,o=this.tempLightVec;Q.R3.scale(o,r,a),o[3]=s,e.uniform4fv(t.uniform("uLightDirection"),o);let l=n.silhouetteRendering.value;l>0&&e.uniform1f(t.uniform("uSilhouettePower"),l)}setColor(e,t,i){e.uniform4fv(t.uniform("uColor"),i)}setPickID(e,t,i){e.uniform1ui(t.uniform("uPickID"),i)}beginModel(e,t,i,n){let{projectionParameters:r}=i;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,Q._E.multiply(hy,r.viewProjectionMat,n)),(0,Q.bZ)(hb,n),(0,Q.Jc)(hb,hb,r.displayDimensionRenderInfo.canonicalVoxelFactors),Q.wO.invert(hb,hb),Q.wO.transpose(hb,hb),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,hb)}drawFragmentHelper(e,t,i,n,r){this.vertexPositionHandler.bind(e,t,i);let{meshData:s}=i;i.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),i.indexBuffer.bind();let{indices:a}=s;e.drawElements(s.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,r-n,2===a.BYTES_PER_ELEMENT?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,n*a.BYTES_PER_ELEMENT)}drawFragment(e,t,i){let{meshData:n}=i,{indices:r}=n;this.drawFragmentHelper(e,t,i,0,r.length)}drawMultiscaleFragment(e,t,i,n,r){let s=i.meshData.subChunkOffsets[n],a=i.meshData.subChunkOffsets[r];this.drawFragmentHelper(e,t,i,s,a)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer((0,Z.mo)(e=>e>0,[e.displayState.silhouetteRendering]));return nC(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(e,t)=>{this.vertexPositionHandler.defineShader(e),e.addAttribute("highp vec2","aVertexNormal"),e.addVarying("highp vec4","vColor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat3","uNormalMatrix"),e.addUniform("highp mat4","uModelViewProjection"),e.addUniform("highp uint","uPickID"),t&&e.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(e.addUniform("highp vec3","uFragmentOrigin"),e.addUniform("highp vec3","uFragmentShape")),e.addVertexCode(hC);let i="";this.fragmentRelativeVertices?i+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:i+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,i+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,t&&(i+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),e.setVertexMain(i),e.setFragmentMain("emit(vColor, uPickID);")}})}}class hk extends u2{chunkManager;source;displayState;meshShaderManager;getShader;backend;constructor(e,t,i){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.meshShaderManager=new hT(!1,uQ.k_.float32),this.getShader=this.meshShaderManager.makeGetter(this),hl(i,this),this.registerDisposer(i.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let n=this.backend=this.registerDisposer(new hm(e,i,this.layerChunkProgressInfo));n.RPC_TYPE_ID=uQ.ve,n.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),n.visibility.add(this.visibility),this.registerDisposer(i.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:i,displayState:n,meshShaderManager:r}=this;if(n.objectAlpha.value<=0)return;let s=ne(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===s)return;let{shader:a}=this.getShader(e.emitter);if(null===a)return;a.bind(),r.beginLayer(i,a,e,this.displayState),r.beginModel(i,a,e,s);let o=this.source.chunks,l=0,d=0,{renderScaleHistogram:u}=this.displayState,c=this.source.fragmentSource.chunks;hf(n,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(t,n,s)=>{let u=lC(t),h=o.get(u);if(++l,void 0!==h)for(let t of(++d,e.emitColor&&r.setColor(i,a,n),e.emitPickID&&r.setPickID(i,a,s),l+=h.fragmentIds.length,h.fragmentIds)){let{key:e}=this.source.getFragmentKey(u,t),n=c.get(e);void 0!==n&&n.state===ih.GPU_MEMORY&&(r.drawFragment(i,a,n),++d)}}),e.emitColor&&(u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),u.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,d,l-d)),r.endLayer(i,a)}isReady(){let{displayState:e,source:t}=this,i=!0,n=t.fragmentSource.chunks;return lE(e.segmentationGroupState.value,e=>{let r=lC(e),s=t.chunks.get(r);if(void 0===s){i=!1;return}for(let e of s.fragmentIds){let{key:t}=this.source.getFragmentKey(r,e),s=n.get(t);if(void 0===s||s.state!==ih.GPU_MEMORY){i=!1;return}}}),i}getObjectPosition(e,t){let i=this.displayState.transform.value;if(void 0!==i.error)return;let n=lC(e),r=this.source.chunks.get(n);if(void 0===r)return;let{rank:s}=i,a=new Float32Array(i.modelToRenderLayerTransform.length);to.SO(a,s+1,i.modelToRenderLayerTransform,s+1,s+1);let o=new Float32Array(s);to.DC(o,a,s+1,t,s);let{fragmentIds:l}=r,d=0,u=[];for(let e of l){let{key:t}=this.source.getFragmentKey(n,e),i=this.source.fragmentSource.chunks.get(t);if(void 0===i)continue;let{state:r,meshData:a}=i;if(r===ih.SYSTEM_MEMORY||r===ih.GPU_MEMORY)d+=a.vertexPositions.length/s,u.push(i)}let c=Math.max(1,Math.floor(1/(1e5/d))),h=new Float32Array(s),p=Number.POSITIVE_INFINITY;for(let e of u){let{meshData:t}=e,{vertexPositions:i}=t;if(!(i.length<s))for(let e=0;e<i.length;e+=s*c){let t=0;for(let n=0;n<s;n++)t+=(i[e+n]-o[n])**2;if(t<p){p=t;for(let t=0;t<s;t++)h[t]=i[e+t]}}}if(p===Number.POSITIVE_INFINITY)return;let g=new Float32Array(s);return to.DC(g,i.modelToRenderLayerTransform,s+1,h,s),g}}class hD extends lc{fragmentIds;constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class hP extends lc{vertexBuffer;indexBuffer;normalBuffer;meshData;constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),hS(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),hw(this)}}class hL extends lv{fragmentSource=this.registerDisposer(new hI(this.chunkManager,this));initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new hD(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}class hI extends lv{meshSource;get key(){return this.meshSource.key}constructor(e,t){super(e),this.meshSource=t}getChunk(e){return new hP(this,e)}}function hR(e,t,i,n){let r=e.get(u1(t,i,n));return void 0!==r&&r.state===ih.GPU_MEMORY}hI=hv([i0(uQ.q7)],hI);class hA extends u2{chunkManager;source;displayState;meshShaderManager;getShader;backend;constructor(e,t,i){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.meshShaderManager=new hT(t.format.fragmentRelativeVertices,t.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),hl(i,this),this.registerDisposer(i.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let n=this.backend=this.registerDisposer(new hm(e,i,this.layerChunkProgressInfo));n.RPC_TYPE_ID=uQ.nL,n.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),n.visibility.add(this.visibility),this.registerDisposer(i.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:i,displayState:n,meshShaderManager:r}=this;if(n.objectAlpha.value<=0)return;let s=ne(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===s)return;let{shader:a}=this.getShader(e.emitter);if(null===a)return;a.bind(),r.beginLayer(i,a,e,this.displayState);let{renderScaleHistogram:o}=this.displayState;e.emitColor&&o.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),(0,Q.bZ)(hb,s),(0,Q.Jc)(hb,hb,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let l=Math.abs(Q.wO.determinant(hb))**(1/3),{chunks:d}=this.source,u=this.source.fragmentSource.chunks,{projectionParameters:c}=e,h=Q._E.multiply(Q._E.create(),c.viewProjectionMat,s),p=(0,Q.th)(new Float32Array(24),h),g=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:m}=this.source.format;r.beginModel(i,a,e,s);let f=0,v=0;hf(n,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(t,n,s)=>{var y;let b=lC(t),S=d.get(b);if(++f,void 0===S)return;++v;let{manifest:w}=S,{octree:C,chunkShape:x,chunkGridSpatialOrigin:E,vertexOffsets:T}=w;e.emitColor&&r.setColor(i,a,n),e.emitPickID&&r.setPickID(i,a,s),u0(w,h,p,g,c.width,c.height,(t,i,n)=>{let r=hR(u,b,t,i);return e.emitColor&&o.add(w.lodScales[t]*l,n,r?1:0,r?0:1),r},(e,t,n,s)=>{let o=u1(b,e,t),l=u.get(o),d=C[5*t],c=C[5*t+1],h=C[5*t+2],p=1<<e;m&&(i.uniform3f(a.uniform("uFragmentOrigin"),E[0]+d*x[0]*p+T[3*e+0],E[1]+c*x[1]*p+T[3*e+1],E[2]+h*x[2]*p+T[3*e+2]),i.uniform3f(a.uniform("uFragmentShape"),x[0]*p,x[1]*p,x[2]*p));r.drawMultiscaleFragment(i,a,l,n,s)})}),o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,v,f-v),r.endLayer(i,a)}isReady(e,t){let{displayState:i}=this;if(i.objectAlpha.value<=0)return!0;let n=ne(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===n)return!1;let{chunks:r}=this.source,s=this.source.fragmentSource.chunks,{projectionParameters:a}=e,o=Q._E.multiply(Q._E.create(),a.viewProjectionMat,n),l=(0,Q.th)(new Float32Array(24),o),d=this.displayState.renderScaleTarget.value,u=!0;return lE(i.segmentationGroupState.value,e=>{if(!u)return;let t=lC(e),i=r.get(t);if(void 0===i){u=!1;return}let{manifest:n}=i;u0(n,o,l,d,a.width,a.height,(e,i)=>u=u&&hR(s,t,e,i),()=>{})}),u}getObjectPosition(e){let t=this.displayState.transform.value;if(void 0!==t.error)return;let i=this.source.chunks.get(lC(e));if(void 0===i)return;let{manifest:n}=i,{clipLowerBound:r,clipUpperBound:s}=n,{rank:a}=t,o=new Float32Array(a);for(let e=0;e<3;++e)o[e]=(r[e]+s[e])/2;let l=new Float32Array(a);return to.DC(l,t.modelToRenderLayerTransform,a+1,o,a),l}}class hM extends lc{manifest;constructor(e,t){super(e),this.manifest=t.manifest}}class hN extends lc{meshData;vertexBuffer;indexBuffer;normalBuffer;constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),hS(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),hw(this)}}class hV extends lv{fragmentSource=this.registerDisposer(new hO(this.chunkManager,this));format;constructor(e,t){super(e,t),this.format=t.format}static encodeOptions(e){return{format:e.format,...lv.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new hM(this,e)}}class hO extends lv{meshSource;get key(){return this.meshSource.key}constructor(e,t){super(e),this.meshSource=t}getChunk(e){return new hN(this,e)}}function h_(e,t){return e^=t=Math.imul(t=((t=Math.imul(t,0xcc9e2d51)>>>0)<<15|t>>>17)>>>0,0x1b873593)>>>0,e=Math.imul(e=(e<<13|e>>>19)>>>0,5)+0xe6546b64>>>0}hO=hv([i0(uQ.Ff)],hO);function hF(e,t,i){var n;let r=e;return r=h_(r,t),n=8^(r=h_(r,i)),n^=n>>>16,n=Math.imul(n,0x85ebca6b)>>>0,n^=n>>>13,n*=0xc2b2ae35,(n^=n>>>16)>>>0}function hB(e,t){return t<=255?new Uint8Array(e):t<=65535?new Uint16Array(e):new Uint32Array(e)}class hU{inlineProperties;constructor(e){this.inlineProperties=e.inlineProperties}}class h${segmentPropertyMap;inlineIdToIndex;tags;labels;numericalProperties;getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return void 0===t?-1:function(e,t,i,n){let r=hF(0,i,n),s=e.length-1;for(;;){let a=e[r&=s];if(0===a)return -1;if(t[2*--a]===i&&t[2*a+1]===n)return a;++r}}(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}constructor(e){this.segmentPropertyMap=e;let{inlineProperties:t}=e;void 0!==t&&(this.inlineIdToIndex=function(e){let t=e.length/2,i=Math.ceil(Math.log2(t))+1,n=hB(2**i,t+1);for(let i=0;i<t;++i){let t=e[2*i];!function(e,t,i){let n=e.length-1;for(;;){if(0===e[t&=n]){e[t]=i;return}++t}}(n,hF(0,t,e[2*i+1]),i+1)}return n}(t.ids)),this.tags=t?.properties.find(e=>"tags"===e.type),this.labels=t?.properties.find(e=>"label"===e.type),this.numericalProperties=t?.properties.filter(e=>"number"===e.type)??[]}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(-1===t)return;let{labels:i,tags:n}=this,r="";if(void 0!==i&&(r=i.values[t]),void 0!==n){let{tags:e,values:i}=n,s=i[t];for(let t=0,i=s.length;t<i;++t){let i=e[s.charCodeAt(t)];r.length>0&&(r+=" "),r+="#",r+=i}}if(0!==r.length)return r}}function hG(e,t,i){for(let n=0,r=i.length;n<r;++n)t[i[n]]=e[n]}function hz(e,t,i){let{type:n}=e;return"label"===n||"description"===n||"string"===n||"tags"===n?function(e,t,i){let n=Array(t);return n.fill(""),hG(e.values,n,i),{...e,values:n}}(e,t,i):function(e,t,i){let n=new Float32Array(t);return n.fill(Number.NaN),hG(e.values,n,i),{...e,values:n}}(e,t,i)}let hj=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function hW(e){return"\\u"+e.toString(16).padStart(4,"0")}function hq(e){return e?.tags||e?.labels?"label":"id"}let hH=new eC.E;function hJ(e,t,i){if(0===i.size)return 0;let n=0;return!function(e,t,i){if(void 0===t)return;let{explicitIds:n}=t;if(void 0!==n){n.forEach(i);return}let{indices:r}=t;if(void 0!==r){let{ids:t}=e.segmentPropertyMap.inlineProperties;for(let e=0,n=r.length;e<n;++e){let n=r[e];hH.low=t[2*n],hH.high=t[2*n+1],i(hH,e)}}}(e,t,e=>{i.has(e)&&++n}),n}function hK(e,t,i,n){let r=e.includeTags.filter(e=>e!==t),s=e.excludeTags.filter(e=>e!==t);return!0===n&&(i?r:s).push(t),{...e,includeTags:r,excludeTags:s}}function hZ(e,t){if(void 0===e||void 0!==e.ids||void 0!==e.errors)return!1;let{sortBy:i,includeColumns:n}=e;return void 0!==i.find(e=>e.fieldId===t)||n.includes(t)}class hY extends s_{layer;constructor(e){super(),this.layer=e;let{element:t}=this;t.appendChild(this.registerDisposer(new aY(e.displayState.segmentationGroupState.value.graph,(t,i,n)=>{t?.tabContents&&i.appendChild(t.tabContents(e,n,this))})).element)}}class hX{}class hQ extends ef.gj{graph;segmentsState;constructor(e,t){super(),this.graph=e,this.segmentsState=t}createRenderLayers(e,t,i){return[]}}var h0=i("658");let h1="DisjointUint64Sets.add",h2="DisjointUint64Sets.clear",h3="DisjointUint64Sets.highBitRepresentativeChanged",h4="DisjointUint64Sets.deleteSet";class h6 extends iX{disjointSets=new h0.D;changed=new ez.K_;get value(){return this}static makeWithCounterpart(e,t){let i=new h6;return i.disjointSets.visibleSegmentEquivalencePolicy=t,i.registerDisposer(t.changed.add(()=>{h7(i)})),i.initializeCounterpart(e),t.value&&h7(i),i}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:i}=this;return i&&i.invoke(h1,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,i=e.length;t<i;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(h2,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(h4,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(void 0!==e){let t=[new eC.E,new eC.E];(0,eb.m7)(e,e=>{(0,eb.m7)(e,(e,i)=>{t[i%2].parseString(String(e),10),0!==i&&this.link(t[0],t[1])})})}}assignFrom(e){for(let[t,i]of(this.clear(),e instanceof h6&&(e=e.disjointSets),e))this.link(t,i)}}h6=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i1("DisjointUint64Sets")],h6);let h5=new eC.E,h8=new eC.E;function h7(e){e.rpc.invoke(h3,{id:e.rpcId,value:e.disjointSets.visibleSegmentEquivalencePolicy.value})}iq(h1,function(e){let t=this.get(e.id);h5.low=e.al,h5.high=e.ah,h8.low=e.bl,h8.high=e.bh,t.disjointSets.link(h5,h8)&&t.changed.dispatch()}),iq(h2,function(e){let t=this.get(e.id);t.disjointSets.clear()&&t.changed.dispatch()}),iq(h3,function(e){this.get(e.id).disjointSets.visibleSegmentEquivalencePolicy.value=e.value}),iq(h4,function(e){let t=this.get(e.id);h5.low=e.l,h5.high=e.h,t.disjointSets.deleteSet(h5)&&t.changed.dispatch()});class h9 extends hX{spanningTreeEdges=new Map;equivalences=new h6;connections=new Set;changed=new ez.MZ;link(e,t){for(let i of(this.equivalences.link(e,t),this.connections))i.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){for(let t of(this.equivalences.linkAll(e),this.connections))t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){for(let t of(this.equivalences.deleteSet(e),this.connections))t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)pe(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let i=e.toString(),n=t.toString(),{spanningTreeEdges:r}=this,s=r.get(i);void 0===s&&(s=new Set,r.set(i,s));let a=r.get(n);void 0===a&&(a=new Set,r.set(n,a)),s.add(n),a.add(i)}removeSpanningTreeEdge(e,t){let i=e.toString(),n=t.toString(),{spanningTreeEdges:r}=this,s=r.get(i),a=r.get(n);s.delete(n),0===s.size&&r.delete(i),a.delete(i),0===a.size&&r.delete(n)}*getSpanningTreeNeighbors(e){let t=new eC.E,i=this.spanningTreeEdges.get(e.toString());if(void 0!==i)for(let e of i)t.parseString(e),yield t}restoreState(e){let{equivalences:t,spanningTreeEdges:i}=this;if(t.clear(),i.clear(),void 0===e)return;let n=[new eC.E,new eC.E];(0,eb.m7)(e,e=>{(0,eb.m7)(e,(e,i)=>{n[i%2].parseString(String(e),10),0!==i&&t.link(n[0],n[1])&&this.addSpanningTreeEdge(n[0],n[1])})})}toJSON(){let{spanningTreeEdges:e}=this;if(0===e.size)return;let t=[];for(let[i,n]of e){let e=eC.E.parseString(i);for(let i of n){let n=eC.E.parseString(i);!(eC.E.compare(e,n)>0)&&t.push([e,n])}}return t.sort((e,t)=>eC.E.compare(e[0],t[0])||eC.E.compare(e[1],t[1])),t.map(e=>e.map(e=>e.toString()))}get visibleSegmentEquivalencePolicy(){return lS.BA.MIN_REPRESENTATIVE}async merge(e,t){let{equivalences:i}=this;return eC.E.equal(i.get(e),i.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),i.get(e))}async split(e,t){let i=this.computeSplit(e,t);if(void 0===i)throw Error("Segments are already split");let{includeBaseSegments:n,includeRepresentative:r,excludeBaseSegments:s,excludeRepresentative:a}=i,{equivalences:o}=this;this.deleteSet(e),this.linkAll(n),this.linkAll(s);let l=(e,t)=>{for(let i of e)for(let e of this.getSpanningTreeNeighbors(i))!eC.E.equal(o.get(e),t)&&this.removeSpanningTreeEdge(i,e)},d=o.get(e),u=o.get(t);for(let e of(l(n,d),l(s,u),this.connections)){let{selectedSegments:t,visibleSegments:i}=e.segmentsState;t.has(a)&&(t.delete(a),t.add(r),i.add(r))}return this.normalizeAll(),this.changed.dispatch(),{include:d,exclude:u}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:i}=this,n=i.get(e);if(!eC.E.equal(n,i.get(t)))return;let r=new h0.D;for(let e of i.setElements(n))if(!eC.E.equal(e,t))for(let i of this.getSpanningTreeNeighbors(e))!eC.E.equal(i,t)&&r.link(e,i);let s=[],a=[],o=r.get(e),l=e,d=t;for(let e of i.setElements(n))eC.E.equal(r.get(e),o)?(s.push(e),0>eC.E.compare(e,l)&&(l=e)):(a.push(e),0>eC.E.compare(e,d)&&(d=e));return s.sort(eC.E.compare),a.sort(eC.E.compare),{includeBaseSegments:s,includeRepresentative:l,excludeBaseSegments:a,excludeRepresentative:d}}connect(e){let t=e.displayState.segmentationGroupState.value,i=new pt(this,t);return t.segmentEquivalences.assignFrom(this.equivalences),pe(t.visibleSegments,t.segmentEquivalences.disjointSets),i.registerDisposer(t.visibleSegments.changed.add(i.registerCancellable((0,ic.Z)(()=>pe(t.visibleSegments,t.segmentEquivalences.disjointSets),0)))),this.connections.add(i),i.registerDisposer(()=>{this.connections.delete(i)}),i}}function pe(e,t){let i=[];for(let n of e.unsafeKeys()){let r=t.get(n);!eC.E.equal(n,r)&&(i.push(r),e.delete(n))}for(let t of i)e.add(t)}class pt extends hQ{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var pi=i("5105");function pn(e,t){e.addVertexCode(sw),e.addUniform("highp vec3","uCircleParams"),e.addVarying("highp vec4","vCircleCoord"),e.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),t?e.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):e.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),e.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function pr(e,t,i){let{gl:n}=e;n.uniform3f(e.uniform("uCircleParams"),1/t.width,1/t.height,Math.max(1e-6,i.featherWidthInPixels))}function ps(e,t,i){sC(e,t,i)}function pa(e){e.addAttribute("int","aDummyVertexId",0),e.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class po extends ef.gj{size;buffer;constructor(e){super(),this.buffer=new nE(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:i}=t;t.bind(),e>this.size&&(this.size=e,i.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),i.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),i.vertexAttribDivisor(0,0),i.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new po(e))}}let pl=Q._E.create(),pd=`void main() {
  emitDefault();
}
`,pu=[],pc=cv(new cs,ec.FLOAT32,3);class ph extends ef.gj{base;targetIsSliceView;textureAccessHelper;vertexIdHelper;get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){pa(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}edgeShaderGetter;nodeShaderGetter;get gl(){return this.base.gl}constructor(e,t){super(),this.base=e,this.targetIsSliceView=t,this.textureAccessHelper=new cS("vertexData"),this.vertexIdHelper=this.registerDisposer(po.get(this.gl)),this.edgeShaderGetter=nC(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),sx(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let i=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(o9);let{vertexAttributes:n}=this,r=n.length;for(let t=1;t<r;++t){let r=n[t];e.addVarying(`highp ${r.glslDataType}`,`vCustom${t}`),i+=`vCustom${t} = readAttribute${t}(vertexIndex);
`,e.addFragmentCode(`#define ${r.name} vCustom${t}
`)}e.setVertexMain(i),ok(t,e),e.setFragmentMainFunction(nx(t.parseResult.code))}}),this.nodeShaderGetter=nC(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),pn(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let i=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(o9);let{vertexAttributes:n}=this,r=n.length;for(let t=1;t<r;++t){let r=n[t];e.addVarying(`highp ${r.glslDataType}`,`vCustom${t}`),i+=`vCustom${t} = readAttribute${t}(vertexIndex);
`,e.addFragmentCode(`#define ${r.name} vCustom${t}
`)}e.setVertexMain(i),ok(t,e),e.setFragmentMainFunction(nx(t.parseResult.code))}})}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let i=this.vertexAttributes.length;for(let e=pu.length;e<i;++e)pu[e]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${e}`);this.vertexAttributes.forEach((i,n)=>{e.addTextureSampler(`${cf(i.dataType)}sampler2D`,`uVertexAttributeSampler${n}`,pu[n]),e.addVertexCode(t.getAccessor(`readAttribute${n}`,`uVertexAttributeSampler${n}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,i,n){let{viewProjectionMat:r}=i.projectionParameters,s=Q._E.multiply(pl,r,n);e.uniformMatrix4fv(t.uniform("uProjection"),!1,s),this.vertexIdHelper.enable()}setColor(e,t,i){e.uniform4fv(t.uniform("uColor"),i)}setPickID(e,t,i){e.uniform1ui(t.uniform("uPickID"),i)}drawSkeleton(e,t,i,n,r){var s,a,o;let{vertexAttributes:l}=this,d=l.length,{vertexAttributeTextures:u}=n;for(let i=0;i<d;++i){let n=WebGL2RenderingContext.TEXTURE0+t.textureUnit(pu[i]);e.activeTexture(n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,u[i])}{;t.bind();let i=t.attribute("aVertexIndex");n.indexBuffer.bindToVertexAttribI(i,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(i,1),sT(t,r,this.targetIsSliceView?1:0),s=1,sC(e,1,n.numIndices/2),e.vertexAttribDivisor(i,0),e.disableVertexAttribArray(i)}if(null!==i){;i.bind(),pr(i,r,{featherWidthInPixels:this.targetIsSliceView?1:0}),a=i.gl,o=2,sC(a,2,n.numVertices)}}endLayer(e,t){let{vertexAttributes:i}=this,n=i.length;for(let i=0;i<n;++i){let n=t.textureUnit(pu[i])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}}var pp=((O={})[O.LINES=0]="LINES",O[O.LINES_AND_POINTS=1]="LINES_AND_POINTS",O);class pg extends rL.B{constructor(e,t=e){super(pp,e,t)}}class pm extends Z.TU{constructor(e,t=e){super(e,eb.o7,t)}}class pf{compound=new rk;get changed(){return this.compound.changed}shader=nS(pd);shaderControlState=new o_(this.shader);params2d={mode:new pg(1),lineWidth:new pm(2)};params3d={mode:new pg(0),lineWidth:new pm(1)};constructor(){let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}reset(){this.compound.reset()}restoreState(e){void 0!==e&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(void 0!==t)return e}}class pv extends ef.gj{chunkManager;source;displayState;layerChunkProgressInfo;redrawNeeded;sharedObject;vertexAttributes;fallbackShaderParameters;get visibility(){return this.sharedObject.visibility}constructor(e,t,i){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.layerChunkProgressInfo=new ib,this.redrawNeeded=new ez.K_,this.fallbackShaderParameters=new Z.SN(oO(oE(pd))),hl(i,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:n}=i;this.registerDisposer(n.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let r=this.sharedObject=this.registerDisposer(new hm(e,i,this.layerChunkProgressInfo));r.RPC_TYPE_ID=pi.f,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let s=this.vertexAttributes=[pS];for(let[e,i]of t.vertexAttributes)s.push({name:e,dataType:i.dataType,numComponents:i.numComponents,webglDataType:function(e){if(e===ec.FLOAT32)return WebGL2RenderingContext.FLOAT;throw Error(`Data type not supported by WebGL: ${ec[e]}`)}(i.dataType),glslDataType:i.numComponents>1?`vec${i.numComponents}`:"float"})}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,i,n,r){let s;let a=n.lineWidth.value,{gl:o,source:l,displayState:d}=this;if(d.objectAlpha.value<=0)return;let u=ne(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,r);if(void 0===u)return;s=1===n.mode.value?Math.max(5,2*a):a;let c=i.edgeShaderGetter(e.emitter),h=i.nodeShaderGetter(e.emitter),{shader:p,parameters:g}=c,{shader:m,parameters:f}=h;if(null===p||null===m)return;let{shaderControlState:v}=this.displayState.skeletonRenderingOptions;p.bind(),i.beginLayer(o,p,e,u),oB(o,p,v,g.parseResult.controls),o.uniform1f(p.uniform("uLineWidth"),a),m.bind(),i.beginLayer(o,m,e,u),o.uniform1f(m.uniform("uNodeDiameter"),s),oB(o,m,v,f.parseResult.controls);let y=l.chunks;hf(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(t,n,r)=>{let s=lC(t),a=y.get(s);if(void 0!==a&&a.state===ih.GPU_MEMORY)void 0!==n&&(p.bind(),i.setColor(o,p,n),m.bind(),i.setColor(o,m,n)),void 0!==r&&(p.bind(),i.setPickID(o,p,r),m.bind(),i.setPickID(o,m,r)),i.drawSkeleton(o,p,m,a,e.projectionParameters)}),i.endLayer(o,p)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let i=e.chunks,n=!0;return lE(t.segmentationGroupState.value,e=>{let t=lC(e),r=i.get(t);if(void 0===r||r.state!==ih.GPU_MEMORY){n=!1;return}}),n}}class py extends u2{base;renderHelper;renderOptions;constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new ph(e,!1)),this.renderOptions=e.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){if(!!e.emitColor||!e.alreadyEmittedPickID)this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class pb extends lL{base;renderHelper;renderOptions;constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new ph(e,!0)),this.renderOptions=e.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}let pS={dataType:ec.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class pw extends lc{vertexAttributes;indices;indexBuffer;numIndices;numVertices;vertexAttributeOffsets;vertexAttributeTextures;constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:i,vertexAttributeOffsets:n}=this,r=this.vertexAttributeTextures=[];for(let s=0,a=n.length;s<a;++s){let o=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),cy(e,t[s],i.subarray(n[s],s+1!==a?n[s+1]:i.length)),r[s]=o}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=nE.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let i of t)e.deleteTexture(i);t.length=0,this.indexBuffer.dispose()}}let pC=new Map;class px extends lv{attributeTextureFormats_;get attributeTextureFormats(){let e=this.attributeTextureFormats_;return void 0===e&&(e=this.attributeTextureFormats_=function(e){let t=[pc];for(let i of e.values())t.push(cv(new cs,i.dataType,i.numComponents));return t}(this.vertexAttributes)),e}getChunk(e){return new pw(this,e)}get vertexAttributes(){return pC}}var pE=((_={})[_.UNKNOWN=0]="UNKNOWN",_[_.IMAGE=1]="IMAGE",_[_.SEGMENTATION=2]="SEGMENTATION",_);function pT(e){let{rank:t,dataType:i,fillValue:n=i===ec.UINT64?eC.E.ZERO:0,compressedSegmentationBlockSize:r}=e,{baseVoxelOffset:s=new Float32Array(t)}=e;return{...oQ(e),compressedSegmentationBlockSize:r,baseVoxelOffset:s,dataType:i,fillValue:n}}function pk(e){let{rank:t,lowerVoxelBound:i,upperVoxelBound:n}=e;if(!function(e){if(void 0!==e.compressedSegmentationBlockSize||2!==e.volumeType&&!e.volumeSourceOptions.discreteValues)return!1;switch(e.dataType){case ec.UINT32:case ec.UINT64:break;default:return!1}switch(e.rank){case 3:return!0;case 4:{let{chunkDataSize:t}=e;if(1!==t[3])return!1;return!0}default:return!1}}(e))return pT(e);let{volumeSourceOptions:{displayRank:r,multiscaleToViewTransform:s},chunkToMultiscaleTransform:a,chunkToViewTransform:o}=e;void 0===o&&(o=to.Jp(new Float32Array(t*r),r,s,r,a,t+1,r,t,t));let{maxCompressedSegmentationBlockSize:l,chunkDataSize:d}=e;return pT({...e,compressedSegmentationBlockSize:Float32Array.from(oY({rank:t,chunkToViewTransform:o,displayRank:r,lowerVoxelBound:i,upperVoxelBound:n,maxVoxelsPerChunkLog2:9,maxBlockSize:void 0===l?d:function(e,t,i){let n=e.length;for(let r=0;r<n;++r)e[r]=Math.min(t[r],i[r]);return e}(new Uint32Array(t),d,l)}))})}function pD(e){let{rank:t}=e,{volumeSourceOptions:{displayRank:i,multiscaleToViewTransform:n,modelChannelDimensionIndices:r},chunkToMultiscaleTransform:s}=e,a=to.Jp(new Float32Array(i*t),i,n,i,s,t+1,i,t,t),{minBlockSize:o}=e;void 0===o?(o=new Uint32Array(t)).fill(1):o=new Uint32Array(o);let{lowerVoxelBound:l,upperVoxelBound:d}=e;if(0!==r.length)for(let e of(0,Q.Mz)(s,t,r)){let t=d[e];void 0!==l&&(t-=l[e]),o[e]=t}let{chunkDataSizes:u=function(e){if(void 0!==e.chunkDataSizes)return e.chunkDataSizes;let{chunkLayoutPreference:t=0}=e;switch(t){case 0:return[oY(e)];case 1:return function(e){let t=[],{displayRank:i,chunkToViewTransform:n,rank:r}=e;if(i>3)throw Error("Unsupported view transform");if(i<3)return[oY(e)];for(let s=0;s<3;++s){let a=(s+2)%3,o=new Float32Array(n);for(let e=0;e<r;++e)o[e*i+a]=0;t[s]=oY({...e,chunkToViewTransform:o})}return t}(e)}}({...e,minBlockSize:o,chunkToViewTransform:a,displayRank:i})}=e;return u.map(t=>pk({...e,chunkDataSize:t,chunkToViewTransform:a}))}function pP(e,t,i,n){let{dataType:r}=t;t.defineShader(e,i);let s="",a="";if(0===i)s+="highp int ignoredChannelIndex";else for(let e=0;e<i;++e)0!==e&&(s+=", "),s+=`highp int channelIndex${e}`,a+=`, channelIndex${e}`;e.addFragmentCode(nU);let o=`
${rn(r)} getDataValue(${s}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${n}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${a});
}
${rn(r)} getInterpolatedDataValue(${s}) {
  highp vec3 positionWithinChunk = ${n};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${rn(r)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${rn(r)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${rn(r)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${a});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;e.addFragmentCode(o),i<=1&&e.addFragmentCode(`
${rn(r)} getDataValue() { return getDataValue(0); }
${rn(r)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}let pL=[];function pI(e){pL.push(e)}class pR extends lV{chunkFormatHandler;tempChunkGridPosition;tempPositionWithinChunk;constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(function(e,t){for(let i of pL){let n=i(e,t);if(null!=n)return n}throw Error("No chunk format handler found.")}(e.chunkQueueManager.gl,this.spec));let i=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(i),this.tempPositionWithinChunk=new Uint32Array(i)}static encodeSpec(e){return{...super.encodeSpec(e),dataType:e.dataType,compressedSegmentationBlockSize:e.compressedSegmentationBlockSize&&Array.from(e.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(e.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let i=this.spec.rank,n=this.tempChunkGridPosition,r=this.tempPositionWithinChunk,{spec:s}=this;{let{chunkDataSize:t}=s;for(let s=0;s<i;++s){let i=e[s],a=t[s],o=Math.floor(i/a);n[s]=o,r[s]=Math.floor(i-a*o)}}let a=this.chunks.get(n.join());if(void 0===a)return null;let o=a.chunkDataSize;for(let e=0;e<3;++e)if(r[e]>=o[e])return;if(0===t.channelSpaceShape.length)return a.getValueAt(r);let{numChannels:l,chunkChannelCoordinates:d,chunkChannelDimensionIndices:u}=t,c=u.length,h=0,p=Array(l);for(let e=0;e<l;++e){for(let e=0;e<c;++e)r[u[e]]=d[h++];p[e]=a.getValueAt(r)}return p}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class pA extends lO{chunkDataSize;get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}}class pM extends lF{}let pN=Q.R3.create(),pV=Q.R3.create();function pO(e){let t=0;for(let i=0;i<3;++i)e[i]<0&&(t+=1<<i);return t}let p_=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),pF=(()=>{let e=[0,1,2,4,5,3,6,7],t=[0,1,2,5,3,4,6,7],i=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],n=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],r=new Int32Array(384);for(let s=0;s<8;++s)for(let a=0;a<i.length;++a){let o=8*t[s]+i[a];r[48*s+a]=e[n[o]]}return r})();function pB(e){e.addUniform("highp vec3","uPlaneNormal"),e.addUniform("highp float","uPlaneDistance"),e.addUniform("highp ivec2","uVertexIndex",24),e.addUniform("highp vec3","uVertexBasePosition",8),e.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),p_)}),e.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > 0.001) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -0.001) && (lambda <= (1.0 + 0.001))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function pU(e,t,i,n,r){let s=(0,Q._Z)(pN,t,n);Q.R3.normalize(s,s);let a=Q.R3.dot(Q.R3.transformMat4(pV,i,r),s);!function(e,t,i){let{gl:n}=e;n.uniform3fv(e.uniform("uPlaneNormal"),t),n.uniform1f(e.uniform("uPlaneDistance"),i);let r=pO(t);n.uniform2iv(e.uniform("uVertexIndex"),pF.subarray(48*r,(r+1)*48))}(e,s,a)}let p$=Q._E.create();class pG extends lP{shaderGetter;tempChunkPosition;shaderParameters;vertexIdHelper;constructor(e,t){let{shaderError:i=nb(),shaderParameters:n}=t;super(e.chunkManager,e,t);let{gl:r}=this;this.vertexIdHelper=this.registerDisposer(po.get(r)),this.shaderParameters=n;let{channelCoordinateSpace:s}=t;this.channelCoordinateSpace=void 0===s?(0,Z.ne)(tA):s,this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch));let a=this.registerDisposer((0,Z.mo)((e,t)=>({numChannelDimensions:e.rank,dataHistogramChannelSpecifications:t}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=nw(this,r,{memoizeKey:`volume/RenderLayer:${(0,nd.M)(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:n,encodeParameters:t.encodeShaderParameters,shaderError:i,extraParameters:a,defineShader:(e,t,i,n)=>{let{chunkFormat:r,dataHistogramsEnabled:s}=t,{dataHistogramChannelSpecifications:a,numChannelDimensions:o}=n;if(!function(e,t){if(pa(e),pB(e),e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),t){sx(e),e.setVertexMain(`
int vertexIndex1 = gl_VertexID / 6;
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),e.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}e.addVarying("highp vec3","vChunkPosition"),e.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    0.001 * abs(uPlaneNormal);
`)}(e,null===r),e.addOutputBuffer("vec4","v4f_fragData0",0),e.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),null===r)return;pP(e,r,o,"vChunkPosition");let l=a.length;if(s&&l>0){let t="",{dataType:i}=r;for(let n=0;n<l;++n){let{channel:r}=a[n],s=`out_histogram${n}`;e.addOutputBuffer("vec4",s,1+n);let o=`getDataValue(${r.join(",")})`,l=`invlerpForHistogram${n}`;e.addFragmentCode(rC(e,l,i,!1)),e.addFragmentCode(`
float getHistogramValue${n}() {
  return invlerpForHistogram${n}(${o});
}
`),t+=`{
float x = getHistogramValue${n}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${s} = vec4(x, x, x, 1.0);
}`}e.addFragmentCode(`void userMain();
void main() {
  ${t}
  userMain();
}
#define main userMain
`)}this.defineShader(e,i)},getContextKey:e=>`${e.chunkFormat?.shaderKey}/${e.dataHistogramsEnabled}`}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:i,chunkTransform:n}of this.visibleSourcesList){if(!iu(t,e,this.localPosition.value,n.layerRank,n.combinedGlobalLocalToChunkTransform))continue;let r=i.getValueAt(t,n);if(null!=r)return r}return null}beginChunkFormat(e,t,i){let{gl:n}=this,r=this.dataHistogramSpecifications.visibility.visible,s=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:r}),{shader:a,parameters:o,fallback:l}=s;if(null!==a){var d,u;if(a.bind(),d=a,u=i,null===t&&sT(d,u,1),null!==t){if(r){let{dataHistogramChannelSpecifications:e}=s.extraParameters,i=e.length,n=this.dataHistogramSpecifications.bounds.value;for(let e=0;e<i;++e)rE(a,`invlerpForHistogram${e}`,t.dataType,n[e])}this.initializeShader(e,a,o,l),t.beginDrawing(n,a)}}return s}endSlice(e,t,i){}draw(e){let t,i;let{sliceView:n}=e,{visibleSources:r}=n.visibleLayers.get(this);if(0===r.length)return;let{projectionParameters:s,wireFrame:a}=e,{gl:o}=this;this.vertexIdHelper.enable();let l=Q.R3.create(),{renderScaleHistogram:d}=this;void 0!==d&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let u=null,c=Q.R3.create(),h=()=>{null!==u&&(u.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(o,u),this.endSlice(n,u,t.parameters))},p=!0;for(let e of r){let r;let v=o5(s,e.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:y}}=e,b=e.source,{fixedPositionWithinChunk:S,chunkDisplayDimensionIndices:w}=e;for(let e of w)S[e]=0;let C=a?null:b.chunkFormat;if(C!==i&&(i=C,h(),u=(t=this.beginChunkFormat(n,C,s)).shader),null===u)continue;let x=b.chunks;c.fill(1);let E=v.size,T=b.spec.rank;!function(e,t,i,n,r,s){let a=i.projectionParameters.value,{centerDataPosition:o}=a;pU(t,a.viewportNormalInGlobalCoordinates,o,s.transform,s.invTransform),e.uniformMatrix4fv(t.uniform("uProjectionMatrix"),!1,Q._E.multiply(p$,n,s.transform)),e.uniform3fv(t.uniform("uLowerClipBound"),r.lowerClipDisplayBound),e.uniform3fv(t.uniform("uUpperClipBound"),r.upperClipDisplayBound)}(o,u,n,s.viewProjectionMat,e,v),null!==C&&C.beginSource(o,u),p=!0;let k=0,D=0;if(n.forEachVisibleChunk(e,v,e=>{let t=x.get(e);if(t&&t.state===ih.GPU_MEMORY){let e=t.chunkDataSize;if(e!==r){var i,n,s;r=e;for(let e=0;e<3;++e){let t=w[e];c[e]=-1===t||t>=T?1:r[t]}i=o,n=u,s=c,i.uniform3fv(n.uniform("uChunkDataSize"),s)}let{chunkGridPosition:d}=t;for(let e=0;e<3;++e){let t=w[e];l[e]=-1===t||t>=T?0:E[e]*d[t]}null!==C&&C.bindChunk(o,u,t,S,w,y,p),p=!1,!function(e,t,i,n){if(e.uniform3fv(t.uniform("uTranslation"),i),n){var r,s,a;r=t.gl,s=6,a=1,sC(r,6,1)}else e.drawArrays(e.TRIANGLE_FAN,0,6)}(o,u,l,a),++k}else++D}),(0!==k||0!==D)&&void 0!==d){var g,m,f;let{effectiveVoxelSize:t}=e;let i=(g=t[0],m=t[1],f=t[2],g>m?f>g?g:m>f?m:f:f>m?m:g>f?g:f);d.add(i,i/s.pixelSize,k,D)}}if(h(),this.vertexIdHelper.disable(),!e.wireFrame){let e=this.getDataHistogramCount();e>0&&n.computeHistograms(e,this.dataHistogramSpecifications)}}}class pz{disjointSets;generation;hashMap;constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new cr}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:i}=this;for(let[t,n]of(i.clear(),e.mappings()))i.set(t,n)}}}class pj extends pG{displayState;segmentationGroupState;segmentColorShaderManager;segmentStatedColorShaderManager;gpuSegmentStatedColorHashTable;hashTableManager;gpuHashTable;gpuTemporaryHashTable;equivalencesShaderManager;equivalencesHashMap;temporaryEquivalencesHashMap;gpuEquivalencesHashTable;gpuTemporaryEquivalencesHashTable;constructor(e,t){super(e,{shaderParameters:new Z.ny(e=>({hasEquivalences:e.registerDisposer((0,Z.mo)(e=>0!==e.size,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:e.registerDisposer((0,Z.mo)((e,t,i)=>0!==(i?t:e).size,[t.segmentStatedColors,t.tempSegmentStatedColors2d,t.useTempSegmentStatedColors2d])),hasSegmentDefaultColor:e.registerDisposer((0,Z.mo)((e,t)=>void 0!==e||void 0!==t,[t.segmentDefaultColor,t.tempSegmentDefaultColor2d])),hasHighlightColor:e.registerDisposer((0,Z.mo)(e=>void 0!==e,[t.highlightColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring,baseSegmentHighlighting:t.baseSegmentHighlighting})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentColorShaderManager=new cD("segmentColorHash"),this.segmentStatedColorShaderManager=new cR("segmentStatedColor"),this.hashTableManager=new cT("visibleSegments"),this.equivalencesShaderManager=new ck("equivalences"),this.segmentationGroupState=t.segmentationGroupState.value,this.gpuHashTable=this.registerDisposer(cE.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=cE.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesHashMap=new pz(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new pz(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(cE.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(cE.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),ho(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){this.gpuSegmentStatedColorHashTable?.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let i=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;i+=`return x;
}
`,e.addFragmentCode(i),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uFlags"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let n=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};
  uint64_t valueForHighlight = ${t.baseSegmentHighlighting?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(n+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),n+=`
  bool has = (uFlags & 2u) != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if ((uFlags & 1u) != 0u && uSelectedSegment == valueForHighlight.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
`,t.hasHighlightColor&&(e.addUniform("highp vec4","uHighlightColor"),n+=`
    emit(uHighlightColor);
    return;
`),n+=`
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let r=`vec4 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),r+=`
  vec4 rgba;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgba)) {
    return rgba;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec4","uSegmentDefaultColor"),r+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),r+=`  return vec4(segmentColorHash(value), 0.0);
`),r+=`
}
`,e.addFragmentCode(r),n+=`
  vec4 rgba = getMappedIdColor(valueForColor);
  if (rgba.a > 0.0) {
    alpha = rgba.a;
  }
  emit(vec4(mix(vec3(1.0,1.0,1.0), vec3(rgba), saturation), alpha));
`,e.setFragmentMain(n)}initializeShader(e,t,i){let{gl:n}=this,{displayState:r,segmentationGroupState:s}=this,{segmentSelectionState:a}=this.displayState,{segmentDefaultColor:{value:o},segmentColorHash:{value:l},highlightColor:{value:d},tempSegmentDefaultColor2d:{value:u}}=this.displayState,c=lx(s),h=this.displayState.ignoreNullVisibleSet.value,p=0,g=0,m=0;if(a.hasSelectedSegment&&r.hoverHighlight.value){let e=r.baseSegmentHighlighting.value?a.baseSelectedSegment:a.selectedSegment;p=e.low,g=e.high,m|=1}if(n.uniform1f(t.uniform("uSelectedAlpha"),r.selectedAlpha.value),n.uniform1f(t.uniform("uSaturation"),r.saturation.value),n.uniform1f(t.uniform("uNotSelectedAlpha"),r.notSelectedAlpha.value),n.uniform2ui(t.uniform("uSelectedSegment"),p,g),0===c.hashTable.size&&h&&(m|=2),n.uniform1ui(t.uniform("uFlags"),m),this.hashTableManager.enable(n,t,s.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),i.hasEquivalences){let e=s.useTemporarySegmentEquivalences.value;(e?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(n,t,e?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}let f=u||o;if(f){let[e,i,r,s]=f;n.uniform4f(t.uniform("uSegmentDefaultColor"),e,i,r,void 0===s?0:s)}else this.segmentColorShaderManager.enable(n,t,l);if(i.hasSegmentStatedColors){let e=r.useTempSegmentStatedColors2d.value?r.tempSegmentStatedColors2d.value:r.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:i}=this;(void 0===i||i.hashTable!==e.hashTable)&&(i?.dispose(),this.gpuSegmentStatedColorHashTable=i=cE.get(n,e.hashTable)),this.segmentStatedColorShaderManager.enable(n,t,i)}void 0!==d&&n.uniform4fv(t.uniform("uHighlightColor"),d)}endSlice(e,t,i){let{gl:n}=this;this.hashTableManager.disable(n,t),i.hasEquivalences&&this.equivalencesShaderManager.disable(n,t),i.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(n,t),super.endSlice(e,t,i)}}function pW(e=.5){return new Z.TU(e,eb.j2)}i("9547");let pq=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function pH(e,t,i){e.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,36*t,i)}let pJ=1,pK=9,pZ=21,pY=Float32Array.from([0,0,0,0,0,1,pK+0,1,0,0,1,0,1,pK+1,0,1,0,0,1,1,pK+2,1,1,0,1,1,1,pK+3,0,0,0,0,1,0,pK+4,0,0,1,0,1,1,pK+5,1,0,0,1,1,0,pK+6,1,0,1,1,1,1,pK+7,0,0,0,1,0,0,pK+8,0,0,1,1,0,1,pK+9,0,1,0,1,1,0,pK+10,0,1,1,1,1,1,pK+11]),pX=Q._E.create(),pQ=new Float32Array(6);class p0 extends ls{defineShader(e){pa(e);let{rank:t}=this;ra(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}vertexIdHelper=this.registerDisposer(po.get(this.gl));enable(e,t,i){Q._E.invert(pX,t.modelViewProjectionMatrix),(0,Q.Mb)(pX,pQ);let{numChunkDisplayDims:n}=t.chunkDisplayTransform;for(let e=0;e<n;++e)pQ[e]=0,pQ[e+3]=0;for(let e=n;e<3;++e){let t=Math.abs(pQ[e+3]-pQ[e]);pQ[e]-=t,pQ[e+3]+=t}super.enable(e,t,e=>{let n=e.vertexShaderInputBinders.Bounds;n.enable(1);let{gl:r}=this;r.uniform3fv(e.uniform("uModelSpaceBoundOffsets"),pQ),r.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),n.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:s}=this;s.enable(),i(e),s.disable(),n.disable()})}}function p1(e){e.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function p2(e){e.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function p3(e){p2(e),e.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}class p4 extends p0{edgeBoxCornerOffsetsBuffer=this.registerDisposer(nE.fromData(this.gl,(0,Y.X9)(pY,7,1,6)));edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),sx(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),p3(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});boxCornerOffsetsBuffer=this.registerDisposer(nE.fromData(this.gl,(0,Y.X9)(p_,3,1,6)));cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),pn(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),p3(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${pJ}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)});drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,i=>{var n;let r=i.attribute("aBoxCornerOffset1"),s=i.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1,28,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(s,4,WebGL2RenderingContext.FLOAT,!1,28,12),sT(i,e.renderContext.projectionParameters,1),n=12,sC(t,12,e.count),t.disableVertexAttribArray(r),t.disableVertexAttribArray(s)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,i=>{var n,r;let s=i.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(s,3,WebGL2RenderingContext.FLOAT,!1),pr(i,e.renderContext.projectionParameters,{featherWidthInPixels:0}),n=i.gl,r=8,sC(n,8,e.count),t.disableVertexAttribArray(s)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}class p6 extends p0{faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),pB(e),sx(e),e.addVarying("highp float","vClipCoefficient"),p3(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / 6;
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{var t;let{rank:i}=this;super.defineShader(e),pB(e),e.addVarying("highp float","vClipCoefficient"),p1(t=e),t.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`),e.setVertexMain(`
float modelPositionA[${i}] = getBounds0();
float modelPositionB[${i}] = getBounds1();
for (int i = 0; i < ${i}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});enableForBoundingBox(e,t,i){super.enable(e,t,e=>{let n=t.renderContext.sliceView.projectionParameters.value;pU(e,n.viewportNormalInGlobalCoordinates,n.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),i(e)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{!function(e,t,i,n,r){e.drawArraysInstanced(t,0,6,r)}(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{var i,n;sT(t,e.renderContext.projectionParameters,1),i=t.gl,n=6,sC(i,6,e.count)})}}lo(eW.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:p6,perspectiveViewRenderHelper:p4,defineShaderNoOpSetters(e){p2(e),p1(e)},pickIdsPerInstance:pZ+6,snapPosition(e,t,i,n){let r=new Float32Array(t,i,2*e.length);n>=pJ&&n<pK&&!function(e,t){let i=e.length;for(let n=0;n<i;++n){let r=t[n],s=t[n+i],a=e[n];e[n]=Math.abs(r-a)<Math.abs(s-a)?r:s}}(e,r)},getRepresentativePoint(e,t,i){e.set(t.pointA)},updateViaRepresentativePoint(e,t,i){let n=t.length,{pointA:r,pointB:s}=e,a=new Float32Array(n),o=new Float32Array(n);for(let e=0;e<n;++e){let i=a[e]=t[e];o[e]=s[e]+(i-r[e])}return{...e,pointA:a,pointB:o}}});let p5=1;function p8(e){e.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function p7(e){e.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}class p9 extends ls{defineShader(e){pa(e);let{rank:t}=this;ra(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}vertexIdHelper=this.registerDisposer(po.get(this.gl));edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),sx(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),p8(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),pn(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),p7(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / 6;
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)});enable(e,t,i){super.enable(e,t,e=>{let n=e.vertexShaderInputBinders.VertexPosition;n.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),n.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:r}=this;r.enable(),i(e),r.disable(),n.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{var i,n;sT(t,e.renderContext.projectionParameters,1),i=t.gl,n=1,sC(i,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{var i,n;pr(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),i=t.gl,n=2,sC(i,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}}lo(eW.LINE,{sliceViewRenderHelper:p9,perspectiveViewRenderHelper:p9,defineShaderNoOpSetters(e){p8(e),p7(e)},pickIdsPerInstance:p5+2,snapPosition(e,t,i,n){let r=new Float32Array(t,i,2*e.length);0===n?!function(e,t){let i=e.length;(0,Q._r)(e,t.subarray(0,i),t.subarray(i),e)}(e,r):!function(e,t,i){let n=e.length,r=n*i;for(let i=0;i<n;++i)e[i]=t[r+i]}(e,r,n-p5)},getRepresentativePoint(e,t,i){e.set(0===i||i===p5?t.pointA:t.pointB)},updateViaRepresentativePoint(e,t,i){let n={...e},r=t.length;switch(i){case 0:{let{pointA:i,pointB:n}=e,s=new Float32Array(r),a=new Float32Array(r);for(let e=0;e<r;++e){let r=s[e]=t[e];a[e]=n[e]+(r-i[e])}return{...e,pointA:s,pointB:a}}case 1:return{...e,pointA:new Float32Array(t)};case 2:return{...e,pointB:new Float32Array(t)}}return n}});class ge extends ls{defineShaderCommon(e){let{rank:t}=this;ra(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{pa(e),pn(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{pa(t),sx(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});shaderGetter2d=this.makeShaderGetter2d(2);shaderGetter1d=this.makeShaderGetter2d(1);vertexIdHelper=this.registerDisposer(po.get(this.gl));enable(e,t,i){super.enable(e,t,e=>{let n=e.vertexShaderInputBinders.VertexPosition;n.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),n.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:r}=this;r.enable(),i(e),r.disable(),n.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,t=>{var i,n;pr(t,e.renderContext.projectionParameters,{featherWidthInPixels:1}),i=t.gl,n=1,sC(i,1,e.count)});break;case 2:case 1:this.enable(2===t?this.shaderGetter2d:this.shaderGetter1d,e,t=>{var i,n;sT(t,e.renderContext.projectionParameters,1),i=t.gl,n=1,sC(i,1,e.count)})}}}lo(eW.POINT,{sliceViewRenderHelper:ge,perspectiveViewRenderHelper:ge,defineShaderNoOpSetters(e){e.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(e,t,i){e.set(new Float32Array(t,i,e.length))},getRepresentativePoint(e,t){e.set(t.point)},updateViaRepresentativePoint:(e,t)=>({...e,point:new Float32Array(t)})});let gt=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,gi=[gt,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`],gn=[gt,`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function gr(e,t){let i=new Float32Array((e+1)*(t+1)*3),n=0;for(let r=0;r<=e;++r){let s=r*Math.PI/e,a=Math.sin(s),o=Math.cos(s);for(let e=0;e<=t;++e){let r=2*e*Math.PI/t,s=Math.sin(r),l=Math.cos(r);i[n++]=l*a,i[n++]=o,i[n++]=s*a}}return i}function gs(e,t){let i=new Uint16Array(e*t*6),n=0;for(let r=0;r<e;r++)for(let e=0;e<t;e++){let s=r*(t+1)+e,a=s+t+1;i[n++]=s,i[n++]=a,i[n++]=s+1,i[n++]=a,i[n++]=a+1,i[n++]=s+1}return i}class ga extends ef.gj{vertexBuffer;indexBuffer;numIndices;constructor(e,t,i){super(),this.vertexBuffer=this.registerDisposer(nT(e,WebGL2RenderingContext.ARRAY_BUFFER,gr,t,i)).value,this.indexBuffer=this.registerDisposer(nT(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,gs,t,i)).value,this.numIndices=t*i*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let i=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(i)}}let go=Q._E.create();class gl extends ls{defineShader(e){let{rank:t}=this;ra(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,i){super.enable(e,t,e=>{let n=e.vertexShaderInputBinders.CenterAndRadii;n.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),n.bind(this.geometryDataStride,t.bufferOffset),i(e),n.disable()})}}class gd extends gl{sphereRenderHelper=this.registerDisposer(new ga(this.gl,10,10));shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});tempLightVec=new Float32Array(4);draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:i}=t,n=this.tempLightVec,{lightDirection:r,ambientLighting:s,directionalLighting:a}=e.renderContext;Q.R3.scale(n,r,a),n[3]=s,i.uniform4fv(t.uniform("uLightDirection"),n),i.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,Q._E.transpose(Q._E.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class gu extends gl{shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{pa(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(gi),e.addVertexCode(gn),e.addVertexCode(sw),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});vertexIdHelper=this.registerDisposer(po.get(this.gl));draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:i}=t,n=e.renderContext.sliceView.projectionParameters.value,r=Q._E.multiply(go,e.renderSubspaceInvModelMatrix,n.invViewMatrix);i.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,r),i.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,n.projectionMat);Q._E.invert(go,r),i.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,go);let{vertexIdHelper:s}=this;s.enable(),sC(i,1,e.count),s.disable()})}}lo(eW.ELLIPSOID,{sliceViewRenderHelper:gu,perspectiveViewRenderHelper:gd,defineShaderNoOpSetters(e){e.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(e,t){e.set(t.center)},updateViaRepresentativePoint:(e,t)=>({...e,center:new Float32Array(t)})});let gc=Q._E.create(),gh=Q.R3.create();function gp(e){e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),e.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}let gg={defineShader(e){gp(e),sx(e),e.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),e.setVertexMain(`
int edgeIndex = gl_VertexID / 6;
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(e,t){sT(e,t,1)},draw(e,t,i){var n,r;let{gl:s}=e,{chunkLayout:a}=t;Q._E.multiply(gc,i.viewProjectionMat,a.transform),s.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,gc),s.uniform3fv(e.uniform("uChunkDataSize"),a.size),s.uniform3fv(e.uniform("uLowerClipBound"),t.lowerClipDisplayBound),s.uniform3fv(e.uniform("uUpperClipBound"),t.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:d}=t;for(let e=0;e<3;++e){let t=d[e];gh[e]=(-1===t?0:l[t])*o[e]}s.uniform3fv(e.uniform("uTranslation"),gh),n=12,r=1,sC(s,12,1)}},gm={defineShader(e){pB(e),gp(e),sx(e),e.setVertexMain(`
int vertexIndex1 = gl_VertexID / 6;
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(e,t){sT(e,t,1)},draw(e,t,i){var n,r;let{gl:s}=e,{chunkLayout:a}=t;Q._E.multiply(gc,i.viewProjectionMat,a.transform),s.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,gc),s.uniform3fv(e.uniform("uChunkDataSize"),a.size),s.uniform3fv(e.uniform("uLowerClipBound"),t.lowerClipDisplayBound),s.uniform3fv(e.uniform("uUpperClipBound"),t.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:d}=t;for(let e=0;e<3;++e){let t=d[e];gh[e]=(-1===t?0:l[t])*o[e]}s.uniform3fv(e.uniform("uTranslation"),gh),pU(e,i.viewportNormalInGlobalCoordinates,i.centerDataPosition,a.transform,a.invTransform),n=6,r=1,sC(s,6,1)}},gf=Q._E.create();class gv extends i5(lb){chunkManager;source;segmentationStates;constructor(e,t,i,n){super(n),this.chunkManager=e,this.source=t,this.segmentationStates=i,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});this.registerDisposer(i.changed.add(()=>{let e={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke("annotation/RenderLayer.updateSegmentation",e)}))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(void 0!==e)return e.map(e=>null==e?e:hp(e.segmentationGroupState.value))}}gv=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i0("annotation/RenderLayer")],gv);class gy extends ef.gj{chunkManager;state;layerChunkProgressInfo;buffer;numPickIds;generation;redrawNeeded;serializedAnnotations;get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}handleChangeAffectingBuffer;sharedObject;get visibility(){let{sharedObject:e}=this;if(void 0!==e)return e.visibility}segmentationStates;constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new ib,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new ez.K_,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.registerDisposer(t),this.segmentationStates=this.registerDisposer((0,Z.mo)((e,t)=>{let{displayState:i,source:n}=this.state,{relationshipStates:r}=i;return i.displayUnfiltered.value?void 0:n.relationships.map(e=>{let t=r.get(e);return t.showMatches.value?t.segmentationState.value:void 0})},[this.state.displayState.relationshipStates,this.state.displayState.ignoreNullSegmentFilter],(e,t)=>void 0===e||void 0===t?e===t:(0,Y.cO)(e,t))),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer((0,Z.Uw)((e,t)=>{if(this.handleChangeAffectingBuffer(),void 0!==t)for(let i of t)null!=i&&e.registerDisposer((0,Z.w)((e,t)=>{e.registerDisposer(t.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),e.registerDisposer(t.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},i.segmentationGroupState))},this.segmentationStates)),!(this.source instanceof tt)&&(this.sharedObject=this.registerDisposer(new gv(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:i}=this.state;this.registerDisposer(i.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof tt){let t=e.changed.count;if(this.generation!==t){let{buffer:i}=this;void 0===i&&(i=this.buffer=this.registerDisposer(new nE(this.chunkManager.gl))),this.generation=t;let n=this.serializedAnnotations=function(e,t){let i=new ts(e.annotationPropertySerializers);for(let n of e)(void 0===t||t(n))&&i.add(n);return i.serialize()}(e,function(e){if(void 0!==e)return t=>{let{relatedSegments:i}=t;if(void 0===i)return!1;for(let t=0,n=i.length;t<n;++t){let n=e[t];if(null==n)continue;let{visibleSegments:r,segmentEquivalences:s}=n.segmentationGroupState.value;for(let e of i[t])if(r.has(s.get(e)))return!0}return!1}}(this.segmentationStates.value));i.setData(this.serializedAnnotations.data),this.numPickIds=l$(n)}}}}function gb(e){let{chunkTransform:t}=e,{unpaddedRank:i}=t.modelTransform,n=new Float32Array(2*i),r=new Float32Array(3*i);r.fill(0),n.fill(1,i);let{numChunkDisplayDims:s,chunkDisplayDimensionIndices:a}=e;for(let e=0;e<s;++e){let t=a[e];n[i+t]=0,r[3*t+e]=1}return{modelClipBounds:n,renderSubspaceTransform:r}}function gS(e,t,i){let n;i.clearMessages();let r=e=>{i.addMessage({severity:iO.error,message:e})};if(void 0!==e.error)return r(e.error);let s=il(e.modelTransform,t.displayDimensionIndices);try{n=id(e,s)}catch(e){return r(e.message)}let{modelClipBounds:a,renderSubspaceTransform:o}=gb(n);return{chunkTransform:e,chunkDisplayTransform:n,modelClipBounds:a,renderSubspaceTransform:o}}function gw(e,t){return class i extends e{base;renderScaleHistogram;curRank;renderHelpers;tempChunkPosition;handleRankChanged(e=!1){let{rank:i}=this.base.source;if(!e&&i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);let{renderHelpers:n,gl:r}=this;for(let e of n)e.dispose();let{properties:{value:s}}=this.base.source,{displayState:a}=this.base.state;for(let e of eq){let o=ll(e),l=o[t],d=n[e]=new l(r,e,i,s,a.shaderControls,a.fallbackShaderControls,a.shaderError);d.pickIdsPerInstance=o.pickIdsPerInstance,d.targetIsSliceView="sliceViewRenderHelper"===t}}constructor(e,t){super(),this.base=e,this.renderScaleHistogram=t,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;let i=e.visibility;void 0!==i&&this.registerDisposer(i.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let e of this.renderHelpers)e.dispose()}),this.role=e.state.role,this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.source.properties.changed.add(()=>{this.handleRankChanged(!0)})),this.handleRankChanged(),this.registerDisposer(this.base.state.displayState.shaderControls.histogramSpecifications.producerVisibility.add(this.visibility))}attach(e){super.attach(e),this.handleRankChanged();let{chunkTransform:t}=this,i=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:i,chunkRenderParameters:gS(t,i,e.messages)}}updateAttachmentState(e){let t=e.state;this.handleRankChanged();let{chunkTransform:i}=this,n=e.view.displayDimensionRenderInfo.value;return void 0!==t&&t.chunkTransform===i&&t.displayDimensionRenderInfo===n?t.chunkRenderParameters:(t.chunkTransform=i,t.displayDimensionRenderInfo=n,t.chunkRenderParameters=gS(i,n,e.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(e,t){let{modelClipBounds:i}=t,n=this.curRank,{chunkTransform:r}=t;iu(i.subarray(0,n),e.projectionParameters.globalPosition,this.base.state.localPosition.value,r.layerRank,r.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(e,t,i,n=1){if(!e.bufferValid){let{buffer:t}=e;void 0===t&&(t=e.buffer=new nE(this.gl));let{serializedAnnotations:i}=e;t.setData(i.data),e.numPickIds=l$(i),e.bufferValid=!0}this.drawGeometry(e,t,i,n)}drawGeometry(e,t,i,n=1){let{base:r}=this,{chunkDisplayTransform:s}=i,{serializedAnnotations:a}=e,{typeToIdMaps:o,typeToOffset:l}=a,d=0;t.emitPickID&&(d=t.pickIDs.register(this,e.numPickIds,0,0,e));let u=r.hoverState.value,c=Q._E.multiply(gf,t.projectionParameters.viewProjectionMat,s.displaySubspaceModelMatrix),h={annotationLayer:r,renderContext:t,selectedIndex:0,basePickId:d,buffer:e.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:c,modelClipBounds:i.modelClipBounds,subspaceMatrix:i.renderSubspaceTransform,renderSubspaceModelMatrix:s.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:s.displaySubspaceInvModelMatrix,chunkDisplayTransform:s},p=this.base.state.displayState.shaderControls.histogramSpecifications.visibleHistograms>0;for(let e of eq){let i=o[e],r=i.size;if(r>0){let s=ll(e),a=0xffffffff;if(void 0!==u){let e=i.get(u.id);void 0!==e&&(a=e*s.pickIdsPerInstance)}r=Math.round(r*n),h.count=r,h.bufferOffset=l[e],h.selectedIndex=a;let o=this.renderHelpers[e];o.draw(h),p&&(o.computeHistograms(h,t.frameNumber),t.bindFramebuffer()),h.basePickId+=r*s.pickIdsPerInstance}}}updateMouseState(e,t,i,n){let{serializedAnnotations:r}=n,{typeToIds:s,typeToOffset:a}=r,o=this.curRank,l=this.chunkTransform;if(void 0===l.error)for(let t of eq){let n=s[t],d=ll(t),{pickIdsPerInstance:u}=d;if(i<n.length*u){let s=Math.floor(i/u),c=n[s],h=i%u;e.pickedAnnotationId=c,e.pickedAnnotationLayer=this.base.state,e.pickedOffset=h,e.pickedAnnotationBuffer=r.data.buffer,e.pickedAnnotationType=t,e.pickedAnnotationBufferBaseOffset=r.data.byteOffset+a[t],e.pickedAnnotationIndex=s,e.pickedAnnotationCount=n.length;let p=this.tempChunkPosition,{chunkToLayerTransform:g,combinedGlobalLocalToChunkTransform:m,layerRank:f}=l,{globalToRenderLayerDimensions:v}=l.modelTransform,{position:y}=e;if(!iu(p,y,this.base.state.localPosition.value,f,m))return;let b=this.base.source.annotationPropertySerializers[t];d.snapPosition(p,e.pickedAnnotationBuffer,e.pickedAnnotationBufferBaseOffset+e.pickedAnnotationIndex*b.propertyGroupBytes[0],h);let S=v.length;for(let e=0;e<S;++e){let t=v[e];if(-1===t)continue;let i=g[(o+1)*o+t];for(let e=0;e<o;++e)i+=p[e]*g[e*(f+1)+t];if(!!Number.isFinite(i))y[e]=i}return}i-=n.length*u}}transformPickedValue(e){let{pickedAnnotationBuffer:t}=e;if(void 0===t)return;let{properties:{value:i}}=this.base.source;if(0===i.length)return;let{pickedAnnotationBufferBaseOffset:n,pickedAnnotationType:r,pickedAnnotationIndex:s,pickedAnnotationCount:a}=e,{annotationPropertySerializers:o}=this.base.source,l=Array(i.length);return o[r].deserialize(new DataView(t),n,s,a,ev.LITTLE===ey,l),function(e,t){switch(e.type){case"rgb":return ea(er(t));case"rgba":return ea(es(t));default:return eQ(e,t)}}(i[0],l[0])}isAnnotation}}let gC=e=>class extends e{layerChunkProgressInfo=this.base.layerChunkProgressInfo;draw(e,t){let i=this.updateAttachmentState(t);if(0===this.curRank||void 0===i)return;this.updateModelClipBounds(e,i);let{source:n}=this.base;if(n instanceof tt){let{base:t}=this;t.updateBuffer(),this.drawGeometry(t,e,i)}else{let{renderScaleHistogram:t}=this;t.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(n.temporary.data,e,i);let{value:r}=this.base.segmentationStates,s=0,a=0;if(void 0!==r)for(let t=0,o=r.length;t<o;++t){let o=r[t];if(null==o)continue;let l=n.segmentFilteredSources[t].chunks;lE(o.segmentationGroupState.value,t=>{let n=lC(t),r=l.get(n);if(void 0!==r&&r.state===ih.GPU_MEMORY){let{data:t}=r;if(void 0===t)return;this.drawGeometryChunkData(t,e,i),++s}else++a})}t.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,s,a)}}isReady(){let{base:e}=this,{source:t}=e;if(!(t instanceof lQ))return!0;let{value:i}=this.base.segmentationStates;if(void 0===i)return!0;for(let e=0,n=i.length;e<n;++e){let n=i[e];if(null===n)return!1;if(void 0===n)continue;let r=t.segmentFilteredSources[e].chunks,s=!1;if(lE(n.segmentationGroupState.value,e=>{let t=lC(e);!r.has(t)&&(s=!0)}),s)return!1}return!0}},gx=gw(u2,"perspectiveViewRenderHelper");class gE extends gC(gx){}let gT=e=>{class t extends e{renderScaleTarget;constructor(e){super(e.annotationLayer,e.renderScaleHistogram),this.renderScaleTarget=e.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let t=this.registerDisposer(new lb(this.layerChunkProgressInfo)),i=this.base.chunkManager.rpc;t.RPC_TYPE_ID="annotation/SpatiallyIndexedRenderLayer",t.initializeCounterpart(i,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(i3.makeFromExisting(i,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(i3.makeFromExisting(i,this.renderScaleTarget)).rpcId}),this.backend=t}backend;attach(e){super.attach(e),e.state.sources=e.registerDisposer((0,Z.Uw)((t,i,n)=>{let r=lB(n,i,e=>this.base.state.source.getSources(e),e.messages,this);for(let e of r)for(let i of e)t.registerDisposer(i.source),Object.assign(i,gb(i.chunkDisplayTransform));return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke("annotation/PerspectiveRenderLayer:updateSources",{layer:this.backend.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:n,sources:lA(r)}),this.redrawNeeded.dispatch(),r},this.base.state.transform,e.view.displayDimensionRenderInfo))}wireFrameRenderHelper=this instanceof lL?gm:gg;wireFrameShaderGetter=nC(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof lL}`,parameters:(0,Z.ne)(void 0),defineShader:e=>{this.wireFrameRenderHelper.defineShader(e)}});draw(e,t){let i;let n=this.updateAttachmentState(t);if(0===this.curRank||void 0===n)return;let r=t.state.sources.value;if(0===r.length)return;this.updateModelClipBounds(e,n);let{renderScaleHistogram:s}=this;s.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:a}=e;if(e.wireFrame){let{shader:t}=this.wireFrameShaderGetter(e.emitter);if(null===t)return;t.bind(),this.wireFrameRenderHelper.initialize(t,a),i=t}o7(a,this.base.state.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},(t,r,o,l,d)=>{let u;let c=t.source.chunks.get(t.curPositionInChunks.join());if(void 0===c||c.state!==ih.GPU_MEMORY)u=0;else{let{data:r}=c;if(void 0===r)return;void 0!==i?this.wireFrameRenderHelper.draw(i,t,a):this.drawGeometryChunkData(r,e,n,o),u=1}s.add(l,d,u,1-u)})}isReady(e,t){let i=this.updateAttachmentState(t);if(0===this.curRank||void 0===i)return;let n=t.state.sources.value;if(0===n.length)return;this.updateModelClipBounds(e,i);let{projectionParameters:r}=e,s=!0;return o7(r,this.base.state.localPosition.value,this.renderScaleTarget.value,n[0],()=>{},(e,t,i,n,r)=>{let a=e.source.chunks.get(e.curPositionInChunks.join());if(void 0===a||a.state!==ih.GPU_MEMORY){s=!1;return}}),s}}return t},gk=gT(gx),gD=gT(gw(lL,"sliceViewRenderHelper")),gP=gC(gw(lL,"sliceViewRenderHelper"));var gL=i("9314");function gI(e={}){return sV({svg:gL,...e})}var gR=i("888");function gA(e={}){let t=sV({svg:gR,...e});return t.firstElementChild.style.fill="white",t}class gM{anchorIndex=0;anchorClientOffset=0;splice(e){let{anchorIndex:t}=this,i=0;for(let n of e){if(t<(i+=n.retainCount))break;let{deleteCount:e}=n;if(t<i+e){t=i;break}let{insertCount:r}=n;t=t-e+r,i+=r-r}this.anchorIndex=t}}class gN{startIndex=0;endIndex=0;anchorIndex=0;anchorOffset=0;scrollOffset=0;viewportWidth=0}class gV{itemSize=[];totalKnownSize=0;numItemsInTotalKnownSize=0;get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){return this.itemSize[e]??this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,i=0){for(;t<e;++t)i+=this.getEstimatedSize(t);for(;t>e;--t)i-=this.getEstimatedSize(t-1);return i}getRangeSize(e,t){let i=0,{itemSize:n,averageSize:r}=this;for(let s=e;s<t;++s)i+=n[s]??r;return i}splice(e){let{itemSize:t}=this;t=this.itemSize=(0,Y.x)(t,e),this.totalKnownSize=t.reduce((e,t)=>e+t,0),this.numItemsInTotalKnownSize=t.reduce(e=>e+1,0)}}class gO extends ef.gj{element=document.createElement("div");scrollContent=document.createElement("div");header=document.createElement("div");body=document.createElement("div");topItems=document.createElement("div");bottomItems=document.createElement("div");renderedItems=[];renderGeneration=-1;listGeneration=-1;newRenderedItems=[];state=new gM;renderParams=new gN;newRenderParams=new gN;sizes=new gV;source;debouncedUpdateView=this.registerCancellable((0,iS.H)(()=>this.updateView()));resizeObserver=new ResizeObserver(()=>this.debouncedUpdateView());constructor(e){super();let{selectedIndex:t}=e;void 0!==t&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let i=this.source=e.source;this.sizes.itemSize.length=i.length;let{element:n,header:r,body:s,scrollContent:a,topItems:o,bottomItems:l}=this;this.resizeObserver.observe(n),this.registerDisposer(()=>this.resizeObserver.disconnect()),n.appendChild(a),n.style.overflowAnchor="none",a.appendChild(r),a.appendChild(s),r.style.position="sticky",r.style.zIndex="1",r.style.top="0",e.horizontalScroll?(a.style.width="min-content",a.style.minWidth="100%",r.style.width="min-content",r.style.minWidth="100%",l.style.width="min-content",l.style.minWidth="100%"):(a.style.width="100%",r.style.width="100%",l.style.width="100%"),s.appendChild(o),s.appendChild(l),o.style.width="min-content",o.style.position="relative",o.style.height="0",o.style.minWidth="100%",l.style.height="0",l.style.position="relative",n.addEventListener("scroll",()=>{let e=n.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-e,this.renderParams.scrollOffset=e,this.debouncedUpdateView()}),void 0!==i.changed&&this.registerDisposer(i.changed.add(e=>{this.sizes.splice(e),this.state.splice(e),this.renderedItems.length=0,this.debouncedUpdateView()})),void 0!==i.renderChanged&&this.registerDisposer(i.renderChanged.add(this.debouncedUpdateView))}updateView(){let e;let{element:t}=this,i=t.clientHeight-this.header.offsetHeight,n=t.clientWidth,{source:r,state:s,sizes:a}=this,o=r.length,{body:l,topItems:d,bottomItems:u}=this,{changed:c,renderChanged:h}=r;for(;;){var p,g;let t;e=this.newRenderParams;let r=this.renderParams;if(!function(e,t,i,n,r,s){let a,o,l,d,u;let{anchorIndex:c,anchorClientOffset:h}=s,p=r.getEstimatedOffset(c);if(0===n||0===r.totalKnownSize)o=Math.min(i,(a=Math.max(0,c-5))+10),u=c,l=0,d=h;else{let e=Math.max(0,r.getEstimatedTotalSize()-n),s=(d=Math.max(0,Math.min(e,d=p-h)))-1*n,g=d-.5*n,m=d+n+.5*n,f=p-h+n+1*n;a=Math.min(i,t.startIndex);let v=r.getEstimatedOffset(a,c,p);if(v<s)for(;a+1<i;++a){let e=r.getEstimatedSize(a);if(v+e>=g)break;v+=e}if(v>=g)for(;v>s&&a>0;--a)v-=r.getEstimatedSize(a-1);o=Math.min(i,t.endIndex);let y=r.getEstimatedOffset(o,c,p);if(y<m)for(;y<=f&&o+1<=i;++o)y+=r.getEstimatedSize(o);else if(y>=f)for(;o>a;--o){let e=r.getEstimatedSize(o-1);if(y-e<m)break;y-=e}for(u=c,l=p;u<a;++u)l+=r.getEstimatedSize(u);for(;u>o;--u)l-=r.getEstimatedSize(u-1)}e.startIndex=a,e.endIndex=o,e.anchorIndex=u,e.anchorOffset=l,e.scrollOffset=d}(e,r,o,i,a,s),e.viewportWidth=n,void 0!==h&&h.count!==this.renderGeneration||void 0!==c&&c.count!==this.listGeneration?(this.renderGeneration=void 0===h?-1:h.count,this.listGeneration=void 0===c?-1:c.count,t=!0,this.renderedItems.length=0):t=!1,!t&&(p=e,g=r,!(p.startIndex<g.startIndex)&&!(p.endIndex>g.endIndex)&&(0===p.viewportWidth||0!==g.viewportWidth))){r.scrollOffset=e.scrollOffset,e=r;break}this.renderParams=e,this.newRenderParams=r;let l=this.renderedItems,f=this.newRenderedItems;f.length=0,this.renderedItems=f,this.newRenderedItems=l;let{source:v}=this,{render:y}=v,{startIndex:b,endIndex:S,anchorIndex:w}=e;function*m(e,t){for(let i=e;i<t;++i){let e=l[i];void 0===e&&(e=y.call(v,i)),f[i]=e,yield e}}sM(d,m(b,w)),sM(u,m(w,S));for(let e=b;e<S;++e){let t=f[e].getBoundingClientRect().height,i=a.itemSize[e];void 0!==i&&(a.totalKnownSize-=i,--a.numItemsInTotalKnownSize),a.itemSize[e]=t,a.totalKnownSize+=t,++a.numItemsInTotalKnownSize}}!function(e,t){let i=t.getEstimatedOffset(e.anchorIndex),n=e.anchorOffset;e.anchorOffset=i,e.scrollOffset+=i-n}(e,a),s.anchorIndex=e.anchorIndex,s.anchorClientOffset=e.anchorOffset-e.scrollOffset;let f=a.getRangeSize(e.startIndex,e.anchorIndex),v=a.getEstimatedTotalSize()||0;l.style.height=`${v}px`,d.style.top=`${e.anchorOffset-f}px`,u.style.top=`${e.anchorOffset}px`,t.scrollTop=e.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:i}=this.renderParams,{renderedItems:n}=this;for(let r=t;r<i;++r){let t=n[r];void 0!==t&&e(t,r)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),i=t+this.sizes.getEstimatedSize(e),n=this.element.scrollTop;if(t<n)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else{if(!(t>n)||!(i>n+this.element.offsetHeight))return;this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight}this.debouncedUpdateView()}disposed(){sR(this.element)}}class g_ extends ef.gj{changed=new ez.K_;isLoadingChanged=new ez.K_;states=[];relationships=[];loadingCount=0;get value(){return this.states}get isLoading(){return 0!==this.loadingCount}markLoading(){return this.loadingCount++,()=>{0==--this.loadingCount&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let i=e.sourceIndex-t.sourceIndex;return 0!==i?i:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let i of t.source.relationships)e.add(i);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function gF(e,t,i){void 0===t.error&&e.setLayerPosition(t.modelTransform,i)}function gB(e,t,i){let{layerRank:n}=t,r=new Float32Array(n);e9[e.type].visitGeometry(e,(e,s)=>{r.set(e);let a=new Float32Array(n);(s?to.lU:to.DC)(a,t.chunkToLayerTransform,n+1,r,n),i(a,s)})}let gU=(e,t,i)=>{let n=i.chunkTransform.value,{layerRank:r}=n,s=new Float32Array(r),a=new Float32Array(r);!function(e,t){switch(t.type){case eW.AXIS_ALIGNED_BOUNDING_BOX:case eW.LINE:e.set(t.pointA);break;case eW.POINT:e.set(t.point);break;case eW.ELLIPSOID:e.set(t.center)}}(s,t),to.DC(a,n.chunkToLayerTransform,r+1,s,r),gF(e,n,a),i.displayState.swapVisibleSegmentsOnMove.value&&g$(t,i,!0)},g$=(e,t,i=!1)=>{let{relatedSegments:n}=e;if(n){let{source:e,displayState:r}=t,{relationships:s}=e,{relationshipStates:a}=r;for(let e=0,t=s.length;e<t;++e){let t=a.get(s[e]).segmentationState.value;if(t)for(let e of(i&&t.segmentationGroupState.value.visibleSegments.clear(),n))t.segmentationGroupState.value.visibleSegments.add(e)}}};class gG extends s_{layer;displayState;annotationStates;previousSelectedState;previousHoverId;previousHoverAnnotationLayerState;virtualListSource;virtualList;listElements;updated;mutableControls;headerRow;attachedAnnotationStates;updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,i=new Map;for(let[i,n]of t)!e.includes(i)&&(t.delete(i),n.refCounted.dispose());for(let n of e){let e=t.get(n);if(void 0!==e){i.set(n,e);continue}let r=n.source,s=new ef.gj;r instanceof tt&&(s.registerDisposer(r.childAdded.add(e=>this.addAnnotationElement(e,n))),s.registerDisposer(r.childUpdated.add(e=>this.updateAnnotationElement(e,n))),s.registerDisposer(r.childDeleted.add(e=>this.deleteAnnotationElement(e,n)))),s.registerDisposer(n.transform.changed.add(this.forceUpdateView)),i.set(n,{refCounted:s,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=i,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}forceUpdateView;globalDimensionIndices;localDimensionIndices;curCoordinateSpaceGeneration;prevCoordinateSpaceGeneration;columnWidths;gridTemplate;updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,i=[],n=[];for(let e=0,n=t.rank;e<n;++e)this.annotationStates.states.some(t=>{let i=t.transform.value;return void 0===i.error&&-1!==i.globalToRenderLayerDimensions[e]})&&i.push(e);for(let t=0,i=e.rank;t<i;++t)this.annotationStates.states.some(e=>{let i=e.transform.value;return void 0===i.error&&-1!==i.localToRenderLayerDimensions[t]})&&n.push(t);(!(0,Y.cO)(i,this.globalDimensionIndices)||!(0,Y.cO)(n,this.localDimensionIndices))&&(this.localDimensionIndices=n,this.globalDimensionIndices=i,++this.curCoordinateSpaceGeneration)}constructor(e,t,i=e.annotationStates){super(),this.layer=e,this.displayState=t,this.annotationStates=i,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:e=>this.render(e),changed:new ez.MZ},this.virtualList=new gO({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new Map,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.element.classList.add("neuroglancer-annotation-layer-view"),this.selectedAnnotationState=(0,Z.og)((e,t)=>{if(void 0===e)return;let{layer:i}=this,n=e.layers.find(e=>e.layer===i)?.state;if(void 0===n)return;let{annotationId:r}=n;if(void 0===r)return;let s=this.annotationStates.states.find(e=>e.sourceIndex===n.annotationSourceIndex&&(void 0===n.annotationSubsource||e.subsourceId===n.annotationSubsource));if(void 0!==s)return{annotationId:r,annotationLayerState:s,pin:t}},e.manager.root.selectionState,e.manager.root.selectionState.pin),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(this.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let n=document.createElement("div");n.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);let r=this.registerDisposer(new sD(this.displayState.color));r.element.title="Change annotation display color",this.registerDisposer(new ns((0,Z.og)(e=>null!==e.match(/\bdefaultColor\b/),t.shaderControls.processedFragmentMain),r.element)),n.appendChild(r.element);let{mutableControls:s}=this,a=sV({text:e9[eW.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new gZ(this.layer,{})}});s.appendChild(a);let o=sV({text:e9[eW.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new g0(this.layer,{})}});s.appendChild(o);let l=sV({text:e9[eW.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new g1(this.layer,{})}});s.appendChild(l);let d=sV({text:e9[eW.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new g2(this.layer,{})}});s.appendChild(d),n.appendChild(s),this.element.appendChild(n),this.element.appendChild(this.headerRow);let{virtualList:u}=this;u.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(u.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let c=cM();this.registerDisposer(new sy(this.virtualList.element,c)),this.virtualList.element.title=c.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}getRenderedAnnotationListElement(e,t,i=!1){let n=this.attachedAnnotationStates.get(e);if(void 0===n)return;let r=n.idToIndex.get(t);if(void 0===r)return;let s=n.listOffset+r;return i&&this.virtualList.scrollItemIntoView(r),this.virtualList.getItemElement(s)}clearSelectionClass(){let{previousSelectedState:e}=this;if(void 0===e)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);void 0!==t&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(void 0!==t){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let i=this.getRenderedAnnotationListElement(t,e);void 0!==i&&i.classList.remove("neuroglancer-annotation-hover")}}selectedAnnotationState;updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||void 0!==t&&void 0!==e&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin)return;if(this.clearSelectionClass(),this.previousSelectedState=e,void 0===e)return;let i=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);void 0!==i&&i.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e,t;let i=this.displayState.hoverState.value;void 0!==i&&(e=i.id,t=i.annotationLayerState);let{previousHoverId:n,previousHoverAnnotationLayerState:r}=this;if(e===n&&t===r)return;if(this.clearHoverClass(),this.previousHoverId=e,this.previousHoverAnnotationLayerState=t,void 0===e)return;let s=this.getRenderedAnnotationListElement(t,e);void 0!==s&&s.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:i}=this.listElements[e],{layer:n,gridTemplate:r,globalDimensionIndices:s,localDimensionIndices:a}=this,[o,l]=g5(n,t,i,r,s,a);for(let[e,t]of l.entries())this.setColumnWidth(e,t);o.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:t.id,partIndex:0,annotationLayerState:i}});let d=this.selectedAnnotationState.value;return void 0!==d&&d.annotationLayerState===i&&d.annotationId===t.id&&o.classList.add("neuroglancer-annotation-selected"),o}setColumnWidth(e,t){t+=2;let{columnWidths:i}=this;if(!(i[e]>t))i[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`)}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:e}=this;e.length=0;let{headerRow:t}=this,i=document.createElement("div");i.style.gridColumn="symbol";let n=document.createElement("div");n.style.gridColumn="delete",sI(t),t.appendChild(i);let r=0,s="[symbol] 2ch",a=(e,i)=>{let n=document.createElement("div");n.classList.add("neuroglancer-annotations-view-dimension");let a=document.createElement("span");a.classList.add("neuroglancer-annotations-view-dimension-name"),a.textContent=e.names[i];let o=document.createElement("scale");o.classList.add("neuroglancer-annotations-view-dimension-scale"),o.textContent=tm(e.scales[i],e.units[i],{precision:2}),n.appendChild(a),n.appendChild(o),n.style.gridColumn=`dim ${r+1}`,this.setColumnWidth(r,o.textContent.length+a.textContent.length+3),s+=` [dim] var(--neuroglancer-column-${r}-width)`,++r,t.appendChild(n)},o=this.layer.manager.root.coordinateSpace.value;for(let e of this.globalDimensionIndices)a(o,e);let l=this.layer.localCoordinateSpace.value;for(let e of this.localDimensionIndices)a(l,e);t.appendChild(n),s+=" [delete] 2ch",this.gridTemplate=s,t.style.gridTemplateColumns=s,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;for(let[i,n]of(t.length=0,this.attachedAnnotationStates)){if(!i.source.readonly&&(e=!0),void 0!==i.chunkTransform.value.error)continue;let{source:r}=i,s=Array.from(r);n.annotations=s;let{idToIndex:a}=n;a.clear();for(let e=0,t=s.length;e<t;++e)a.set(s[e].id,e);for(let e of s)t.push({state:i,annotation:e})}let i=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:i,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let i=this.attachedAnnotationStates.get(t);if(void 0!==i){let n=i.annotations.length;i.annotations.push(e),i.idToIndex.set(e.id,n);let r=i.listOffset+n;this.listElements.splice(r,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let i=this.attachedAnnotationStates.get(t);if(void 0!==i){let t=i.idToIndex.get(e.id);if(void 0!==t){let n=i.listOffset+t;i.annotations[t]=e,this.listElements[n].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:n,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let i=this.attachedAnnotationStates.get(t);if(void 0!==i){let{idToIndex:t}=i,n=t.get(e);if(void 0!==n){let r=i.listOffset+n,{annotations:s}=i;s.splice(n,1),t.delete(e);for(let e=n,i=s.length;e<i;++e)t.set(s[e].id,e);this.listElements.splice(r,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}}class gz extends s_{layer;layerView;constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new gG(e,e.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function gj(e,t=!1){let i=[],{relationships:n}=e.source,{relationshipStates:r}=e.displayState;for(let e=0,s=n.length;e<s;++e){let s=r.get(n[e]).segmentationState.value;if(null!=s&&s.segmentSelectionState.hasSelectedSegment){i[e]=[s.segmentSelectionState.selectedSegment.clone()],t&&(i[e]=[...i[e],s.segmentSelectionState.baseSelectedSegment.clone()]);continue}i[e]=[]}return i}class gW extends aE{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}let gq="annotatePoint",gH="annotateLine",gJ="annotateBoundingBox",gK="annotateSphere";class gZ extends gW{trigger(e){let{annotationLayer:t}=this;if(void 0!==t){if(e.updateUnconditionally()){let i=gY(e,t);if(void 0===i)return;let n={id:"",description:"",relatedSegments:gj(t),point:i,type:eW.POINT,properties:t.source.properties.value.map(e=>e.default)},r=t.source.add(n,!0);this.layer.selectAnnotation(t,r.id,!0),r.dispose()}}}get description(){return"annotate point"}toJSON(){return gq}}function gY(e,t){let i=t.chunkTransform.value;if(void 0!==i.error)return;let n=new Float32Array(i.modelTransform.unpaddedRank);if(!!iu(n,e.unsnappedPosition,t.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))return n}class gX extends gW{inProgressAnnotation=new Z.SN(void 0);trigger(e){let{annotationLayer:t,inProgressAnnotation:i}=this;if(void 0!==t){if(e.updateUnconditionally()){let n=()=>{let n=i.value,r=n.reference,s=this.getUpdatedAnnotation(r.value,e,t);if(JSON.stringify(te(s,t.source))!==JSON.stringify(te(r.value,t.source)))n.annotationLayer.source.update(r,s),this.layer.selectAnnotation(t,r.id,!0)};if(void 0===i.value){let r=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,r.id,!0);let s=e.changed.add(n);i.value={annotationLayer:t,reference:r,disposer:()=>{s(),r.dispose()}}}else{n();let e=i.value;e.annotationLayer.source.commit(e.reference),e.disposer(),i.value=void 0}}}}disposed(){this.deactivate(),super.disposed()}deactivate(){let e=this.inProgressAnnotation.value;void 0!==e&&(e.annotationLayer.source.delete(e.reference),e.disposer(),this.inProgressAnnotation.value=void 0)}}class gQ extends gX{getInitialAnnotation(e,t){let i=gY(e,t);return{id:"",type:this.annotationType,description:"",pointA:i,pointB:i,properties:t.source.properties.value.map(e=>e.default)}}getUpdatedAnnotation(e,t,i){let n=gY(t,i);return void 0===n?e:{...e,pointB:n}}}class g0 extends gQ{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,i){let n=super.getUpdatedAnnotation(e,t,i),{pointA:r,pointB:s}=n,a=r.length;for(let e=0;e<a;++e)r[e]===s[e]&&(s[e]+=1);return n}toJSON(){return gJ}}g0.prototype.annotationType=eW.AXIS_ALIGNED_BOUNDING_BOX;class g1 extends gQ{getBaseSegment=!1;get description(){return"annotate line"}initialRelationships;getInitialAnnotation(e,t){let i=super.getInitialAnnotation(e,t);return this.initialRelationships=i.relatedSegments=gj(t,this.getBaseSegment),i}getUpdatedAnnotation(e,t,i){let n=super.getUpdatedAnnotation(e,t,i),r=this.initialRelationships,s=gj(i,this.getBaseSegment);return void 0===r?n.relatedSegments=s:n.relatedSegments=Array.from(s,(e,t)=>{let i=r[t];return e=e.filter(e=>-1===i.findIndex(t=>eC.E.equal(e,t))),[...i,...e]}),n}toJSON(){return gH}}g1.prototype.annotationType=eW.LINE;class g2 extends gX{getInitialAnnotation(e,t){let i=gY(e,t);return{type:eW.ELLIPSOID,id:"",description:"",segments:gj(t),center:i,radii:Q.R3.fromValues(0,0,0),properties:t.source.properties.value.map(e=>e.default)}}getUpdatedAnnotation(e,t,i){let n=gY(t,i);if(void 0===n)return e;let r=e.center,s=r.length;for(let e=0;e<s;++e)n[e]=Math.abs(r[e]-n[e]);return{...e,radii:n}}get description(){return"annotate ellipsoid"}toJSON(){return gK}}aP(gq,(e,t)=>new gZ(e,t)),aP(gJ,(e,t)=>new g0(e,t)),aP(gH,(e,t)=>new g1(e,t)),aP(gK,(e,t)=>new g2(e,t));let g3=sh.fromObject({enter:{action:"commit"},escape:{action:"cancel"}}),g4="annotationColor";function g6(e){class t extends e{annotationStates=this.registerDisposer(new g_);annotationDisplayState=new oz;annotationCrossSectionRenderScaleHistogram=new lD;annotationCrossSectionRenderScaleTarget=lk(8);annotationProjectionRenderScaleHistogram=new lD;annotationProjectionRenderScaleTarget=lk(8);constructor(...e){let t;super(...e),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new gz(this)});let i=()=>{let e=this.isReady;e&&void 0!==t?(t(),t=void 0):!e&&void 0===t&&(t=this.annotationStates.markLoading())};this.readyStateChanged.add(i),i();let{mouseState:n}=this.manager.layerSelectedValues;this.registerDisposer(n.changed.add(()=>{if(n.active){let{pickedAnnotationLayer:e}=n;if(void 0!==e&&this.annotationStates.states.includes(e)){let t=this.annotationDisplayState.hoverState.value;(void 0===t||t.id!==n.pickedAnnotationId||t.partIndex!==n.pickedOffset||t.annotationLayerState!==e)&&(this.annotationDisplayState.hoverState.value={id:n.pickedAnnotationId,partIndex:n.pickedOffset,annotationLayerState:e});return}}this.annotationDisplayState.hoverState.value=void 0})),this.registerDisposer(this.registerLayerEvent("select-previous",()=>{this.changeSelectedIndex(-1)})),this.registerDisposer(this.registerLayerEvent("select-next",()=>{this.changeSelectedIndex(1)}))}initializeAnnotationLayerViewTab(e){}restoreState(e){super.restoreState(e),this.annotationDisplayState.color.restoreState(e[g4])}captureSelectionState(e,t){super.captureSelectionState(e,t);let i=t.pickedAnnotationLayer;if(void 0!==i&&!!this.annotationStates.states.includes(i))e.annotationId=t.pickedAnnotationId,e.annotationType=t.pickedAnnotationType,e.annotationBuffer=new Uint8Array(t.pickedAnnotationBuffer,t.pickedAnnotationBufferBaseOffset),e.annotationIndex=t.pickedAnnotationIndex,e.annotationCount=t.pickedAnnotationCount,e.annotationPartIndex=t.pickedOffset,e.annotationSourceIndex=i.sourceIndex,e.annotationSubsource=i.subsourceId}displayAnnotationState(e,t,i){if(void 0===e.annotationId)return!1;let n=this.annotationStates.states.find(t=>t.sourceIndex===e.annotationSourceIndex&&t.subsubsourceId===e.annotationSubsubsourceId&&(void 0===e.annotationSubsource||t.subsourceId===e.annotationSubsource));if(void 0===n)return!1;let r=i.registerDisposer(n.source.getReference(e.annotationId));return t.appendChild(i.registerDisposer(new aY(i.registerDisposer(new Z.ny(()=>({annotation:r,chunkTransform:n.chunkTransform}))),({annotation:t,chunkTransform:i},s,a)=>{let o;if(null==t){if(void 0!==e.annotationType&&void 0!==e.annotationBuffer){let i=e9[e.annotationType],r=n.source.rank,s=i.serializedBytes(r),a=e.annotationBuffer.byteOffset,l=new DataView(e.annotationBuffer.buffer),d=ev.LITTLE===ey,{properties:u}=n.source,c=new eY(r,s,u.value),h=e.annotationIndex,p=e.annotationCount;t=i.deserialize(l,a+c.propertyGroupBytes[0]*h,d,r,e.annotationId),c.deserialize(l,a,h,p,d,t.properties=Array(u.value.length)),n.source.hasNonSerializedProperties()&&(o="Loading...")}else o=null===t?"Annotation not found":"Loading..."}if(null!=t){let e=void 0===i.error?i.layerRank:0,o=document.createElement("div");o.classList.add("neuroglancer-selected-annotation-details-position-grid"),o.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${e}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,s.appendChild(o);let l=e9[t.type],d=document.createElement("div");if(d.className="neuroglancer-selected-annotation-details-icon",d.textContent=l.icon,o.appendChild(d),0!==e){let{layerDimensionNames:n}=i.modelTransform;for(let t=0;t<e;++t){let e=document.createElement("div");e.classList.add("neuroglancer-selected-annotation-details-position-dim"),e.textContent=n[t],e.style.gridColumn=`dim ${t+1}`,o.appendChild(e)}gB(t,i,(t,n)=>{let r=aK({title:"Copy position",onClick:()=>{aG(t.map(e=>Math.floor(e)).join(", "))}});r.style.gridColumn="copy",o.appendChild(r);for(let i=0;i<e;++i){let e=document.createElement("div");e.classList.add("neuroglancer-selected-annotation-details-position-coord"),e.style.gridColumn=`coord ${i+1}`,e.textContent=Math.floor(t[i]).toString(),o.appendChild(e)}if(!n){let e=cH({title:"Move to position",onClick:()=>{gF(this,i,t)}});e.style.gridColumn="move",o.appendChild(e)}})}if(!n.source.readonly){let e=gA({title:"Delete annotation",onClick:()=>{n.source.delete(r)}});e.classList.add("neuroglancer-selected-annotation-details-delete"),o.appendChild(e)}let{relationships:u,properties:{value:c}}=n.source,h=n.source.readonly,p=document.createElement("label");p.classList.add("neuroglancer-annotation-property");let g=document.createElement("span");g.classList.add("neuroglancer-annotation-property-label"),g.textContent="ID",p.appendChild(g);let m=document.createElement("span");m.classList.add("neuroglancer-annotation-property-value"),m.textContent=r.id,p.appendChild(m),s.appendChild(p);let f=[];for(let e=0,i=c.length;e<i;++e){let i=c[e],n=t.properties[e];if(eJ(i)&&i.tag){0!==n&&f.push(i.tag);continue}let r=document.createElement("label");r.classList.add("neuroglancer-annotation-property");let a=document.createElement("span");a.classList.add("neuroglancer-annotation-property-label"),a.textContent=i.identifier,r.appendChild(a);let{description:o}=i;void 0!==o&&(r.title=o);let l=document.createElement("span");switch(l.classList.add("neuroglancer-annotation-property-value"),i.type){case"rgb":{let e=er(n),t=ea(e);l.textContent=t,l.style.backgroundColor=t,l.style.color=el(e)?"white":"black";break}case"rgba":{let e=er(n);l.textContent=ea(es(n)),l.style.backgroundColor=ea(er(n)),l.style.color=el(e)?"white":"black";break}default:l.textContent=eQ(i,n)}r.appendChild(l),s.appendChild(r)}if(f.length){let e=document.createElement("label");e.classList.add("neuroglancer-annotation-property");let t=document.createElement("span");t.classList.add("neuroglancer-annotation-property-label"),t.textContent="tags",e.appendChild(t);let i=document.createElement("span");i.classList.add("neuroglancer-annotation-property-value"),i.textContent=f.map(e=>`#${e}`).join(" "),e.appendChild(i),s.appendChild(e)}let{relatedSegments:v}=t;for(let e=0,t=u.length;e<t;++e){let t=void 0===v?[]:v[e];if(0===t.length&&h)continue;let i=e,o=u[e];s.appendChild(a.registerDisposer(function(e,t,i,n){return new aY(i,(i,r,s)=>{let a;let o=document.createElement("div");o.classList.add("neuroglancer-related-segment-list"),null!=i&&s.registerDisposer(c8(i,o));let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list-header");let d=aK({title:"Copy segment IDs",onClick:()=>{aG(t.map(e=>e.toString()).join(", "))}});if(l.appendChild(d),null!=i&&((a=document.createElement("input")).type="checkbox",a.addEventListener("change",()=>{let{visibleSegments:e}=i.segmentationGroupState.value,n=t.some(t=>!e.has(t));for(let i of t)e.set(i,n)}),l.appendChild(a)),void 0!==n){let e=gA({title:"Remove all IDs",onClick:()=>{n([])}});l.appendChild(e)}let u=document.createElement("span");if(u.classList.add("neuroglancer-related-segment-list-title"),u.textContent=e,l.appendChild(u),void 0!==n){let e=gI({title:"Add related segment ID",onClick:()=>{let e=new ef.gj,r=s.registerDisposer((0,ef.oq)(e)),a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry"),a.classList.add("neuroglancer-segment-list-entry-new");let l=aK({});if(l.classList.add("neuroglancer-segment-list-entry-copy"),a.appendChild(l),null!=i){let e=document.createElement("input");e.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.type="checkbox",a.appendChild(e)}let d=gA({title:"Cancel adding new segment ID",onClick:()=>{r()}});d.classList.add("neuroglancer-segment-list-entry-delete"),a.appendChild(d);let u=document.createElement("input");u.autocomplete="off",u.spellcheck=!1,u.classList.add("neuroglancer-segment-list-entry-id"),e.registerDisposer(new aq(u,g3)).allShortcutsAreGlobal=!0;let c=()=>{let e=new eC.E;if(e.tryParseString(u.value))return u.dataset.valid="true",e;u.dataset.valid="false"};c(),u.addEventListener("input",()=>{c()}),u.addEventListener("blur",()=>{let e=c();void 0!==e&&n([...t,e]),r()}),sv(u,"cancel",r),sv(u,"commit",()=>{let e=c();void 0!==e&&n([...t,e]),r()}),a.appendChild(u),o.appendChild(a),u.focus(),e.registerDisposer(()=>{u.value="",a.remove()})}});l.appendChild(e)}o.appendChild(l);let c=[],h=ht.make(i??void 0,!1);for(let e of t){let i=h.get(e);if(c.push(i),void 0!==n){let r=gA({title:"Remove ID",onClick:i=>{n(t.filter(t=>!eC.E.equal(t,e))),i.stopPropagation()}});r.classList.add("neuroglancer-segment-list-entry-delete"),i.children[0].appendChild(r)}o.appendChild(i)}if(null!=i){let e=s.registerCancellable((0,iS.H)(()=>{let{visibleSegments:e}=i.segmentationGroupState.value,n=0;for(let i of t)e.has(i)&&++n;for(let e of c)h.update(e);a.checked=n===t.length&&n>0,a.indeterminate=n>0&&n<t.length}));e(),e.flush(),ha(i,s,e),s.registerDisposer(i.segmentationGroupState.changed.add(e))}r.appendChild(o)})}(o,t,n.displayState.relationshipStates.get(o).segmentationState,h?void 0:e=>{let t=r.value;if(null==t)return;let{relatedSegments:s}=t;(s=void 0===s?n.source.relationships.map(()=>[]):s.slice())[i]=e;let a={...t,relatedSegments:s};n.source.update(r,a),n.source.commit(r)})).element)}if(!n.source.readonly||t.description){if(n.source.readonly){let e=document.createElement("div");e.className="neuroglancer-annotation-details-description",e.textContent=t.description||"",s.appendChild(e)}else{let e=document.createElement("textarea");e.value=t.description||"",e.rows=3,e.className="neuroglancer-annotation-details-description",e.placeholder="Description",e.addEventListener("change",()=>{let i=e.value;n.source.update(r,{...t,description:i||void 0}),n.source.commit(r)}),s.appendChild(e)}}}if(void 0!==o){let e=document.createElement("div");e.classList.add("neuroglancer-selection-annotation-status"),e.textContent=o,s.appendChild(e)}})).element),!0}displaySelectionState(e,t,i){let n=this.displayAnnotationState(e,t,i);return super.displaySelectionState(e,t,i)&&(n=!0),n}addLocalAnnotations(e,t,i){let{subsourceEntry:n}=e,r=new oj({localPosition:this.localPosition,transform:e.getRenderLayerTransform(),source:t,displayState:this.annotationDisplayState,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:n.id,role:i});this.addAnnotationLayerState(r,e)}addStaticAnnotations(e){let{subsourceEntry:t}=e,{staticAnnotations:i}=t.subsource;return void 0!==i&&(e.activate(()=>{this.addLocalAnnotations(e,i,i8.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(e,t){let i=t.activated;i.registerDisposer(this.annotationStates.add(e));let n=new gy(this.manager.chunkManager,e.addRef());if(n.source instanceof lQ){let e=new gD({annotationLayer:n.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});i.registerDisposer(t.messages.addChild(e.messages));let r=new gk({annotationLayer:n.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});i.registerDisposer(t.messages.addChild(r.messages)),i.registerDisposer((0,Z.Uw)((t,i)=>{i&&(t.registerDisposer(this.addRenderLayer(e.addRef())),t.registerDisposer(this.addRenderLayer(r.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let e=new gP(n,this.annotationCrossSectionRenderScaleHistogram);i.registerDisposer(this.addRenderLayer(e)),i.registerDisposer(t.messages.addChild(e.messages))}{let e=new gE(n.addRef(),this.annotationProjectionRenderScaleHistogram);i.registerDisposer(this.addRenderLayer(e)),i.registerDisposer(t.messages.addChild(e.messages))}}selectAnnotation(e,t,i){this.manager.root.selectionState.captureSingleLayerState(this,i=>(i.annotationId=t,i.annotationSourceIndex=e.sourceIndex,i.annotationSubsource=e.subsourceId,i.annotationSubsubsourceId=e.subsubsourceId,!0),i)}changeSelectedIndex=e=>{let t=this.manager.root.selectionState.value;if(void 0===t)return;let i=t.layers.find(e=>e.layer===this)?.state;if(void 0===i)return;let{annotationId:n}=i;if(void 0===n)return;let r=this.annotationStates.states.find(e=>e.sourceIndex===i.annotationSourceIndex&&(void 0===i.annotationSubsource||e.subsourceId===i.annotationSubsource));if(void 0===r)return;let s=this.annotationStates.states.indexOf(r),{source:a}=r,o=Array.from(a),l=o.findIndex(e=>e.id===n);for(;;){if(-1===(l+=e))s-=1;else if(l===o.length)s+=1;else{let e=o[l];this.selectAnnotation(r,e.id,!0),gU(this,e,r);return}if(void 0===(r=this.annotationStates.states[s]))return;o=Array.from(a=r.source),l=-1===l?o.length:0}};toJSON(){let e=super.toJSON();return e[g4]=this.annotationDisplayState.color.toJSON(),e}}return t}function g5(e,t,i,n,r,s){let a;let o=i.chunkTransform.value,l=document.createElement("div");l.classList.add("neuroglancer-annotation-list-entry"),l.dataset.color=i.displayState.color.toString(),l.style.gridTemplateColumns=n;let d=document.createElement("div");d.className="neuroglancer-annotation-icon",d.textContent=e9[t.type].icon,l.appendChild(d);let u=()=>{if(!i.source.readonly)void 0===a&&((a=gA({title:"Delete annotation",onClick:e=>{e.stopPropagation(),e.preventDefault();let n=i.source.getReference(t.id);try{i.source.delete(n)}finally{n.dispose()}}})).classList.add("neuroglancer-annotation-list-entry-delete"),l.appendChild(a))},c=[],h=0;if(gB(t,o,(e,t)=>{++h;let i=document.createElement("div");i.className="neuroglancer-annotation-position",l.appendChild(i);let n=0,a=(t,r)=>{for(let s of t){let t=r[s];if(-1!==t){let r=Math.floor(e[t]),s=document.createElement("div"),a=r.toString();s.textContent=a,s.classList.add("neuroglancer-annotation-coordinate"),s.style.gridColumn=`dim ${n+1}`,c[n]=Math.max(c[n]||0,a.length),i.appendChild(s)}++n}};a(r,o.modelTransform.globalToRenderLayerDimensions),a(s,o.modelTransform.localToRenderLayerDimensions),u()}),t.description){++h;let e=document.createElement("div");e.classList.add("neuroglancer-annotation-description"),e.textContent=t.description,l.appendChild(e)}let{properties:{value:p}}=i.source,g=[];for(let e=0,i=p.length;e<i;++e){let i=p[e],n=t.properties[e];eJ(i)&&i.tag&&0!==n&&g.push(i.tag)}if(g.length){let e=document.createElement("div");e.classList.add("neuroglancer-annotation-tags"),e.textContent=g.map(e=>`#${e}`).join(" "),l.appendChild(e)}return d.style.gridRow=`span ${h}`,void 0!==a&&(a.style.gridRow=`span ${h}`),l.addEventListener("mouseenter",()=>{e.selectAnnotation(i,t.id,!1)}),l.addEventListener("action:select-position",n=>{n.stopPropagation(),e.selectAnnotation(i,t.id,"toggle")}),l.addEventListener("action:pin-annotation",n=>{n.stopPropagation(),e.selectAnnotation(i,t.id,!0)}),l.addEventListener("action:move-to-annotation",n=>{n.stopPropagation(),n.preventDefault(),gU(e,t,i)}),[l,c]}i("6921");let g8="selectSegments",g7="mousedown0",g9=sh.fromObject({[`at:alt?+shift?+${g7}`]:"drag-select-segments"});class me extends ax{toJSON(){return g8}activate(e){let{layer:t}=this,{body:i,header:n}=aB(e),r=0,s=!1;e.bindInputEventMap(g9);let a=()=>az.value&so.ALT?2:1,o=e=>{r!==e&&(r=e,s=!1,l())},l=()=>{sI(i);let e=document.createElement("span");switch(r){case 0:n.textContent="Select/Deselect segments",e.textContent=`${g7} to select segments; alt+${g7} to deselect segments.`;break;case 1:case 2:n.textContent=`${1===r?"Select":"Deselect"} segments`,e.textContent=`Drag to ${1===r?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}i.appendChild(e)};l();let d=()=>{if(0===r)return;let{segmentSelectionState:e}=t.displayState;if(e.hasSelectedSegment){let i=e.selectedSegment,{selectedSegments:n,visibleSegments:s}=t.displayState.segmentationGroupState.value;switch(r){case 1:n.add(i),s.add(i);break;case 2:n.delete(i)}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{s&&d()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(l)),e.registerDisposer(az.changed.add(()=>{0!==r&&o(a())}));let u=(e,t)=>{e.stopPropagation(),o(t),d();let i=e.detail.screenX,n=e.detail.screenY;sb(e.detail,(e,t,r)=>{if(!s){let t=e.screenX-i,r=e.screenY-n;t*t+r*r>25&&(d(),s=!0)}},e=>{s=!1,o(0)})};e.bindAction("drag-select-segments",e=>u(e,a()))}get description(){return"select"}}i("4504");let mt="mergeSegments",mi="splitSegments",mn=sh.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),mr=sh.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class ms extends ax{lastAnchorBaseSegment=new Z.SN(void 0);constructor(e){super(e);let t=()=>{let t=e.anchorSegment.value;if(void 0===t)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:n}=e.displayState.segmentationGroupState.value,r=n.get(t);if(!eC.E.equal(i.selectedSegment,r))return;let s=i.baseSelectedSegment,a=(0,lS.Lr)(s),o=n.disjointSets.visibleSegmentEquivalencePolicy.value;if((!(o&lS.BA.NONREPRESENTATIVE_EXCLUDED)||!a)&&(!(o&lS.BA.REPRESENTATIVE_EXCLUDED)||!!a))this.lastAnchorBaseSegment.value=s.clone()};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return mt}activate(e){let t=this.layer.displayState.segmentationGroupState.value,i=()=>{let e=this.layer.anchorSegment.value,i=this.lastAnchorBaseSegment.value;if(void 0===e)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let n=t.segmentEquivalences.get(e);return t.visibleSegments.has(n)?void 0!==i&&eC.E.equal(t.segmentEquivalences.get(i),n)?{anchorSegment:i,error:void 0}:{anchorSegment:e,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:e,error:"Anchor segment must be in visible set"}},n=()=>{let{anchorSegment:e,error:n}=i();if(void 0===e||void 0!==n)return{anchorSegment:e,error:n,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:r}=this.layer,s=r.segmentSelectionState.baseValue;return void 0===s||eC.E.equal(r.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(e))?{anchorSegment:e,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:e,otherSegment:s,error:void 0,anchorSegmentValid:!0}},{body:r,header:s}=aB(e);s.textContent="Merge segments",r.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(mn),e.registerDisposer(()=>{c3(t)});let a=()=>{sI(r);let{displayState:e}=this.layer,{anchorSegment:i,otherSegment:s,anchorSegmentValid:a,error:o}=n(),l=e=>{let t=hs(this.layer.displayState,e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t};if(void 0!==i&&r.appendChild(l(c6(e,i))),void 0!==o){let e=document.createElement("span");e.textContent=o,r.appendChild(e)}if(void 0!==s){let t=document.createElement("span");t.textContent=" merge ",r.appendChild(t),r.appendChild(l(c6(e,s)))}let{segmentEquivalences:d}=t;if(!a){c3(t);return}t.useTemporaryVisibleSegments.value=!0;let u=t.temporaryVisibleSegments;u.clear(),u.add(d.get(i)),void 0!==s&&u.add(d.get(s))};a(),e.registerDisposer(c8(this.layer.displayState,r));let o=e.registerCancellable((0,iS.H)(a));ha(this.layer.displayState,e,o),e.registerDisposer(this.layer.anchorSegment.changed.add(o)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(o)),e.bindAction("merge-segments",e=>{e.stopPropagation(),(async()=>{let{graph:{value:e}}=t;if(void 0===e)return;let{anchorSegment:i,otherSegment:r,error:s}=n();if(void 0!==i&&void 0!==r&&void 0===s)try{await e.merge(i,r),ai.showTemporaryMessage("Merge performed")}catch(e){ai.showTemporaryMessage(`Merge failed: ${e}`)}})()}),e.bindAction("set-anchor",e=>{e.stopPropagation();let{segmentSelectionState:i}=this.layer.displayState,n=i.baseValue;if(void 0===n)return;let r=this.layer.anchorSegment.value;if(t.visibleSegments.add(n),void 0===r||!eC.E.equal(r,n)){this.layer.anchorSegment.value=n.clone();return}})}get description(){return"merge"}}class ma extends ax{toJSON(){return mi}activate(e){let t=this.layer.displayState.segmentationGroupState.value,i=()=>{let e=this.layer.anchorSegment.value;if(void 0===e)return{anchorSegment:void 0,error:"Select anchor segment for split"};let i=t.segmentEquivalences.get(e);return t.visibleSegments.has(i)?{anchorSegment:e,error:void 0}:{anchorSegment:e,error:"Anchor segment must be in visible set"}},{body:n,header:r}=aB(e);r.textContent="Split segments",n.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(mr);let s=()=>{let{anchorSegment:e,error:n}=i();if(void 0===e||void 0!==n)return{anchorSegment:e,error:n,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:r}=this.layer,s=r.segmentSelectionState.baseValue;return void 0===s||!eC.E.equal(r.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(e))||eC.E.equal(s,e)?{anchorSegment:e,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:e,otherSegment:s,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{c3(t)});let a=()=>{let e,i;sI(n);let{displayState:r}=this.layer,{anchorSegment:a,otherSegment:o,anchorSegmentValid:l,error:d}=s();(()=>{let{segmentEquivalences:n}=t,{graphConnection:{value:r}}=this.layer;if(!l||void 0===r){c3(t);return}if(t.useTemporaryVisibleSegments.value=!0,void 0!==o){let n=r.computeSplit(a,o);if(void 0!==n){e=new c1(a,n.includeRepresentative),i=new c1(o,n.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let r=n.includeRepresentative,s=n.excludeRepresentative,l=t.temporarySegmentEquivalences;for(let e of(l.clear(),n.includeBaseSegments))l.link(e,r);for(let e of n.excludeBaseSegments)l.link(e,s);let d=t.temporaryVisibleSegments;d.clear(),d.add(r),d.add(s);return}}t.useTemporarySegmentEquivalences.value=!1;let s=t.temporaryVisibleSegments;s.clear(),s.add(n.get(a))})();let u=e=>{let t=hs(this.layer.displayState,e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t};if(void 0!==a&&n.appendChild(u(e??c6(r,a))),void 0!==d){let e=document.createElement("span");e.textContent=d,n.appendChild(e)}if(void 0!==i){let e=document.createElement("span");e.textContent=" split ",n.appendChild(e),n.appendChild(u(i))}};e.registerDisposer(c8(this.layer.displayState,n)),a();let o=e.registerCancellable((0,iS.H)(a));ha(this.layer.displayState,e,o),e.registerDisposer(this.layer.anchorSegment.changed.add(o));let l=async e=>{let{graph:{value:i}}=t;if(void 0===i)return;let{anchorSegment:n,otherSegment:r,error:a}=s();if(void 0!==n&&void 0!==r&&void 0===a)try{await i.split(n,r),e&&t.visibleSegments.add(t.segmentEquivalences.get(r)),ai.showTemporaryMessage("Split performed")}catch(e){ai.showTemporaryMessage(`Split failed: ${e}`)}};e.bindAction("split-segments",e=>{e.stopPropagation(),l(!1)}),e.bindAction("split-and-select-segments",e=>{e.stopPropagation(),l(!0)}),e.bindAction("set-anchor",e=>{e.stopPropagation();let{segmentSelectionState:i}=this.layer.displayState,n=i.baseValue;if(void 0===n)return;t.visibleSegments.add(n);let r=this.layer.anchorSegment.value;if(void 0===r||!eC.E.equal(r,n)){this.layer.anchorSegment.value=n.clone();return}})}get description(){return"split"}}let mo=new eC.E;class ml extends ef.gj{segmentationDisplayState;parentElement;length;changed;explicitSegments;debouncedUpdate;constructor(e,t){super(),this.segmentationDisplayState=e,this.parentElement=t,this.changed=new ez.MZ,this.debouncedUpdate=(0,ic.Z)(()=>this.update(),0)}updateRendering(e){this.segmentWidgetFactory.update(e)}segmentWidgetFactory;updateRenderedItems(e){e.forEachRenderedItem(e=>{this.updateRendering(e)})}}class md extends ml{segmentationDisplayState;parentElement;constructor(e,t){super(e,t),this.segmentationDisplayState=e,this.parentElement=t,this.render=e=>{let{explicitSegments:t}=this,i=t[e];return this.segmentWidgetFactory.get(i)},this.update(),this.registerDisposer(e.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate))}update(){let e=[],{selectedSegments:t}=this.segmentationDisplayState.segmentationGroupState.value,i=[...t],{explicitSegments:n}=this;void 0===n?e.push({retainCount:0,insertCount:i.length,deleteCount:0}):e.push(...(0,Y.wG)(n,i,eC.E.equal)),this.explicitSegments=i,this.length=i.length,this.changed.dispatch(e)}render}class mu extends ml{query;segmentPropertyMap;segmentationDisplayState;parentElement;prevQuery;queryResult;prevQueryResult;statusText;selectedMatches;visibleMatches;matchStatusTextPrefix;selectedSegmentsGeneration;visibleSegmentsGeneration;get numMatches(){return this.queryResult.value?.count??0}update(){var e;let t;let i=this.query.value,{segmentPropertyMap:n}=this;this.prevQueryResult.value=this.queryResult.value;let r=this.prevQueryResult.value;if(this.prevQuery===i)t=r;else{let e=function(e,t){let i;if(null!==t.match(hj)){let e=t.split(/[\s,]+/),i=[],n=new Set;for(let t=0,r=e.length;t<r;++t){let r=e[t];if(""===r)continue;let s=new eC.E;if(!s.tryParseString(r))continue;let a=s.toString();!n.has(a)&&(n.add(a),i.push(s))}return i.sort(eC.E.compare),{ids:i}}let n={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=e?.segmentPropertyMap.inlineProperties?.properties,s=e?.tags,a=s?.tags||[],o=a.map(e=>e.toLowerCase()),l=e?.labels,d=[];for(let s=0;s<t.length;s=i){let u=t.indexOf(" ",s);i=-1===u?u=t.length:u+1;let c=t.substring(s,u);if(0===c.length)continue;let h=(e,t)=>{let i=e.toLowerCase(),r=o.indexOf(i);if(-1===r){d.push({begin:t,end:u,message:`Invalid tag: ${e}`});return}if(e=a[r],n.includeTags.includes(e)||n.excludeTags.includes(e)){d.push({begin:t,end:u,message:`Duplicate tag: ${e}`});return}return e};if(c.startsWith("#")){let e=h(c.substring(1),s+1);void 0!==e&&n.includeTags.push(e);continue}if(c.startsWith("-#")){let e=h(c.substring(2),s+2);void 0!==e&&n.excludeTags.push(e);continue}if(c.startsWith("<")||c.startsWith(">")){let e=c.substring(1).toLowerCase();if("id"!==e&&"label"!==e){let t=r?.find(t=>t.id.toLowerCase()===e&&("number"===t.type||"label"===t.type||"string"===t.type));if(void 0===t){d.push({begin:s+1,end:u,message:`Invalid field: ${e}`});continue}e=t.id}if(void 0!==n.sortBy.find(t=>t.fieldId===e)){d.push({begin:s+1,end:u,message:`Duplicate sort field: ${e}`});continue}n.sortBy.push({order:c[0],fieldId:e});continue}if(c.startsWith("|")){let e=c.substring(1).toLowerCase();if("id"===e||"label"===e)continue;let t=r?.find(t=>t.id.toLowerCase()===e&&("number"===t.type||"string"===t.type));if(void 0===t){d.push({begin:s+1,end:u,message:`Invalid field: ${e}`});continue}if(e=t.id,n.sortBy.find(t=>t.fieldId===e)||n.includeColumns.find(t=>t===e))continue;n.includeColumns.push(e);continue}if(c.startsWith("/")){if(void 0!==n.regexp){d.push({begin:s,end:u,message:"Only one regular expression allowed"});continue}if(void 0!==n.prefix){d.push({begin:s,end:u,message:"Prefix cannot be combined with regular expression"});continue}if(void 0===l&&0==a.length){d.push({begin:s,end:u,message:"No label property"});continue}try{n.regexp=new RegExp(c.substring(1))}catch{d.push({begin:s,end:u,message:"Invalid regular expression syntax"})}continue}let p=c.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)(-?[0-9.].*)$/);if(null!==p){let t,i=p[1].toLowerCase(),r=p[2],a=e?.numericalProperties.find(e=>e.id.toLowerCase()===i);if(void 0===a){d.push({begin:s,end:s+i.length,message:`Invalid numerical field: ${i}`});continue}i=a.id;try{t=eM(a.dataType,p[3])}catch(e){d.push({begin:s+p[1].length+p[2].length,end:u,message:e.message});continue}let o=n.numericalConstraints.find(e=>e.fieldId===i);void 0===o&&(o={fieldId:i,bounds:a.bounds},n.numericalConstraints.push(o));let l=ek(a.bounds,o.bounds[0]),c=ek(a.bounds,o.bounds[1]),h=c,g=l;switch(r){case"<":h=eF(a.dataType,t,-1);break;case"<=":h=t;break;case"=":h=g=t;break;case">=":g=t;break;case">":g=eF(a.dataType,t,1)}if(g=eI(l,g)>0?l:g,h=0>eI(c,h)?c:h,eI(g,h)>0){d.push({begin:s,end:u,message:"Constraint would not match any values"});continue}o.bounds=[g,h];continue}if(void 0!==n.regexp){d.push({begin:s,end:u,message:"Prefix cannot be combined with regular expression"});continue}if(void 0===l&&0==a.length){d.push({begin:s,end:u,message:"No label property"});continue}void 0!==n.prefix?n.prefix+=` ${c}`:n.prefix=c}return d.length>0?{errors:d}:(0===n.sortBy.length&&n.sortBy.push({fieldId:hq(e),order:"<"}),n)}(n,i);t=function(e,t){let i,n;if(void 0!==t.errors)return{query:t,total:-1,count:0,errors:t.errors};if(void 0!==t.ids){let{ids:e}=t;return{query:t,total:-1,explicitIds:e,count:e.length}}let r=e?.segmentPropertyMap?.inlineProperties;if(void 0===r)return{query:t,count:0,total:-1};let s=r?.properties,a=r.ids.length/2,o=e?.tags?.tags?.length||0,l=hB(a,a),d=hB(o,o);d.fill(1);for(let e=0;e<a;++e)l[e]=e;let u=e=>{let t=l.length,i=0;for(let n=0;n<t;++n){let t=l[n];e(t)&&(l[i]=t,++i)}l=l.subarray(0,i)};if(void 0!==t.regexp||void 0!==t.prefix){let{regexp:i,prefix:n}=t;if(void 0!==e.labels){let t=e.labels.values;void 0!==i&&u(e=>null!==t[e].match(i)),void 0!==n&&u(e=>t[e].startsWith(n))}if(0==l.length&&void 0!==i||void 0==e.labels&&void 0!=i){l=hB(a,a);for(let e=0;e<a;++e)l[e]=e;(t=>{let i=e.tags.tagDescriptions,n=e.tags.tags;d.fill(0);for(let e=0;e<i.length;e++)null!==i[e].match(t)&&(d[e]=1),null!==n[e].match(t)&&(d[e]=1)})(i),t.regexp=void 0}}let{includeTags:c,excludeTags:h}=t,p=e.tags;if(c.length>0||h.length>0){let{values:e,tags:t}=p,i=[];for(let e of c)i.push([t.indexOf(e),1]);for(let e of h)i.push([t.indexOf(e),0]);i.sort((e,t)=>e[0]-t[0]);let n="^",r=0,s=e=>{!(e<r)&&(n+=`[${hW(r)}-${hW(e)}]*`)};for(let[e,t]of i)s(e-1),t&&(n+=hW(e)),r=e+1;s(65535);let a=new RegExp(n+="$");u(t=>null!==e[t].match(a))}let{numericalConstraints:g}=t;if(g.length>0){let t=e.numericalProperties,r=g.length,s=2**r-1;i=hB(l.length,s);for(let e=0;e<r;++e){let n=g[e],{values:r}=t.find(e=>e.id===n.fieldId),s=2**e,[a,o]=n.bounds;for(let e=0,t=l.length;e<t;++e){let t=r[l[e]];i[e]|=s*(t>=a&&t<=o)}}let a=(l=(n=l).slice()).length,o=0;for(let e=0;e<a;++e)i[e]===s&&(l[o]=l[e],++o);l=l.subarray(0,o)}let m=[];if(void 0!==p){let e=[],{tags:i,values:n,tagDescriptions:r}=p,s=new Uint32Array(i.length);for(let e=0,t=l.length;e<t;++e){let t=n[l[e]];for(let e=0,i=t.length;e<i;++e)++s[t.charCodeAt(e)]}for(let n=0,a=i.length;n<a;++n){if(0===d[n])continue;let a=s[n],o=i[n],l=r[n],u={tag:o,tagIndex:n,count:s[n],desc:l};t.includeTags.includes(o)||t.excludeTags.includes(o)?e.push(u):a>0&&m.push(u)}e.push(...m),m=e}let f=(e,t)=>{if("number"!==e.type){let{values:i}=e;l.sort((e,n)=>(0,ac.B)(i[e],i[n])*t)}else{let i=e.values;l.sort((e,n)=>(i[e]-i[n])*t)}},v=t=>{void 0!==p&&f(p,t);let i=e?.labels;void 0!==i&&f(i,t)},{sortBy:y}=t;for(let e=y.length-1;e>=0;--e){let{fieldId:t,order:i}=y[e],n="<"===i?1:-1;if("id"===t){if(e+1===y.length){if("<"===i)continue;l.reverse();continue}l.sort((e,t)=>n*(e-t))}else"label"===t?v(n):f(s.find(e=>e.id===t),n)}return{query:t,intermediateIndices:n,intermediateIndicesMask:i,indices:l,tags:m,count:l.length,total:a}}(n,e)}let s=[],a=!1,o="";let l=void 0===(e=t.query).ids&&(void 0!==e.errors||!(e.numericalConstraints.length>0)&&!(e.includeTags.length>0)&&!(e.excludeTags.length>0)&&!e.prefix&&!e.regexp&&!0);!l&&void 0!==this.explicitSegments&&(s.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,a=!0);let{explicitIds:d}=t;void 0!==d?this.explicitSegments=d:this.explicitSegments=void 0,r!==t&&(s.push({retainCount:0,deleteCount:r?.count??0,insertCount:t.count}),a=!0,this.queryResult.value=t),void 0!==t.explicitIds?o=`${t.count} ids`:l?o=`${t.count} total ids`:t.total>0&&(o=`${t.count} match /${t.total} total ids`);let{selectedSegments:u,visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,h=u.changed.count,p=c.changed.count,g=this.selectedSegmentsGeneration,m=this.visibleSegmentsGeneration,f=r!==t;this.selectedSegmentsGeneration=h,this.visibleSegmentsGeneration=p,(g!==h||f)&&(this.selectedMatches=t.count>0?hJ(n,t,u):0),(m!==p||f)&&(this.visibleMatches=t.count>0?hJ(n,t,c):0);let v=o;this.selectedMatches>0&&(v=this.selectedMatches===this.visibleMatches?`${this.selectedMatches} vis/${v}`:this.visibleMatches>0?`${this.visibleMatches} vis/${this.selectedMatches} star/${v}`:`${this.selectedMatches} star/${v}`),this.statusText.value=v,this.prevQuery=i,this.matchStatusTextPrefix=o,this.length=t.count,a&&this.changed.dispatch(s)}constructor(e,t,i,n){super(i,n),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=i,this.parentElement=n,this.queryResult=new Z.SN(void 0),this.prevQueryResult=new Z.SN(void 0),this.statusText=new Z.SN(""),this.selectedMatches=0,this.visibleMatches=0,this.matchStatusTextPrefix="",this.selectedSegmentsGeneration=-1,this.visibleSegmentsGeneration=-1,this.render=e=>{let t;let{explicitSegments:i}=this;if(void 0!==i)t=i[e];else{t=mo;let i=this.queryResult.value.indices[e],{ids:n}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;t.low=n[2*i],t.high=n[2*i+1]}return this.segmentWidgetFactory.get(t)},this.update(),this.registerDisposer(i.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(i.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),e&&this.registerDisposer(e.changed.add(this.debouncedUpdate))}render}let mc=sh.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}});function mh(e){sA(e,Math.max(1,e.value.length+.1))}function mp(e,t){let i;if(Number.isInteger(t))i=t.toString();else{let e=t.toString(),n=t.toPrecision(6);i=e.length<n.length?e:n}e.value=i,mh(e)}function mg(e,t,i){let n=e?.query,r=n?.sortBy;if(void 0===r)return;let{includeColumns:s}=n,a=r.find(e=>e.fieldId===i)?.order,o=s.filter(e=>e!==i);for(let e of r)"id"!==e.fieldId&&"label"!==e.fieldId&&e.fieldId!==i&&o.push(e.fieldId);t({...n,sortBy:[{fieldId:i,order:"<"===a?">":"<"}],includeColumns:o})}function mm(e,t,i){let n=e?.query?.sortBy,r=n?.find(e=>e.fieldId===i)?.order;t.textContent=">"===r?"▼":"▲",t.style.visibility=void 0===r?"":"visible",t.title=`Sort by ${i} in ${"<"===r?"descending":"ascending"} order`}class mf extends ef.gj{segmentPropertyMap;queryResult;setQuery;listElement;properties;propertyHistograms;bounds;throttledUpdate;debouncedRender;debouncedSetQuery;constructor(e,t,i){let n;super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=i,this.propertyHistograms=[],this.bounds={window:new Z.SN([]),range:new Z.SN([])},this.throttledUpdate=this.registerCancellable((0,da.Z)(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable((0,iS.H)(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable((0,ic.Z)(()=>this.setQueryFromBounds(),200));let r=e?.numericalProperties,s=[];if(void 0!==r&&r.length>0){n=document.createElement("details");let e=document.createElement("summary");e.textContent=`${r.length} numerical propert${r.length>1?"ies":"y"}`,n.appendChild(e),n.classList.add("neuroglancer-segment-query-result-numerical-list");let t=this.bounds.window.value;for(let e=0,i=r.length;e<i;++e){let i=r[e],a=this.makeNumericalPropertySummary(e,i);s.push(a),n.appendChild(a.element),t[e]=i.bounds}}this.listElement=n,this.properties=s,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(void 0===e||void 0===e.indices)return;let t=e.query,i=[],n=this.bounds.range.value,{properties:r}=this;for(let e=0,t=r.length;e<t;++e){let t=r[e].property;i.push({fieldId:t.id,bounds:n[e]})}this.setQuery({...t,numericalConstraints:i})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:i}=this.properties[e],n=eD(i.bounds,t.range);eI(n[0],n[1])>0&&(n=[n[1],n[0]]);let r=eD(i.bounds,t.window),s=this.getBounds(e),{dataType:a}=this.properties[e].property;!eO(a,r,s.window)&&(this.bounds.window.value[e]=r,this.bounds.window.changed.dispatch()),!eO(a,n,s.range)&&(this.bounds.range.value[e]=n,this.bounds.range.changed.dispatch())}setBound(e,t,i,n){n=ek(this.segmentPropertyMap.numericalProperties[i].bounds,n);let r=sq(this.getBounds(i),e,t,n,!0);this.setBounds(i,r)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(void 0!==t){if(e?.indices!==void 0){let{numericalConstraints:t}=e.query,{numericalProperties:i}=this.segmentPropertyMap,n=this.bounds.range.value,r=t.length,s=i.length;n.length=s;for(let e=0;e<s;++e)n[e]=i[e].bounds;for(let e=0;e<r;++e){let r=t[e];n[i.findIndex(e=>e.id===r.fieldId)]=r.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;void 0!==t&&(!function(e,t,i,n){if(void 0===e){i.length=0,n.length=0;return}let{numericalProperties:r}=e,s=r.length;if(void 0===t?.indices){i.length=0;return}for(let e=0;e<s;++e){let s=i[e],a=n[e],o=r[e];if(!(void 0!==s&&s.queryResult===t&&eO(o.dataType,s.window,a)))i[e]=function(e,t,i){let{values:n}=t,[r,s]=i,a=s<=r?0:256/(s-r),o=new Uint32Array(258),{numericalConstraints:l}=e.query,d=l.findIndex(e=>e.fieldId===t.id);if(-1===d){let t=e.indices;for(let e=0,i=t.length;e<i;++e){let i=n[t[e]];!Number.isNaN(i)&&++o[Math.min(255,Math.max(-1,(i-r)*a))+1>>>0]}}else{let t=e.intermediateIndices,i=e.intermediateIndicesMask,s=2**l.length-1-2**d;for(let e=0,l=t.length;e<l;++e)if((i[e]&s)===s){let i=n[t[e]];!Number.isNaN(i)&&++o[Math.min(255,Math.max(-1,(i-r)*a))+1>>>0]}}return{queryResult:e,histogram:o,window:i}}(t,o,a)}}(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(void 0===e)return;let{propertyHistograms:t}=this;if(0===t.length){e.style.display="none";return}e.style.display="";let{properties:i}=this;for(let e=0,n=i.length;e<n;++e)this.updateNumericalPropertySummary(e,i[e],t[e])}makeNumericalPropertySummary(e,t){let i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let n=document.createElement("img");n.classList.add("neuroglancer-segment-query-result-numerical-plot");let r=new sj(n,t.dataType,()=>this.getBounds(e),t=>this.setBounds(e,t)),s=document.createElement("span");s.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let a=document.createElement("input");a.type="checkbox",a.addEventListener("click",()=>{!function(e,t,i){if(void 0===e||void 0===e.indices)return;let n=e.query,{sortBy:r,includeColumns:s}=n;hZ(n,i)?(r=r.filter(e=>e.fieldId!==i),s=s.filter(e=>e!==i)):s.push(i),t({...n,sortBy:r,includeColumns:s})}(this.queryResult.value,this.setQuery,t.id)});let o=i=>{let n;let r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),r.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${i}`);let o=n=>{let r=function(e,t){let i=document.createElement("input");return i.addEventListener("focus",()=>{i.select()}),i.classList.add(`neuroglancer-segment-query-result-numerical-plot-${e}-bound`),i.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),i.type="text",i.spellcheck=!1,i.autocomplete="off",i.title=(0===t?"Lower":"Upper")+" bound "+("range"===e?"range":"for distribution"),i.addEventListener("input",()=>{mh(i)}),i}(i,n);return r.addEventListener("change",()=>{if(void 0!==this.bounds[i].value[e]){try{let s=eM(t.dataType,r.value);this.setBound(i,n,e,s),this.bounds[i].changed.dispatch()}catch{}mp(r,this.bounds[i].value[e][n])}}),r},l=[o(0),o(1)];if("range"===i){(n=[document.createElement("div"),document.createElement("div"),document.createElement("div")])[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),n[1].appendChild(a);let e=document.createElement("span");e.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),e.appendChild(document.createTextNode(t.id)),e.appendChild(s),e.addEventListener("click",()=>{mg(this.queryResult.value,this.setQuery,t.id)}),n[1].appendChild(e);let{description:i}=t;i&&(n[1].title=i),r.appendChild(n[0]),r.appendChild(l[0]);let o=document.createElement("div");o.textContent="≤",o.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),r.appendChild(o),r.appendChild(n[1]);let d=document.createElement("div");d.textContent="≤",d.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),r.appendChild(d),r.appendChild(l[1]),r.appendChild(n[2])}else r.appendChild(l[0]),r.appendChild(l[1]);return{container:r,spacers:n,inputs:l}},l={range:o("range"),window:o("window")};return i.appendChild(l.range.container),i.appendChild(n),i.appendChild(l.window.container),{property:t,controller:r,element:i,plotImg:n,boundElements:l,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:a,sortIcon:s}}updateNumericalPropertySummary(e,t,i){let n=t.bounds.window,r=this.bounds.window.value[e],s=t.bounds.range,a=this.bounds.range.value[e],{property:o}=t,l=this.queryResult.value,d=hZ(l?.query,o.id);if(t.columnCheckbox.checked=d,t.columnCheckbox.title=d?"Remove column from result table":"Add column to result table",mm(l,t.sortIcon,o.id),t.propertyHistogram===i&&eO(o.dataType,n,r)&&eO(o.dataType,s,a))return;let{histogram:u}=i,c="http://www.w3.org/2000/svg",h=document.createElementNS(c,"svg");h.setAttribute("width","1"),h.setAttribute("height","1"),h.setAttribute("preserveAspectRatio","none");let p=document.createElementNS(c,"rect"),g=eE(r,a[0]),m=eE(r,a[1]);p.setAttribute("x",`${g}`),p.setAttribute("y","0"),p.setAttribute("width",`${m-g}`),p.setAttribute("height","1"),p.setAttribute("fill","#4f4f4f"),h.appendChild(p);let f=u.length,v=(e,t,n)=>{let s=document.createElementNS(c,"polyline"),a="",o=0;for(let t=e;t<n;++t)o+=u[t];if(0===o)return;let l=eE(r,i.window[0]),d=eE(r,i.window[1]),h=(e,t)=>{let i=e/(f-2);a+=` ${l*(1-i)+d*i},${1-t}`};0!==e&&h(e,0);let p=0;for(let i=e;i<t;++i)p+=u[i],h(i,p/o);return s.setAttribute("fill","none"),s.setAttribute("stroke-width","1px"),s.setAttribute("points",a),s.setAttribute("vector-effect","non-scaling-stroke"),s};{let e=v(0,f-1,f);void 0!==e&&(e.setAttribute("stroke","cyan"),h.appendChild(e))}if(!eO(o.dataType,o.bounds,a)){let e=Math.floor(Math.max(0,Math.min(1,eE(i.window,a[0])))*(f-2)),t=Math.ceil(Math.max(0,Math.min(1,eE(i.window,a[1])))*(f-2)),n=v(e,t,t);void 0!==n&&(n.setAttribute("stroke","white"),h.appendChild(n))}let y=new XMLSerializer().serializeToString(h);t.plotImg.src=`data:image/svg+xml;base64,${btoa(y)}`,t.propertyHistogram=i;for(let e=0;e<2;++e)n[e]=r[e],mp(t.boundElements.window.inputs[e],r[e]),s[e]=a[e],mp(t.boundElements.range.inputs[e],a[e]);let b=t.boundElements.range.spacers,S=eD(r,a),w=eB(o.dataType,r),C=eE(r,S[0])*w,x=eE(r,S[1])*w+(1-w);b[0].style.width=`${100*C}%`,b[2].style.width=`${(1-x)*100}%`}}class mv extends ef.gj{listSource;group;element;selectionStatusContainer;starAllButton;selectionStatusMessage;copyAllSegmentsButton;copyVisibleSegmentsButton;visibilityToggleAllButton;statusChanged;debouncedUpdateStatus;makeSegmentsVisible(e){let{visibleSegments:t}=this.group,i=Array.from(this.listSegments(!0));t.set(i,e)}invertVisibility(){let e=[],t=[],{visibleSegments:i}=this.group;for(let n of this.listSegments(!0))i.has(n)?t.push(n):e.push(n);i.set(e,!0),i.set(t,!1)}selectSegments(e,t=!1){let{selectedSegments:i,visibleSegments:n}=this.group,r=Array.from(this.listSegments(!0));(e||!t)&&i.set(r,e),t&&n.set(r,e)}copySegments(e=!1){let t=[...this.listSegments(!0)];e&&(t=t.filter(e=>this.group.visibleSegments.has(e))),t.sort(eC.E.compare),aG(t.join(", "))}constructor(e,t){super(),this.listSource=e,this.group=t,this.element=document.createElement("div"),this.selectionStatusContainer=document.createElement("span"),this.selectionStatusMessage=document.createElement("span"),this.statusChanged=new ez.K_,this.debouncedUpdateStatus=(0,ic.Z)(()=>this.updateStatus(),0);let{element:i}=this;i.style.display="contents",this.starAllButton=c0({title:"Click to toggle star status, shift+click to unstar non-visible segments.",onClick:e=>{let t=this.starAllButton.classList.contains("neuroglancer-starred");if(e.shiftKey){let e=[];for(let t of this.group.selectedSegments)!this.group.visibleSegments.has(t)&&e.push(t);this.group.selectedSegments.delete(e);return}this.selectSegments(!t,!1)}}),this.copyAllSegmentsButton=aK({title:"Copy all segment IDs",onClick:()=>{this.copySegments(!1)}}),this.copyVisibleSegmentsButton=aK({title:"Copy visible segment IDs",onClick:()=>{this.copySegments(!0)}}),this.visibilityToggleAllButton=cY({onClick:e=>{if(e.shiftKey){this.invertVisibility();return}this.makeSegmentsVisible(!this.visibilityToggleAllButton.classList.contains("neuroglancer-visible"))}});let{selectionStatusContainer:n}=this;this.selectionStatusMessage.classList.add("neuroglancer-segment-list-status-message"),n.classList.add("neuroglancer-segment-list-status"),n.appendChild(this.copyAllSegmentsButton),n.appendChild(this.starAllButton),n.appendChild(this.visibilityToggleAllButton),n.appendChild(this.copyVisibleSegmentsButton),n.appendChild(this.selectionStatusMessage),this.element.appendChild(n),this.registerDisposer(t.visibleSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(t.selectedSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(e.changed.add(this.debouncedUpdateStatus))}*listSegments(e=!1){}updateStatus(){let e;let{listSource:t,group:i,starAllButton:n,selectionStatusMessage:r,copyAllSegmentsButton:s,copyVisibleSegmentsButton:a,visibilityToggleAllButton:o}=this;t.debouncedUpdate.flush();let{visibleSegments:l,selectedSegments:d}=i,u=0,c=0,h=0,p="",g=d.size,m=l.size;t instanceof mu?(h=t.numMatches,u=t.visibleMatches,c=t.selectedMatches,p=t.statusText.value):p=`${m}/${g} visible`;let f=h?u:m,v=h?c:g,y=h||g;n.classList.toggle("neuroglancer-starred",v===y),n.classList.toggle("neuroglancer-indeterminate",v>0&&v!==y),r.textContent=p,s.title=`Copy all ${y} ${h?"matching":"starred"} segment(s)`,a.title=`Copy ${f} ${h?"visible matching":"visible"} segment(s)`,s.style.visibility=y?"visible":"hidden",a.style.visibility=f?"visible":"hidden",n.style.visibility=y?"visible":"hidden",o.style.visibility=y?"visible":"hidden";let b=f===y;o.classList.toggle("neuroglancer-visible",b);let S=f>0&&f!==y;o.classList.toggle("neuroglancer-indeterminate",S),e=b?`Click to hide ${y} segment ID(s).`:`Click to show ${y-f} segment ID(s).`,S&&(e+="  Shift+click to invert visibility."),o.title=e,this.statusChanged.dispatch()}}class my extends mv{listSource;group;constructor(e,t){super(e,t),this.listSource=e,this.group=t}listSegments(e=!1){return this.group.selectedSegments[Symbol.iterator]()}}class mb extends mv{listSource;segmentPropertyMap;debouncedUpdateQueryModel;updateQuery(){let{listSource:e,debouncedUpdateQueryModel:t}=this;t(),t.flush(),e.debouncedUpdate.flush()}listSegments(e=!1){let{listSource:t,segmentPropertyMap:i}=this;return this.updateQuery(),function*(e,t,i=!1){if(void 0===t)return;let{explicitIds:n}=t;if(void 0!==n)for(let e of n)yield e;let{indices:r}=t;if(void 0!==r){let{ids:t}=e.segmentPropertyMap.inlineProperties;for(let e=0,n=r.length;e<n;++e){let n=r[e];i?yield new eC.E(t[2*n],t[2*n+1]):(hH.low=t[2*n],hH.high=t[2*n+1],yield hH)}}}(i,t.queryResult.value,e)}constructor(e,t,i,n,r,s,a){let o;super(t,i),this.listSource=t,this.segmentPropertyMap=n,this.debouncedUpdateQueryModel=a;let l=e=>{s.focus(),s.select();let t=function(e,t){let{ids:i}=t;if(void 0!==i)return i.map(e=>e.toString()).join(", ");let n="",{prefix:r,regexp:s}=t;for(let e of(void 0!==r?n=r:void 0!==s&&(n=`/${s}`),t.includeTags))n.length>0&&(n+=" "),n+=`#${e}`;for(let e of t.excludeTags)n.length>0&&(n+=" "),n+=`-#${e}`;for(let i of t.numericalConstraints){let{fieldId:t,bounds:r}=i,[s,a]=r,o=e.numericalProperties.find(e=>e.id===t);if(!eO(o.dataType,o.bounds,r)){if(0===eI(s,a)){n.length>0&&(n+=" "),n+=`${t}=${s}`;continue}if(eI(s,o.bounds[0])>0){n.length>0&&(n+=" ");let e=eF(o.dataType,s,-1),i=s.toString(),r=e.toString();o.dataType!==ec.FLOAT32||i.length<=r.length?n+=`${t}>=${i}`:n+=`${t}>${r}`}if(0>eI(a,o.bounds[1])){n.length>0&&(n+=" ");let e=eF(o.dataType,a,1),i=a.toString(),r=e.toString();o.dataType!==ec.FLOAT32||i.length<=r.length?n+=`${t}<=${i}`:n+=`${t}<${r}`}}}let{sortBy:a}=t;if(1===a.length){let t=a[0];"<"===t.order&&t.fieldId===hq(e)&&(a=[])}for(let e of a)n.length>0&&(n+=" "),n+=`${e.order}${e.fieldId}`;for(let e of t.includeColumns)n.length>0&&(n+=" "),n+=`|${e}`;return n}(n,e);document.execCommand("insertText",!1,t),r.value=t,s.select()},d=document.createElement("div");d.classList.add("neuroglancer-segment-query-result-statistics");let u=document.createElement("div");u.classList.add("neuroglancer-segment-query-result-statistics-separator");let c=document.createElement("ul");c.classList.add("neuroglancer-segment-query-errors"),this.element.prepend(c,d,u),this.registerEventListener(s,"input",()=>{a()}),this.registerDisposer(sv(s,"cancel",()=>{s.focus(),s.select(),document.execCommand("delete"),s.blur(),s.value="",r.value=""})),this.registerDisposer(sv(s,"toggle-listed",()=>{this.toggleMatches()})),this.registerDisposer(sv(s,"hide-all",()=>{i.visibleSegments.clear()})),this.registerDisposer(sv(s,"hide-listed",()=>{a(),a.flush(),t.debouncedUpdate.flush();let{visibleSegments:e}=i;this.listSource instanceof md?e.clear():e.delete(Array.from(this.listSegments()))}));let h=this.registerDisposer(new mf(n,t.queryResult,l));{let{listElement:e}=h;void 0!==e&&d.appendChild(e)}let p=e=>{let t=e?.errors;if(sI(c),void 0!==t)for(let e of t){let t=document.createElement("li");t.textContent=e.message,c.appendChild(t)}};(0,Z.Jk)(i=>{if(t.segmentWidgetFactory=new hr(t.segmentationDisplayState,t.parentElement,e=>hZ(i?.query,e.id)),e.scrollToTop(),sI(e.header),void 0!==n){let n=t.segmentWidgetFactory.getHeader();for(let e of(n.container.classList.add("neuroglancer-segment-list-header"),n.propertyLabels)){let{label:n,sortIcon:r,id:s}=e;n.addEventListener("click",()=>{mg(t.queryResult.value,l,s)}),mm(i,r,s)}e.header.appendChild(n.container)}if(p(i),u.style.display="none",o?.remove(),void 0===i)return;let{query:r}=i;void 0===r.errors&&void 0===r.ids&&(void 0!==(o=function(e,t){let{tags:i}=e;if(void 0===i||0===i.length)return;let n=e.query,r=document.createElement("div");for(let{tag:s,count:a,desc:o}of(r.classList.add("neuroglancer-segment-query-result-tag-list"),i)){let i;let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let d=document.createElement("span");d.classList.add("neuroglancer-segment-query-result-tag-name"),s!==o&&void 0!==o&&""!==o?d.textContent=s+" ("+o+")":d.textContent=s,r.appendChild(l);let u=n.includeTags.includes(s),c=n.excludeTags.includes(s);i=u?"Remove tag from required set":c?"Remove tag from excluded set":"Add tag to required set",d.addEventListener("click",()=>{t(hK(n,s,!0,!u&&!c))}),d.title=i;let h=u||c,p=i=>{let r=i?a:e.count-a,o=document.createElement("div");if(o.classList.add("neuroglancer-segment-query-result-tag-toggle"),o.classList.add(`neuroglancer-segment-query-result-tag-${i?"include":"exclude"}`),l.appendChild(o),!h&&0===r)return;let d=i?u:c;o.appendChild(new aH({get value(){return d},set value(value){t(hK(n,s,i,value))},changed:ez.LP},{text:i?"+":"-",enableTitle:`Add tag to ${i?"required":"exclusion"} set`,disableTitle:`Remove tag from ${i?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};p(!0),p(!1),l.appendChild(d);let g=document.createElement("span");g.classList.add("neuroglancer-segment-query-result-tag-count"),!h&&(g.textContent=a.toString()),l.appendChild(g)}return r}(i,l))&&d.appendChild(o),(h.properties.length>0||void 0!==o)&&(u.style.display=""))},t.queryResult)}toggleMatches(){let{listSource:e}=this;this.updateQuery(),e.debouncedUpdate.flush();let t=e.queryResult.value;if(void 0===t)return;let{visibleMatches:i}=e,n=i!==t.count;return this.selectSegments(n,!0),!0}}class mS extends s_{layer;constructor(e){super(),this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new aY(e.displayState.segmentationGroupState.value.graph,(t,i,n)=>{if(void 0===t||t.tabContents)return;let r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(a_(n,e.toolBinder,{toolJson:mt,label:"Merge",title:"Merge segments"})),r.appendChild(a_(n,e.toolBinder,{toolJson:mi,label:"Split",title:"Split segments"})),i.appendChild(r)})).element);let i=document.createElement("div");i.className="neuroglancer-segmentation-toolbox",i.appendChild(a_(this,e.toolBinder,{toolJson:g8,label:"Select",title:"Select/Deselect segments"})),t.appendChild(i);let n=document.createElement("input");n.classList.add("neuroglancer-segment-list-query"),n.addEventListener("focus",()=>{n.select()}),this.registerDisposer(new aq(n,mc)).allShortcutsAreGlobal=!0;let{segmentQuery:r}=this.layer.displayState,s=this.registerCancellable((0,ic.Z)(()=>{r.value=n.value},200));n.autocomplete="off",n.title=mc.describe(),n.spellcheck=!1,n.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer((0,Z.Jk)(e=>{n.value=e},r)),this.registerDisposer((0,Z.Jk)(e=>{Date.now()-e<100&&(setTimeout(()=>{n.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(n),t.appendChild(this.registerDisposer(new aY(e.displayState.segmentPropertyMap,(t,i,a)=>{let o=a.registerDisposer(new mu(r,t,e.displayState,i)),l=a.registerDisposer(new md(e.displayState,i)),d=a.registerDisposer(new gO({source:o,horizontalScroll:!0})),u=a.registerDisposer(new gO({source:l,horizontalScroll:!0})),c=e.displayState.segmentationGroupState.value,h=a.registerDisposer(new mb(d,o,c,t,r,n,s));h.element.appendChild(d.element),i.appendChild(h.element);let p=a.registerDisposer(new my(l,c));p.element.appendChild(u.element),i.appendChild(p.element);let g=()=>{let e=""!==o.query.value||o.numMatches>0,t=l.length>0||!e;h.element.style.display=e?"contents":"none",p.element.style.display=t?"contents":"none"};a.registerDisposer(h.statusChanged.add(g)),a.registerDisposer(p.statusChanged.add(g)),h.updateStatus(),p.updateStatus();let m=a.registerCancellable((0,iS.H)(()=>{o.updateRenderedItems(d),l.updateRenderedItems(u)})),{displayState:f}=this.layer;ha(f,a,m),a.registerDisposer(f.segmentationGroupState.value.selectedSegments.changed.add(m)),d.element.classList.add("neuroglancer-segment-list"),d.element.classList.add("neuroglancer-preview-list"),u.element.classList.add("neuroglancer-segment-list"),a.registerDisposer(e.bindSegmentListWidth(d.element)),a.registerDisposer(e.bindSegmentListWidth(u.element)),a.registerDisposer(new sy(d.element,cA())),a.registerDisposer(new sy(u.element,cA())),l.segmentWidgetFactory=new hr(l.segmentationDisplayState,l.parentElement,e=>hZ(void 0,e.id)),u.scrollToTop(),sI(u.header)})).element)}}var mw=i("1064");let mC=new class e{next0;prev0;constructor(){mw.Z.initializeHead(this)}},mx=window.top===window,mE=(0,ic.Z)(()=>{if(!mx)return;let{activeElement:e}=document;if(null===e||e===document.body){let e=mw.Z.front(mC);null!==e&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{mE()},!0),window.addEventListener("blur",()=>{mE()},!0);class mT extends ef.gj{element;prev0;next0;lastFocusedElement;scheduleUpdateFocus;constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable((0,ic.Z)(()=>{let{activeElement:e}=document,{element:t}=this;if(!(t.contains(e)||sN(e)))null!=e&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),mw.Z.insertBefore(mC,this),this.registerEventListener(e,"focus",()=>{mw.Z.pop(this),mw.Z.insertAfter(mC,this)}),mE()}disposed(){mw.Z.pop(this),super.disposed()}}i("8213");let mk=0,mD=sh.fromObject({escape:{action:"close"}});class mP extends ef.gj{container;content;keyMap=new sh;constructor(){super(),this.keyMap.addParent(mD,Number.NEGATIVE_INFINITY),++mk;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new mT(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new aq(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--mk,document.body.removeChild(this.container),super.disposed()}}function mL(e={}){return sV({text:"?",...e})}i("6054");class mI extends ef.gj{group;element;topRow;label;selectElement;linkedLayers;unlinkButton;constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");let{element:t,label:i,topRow:n,selectElement:r,linkedLayers:s,unlinkButton:a}=this;n.appendChild(i),n.appendChild(r),n.appendChild(a),a.textContent="Unlink",a.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(n),t.appendChild(s),this.updateView();let o=(0,ic.Z)(()=>this.updateView(),0);this.registerEventListener(r,"change",()=>{this.updateModel(),o()}),this.registerDisposer(this.group.changed.add(o)),this.registerDisposer(this.group.linkedLayersChanged.add(o)),this.registerDisposer(this.group.layerManager.layersChanged.add(o))}updateModel(){let e=this.selectElement.value;""===e&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){let{selectElement:e,group:t}=this,{predicate:i}=t;sI(e);let n=0!==this.group.rootGroup.linkedLayers.size;this.unlinkButton.style.display=n?"":"none";let{linkedLayers:r}=this,s=0!==t.linkedLayers.size;if(r.style.display=s?"":"none",this.unlinkButton.textContent=s?"Unlink all":"Unlink",s)for(let i of(this.element.style.display="",e.style.display="none",sI(r),t.linkedLayers)){let e=document.createElement("div");e.classList.add("neuroglancer-linked-layer-widget-layer");let t=ae({title:"Unlink layer",onClick:()=>{this.group.getGroup(i).isolate()}});e.appendChild(t),e.appendChild(document.createTextNode(i.managedLayer.name)),r.appendChild(e)}else{e.style.display="";let n=document.createElement("option");e.appendChild(n);let r=0;for(let n of this.group.layerManager.managedLayers){let s=n.layer;if(null!==s){if(s!==t.layer&&i(s)){++r;let t=document.createElement("option"),{name:i}=n;t.textContent=i,t.value=i,e.appendChild(t)}}}e.value=t.toJSON()??"",this.element.style.display=0===r?"none":""}}}var mR=i("7750");function mA(e={}){return sV({svg:mR,...e})}i("3256"),i("7665"),i("7671"),i("8512");var mM=i("4631"),mN=i.n(mM);class mV{indented;column;type;align;prev;constructor(e,t,i,n,r){this.indented=e,this.column=t,this.type=i,this.align=n,this.prev=r}}function mO(e,t){let i;let n=e.indentUnit,r=t.keywords||m_(mF),s=t.builtins||m_(mB),a=t.blockKeywords||m_("case do else for if switch while struct"),o=t.atoms||m_("null"),l=t.hooks||{},d=t.multiLineStrings,u=/[+\-*&%=<>!?|/]/;function c(e,t){let n=e.next();if(l[n]){let i=l[n](e,t);if(!1!==i)return i}if('"'==n||"'"==n)return t.tokenize=function(e){return function(t,i){let n=!1,r,s=!1;for(;null!=(r=t.next());){if(r==e&&!n){s=!0;break}n=!n&&"\\"==r}return(s||!(n||d))&&(i.tokenize=c),"string"}}(n),t.tokenize(e,t);if(/[[\]{}(),;:.]/.test(n))return i=n,"bracket";if(/\d/.test(n))return e.eatWhile(/[\w.]/),"number";if("/"==n){if(e.eat("*"))return t.tokenize=h,h(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if("#"==n)return e.eatWhile(/[\S]+/),e.eatWhile(/[\s]+/),e.eatWhile(/[\S]+/),e.eatWhile(/[\s]+/),"comment";if(u.test(n))return e.eatWhile(u),"operator";e.eatWhile(/[\w$_]/);let p=e.current();return Object.hasOwn(r,p)?(Object.hasOwn(a,p)&&(i="newstatement"),"keyword"):Object.hasOwn(s,p)?"builtin":Object.hasOwn(o,p)?"atom":"word"}function h(e,t){let i=!1,n;for(;n=e.next();){if("/"==n&&i){t.tokenize=c;break}i="*"==n}return"comment"}function p(e,t,i){return e.context=new mV(e.indented,t,i,null,e.context)}function g(e){let t=e.context.type;return(")"==t||"]"==t||"}"==t)&&(e.indented=e.context.indented),e.context=e.context.prev}return{startState:function(e){return{tokenize:null,context:new mV((e||0)-n,0,"top",!1),indented:0,startOfLine:!0}},token:function(e,t){let n=t.context;if(e.sol()&&(null==n.align&&(n.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return null;i=null;let r=(t.tokenize||c)(e,t);if("comment"==r||"meta"==r)return r;if(null==n.align&&(n.align=!0),(";"==i||":"==i)&&"statement"==n.type)g(t);else if("{"==i)p(t,e.column(),"}");else if("["==i)p(t,e.column(),"]");else if("("==i)p(t,e.column(),")");else if("}"==i){for(;"statement"==n.type;)n=g(t);for("}"==n.type&&(n=g(t));"statement"==n.type;)n=g(t)}else i==n.type?g(t):("}"==n.type||"top"==n.type||"statement"==n.type&&"newstatement"==i)&&p(t,e.column(),"statement");return t.startOfLine=!1,r},indent:function(e,t){if(e.tokenize!=c&&null!=e.tokenize)return 0;let i=t&&t.charAt(0),r=e.context,s=i==r.type;return"statement"==r.type?r.indented+("{"==i?0:n):r.align?r.column+(s?0:1):r.indented+(s?0:n)},electricChars:"{}"}}function m_(e){let t={},i=e.split(" ");for(let e=0;e<i.length;++e)t[i[e]]=!0;return t}let mF="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",mB="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function mU(e,t){return!!t.startOfLine&&(e.skipToEnd(),"meta")}(F=mN()).defineMode("glsl",mO),F.defineMIME("text/x-glsl",{name:"glsl",keywords:m_(mF),builtins:m_(mB),blockKeywords:m_("case do else for if switch while struct"),atoms:m_("null"),hooks:{"#":mU}});class m$ extends ef.gj{state;textEditor;get element(){return this.textEditor.getWrapperElement()}changingValue;debouncedValueUpdater;constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=(0,ic.Z)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},500),this.textEditor=mN()(e=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{!this.changingValue&&this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;void 0!==t&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let i=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&this.textEditor.refresh()},{root:document.body});i.observe(this.element),this.registerDisposer(()=>i.disconnect())}updateErrorState(){let e;let{sourceStringNumber:t=1}=this.state,i=this.state.shaderError.value,{shaderControlState:n}=this.state;e=void 0!==n?n.parseErrors.value:[],void 0===i&&0===e.length?this.setValidState(void 0):null!=i||0!==e.length?(this.textEditor.setOption("lint",{getAnnotations:()=>{let n=[];for(let t of e)n.push({message:t.message,severity:"error",from:mN().Pos(t.line)});if(null!=i){if("ShaderCompilationError"===i.name)for(let e of i.errorMessages)n.push({message:e.message,severity:"error",from:mN().Pos(e.file===t&&e.line||0)});else"ShaderLinkError"===i.name?n.push({message:i.log,severity:"error",from:mN().Pos(0)}):n.push({message:i.message,severity:"error",from:mN().Pos(0)})}return n}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),!0===e?t.classList.add("valid-input"):!1===e&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,sR(this.element),this.textEditor=void 0,super.disposed()}}function mG(e,t){var i,n,r;let{shaderControlState:s}=e,a=s.state.get(t);if(void 0===a)return;let{control:o}=a;switch(o.type){case"slider":return uF(()=>({value:a.trackable,options:{min:o.min,max:o.max,step:o.step}}));case"color":return uq(()=>a.trackable);case"checkbox":return uM(()=>a.trackable);case"imageInvlerp":;return i=()=>({dataType:o.dataType,defaultChannel:o.default.channel,watchableValue:a.trackable,channelCoordinateSpaceCombiner:s.channelCoordinateSpaceCombiner,histogramSpecifications:s.histogramSpecifications,histogramIndex:l(),legendShaderOptions:e.legendShaderOptions}),{makeControl:(e,t,n)=>{let{watchableValue:r,channelCoordinateSpaceCombiner:s,dataType:a,defaultChannel:o,histogramSpecifications:l,legendShaderOptions:d,histogramIndex:u}=i(e);if(void 0!==s&&0!==o.length){let e=t.registerDisposer(new rO(s.combined)),i=t.registerDisposer(new a9(e,s,{copyButton:!1}));t.registerDisposer(e.changed.add(()=>{let t=Array.from(e.value,e=>Math.floor(e)),i=r.value;!(0,Y.cO)(i.channel,t)&&(r.value={...r.value,channel:t})}));let a=()=>{let t=e.value,i=r.value;!(0,Y.cO)(t,i.channel)&&(t.set(i.channel),e.changed.dispatch())};a(),t.registerDisposer(r.changed.add(a)),n.labelContainer.appendChild(i.element)}let c=t.registerDisposer(new s2(n.visibility,n.display,a,r,l,u,0===o.length?d:void 0));return{control:c,controlElement:c.element}},activateTool:(e,t)=>{s6(e,t)}};case"propertyInvlerp":;return n=()=>({properties:o.properties,watchableValue:a.trackable,histogramSpecifications:s.histogramSpecifications,histogramIndex:l(),legendShaderOptions:e.legendShaderOptions}),{makeControl:(e,t,i)=>{let{watchableValue:r,properties:s,histogramSpecifications:a,legendShaderOptions:o,histogramIndex:l}=n(e);{let e=document.createElement("select");for(let[t,i]of s){let n=document.createElement("option");n.textContent=`${t} (${ec[i].toLowerCase()})`,n.value=t,e.appendChild(n)}let n=()=>{e.value=r.value.property};t.registerEventListener(e,"change",()=>{let t=e.value,i=s.get(t),{window:n,range:a}=r.value;r.value={window:void 0!==n?eU(n,i):void 0,range:void 0!==a?eU(a,i):void 0,property:t,dataType:i}}),t.registerDisposer(r.changed.add(n)),n(),i.labelContainer.appendChild(e)}let d={changed:r.changed,get value(){let{dataType:e,window:t,range:i}=r.value;return void 0===i&&(i=ex[e]),{window:eL(t??i),range:i}},set value(newValue){let{window:e,range:t}=newValue;r.value={...r.value,window:e,range:t}}},u=(0,Z.mo)(e=>e.dataType,[r]),c=t.registerDisposer(new s3(i.visibility,i.display,u,d,a,l,o));return{control:c,controlElement:c.element}},activateTool:(e,t)=>{s6(e,t)}};case"transferFunction":;return r=()=>({dataType:o.dataType,watchableValue:a.trackable,channelCoordinateSpaceCombiner:s.channelCoordinateSpaceCombiner,defaultChannel:o.default.channel,histogramSpecifications:s.histogramSpecifications,histogramIndex:l()}),{makeControl:(e,t,i)=>{let{watchableValue:n,channelCoordinateSpaceCombiner:s,defaultChannel:a,histogramSpecifications:o,histogramIndex:l,dataType:d}=r(e);if(void 0!==s&&0!==a.length){let e=t.registerDisposer(new rO(s.combined)),r=t.registerDisposer(new a9(e,s,{copyButton:!1}));t.registerDisposer(e.changed.add(()=>{let t=Array.from(e.value,e=>Math.floor(e)),i=n.value;!(0,Y.cO)(i.channel,t)&&(n.value={...n.value,channel:t})}));let a=()=>{let t=e.value,i=n.value;!(0,Y.cO)(i.channel,t)&&(t.set(i.channel),e.changed.dispatch())};a(),t.registerDisposer(n.changed.add(a)),i.labelContainer.appendChild(r.element)}let u=t.registerDisposer(new ow(i.visibility,i.display,d,n,o,l));return{control:u,controlElement:u.element}},activateTool:(e,t)=>{!function(e,t){e.bindInputEventMap(ob)}(e,0)}}}function l(e=o.type){let i=t=>{if("imageInvlerp"===e||"transferFunction"===e)return"imageInvlerp"===t||"transferFunction"===t;if("propertyInvlerp"===e)return"propertyInvlerp"===t;throw Error(`${e} does not support histogram index.`)},n=0;for(let[e,{control:{type:r}}]of s.state){if(e===t)break;i(r)&&n++}return n}}function mz(e,t,i){return{label:i,toolJson:function(e,t){return{type:t,[mq]:e}}(i,t),makeControl:(t,n,r)=>mG(e(t),i).makeControl(t,n,r),activateTool:(t,n)=>mG(e(t.tool.layer),i).activateTool(t,n)}}class mj extends s_{state;display;layer;options;controlDisposer;toolId;constructor(e,t,i,n={}){super(n.visibility),this.state=e,this.display=t,this.layer=i,this.options=n,this.controlDisposer=void 0;let{toolId:r=mW}=n;this.toolId=r;let{element:s}=this;s.style.display="contents";let{controls:a}=e;this.registerDisposer(a.changed.add(this.registerCancellable((0,ic.Z)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;void 0!==this.controlDisposer&&(this.controlDisposer.dispose(),sI(e));let t=this.controlDisposer=new ef.gj,i=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let n of this.state.state.keys())e.appendChild(uR(t,this.layer,this.visibility,mz(i,this.toolId,n)))}disposed(){this.controlDisposer?.dispose(),super.disposed()}}let mW="shaderControl",mq="control";class mH extends uL{layerShaderControls;control;constructor(e,t,i,n){super(e,mz(()=>t,i,n)),this.layerShaderControls=t,this.control=n;let r=this.registerCancellable((0,ic.Z)(()=>{void 0===t.shaderControlState.state.get(n)&&this.unbind()}));this.registerDisposer(t.shaderControlState.controls.changed.add(r))}isLoading(){let{shaderControlState:e}=this.layerShaderControls;return void 0===e.state.get(this.control)}}function mJ(e,t,i=mW){aL(e,i,(e,n)=>{let r=(0,eb.uq)(n,mq,eb.ZE);return new mH(e,t(e),i,r)},(e,i)=>{let{shaderControlState:n}=t(e);return void 0!==i&&n.controls.changed.addOnce(i),Array.from(n.state.keys(),e=>({type:mW,[mq]:e}))})}function mK(e){return new m$({fragmentMain:e.displayState.skeletonRenderingOptions.shader,shaderError:e.displayState.shaderError,shaderControlState:e.displayState.skeletonRenderingOptions.shaderControlState})}class mZ extends s_{layer;constructor(e){super(),this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new mI(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new mI(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of uZ)t.appendChild(uR(this,e,this.visibility,i));let i=this.registerDisposer(new aY(e.hasSkeletonsLayer,(t,i,n)=>{if(!t)return;let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let s=document.createElement("div");s.style.flex="1",s.textContent="Skeleton shader:",r.appendChild(s),r.appendChild(mA({title:"Show larger editor view",onClick:()=>{new mY(this.layer)}})),r.appendChild(mL({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),i.appendChild(r);let a=n.registerDisposer(mK(this.layer));i.appendChild(a.element),i.appendChild(n.registerDisposer(new mj(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:uT})).element),a.textEditor.refresh()},this.visibility));t.appendChild(i.element)}}class mY extends mP{layer;codeWidget;constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(mK(e)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}class mX extends iX{hashTable=new cr;changed=new ez.MZ;get value(){return this}static makeWithCounterpart(e){let t=new mX;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:i}=this;i&&i.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){for(let[t,i]of(this.clear(),e.unsafeEntries()))this.set(t,i)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,i]of this.hashTable.unsafeEntries())e[t.toString()]=i.toString();return e}}mX=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i1("Uint64Map")],mX),iq("Uint64Map.set",function(e){let t=this.get(e.id);t.set_(e.key,e.value)&&t.changed.dispatch()}),iq("Uint64Map.delete",function(e){let t=this.get(e.id);t.delete_(e.key)&&t.changed.dispatch()}),iq("Uint64Map.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});class mQ{changed=new ez.MZ;data=new Map;dispose(){this.data.clear()}get size(){return this.data.size}get value(){return this}has(e){return this.data.has(BigInt(e.toString()))}add(e){let{data:t}=this;if(Array.isArray(e)){let i=[];for(let n of e){let e=BigInt(n.toString());!t.has(e)&&(n=n.clone(),i.push(n),t.set(e,n))}0!==i.length&&this.changed.dispatch(i,!0)}else{let i=BigInt(e.toString());if(t.has(i))return;t.set(i,e.clone()),this.changed.dispatch(e,!0)}}[Symbol.iterator](){return this.data.values()}delete(e){let{data:t}=this;if(Array.isArray(e)){let i=[];for(let n of e){let e=BigInt(n.toString());t.has(e)&&(t.delete(e),i.push(n))}0!==i.length&&this.changed.dispatch(i,!1)}else{let i=BigInt(e.toString());if(!t.has(i))return;t.delete(i),this.changed.dispatch(e,!1)}}set(e,t){t?this.add(e):this.delete(e)}clear(){this.data.size>0&&(this.data.clear(),this.changed.dispatch(null,!1))}toJSON(){return Array.from(this.data.keys(),e=>e.toString())}assignFrom(e){this.clear();let t=e.data,{data:i}=this,n=Array.from(t.values());for(let[e,n]of t)i.set(e,n);this.changed.dispatch(n,!0)}}class m0 extends iX{hashTable=new u9;changed=new ez.MZ;get value(){return this}static makeWithCounterpart(e){let t=new m0;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let i of e)t=this.hashTable.add(i)||t;return t}add(e){let t=[].concat(e);if(this.add_(t)){let{rpc:i}=this;i&&i.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(e){let t=!1;for(let i of e)t=this.hashTable.delete(i)||t;return t}delete(e){let t=[].concat(e);if(this.delete_([].concat(e))){let{rpc:i}=this;i&&i.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=[];for(let t of this.unsafeKeys())e.push(t.toString());return e.sort(),e}assignFrom(e){for(let t of(this.clear(),e.unsafeKeys()))this.add(t)}}m0=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i1("Uint64Set")],m0),iq("Uint64Set.reserve",function(e){let t=this.get(e.id);t.reserve_(e.value)&&t.changed.dispatch()}),iq("Uint64Set.add",function(e){let t=this.get(e.id);t.add_(e.value)&&t.changed.dispatch()}),iq("Uint64Set.delete",function(e){let t=this.get(e.id);t.delete_(e.value)&&t.changed.dispatch()}),iq("Uint64Set.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});class m1 extends ef.gj{layer;specificationChanged;constructor(e){super(),this.layer=e,this.specificationChanged=new ez.MZ,this.localGraph=new h9,this.timestamp=new Z.TU(void 0,e=>e),this.timestampOwner=new Z.GF,this.selectedSegments=this.registerDisposer(new mQ),this.segmentPropertyMap=new Z.SN(void 0),this.graph=new Z.SN(void 0),this.localSegmentEquivalences=!1,this.maxIdLength=new Z.SN(1),this.hideSegmentZero=new nn(!0,!0),this.segmentQuery=new Z.TU("",eb.ZE);let{specificationChanged:t}=this;this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch);let{selectedSegments:i}=this,n=this.visibleSegments=this.registerDisposer(m0.makeWithCounterpart(e.manager.rpc));this.segmentEquivalences=this.registerDisposer(h6.makeWithCounterpart(e.manager.rpc,e.registerDisposer((0,Z.mo)(e=>e?.visibleSegmentEquivalencePolicy||lS.BA.MIN_REPRESENTATIVE,[this.graph])))),this.temporaryVisibleSegments=e.registerDisposer(m0.makeWithCounterpart(e.manager.rpc)),this.temporarySegmentEquivalences=e.registerDisposer(h6.makeWithCounterpart(e.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=e.registerDisposer(i3.make(e.manager.rpc,!1)),this.useTemporarySegmentEquivalences=e.registerDisposer(i3.make(e.manager.rpc,!1)),n.changed.add(t.dispatch),i.changed.add(t.dispatch),i.changed.add((e,t)=>{!t&&(e?n.delete(e):n.clear())}),n.changed.add((e,t)=>{t&&e&&i.add(e)}),this.timestamp.changed.add(t.dispatch),this.timestampOwner.changed.add(t.dispatch)}restoreState(e){(0,eb.Kh)(e,ud,e=>this.hideSegmentZero.restoreState(e)),(0,eb.Kh)(e,up,e=>{this.localGraph.restoreState(e)}),(0,eb.Kh)(e,uh,e=>{let{segmentEquivalences:t,selectedSegments:i,visibleSegments:n}=this;(0,eb.m7)(e,e=>{let r=String(e),s=r.startsWith("!");s&&(r=r.substring(1));let a=eC.E.parseString(r,10),o=t.get(a);i.add(o),!s&&n.add(o)})}),(0,eb.Kh)(e,ub,e=>this.segmentQuery.restoreState(e)),(0,eb.Kh)(e,uD,e=>{let t=(0,eb.zE)(e);for(let e of(this.timestampOwner.clear(),t))this.timestampOwner.add(e)}),(0,eb.Kh)(e,uk,e=>{this.timestamp.restoreState(e)})}toJSON(){let e={};e[ud]=this.hideSegmentZero.toJSON();let{selectedSegments:t,visibleSegments:i}=this;t.size>0?e[uh]=[...t].map(e=>i.has(e)?e.toString():"!"+e.toString()):e[uh]=[];let{segmentEquivalences:n}=this;return this.localSegmentEquivalences&&n.size>0&&(e[up]=n.toJSON()),e[ub]=this.segmentQuery.toJSON(),e[uk]=this.timestamp.toJSON(),this.timestampOwner.size>0&&(e[uD]=[...this.timestampOwner]),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.selectedSegments.assignFrom(e.selectedSegments),this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences),this.timestamp.value=e.timestamp.value,this.timestampOwner.values=new Set(e.timestampOwner)}localGraph;visibleSegments;timestamp;timestampOwner;selectedSegments;segmentPropertyMap;graph;segmentEquivalences;localSegmentEquivalences;maxIdLength;hideSegmentZero;segmentQuery;temporaryVisibleSegments;temporarySegmentEquivalences;useTemporaryVisibleSegments;useTemporarySegmentEquivalences;canSetTimestamp(e){return![...this.timestampOwner].filter(t=>t!==e).length&&!0}}class m2 extends ef.gj{layer;specificationChanged;constructor(e){super(),this.layer=e,this.specificationChanged=new ez.MZ,this.segmentColorHash=cI.getDefault(),this.segmentStatedColors=this.registerDisposer(new mX),this.tempSegmentStatedColors2d=this.registerDisposer(new mX),this.segmentDefaultColor=new eu,this.tempSegmentDefaultColor2d=new Z.SN(void 0),this.highlightColor=new Z.SN(void 0);let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.tempSegmentStatedColors2d.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch),this.tempSegmentDefaultColor2d.changed.add(t.dispatch),this.highlightColor.changed.add(t.dispatch)}restoreState(e){(0,eb.Kh)(e,ug,e=>this.segmentColorHash.restoreState(e)),(0,eb.Kh)(e,ux,e=>this.segmentDefaultColor.restoreState(e)),(0,eb.Kh)(e,um,e=>{for(let[t,i]of(0,eb.ZI)(e,e=>ei(String(e)))){let e=eC.E.parseString(String(t)),n=new eC.E(en(i));this.segmentStatedColors.set(e,n)}})}toJSON(){let e={};e[ug]=this.segmentColorHash.toJSON(),e[ux]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let i=e[um]={};for(let[e,n]of t.unsafeEntries())i[e.toString()]=ea(er(n.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.tempSegmentStatedColors2d.assignFrom(e.tempSegmentStatedColors2d),this.segmentDefaultColor.value=e.segmentDefaultColor.value,this.highlightColor.value=e.highlightColor.value}segmentColorHash;segmentStatedColors;tempSegmentStatedColors2d;segmentDefaultColor;tempSegmentDefaultColor2d;highlightColor}class m3 extends ef.gj{linkedGroup;propertyName;curRoot;curGroupState;get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:e}=this;void 0!==e&&(t.assignFrom(e),e.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){this.curGroupState?.dispose()}constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}}class m4{layer;constructor(e){this.layer=e,this.segmentSelectionState=new c2,this.selectedAlpha=pW(.5),this.saturation=pW(1),this.notSelectedAlpha=pW(0),this.hoverHighlight=new nn(!0,!0),this.silhouetteRendering=new Z.TU(0,eb.lu,0),this.objectAlpha=pW(1),this.ignoreNullVisibleSet=new nn(!0,!0),this.skeletonRenderingOptions=new pf,this.shaderError=nb(),this.renderScaleHistogram=new lD,this.renderScaleTarget=lk(1),this.baseSegmentColoring=new nn(!1,!1),this.baseSegmentHighlighting=new nn(!1,!1),this.moveToSegment=e=>{this.layer.moveToSegment(e)},e.displayState=this,this.linkedSegmentationGroup=e.registerDisposer(new dH(e.manager.rootLayers,e,e=>e instanceof m5,e=>e.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new dH(e.manager.rootLayers,e,e=>e instanceof m5,e=>e.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=e.registerDisposer(new m1(e)),this.originalSegmentationColorGroupState=e.registerDisposer(new m2(e)),this.transparentPickEnabled=e.pick,this.useTempSegmentStatedColors2d=e.registerDisposer(i3.make(e.manager.rpc,!1)),this.segmentationGroupState=this.layer.registerDisposer(new m3(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new m3(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.selectSegment=e.selectSegment,this.filterBySegmentLabel=e.filterBySegmentLabel,this.hideSegmentZero=this.layer.registerDisposer(new Z.ip(this.segmentationGroupState,e=>e.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new Z.kp(this.segmentationColorGroupState,e=>e.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new Z.kp(this.segmentationColorGroupState,e=>e.segmentStatedColors)),this.tempSegmentStatedColors2d=this.layer.registerDisposer(new Z.kp(this.segmentationColorGroupState,e=>e.tempSegmentStatedColors2d)),this.segmentDefaultColor=this.layer.registerDisposer(new Z.kp(this.segmentationColorGroupState,e=>e.segmentDefaultColor)),this.tempSegmentDefaultColor2d=this.layer.registerDisposer(new Z.kp(this.segmentationColorGroupState,e=>e.tempSegmentDefaultColor2d)),this.highlightColor=this.layer.registerDisposer(new Z.kp(this.segmentationColorGroupState,e=>e.highlightColor)),this.segmentQuery=this.layer.registerDisposer(new Z.ip(this.segmentationGroupState,e=>e.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new Z.ip(this.segmentationGroupState,e=>e.segmentPropertyMap))}segmentSelectionState;selectedAlpha;saturation;notSelectedAlpha;hoverHighlight;silhouetteRendering;objectAlpha;ignoreNullVisibleSet;skeletonRenderingOptions;shaderError;renderScaleHistogram;renderScaleTarget;selectSegment;transparentPickEnabled;baseSegmentColoring;baseSegmentHighlighting;useTempSegmentStatedColors2d;filterBySegmentLabel;moveToSegment;linkedSegmentationGroup;linkedSegmentationColorGroup;originalSegmentationGroupState;originalSegmentationColorGroupState;segmentationGroupState;segmentationColorGroupState;hideSegmentZero;segmentColorHash;segmentStatedColors;tempSegmentStatedColors2d;segmentDefaultColor;tempSegmentDefaultColor2d;highlightColor;segmentQuery;segmentPropertyMap}let m6=g6(dM);class m5 extends m6{sliceViewRenderScaleHistogram=new lD;sliceViewRenderScaleTarget=lk(1);graphConnection=new Z.SN(void 0);bindSegmentListWidth(e){return c8(this.displayState,e)}segmentQueryFocusTime=new Z.SN(Number.NEGATIVE_INFINITY);selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,t=>(t.value=e.clone(),!0),t)};filterBySegmentLabel=e=>{let{label:t}=c6(this.displayState,e);t&&this.filterSegments(t)};filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};displayState=new m4(this);anchorSegment=new Z.TU(void 0,e=>void 0===e?void 0:eC.E.parseString(e));constructor(e){super(e),this.registerDisposer((0,Z.w)((e,t)=>{e.registerDisposer(t.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer((0,Z.w)((e,t)=>{e.registerDisposer(t.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.hoverHighlight.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new mZ(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new mS(this)});let t=this.registerDisposer((0,Z.mo)(e=>void 0===e,[this.displayState.segmentationGroupState.value.graph]));this.tabs.add("graph",{label:"Graph",order:-25,getter:()=>new hY(this),hidden:t}),this.tabs.default="rendering"}get volumeOptions(){return{volumeType:pE.SEGMENTATION}}has2dLayer=this.registerDisposer((0,Z.og)(e=>e.some(e=>e instanceof pj),{changed:this.layersChanged,value:this.renderLayers}));has3dLayer=this.registerDisposer((0,Z.og)(e=>e.some(e=>e instanceof hk||e instanceof hA||e instanceof py||e instanceof pb),{changed:this.layersChanged,value:this.renderLayers}));hasSkeletonsLayer=this.registerDisposer((0,Z.og)(e=>e.some(e=>e instanceof py),{changed:this.layersChanged,value:this.renderLayers}));activateDataSubsources(e){var t,i;let n;let r=[],s=this.displayState.linkedSegmentationGroup.root.value===this;for(let t of e){if(this.addStaticAnnotations(t))continue;let{volume:e,mesh:i,segmentPropertyMap:a,segmentationGraph:o,local:l}=t.subsourceEntry.subsource;if(e instanceof pM){if(e.dataType===ec.FLOAT32){t.deactivate("Data type not compatible with segmentation layer");continue}t.activate(()=>t.addRenderLayer(new pj(e,{...this.displayState,transform:t.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else void 0!==i?t.activate(()=>{let e={...this.displayState,transform:t.getRenderLayerTransform()};if(i instanceof hL)t.addRenderLayer(new hk(this.manager.chunkManager,i,e));else if(i instanceof hV)t.addRenderLayer(new hA(this.manager.chunkManager,i,e));else{let n=new pv(this.manager.chunkManager,i,e);t.addRenderLayer(new py(n.addRef())),t.addRenderLayer(new pb(n))}},this.displayState.segmentationGroupState.value):void 0!==a?s?(t.activate(()=>{}),r.push(a)):t.deactivate("Not supported on non-root linked segmentation layers"):void 0!==o?s?void 0!==n?t.deactivate("Only one segmentation graph is supported"):(n=o,t.activate(e=>{let i=o.connect(this);e.registerDisposer(()=>{i.dispose(),this.graphConnection.value=void 0});let n={...this.displayState,transform:t.getRenderLayerTransform()},r=i.createRenderLayers(this.manager.chunkManager,n,this.localPosition);for(let e of(this.graphConnection.value=i,r))t.addRenderLayer(e)})):t.deactivate("Not supported on non-root linked segmentation layers"):l===l7.equivalences?s?void 0!==n?t.deactivate("Only one segmentation graph is supported"):(n=this.displayState.originalSegmentationGroupState.localGraph,t.activate(e=>{this.graphConnection.value=e.registerDisposer(n.connect(this)),e.registerDisposer(()=>{this.graphConnection.value=void 0})})):t.deactivate("Not supported on non-root linked segmentation layers"):t.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=(t=this.manager.chunkManager,i=r,t.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:i.map(e=>(0,nd.M)(e))},()=>{let e=function(e){for(;;){if(0===e.length)return;if(1===e.length)return e[0];let n=[];for(let r=0,s=e.length;r<s;r+=2)if(r+1===s)n.push(e[r]);else{var t,i;n.push((t=e[r],i=e[r+1],new hU({inlineProperties:function(e,t){let i;if(void 0===e)return t;if(void 0===t)return e;let n=0,r=e.ids.length/2,s=t.ids.length/2,a=new Uint32Array(r),o=new Uint32Array(s),l=e.ids,d=t.ids;if((0,Y.FD)(r,s,(e,t)=>{let i=l[2*e+1],n=l[2*e],r=d[2*t+1],s=d[2*t];return i-r||n-s},e=>{a[e]=n,++n},e=>{o[e]=n,++n},(e,t)=>{a[e]=n,o[t]=n,++n}),n===r)i=l;else if(n===s)i=d;else{i=new Uint32Array(2*n);for(let e=0;e<r;++e){let t=a[e];i[2*t]=l[2*e],i[2*t+1]=l[2*e+1]}for(let e=0;e<s;++e){let t=o[e];i[2*t]=d[2*e],i[2*t+1]=d[2*e+1]}}let u=[];if(n===r)u.push(...e.properties);else for(let t of e.properties)u.push(hz(t,n,a));if(n===s)u.push(...t.properties);else for(let e of t.properties)u.push(hz(e,n,o));return{ids:i,properties:u}}(t.inlineProperties,i.inlineProperties)})))}e=n}}(i);if(void 0!==e)return new h$(e)})),this.displayState.originalSegmentationGroupState.graph.value=n}getLegacyDataSourceSpecifications(e,t,i,n){let r=super.getLegacyDataSourceSpecifications(e,t,i,n),s=(0,eb.Kh)(t,"mesh",e=>null===e?null:(0,eb.ZE)(e)),a=(0,eb.Kh)(t,"skeletons",e=>null===e?null:(0,eb.ZE)(e));if(void 0!==s||void 0!==a)for(let e of r)e.enableDefaultSubsources=!1,e.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return null!=s&&r.push(dd(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:s,type:"mesh"}))),null!=a&&r.push(dd(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:a,type:"skeletons"}))),void 0!==t[up]&&void 0===n.find(e=>e.url===di)&&r.push({url:di,enableDefaultSubsources:!0,transform:{outputSpace:tM,sourceRank:0,transform:void 0,inputSpace:tM},subsources:new Map}),r}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[ur]),this.displayState.saturation.restoreState(e[uo]),this.displayState.notSelectedAlpha.restoreState(e[us]),this.displayState.hoverHighlight.restoreState(e[ul]),this.displayState.objectAlpha.restoreState(e[ua]),this.displayState.baseSegmentColoring.restoreState(e[uu]),this.displayState.silhouetteRendering.restoreState(e[uS]),this.displayState.ignoreNullVisibleSet.restoreState(e[uc]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[uy]);let i=e.skeletonShader;void 0!==i&&t.shader.restoreState(i),this.displayState.renderScaleTarget.restoreState(e[uf]),this.anchorSegment.restoreState(e[uE]),this.sliceViewRenderScaleTarget.restoreState(e[uv]);let n=(0,eb.Kh)(e,uw,eb.ZE);void 0!==n&&this.displayState.linkedSegmentationGroup.linkByName(n);let r=(0,eb.Kh)(e,uC,e=>!1===e?void 0:(0,eb.ZE)(e),n);void 0!==r&&this.displayState.linkedSegmentationColorGroup.linkByName(r),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){let e=super.toJSON();e[ur]=this.displayState.selectedAlpha.toJSON(),e[us]=this.displayState.notSelectedAlpha.toJSON(),e[uo]=this.displayState.saturation.toJSON(),e[ua]=this.displayState.objectAlpha.toJSON(),e[ul]=this.displayState.hoverHighlight.toJSON(),e[uu]=this.displayState.baseSegmentColoring.toJSON(),e[uc]=this.displayState.ignoreNullVisibleSet.toJSON(),e[uS]=this.displayState.silhouetteRendering.toJSON(),e[uE]=this.anchorSegment.toJSON(),e[uy]=this.displayState.skeletonRenderingOptions.toJSON(),e[uf]=this.displayState.renderScaleTarget.toJSON(),e[uv]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:i}=this.displayState;return e[uw]=t.toJSON(),i.root.value!==t.root.value&&(e[uC]=i.toJSON()??!1),e[up]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),i.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return null==e?e:c4(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break;case"clear-segments":if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break;case"select":case"star":{if(!this.pick.value)break;let{segmentSelectionState:i}=this.displayState;if(i.hasSelectedSegment){let n=i.selectedSegment,r=this.displayState.segmentationGroupState.value,s="select"===e?r.visibleSegments:r.selectedSegments,a=!s.has(n);(a||void 0===t.segmentationToggleSegmentState)&&(t.segmentationToggleSegmentState=a),t.defer(()=>{t.segmentationToggleSegmentState===a&&s.set(n,a)})}}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let i=new eC.E,{value:n}=e;"number"==typeof n&&(n=n.toString()),"string"==typeof n&&i.tryParseString(n)?e.value=i:e.value=void 0}selectionStateToJson(e,t){let i=super.selectionStateToJson(e,t),{value:n}=e;return n instanceof c1?t?i.value={key:n.key.toString(),value:n.value?n.value.toString():void 0,label:n.label}:i.value=(n.value||n.key).toString():n instanceof eC.E&&(i.value=n.toString()),i}displaySegmentationSelection(e,t,i){let n;let{value:r}=e;if(("number"==typeof r||"string"==typeof r)&&!(n=new eC.E).tryParseString(r.toString()))return!1;if(r instanceof eC.E)n=r.clone();else{if(!(r instanceof c1))return!1;n=r.key.clone()}let{displayState:s}=this,a=c6(s,n),{segmentEquivalences:o,segmentPropertyMap:{value:l}}=this.displayState.segmentationGroupState.value,d=o.get(n),u=hs(this.displayState,a);if(ha(s,i,i.redraw),i.registerDisposer(c8(s,u)),u.classList.add("neuroglancer-selection-details-segment"),t.appendChild(u),void 0!==l){let{inlineProperties:e}=l.segmentPropertyMap;if(void 0!==e){let i=l.getSegmentInlineIndex(d);if(-1!==i){for(let n of e.properties)if("label"!==n.type){if("description"===n.type){let e=n.values[i];if(!e)continue;let r=document.createElement("div");r.classList.add("neuroglancer-selection-details-segment-description"),r.textContent=e,t.appendChild(r)}else if("number"===n.type||"string"===n.type){let e=n.values[i];if("number"===n.type?Number.isNaN(e):!e)continue;let r=document.createElement("div");r.classList.add("neuroglancer-selection-details-segment-property");let s=document.createElement("div");s.classList.add("neuroglancer-selection-details-segment-property-name"),s.textContent=n.id,n.description&&(s.title=n.description);let a=document.createElement("div");a.classList.add("neuroglancer-selection-details-segment-property-value"),a.textContent=e.toString(),r.appendChild(s),r.appendChild(a),t.appendChild(r)}}}}}return!0}displaySelectionState(e,t,i){let n=this.displaySegmentationSelection(e,t,i);return super.displaySelectionState(e,t,i)&&(n=!0),n}moveToSegment(e){for(let t of this.renderLayers){if(!(t instanceof hA||t instanceof hk))continue;let i=t.displayState.transform.value;if(void 0!==i.error)return;let{rank:n,globalToRenderLayerDimensions:r}=i,{globalPosition:s}=this.manager.root,a=new Float32Array(n),o=[];for(let e=0;e<n;e++)o[r[e]]=e;(0,Y.zV)(a,s.value,o);let l=t instanceof hk?t.getObjectPosition(e,a):t.getObjectPosition(e);if(void 0!==l){this.setLayerPosition(i,l);return}}ai.showTemporaryMessage(`No position information loaded for segment ${e}`)}static type="segmentation";static typeAbbreviation="seg";static supportsPickOption=!0}!function(e){for(let t of uZ)uA(e,t)}(m5),d4(m5),B=pE.SEGMENTATION,U=m5,d2.set(B,U),d6(e=>{if(void 0!==e.mesh)return{layerConstructor:m5,priority:1}}),mJ(m5,e=>({shaderControlState:e.displayState.skeletonRenderingOptions.shaderControlState}),uT),aL($=m5,mt,e=>new ms(e)),aL($,mi,e=>new ma(e)),aL(m5,g8,e=>new me(e)),i("9308"),i("5995");var m8=i("4649");function m7(e,t=e.value){e.style.minWidth=t.length+1+"ch"}let m9="neuroglancer-coordinate-space-transform-singleton";function fe(e,t,i){let n,r;return i&&(e+=.5,t+=.5),{lower:n=e===Number.NEGATIVE_INFINITY?"(-∞,":`[${Math.floor(e)},`,upper:r=t===Number.POSITIVE_INFINITY?"+∞)":`${Math.floor(t)})`}}let ft=sh.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function fi(){let e=document.createElement("div"),t=document.createElement("input");e.classList.add("neuroglancer-coordinate-space-transform-scale-container"),t.spellcheck=!1,t.autocomplete="off",t.size=1,t.classList.add("neuroglancer-coordinate-space-transform-scale"),e.appendChild(t);let i=document.createElement("div"),n=document.createElement("span");n.innerHTML=m8,i.appendChild(n);let r=document.createTextNode("");return i.appendChild(r),i.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),e.appendChild(i),{cellElement:e,inputElement:t,suggestionElement:i}}function fn(e,t,i,n,r){if(void 0===t||t.scale===i&&t.unit===n)e.style.display="none";else{e.style.display="";let i=tm(t.scale,t.unit,{elide1:!1});e.lastChild.textContent=i,e.title=`${r}${i}`}}function fr(){let e=document.createElement("input");return e.spellcheck=!1,e.autocomplete="off",e.size=1,e.placeholder=" ",e.classList.add("neuroglancer-coordinate-space-transform-output-name"),e}function fs(e,t,i){let n=e.map(e=>tf(e.value));if(n.includes(void 0))return!1;let r=Float64Array.from(n,e=>e.scale),s=Array.from(n,e=>e.unit),a=i.value,{scales:o,units:l,rank:d}=a;for(let e=0;e<d;++e)!t[e]&&(r[e]=o[e],s[e]=l[e]);if((0,Y.cO)(o,r)&&(0,Y.cO)(l,s))return!1;let u=a.timestamps.map((e,t)=>r[t]===o[t]&&s[t]===l[t]?e:Date.now()),c=tR({valid:a.valid,rank:a.rank,scales:r,units:s,timestamps:u,ids:a.ids,names:a.names,boundingBoxes:a.boundingBoxes,coordinateArrays:a.coordinateArrays});return i.value=c,!0}function fa(e,t,i,n){let r=new Float64Array(e.scales),s=Array.from(e.units);if(r[t]===i&&s[t]===n)return e;let a=Array.from(e.timestamps);return r[t]=i,s[t]=n,a[t]=Date.now(),{...e,scales:r,units:s,timestamps:a}}class fo extends ef.gj{transform;localCombiner;globalCombiner;element;coefficientContainer;translationContainer;outputNameContainer;outputScaleContainer;inputNameContainer;inputScaleContainer;inputLowerBoundsContainer;inputUpperBoundsContainer;coefficientElements;inputNameElements;outputNameElements;outputScaleElements;outputScaleSuggestionElements;inputScaleSuggestionElements;inputScaleElements;inputBoundsElements;outputBoundsElements;addSourceDimensionIcon;addOutputDimensionIcon;addOutputDimensionCell;addOutputDimensionInput;inputScaleModified;outputScaleModified;curSourceRank;curRank;curTransform;addingSourceDimension;resetToIdentityButton;resetToDefaultButton;constructor(e,t,i){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=i,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=sV({svg:gL,text:"S"}),this.addOutputDimensionIcon=sV({svg:gL,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=fr(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=sV({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=(0,to.XD)(Float64Array,t+1)}}),this.resetToDefaultButton=sV({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:i}=t,n=i.ids.map(()=>++tE);e.value={...t,outputSpace:{...i,ids:n}}}});let{element:n}=this;this.registerDisposer(new aq(n,ft)).allShortcutsAreGlobal=!0,n.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new sy(n,ft));let r=(0,iS.H)(()=>this.updateView());this.registerDisposer(e.changed.add(r));let{coefficientContainer:s,translationContainer:a,outputNameContainer:o,inputNameContainer:l,inputScaleContainer:d,inputLowerBoundsContainer:u,inputUpperBoundsContainer:c,outputScaleContainer:h,addOutputDimensionCell:p,addOutputDimensionIcon:g,addSourceDimensionIcon:m,resetToIdentityButton:f,resetToDefaultButton:v}=this;s.style.display="contents",a.style.display="contents",o.style.display="contents",l.style.display="contents",d.style.display="contents",h.style.display="contents",u.style.display="contents",c.style.display="contents";let y=document.createElement("div");for(let[e,t]of(y.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),f.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),v.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),y.appendChild(f),y.appendChild(v),n.appendChild(y),[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]])){let i=document.createElement("div");i.classList.add(`neuroglancer-coordinate-space-transform-${e}-label`),i.classList.add("neuroglancer-coordinate-space-transform-label"),i.textContent=t,n.appendChild(i)}e.mutableSourceRank&&p.appendChild(m),p.appendChild(g),p.classList.add("neuroglancer-coordinate-space-transform-output-extend");let b="Embed in additional output dimension",S="Extend to additional source dimension";g.title=b,m.title=S,p.appendChild(this.addOutputDimensionInput),p.dataset.isActive="false",g.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=b,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),m.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=S,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),n.appendChild(s),n.appendChild(o),n.appendChild(l),n.appendChild(d),n.appendChild(h),n.appendChild(u),n.appendChild(c),s.appendChild(a),n.addEventListener("input",e=>{let{target:t}=e;if(t instanceof HTMLInputElement){m7(t);let e=this.inputScaleElements.indexOf(t);if(-1!==e){this.inputScaleModified[e]=!0,this.updateScaleValidity(t);return}if(-1!==(e=this.outputScaleElements.indexOf(t))){this.outputScaleModified[e]=!0,this.updateScaleValidity(t);return}if(-1!==(e=this.outputNameElements.indexOf(t))){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(t)){this.updateCoefficientValidity(t);return}}});let w=(e,t,i)=>{sv(n,e,e=>{e.stopPropagation();let n=e.target;if(!(n instanceof HTMLInputElement)||0!==i&&(n.selectionStart!==n.selectionEnd||n.selectionStart!==(1===i?n.value.length:0)))return;let r=this.getElementGridPosition(n);if(void 0===r)return;let s=this.getElementByGridPosition(r.row+t,r.col+i);null!==s&&(s.focus(),e.preventDefault())})};w("move-up",-1,0),w("move-down",1,0),w("move-left",0,-1),w("move-right",0,1);let C=(e,t)=>{e.addEventListener("focusout",i=>{let{relatedTarget:n}=i;if(!(n instanceof Node&&e.contains(n)))t(i)})};C(s,()=>{!this.updateModelTransform()&&this.updateViewTransformCoefficients()}),C(o,()=>{!this.updateModelOutputNames()&&this.updateViewOutputNames()}),C(d,()=>{!this.updateModelInputScales()&&this.updateViewInputScales()}),C(h,()=>{!this.updateModelOutputScales()&&this.updateViewOutputScales()}),sv(n,"cancel",e=>{this.curTransform=void 0,this.updateView(),e.target.blur()}),sv(s,"commit",()=>{this.updateModelTransform()}),sv(o,"commit",()=>{this.updateModelOutputNames()}),sv(d,"commit",()=>{this.updateModelInputScales()}),sv(h,"commit",()=>{this.updateModelOutputScales()}),n.addEventListener("focusin",e=>{let{target:t}=e;t instanceof HTMLInputElement&&t.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;void 0===e&&(e=Array(t)).fill(!1);let{coefficientElements:i,inputBoundsElements:n,inputScaleElements:r}=this;for(let s=0;s<t;++s){let a=e[s];for(let n=0;n<=t;++n){let r=i[t*n+s],o=n<t&&e[n];r.dataset.willBeDeleted=(a||o).toString()}r[s].dataset.willBeDeleted=a.toString();let{lower:o,upper:l}=n[s];o.dataset.willBeDeleted=a.toString(),l.dataset.willBeDeleted=a.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(0!==e.value.length||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(e=>e.value),{value:{sourceRank:i,rank:n},mutableSourceRank:r}=this.transform;if(e.length!==n+1)return;let s=tK(t),a=Array(n);a.fill(!1);for(let o=0;o<=n;++o){let n=s[o];0===t[o].length&&(r||o>=i)&&(n=!0,a[o]=!0),e[o].dataset.isValid=n.toString()}this.updateWillBeDeletedAttributes(a),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=void 0!==tf(e.value);e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(-1!==t)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(-1!==t)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:i}=this.transform.value;if(-1!==t)return{row:t%i,col:Math.floor(t/i)}}{let t=this.outputScaleElements.indexOf(e);if(-1!==t)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:i}=this.transform.value;if(-1===e)return t<0||t>=i?null:this.inputScaleElements[t];if(-2===t)return e<0||e>i?null:this.outputNameElements[e];if(-1===t)return e<0||e>=i?null:this.outputScaleElements[e];return e<0||e>=i||t<0||t>i?null:this.coefficientElements[t*i+e]}dimensionRefCount(e){return(tZ(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return fs(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return fs(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(e=>e.value),{value:t,mutableSourceRank:i}=this.transform,{outputSpace:n,rank:r,sourceRank:s}=t;if(e.length!==r+1)return;let a=[],o=[],l=0!==e[r].length,d=s;for(let t=0;t<=r;++t){let n=e[t];if(0===n.length){if(t<s){if(!i)return!1;--d}continue}o.push(n),a.push(t)}if(!tJ(o))return!1;let u=n.names;if(!l&&(0,Y.cO)(u,o))return!0;let c=t.inputSpace,h=t.outputSpace,p=t.transform;if(l){let t,i;this.addingSourceDimension&&++d;let s=e[r],a=(tZ(s)?this.localCombiner:this.globalCombiner).combined.value,o=a.names.indexOf(s);-1!==o?(t=a.units[o],i=a.scales[o]):(t="",i=1);let l=c.boundingBoxes.map(e=>tz(e,r,r+1));!this.addingSourceDimension&&l.push(tG(r+1,r)),c=tR({valid:c.valid,rank:r+1,names:[...c.names,""],ids:[...c.ids,++tE],timestamps:[...c.timestamps,Date.now()],scales:Float64Array.from([...c.scales,i]),units:[...c.units,t],boundingBoxes:l,coordinateArrays:[...c.coordinateArrays,void 0]}),h=tR({valid:n.valid,rank:r+1,names:[...n.names,s],ids:[...n.ids,++tE],timestamps:[...n.timestamps,Date.now()],scales:Float64Array.from([...n.scales,i]),units:[...n.units,t],coordinateArrays:[...n.coordinateArrays,void 0]}),p=(0,to.w9)(new Float64Array((r+2)**2),r+1,p,r)}p=t6(Float64Array,p,c.rank,a,a),c=t9(c,a);let g=(h=t9(h,a)).ids.map((e,t)=>{let i=a[t];if(i===r)return e;let n=o[t],s=u[i];return n===s||1===this.dimensionRefCount(s)&&this.dimensionRefCount(n)===(u.includes(n)?1:0)?e:++tE}),m=h.timestamps.map((e,t)=>{let i=a[t];return i===r||o[t]===u[i]?e:Date.now()}),f={rank:(h={...h,names:o,ids:g,timestamps:m}).rank,sourceRank:d,outputSpace:h,inputSpace:c,transform:p};return this.transform.value=f,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,i=new Float64Array((t+1)**2);i[i.length-1]=1;for(let n=0;n<t;++n)for(let r=0;r<=t;++r){let s=parseFloat(e[r*t+n].value);if(!Number.isFinite(s))return!1;i[r*(t+1)+n]=s}return this.transform.transform=i,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:i}=this,{names:n}=e;for(let e=0;e<t;++e){let t=i[e];t.value=n[e],t.dataset.isValid="true",m7(t)}i[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:i}=this;for(let n=0;n<t;++n)for(let r=0;r<=t;++r){let s=i[r*t+n];s.value=e[r*(t+1)+n].toString(),s.dataset.isValid="true",m7(s)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,i=e.sourceRank;if(this.curSourceRank===i&&this.curRank===t)return;let{inputBoundsElements:n,inputNameElements:r,inputScaleElements:s}=this,{element:a,coefficientElements:o,outputNameElements:l,outputScaleElements:d,outputScaleSuggestionElements:u,inputScaleSuggestionElements:c,outputBoundsElements:h,coefficientContainer:p,translationContainer:g,outputNameContainer:m,inputNameContainer:f,inputScaleContainer:v,inputLowerBoundsContainer:y,inputUpperBoundsContainer:b,outputScaleContainer:S}=this;a.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,a.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,sI(p),sI(g),p.appendChild(g),sI(m),sI(f),sI(v),sI(y),sI(b),sI(S),r.length=0,s.length=0,n.length=0,d.length=0,u.length=0,c.length=0,o.length=0,l.length=0,h.length=0;for(let e=0;e<t;++e){let t=t=>{t.classList.add("neuroglancer-coordinate-space-transform-input"),e>=i&&t.classList.add(m9)};{let i=document.createElement("div");i.classList.add("neuroglancer-coordinate-space-transform-input-name"),t(i),i.style.gridRowStart="sourceNames",i.style.gridColumnStart=`sourceDim ${e+1}`,f.appendChild(i),r.push(i)}{let{cellElement:i,inputElement:n,suggestionElement:r}=fi();i.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),t(i),i.style.gridRowStart="sourceScales",i.style.gridColumnStart=`sourceDim ${e+1}`,v.appendChild(i),s.push(n),c.push(r);let a=e;r.addEventListener("click",()=>{let e=ii(this.transform,a);void 0!==e&&(this.transform.inputSpace.value=fa(this.transform.inputSpace.value,a,e.scale,e.unit))})}{let i=document.createElement("div");t(i),i.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),i.style.gridRowStart="sourceLower",i.style.gridColumnStart=`sourceDim ${e+1}`,y.appendChild(i);let r=document.createElement("div");t(r),r.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),r.style.gridRowStart="sourceUpper",r.style.gridColumnStart=`sourceDim ${e+1}`,b.appendChild(r),n.push({lower:i,upper:r})}}for(let e=0;e<t;++e){for(let n=0;n<=t;++n){let r=document.createElement("input");r.classList.add("neuroglancer-coordinate-space-transform-coeff"),r.spellcheck=!1,r.autocomplete="off",r.size=1,r.style.gridRowStart=`outputDim ${e+1}`,r.placeholder=" ",r.style.gridColumnStart=`sourceDim ${n+1}`,o[n*t+e]=r,n===t?r.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):n===i&&r.classList.add(m9),(n===t?g:p).appendChild(r)}{let{cellElement:t,suggestionElement:i,inputElement:n}=fi();t.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),t.style.gridRowStart=`outputDim ${e+1}`,t.style.gridColumnStart="outputScales";let r=e;i.addEventListener("click",()=>{let{value:e}=this.transform,t=it(e,r);void 0!==t&&(this.transform.outputSpace.value=fa(e.outputSpace,r,t.scale,t.unit))}),u.push(i),S.appendChild(t),d.push(n)}{let t=document.createElement("div");t.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),t.style.gridRowStart=`outputDim ${e+1}`,t.style.gridColumnStart="outputNames";let n=fr();n.title="Rebind to a different dimension",e>=i?n.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(n.title+=", or delete to remove source dimension"),n.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",l.push(n),m.appendChild(t),t.appendChild(n);let r=document.createElement("div");r.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),t.appendChild(r);let s=document.createElement("div");s.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),t.appendChild(s),h.push({lower:r,upper:s}),t.addEventListener("mousedown",e=>{e.target!==n&&(n.focus(),e.preventDefault())})}}l.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",m.appendChild(this.addOutputDimensionCell),this.curSourceRank=i,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:i}=this.transform.value,{inputBoundsElements:n,inputNameElements:r,inputScaleElements:s,inputScaleSuggestionElements:a}=this,{names:o,scales:l,units:d,bounds:{lowerBounds:u,upperBounds:c,voxelCenterAtIntegerCoordinates:h}}=e;for(let e=0;e<t;++e){let t;let p=s[e],g=l[e],m=d[e];if(p.value=tm(g,m,{elide1:!1}),p.dataset.isValid="true",m7(p),e<i){let i=o[e];!i&&(i=`${e}`),r[e].textContent=i,t=`source dimension ${i}`,p.title=`Override scale of ${t}`}else t="singleton dimension",p.title=`Set extent of ${t}`;let{lower:f,upper:v}=fe(u[e],c[e],h[e]),y=n[e];y.lower.textContent=f,y.lower.title=`Lower bound of ${t}`,y.upper.title=`Upper bound of ${t}`,y.upper.textContent=v,fn(a[e],ii(this.transform,e),g,m,`Revert scale of ${t} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:i,units:n,scales:r,bounds:{lowerBounds:s,upperBounds:a,voxelCenterAtIntegerCoordinates:o}}=e.outputSpace,{outputScaleElements:l,outputBoundsElements:d,outputScaleSuggestionElements:u}=this;for(let c=0;c<t;++c){let t=l[c],h=r[c],p=n[c];t.value=tm(h,p,{elide1:!1}),m7(t);let g=i[c];t.dataset.isValid="true";let m=`Change coordinates of ${tZ(g)?"local":"global"} dimension ${g}`;t.title=`${m} (does not rescale the source)`;let{lower:f,upper:v}=fe(s[c],a[c],o[c]),y=d[c];y.lower.textContent=f,y.upper.textContent=v,fn(u[c],it(e,c),h,p,`${m} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:i,mutableSourceRank:n,defaultTransform:r}}=this,{rank:s}=i;this.resetToIdentityButton.style.visibility=e||!(0,to.GU)(i.transform,s+1,s+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!n&&(e||t||!function(e,t){let{rank:i,sourceRank:n}=e;if(i!==t.rank||n!==t.sourceRank)return!1;let{inputSpace:r}=e,{inputSpace:s}=t;return!!((0,Y.cO)(s.scales,r.scales)&&(0,Y.cO)(s.units,r.units)&&(0,Y.cO)(t.outputSpace.names,e.outputSpace.names))&&t0(e.transform,i,e.outputSpace.scales,t.transform,i,t.outputSpace.scales)}(r,i))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){sR(this.element),super.disposed()}}i("4939");let fl="neuroglancer-multiline-autocomplete-completion-active";function fd(e){let t=document.createElement("div");return t.textContent=e.value,t}function*fu(e){for(;e.length>0;){let t=e.match(/[:/_]+/);if(null===t){yield e;return}let i=t.index+t[0].length;yield e.substring(0,i),e=e.substring(i)}}function fc(e){let t=document.createElement("div");t.className="neuroglancer-multiline-autocomplete-completion-with-description",t.textContent=e.value;let i=document.createElement("div");return i.className="neuroglancer-multiline-autocomplete-completion-description",i.textContent=e.description||"",t.appendChild(i),t}let fh=sh.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}});class fp extends ef.gj{element=document.createElement("div");inputElement=document.createElement("span");hintElement=document.createElement("span");completionsVirtualList=void 0;onCommit=new ez.MZ;onInput=new ez.MZ;prevInputValue="";completionsVisible=!1;activeCompletionPromise=null;activeCompletionAbortController=void 0;hasFocus=!1;completionResult=null;dropdownContentsStale=!0;hasResultForDropdown=!1;commonPrefix="";completionDisabled=-1;disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=void 0!==e&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(null===e||0===e.rangeCount)return;let t=e.getRangeAt(0),{inputElement:i}=this,n=document.createRange();n.setStart(i,0),n.setEnd(t.startContainer,t.startOffset);let r=n.toString().length;return{begin:r,end:r+e.toString().length}}setValueAndSelection(e,t){let i=-1!==this.completionDisabled;this.onInput.dispatch(e);let{inputElement:n}=this;sI(n);let r=0,s=void 0!==t?document.createRange():void 0,a=!0;for(let i of fu(e)){!a&&n.appendChild(document.createElement("wbr")),a=!1;let e=r+i.length,o=document.createTextNode(i);if(n.appendChild(o),void 0!==s){let{begin:i,end:n}=t;i>=r&&i<=e&&s.setStart(o,i-r),n>=r&&n<=e&&s.setEnd(o,n-r)}r=e}if(void 0!==s){a&&(s.setStart(n,0),s.setEnd(n,0));let e=window.getSelection();null!==e&&(e.removeAllRanges(),e.addRange(s))}this.completionDisabled=i&&void 0!==t&&t.end===t.begin?t.end:-1}activeIndex=-1;dropdownStyleStale=!0;scheduleUpdateCompletions;completer;resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()};resizeObserver=new ResizeObserver(this.resizeHandler);constructor(e){super(),this.completer=e.completer;let{delay:t=200}=e,i=this.scheduleUpdateCompletions=(0,ic.Z)(()=>{let e=this.activeCompletionAbortController=new AbortController,t=this.activeCompletionPromise=this.completer({value:this.value,selectionRange:this.getSelectionRange()},e.signal);null!==t&&t.then(e=>{this.activeCompletionPromise===t&&(this.setCompletions(e),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{i.cancel()});let{element:n,inputElement:r,hintElement:s}=this;n.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(n),this.registerDisposer(()=>this.resizeObserver.unobserve(r)),r.contentEditable="true",r.spellcheck=!1,n.appendChild(document.createTextNode("​")),n.appendChild(r),n.appendChild(s),r.classList.add("neuroglancer-multiline-autocomplete-input"),s.classList.add("neuroglancer-multiline-autocomplete-hint"),r.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),r.addEventListener("copy",e=>{let{clipboardData:t}=e;if(null!==t){let e=window.getSelection();null!==e&&!e.isCollapsed&&e.containsNode(r,!0)&&t.setData("text/plain",e.toString())}e.preventDefault(),e.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let e=this.getSelectionRange(),{completionDisabled:t}=this;if(void 0===e||e.begin!==t||e.end!==t)this.completionDisabled=-1,this.debouncedUpdateHintState()}),this.setValueAndSelection(""),this.updateHintState(),n.addEventListener("pointerdown",e=>{let{target:t}=e;if(t instanceof Node){if(r.contains(t))return;let{completionsVirtualList:e}=this;if(e?.element.contains(t))return}r===document.activeElement&&(this.moveCaretToEndOfInput(),e.stopPropagation(),e.preventDefault())}),n.addEventListener("click",()=>{r.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let e=document.createRange(),{childNodes:t}=r;e.setStart(r,0),0===t.length?e.setEnd(r,0):e.setEndAfter(t[t.length-1]);let i=window.getSelection();null!==i&&(i.removeAllRanges(),i.addRange(e)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus)this.hasFocus=!1,this.updateDropdown();this.debouncedUpdateHintState();let e=window.getSelection();null!==e&&e.containsNode(this.inputElement,!0)&&e.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0}),this.registerDisposer(new aq(r,fh)).allShortcutsAreGlobal=!0,sv(r,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),sv(r,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),sv(r,"home",()=>{this.moveCaretToBeginningOfInput()}),sv(r,"end",()=>{this.moveCaretToEndOfInput()}),sv(r,"choose-active-completion-or-prefix",e=>{this.selectActiveCompletion(!0)&&e.preventDefault()}),sv(r,"commit",e=>{if(this.selectActiveCompletion(!1))e.stopPropagation();else{let e=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,e)}}),sv(r,"cancel",e=>{e.stopPropagation(),this.cancel()&&(e.detail.preventDefault(),e.detail.stopPropagation())})}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return void 0!==t&&t.end===t.begin&&t.end!==this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}debouncedUpdateHintState=this.registerCancellable((0,ic.Z)(()=>this.updateHintState(),0));updateHintState(){if(this.debouncedUpdateHintState.cancel(),!this.shouldAttemptCompletion()){this.hideCompletions();return}let{value:e}=this;if(e!==this.prevInputValue)this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(void 0===t)return;let i=t.element;for(let t=e.target;t instanceof HTMLElement&&t!==i;t=t.parentElement){let e=t.dataset.completionIndex;if(void 0!==e){this.selectCompletion(Number(e));break}}}cycleActiveCompletion(e){if(null===this.completionResult)return;let{activeIndex:t}=this,i=this.completionResult.completions.length;t=-1===t?e>0?0:i-1:(t+e+i)%i,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return null!==e&&!!this.hasFocus&&this.hasResultForDropdown}updateDropdownStyle(){let{completionsVirtualList:e,element:t}=this;void 0!==e&&!function(e,t,{horizontal:i=!1,vertical:n=!0,topMargin:r=6,bottomMargin:s=6,leftMargin:a=6,rightMargin:o=6,maxHeight:l=!0,maxWidth:d=!0}={}){let u=t.getBoundingClientRect();if(i){let t=e.ownerDocument.documentElement.clientWidth,i=u.right,n=t-u.left;i>n?(e.style.left="",e.style.right=`${t-u.right}px`,d&&(e.style.maxWidth=i-a+"px")):(e.style.right="",e.style.left=`${u.left}px`,d&&(e.style.maxWidth=n-o+"px"))}if(n){let t=e.ownerDocument.documentElement.clientHeight,i=u.top-r,n=t-u.bottom-s;e.style.left=`${u.left}px`,e.style.width=`${u.width}px`,e.style.maxWidth=`${u.width}px`,i>3*n?(e.style.top="",e.style.bottom=`${t-u.top}px`,l&&(e.style.maxHeight=i+"px")):(e.style.top=`${u.bottom}px`,e.style.bottom="",l&&(e.style.maxHeight=n+"px"))}}(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){void 0!==e&&e.dispose();let t=this.completionResult,{makeElement:i=fd}=t;(e=this.completionsVirtualList=new gO({source:{length:t.completions.length,render:e=>{let n=t.completions[e],r=i.call(t,n);return r.classList.add("neuroglancer-multiline-autocomplete-completion"),r.dataset.completionIndex=`${e}`,this.activeIndex===e&&r.classList.add(fl),r}},selectedIndex:-1===this.activeIndex?void 0:this.activeIndex})).element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",e=>{this.inputElement.focus(),e.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),!this.completionsVisible&&(this.completionsVisible=!0);let{activeIndex:t}=this;-1!==t&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(void 0!==e&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(0===t.length)return;let i=this.prevInputValue;if(void 0!==i){if(this.completionResult=e,1===t.length){let n=t[0];e.showSingleResult?this.hasResultForDropdown=!0:n.value.startsWith(i)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let t=function(e){let t=e[Symbol.iterator](),{value:i,done:n}=t.next();if(n)return"";let r=i.length;for(;r>0;){let{value:e,done:n}=t.next();if(n)break;let s=0;for(;s<r&&i.charCodeAt(s)===e.charCodeAt(s);++s);r=s}return i.substring(0,r)}(function*(){for(let t of e.completions)yield t.value}()),n=this.getCompletedValue(t);n.startsWith(i)&&(this.commonPrefix=n,this.setHintValue(n))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(void 0===t)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);let{hintElement:i}=this;sI(i);let n=!0;for(let t of fu(e)){!n&&i.appendChild(document.createElement("wbr")),n=!1;let e=document.createTextNode(t);i.appendChild(e)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:i}=this;if(void 0!==i){if(-1!==t){let e=i.getItemElement(t);void 0!==e&&e.classList.remove(fl)}if(-1!==e){let t=i.getItemElement(e);void 0!==t&&t.classList.add(fl),i.scrollItemIntoView(e)}}}-1!==e&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,i=this.prevInputValue;return void 0===i?"":i.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let i=window.getSelection();null!==i&&(i.removeAllRanges(),i.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:i}=t,n=i[i.length-1];void 0===n?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(n),e.setEndAfter(n));let r=window.getSelection();null!==r&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(-1===t){if(!e)return!1;let{completionResult:i}=this;if(null!==i&&1===i.completions.length)t=0;else{let{commonPrefix:e}=this;return!!(e.length>this.value.length)&&(this.value=e,this.moveCaretToEndOfInput(),!0)}}let i=this.getCompletedValueByIndex(t);return this.value!==i&&(this.value=i,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0,this.activeCompletionAbortController?.abort(),this.activeCompletionAbortController=void 0,this.activeCompletionPromise=null}clearCompletions(){if(null!==this.completionResult){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";let{completionsVirtualList:e}=this;void 0!==e&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;void 0!==e&&e.dispose(),sR(this.element),this.cancelActiveCompletion(),super.disposed()}}class fg extends fp{dataSourceView;dirty;constructor(e){let{manager:t}=e.source.layer;super({completer:({value:e},i)=>t.dataSourceProviderRegistry.completeUrl({url:e,chunkManager:t.chunkManager,abortSignal:i}).then(e=>({completions:e.completions,makeElement:fc,offset:e.offset,showSingleResult:!0})),delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new Z.SN(!1);let i=e=>{e!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class fm extends ef.gj{model;element;generation;constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>sR(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:i}=this;sI(i);let n=new Set;for(let t of e){let e=`${t.severity} ${t.message}`;if(n.has(e))continue;n.add(e);let r=document.createElement("li");i.appendChild(r),r.classList.add("neuroglancer-message"),r.classList.add(`neuroglancer-message-${iO[t.severity]}`),r.textContent=t.message}}}class ff extends ef.gj{loadedSubsource;element;constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");let{element:i}=this;i.classList.add("neuroglancer-layer-data-source-subsource");let n=document.createElement("label"),r=document.createElement("span"),s=()=>{n.dataset.isActive=(void 0!==t.activated||!t.enabled).toString()};s(),this.registerDisposer(t.isActiveChanged.add(s)),this.registerDisposer(e.enabledSubsourcesChanged.add(s));let a=this.registerDisposer(new nr({get value(){return t.enabled},set value(value){t.enabled=value,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));n.classList.add("neuroglancer-layer-data-sources-info-line"),n.appendChild(a.element);let o=document.createElement("span");o.classList.add("neuroglancer-layer-data-sources-source-id");let{id:l}=t.subsourceEntry;"default"!==l&&(o.textContent=l),n.appendChild(o),r.classList.add("neuroglancer-layer-data-sources-source-type");let d=this.registerDisposer(new fm(this.loadedSubsource.messages));i.appendChild(n),n.appendChild(r),i.appendChild(d.element);let u="",{subsource:c}=t.subsourceEntry,{volume:h}=c;if(h instanceof pM)u=`${ec[h.dataType].toLowerCase()} volume`;else if(c.mesh instanceof hL)u="meshes (single-res.)";else if(c.mesh instanceof hV)u="meshes (multi-res.)";else if(c.mesh instanceof px)u="skeletons";else if(void 0!==c.segmentPropertyMap)u="segment property map";else if(void 0!==c.local)switch(c.local){case l7.annotations:u="Local annotations";break;case l7.equivalences:u="local segmentation graph"}else void 0!==c.staticAnnotations?u="default annotations":void 0!==c.annotation?u="annotations":void 0!==c.singleMesh?u="single mesh":void 0!==c.segmentationGraph&&(u="segmentation graph");r.textContent=u}}class fv extends ef.gj{source;element;constructor(e){super(),this.source=e,this.element=document.createElement("div");let{element:t}=this,i=document.createElement("label");for(let n of(i.classList.add("neuroglancer-layer-data-sources-source-default"),i.appendChild(this.registerDisposer(new nr({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(value){if(e.enableDefaultSubsources===value)return;if(e.enableDefaultSubsources=value,value)for(let t of e.subsources)t.enabled=t.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}})).element),i.appendChild(document.createTextNode("Enable default subsource set")),i.title="Enable the default set of subsources for this data source.",t.appendChild(i),e.subsources))t.appendChild(this.registerDisposer(new ff(e,n)).element);let{transform:n}=e;if(n.mutableSourceRank||0!==n.value.sourceRank){let t=this.registerDisposer(new fo(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(t.element)}this.registerDisposer(()=>sR(this.element))}}class fy extends ef.gj{tab;source;element;urlInput;seenGeneration;generation;loadedView;constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;let i=this.urlInput=this.registerDisposer(new fg(this));i.onCommit.add((t,n)=>{let{source:r}=this,s=r.spec,a=this.source.layer;if((t=a.manager.dataSourceProviderRegistry.normalizeUrl({url:t}))!==i.value&&(i.disableCompletion(),i.setValueAndSelection(t,{begin:t.length,end:t.length})),i.dirty.value=!1,t&&t===s.url){n&&void 0!==e.detectedLayerConstructor&&fb(r.layer);return}if(a instanceof ui)try{let e=a.manager.dataSourceProviderRegistry.suggestLayerName(t);d7(a.managedLayer,e)}catch{}r.spec={...s,url:t}});let{element:n}=this;n.classList.add("neuroglancer-layer-data-source"),n.appendChild(i.element),n.appendChild(this.registerDisposer(new fm(t.messages)).element),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:i}=this;if(void 0!==i){if(i.source===t)return;i.dispose(),i=this.loadedView=void 0}t instanceof dh&&(i=this.loadedView=new fv(t),this.element.appendChild(i.element))}disposed(){let{loadedView:e}=this;void 0!==e&&e.dispose(),sR(this.element),super.disposed()}}function fb(e){if(e instanceof ui){let t=e.detectedLayerConstructor;if(void 0!==t)return d8(e.managedLayer,t),!0}return!1}class fS extends s_{layer;generation;sourceViews;addDataSourceIcon;layerTypeDetection;layerTypeElement;dataSourcesContainer;reRender;constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new Map,this.addDataSourceIcon=gI({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:i}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),i.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:n}=this;if(n.style.alignSelf="start",n.addEventListener("click",()=>{let e=this.layer.addDataSource(void 0);this.updateView();let t=this.sourceViews.get(e);void 0!==t&&t.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof ui){let{layerTypeDetection:i,layerTypeElement:n}=this;i.style.display="none",n.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),i.appendChild(document.createTextNode("Create as ")),i.appendChild(n),i.appendChild(document.createTextNode(" layer")),t.appendChild(i),i.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),i.addEventListener("click",()=>{fb(e)})}let r=this.reRender=(0,iS.H)(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(r)),this.registerDisposer(this.visibility.changed.add(r)),this.updateView()}detectedLayerConstructor;updateLayerTypeDetection(){let e=(()=>{let e=this.layer;if(!(e instanceof ui))return;let t=e.detectedLayerConstructor;if(void 0!==t){for(let e of this.sourceViews.values())if(e.urlInput.dirty.value)return;return t}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,void 0!==e){let{layerTypeElement:i}=this;i.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:i}=this,{layer:n}=this;for(let[e,r]of(sM(this.dataSourcesContainer,(function*(){let e=!0,{dataSources:r}=n;for(let n of r){let s=i.get(n);void 0===s&&((s=new fy(this,n)).registerDisposer(s.urlInput.dirty.changed.add(this.reRender)),i.set(n,s)),s.seenGeneration=t,s.updateView();let a=n.spec.url;1===r.length&&""===a&&setTimeout(()=>{s.urlInput.inputElement.focus()},0),e=0===n.spec.url.length,yield s.element}!e&&(yield this.addDataSourceIcon)}).call(this)),i))r.seenGeneration!==t&&(r.dispose(),i.delete(e))}this.updateLayerTypeDetection()}}dA.push({id:"source",label:"Source",order:-100,getter:e=>new fS(e)});class fw extends ef.gj{ref;element;selectElement;constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);let{element:t,selectElement:i}=this;t.appendChild(i),this.updateView(),this.registerEventListener(i,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,ic.Z)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:i}=t;sI(e);let n=document.createElement("option");for(let t of(e.appendChild(n),this.ref.layerManager.managedLayers))if(i(t)){let i=document.createElement("option"),{name:n}=t;i.textContent=n,i.value=n,e.appendChild(i)}e.value=t.layerName||""}}let fC="annotations",fx="annotationProperties",fE="annotationRelationships",fT="crossSectionAnnotationSpacing",fk="projectionAnnotationSpacing",fD="shader",fP="shaderControls";function fL(e){let t=e.layer;return null===t||t instanceof m5||!1}let fI="linkedSegmentationLayer",fR="filterBySegmentation",fA="ignoreNullSegmentFilter",fM="swapVisbleSegmentsOnMove";class fN extends ef.gj{layerManager;annotationStates;annotationDisplayState;changed;curGeneration;wasLoading;constructor(e,t,i){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=i,this.changed=new ez.K_,this.curGeneration=-1,this.wasLoading=void 0,this.map=new Map,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:i}=this,n=!1;for(let t of this.annotationStates.relationships){let r=i.get(t);void 0===r&&(r=this.addRelationship(t),n=!0),r.seenGeneration=e}if(!t){let{relationshipStates:t}=this.annotationDisplayState;for(let[r,s]of i)s.seenGeneration!==e&&(i.delete(r),t.delete(r),n=!0)}n&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),i=new dq(this.layerManager.addRef(),fL);i.registerDisposer(i.changed.add(()=>{t.segmentationState.value=void 0===i.layerName?void 0:function(e){if(void 0===e)return null;let t=e.layer;return null!==t&&t instanceof m5?t.displayState:null}(i.layer)}));let{showMatches:n}=t,r={layerRef:i,showMatches:n,seenGeneration:-1};return i.changed.add(this.changed.dispatch),n.changed.add(this.changed.dispatch),this.map.set(e,r),r}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let e,{map:t}=this;if(0===t.size)return{};let i=[];for(let[n,r]of t){r.showMatches.value&&i.push(n);let{layerName:t}=r.layerRef;void 0!==t&&((e=e||{})[n]=t)}return i.sort(),{[fI]:e,[fR]:0===i.length?void 0:i}}restoreState(e){let{isLoading:t}=this.annotationStates;(0,eb.Kh)(e,fI,e=>{for(let i of("string"==typeof e&&(e={segments:e}),(0,eb.PT)(e),Object.keys(e))){let n=(0,eb.ZE)(e[i]),r=this.map.get(i);if(void 0===r){if(!t)continue;r=this.addRelationship(i)}r.layerRef.layerName=n}for(let[t,i]of this.map)!Object.prototype.hasOwnProperty.call(e,t)&&(i.layerRef.layerName=void 0)}),(0,eb.Kh)(e,fR,e=>{for(let i of("boolean"==typeof e&&(e=!0===e?["segments"]:[]),(0,eb.zE)(e))){let e=this.map.get(i);if(void 0===e){if(!t)continue;e=this.addRelationship(i)}e.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}map}class fV extends ef.gj{relationship;state;element;seenGeneration;constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;let{element:i}=this,n=this.registerDisposer(new nr(t.showMatches)),r=new fw(t.layerRef);i.appendChild(n.element),i.appendChild(document.createTextNode(e)),i.appendChild(r.element)}}class fO extends ef.gj{linkedSegmentationLayers;widgets;element;constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new Map,this.element=document.createElement("div"),this.element.style.display="contents";let t=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,i=t.changed.count,{widgets:n}=this;for(let[e,t]of n)t.seenGeneration!==i&&(t.dispose(),n.delete(e));sM(this.element,(function*(){for(let r of t.relationships){let t=n.get(r);void 0===t&&(t=new fV(r,e.get(r))),t.seenGeneration=i,yield t.element}}).call(this))}disposed(){for(let e of(super.disposed(),this.widgets.values()))e.dispose()}}function f_(e){let{localAnnotations:t}=e;if(t){let i=e.manager.root.selectionState.value?.layers.find(t=>t.layer===e);if(i&&i.state.annotationId)return t.get(i.state.annotationId)}}function fF(e,t){let i=e.getReference(t.id);e.update(i,t),e.commit(i)}class fB extends ax{propertyIdentifier;static TOOL_ID="tagTool";constructor(e,t){super(t,!0),this.propertyIdentifier=e}get tag(){let{localAnnotations:e}=this.layer;if(e){let t=e.properties.value.find(e=>e.identifier===this.propertyIdentifier);if(t&&eJ(t))return t.tag}return"unknown"}activate(e){let{localAnnotations:t}=this.layer;if(!t)return;let i=f_(this.layer);if(i){let{propertyIdentifier:e}=this,n=t.properties.value.findIndex(t=>t.identifier===e);n>-1&&(i.properties[n]=1-i.properties[n],fF(t,i))}e.cancel()}toJSON(){return`${fB.TOOL_ID}_${this.propertyIdentifier}`}get description(){return`tag ${this.tag}`}}class fU extends s_{layer;tools;constructor(e){super(),this.layer=e,this.tools=new Set;let{element:t}=this;t.classList.add("neuroglancer-tags-tab");let{localAnnotations:i}=e;if(!i)return;let{properties:n}=i,r=document.createElement("div");r.classList.add("neuroglancer-tags-container"),t.appendChild(r);let s=0,a=[],o=new i_,l=e=>(o.clearMessages(),!a.includes(e)||(o.addMessage({severity:iO.error,message:`tag: "${e}" already exists`}),!1)),d=e=>{let{properties:t}=e,i=-1;for(let e of t.value){let t=e.identifier.match(/tag([\d]+)/);i++,t&&t.length>1&&(i=parseInt(t[1]))}return`tag${i+1}`},u=e=>{let{value:t}=e;e.validity.valid&&l(t)&&i.addProperty({type:"uint8",tag:t,default:0,description:void 0,identifier:d(i)})},c={length:1,render:t=>{let r=document.createElement("div");r.classList.add("neuroglancer-tag-list-entry");let a=document.createElement("input");if(a.required=!0,r.append(a),t===c.length-1){r.classList.add("add");let t=a_(this,e.toolBinder,{toolJson:`${fB.TOOL_ID}__invalid`});r.prepend(t),a.placeholder="Tag name",s<c.length&&setTimeout(()=>{a.focus()},0),a.addEventListener("keyup",e=>{"Enter"===e.key&&u(a)});let i=gI({title:"Add additional tag",onClick:()=>u(a)});r.append(i),s=c.length}else{let s=i.getTagProperties()[t],{tag:o}=s,d=a_(this,e.toolBinder,{toolJson:`${fB.TOOL_ID}_${s.identifier}`,title:`Tag selected annotation with ${o}`});r.prepend(d),a.value=o,a.addEventListener("change",()=>{let{value:e}=a;if(!l(e)||!confirm(`Rename tag ${o} to ${e}?`)){a.value=o;return}s.tag=e,n.changed.dispatch();let t=f_(this.layer);t&&fF(i,t)});let u=gA({title:"Delete tag",onClick:e=>{e.stopPropagation(),e.preventDefault(),confirm(`Delete tag ${o}?`)&&i.removeProperty(s.identifier);let t=f_(this.layer);t&&fF(i,t)}});u.classList.add("neuroglancer-tag-list-entry-delete"),r.append(u)}return r},changed:new ez.K_},h=this.registerDisposer(new gO({source:c}));r.appendChild(h.element);let p=this.registerDisposer(new fm(o));r.appendChild(p.element),h.body.classList.add("neuroglancer-tag-list"),h.element.classList.add("neuroglancer-tag-list-outer");let g=()=>{let e=1,t=0,n=0,r=i.getTagProperties().map(e=>e.tag);for(let t of r)a.includes(t)?e++:n++;for(let e of a)!r.includes(e)&&t++;c.length=r.length+1,a=r,(t>0||n>0)&&c.changed.dispatch([{retainCount:e,deleteCount:t,insertCount:n}])};this.registerDisposer(n.changed.add(g)),g()}}let f$=g6(dM);class fG extends f${localAnnotations;localAnnotationProperties=new Z.SN([]);localAnnotationRelationships;localAnnotationsJson=void 0;pointAnnotationsJson=void 0;tagTools=[];linkedSegmentationLayers=this.registerDisposer(new fN(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));disposed(){let{localAnnotations:e}=this;void 0!==e&&e.dispose(),super.disposed()}constructor(e){super(e),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.annotationProjectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.registerDisposer(this.localAnnotationProperties.changed.add(()=>{let{localAnnotations:e}=this;if(e){let t=e.getTagProperties().map(e=>e.identifier);this.syncTagTools(t)}})),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new fW(this)});let t=this.registerDisposer(new Z.x2(()=>void 0===this.localAnnotations,this.dataSourcesChanged));this.tabs.add("tags",{label:"Tags",order:10,getter:()=>new fU(this),hidden:t}),this.tabs.default="annotations"}syncTagTools=e=>{for(let t of this.tagTools)if(!e.includes(t))for(let[e,i]of(!function(e,t){let{prototype:i}=e,n=aD.get(i);n&&n.delete(t)}(fG,`${fB.TOOL_ID}_${t}`),this.toolBinder.bindings.entries()))i instanceof fB&&i.propertyIdentifier===t&&this.toolBinder.deleteTool(e);for(let t of(this.tagTools=this.tagTools.filter(t=>e.includes(t)),e))!this.tagTools.includes(t)&&(this.tagTools.push(t),aL(fG,`${fB.TOOL_ID}_${t}`,e=>new fB(t,e)))};restoreState(e){let t=(0,eb.Kh)(e,fx,e4);t&&this.syncTagTools(t.filter(eJ).map(e=>e.identifier)),super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[fC],t&&(this.localAnnotationProperties.value=t||[]),this.localAnnotationRelationships=(0,eb.Kh)(e,fE,eb.zE,["segments"]),this.pointAnnotationsJson=e.points,this.annotationCrossSectionRenderScaleTarget.restoreState(e[fT]),this.annotationProjectionRenderScaleTarget.restoreState(e[fk]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[fA]),this.annotationDisplayState.swapVisibleSegmentsOnMove.restoreState(e[fM]),this.annotationDisplayState.shader.restoreState(e[fD]),this.annotationDisplayState.shaderControls.restoreState(e[fP])}getLegacyDataSourceSpecifications(e,t,i,n){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,i,n);let r=(0,eb.Kh)(t,"voxelSize",e=>(0,eb.Iw)(new Float64Array(3),e,e=>(0,eb.o7)(e)/1e9));if(void 0!==r){let e=tR({rank:3,units:["m","m","m"],scales:r,names:["x","y","z"]});i=void 0===i?{outputSpace:e,sourceRank:3,transform:void 0,inputSpace:e}:{...i,inputSpace:e}}return[{url:dt,transform:i,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){let t,i=!1;for(let n of e){let{subsourceEntry:e}=n,{local:r}=e.subsource,s=e=>void 0!==t&&(0,eb.hd)(e.value)!==(0,eb.hd)(t.value)?(n.deactivate("Annotation properties are not compatible"),!1):(t=e,!0);if(r===l7.annotations){if(i){n.deactivate("Only one local annotations source per layer is supported");continue}if(i=!0,!s(this.localAnnotationProperties))continue;n.activate(t=>{let i=this.localAnnotations=new ti(n.loadedDataSource.transform,this.localAnnotationProperties,this.localAnnotationRelationships);try{i.restoreState(this.localAnnotationsJson)}catch{}t.registerDisposer(()=>{i.dispose(),this.localAnnotations=void 0}),t.registerDisposer(this.localAnnotations.changed.add(()=>{this.specificationChanged.dispatch()}));try{!function(e,t){if(void 0!==t)(0,eb.m7)(t,(t,i)=>{e.add({type:eW.POINT,id:""+i,point:(0,eb.ET)(t),properties:[]})})}(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let r=new oj({localPosition:this.localPosition,transform:t.registerDisposer(ia(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,n.loadedDataSource.transform,void 0)),source:i.addRef(),displayState:this.annotationDisplayState,dataSource:n.loadedDataSource.layerDataSource,subsourceIndex:n.subsourceIndex,subsourceId:e.id,role:i8.ANNOTATION});this.addAnnotationLayerState(r,n)});continue}let{annotation:a}=e.subsource;if(void 0!==a){if(!s(a.properties))continue;n.activate(()=>{let t=new oj({localPosition:this.localPosition,transform:n.getRenderLayerTransform(),source:a,displayState:this.annotationDisplayState,dataSource:n.loadedDataSource.layerDataSource,subsourceIndex:n.subsourceIndex,subsourceId:e.id,role:i8.ANNOTATION});this.addAnnotationLayerState(t,n)});continue}n.deactivate("Not compatible with annotation layer")}t&&(0,eb.hd)(this.annotationDisplayState.annotationProperties.value)!==(0,eb.hd)(t?.value)&&(this.registerDisposer(t.changed.add(()=>{this.annotationDisplayState.annotationProperties.value=[...t.value]})),this.annotationDisplayState.annotationProperties.value=[...t.value])}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer((0,Z.og)(e=>e.some(e=>e.source instanceof lQ),this.annotationStates)),i=e.registerDisposer(new aY(t,(e,t,i)=>{if(e){{let e=i.registerDisposer(new u$(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));e.label.textContent="Spacing (cross section)",t.appendChild(e.element)}{let e=i.registerDisposer(new u$(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));e.label.textContent="Spacing (projection)",t.appendChild(e.element)}}}));e.element.insertBefore(i.element,e.element.firstChild);{let t=e.registerDisposer(new nr(this.annotationDisplayState.ignoreNullSegmentFilter)),i=document.createElement("label");i.appendChild(document.createTextNode("Ignore null related segment filter")),i.title="Display all annotations if filtering by related segments is enabled but no segments are selected",i.appendChild(t.element),e.element.appendChild(i)}{let t=e.registerDisposer(new nr(this.annotationDisplayState.swapVisibleSegmentsOnMove)),i=document.createElement("label");i.appendChild(document.createTextNode("Swap visible segments when moving to annotation")),i.title="Swap visible segments when moving to annotation",i.appendChild(t.element),e.element.appendChild(i)}e.element.appendChild(e.registerDisposer(new fO(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[fT]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[fk]=this.annotationProjectionRenderScaleTarget.toJSON(),void 0!==this.localAnnotations?e[fC]=this.localAnnotations.toJSON():void 0!==this.localAnnotationsJson&&(e[fC]=this.localAnnotationsJson),e[fx]=function(e){if(void 0!==e&&0!==e.length)return e.map(e3)}(this.localAnnotationProperties.value);let{localAnnotationRelationships:t}=this;return e[fE]=1===t.length&&"segments"===t[0]?void 0:t,e[fA]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[fM]=this.annotationDisplayState.swapVisibleSegmentsOnMove.toJSON(),e[fD]=this.annotationDisplayState.shader.toJSON(),e[fP]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}static type="annotation";static typeAbbreviation="ann"}function fz(e){return new m$({shaderError:e.annotationDisplayState.shaderError,fragmentMain:e.annotationDisplayState.shader,shaderControlState:e.annotationDisplayState.shaderControls})}class fj extends mP{layer;codeWidget;constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(fz(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}class fW extends s_{layer;codeWidget;constructor(e){super(),this.layer=e;let{element:t}=this;this.codeWidget=this.registerDisposer(fz(this.layer)),t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new aY(e.annotationDisplayState.annotationProperties,(e,t)=>{if(void 0===e||0===e.length)return;let i=document.createElement("div");for(let n of(t.appendChild(i),i.classList.add("neuroglancer-annotation-shader-property-list"),e)){let e=document.createElement("div");e.classList.add("neuroglancer-annotation-shader-property");let t=document.createElement("span");t.classList.add("neuroglancer-annotation-shader-property-type"),t.textContent=n.type;let r=document.createElement("span");r.classList.add("neuroglancer-annotation-shader-property-identifier"),r.textContent=`prop_${n.identifier}`,e.appendChild(t),e.appendChild(r);let{description:s}=n;if(void 0!==s&&(e.title=s),eJ(n)){let t=document.createElement("span");t.classList.add("neuroglancer-annotation-tag-property-type"),t.textContent=`(${n.tag})`,e.appendChild(t)}i.appendChild(e)}})).element);let i=document.createElement("div");i.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let n=document.createElement("div");n.style.flex="1",n.textContent="Annotation shader:",i.appendChild(n),i.appendChild(mA({title:"Show larger editor view",onClick:()=>{new fj(this.layer)}})),i.appendChild(mL({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/annotation/rendering.md"})),t.appendChild(i),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new mj(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}}d4(fG),d4(fG,"pointAnnotation"),d6(e=>e.local===l7.annotations?{layerConstructor:fG,priority:100}:void 0!==e.annotation?{layerConstructor:fG,priority:1}:void 0),mJ(fG,e=>({shaderControlState:e.annotationDisplayState.shaderControls})),i("320");var fq=((G={})[G.DEFAULT=0]="DEFAULT",G[G.ADDITIVE=1]="ADDITIVE",G);let fH=new Map([[0,e=>{e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}],[1,e=>{e.blendFunc(e.SRC_ALPHA,e.ONE)}]]),fJ=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function fK(e,t){e.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
void emitIntensity(float value) {
}
`),e.addFragmentCode(o9),ok(t,e),e.setFragmentMainFunction(nx(t.parseResult.code))}class fZ extends pG{opacity;blendMode;shaderControlState;constructor(e,t){let{opacity:i,blendMode:n,shaderControlState:r}=t;super(e,{...t,fallbackShaderParameters:new Z.SN(oO(oE(fJ,{imageData:{dataType:e.dataType,channelRank:t.channelCoordinateSpace?.value?.rank??0}}))),encodeShaderParameters:e=>e.key,shaderParameters:r.builderState,dataHistogramSpecifications:r.histogramSpecifications}),this.shaderControlState=r,this.opacity=i,this.blendMode=n,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),fK(e,t)}initializeShader(e,t,i){let{gl:n}=this;n.uniform1f(t.uniform("uOpacity"),this.opacity.value),oB(n,t,this.shaderControlState,i.parseResult.controls)}setGLBlendMode(e,t){let i=this.blendMode.value;i===fq.ADDITIVE||t>0?(e.enable(e.BLEND),fH.get(i)(e)):e.disable(WebGL2RenderingContext.BLEND)}}var fY=((z={})[z.OFF=0]="OFF",z[z.ON=1]="ON",z[z.MAX=2]="MAX",z[z.MIN=3]="MIN",z);function fX(e=0){return new rL.B(fY,e)}function fQ(e){return 2===e||3===e}function f0(e){return fQ(e.mode.value)}let f1=Q.wO.create();function f2(e,t,i,n,r,s){if(0===n.length)return;let{viewMatrix:a,projectionMat:o,displayDimensionRenderInfo:l}=e,{voxelPhysicalScales:d}=l,u=(0,Q.n_)(d),c=(0,Q.V2)(o),h=(c/i)**3,p=Q.wO.determinant((0,Q.bZ)(f1,a)),g={spatialScales:new Map,activeIndex:-1},m=e=>Math.abs(n[e].chunkLayout.detTransform*p),f=n.length-1,v=m(f);for(let e=f;e>=0;--e){let t=m(e),i=Math.cbrt(t*u/p),n=c/Math.cbrt(t);g.spatialScales.set(i,n),t-h>=0&&(v=t,f=e),g.activeIndex=f}let y=Math.cbrt(v*u/p),b=c/Math.cbrt(v),S=!0,w=n[f];o6(e,t,w,(e,t)=>{S&&(r(w,f,y,b,t,g),S=!1),s(w,f,e)})}let f3=Symbol("depthSamplerTextureUnit"),f4=`
void emitRGBA(vec4 rgba) {
  float correctedAlpha = clamp(rgba.a * uBrightnessFactor * uGain, 0.0, 1.0);
  float weightedAlpha = correctedAlpha * computeOITWeight(correctedAlpha, depthAtRayPosition);
  outputColor += vec4(rgba.rgb * weightedAlpha, weightedAlpha);
  revealage *= 1.0 - correctedAlpha;
}
`,f6=Q._E.create(),f5=new Float32Array(24);function f8(){return[1,Math.round(21)]}function f7(e){let t=f8();return ek([2**t[0],2**t[1]-1],Math.round(e))}class f9 extends u2{gain;multiscaleSource;transform;channelCoordinateSpace;localPosition;shaderControlState;depthSamplesTarget;chunkResolutionHistogram;mode;backend;modeOverride;vertexIdHelper;dataHistogramSpecifications;shaderGetter;histogramShaderGetter;get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}histogramIndexBuffer;constructor(e){super(),this.gain=e.gain,this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.depthSamplesTarget=e.depthSamplesTarget,this.chunkResolutionHistogram=e.chunkResolutionHistogram,this.mode=e.mode,this.modeOverride=fX(),this.dataHistogramSpecifications=this.shaderControlState.histogramSpecifications,this.histogramIndexBuffer=this.registerDisposer(nT(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(256))),this.registerDisposer(this.chunkResolutionHistogram.visibility.add(this.visibility)),this.registerDisposer(this.dataHistogramSpecifications.producerVisibility.add(this.visibility));let t=this.registerDisposer((0,Z.mo)((e,t,i,n)=>({numChannelDimensions:e.rank,mode:i===fY.OFF?t:i,dataHistogramChannelSpecifications:n}),[this.channelCoordinateSpace,this.mode,this.modeOverride,this.dataHistogramSpecifications.channels]));this.shaderGetter=nw(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:e,chunkFormat:t,wireFrame:i})=>`${(0,nd.M)(e)}:${t.shaderKey}:${i}`,shaderError:e.shaderError,extraParameters:t,defineShader:(e,{emitter:t,chunkFormat:i,wireFrame:n},r,s)=>{if(0!==r.parseResult.errors.length)throw Error("Invalid UI control specification");pa(e),e.addFragmentCode(`
#define VOLUME_RENDERING true
`);let a=f4,o=`
  emitAccumAndRevealage(outputColor, 1.0 - revealage, 0u);
`,l=`
void emitIntensity(float value) {
}
`,d="";if(fQ(s.mode)){let t=s.mode===fY.MIN?"1.0 - value":"value";e.addFragmentCode(`
float savedDepth = 0.0;
float savedIntensity = 0.0;
vec4 newColor = vec4(0.0);
float userEmittedIntensity = -100.0;
`),l=`
float convertIntensity(float value) {
  return clamp(${t}, 0.0, 1.0);
}
void emitIntensity(float value) {
  userEmittedIntensity = value;
}
float getIntensity() {
  float intensity = userEmittedIntensity > -100.0 ? userEmittedIntensity : defaultMaxProjectionIntensity;
  return convertIntensity(intensity);
}
`,a=`
void emitRGBA(vec4 rgba) {
  float alpha = clamp(rgba.a, 0.0, 1.0);
  newColor = vec4(rgba.rgb * alpha, alpha);
}
`,o=`
  gl_FragDepth = savedIntensity;
`,d=`
  float newIntensity = getIntensity();
  bool intensityChanged = newIntensity > savedIntensity;
  savedIntensity = intensityChanged ? newIntensity : savedIntensity; 
  savedDepth = intensityChanged ? depthAtRayPosition : savedDepth;
  outputColor = intensityChanged ? newColor : outputColor;
  emit(outputColor, savedDepth, savedIntensity, uPickId);
  defaultMaxProjectionIntensity = 0.0;
  userEmittedIntensity = -100.0;
`}if(t(e),e.addUniform("highp float","uNearLimitFraction"),e.addUniform("highp float","uFarLimitFraction"),e.addUniform("highp int","uMaxSteps"),e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uModelViewProjectionMatrix"),e.addUniform("highp mat4","uInvModelViewProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp float","uChunkNumber"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),e.addUniform("highp float","uBrightnessFactor"),e.addUniform("highp float","uGain"),e.addUniform("highp uint","uPickId"),e.addVarying("highp vec4","vNormalizedPosition"),e.addTextureSampler("sampler2D","uDepthSampler",f3),e.addVertexCode(pq),e.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),e.addFragmentCode(`
vec3 curChunkPosition;
float depthAtRayPosition;
vec4 outputColor;
float revealage;
void userMain();
`),pP(e,i,s.numChannelDimensions,"curChunkPosition"),e.addFragmentCode([l,a,`
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGBA(vec4(value, value, value, value));
}
void emitTransparent() {
  emitIntensity(0.0);
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
float computeDepthFromClipSpace(vec4 clipSpacePosition) {
  float NDCDepthCoord = clipSpacePosition.z / clipSpacePosition.w;
  return (NDCDepthCoord + 1.0) * 0.5;
}
vec2 computeUVFromClipSpace(vec4 clipSpacePosition) {
  vec2 NDCPosition = clipSpacePosition.xy / clipSpacePosition.w;
  return (NDCPosition + 1.0) * 0.5;
}
`]),n){let t=`
  emit(outputColor, 0u);
`;fQ(s.mode)&&(t=`
  emit(outputColor, 1.0, uChunkNumber, uPickId);
            `),e.setFragmentMainFunction(`
void main() {
  outputColor = vec4(uChunkNumber, uChunkNumber, uChunkNumber, 1.0);
  emitIntensity(uChunkNumber);
  ${t}
}
`)}else e.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  revealage = 1.0;
  for (int rayStep = startStep; rayStep < endStep; ++rayStep) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(rayStep) * stepSize);
    vec4 clipSpacePosition = uModelViewProjectionMatrix * vec4(position, 1.0);
    depthAtRayPosition = computeDepthFromClipSpace(clipSpacePosition);
    vec2 uv = computeUVFromClipSpace(clipSpacePosition);
    float depthInBuffer = texture(uDepthSampler, uv).r;
    bool rayPositionBehindOpaqueObject = (1.0 - depthAtRayPosition) < depthInBuffer;
    if (rayPositionBehindOpaqueObject) {
      break;
    }
    curChunkPosition = position - uTranslation;
    userMain();
    ${d}
  }
  ${o}
}
`);e.addFragmentCode(o9),ok(r,e),e.addFragmentCode("\n#define main userMain\n"+nx(r.parseResult.code)+"\n#undef main\n")}}),this.histogramShaderGetter=nw(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayerHistogram",parameters:e.shaderControlState.builderState,getContextKey:({chunkFormat:e})=>`${e.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(e,{chunkFormat:t},i,n)=>{e.addOutputBuffer("vec4","outputValue",null),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp int","uHistogramIndex"),e.addAttribute("float","aInput1"),e.addVertexCode(`
vec3 chunkSamplePosition;
          `);let r=n.numChannelDimensions;t.defineShader(e,r,!0);let{dataType:s}=t,a="",o="";if(0===r)a+="highp int ignoredChannelIndex";else for(let e=0;e<r;++e)0!==e&&(a+=", "),a+=`highp int channelIndex${e}`,o+=`, channelIndex${e}`;let l=`
${rn(s)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(chunkSamplePosition), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}`;e.addVertexCode(l),r<=1&&e.addVertexCode(`
${rn(s)} getDataValue() { return getDataValue(0); }
`);let d=n.dataHistogramChannelSpecifications,u=d.length,c=`
  float x;
  switch (uHistogramIndex) {`;for(let t=0;t<u;++t){let{channel:i}=d[t],n=`getDataValue(${i.join(",")})`,r=`invlerpForHistogram${t}`;e.addVertexCode(rC(e,r,s,!1)),e.addVertexCode(`
float getHistogramValue${t}() {
  return invlerpForHistogram${t}(${n});
}
`),c+=`
  case ${t}:
    x = getHistogramValue${t}();
    break;`}c+=`
  }
`,e.addVertexCode(n8),e.setVertexMain(`
  vec3 rand3val = vec3(
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID), float(gl_InstanceID))),
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + float(gl_InstanceID))),
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 20.0, 15.0 + float(gl_InstanceID))));
  chunkSamplePosition = rand3val * (uChunkDataSize - 1.0);
${c}
  if (x < 0.0) x = 0.0;
  else if (x > 1.0) x = 1.0;
  else x = (1.0 + x * 253.0) / 255.0;
  gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
  gl_PointSize = 1.0;`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
          `)}}),this.vertexIdHelper=this.registerDisposer(po.get(this.gl)),this.registerDisposer(this.depthSamplesTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.gain.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:i}=this.multiscaleSource,n=this.registerDisposer(new lb(this.layerChunkProgressInfo)),r=i.rpc;n.RPC_TYPE_ID="volume_rendering/VolumeRenderingRenderLayer",n.initializeCounterpart(r,{chunkManager:i.rpcId,localPosition:this.registerDisposer(i3.makeFromExisting(r,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(i3.makeFromExisting(r,this.depthSamplesTarget)).rpcId}),this.backend=n}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer((0,Z.Uw)((t,i,n)=>{let r=lB(n,i,e=>this.multiscaleSource.getSources(e),e.messages,this);for(let e of r)for(let i of e)t.registerDisposer(i.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke("volume_rendering/VolumeRenderingRenderLayer/update",{layer:this.backend.rpcId,view:e.view.rpcId,sources:lA(r),displayDimensionRenderInfo:n}),this.redrawNeeded.dispatch(),r},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){let i,n,r,s,a;if(!e.emitColor)return;let o=t.state.sources.value;if(0===o.length)return;let l=0,d=0,u={spatialScales:new Map,activeIndex:0},c=null,h=Q.R3.create(),{gl:p}=this;this.vertexIdHelper.enable(),this.modeOverride.value=fY.OFF;let{chunkResolutionHistogram:g}=this;g.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let m=()=>{if(null===c)return;c.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(p,c);let e=c.textureUnit(f3);if(p.activeTexture(WebGL2RenderingContext.TEXTURE0+e),p.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),0!==y||0!==b){let e=u.spatialScales.size-1,t=new Set([f7(d)]);u.spatialScales.forEach((i,n)=>{let r=f7(i);e!==u.activeIndex&&!t.has(r)&&(g.add(n,i,0,10,!0),t.add(r)),e--}),g.add(l,d,y,b)}},f=!0,{projectionParameters:v}=e,y=0,b=0,S=1,w=this.multiscaleSource.rank,C=Q.R3.create(),x=this.getDataHistogramCount()>0&&!e.wireFrame&&!e.sliceViewsPresent&&(!e.isContinuousCameraMotionInProgress||e.force3DHistogramForAutoRange),E=!fQ(this.mode.value)&&!e.isContinuousCameraMotionInProgress&&!e.wireFrame,T=fQ(this.mode.value)||E?e.pickIDs.register(this):0,k=[],D=[];if(p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),f2(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,o[0],(t,o,g,f,y,b)=>{l=g,d=f,u=b;let S=o5(v,t.chunkLayout),w=t.source,{fixedPositionWithinChunk:C,chunkDisplayDimensionIndices:x}=t;for(let e of x)C[e]=0;let E=w.chunkFormat;if(E!==i&&(i=E,m(),null!==(c=(n=this.shaderGetter({emitter:e.emitter,chunkFormat:E,wireFrame:e.wireFrame})).shader)&&(c.bind(),null!==E&&(oB(p,c,this.shaderControlState,n.parameters.parseResult.controls),this.bindDepthBufferTexture(e,c),E.beginDrawing(p,c),E.beginSource(p,c)))),s=void 0,null===c)return;r=w.chunks,h.fill(1);let k=Q._E.multiply(f6,v.viewProjectionMat,S.transform);(0,Q.th)(f5,k);let D=Q._E.create();Q._E.invert(D,k);let{near:P,far:L,adjustedNear:I,adjustedFar:R}=function(e,t,i){let n=0,r=0;for(let s=0;s<3;++s){let a=e[16+s],o=a*t[s],l=a*i[s];n+=Math.min(o,l),r+=Math.max(o,l)}let s=-e[19],a=Math.max(s,n),o=e[23],l=Math.min(o,r);return{near:s,far:o,adjustedNear:a,adjustedFar:l}}(f5,t.lowerClipDisplayBound,t.upperClipDisplayBound),A=this.depthSamplesTarget.value;a={uNearLimitFraction:(I-P)/(L-P),uFarLimitFraction:(R-P)/(L-P),uMaxSteps:this.depthSamplesTarget.value,uBrightnessFactor:f/A,uGain:Math.exp(this.gain.value),uPickId:T,uLowerClipBound:t.lowerClipDisplayBound,uUpperClipBound:t.upperClipDisplayBound,uModelViewProjectionMatrix:k,uInvModelViewProjectionMatrix:D},this.setShaderUniforms(c,a)},t=>{if(null===c)return;let n=t.curPositionInChunks.join(),a=r.get(n);if(void 0!==a&&a.state===ih.GPU_MEMORY){let n=t.chunkLayout.size,o=a.chunkDataSize,{chunkDisplayDimensionIndices:l,fixedPositionWithinChunk:d,chunkTransform:{channelToChunkDimensionIndices:u}}=t;if(e.wireFrame){let e=S/r.size;p.uniform1f(c.uniform("uChunkNumber"),e),++S}if(o!==s){s=o;for(let e=0;e<3;++e){let t=l[e];h[e]=-1===t||t>=w?1:s[t]}p.uniform3fv(c.uniform("uChunkDataSize"),h)}let{chunkGridPosition:g}=a;for(let e=0;e<3;++e){let t=l[e];C[e]=-1===t||t>=w?0:n[e]*g[t]}if(p.uniform3fv(c.uniform("uTranslation"),C),null!=i&&i.bindChunk(p,c,a,d,l,u,f),x||E){k.push({chunk:a,fixedPositionWithinChunk:d,chunkDisplayDimensionIndices:l,channelToChunkDimensionIndices:u,chunkFormat:i});let e=Q.R3.create(),t=Q.R3.create();Q.R3.copy(e,h),Q.R3.copy(t,C),D.push({uChunkDataSize:e,uTranslation:t})}pH(p,1,1),f=!1,++y}else++b}),m(),c=null,i=null,E){p.enable(WebGL2RenderingContext.DEPTH_TEST),p.depthMask(!0),p.disable(WebGL2RenderingContext.BLEND),p.depthFunc(WebGL2RenderingContext.GREATER),e.emitter=e.maxProjectionEmit,e.bindMaxProjectionBuffer(),this.modeOverride.value=fY.MAX;let t=()=>{null!==c&&(c.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(p,c))};f=!0;for(let r=0;r<y;++r){let s=k[r],o=D[r],l=s.chunkFormat;if(l!==i&&(i=l,t(),null!==(c=(n=this.shaderGetter({emitter:e.emitter,chunkFormat:l,wireFrame:e.wireFrame})).shader)&&void 0!==a&&(c.bind(),null!=l&&(oB(p,c,this.shaderControlState,n.parameters.parseResult.controls),this.bindDepthBufferTexture(e,c),this.setShaderUniforms(c,a),l.beginDrawing(p,c),l.beginSource(p,c)))),null===c)break;null!=l&&l.bindChunk(p,c,s.chunk,s.fixedPositionWithinChunk,s.chunkDisplayDimensionIndices,s.channelToChunkDimensionIndices,f),p.uniform3fv(c.uniform("uTranslation"),o.uTranslation),p.uniform3fv(c.uniform("uChunkDataSize"),o.uChunkDataSize),pH(p,1,1),f=!1}this.modeOverride.value=fY.OFF}if(this.vertexIdHelper.disable(),p.disable(WebGL2RenderingContext.CULL_FACE),x){let e=null,t=()=>{null!==e&&(e.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(p,e))},n=(e,t)=>{let i=e.reduce((e,t)=>e*t,1);return Math.max(Math.round(Math.min(i/2,i/t*16384)/256),1)};i=null;let{dataType:r,dataHistogramSpecifications:s}=this,a=s.getFramebuffers(p),o=this.getDataHistogramCount();for(let e=0;e<o;++e)a[e].bind(256,1),p.clearColor(0,0,0,1),p.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let l=this.dataHistogramSpecifications.bounds.value;p.enable(WebGL2RenderingContext.BLEND),p.disable(WebGL2RenderingContext.DEPTH_TEST);let d=D.reduce((e,t)=>e+t.uChunkDataSize.reduce((e,t)=>e*t,1),0);for(let s=0;s<y;++s){f=!0;let u=k[s],c=D[s],h=u.chunkFormat;if(h!==i){if(i=h,t(),null!==(e=this.histogramShaderGetter({chunkFormat:h}).shader))null!=h&&(h.beginDrawing(p,e),h.beginSource(p,e)),e.bind();else break}if(null===e)break;p.uniform3fv(e.uniform("uChunkDataSize"),c.uChunkDataSize),null!=i&&i.bindChunk(p,e,u.chunk,u.fixedPositionWithinChunk,u.chunkDisplayDimensionIndices,u.channelToChunkDimensionIndices,f),this.histogramIndexBuffer.value.bindToVertexAttrib(e.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let g=n(c.uChunkDataSize,d);for(let t=0;t<o;++t)a[t].bind(256,1),rE(e,`invlerpForHistogram${t}`,r,l[t]),p.uniform1i(e.uniform("uHistogramIndex"),t),p.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,256,g);f=!1}t()}(E||x)&&(()=>{let t=!fQ(this.mode.value)&&!e.isContinuousCameraMotionInProgress;fQ(this.mode.value)||t?(p.depthMask(!0),p.disable(WebGL2RenderingContext.BLEND),p.depthFunc(WebGL2RenderingContext.GREATER)):(p.depthMask(!1),p.enable(WebGL2RenderingContext.BLEND),p.depthFunc(WebGL2RenderingContext.LESS),e.bindVolumeRenderingBuffer())})()}bindDepthBufferTexture(e,t){let{gl:i}=this;if(void 0!==e.depthBufferTexture&&null!==e.depthBufferTexture){let n=t.textureUnit(f3);i.activeTexture(WebGL2RenderingContext.TEXTURE0+n),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e.depthBufferTexture)}else throw Error("Depth buffer texture ID for volume rendering is undefined or null")}setShaderUniforms(e,t){let{gl:i}=this;i.uniformMatrix4fv(e.uniform("uModelViewProjectionMatrix"),!1,t.uModelViewProjectionMatrix),i.uniformMatrix4fv(e.uniform("uInvModelViewProjectionMatrix"),!1,t.uInvModelViewProjectionMatrix),i.uniform1f(e.uniform("uNearLimitFraction"),t.uNearLimitFraction),i.uniform1f(e.uniform("uFarLimitFraction"),t.uFarLimitFraction),i.uniform1f(e.uniform("uGain"),t.uGain),i.uniform1ui(e.uniform("uPickId"),t.uPickId),i.uniform1i(e.uniform("uMaxSteps"),t.uMaxSteps),i.uniform3fv(e.uniform("uLowerClipBound"),t.uLowerClipBound),i.uniform3fv(e.uniform("uUpperClipBound"),t.uUpperClipBound),i.uniform1f(e.uniform("uBrightnessFactor"),t.uBrightnessFactor)}isReady(e,t){let i=t.state.sources.value;if(0===i.length)return!0;let n=!1;return f2(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,i[0],()=>{},e=>{let t=e.source.chunks.get(e.curPositionInChunks.join());(void 0===t||t.state!==ih.GPU_MEMORY)&&(n=!0)}),!n}}i("6674");let ve=sh.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class vt{id;element;nameContainer;nameElement;lowerElement;upperElement;constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");let{element:t,nameContainer:i,nameElement:n,lowerElement:r,upperElement:s}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),i.classList.add("neuroglancer-channel-dimensions-widget-name-container"),n.classList.add("neuroglancer-channel-dimensions-widget-name"),i.appendChild(n),r.classList.add("neuroglancer-channel-dimensions-widget-lower"),s.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(i),t.appendChild(r),t.appendChild(s),i.draggable=!0,n.disabled=!0,n.spellcheck=!1,n.autocomplete="off",n.required=!0,n.placeholder=" ",i.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",i.addEventListener("dblclick",()=>{n.disabled=!1,n.focus(),n.select()}),n.addEventListener("focus",()=>{n.select()})}}class vi extends ef.gj{combiner;element;dimensionWidgets;curCoordinateSpace;dragSource;reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:i}=this;i.value=ie(i.value,e,t)}coordinateSpace;constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=e.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let i=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(i)),this.registerDisposer(new aq(t,ve)).allShortcutsAreGlobal=!0,this.registerDisposer(sv(t,"cancel",e=>{this.forceUpdateView();let{target:t}=e;t instanceof HTMLElement&&t.blur()})),this.updateView()}makeNewDimensionWidget(e){let t=new vt(e);return t.nameContainer.addEventListener("dragstart",e=>{this.dragSource=t,e.stopPropagation(),e.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",e=>{let{dragSource:i}=this;if(void 0===i||i===t)return;let{dimensionWidgets:n}=this,r=n.indexOf(i),s=n.indexOf(t);-1!==r&&-1!==s&&(e.preventDefault(),this.reorderDimensionTo(s,r))}),t.nameContainer.addEventListener("dragend",e=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",e=>{t.nameElement.disabled=!0;let{relatedTarget:i}=e;if(!this.dimensionWidgets.some(e=>e.nameElement===i))!this.updateNames()&&this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{let{nameElement:e}=t;sA(e),this.updateNameValidity()}),sv(t.nameElement,"commit",()=>{this.updateNames()}),sv(t.nameElement,"tab-forward",e=>this.selectAdjacentField(e,t,1)),sv(t.nameElement,"tab-backward",e=>this.selectAdjacentField(e,t,-1)),t}selectAdjacentField(e,t,i){e.stopPropagation();let{dimensionWidgets:n}=this,r=n.indexOf(t);if(-1===r)return;let s=r+i;if(s<0||s>=n.length)return;let a=n[s];a.nameElement.disabled=!1,a.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,i=t.value,n=e.map(e=>e.nameElement.value);if(this.combiner.getRenameValidity(n).includes(!1))return!1;let r=i.names;if((0,Y.cO)(r,n))return!1;let s=i.timestamps.map((e,t)=>r[t]===n[t]?e:Date.now()),a={...i,names:n,timestamps:s};return t.value=a,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(e=>e.nameElement.value),i=t.length,n=this.combiner.getRenameValidity(t);for(let t=0;t<i;++t)e[t].nameElement.dataset.isValid=!1===n[t]?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,i=this.dimensionWidgets,n=this.dimensionWidgets=e.ids.map(e=>i.find(t=>t.id===e)||this.makeNewDimensionWidget(e));sM(t,(function*(){let{names:t,rank:i,bounds:r}=e;for(let e=0;e<i;++e){let i=n[e];i.nameElement.value=t[e],i.nameElement.dataset.isValid=void 0,sA(i.nameElement);let[s,a]=t_(r,e);i.lowerElement.textContent=s.toString(),i.upperElement.textContent=a.toString(),yield i.element}}).call(this))}}let vn="opacity",vr="blend",vs="shader",va="shaderControls",vo="crossSectionRenderScale",vl="channelDimensions",vd="volumeRendering",vu="volumeRenderingGain",vc="volumeRenderingDepthSamples",vh=g6(dM),[vp,vg]=f8();class vm extends vh{opacity=pW(.5);blendMode=(function(e=0){return new rL.B(fq,e)})();fragmentMain=(function(e=fJ){return nS(e)})();shaderError=nb();dataType=new Z.SN(void 0);sliceViewRenderScaleHistogram=new lD;sliceViewRenderScaleTarget=lk(1);volumeRenderingGain=(function(e=1){return new Z.TU(e,eb.jz)})(0);volumeRenderingChunkResolutionHistogram=new lD(vp);volumeRenderingDepthSamplesTarget=lk(64,2**vp,2**vg-1);channelCoordinateSpace=new tO;channelCoordinateSpaceCombiner=new t4(this.channelCoordinateSpace,tX);channelSpace=this.registerDisposer((0,Z.og)(e=>na(()=>(function(e){let{rank:t}=e,{bounds:{lowerBounds:i,upperBounds:n}}=e;if(i.some(e=>0!==e))throw Error("Lower bounds of channel coordinate space must all be 0");if(n.some(e=>!Number.isInteger(e)||e<=0||e>=0x100000000))throw Error("Upper bounds of channel coordinate space must all be positive integers");let r=new Uint32Array(n),s=tw(r),a=new Uint32Array(s*t);for(let e=0;e<s;++e){let i=e;for(let n=0;n<t;++n){let s=i%r[n];i=(i-s)/r[n],a[e*t+n]=s}}return{channelCoordinateSpace:e,shape:r,numChannels:s,coordinates:a}})(e)),this.channelCoordinateSpace));volumeRenderingMode=fX();shaderControlState=this.registerDisposer(new o_(this.fragmentMain,this.registerDisposer((0,Z.mo)((e,t)=>void 0===e?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),i=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),i()}}constructor(e){super(e),this.localCoordinateSpaceCombiner.includeDimensionPredicate=tZ,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.volumeRenderingGain.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRenderingMode.changed.add(this.specificationChanged.dispatch),this.volumeRenderingDepthSamplesTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new vy(this)}),this.tabs.default="rendering"}activateDataSubsources(e){let t;for(let i of e){if(this.addStaticAnnotations(i))continue;let{subsourceEntry:e}=i,{subsource:n}=e,{volume:r}=n;if(!(r instanceof pM)){i.deactivate("Not compatible with image layer");continue}if(t&&r.dataType!==t){i.deactivate(`Data type must be ${ec[r.dataType].toLowerCase()}`);continue}t=r.dataType,i.activate(e=>{i.addRenderLayer(new fZ(r,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:i.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let t=e.registerDisposer(new f9({gain:this.volumeRenderingGain,multiscaleSource:r,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:i.getRenderLayerTransform(this.channelCoordinateSpace),depthSamplesTarget:this.volumeRenderingDepthSamplesTarget,chunkResolutionHistogram:this.volumeRenderingChunkResolutionHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace,mode:this.volumeRenderingMode}));e.registerDisposer(i.messages.addChild(t.messages)),e.registerDisposer((0,Z.Uw)((e,i)=>{i!==fY.OFF&&e.registerDisposer(this.addRenderLayer(t.addRef()))},this.volumeRenderingMode)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[vn]),(0,eb.Kh)(e,vr,e=>this.blendMode.restoreState(e)),this.fragmentMain.restoreState(e[vs]),this.shaderControlState.restoreState(e[va]),this.sliceViewRenderScaleTarget.restoreState(e[vo]),this.channelCoordinateSpace.restoreState(e[vl]),(0,eb.Kh)(e,vd,e=>{"boolean"==typeof e?this.volumeRenderingMode.value=e?fY.ON:fY.OFF:this.volumeRenderingMode.restoreState(e)}),(0,eb.Kh)(e,vu,e=>this.volumeRenderingGain.restoreState(e)),(0,eb.Kh)(e,vc,e=>this.volumeRenderingDepthSamplesTarget.restoreState(e))}toJSON(){let e=super.toJSON();return e[vn]=this.opacity.toJSON(),e[vr]=this.blendMode.toJSON(),e[vs]=this.fragmentMain.toJSON(),e[va]=this.shaderControlState.toJSON(),e[vo]=this.sliceViewRenderScaleTarget.toJSON(),e[vl]=this.channelCoordinateSpace.toJSON(),e[vd]=this.volumeRenderingMode.toJSON(),e[vu]=this.volumeRenderingGain.toJSON(),e[vc]=this.volumeRenderingDepthSamplesTarget.toJSON(),e}displayImageSelectionState(e,t){let{value:i}=e;if(null==i)return!1;let n=this.channelSpace.value;if(void 0!==n.error)return!1;let{numChannels:r,coordinates:s,channelCoordinateSpace:{names:a,rank:o}}=n,l=document.createElement("div");l.classList.add("neuroglancer-selection-details-value-grid");let d="[copy] 0fr ";0!==o&&(d+=`repeat(${o}, [dim] 0fr [coord] 0fr) `),d+="[value] 1fr",l.style.gridTemplateColumns=d;for(let e=0;e<r;++e){let t=0===o?i:i[e],n=null==t?"":t.toString(),r=aK({title:"Copy value",onClick:()=>{aG(n)}});l.appendChild(r);for(let t=0;t<o;++t){let i=document.createElement("div");i.classList.add("neuroglancer-selection-details-value-grid-dim"),i.textContent=a[t],l.appendChild(i);let n=document.createElement("div");n.classList.add("neuroglancer-selection-details-value-grid-coord"),n.textContent=s[e*o+t].toString(),l.appendChild(n)}let d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid-value"),d.textContent=n,l.appendChild(d)}return t.appendChild(l),!0}displaySelectionState(e,t,i){let n=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,i)&&(n=!0),n}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),fK(e,t)},initializeShader:e=>{let t=e.shader;oB(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}static type="image";static typeAbbreviation="img"}function vf(e){return new m$({shaderError:e.shaderError,fragmentMain:e.fragmentMain,shaderControlState:e.shaderControlState})}let vv=[{label:"Resolution (slice)",toolJson:vo,...uz(e=>({histogram:e.sliceViewRenderScaleHistogram,target:e.sliceViewRenderScaleTarget}))},{label:"Blending (slice)",toolJson:vr,...uV(e=>e.blendMode)},{label:"Opacity (slice)",toolJson:vn,...uF(e=>({value:e.opacity}))},{label:"Volume rendering (experimental)",toolJson:vd,...uV(e=>e.volumeRenderingMode)},{label:"Gain (3D)",toolJson:vu,isValid:e=>(0,Z.mo)(e=>e===fY.ON,[e.volumeRenderingMode]),...uF(e=>({value:e.volumeRenderingGain,options:{min:-10,max:10,step:.1}}))},{label:"Resolution (3D)",toolJson:vc,isValid:e=>(0,Z.mo)(e=>e!==fY.OFF,[e.volumeRenderingMode]),...uz(e=>({histogram:e.volumeRenderingChunkResolutionHistogram,target:e.volumeRenderingDepthSamplesTarget}),class e extends u${unitOfTarget="samples";logScaleOrigin=1;getWheelMoveValue(e){return-e.deltaY}})}];for(let e of vv)uA(vm,e);class vy extends s_{layer;codeWidget;constructor(e){super(),this.layer=e;let{element:t}=this;for(let i of(this.codeWidget=this.registerDisposer(vf(this.layer)),t.classList.add("neuroglancer-image-dropdown"),vv))t.appendChild(uR(this,e,this.visibility,i));let i=document.createElement("div");i.style.flex="1";let n=document.createElement("div");n.className="neuroglancer-image-dropdown-top-row",n.appendChild(document.createTextNode("Shader")),n.appendChild(i),n.appendChild(mA({title:"Show larger editor view",onClick:()=>{new vb(this.layer)}})),n.appendChild(mL({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),t.appendChild(n),t.appendChild(this.registerDisposer(new vi(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new mj(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class vb extends mP{layer;codeWidget;constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(vf(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}d4(vm),j=pE.IMAGE,W=vm,d2.set(j,W),d6(e=>{let{volume:t}=e;if(void 0!==t){if(t.volumeType===pE.UNKNOWN)return{layerConstructor:vm,priority:-100}}}),mJ(vm,e=>({shaderControlState:e.shaderControlState,legendShaderOptions:e.getLegendShaderOptions()})),i("9760");var vS=i("5898");class vw extends iY{provider;constructor(e,t){super(),this.provider=e,this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}}function vC(e,t){if(void 0===t)return;let i=e.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:(0,nd.M)(t)},()=>new vw(t.addRef(),e.rpc)),n=i.addCounterpartRef();return i.dispose(),n}function vx(){return e=>class t extends e{credentialsProvider;constructor(...e){super(...e);let t=e[1];this.credentialsProvider=t.credentialsProvider?.addRef()}initializeCounterpart(e,t){let{credentialsProvider:i}=this;t.credentialsProvider=vC(this.chunkManager,i),super.initializeCounterpart(e,t)}static encodeOptions(t){let i=e.encodeOptions(t),{credentialsProvider:n}=t;return i.credentialsProvider=void 0===n?void 0:(0,nd.M)(n),i}}}vw=function(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([i0(vS.y)],vw),iJ(vS.L,function(e,t){return this.get(e.providerId).get(e.invalidCredentials,t).then(e=>({value:e}))});var vE=i("8956");class vT extends Error{url;status;statusText;response;constructor(e,t,i,n){let r=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;i&&(r+=`: ${i}`),super(r+="."),this.name="HttpError",this.message=r,this.url=e,this.status=t,this.statusText=i,n&&(this.response=n)}static fromResponse(e){return new vT(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let t;return new vT(t="string"==typeof e?e:e.url,0,"Network or CORS error")}return t}}function vk(e){return Math.min(2**e*500,5e3)*(1+Math.random())}async function vD(e,t){for(let i=0;;){let n;t?.signal?.throwIfAborted();try{n=await fetch(e,t)}catch(t){throw vT.fromRequestError(e,t)}if(!n.ok){let{status:e}=n;if((429===e||503===e||504===e)&&32!=++i){await new Promise(e=>setTimeout(e,vk(i-1)));continue}throw vT.fromResponse(n)}return n}}function vP(e){let t=e.match(/^([^:/]+):\/\/([^/]+)((?:\/.*)?)$/);if(null===t)throw Error(`Invalid URL: ${JSON.stringify(e)}`);return{protocol:t[1],host:t[2],path:t[3]}}function vL(e){return e instanceof vT&&(0===e.status||403===e.status||404===e.status)}new eC.E;async function vI(e,t,i,n,r){let s;for(let a=0;;){i.signal?.throwIfAborted(),a>1&&await new Promise(e=>setTimeout(e,vk(a-2))),s=await e.get(s,i.signal??void 0);try{return await vD("function"==typeof t?t(s.credentials):t,n(s.credentials,i))}catch(e){if(e instanceof vT&&await r(e,s.credentials)==="refresh"){if(3==++a)throw e;continue}throw e}}}function vR(e,t,i){return void 0===e?vD(t,i):vI(e,t,i,(e,t)=>{if(!e.accessToken)return t;let i=new Headers(t.headers);return i.set("Authorization",`${e.tokenType} ${e.accessToken}`),{...t,headers:i}},e.errorHandler)}async function vA(e,t,i,n,r){let s=await vR(e,`${t}?prefix=${encodeURIComponent(i)}&delimiter=${encodeURIComponent(n)}`,{signal:r}),a=new DOMParser().parseFromString(await s.text(),"application/xml"),o=a.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let e=0,t=o.snapshotLength;e<t;++e)l.push(o.snapshotItem(e).textContent||"");let d=a.evaluate('//*[name()="Contents"]/*[name()="Key"]',a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let e=0,t=d.snapshotLength;e<t;++e)l.push(d.snapshotItem(e).textContent||"");return l}async function vM(e,t,i,n,r){if(!n.startsWith("/"))throw null;let s=await vA(e,i,n.substring(1),"/",r),a=n.lastIndexOf("/");return{offset:a+t.length+1,completions:s.map(e=>({value:e.substring(a)}))}}async function vN(e,t,i){return await vM(void 0,`s3://${e}`,`https://${e}.s3.amazonaws.com`,t,i)}function vV(e,t,i){let n=i.match(/^\/([^/]+)/);if(null!==n)return e.getCredentialsProvider("ngauth_gcs",{authServer:t,bucket:n[1]})}function vO(e,t){let i=vP(e);switch(i.protocol){case"gs":case"gs+xml":return{credentialsProvider:void 0,url:e};case"gs+ngauth+http":return{credentialsProvider:vV(t,`http://${i.host}`,i.path),url:"gs:/"+i.path};case"gs+ngauth+https":return{credentialsProvider:vV(t,`https://${i.host}`,i.path),url:"gs:/"+i.path};case"gs+xml+ngauth+http":return{credentialsProvider:vV(t,`http://${i.host}`,i.path),url:"gs+xml:/"+i.path};case"gs+xml+ngauth+https":return{credentialsProvider:vV(t,`https://${i.host}`,i.path),url:"gs+xml:/"+i.path};case"middleauth+https":var n,r;return e=e.substr(11),{credentialsProvider:(n=t,r=e,n.getCredentialsProvider("middleauthapp",new URL(r).origin)),url:e};default:return{credentialsProvider:void 0,url:e}}}async function v_(e,t,i){let n=vP(t);switch(n.protocol){case"gs":return vR(e,`https://www.googleapis.com/storage/v1/b/${n.host}/o/${encodeURIComponent(n.path.substring(1))}?alt=media&neuroglancer=${e$()}`,i);case"gs+xml":return vR(e,`https://storage.googleapis.com/${n.host}${n.path}?neuroglancer=${e$()}`,i);case"s3":var r,s;return r=n.host,s=n.path,vD(`https://${r}.s3.amazonaws.com${s}`,i);default:return vR(e,t,i)}}class vF extends ef.gj{gl;length;webglType;buffer;constructor(e){super(),this.gl=e,this.buffer=this.registerDisposer(new nE(e))}resize(e){let t;if(e<256){let i=t=new Uint8Array(e);for(let t=0;t<e;++t)i[t]=t;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let i=t=new Uint16Array(e);for(let t=0;t<e;++t)i[t]=t;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let i=t=new Uint32Array(e);for(let t=0;t<e;++t)i[t]=t;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(void 0===this.length||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let i=e.attribute("aIndexRaw");i>=0&&(this.bindToVertexAttrib(i),0!==t&&this.gl.vertexAttribDivisor(i,t))}}function vB(e){e.addAttribute("highp uint","aIndexRaw"),e.addVertexCode(n2),e.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}class vU{name;constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let i=t.attribute(this.name);e.bindToVertexAttribI(i,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}}let v$=`void main() {
  emitGray();
}
`;class vG{shaderError=nb();fragmentMain=nS(v$);shaderControlState=new o_(this.fragmentMain)}function vz(e){return rn(e.dataType,e.numComponents)}let vj=[],vW=cv(new cs,ec.FLOAT32,3);function vq(e){let t=new Set,i=[];for(let n of e){let e=n.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_"),r="",s=0;for(;t.has(e+r);)r=""+ ++s;i.push(e+r)}return i}class vH{attributeNames;attributeInfo;tempLightVec;textureAccessHelper;indexBufferHelper;constructor(e,t){this.attributeNames=e,this.attributeInfo=t,this.tempLightVec=new Float32Array(4),this.textureAccessHelper=new cS("vertexData"),this.indexBufferHelper=new vU("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:i}=this;i.defineShader(e);let{attributeNames:n}=this,r=2+n.length;for(let e=vj.length;e<r;++e)vj[e]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${e}`);r=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",vj[r++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",vj[r++]),e.addVertexCode(i.getAccessor("readVertexPosition","uVertexAttributeSampler0",ec.FLOAT32,3)),e.addVertexCode(i.getAccessor("readVertexNormal","uVertexAttributeSampler1",ec.FLOAT32,3));let s=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((a,o)=>{e.addTextureSampler(`${cf(a.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,vj[r]);let l=vz(a);e.addVarying(`highp ${l}`,`vCustom${o}`),e.addFragmentCode(`
#define ${n[o]} vCustom${o}
`),e.addVertexCode(i.getAccessor(`readAttribute${o}`,`uVertexAttributeSampler${r}`,a.dataType,a.numComponents)),s+=`vCustom${o} = readAttribute${o}(${t});
`,++r}),e.addVertexMain(s)}defineShader(e){e.require(vB),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(o9),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,i){let{lightDirection:n,ambientLighting:r,directionalLighting:s,projectionParameters:a}=i,{viewProjectionMat:o}=a;e.uniformMatrix4fv(t.uniform("uProjection"),!1,o);let l=this.tempLightVec;Q.R3.scale(l,n,s),l[3]=r,e.uniform4fv(t.uniform("uLightDirection"),l)}setPickID(e,t,i){e.uniform1ui(t.uniform("uPickID"),i)}beginObject(e,t,i){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,i)}bindVertexData(e,t,i){let n=0,r=i=>{let r=WebGL2RenderingContext.TEXTURE0+t.textureUnit(vj[n]);e.activeTexture(r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),++n};r(i.vertexTexture),r(i.normalTexture);let{attributeNames:s}=this;i.vertexAttributeTextures.forEach((e,t)=>{void 0!==s[t]&&r(e)})}disableVertexData(e,t){let i=2,n=this.attributeInfo.length,{attributeNames:r}=this;for(let e=0;e<n;++e)void 0!==r[e]&&++i;for(let n=0;n<i;++n){let i=t.textureUnit(vj[n])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,i,n){n.ensure(i.numIndices).bind(t),this.bindVertexData(e,t,i.vertexData),this.indexBufferHelper.bind(i.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,i.numIndices)}endLayer(e,t){!function(e,t,i=!1){let n=t.attribute("aIndexRaw");n>=0&&(i&&e.vertexAttribDivisor(n,0),e.disableVertexAttribArray(n))}(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}}class vJ{vertexPositions;vertexNormals;vertexTexture;normalTexture;vertexAttributes;vertexAttributeTextures;copyToGPU(e,t){let i=(t,i)=>{let n=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n),cy(e,i,t),n};this.vertexTexture=i(this.vertexPositions,vW),this.normalTexture=i(this.vertexNormals,vW),this.vertexAttributeTextures=this.vertexAttributes.map((e,n)=>i(e,t[n])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let i of t)e.deleteTexture(i);t.length=0}}class vK extends lc{indexBuffer;numIndices;indices;vertexData;constructor(e,t){super(e);let i=this.vertexData=new vJ;i.vertexPositions=t.vertexPositions,i.vertexNormals=t.vertexNormals,i.vertexAttributes=t.vertexAttributes;let n=this.indices=t.indices;this.numIndices=n.length}copyToGPU(e){var t,i;super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=(t=e,i=this.indices,nE.fromData(t,i,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW))}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}}class vZ extends ly(vx()(lv),vE.J6){attributeTextureFormats=this.info.vertexAttributes.map(e=>cv(new cs,e.dataType,e.numComponents));get info(){return this.parameters.info}getChunk(e){return new vK(this,e)}}let vY=i5(iY);class vX extends vY{}class vQ extends u2{source;displayState;transform;shaderManager;shaders;sharedObject;shaderGetter;countingBuffer;constructor(e,t,i){var n;super(),this.source=e,this.displayState=t,this.transform=i,this.shaders=new Map,this.sharedObject=this.registerDisposer(new vX),this.shaderManager=new vH(vq(e.info.vertexAttributes.map(e=>e.name)),e.info.vertexAttributes),this.shaderGetter=nC(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new Z.SN(oO(oE(v$))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");ok(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(nx(t.parseResult.code))}}),this.countingBuffer=this.registerDisposer((n=this.gl).memoize.get("IndexBuffer",()=>new vF(n))),this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let{sharedObject:r}=this;r.visibility.add(this.visibility),r.RPC_TYPE_ID=vE.V4,r.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())null!==t&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return null!==this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)}get gl(){return this.source.gl}isReady(){let e=this.source.chunks.get(vE.Sk);return void 0!==e&&e.state===ih.GPU_MEMORY&&!0}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let i=ne(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===i)return;let n=this.source.chunks.get(vE.Sk);if(void 0===n||n.state!==ih.GPU_MEMORY)return;let{shader:r,parameters:s}=this.shaderGetter(e.emitter);if(null===r)return;let{gl:a}=this,o=this.shaderManager;r.bind(),o.beginLayer(a,r,e),oB(a,r,this.displayState.shaderControlState,s.parseResult.controls);let{pickIDs:l}=e;o.beginObject(a,r,i),e.emitPickID&&o.setPickID(a,r,l.register(this,n.numIndices/3)),o.drawFragment(a,r,n,this.countingBuffer),o.endLayer(a,r)}transformPickedValue(e){let{pickedOffset:t}=e,i=this.source.chunks.get(vE.Sk);if(void 0===i)return;let n=3*t,{indices:r}=i;if(n>=r.length)return;let s=r[n],a=[],{attributeNames:o}=this.shaderManager;return i.vertexData.vertexAttributes.forEach((e,t)=>{let i=o[t];void 0!==i&&a.push(`${i}=${e[s].toPrecision(6)}`)}),a.join(", ")}}async function v0(e,t,i){var n,r,s;let{info:a,url:o,credentialsProvider:l}=await (n=e,r=t,s=i,n.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:s},async()=>{let{url:e,credentialsProvider:t}=vO(s,r);return{info:await n.rpc.promiseInvoke(vE.Wl,{chunkManager:n.addCounterpartRef(),credentialsProvider:vC(n,t),parameters:{meshSourceUrl:e}}),url:e,credentialsProvider:t}}));return e.getChunkSource(vZ,{credentialsProvider:l,parameters:{meshSourceUrl:o,info:a}})}let v1="shader",v2="shaderControls";class v3 extends dM{managedLayer;displayState;vertexAttributes;constructor(e){super(e),this.managedLayer=e,this.displayState=new vG,this.vertexAttributes=new Z.SN(void 0),this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new v8(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[v1]),this.displayState.shaderControlState.restoreState(e[v2])}activateDataSubsources(e){let t=!1;for(let i of e){let{subsourceEntry:e}=i,{subsource:n}=e,{singleMesh:r}=n;if(void 0!==r){if(t){i.deactivate("Only one single-mesh source supported");continue}t=!0,i.activate(e=>{i.addRenderLayer(new vQ(r,this.displayState,i.getRenderLayerTransform())),this.vertexAttributes.value=r.info.vertexAttributes,e.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}i.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[v1]=this.displayState.fragmentMain.toJSON(),e[v2]=this.displayState.shaderControlState.toJSON(),e}static type="mesh";static typeAbbreviation="mesh"}function v4(e){return new m$({fragmentMain:e.displayState.fragmentMain,shaderError:e.displayState.shaderError,shaderControlState:e.displayState.shaderControlState})}class v6 extends ef.gj{attributes;element;constructor(e){super(),this.attributes=e,this.element=document.createElement("div"),this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(void 0===t){sI(e);return}let i=vq(t.map(e=>e.name)),n=t.length;for(let r=0;r<n;++r){let n=t[r],s=document.createElement("div");s.className="neuroglancer-single-mesh-attribute";let a=document.createElement("div");a.className="neuroglancer-single-mesh-attribute-type",a.textContent=vz(n);let o=document.createElement("div");if(o.className="neuroglancer-single-mesh-attribute-name",o.textContent=i[r],s.appendChild(a),s.appendChild(o),void 0!==n.min&&void 0!==n.max){let e=document.createElement("neuroglancer-single-mesh-attribute-minmax");e.className="neuroglancer-single-mesh-attribute-range",e.textContent=`[${n.min.toPrecision(6)}, ${n.max.toPrecision(6)}]`,s.appendChild(e)}e.appendChild(s)}}disposed(){sR(this.element)}}function v5(e){return new v6(e.vertexAttributes)}class v8 extends s_{layer;attributeWidget;codeWidget;constructor(e){super(),this.layer=e;let{element:t}=this;this.attributeWidget=this.registerDisposer(v5(e)),this.codeWidget=this.registerDisposer(v4(e)),t.classList.add("neuroglancer-single-mesh-dropdown");let i=document.createElement("div");i.className="neuroglancer-single-mesh-dropdown-top-row";let n=document.createElement("div");n.style.flex="1",i.appendChild(n),i.appendChild(mA({title:"Show larger editor view",onClick:()=>{new v7(this.layer)}})),i.appendChild(mL({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new mj(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}}class v7 extends mP{layer;attributeWidget;codeWidget;constructor(e){super(),this.layer=e,this.attributeWidget=this.registerDisposer(v5(e)),this.codeWidget=this.registerDisposer(v4(e)),this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}d4(v3),d6(e=>{if(void 0!==e.singleMesh)return{layerConstructor:v3,priority:2}}),mJ(v3,e=>({shaderControlState:e.displayState.shaderControlState}));let v9="boss";async function ye(e,t,i){return vD(t,i).catch(n=>{if(500!==n.status&&401!==n.status&&403!==n.status&&504!==n.status)throw n;return vI(e,t,i,e=>{let t=new Headers(i.headers);return t.set("Authorization",`Bearer ${e}`),{...i,headers:t}},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e})})}var yt=i("5675");class yi extends ly(vx()(pR),yt.Yz){}class yn extends ly(vx()(hL),yt.i6){}let yr=new Map;yr.set("image",pE.IMAGE),yr.set("annotation",pE.SEGMENTATION);let ys=new Set(["npz","jpeg"]),ya=Uint32Array.of(512,512,16);var yo=((q=yo||{})[q.NANOMETERS=0]="NANOMETERS",q[q.MICROMETERS=1]="MICROMETERS",q[q.MILLIMETERS=2]="MILLIMETERS",q[q.CENTIMETERS=3]="CENTIMETERS",q);function yl(e){var t;let i;(0,eb.PT)(e);let n=(0,eb.uq)(e,"type",eb.ZE),r=!1;"DOWNSAMPLED"===(0,eb.uq)(e,"downsample_status",eb.ZE)&&(r=!0);return{channelType:n,description:(0,eb.uq)(e,"description",eb.ZE),volumeType:(t=n,void 0===(i=yr.get(t))&&(i=pE.UNKNOWN),i),dataType:(0,eb.uq)(e,"datatype",e=>(0,eb.CT)(e,ec)),downsampled:r,scales:[],key:(0,eb.uq)(e,"name",eb.ZE),baseResolution:(0,eb.uq)(e,"base_resolution",eb.C$)}}class yd extends pM{baseUrl;credentialsProvider;experimentInfo;parameters;get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}experiment;channel;meshPath;meshUrl;channelInfo;scales;coordinateFrame;encoding;window;get rank(){return 3}constructor(e,t,i,n,r,s){if(super(e),this.baseUrl=t,this.credentialsProvider=i,this.experimentInfo=n,this.parameters=s,this.meshPath=void 0,this.meshUrl=void 0,void 0===r){let e=Array.from(n.channels.keys());if(1!==e.length)throw Error(`Experiment contains multiple channels: ${JSON.stringify(e)}`);r=e[0]}let a=n.channels.get(r);if(void 0===a)throw Error(`Specified channel ${JSON.stringify(r)} is not one of the supported channels ${JSON.stringify(Array.from(n.channels.keys()))}`);if(this.channel=r,this.channelInfo=a,this.scales=a.scales,void 0===n.coordFrame)throw Error(`Specified experiment ${JSON.stringify(n.key)} does not have a valid coordinate frame`);this.coordinateFrame=n.coordFrame,!1===this.channelInfo.downsampled&&(this.scales=[a.scales[0]]),this.experiment=n.key;let o=(0,eb.kt)(s.window);if(void 0!==o){let e=Q.K4.create(),t=o.split(/,/);if(2===t.length)e[0]=(0,eb.jz)(t[0]),e[1]=(0,eb.jz)(t[1]);else if(1===t.length)e[0]=0,e[1]=(0,eb.jz)(t[1]);else throw Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(o)}`);if(this.window=e,this.window[0]===this.window[1])throw Error(`Invalid window. First element must be different from second: ${JSON.stringify(o)}.`)}let l=(0,eb.kt)(s.meshurl);void 0!==l&&(this.meshUrl=l);let d=(0,eb.kt)(s.encoding);if(void 0===d)d=this.dataType===ec.UINT8?"jpeg":"npz";else if(!ys.has(d))throw Error(`Invalid encoding: ${JSON.stringify(d)}.`);this.encoding=d}getSources(e){let t=this.scales[0].downsampleFactors,{rank:i}=this;return(0,Y.PK)(this.scales.map(n=>{let r=this.coordinateFrame.voxelOffsetBase,s=Q.R3.create();for(let e=0;e<3;++e)s[e]=Math.ceil(r[e]);let a=n.downsampleFactors,o=i+1,l=new Float32Array(o*o);l[l.length-1]=1;for(let e=0;e<3;++e){let n=a[e]/t[e];l[o*e+e]=n,l[o*i+e]=s[e]*n}4===i&&(l[3*o+3]=1);let d=n.imageSize;return pD({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:l,chunkDataSizes:[ya],baseVoxelOffset:s,upperVoxelBound:d,volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(yi,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:n.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:l}))}))}getMeshSource(){return void 0!==this.meshUrl?this.chunkManager.getChunkSource(yn,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}}let yu=/^([^/?]+)\/([^/?]+)(?:\/([^/?]+))?(?:\?(.*))?$/;function yc(e,t,i,n,r){return e.memoize.getUncounted({hostname:t,collection:r,experiment:n,type:"boss:getExperimentInfo"},()=>ye(i,`${t}/latest/collection/${r}/experiment/${n}/`,{}).then(e=>e.json()).then(s=>{var a,o,l,d,u,c;return a=s,o=e,l=t,d=i,u=r,c=n,(0,eb.PT)(a),Promise.all((0,eb.uq)(a,"channels",e=>(0,eb.m7)(e,e=>(function(e,t,i,n,r,s){return e.memoize.getUncounted({hostname:t,collection:r,experiment:n,channel:s,type:"boss:getChannelInfo"},()=>ye(i,`${t}/latest/collection/${r}/experiment/${n}/channel/${s}/`,{}).then(e=>e.json()).then(yl))})(o,l,d,c,u,e)))).then(e=>{let t=new Map;return e.forEach(e=>{t.set(e.key,e)}),function(e,t,i,n){let r=n.coordFrameKey;return e.memoize.getUncounted({hostname:t,coordinateframe:r,experimentInfo:n,type:"boss:getCoordinateFrame"},()=>ye(i,`${t}/latest/coord/${r}/`,{}).then(e=>e.json()).then(e=>(function(e,t){(0,eb.PT)(e);let i=(0,eb.uq)(e,"voxel_unit",e=>(0,eb.CT)(e,yo)),n=function(e){switch(e){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}(i),r=new Float32Array(3),s=new Float64Array(3),a=new Float64Array(3),o=new Float64Array(3),l=["x","y","z"];for(let t=0;t<3;++t){let i=l[t];r[t]=(0,eb.uq)(e,`${i}_voxel_size`,eb.o7),s[t]=r[t]/n,a[t]=(0,eb.uq)(e,`${i}_start`,eb.C$),o[t]=(0,eb.uq)(e,`${i}_stop`,eb.C$)}return t.coordFrame={voxelSizeBaseInMeters:s,voxelSizeBaseInOriginalUnits:r,voxelOffsetBase:a,imageSizeBase:o,voxelUnit:i,names:l},t})(e,n)))}(o,l,d,{channels:t,scalingLevels:(0,eb.uq)(a,"num_hierarchy_levels",eb.C$),coordFrameKey:(0,eb.uq)(a,"coord_frame",eb.ZE),coordFrame:void 0,key:(0,eb.uq)(a,"name",eb.ZE),collection:(0,eb.uq)(a,"collection",eb.ZE)})})}))}let yh=/^((?:http|https):\/\/[^/?]+)\/(.*)$/;class yp extends de{credentialsManager;constructor(e){super(),this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){let t=function(e){let t=e.match(/^(?:https:\/\/[^.]+([^/]+))/);if(null===t)throw Error(`Unable to construct auth server hostname from base hostname ${e}.`);return`https://auth${t[1]}/auth`}(e);return this.credentialsManager.getCredentialsProvider(v9,t)}get(e){let t=e.providerUrl.match(yh);if(null===t)throw Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let i=this.getCredentialsProvider(e.providerUrl);return function(e,t,i,n){let r=n.match(yu);if(null===r)throw Error(`Invalid volume path ${JSON.stringify(n)}`);let s=r[1],a=r[2],o=r[3],l=(0,eb.Re)(r[4]||"");return e.memoize.getUncounted({hostname:t,path:n,type:"boss:getVolume"},async()=>{var n,r,d,u,c,h;let p=await yc(e,t,i,a,s);let g=await (n=e,r=t,d=i,u=s,c=p,h=o,n.memoize.getUncounted({hostname:r,collection:u,experiment:c.key,channel:h,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>ye(d,`${r}/latest/downsample/${u}/${c.key}/${h}`,{}).then(e=>e.json())).then(e=>(function(e,t,i){let n=t.coordFrame;if(void 0===n)throw Error(`Missing coordinate frame information for experiment ${t.key}. A valid coordinate frame is required to retrieve downsampling information.`);let r=t.channels.get(i);if(void 0===r)throw Error(`Specified channel ${JSON.stringify(i)} is not one of the supported channels ${JSON.stringify(Array.from(t.channels.keys()))}`);return r.scales=function(e,t){(0,eb.PT)(e);let i=(0,eb.uq)(e,"voxel_size",e=>(0,eb.ZI)(e,eb.et)),n=(0,eb.uq)(e,"extent",e=>(0,eb.ZI)(e,eb.gV)),r=(0,eb.uq)(e,"num_hierarchy_levels",eb.C$),s=[];for(let e=0;e<r;e++){let r=String(e),a=i.get(r),o=n.get(r);if(void 0===a||void 0===o)throw Error(`Missing voxel_size/extent for resolution ${r}.`);let l=new Float32Array(3);for(let e=0;e<3;++e)l[e]=a[e]/t[e];s[e]={downsampleFactors:l,imageSize:o,key:r}}return s}(e,n.voxelSizeBaseInOriginalUnits),t.channels.set(i,r),t})(e,c,h))),m=new yd(e,t,i,g,o,l),f=g.coordFrame,v={lowerBounds:f.voxelOffsetBase,upperBounds:Float64Array.from(f.imageSizeBase,(e,t)=>f.voxelOffsetBase[t]+e)};return{modelTransform:tj(tR({rank:3,names:f.names,units:["m","m","m"],scales:f.voxelSizeBaseInMeters,boundingBoxes:[tU(v)]})),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:tr(v)}}]}})}(e.chunkManager,t[1],i,t[2])}async completeUrl(e){let t=e.providerUrl.match(yh);if(null===t)throw null;let i=t[1],n=this.getCredentialsProvider(t[1]),r=t[2],s=await function(e,t,i,n){var r,s,a,o,l,d,u;let c=n.match(/^(?:([^/]+)(?:\/?([^/]*)(?:\/?([^/]*)(?:\/?([^/]*)?))?)?)?$/);if(null===c||void 0===c[1])return Promise.reject(null);if(void 0===c[2]){;let n=c[1]||"";return(r=e,s=t,a=i,r.memoize.getUncounted({hostname:s,type:"boss:getCollections"},()=>ye(a,`${s}/latest/collection/`,{}).then(e=>e.json()).then(e=>(0,eb.uq)(e,"collections",e=>(0,eb.m7)(e,eb.ZE))))).then(e=>({offset:0,completions:l3(n,e,e=>e+"/",()=>void 0)}))}if(void 0===c[3]){;let n=c[2]||"";return(o=e,l=t,d=i,u=c[1],o.memoize.getUncounted({hostname:l,collection:u,type:"boss:getExperiments"},()=>ye(d,`${l}/latest/collection/${u}/experiment/`,{}).then(e=>e.json()).then(e=>(0,eb.uq)(e,"experiments",e=>(0,eb.m7)(e,eb.ZE))))).then(e=>({offset:c[1].length+1,completions:l3(n,e,e=>e+"/",()=>void 0)}))}return yc(e,t,i,c[2],c[1]).then(e=>{let t=l3(c[3],e.channels,e=>e[0],e=>`${e[1].channelType} (${ec[e[1].dataType]})`);return{offset:c[1].length+c[2].length+2,completions:t}})}(e.chunkManager,i,n,r);return l1(t[1].length+1,s)}}let yg=new Map;function ym(e,t){yg.set(e,t)}ym("boss",e=>new yp(e.credentialsManager));class yf extends ef.gj{errorHandler=async(e,t)=>{let{status:i}=e;if(401===i||403===i&&!t.accessToken)return"refresh";throw e instanceof Error&&void 0!==t.email&&(e.message+=`  (Using credentials for ${JSON.stringify(t.email)})`),e}}function yv(e){let t,i,n;return(r,s)=>void 0!==i&&(void 0===t||void 0===r||t.generation!==r.generation)?(void 0===t&&n.addConsumer(s),iU(i,s)):(t=void 0,i=e(r,(n=new iB).signal).then(e=>(t=e,n[Symbol.dispose](),n=void 0,e),e=>{throw n[Symbol.dispose](),n?.signal.aborted&&(n=void 0,i=void 0),e}))}function yy(e){let t=0;return yv((i,n)=>e(n).then(e=>({generation:++t,credentials:e})))}class yb{providers=new Map;topLevelManager=this;register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let i=this.providers.get(e);if(void 0===i)throw Error(`No registered credentials provider: ${JSON.stringify(e)}`);return i(t,this.topLevelManager)}}class yS extends ef.gj{base;memoize;constructor(e){super(),this.base=e,this.memoize=new ld.O}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class yw extends yf{baseProvider;anonymousCredentials;anonymous;constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=yv(e=>this.anonymous&&void 0===e?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e)))}get}let yC=new class e extends yS{constructor(){super(new yb),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}};function yx(e,t){let i;let{requestDescription:n="login"}=e,r=new ai(!0,!0);return new Promise((s,a)=>{let o=iF(t,e=>{void 0!==i&&(i.abort(e),i=void 0,r.dispose(),a(e))});function l(t=`${e.description} ${n} required.`,i=`Request ${n}.`){r.setText(t+"  ");let s=document.createElement("button");s.textContent=i,r.element.appendChild(s),s.addEventListener("click",()=>{d(!1)})}function d(t){i?.abort(),i=new AbortController,l(`Waiting for ${e.description} ${n}...`,"Retry"),e.get(i.signal,t).then(e=>{void 0!==i&&(i=void 0,r.dispose(),o?.[Symbol.dispose]()),s(e)},s=>{if(void 0!==i)i=void 0,r.setVisible(!0),r.setModal(!0),t?l():l(`${e.description} ${n} failed: ${s}.`,"Retry")})}!0===e.supportsImmediate?d(!0):(l(),r.setVisible(!0))})}class yE extends Error{constructor(){super("Authentication window was closed")}}function yT(e,t){window.addEventListener("beforeunload",()=>{e.close()},{signal:t.signal});let i=setInterval(()=>{e.closed&&t.abort(new yE)},1e3);t.signal.addEventListener("abort",()=>{try{e.close()}catch{}clearInterval(i)})}async function yk(e,t){var n,r,s,a;let o,l=e$(),d=e$();let u=(n={state:l,clientId:e.clientId,redirect_uri:new URL(i(2959),i.b).href,authServer:e.authServer,nonce:d},o=`${n.authServer}/realms/BOSS/protocol/openid-connect/auth?client_id=${encodeURIComponent(n.clientId)}&redirect_uri=${encodeURIComponent(n.redirect_uri)}&response_mode=fragment&response_type=code%20id_token%20token`,n.state&&(o+=`&state=${n.state}`),n.nonce&&(o+=`&nonce=${n.nonce}`),o),c=new AbortController;t=AbortSignal.any([c.signal,t]);try{;let e=open(u);if(null===e)throw Error("Failed to create authentication popup window");return yT(e,c),await iU((r=e,s=l,a=c.signal,new Promise((e,t)=>{window.addEventListener("message",i=>{if(i.origin===location.origin){if(i.source===r)try{let t=(0,eb.PT)(JSON.parse(i.data));if("bossAuthCallback"!==(0,eb.uq)(t,"service",eb.ZE))throw Error("Unexpected service");if((0,eb.uq)(t,"state",eb.ZE)!==s)throw Error("invalid state");let n=(0,eb.uq)(t,"access_token",eb.ZE);e(n)}catch(e){t(Error(`Received unexpected authentication response: ${e.message}`)),console.error("Response received: ",i.data)}}},{signal:a})})),t)}finally{c.abort()}}class yD extends yf{authServer;constructor(e){super(),this.authServer=e,this.get=yy(e=>yx({description:"Boss",get:e=>yk({realm:"boss",clientId:"endpoint",authServer:this.authServer},e)},e))}get}yC.register(v9,e=>new yD(e));let yP="google-brainmaps";function yL(e,t,i){return vR(t,`${e.serverUrl}${i.path}`,{signal:i.signal,method:i.method,body:i.payload})}var yI=i("3488");class yR extends ly(vx()(pR),yI.LV){}class yA extends ly(vx()(hV),yI.f5){}class yM extends ly(vx()(hL),yI.i6){}class yN extends ly(vx()(px),yI.zT){}class yV extends ly(vx()(lW),yI.WM){}let yO=new Map;function y_(e){(0,eb.PT)(e);try{return{corner:(0,eb.uq)(e,"corner",e=>(0,eb.V3)(Q.R3.create(),e,eb.jz)),size:(0,eb.uq)(e,"size",e=>(0,eb.V3)(Q.R3.create(),e,eb.o7)),metadata:(0,eb.uq)(e,"metadata",eb.kt)}}catch(e){throw Error(`Failed to parse bounding box: ${e.message}`)}}yO.set("UINT8",ec.UINT8),yO.set("FLOAT",ec.FLOAT32),yO.set("UINT32",ec.UINT32),yO.set("UINT64",ec.UINT64);class yF{numChannels;dataType;voxelSize;upperVoxelBound;boundingBoxes;constructor(e){try{(0,eb.PT)(e),this.numChannels=(0,eb.uq)(e,"channelCount",eb.Sc),this.dataType=(0,eb.uq)(e,"channelType",e=>(0,eb.DY)(e,yO)),this.voxelSize=(0,eb.uq)(e,"pixelSize",e=>(0,eb.V3)(Q.R3.create(),e,eb.o7)),this.upperVoxelBound=(0,eb.uq)(e,"volumeSize",e=>(0,eb.V3)(Q.R3.create(),e,eb.Sc)),this.boundingBoxes=(0,eb.uq)(e,"boundingBox",e=>void 0===e?[]:(0,eb.m7)(e,y_))}catch(e){throw Error(`Failed to parse BrainMaps volume geometry: ${e.message}`)}}}function yB(e){return(0,eb.PT)(e),{name:(0,eb.uq)(e,"name",eb.ZE),type:(0,eb.uq)(e,"type",eb.ZE)}}let yU="([0-9]+)",y$=RegExp(`^(.*)_${yU}x${yU}x${yU}_lod([0-9]+)_([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)$`);class yG{scales;numChannels;dataType;box;constructor(e){try{(0,eb.PT)(e);let t=this.scales=(0,eb.uq)(e,"geometry",e=>(0,eb.m7)(e,e=>new yF(e)));if(0===t.length)throw Error("Expected at least one scale.");let i=t[0],n=this.numChannels=i.numChannels,r=this.dataType=i.dataType;for(let e=1,i=t.length;e<i;++e){let i=t[e];if(i.dataType!==r)throw Error(`Scale ${e} has data type ${ec[i.dataType]} but scale 0 has data type ${ec[r]}.`);if(i.numChannels!==n)throw Error(`Scale ${e} has ${i.numChannels} channel(s) but scale 0 has ${n} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(i.upperVoxelBound)}}catch(e){throw Error(`Failed to parse BrainMaps multiscale volume specification: ${e.message}`)}}getModelSpace(e=!1){let t=this.scales[0],i=["x","y","z"],n=["m","m","m"],r=Array.from(t.voxelSize,e=>e/1e9),s=Array.from(t.upperVoxelBound);return e&&(i.push("c^"),n.push(""),r.push(1),[0,0,0].push(0),s.push(this.numChannels)),tR({names:i,units:n,scales:Float64Array.from(r),boundingBoxes:[tU({lowerBounds:new Float64Array(i.length),upperBounds:Float64Array.from(s)})]})}}class yz extends pM{instance;credentialsProvider;volumeId;changeSpec;multiscaleVolumeInfo;volumeType;get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return 1!==this.multiscaleVolumeInfo.numChannels?4:3}encoding;jpegQuality;chunkLayoutPreference;constructor(e,t,i,n,r,s,a){super(e),this.instance=t,this.credentialsProvider=i,this.volumeId=n,this.changeSpec=r,this.multiscaleVolumeInfo=s,this.encoding=a.encoding,this.jpegQuality=a.jpegQuality,this.chunkLayoutPreference=a.chunkLayoutPreference;let o=pE.IMAGE;this.dataType===ec.UINT64&&(o=pE.SEGMENTATION),this.volumeType=o}getSources(e){let t=yI.ke.RAW;(this.dataType===ec.UINT64||this.dataType===ec.UINT32)&&this.volumeType===pE.SEGMENTATION&&this.encoding!==yI.ke.RAW?t=yI.ke.COMPRESSED_SEGMENTATION:this.volumeType===pE.IMAGE&&this.dataType===ec.UINT8&&1===this.multiscaleVolumeInfo.numChannels&&this.encoding!==yI.ke.RAW&&!0!==e.discreteValues&&(t=yI.ke.JPEG);let i=t===yI.ke.JPEG?this.jpegQuality:void 0,n=this.scales[0],{upperVoxelBound:r}=n,s=Q.R3.create(),{rank:a}=this;return(0,Y.PK)(this.scales.map((o,l)=>{let d;Q.R3.divide(s,o.voxelSize,n.voxelSize);let u=o.upperVoxelBound,{numChannels:c}=o,h=new Float32Array((a+1)**2);h[(a+1)*a+a]=1;let p=new Float32Array(a);1!==c&&(u=Float32Array.of(...u,c),d=Uint32Array.of(1,1,1,c),h[(a+1)*3+3]=1,p[3]=c);for(let e=0;e<3;++e)h[(a+1)*e+e]=s[e],p[e]=r[e]/s[e];return pD({rank:a,minBlockSize:d,chunkToMultiscaleTransform:h,dataType:o.dataType,upperVoxelBound:u,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:Q.R3.fromValues(64,64,64)}).map(e=>({chunkSource:this.chunkManager.getChunkSource(yR,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:l,encoding:t,jpegQuality:i,instance:this.instance}}),chunkToMultiscaleTransform:h,upperClipBound:p}))}))}}function yj(e){try{return(0,eb.PT)(e),{id:(0,eb.uq)(e,"id",eb.ZE),label:(0,eb.uq)(e,"label",eb.ZE),description:(0,eb.uq)(e,"description",eb.kt)}}catch(e){throw Error(`Failed to parse project: ${e.message}`)}}function yW(e){try{return(0,eb.PT)(e),(0,eb.uq)(e,"project",e=>void 0===e?[]:(0,eb.m7)(e,yj))}catch(e){throw Error(`Error parsing project list: ${e.message}`)}}function yq(e,t){try{return(0,eb.PT)(e),(0,eb.uq)(e,t,e=>void 0===e?[]:(0,eb.m7)(e,eb.ZE))}catch(e){throw Error(`Error parsing dataset list: ${e.message}`)}}let yH=ly(vx()(lQ),yI.Jb);class yJ extends yH{credentialsProvider;constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t}),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){let{upperVoxelBound:e}=this.parameters,t=oQ({rank:3,chunkDataSize:e,upperVoxelBound:e}),i=Q._E.create();return[[{chunkSource:this.chunkManager.getChunkSource(yV,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:i,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:i}]]}}let yK=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class yZ extends de{instance;credentialsProvider;constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:(0,nd.M)(this.credentialsProvider)},()=>yL(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`}).then(e=>e.json()).then(e=>new yG(e)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:(0,nd.M)(this.credentialsProvider)},()=>yL(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`}).then(e=>e.json()).then(e=>(function(e){try{return(0,eb.PT)(e),(0,eb.uq)(e,"meshes",e=>void 0===e?[]:(0,eb.m7)(e,yB))}catch(e){throw Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}})(e)))}get(e){let{volumeId:t,changeSpec:i,meshName:n,parameters:r}=function(e){let t;let i=e.match(/^([^:?/]+:[^:?/]+:[^:?/]+)(?::([^:?/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(null===i)throw Error(`Invalid Brain Maps volume key: ${JSON.stringify(e)}.`);void 0!==i[2]&&(t={changeStackId:i[2]});let n=(0,eb.Re)(i[4]||"");return{volumeId:i[1],changeSpec:t,meshName:i[3],parameters:n}}(e.providerUrl);(0,eb.PT)(r);let s=(0,eb.Kh)(r,"encoding",e=>(0,eb.CT)(e,yI.ke)),a=(0,eb.Kh)(r,"jpegQuality",e=>{let t=(0,eb.C$)(e);if(t<1||t>100)throw Error(`Expected integer in range [1, 100], but received: ${e}`);return t},70),o={encoding:s,chunkLayoutPreference:(0,eb.Kh)(r,"chunkLayout",e=>(0,eb.CT)(e,oX)),jpegQuality:a};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:i,brainmapsOptions:o},async()=>{let[r,s]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),a=new yz(e.chunkManager,this.instance,this.credentialsProvider,t,i,r,o),l={modelTransform:tj(r.getModelSpace(1!==r.numChannels)),subsources:[{id:void 0===n?"default":"volume",subsource:{volume:a},default:void 0===n}]},d=tr(r.box);r.scales[0].boundingBoxes.forEach((e,t)=>{d.add({type:eW.AXIS_ALIGNED_BOUNDING_BOX,description:e.metadata,pointA:e.corner,pointB:Q.R3.add(Q.R3.create(),e.corner,e.size),id:`boundingBox${t}`,properties:[]})}),l.subsources.push({id:"bounds",subsource:{staticAnnotations:d},default:!0});let u=function(e,t){let i=function(e,t){let i=new Map,n=e.scales[0],r=new Set;for(let e of t){if("TRIANGLES"!==e.type)continue;let t=e.name.match(y$);if(null===t)continue;let s=t[1],a=i.get(s);void 0===a&&(a={key:s,chunkShape:Q.R3.create(),lods:[]},i.set(s,a));let o=parseInt(t[5]);if(void 0!==a.lods[o]){r.add(s);continue}let l=Q.R3.fromValues(parseInt(t[2],10),parseInt(t[3],10),parseInt(t[4],10)),d=new Uint32Array(3);for(let e=0;e<3;++e)d[e]=Math.ceil(n.upperVoxelBound[e]/l[e]);a.lods[o]={info:e,scale:parseFloat(t[6]),relativeBlockShape:l,gridShape:d}}let s=[];n:for(let e of i.values()){if(r.has(e.key))continue;let t=e.lods[0];if(void 0===t)continue;let i=t.relativeBlockShape;Q.R3.multiply(e.chunkShape,i,n.voxelSize);for(let t=1;t<e.lods.length;++t){let n=e.lods[t];if(void 0===n)continue n;let{relativeBlockShape:r}=n;for(let e=0;e<3;++e){let t=r[e],n=i[e];if(t<n||t%n!=0)continue n;r[e]=t/n}}i.fill(1),s.push(e)}return s}(e,t),n=[],r=e=>{if(!n.some(t=>t.name===e.name))n.push(e)},s=new Set;for(let e of i)for(let t of(r({multi:e,single:void 0,name:e.key,partOfMultiscale:!1}),e.lods))s.add(t.info);for(let e of t)r({single:e,multi:void 0,name:e.name,partOfMultiscale:s.has(e)});return n}(r,s),c=(s,a)=>{let o;let{single:d}=s;if(void 0!==d)o="TRIANGLES"===d.type?e.chunkManager.getChunkSource(yM,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:d.name,changeSpec:i}}):e.chunkManager.getChunkSource(yN,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:s.name,changeSpec:i}});else{let n=s.multi;o=e.chunkManager.getChunkSource(yA,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:uQ.k_.float32},parameters:{instance:this.instance,volumeId:t,info:n,changeSpec:i}})}l.subsources.push({id:void 0===n?`/${s.name}`:"default",subsource:{mesh:o},subsourceToModelSubspaceTransform:function(e){let t=Q._E.create(),i=e.scales[0].voxelSize;for(let e=0;e<3;++e)t[5*e]=1/i[e];return t}(r),modelSubspaceDimensionIndices:[0,1,2],default:a})};if(void 0!==n){let e=u.find(e=>e.name===n);if(void 0===e)throw Error(`Mesh/skeleton source not found: ${JSON.stringify(e)}`);c(e,!0)}else{let e=!0;for(let t of u)!t.partOfMultiscale&&(c(t,e),e=!1)}return void 0!==i&&l.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(yJ,{parameters:{volumeId:t,changestack:i.changeStackId,instance:this.instance,upperVoxelBound:r.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),l})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let e=yL(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects"}).then(e=>e.json()).then(e=>yW(e)),t=`${this.instance.description} project list`;return ai.forPromise(e,{delay:!0,initialMessage:`Retrieving ${t}.`,errorPrefix:`Error retrieving ${t}: `}),e})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let e=yL(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`}).then(e=>e.json()).then(e=>yq(e,"datasetIds")),i=`${this.instance.description} dataset list`;return ai.forPromise(e,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),e})}getVolumeList(e,t,i){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${i}:getVolumeList`},()=>{let e=yL(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${i}`}).then(e=>e.json()).then(e=>{let n=yq(e,"volumeId"),r=t.length+i.length+2,s=[];for(let e of n)s.push(e.substring(r));return s}),n=`${this.instance.description} volume list`;return ai.forPromise(e,{delay:!0,initialMessage:`Retrieving ${n}`,errorPrefix:`Error retrieving ${n}`}),e})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let e=yL(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`}).then(e=>e.json()).then(e=>{var t;return t=e,(0,eb.uq)(t,"changeStackId",e=>void 0===e?void 0:(0,eb.m7)(e,eb.ZE))}),i=`change stacks for ${t}`;return ai.forPromise(e,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),e})}async completeUrl(e){let{providerUrl:t}=e,i=t.match(/^([^:/?]*)(?::([^:/?]*)(?::([^:/?]*)(?::([^:/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(null===i)throw null;let[,n,r,s,a,o,l]=i;if(void 0!==l)return l1(t.length-l.length,await l6(l,yK));if(void 0!==o){let i=`${n}:${r}:${s}`,a=await this.getMeshesInfo(e.chunkManager,i),l=[],d=new Set;for(let e of a)if(e.name.startsWith(o))switch(e.type){case"LINE_SEGMENTS":l.push({value:e.name,description:"Skeletons"});break;case"TRIANGLES":{l.push({value:e.name,description:"Mesh (single-resolution)"});let t=e.name.match(y$);if(null!==t){let e=t[1];if(d.has(e))break;d.add(e),l.push({value:e,description:"Mesh (multi-resolution)"})}}}return l.sort((e,t)=>(0,ac.B)(e.value,t.value)),{offset:t.length-o.length,completions:l}}if(void 0!==a){let i=`${n}:${r}:${s}`,o=await this.getChangeStackList(e.chunkManager,i);if(void 0===o)throw null;return{offset:t.length-a.length,completions:l2(a,o)}}if(void 0!==s)return{offset:t.length-s.length,completions:l2(s,await this.getVolumeList(e.chunkManager,n,r))};if(void 0!==r){let i=await this.getDatasetList(e.chunkManager,n);return{offset:t.length-r.length,completions:l2(r,i.map(e=>`${e}:`))}}return{offset:0,completions:l3(n,await this.getProjectList(e.chunkManager),e=>`${e.id}:`,e=>e.label)}}}let yY={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};if(ym("brainmaps",e=>new yZ(yY,e.credentialsManager.getCredentialsProvider(yP))),"undefined"!=typeof NEUROGLANCER_BRAINMAPS_SERVERS)for(let[e,t]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))ym(`brainmaps-${e}`,e=>new yZ(t,e.credentialsManager.getCredentialsProvider(yP)));async function yX(e,t){let n=e$(),r=function(e){let t=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${encodeURIComponent(e.clientId)}`,n=new URL(i(7984),i.b).href;t+=`&redirect_uri=${n}`;let r="token",{scopes:s}=e;return s.includes("email")&&s.includes("openid")&&(r="token%20id_token"),t+=`&response_type=${r}`,!0===e.includeGrantedScopes&&(t+="&include_granted_scopes=true"),t+=`&scope=${encodeURIComponent(s.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),void 0!==e.nonce&&(t+=`&nonce=${e.nonce}`),void 0!==e.authUser&&(t+=`&authuser=${e.authUser}`),t}({state:n,nonce:e$(),clientId:e.clientId,scopes:e.scopes,approvalPrompt:e.approvalPrompt,loginHint:e.loginHint,immediate:e.immediate,authUser:e.authUser}),s=new AbortController;t=AbortSignal.any([s.signal,t]);try{var a,o,l;let i;if(e.immediate)i=function(e,t){let i=document.createElement("iframe");return i.src=e,i.style.display="none",i.addEventListener("load",()=>{null==i.contentDocument&&t.abort(Error("Immediate authentication failed"))},{signal:t.signal}),document.body.appendChild(i),t.signal.addEventListener("abort",()=>{sR(i)}),i.contentWindow}(r,s);else{let e=open(r);if(null===e)throw Error("Failed to create authentication popup window");yT(e,s),i=e}return await iU((a=i,o=n,l=s.signal,new Promise((e,t)=>{window.addEventListener("message",i=>{if(i.origin===location.origin){if(i.source===a)try{let t=(0,eb.PT)(i.data);if((0,eb.uq)(t,"state",eb.ZE)!==o)throw Error("invalid state");let n=(0,eb.uq)(t,"id_token",eb.ZE),r={accessToken:(0,eb.uq)(t,"access_token",eb.ZE),tokenType:(0,eb.uq)(t,"token_type",eb.ZE),expiresIn:(0,eb.uq)(t,"expires_in",eb.ZE),scope:(0,eb.uq)(t,"scope",eb.ZE),email:function(e){let t=e.split(".");try{if(3!==t.length)throw Error("Invalid JWT format");let e=atob(t[1]),i=JSON.parse(e);return(0,eb.PT)(i),(0,eb.uq)(i,"email",eb.ZE)}catch(e){throw Error(`Failed to decode id token: ${e.message}`)}}(n)};e(r)}catch(e){t(Error(`Received unexpected authentication response: ${e.message}`)),console.error("Response received: ",i.data)}}},{signal:l})})),t)}finally{s.abort()}}class yQ extends yf{options;constructor(e){super(),this.options=e,this.get=yy(e=>yx({description:this.options.description,supportsImmediate:!0,get:(e,t)=>yX({clientId:this.options.clientId,scopes:this.options.scopes,immediate:t,authUser:0},e)},e))}get}class y0 extends yQ{constructor(e){super({clientId:e,scopes:["https://www.googleapis.com/auth/brainmaps","openid","email"],description:"Brain Maps"})}}yC.register(yP,()=>new y0("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));var y1=i("7484"),y2=i("602");async function y3(e,t,i,n,r){let s=await vR(e,`https://www.googleapis.com/storage/v1/b/${t}/o?delimiter=${encodeURIComponent(n)}&prefix=${encodeURIComponent(i)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{signal:r}).then(e=>e.json());(0,eb.PT)(s);let a=(0,eb.Kh)(s,"prefixes",eb.zE,[]);return[...a,...(0,eb.Kh)(s,"items",e=>(0,eb.m7)(e,e=>((0,eb.PT)(e),(0,eb.uq)(e,"name",eb.ZE))),[]).filter(e=>!e.endsWith("_$folder$"))]}async function y4(e,t,i,n,r){if(!n.startsWith("/"))throw null;let s=await y3(e,i,n.substring(1),"/",r),a=n.lastIndexOf("/");return{offset:a+t.length+1,completions:s.map(e=>({value:e.substring(a)}))}}async function y6(e,t,i){let n=await v_(i,e,{headers:{accept:"text/html"},signal:t}),r=n.headers.get("content-type");if(null===r||null===/\btext\/html\b/i.exec(r))return[];let s=await n.text(),a=new DOMParser().parseFromString(s,"text/html"),o=a.evaluate("//a/@href",a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let t=0,i=o.snapshotLength;t<i;++t){let i=o.snapshotItem(t).textContent;i&&l.push(new URL(i,e).toString())}return l}async function y5(e,t,i){console.log("getHtmlPathCompletions");let n=e.match(/^([a-z]+:\/\/.*\/)([^/?#]*)$/);if(null===n)throw null;let r=await y6(n[1],t,i),s=n[1].length,a=[];for(let t of r)t.startsWith(e)&&a.push({value:t.substring(s)});return{offset:s,completions:a}}let y8=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function y7(e,t,i){let n;if(!t.includes("://"))return{offset:0,completions:l3(t,y8,e=>e.value,e=>e.description)};let{url:r,credentialsProvider:s}=vO(t,e),a=t.length-r.length;try{n=vP(r)}catch{throw null}let{protocol:o,host:l,path:d}=n,u=await (async()=>{if("gs+xml"===o&&d.length>0)return await vM(s,`${o}://${l}`,`https://storage.googleapis.com/${l}`,d,i);if("gs"===o&&d.length>0)return await y4(s,`${o}://${l}`,l,d,i);if("s3"===o&&d.length>0)return await vN(l,d,i);let e=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^/]+|[^/]+\.storage\.googleapis\.com|[^/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(null!==e)return await vM(s,e[1],e[1],e[2],i);if(("http"===o||"https"===o)&&d.length>0)return await y5(r,i,s);throw null})();return{offset:a+u.offset,completions:u.completions}}class y9 extends ly(vx()(pR),y2.Yz){}class be extends ly(vx()(hL),y2.i6){}class bt extends ly(vx()(hV),y2.f5){}class bi extends ly(vx()(px),y2.zT){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function bn(e,t){let i=e.split("/");for(let e of t.split("/")){if(".."===e&&0!==i.length){i.length=i.length-1;continue}i.push(e)}return i.join("/")}class br{key;encoding;resolution;voxelOffset;size;chunkSizes;compressedSegmentationBlockSize;sharding;hidden;constructor(e,t){(0,eb.PT)(e);let i=1===t?3:4,n=this.resolution=new Float64Array(i),r=this.voxelOffset=new Float32Array(i),s=this.size=new Float32Array(i);if(4===i&&(n[3]=1,s[3]=t),(0,eb.uq)(e,"resolution",e=>(0,eb.Iw)(n.subarray(0,3),e,eb.o7)),(0,eb.Kh)(e,"voxel_offset",e=>(0,eb.Iw)(r.subarray(0,3),e,eb.C$)),(0,eb.uq)(e,"size",e=>(0,eb.Iw)(s.subarray(0,3),e,eb.Sc)),this.chunkSizes=(0,eb.uq)(e,"chunk_sizes",e=>(0,eb.m7)(e,e=>{let n=new Uint32Array(i);return 4===i&&(n[3]=t),(0,eb.Iw)(n.subarray(0,3),e,eb.Sc),n})),0===this.chunkSizes.length)throw Error("No chunk sizes specified.");if(this.sharding=(0,eb.uq)(e,"sharding",bp),void 0!==this.sharding&&1!==this.chunkSizes.length)throw Error("Sharding requires a single chunk size per scale");(this.encoding=(0,eb.uq)(e,"encoding",e=>(0,eb.CT)(e,y2.ke)))===y2.ke.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=(0,eb.uq)(e,"compressed_segmentation_block_size",e=>(0,eb.Iw)(Q.R3.create(),e,eb.Sc))),this.key=(0,eb.uq)(e,"key",eb.ZE),this.hidden=(0,eb.uq)(e,"hidden",eb.ds)??!1}}function bs(e){(0,eb.PT)(e);let t=(0,eb.uq)(e,"data_type",e=>(0,eb.CT)(e,ec)),i=(0,eb.uq)(e,"num_channels",eb.Sc),n=(0,eb.uq)(e,"type",e=>(0,eb.CT)(e,pE)),r=(0,eb.uq)(e,"mesh",eb.kt),s=(0,eb.uq)(e,"skeletons",eb.kt),a=(0,eb.uq)(e,"segment_properties",eb.kt),o=(0,eb.uq)(e,"scales",e=>(0,eb.m7)(e,e=>new br(e,i)));if(0===o.length)throw Error("Expected at least one scale");let l=o[0],d=1===i?3:4,u=new Float64Array(d),c=new Float64Array(d),h=new Float64Array(d),p=["x","y","z"],g=["m","m","m"];for(let e=0;e<3;++e)u[e]=l.resolution[e]/1e9,c[e]=l.voxelOffset[e],h[e]=c[e]+l.size[e];return 4===d&&(u[3]=1,h[3]=i,p[3]="c^",g[3]=""),{dataType:t,volumeType:n,mesh:r,skeletons:s,segmentPropertyMap:a,scales:o,modelSpace:tR({rank:d,names:p,units:g,scales:u,boundingBoxes:[tU({lowerBounds:c,upperBounds:h})]})}}class ba extends pM{credentialsProvider;url;info;get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}constructor(e,t,i,n){super(e),this.credentialsProvider=t,this.url=i,this.info=n}getSources(e){let t=this.info.scales[0].resolution,{rank:i}=this;return(0,Y.PK)(this.info.scales.filter(e=>!e.hidden).filter(e=>"placeholder"!==e.key).map(n=>{let{resolution:r}=n,s=i+1,a=new Float32Array(s*s);a[a.length-1]=1;let{lowerBounds:o,upperBounds:l}=this.info.modelSpace.boundingBoxes[0].box,d=new Float32Array(i),u=new Float32Array(i);for(let e=0;e<3;++e){let c=r[e]/t[e];a[s*e+e]=c;let h=n.voxelOffset[e];a[s*i+e]=h*c,d[e]=o[e]/c-h,u[e]=l[e]/c-h}return 4===i&&(a[3*s+3]=1,d[3]=o[3],u[3]=l[3]),pD({rank:i,dataType:this.dataType,chunkToMultiscaleTransform:a,upperVoxelBound:n.size,volumeType:this.volumeType,chunkDataSizes:n.chunkSizes,baseVoxelOffset:n.voxelOffset,compressedSegmentationBlockSize:n.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(y9,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:bn(this.url,n.key),encoding:n.encoding,sharding:n.sharding}}),chunkToMultiscaleTransform:a,lowerClipBound:d,upperClipBound:u}))}))}}let bo=ly(vx()(lQ),y2.Jb);class bl extends ly(vx()(lW),y2.WM){}class bd extends bo{metadata;credentialsProvider;constructor(e,t){let{parameters:i}=t;super(e,{rank:i.rank,relationships:i.relationships.map(e=>e.name),properties:i.properties,parameters:i}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(bl,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function bu(e){return(0,eb.uq)(e,"transform",e=>{let t=Q._E.create();return void 0!==e&&(0,eb.Iw)(t.subarray(0,12),e,eb.jz),Q._E.transpose(t,t),t})}async function bc(e,t,i){let n;try{n=await by(e,t,i)}catch(e){if(vL(e))return{metadata:void 0};throw e}return function(e){let t;(0,eb.PT)(e);let i=(0,eb.uq)(e,"@type",eb.ZE);if("neuroglancer_legacy_mesh"===i)t=void 0;else if("neuroglancer_multilod_draco"!==i)throw Error(`Unsupported mesh type: ${JSON.stringify(i)}`);else{let i=(0,eb.uq)(e,"lod_scale_multiplier",eb.o7),n=(0,eb.uq)(e,"vertex_quantization_bits",eb.Sc),r=bu(e);t={lodScaleMultiplier:i,transform:r,sharding:(0,eb.uq)(e,"sharding",bp),vertexQuantizationBits:n}}return{metadata:t,segmentPropertyMap:(0,eb.uq)(e,"segment_properties",eb.kt)}}(n)}function bh(e){return void 0===e?y2.qm.RAW:(0,eb.CT)(e,y2.qm)}function bp(e){if(void 0===e)return;(0,eb.PT)(e);let t=(0,eb.uq)(e,"@type",eb.ZE);if("neuroglancer_uint64_sharded_v1"!==t)throw Error(`Unsupported sharding format: ${JSON.stringify(t)}`);let i=(0,eb.uq)(e,"hash",e=>(0,eb.CT)(e,y2.wC)),n=(0,eb.uq)(e,"preshift_bits",eb.C$),r=(0,eb.uq)(e,"shard_bits",eb.C$),s=(0,eb.uq)(e,"minishard_bits",eb.C$),a=(0,eb.uq)(e,"minishard_index_encoding",bh);return{hash:i,preshiftBits:n,shardBits:r,minishardBits:s,minishardIndexEncoding:a,dataEncoding:(0,eb.uq)(e,"data_encoding",bh)}}async function bg(e,t,i){return function(e){(0,eb.PT)(e);let t=(0,eb.uq)(e,"@type",eb.ZE);if("neuroglancer_skeletons"!==t)throw Error(`Unsupported skeleton type: ${JSON.stringify(t)}`);let i=bu(e),n=new Map;(0,eb.uq)(e,"vertex_attributes",e=>{void 0!==e&&(0,eb.m7)(e,e=>{(0,eb.PT)(e);let t=(0,eb.uq)(e,"id",eb.ZE);if(""===t)throw Error("vertex attribute id must not be empty");if(n.has(t))throw Error(`duplicate vertex attribute id ${JSON.stringify(t)}`);let i=(0,eb.uq)(e,"data_type",e=>(0,eb.CT)(e,ec)),r=(0,eb.uq)(e,"num_components",eb.Sc);n.set(t,{dataType:i,numComponents:r})})});let r=(0,eb.uq)(e,"sharding",bp);return{metadata:{transform:i,vertexAttributes:n,sharding:r},segmentPropertyMap:(0,eb.uq)(e,"segment_properties",eb.kt)}}(await by(e,t,i))}function bm(){return tR({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function bf(e,t,i){let n;let{metadata:r,segmentPropertyMap:s}=await bc(e,t,i);if(void 0===r){var a,o,l;return{source:(a=e,o=t,l={url:i,lod:0},a.getChunkSource(be,{parameters:l,credentialsProvider:o})),transform:Q._E.create(),segmentPropertyMap:s}}let{vertexQuantizationBits:d}=r;if(10===d)n=uQ.k_.uint10;else if(16===d)n=uQ.k_.uint16;else throw Error(`Invalid vertex quantization bits: ${d}`);return{source:e.getChunkSource(bt,{credentialsProvider:t,parameters:{url:i,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:n}}),transform:r.transform,segmentPropertyMap:s}}async function bv(e,t,i){let{metadata:n,segmentPropertyMap:r}=await bg(e,t,i);return{source:e.getChunkSource(bi,{credentialsProvider:t,parameters:{url:i,metadata:n}}),transform:n.transform,segmentPropertyMap:r}}function by(e,t,i){return e.memoize.getUncounted({type:"precomputed:metadata",url:i,credentialsProvider:(0,nd.M)(t)},async()=>await v_(t,`${i}/info`,{}).then(e=>e.json()))}function bb(e){let t=Q._E.create(),i=e.scales[0].resolution;for(let e=0;e<3;++e)t[5*e]=1/i[e];return t}async function bS(e,t,i,n){let r=bs(n),s=new ba(e.chunkManager,t,i,r),{modelSpace:a}=r,o=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:tr(a.bounds)}}];if(void 0!==r.segmentPropertyMap){let n=bn(i,r.segmentPropertyMap),s=await by(e.chunkManager,t,n),a=bD(e.chunkManager,t,s,n);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:a}})}if(void 0!==r.mesh){let n=bn(i,r.mesh),{source:s,transform:a}=await bf(e.chunkManager,t,n),l=bb(r);Q._E.multiply(l,l,a),o.push({id:"mesh",default:!0,subsource:{mesh:s},subsourceToModelSubspaceTransform:l})}if(void 0!==r.skeletons){let n=bn(i,r.skeletons),{source:s,transform:a}=await bv(e.chunkManager,t,n),l=bb(r);Q._E.multiply(l,l,a),o.push({id:"skeletons",default:!0,subsource:{mesh:s},subsourceToModelSubspaceTransform:l})}return{modelTransform:tj(a),subsources:o}}async function bw(e,t,i){let{source:n,transform:r,segmentPropertyMap:s}=await bv(e.chunkManager,t,i),a=[{id:"default",default:!0,subsource:{mesh:n},subsourceToModelSubspaceTransform:r}];if(void 0!==s){let n=bn(i,s),r=await by(e.chunkManager,t,n),o=bD(e.chunkManager,t,r,n);a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:o}})}return{modelTransform:tj(bm()),subsources:a}}function bC(e,t){return(0,eb.PT)(t),{url:bn(e,(0,eb.uq)(t,"key",eb.ZE)),sharding:(0,eb.uq)(t,"sharding",bp)}}class bx{url;coordinateSpace;parameters;spatialIndices;constructor(e,t){this.url=e,(0,eb.PT)(t);let i=(0,eb.uq)(t,"dimensions",tN),{rank:n}=i,r=(0,eb.uq)(t,"lower_bound",e=>(0,eb.Iw)(new Float64Array(n),e,eb.jz)),s=(0,eb.uq)(t,"upper_bound",e=>(0,eb.Iw)(new Float64Array(n),e,eb.jz));this.coordinateSpace=tR({rank:n,names:i.names,units:i.units,scales:i.scales,boundingBoxes:[tU({lowerBounds:r,upperBounds:s})]}),this.parameters={type:(0,eb.uq)(t,"annotation_type",e=>(0,eb.CT)(e,eW)),rank:n,relationships:(0,eb.uq)(t,"relationships",t=>(0,eb.m7)(t,t=>{let i=bC(e,t),n=(0,eb.uq)(t,"id",eb.ZE);return{...i,name:n}})),properties:(0,eb.uq)(t,"properties",e4),byId:(0,eb.uq)(t,"by_id",t=>bC(e,t))},this.spatialIndices=(0,eb.uq)(t,"spatial",t=>(0,eb.m7)(t,t=>{let i=bC(e,t),s=(0,eb.uq)(t,"grid_shape",e=>(0,eb.Iw)(new Float32Array(n),e,eb.Sc)),a=(0,eb.uq)(t,"chunk_size",e=>(0,eb.Iw)(new Float32Array(n),e,eb.o7)),o=(0,eb.uq)(t,"limit",eb.Sc),l=new Float32Array(n);for(let e=0;e<n;++e)l[e]=s[e]*a[e];let d=to.XD(Float32Array,n+1);for(let e=0;e<n;++e)d[(n+1)*n+e]=r[e];let u={limit:o,chunkToMultiscaleTransform:d,...oQ({rank:n,chunkDataSize:a,upperVoxelBound:l})};return u.upperChunkBound=s,{parameters:i,spec:u,limit:o}})),this.spatialIndices.reverse()}}async function bE(e,t,i,n){let r=new bx(i,n);return{modelTransform:tj(r.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:e.chunkManager.getChunkSource(bd,{credentialsProvider:t,metadata:r,parameters:r.parameters})}}]}}async function bT(e,t,i){let{source:n,transform:r,segmentPropertyMap:s}=await bf(e.chunkManager,t,i),a=[{id:"default",default:!0,subsource:{mesh:n},subsourceToModelSubspaceTransform:r}];if(void 0!==s){let n=bn(i,s),r=await by(e.chunkManager,t,n),o=bD(e.chunkManager,t,r,n);a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:o}})}return{modelTransform:tj(bm()),subsources:a}}function bk(e){(0,eb.PT)(e);let t=new eC.E,i=(0,eb.uq)(e,"ids",e=>{let i=(e=(0,eb.zE)(e)).length,n=new Uint32Array(2*i);for(let r=0;r<i;++r){if(!t.tryParseString(e[r]))throw Error(`Invalid uint64 id: ${JSON.stringify(e[r])}`);n[2*r]=t.low,n[2*r+1]=t.high}return n}),n=i.length/2;return function(e){let{ids:t}=e;if(function(e){let t=e.length;if(0===t)return!0;let i=e[0],n=e[1];for(let r=0;r<t;r+=2){let t=e[r],s=e[r+1];if(0>=(s-n||t-i))return!1;i=t,n=s}return!0}(t))return e;let i=t.length/2,n=hB(i,i-1);for(let e=0;e<i;++e)n[e]=e;n.sort((e,i)=>{let n=t[2*e],r=t[2*e+1],s=t[2*i];return r-t[2*i+1]||n-s});let r=new Uint32Array(2*i);for(let e=0;e<i;++e){let i=n[e];r[2*e]=t[2*i],r[2*e+1]=t[2*i+1]}return{ids:r,properties:e.properties.map(e=>{let{values:t}=e,r=new t.constructor(i);for(let e=0;e<i;++e)r[e]=t[n[e]];return{...e,values:r}})}}({ids:i,properties:(0,eb.uq)(e,"properties",e=>(0,eb.m7)(e,e=>{(0,eb.PT)(e);let t=(0,eb.uq)(e,"id",eb.ZE),i=(0,eb.Kh)(e,"description",eb.ZE),r=(0,eb.uq)(e,"type",e=>{if("label"!==e&&"description"!==e&&"string"!==e&&"tags"!==e&&"number"!==e)throw Error(`Invalid property type: ${JSON.stringify(e)}`);return e});if("tags"===r){let s=(0,eb.uq)(e,"tags",eb.zE),a=(0,eb.Kh)(e,"tag_descriptions",eb.zE);if(void 0===a)(a=Array(s.length)).fill("");else if(a.length!==s.length)throw Error(`Expected tag_descriptions to have length: ${s.length}`);return{id:t,description:i,type:r,tags:s,tagDescriptions:a,values:(0,eb.uq)(e,"values",e=>{if(!Array.isArray(e)||e.length!==n)throw Error(`Expected ${n} values, but received: ${e.length}`);return e.map(e=>String.fromCharCode(...e))})}}if("number"===r){let s=(0,eb.uq)(e,"data_type",e=>(0,eb.CT)(e,ec));if(s===ec.UINT64)throw Error("uint64 properties not supported");let a=(0,eb.uq)(e,"values",e=>{if(!Array.isArray(e)||e.length!==n)throw Error(`Expected ${n} values, but received: ${e.length}`);return eg[s].from(e)}),o=1/0,l=-1/0;for(let e=a.length-1;e>=0;--e){let t=a[e];t<o&&(o=t),t>l&&(l=t)}return{id:t,description:i,type:r,dataType:s,values:a,bounds:[o,l]}}return{id:t,description:i,type:r,values:(0,eb.uq)(e,"values",e=>{if((0,eb.zE)(e),e.length!==n)throw Error(`Expected ${n} values, but received: ${e.length}`);return e})}}))})}function bD(e,t,i,n){try{let e=(0,eb.uq)(i,"@type",eb.ZE);if("neuroglancer_segment_properties"!==e)throw Error(`Unsupported segment property map type: ${JSON.stringify(e)}`);let t=(0,eb.Kh)(i,"inline",bk);return new hU({inlineProperties:t})}catch(e){throw Error(`Error parsing segment property map: ${e.message}`)}}async function bP(e,t,i,n){return{modelTransform:tj(tM),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:bD(e.chunkManager,t,n,i)}}]}}ly(vx()(class e extends lv{properties;constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}),y2.S0);let bL=/^([^#]*)(?:#(.*))?$/;function bI(e){let[,t,i]=e.match(bL);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),{url:t,parameters:(0,eb.Re)(i||"")}}function bR(e,t){let i=(0,eb.qs)(t);return i&&(e+=`#${i}`),e}class bA extends de{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){let{url:t,parameters:i}=bI(e.providerUrl);return e.providerProtocol+"://"+bR(t,i)}convertLegacyUrl(e){let{url:t,parameters:i}=bI(e.providerUrl);return"mesh"===e.type&&(i.type="mesh"),e.providerProtocol+"://"+bR(t,i)}get(e){let{url:t,parameters:i}=bI(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:i},async()=>{let n;let{url:r,credentialsProvider:s}=vO(t,e.credentialsManager);try{n=await by(e.chunkManager,s,r)}catch(t){if(vL(t)&&"mesh"===i.type)return await bT(e,s,r);throw t}(0,eb.PT)(n);let a=(0,eb.Kh)(n,"redirect",eb.ZE);if(void 0!==a)throw new l5(a);let o=(0,eb.Kh)(n,"@type",eb.ZE);switch(o){case"neuroglancer_skeletons":return await bw(e,s,r);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await bT(e,s,r);case"neuroglancer_annotations_v1":return await bE(e,s,r,n);case"neuroglancer_segment_properties":return await bP(e,s,r,n);case"neuroglancer_multiscale_volume":case void 0:return await bS(e,s,r,n);default:throw Error(`Invalid type: ${JSON.stringify(o)}`)}})}completeUrl(e){return y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}class bM extends ly(vx()(pR),y1.j){}class bN extends pM{credentialsProvider;info;get dataType(){return ec.UINT8}get volumeType(){return pE.IMAGE}get rank(){return this.info.modelSpace.rank}url;constructor(e,t,i,n){super(e),this.credentialsProvider=t,this.info=n,this.url=i.substring(0,i.lastIndexOf("."))+"_files"}getSources(e){let{rank:t}=this,i=[Uint32Array.of(this.info.tilesize,this.info.tilesize,3)];return(0,Y.PK)(this.info.levels.map((n,r,s)=>{let a=1<<r,o=t+1,l=new Float32Array(o*o);l[l.length-1]=1;let{upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,u=new Float32Array(t);for(let e=0;e<2;++e)l[o*e+e]=a,u[e]=d[e]/a;return l[2*o+2]=1,u[2]=d[2],pD({rank:t,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:Float32Array.of(n.width,n.height,3),volumeType:this.volumeType,chunkDataSizes:i,volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(bM,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:bn(this.url,(s.length-1-r).toString()),encoding:this.info.encoding,format:this.info.format,overlap:this.info.overlap,tilesize:this.info.tilesize}}),chunkToMultiscaleTransform:l,upperClipBound:u}))}))}}async function bV(e,t,i,n){let r=function(e){let{width:t,height:i,tilesize:n,overlap:r,format:s}=e,a=(0,eb.CT)(s,y1.W),o=[],l=t,d=i;for(;l>1||d>1;)o.push({width:l,height:d}),l=Math.ceil(l/2),d=Math.ceil(d/2);o.push({width:l,height:d});let u=Float64Array.of(1/1e9,1/1e9,1),c=new Float64Array(3),h=Float64Array.of(t,i,3);return{levels:o,modelSpace:tR({rank:3,names:["x","y","c^"],units:["m","m",""],scales:u,boundingBoxes:[tU({lowerBounds:c,upperBounds:h})]}),overlap:r,tilesize:n,format:s,encoding:a}}(n),s=new bN(e.chunkManager,t,i,r),{modelSpace:a}=r,o=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:tr(a.bounds)}}];return{modelTransform:tj(a),subsources:o}}class bO extends de{get description(){return"Deep Zoom file-backed data source"}normalizeUrl(e){let{url:t,parameters:i}=bI(e.providerUrl);return e.providerProtocol+"://"+bR(t,i)}convertLegacyUrl(e){let{url:t,parameters:i}=bI(e.providerUrl);return e.providerProtocol+"://"+bR(t,i)}get(e){let{url:t,parameters:i}=bI(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"deepzoom:get",providerUrl:t,parameters:i},async()=>{let{url:i,credentialsProvider:n}=vO(t,e.credentialsManager),r=await function(e,t,i){if(i.endsWith(".json")||i.includes(".json?"))throw Error("DZI-JSON: OpenSeadragon hack not supported yet.");return e.memoize.getUncounted({type:"deepzoom:metadata",url:i,credentialsProvider:(0,nd.M)(t)},async()=>{let e=await v_(t,i,{}).then(e=>e.text()),n=new DOMParser().parseFromString(e,"text/xml").documentElement,r=(0,eb.PT)(n.getElementsByTagName("Size").item(0));return{width:(0,eb.Sc)(r.getAttribute("Width")),height:(0,eb.Sc)(r.getAttribute("Height")),tilesize:(0,eb.Sc)((0,eb.ZE)(n.getAttribute("TileSize"))),overlap:(0,eb.C$)((0,eb.ZE)(n.getAttribute("Overlap"))),format:(0,eb.ZE)(n.getAttribute("Format"))}})}(e.chunkManager,n,i);return bV(e,n,i,r)})}completeUrl(e){return y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}ym("deepzoom",()=>new bO);let b_="DVID";var bF=i("2600");let bB=new Map;bB.set("uint8",ec.UINT8),bB.set("uint32",ec.UINT32),bB.set("uint64",ec.UINT64);class bU{obj;get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}constructor(e){this.obj=e,(0,eb.PT)(e),(0,eb.uq)(e,"TypeName",eb.ZE)}}class b${obj;name;base;lowerVoxelBound;upperVoxelBoundInclusive;voxelSize;blockSize;numLevels;constructor(e,t,i){this.obj=e,this.name=t,this.base=i}}class bG extends ly(vx()(pR),bF.Yz){}class bz extends ly(vx()(px),bF.zT){}class bj extends ly(vx()(hL),bF.i6){}class bW extends b${encoding;dataType;meshSrc;skeletonSrc;constructor(e,t,i,n,r){super(e,t,i),this.encoding=n;let s=(0,eb.uq)(e,"Extended",eb.PT),a=(0,eb.uq)(s,"Values",e=>(0,eb.m7)(e,eb.PT));if(a.length<1)throw Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;let o=new Set(r);if(n===bF.ke.COMPRESSED_SEGMENTATIONARRAY){let e=(0,eb.uq)(s,"MaxDownresLevel",eb.Sc);this.numLevels=e+1}else for(;o.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;o.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",o.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=(0,eb.uq)(a[0],"DataType",e=>(0,eb.DY)(e,bB)),this.voxelSize=(0,eb.uq)(s,"VoxelSize",e=>(0,eb.Iw)(Q.R3.create(),e,eb.o7)),this.blockSize=(0,eb.uq)(s,"BlockSize",e=>(0,eb.Iw)(Q.R3.create(),e,eb.o7)),this.lowerVoxelBound=(0,eb.uq)(s,"MinPoint",e=>(0,eb._s)(Q.R3.create(),e)),this.upperVoxelBoundInclusive=(0,eb.uq)(s,"MaxPoint",e=>(0,eb._s)(Q.R3.create(),e))}get volumeType(){return this.encoding===bF.ke.COMPRESSED_SEGMENTATION||this.encoding===bF.ke.COMPRESSED_SEGMENTATIONARRAY?pE.SEGMENTATION:pE.IMAGE}getSources(e,t,i,n){let{encoding:r}=this,s=[];for(let a=0;a<this.numLevels;++a){let o=2**a,l=2**-a,d=Q.R3.create(),u=Q.R3.create();for(let e=0;e<3;++e){let t=Math.floor(this.lowerVoxelBound[e]*l);d[e]=t-t%64;let i=Math.ceil((this.upperVoxelBoundInclusive[e]+1)*l);u[e]=i,i%64!=0&&(u[e]+=64-i%64)}let c=t.dataInstanceKey;r!==bF.ke.COMPRESSED_SEGMENTATIONARRAY&&a>0&&(c+="_"+a.toString());let h={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:c,dataScale:a.toString(),encoding:r},p=Q._E.create();for(let e=0;e<3;++e)p[5*e]=o,p[12+e]=d[e]*o;let g=pD({rank:3,chunkToMultiscaleTransform:p,dataType:this.dataType,baseVoxelOffset:d,upperVoxelBound:Q.R3.subtract(Q.R3.create(),u,d),volumeType:this.volumeType,volumeSourceOptions:i,compressedSegmentationBlockSize:r===bF.ke.COMPRESSED_SEGMENTATION||r===bF.ke.COMPRESSED_SEGMENTATIONARRAY?Q.R3.fromValues(8,8,8):void 0}).map(t=>({chunkSource:e.getChunkSource(bG,{spec:t,parameters:h,credentialsProvider:n}),chunkToMultiscaleTransform:p}));s.push(g)}return(0,Y.PK)(s)}}class bq{alias;description;errors=[];dataInstances=new Map;uuid;vnodes=new Set;constructor(e){if(e instanceof bq){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}(0,eb.PT)(e),this.alias=(0,eb.uq)(e,"Alias",eb.ZE),this.description=(0,eb.uq)(e,"Description",eb.ZE);let t=(0,eb.uq)(e,"DataInstances",eb.PT),i=Object.keys(t);for(let e of i)try{this.dataInstances.set(e,function(e,t,i){(0,eb.PT)(e);let n=(0,eb.uq)(e,"Base",e=>new bU(e));switch(n.typeName){case"uint8blk":case"grayscale8":{let r=-1!==n.compressionName.indexOf("jpeg");return new bW(e,t,n,r?bF.ke.JPEG:bF.ke.RAW,i)}case"labels64":case"labelblk":return new bW(e,t,n,bF.ke.COMPRESSED_SEGMENTATION,i);case"labelarray":case"labelmap":return new bW(e,t,n,bF.ke.COMPRESSED_SEGMENTATIONARRAY,i);default:throw Error(`DVID data type ${JSON.stringify(n.typeName)} is not supported.`)}}(t[e],e,i))}catch(i){let t=`Failed to parse data instance ${JSON.stringify(e)}: ${i.message}`;console.log(t),this.errors.push(t)}let n=(0,eb.uq)(e,"DAG",eb.PT);for(let e of Object.keys((0,eb.uq)(n,"Nodes",eb.PT)))this.vnodes.add(e)}}class bH{repositories;constructor(e){this.repositories=function(e){try{let t=(0,eb.ZI)(e,e=>new bq(e)),i=new Map;for(let[e,n]of t)for(let t of(i.set(e,n),n.vnodes))if(t!==e){let e=new bq(n);i.set(t,e)}for(let[e,t]of i)t.uuid=e;return i}catch(e){throw Error(`Failed to parse DVID repositories info: ${e.message}`)}}(e)}getNode(e){let t=[];for(let i of this.repositories.keys())i.startsWith(e)&&t.push(i);if(1!==t.length)throw Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}}function bJ(e,t,i){return e.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:t},()=>{let e=vI(i,`${t}/api/repos/info`,{method:"GET"},(e,t)=>{let i={...t};return e.token&&(i.headers={...i.headers,Authorization:`Bearer ${e}`}),i},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e}).then(e=>e.json()).then(e=>new bH(e)),n=`repository info for DVID server ${t}`;return ai.forPromise(e,{initialMessage:`Retrieving ${n}.`,delay:!0,errorPrefix:`Error retrieving ${n}: `}),e})}class bK extends pM{baseUrl;nodeKey;dataInstanceKey;info;credentialsProvider;get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}constructor(e,t,i,n,r,s){super(e),this.baseUrl=t,this.nodeKey=i,this.dataInstanceKey=n,this.info=r,this.credentialsProvider=s}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}}let bZ=/^((?:http|https):\/\/[^/]+)\/([^/]+)\/([^/]+)(\?.*)?$/;function bY(e){if(e.startsWith("https"))return e+"/api/server/token"}async function bX(e){let t=e.providerUrl.match(/^((?:http|https):\/\/[^/]+)\/([^?]*).*$/);if(null===t)throw null;let i=t[1],n=t[2],r=bY(i),s=await bJ(e.chunkManager,i,e.credentialsManager.getCredentialsProvider(b_,{dvidServer:i,authServer:r}));return l1(i.length+1,function(e,t){var i;let n=t.match(/^(?:([^/]+)(?:\/([^/]*))?)?$/);if(null===n)throw Error("Invalid DVID URL syntax.");if(void 0===n[2])return{offset:0,completions:l3(t,e.repositories.values(),e=>e.uuid+"/",e=>`${e.alias}: ${e.description}`)};let r=n[1],s=e.getNode(r);return l1(r.length+1,(i=s,{offset:0,completions:l3(n[2],i.dataInstances.values(),e=>e.name,e=>`${e.base.typeName}`)}))}(s,n))}class bQ extends de{credentialsManager;constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return function(e){let t=function(e){let t=e.match(bZ);if(null===t)throw Error(`Invalid DVID URL: ${JSON.stringify(e)}.`);let i={baseUrl:t[1],nodeKey:t[2],dataInstanceKey:t[3]},n=t[4];if(n&&n.length>1){let e=(0,eb.Re)(n.substring(1));e.user&&(i.user=e.user)}return i.authServer=bY(i.baseUrl),i}(e.providerUrl),{baseUrl:i,nodeKey:n,dataInstanceKey:r}=t;return e.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:i,nodeKey:n,dataInstanceKey:r},async()=>{let s=e.credentialsManager.getCredentialsProvider(b_,{dvidServer:t.baseUrl,authServer:t.authServer}),a=(await bJ(e.chunkManager,i,s)).getNode(n);if(void 0===a)throw Error(`Invalid node: ${JSON.stringify(n)}.`);let o=a.dataInstances.get(r);if(!(o instanceof bW))throw Error(`Invalid data instance ${r}.`);return function(e,t,i,n){let r=t.baseUrl,s=t.nodeKey,a=t.dataInstanceKey,o={lowerBounds:new Float64Array(i.lowerVoxelBound),upperBounds:Float64Array.from(i.upperVoxelBoundInclusive,e=>e+1)},l=tR({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(i.voxelSize,e=>e/1e9),boundingBoxes:[tU(o)]}),d=new bK(e.chunkManager,r,s,a,i,n),u={modelTransform:tj(l),subsources:[{id:"default",subsource:{volume:d},default:!0}]};if(i.meshSrc){let r=Q._E.create();for(let e=0;e<3;++e)r[5*e]=1/i.voxelSize[e];u.subsources.push({id:"meshes",default:!0,subsource:{mesh:e.chunkManager.getChunkSource(bj,{parameters:{...t,dataInstanceKey:i.meshSrc},credentialsProvider:n})},subsourceToModelSubspaceTransform:r})}return i.skeletonSrc&&u.subsources.push({id:"skeletons",default:!0,subsource:{mesh:e.chunkManager.getChunkSource(bz,{parameters:{...t,dataInstanceKey:i.skeletonSrc},credentialsProvider:n})}}),u.subsources.push({id:"bounds",subsource:{staticAnnotations:tr(o)},default:!0}),u}(e,t,o,s)})}(e)}completeUrl(e){return bX(e)}}async function b0(e,t){let i=await vD(e,{method:"GET",credentials:"include",signal:t});return{token:await i.text()}}ym("dvid",e=>new bQ(e.credentialsManager));class b1 extends yf{authServer;constructor(e){super(),this.authServer=e,this.get=yy(async e=>{let{authServer:t}=this;return t?await yx({description:`DVID server ${this.authServer}`,supportsImmediate:!0,get:async(e,i)=>{if(i)return await b0(t,e);let n=t.match(/^[^/]+\/\/[^/.]+\.([^/]+)/);if(n){let e=`https://flyemlogin.${n[1]}/login`;throw Error(`Please log into ${e} and then refresh the neurogalncer page to try again.
If you are unable to log into ${e}, please check your authorization server ${t} to make sure it is correct.`)}throw Error(`Please check your authorization server ${t} to make sure it is correct.`)}},e):{token:""}})}get}class b2 extends yw{constructor(e,t){super(new b1(t),{})}}yC.register(b_,e=>new b2(e.dvidServer,e.authServer)),i("8611");class b3{url;static RPC_ID="graphene/ChunkedGraphSource"}class b4{manifestUrl;fragmentUrl;lod;sharding;nBitsForLayerId;static RPC_ID="graphene/MeshSource"}function b6(e,t){let i=eC.E.rshift(new eC.E,e,64-t);return eC.E.equal(i,eC.E.ONE)}function b5(e){return new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString().slice(0,-8)}class b8 extends ef.gj{model;element;constructor(e,t,i){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:n}=this;n.type="datetime-local",t&&this.setMin(t),i&&this.setMax(i),this.registerEventListener(n,"change",()=>this.updateModel()),this.updateView()}setMin(e){let{element:t}=this;t.min=b5(e)}setMax(e){let{element:t}=this;t.max=b5(e)}disposed(){sR(this.element)}updateView(){void 0!==this.model.value?this.element.value=b5(new Date(this.model.value)):this.element.value=""}updateModel(){try{this.element.value?this.model.value=new Date(this.element.value).valueOf():this.model.value=void 0}catch{}this.updateView()}}function b7(e,t=0){let i=Q.vh.clone([...e]);return i[3]=t,i}let b9=Q.R3.fromValues(1,0,0),Se=Q.R3.fromValues(0,0,1),St=b7(b9,.5),Si=b7(Se,.5),Sn=b7(b9,.25),Sr=b7(Se,.25),Ss=Q.vh.fromValues(.5,.5,.5,.01),Sa=new eC.E(en(St)),So=new eC.E(en(Si)),Sl=new eC.E(en(Ss)),Sd=Q.vh.fromValues(0,0,0,.5),Su=Q.R3.fromValues(1,1,1);class Sc extends ly(vx()(hL),b4){getFragmentKey(e,t){return function(e){if("~"===e.charAt(0)){let t=e.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}return{key:e,fragmentId:e}}(t)}}class Sh{segmentationUrl;meshingUrl;l2CacheUrl;table;supported_api_versions;constructor(e,t){let i=e.match(/^(https?:\/\/[.\w:\-/]+)\/segmentation\/(?:1\.0|table)\/([^/]+)\/?$/);if(null===i)throw Error(`Graph URL invalid: ${e}`);this.table=i[2];let{table:n}=this;this.segmentationUrl=`${i[1]}/segmentation/api/v1/table/${n}`,this.meshingUrl=`${i[1]}/meshing/api/v1/table/${n}`,this.l2CacheUrl=`${i[1]}/l2cache/api/v1`;try{(0,eb.PT)(t),this.supported_api_versions=(0,eb.uq)(t,"supported_api_versions",e=>(0,eb.m7)(e,eb.Iq))}catch{this.supported_api_versions=[0]}if(1 in this.supported_api_versions==!1)throw Error(`This Neuroglancer branch requires Graph Server version 1, but the server only supports version(s) ${this.supported_api_versions}.`)}}class Sp{chunkSize;nBitsForLayerId;constructor(e){(0,eb.PT)(e),this.chunkSize=(0,eb.uq)(e,"chunk_size",e=>(0,eb.Iw)(Q.R3.create(),e,eb.Sc)),this.nBitsForLayerId=(0,eb.Kh)(e,"n_bits_for_layer_id",eb.Sc,8)}}class Sg extends ba{chunkedGraphCredentialsProvider;info;constructor(e,t,i){super(e,void 0,i.dataUrl,i),this.chunkedGraphCredentialsProvider=t,this.info=i}getChunkedGraphSource(){let{rank:e}=this,t=this.info.scales[0],i=function(e){let{rank:t,dataType:i}=e,{baseVoxelOffset:n=new Float32Array(t)}=e;return{...oQ(e),baseVoxelOffset:n,dataType:i}}({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),n=e+1,r=new Float32Array(n*n);r[r.length-1]=1;let{lowerBounds:s,upperBounds:a}=this.info.modelSpace.boundingBoxes[0].box,o=new Float32Array(e),l=new Float32Array(e);for(let i=0;i<3;++i)r[n*i+i]=1,r[n*e+i]=t.voxelOffset[i],o[i]=s[i],l[i]=a[i];return{chunkSource:this.chunkManager.getChunkSource(S4,{spec:i,credentialsProvider:this.chunkedGraphCredentialsProvider,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:r,lowerClipBound:o,upperClipBound:l}}}function Sm(e){return(0,eb.uq)(e,"transform",e=>{let t=Q._E.create();return void 0!==e&&(0,eb.Iw)(t.subarray(0,12),e,eb.jz),Q._E.transpose(t,t),t})}async function Sf(e,t,i){let n;try{n=await SS(e,t,i)}catch(e){if(vL(e))return{metadata:void 0};throw e}return function(e){let t;(0,eb.PT)(e);let i=(0,eb.uq)(e,"@type",eb.ZE);if("neuroglancer_legacy_mesh"===i){let i=(0,eb.uq)(e,"sharding",Sy);t=void 0===i?void 0:{lodScaleMultiplier:0,transform:Sm(e),sharding:i,vertexQuantizationBits:10}}else if("neuroglancer_multilod_draco"!==i)throw Error(`Unsupported mesh type: ${JSON.stringify(i)}`);else{let i=(0,eb.uq)(e,"lod_scale_multiplier",eb.o7),n=(0,eb.uq)(e,"vertex_quantization_bits",eb.Sc),r=Sm(e);t={lodScaleMultiplier:i,transform:r,sharding:(0,eb.uq)(e,"sharding",Sy),vertexQuantizationBits:n}}return{metadata:t,segmentPropertyMap:(0,eb.uq)(e,"segment_properties",eb.kt)}}(n)}function Sv(e){return void 0===e?y2.qm.RAW:(0,eb.CT)(e,y2.qm)}function Sy(e){if(void 0===e)return;(0,eb.PT)(e);let t=[];for(let i in e){let n=Number(i);t[n]=function(e){if(void 0===e)return;(0,eb.PT)(e);let t=(0,eb.uq)(e,"@type",eb.ZE);if("neuroglancer_uint64_sharded_v1"!==t)throw Error(`Unsupported sharding format: ${JSON.stringify(t)}`);let i=(0,eb.uq)(e,"hash",e=>(0,eb.CT)(e,y2.wC)),n=(0,eb.uq)(e,"preshift_bits",eb.C$),r=(0,eb.uq)(e,"shard_bits",eb.C$),s=(0,eb.uq)(e,"minishard_bits",eb.C$),a=(0,eb.uq)(e,"minishard_index_encoding",Sv);return{hash:i,preshiftBits:n,shardBits:r,minishardBits:s,minishardIndexEncoding:a,dataEncoding:(0,eb.uq)(e,"data_encoding",Sv)}}(e[n])}return t}async function Sb(e,t,i,n,r){var s,a,o;let{metadata:l,segmentPropertyMap:d}=await Sf(e,void 0,n),u={manifestUrl:i,fragmentUrl:n,lod:0,sharding:l?.sharding,nBitsForLayerId:r},c=l?.transform||Q._E.create();return{source:(s=e,a=u,o=t,s.getChunkSource(Sc,{parameters:a,credentialsProvider:o})),transform:c,segmentPropertyMap:d}}function SS(e,t,i){return e.memoize.getUncounted({type:"graphene:metadata",url:i,credentialsProvider:(0,nd.M)(t)},async()=>await v_(t,`${i}/info`,{}).then(e=>e.json()))}async function Sw(e,t,i,n){let r=function(e,t,i){let n=bs(e),r=(0,eb.uq)(e,"data_dir",e=>vO(e,i)).url,s=(0,eb.uq)(e,"app",e=>new Sh(t,e)),a=(0,eb.uq)(e,"graph",e=>new Sp(e));return{...n,app:s,graph:a,dataUrl:r}}(n,i,e.credentialsManager),s=new Sg(e.chunkManager,t,r),a=new Sq;e.state&&a.restoreState(e.state);let o=new S2(r,t,s,a),{modelSpace:l}=r,d=[{id:"default",default:!0,subsource:{volume:s}},{id:"graph",default:!0,subsource:{segmentationGraph:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:tr(l.bounds)}}];if(void 0!==r.segmentPropertyMap){let n=bn(i,r.segmentPropertyMap),s=await SS(e.chunkManager,t,n),a=bD(e.chunkManager,t,s,n);d.push({id:"properties",default:!0,subsource:{segmentPropertyMap:a}})}if(void 0!==r.mesh){let{source:i,transform:n}=await Sb(e.chunkManager,t,r.app.meshingUrl,bn(r.dataUrl,r.mesh),r.graph.nBitsForLayerId),s=function(e){let t=Q._E.create(),i=e.scales[0].resolution;for(let e=0;e<3;++e)t[5*e]=1/i[e];return t}(r);Q._E.multiply(s,s,n),d.push({id:"mesh",default:!0,subsource:{mesh:i},subsourceToModelSubspaceTransform:s})}return{modelTransform:tj(l),subsources:d,state:a}}class SC extends bA{get description(){return"Graphene file-backed data source"}get(e){let{url:t,parameters:i}=bI(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"graphene:get",providerUrl:t,parameters:i},async()=>{let n;let{url:r,credentialsProvider:s}=vO(t,e.credentialsManager);try{n=await SS(e.chunkManager,s,r)}catch(e){throw vL(e)&&"mesh"===i.type&&console.log("does this happen?"),e}(0,eb.PT)(n);let a=(0,eb.Kh)(n,"redirect",eb.ZE);if(void 0!==a)throw new l5(a);let o=(0,eb.Kh)(n,"@type",eb.ZE);switch(o){case"neuroglancer_multiscale_volume":case void 0:return await Sw(e,s,r,n);default:throw Error(`Invalid type: ${JSON.stringify(o)}`)}})}}function Sx(e){for(let t of e.dataSources){let{loadState:e}=t;if(void 0!==e&&void 0===e.error){for(let t of e.subsources)if(t.enabled&&"graph"===t.subsourceEntry.id)return t}}}function SE(e,t,i,n){let{subsourceEntry:r}=t,s=new ti(t.loadedDataSource.transform,new Z.SN([]),["associated segments"]),a=new oz;a.color.value.set(n),a.relationshipStates.set("associated segments",{segmentationState:new Z.SN(e.displayState),showMatches:new nn(!1)});let o=new oj({localPosition:e.localPosition,transform:t.getRenderLayerTransform(),source:s,displayState:a,dataSource:t.loadedDataSource.layerDataSource,subsourceIndex:t.subsourceIndex,subsourceId:r.id,subsubsourceId:i,role:i8.ANNOTATION});return e.addAnnotationLayerState(o,t),o}function ST(e,t){return(0,eb.uq)(e,t,e=>eC.E.parseString(String(e)))}function Sk(e){let t=ST(e,SP),i=ST(e,SL);return{segmentId:t,rootId:i,position:(0,eb.uq)(e,SI,e=>(0,eb.ET)(e))}}let SD=e=>({[SP]:e.segmentId.toJSON(),[SL]:e.rootId.toJSON(),[SI]:[...e.position]}),SP="segmentId",SL="rootId",SI="position",SR="sink",SA="source",SM="multicut",SN="focusSegment",SV="sinks",SO="sources",S_="merge",SF="merges",SB="autosubmit",SU="mergedRoot",S$="error",SG="findPath",Sz="target",Sj="centroids",SW="precision";class Sq extends ef.gj{changed=new ez.K_;multicutState=new SK;mergeState=new SH;findPathState=new SJ;constructor(){super(),this.registerDisposer(this.multicutState.changed.add(()=>{this.changed.dispatch()})),this.registerDisposer(this.mergeState.changed.add(()=>{this.changed.dispatch()})),this.registerDisposer(this.findPathState.changed.add(()=>{this.changed.dispatch()}))}replaceSegments(e,t){this.multicutState.replaceSegments(e,t),this.mergeState.replaceSegments(e,t),this.findPathState.replaceSegments(e,t)}reset(){this.multicutState.reset(),this.mergeState.reset(),this.findPathState.reset()}toJSON(){return{[SM]:this.multicutState.toJSON(),[S_]:this.mergeState.toJSON(),[SG]:this.findPathState.toJSON()}}restoreState(e){(0,eb.Kh)(e,SM,e=>{this.multicutState.restoreState(e)}),(0,eb.Kh)(e,S_,e=>{this.mergeState.restoreState(e)}),(0,eb.Kh)(e,SG,e=>{this.findPathState.restoreState(e)})}}class SH extends ef.gj{changed=new ez.K_;merges=new Z.SN([]);autoSubmit=new nn(!1);constructor(){super(),this.registerDisposer(this.merges.changed.add(this.changed.dispatch))}replaceSegments(e,t){let{merges:{value:i}}=this,n=1===t.size?[...t][0]:void 0;for(let t of i){if(t.source&&e.has(t.source.rootId)){if(n)t.source.rootId=n;else{this.reset();return}}if(t.sink&&e.has(t.sink.rootId)){if(n)t.sink.rootId=n;else{this.reset();return}}}}reset(){this.merges.value=[],this.autoSubmit.reset()}toJSON(){let{merges:e,autoSubmit:t}=this;return{[SF]:e.value.filter(e=>e.source).map(e=>{let t={id:e.id,locked:e.locked,[SR]:SD(e.sink),[SA]:SD(e.source)};return e.mergedRoot&&(t[SU]=e.mergedRoot.toJSON()),e.error&&(t[S$]=e.error),t}),[SB]:t.toJSON()}}restoreState(e){this.merges.value=(0,eb.uq)(e,SF,e=>(0,eb.m7)(e,e=>(function(e){var t,i;let n=(t=e,i=SU,(0,eb.Kh)(t,i,e=>eC.E.parseString(String(e)))),r=(0,eb.uq)(e,"id",eb.ZE),s=(0,eb.Kh)(e,S$,eb.ZE),a=Sk(e[SR]);return{id:r,locked:!1,sink:a,source:Sk(e[SA]),mergedRoot:n,error:s}})(e))),this.autoSubmit.restoreState((0,eb.Kh)(e,SB,eb.JG))}}class SJ extends ef.gj{changed=new ez.K_;triggerPathUpdate=new ez.K_;source=new Z.TU(void 0,e=>e);target=new Z.TU(void 0,e=>e);centroids=new Z.TU([],e=>e);precisionMode=new nn(!0);get path(){let e=[],{source:{value:t},target:{value:i},centroids:{value:n}}=this;if(!t||!i||0===n.length)return e;for(let t=0;t<n.length-1;t++){let i=n[t],r=n[t+1],s={pointA:Q.R3.fromValues(i[0],i[1],i[2]),pointB:Q.R3.fromValues(r[0],r[1],r[2]),id:"",type:eW.LINE,properties:[]};e.push(s)}let r={pointA:t.position,pointB:e[0].pointA,id:"",type:eW.LINE,properties:[]},s={pointA:e[e.length-1].pointB,pointB:i.position,id:"",type:eW.LINE,properties:[]};return[r,...e,s]}constructor(){super(),this.registerDisposer(this.source.changed.add(()=>{this.centroids.reset(),this.changed.dispatch()})),this.registerDisposer(this.target.changed.add(()=>{this.centroids.reset(),this.changed.dispatch()})),this.registerDisposer(this.centroids.changed.add(this.changed.dispatch))}replaceSegments(e,t){let{source:{value:i},target:{value:n}}=this,r=1===t.size?[...t][0]:void 0,s=!!i&&e.has(i.rootId),a=!!n&&e.has(n.rootId);r?(s&&(i.rootId=r),a&&(n.rootId=r),(s||a)&&(this.centroids.value.length?(this.centroids.reset(),this.triggerPathUpdate.dispatch()):this.changed.dispatch())):(s||a)&&this.reset()}reset(){this.source.reset(),this.target.reset(),this.centroids.reset(),this.precisionMode.reset()}toJSON(){let{source:{value:e},target:{value:t},centroids:i,precisionMode:n}=this;return{[SA]:e?SD(e):void 0,[Sz]:t?SD(t):void 0,[Sj]:i.toJSON(),[SW]:n.toJSON()}}restoreState(e){(0,eb.Kh)(e,SA,e=>{this.source.restoreState(Sk(e))}),(0,eb.Kh)(e,Sz,e=>{this.target.restoreState(Sk(e))}),(0,eb.Kh)(e,Sj,e=>{this.centroids.restoreState(e)}),(0,eb.Kh)(e,SW,e=>{this.precisionMode.restoreState(e)})}}class SK extends ef.gj{focusSegment;blueGroup;changed;sinks;sources;constructor(e=new Z.TU(void 0,e=>e),t=new Z.SN(!1)){super(),this.focusSegment=e,this.blueGroup=t,this.changed=new ez.K_,this.sinks=new Z.GF,this.sources=new Z.GF;let i=()=>{0===this.sinks.size&&0===this.sources.size&&(this.focusSegment.value=void 0)};this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(i)),this.registerDisposer(this.sources.changed.add(i)),this.registerDisposer(this.blueGroup.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(this.changed.dispatch)),this.registerDisposer(this.sources.changed.add(this.changed.dispatch))}replaceSegments(e,t){let i=1===t.size?[...t][0]:void 0,{focusSegment:{value:n}}=this;if(n&&e.has(n)){if(i){for(let e of(this.focusSegment.value=i,this.sinks))e.rootId=i;for(let e of this.sources)e.rootId=i;this.changed.dispatch()}else this.reset()}}reset(){this.focusSegment.reset(),this.blueGroup.value=!1,this.sinks.clear(),this.sources.clear()}toJSON(){let{focusSegment:e,sinks:t,sources:i}=this;return{[SN]:e.toJSON(),[SV]:[...t].map(SD),[SO]:[...i].map(SD)}}restoreState(e){let t=e=>(0,eb.m7)(e,e=>Sk(e));(0,eb.Kh)(e,SN,e=>{this.focusSegment.restoreState(eC.E.parseString(String(e)))});let i=(0,eb.uq)(e,SV,t),n=(0,eb.uq)(e,SO,t);for(let e of i)this.sinks.add(e);for(let e of n)this.sources.add(e)}swapGroup(){this.blueGroup.value=!this.blueGroup.value}get activeGroup(){return this.blueGroup.value?this.sources:this.sinks}get segments(){return[...this.redSegments,...this.blueSegments]}get redSegments(){return[...this.sinks].filter(e=>!eC.E.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}get blueSegments(){return[...this.sources].filter(e=>!eC.E.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}}class SZ extends hQ{graph;layer;chunkSource;state;annotationLayerStates;mergeAnnotationState;findPathAnnotationState;constructor(e,t,i,n){super(e,t.displayState.segmentationGroupState.value),this.graph=e,this.layer=t,this.chunkSource=i,this.state=n,this.annotationLayerStates=[],this.lastDeselectionMessageExists=!1,this.deleteMergeSubmission=e=>{let{mergeAnnotationState:t}=this;e.locked=!1,t.source.delete(t.source.getReference(e.id))},this.submitMerge=async(e,t=1)=>{let i=Sx(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(e=>e/1e-9);e.error=void 0;for(let n=1;n<=t;n++)try{let t=await this.graph.graphServer.mergeSegments(SQ(e.sink,i),SQ(e.source,i)),n=new m0;n.add(e.sink.rootId),n.add(e.source.rootId);let r=new m0;return r.add(t),this.state.replaceSegments(n,r),t}catch(i){if(n===t)throw e.error=i.message||"unknown",i}return eC.E.ZERO};let r=t.displayState.segmentationGroupState.value;this.previousVisibleSegmentCount=r.visibleSegments.size,this.registerDisposer(r.selectedSegments.changed.add((e,t)=>{null!==e&&(e=[].concat(e)),this.selectedSegmentsChanged(e,t)})),this.registerDisposer(r.visibleSegments.changed.add((e,t)=>{null!==e&&(e=[].concat(e)),this.visibleSegmentsChanged(e,t)}));let{annotationLayerStates:s,state:{multicutState:a,mergeState:o,findPathState:l}}=this,{timestamp:d}=r;this.registerDisposer(d.changed.add(async()=>{let e=await this.graph.graphServer.filterLatestRoots([...r.selectedSegments],d.value,!0);if(r.selectedSegments.delete(e),void 0===d.value){let{focusSegment:{value:e}}=n.multicutState;e&&r.visibleSegments.add(e)}}));let u=Sx(t),c=SE(t,u,"sinks",b9),h=SE(t,u,"sources",Se);wt(a.sinks,c),wt(a.sources,h),s.push(c,h),t.tool.value instanceof wd&&(t.tool.value=void 0),this.mergeAnnotationState=SE(t,u,"grapheneMerge",b9);{let{mergeState:e}=n,{merges:i,autoSubmit:s}=e,{mergeAnnotationState:a}=this,{visibleSegments:o}=r;for(let e of i.value)a.source.add(function(e){let{sink:t,source:i}=e;return{id:e.id,type:eW.LINE,pointA:t.position.slice(),pointB:i.position.slice(),relatedSegments:[[t.rootId.clone(),t.segmentId.clone(),i.rootId.clone(),i.segmentId.clone()]],properties:[]}}(e));this.registerDisposer(a.source.childAdded.add(e=>{!1===e.relatedSegments[0].map(e=>o.has(e))[0]?(setTimeout(()=>{let{tool:e}=t;e.value instanceof wd&&e.value.deactivate()},0),ai.showTemporaryMessage("Cannot merge a hidden segment.")):i.value.length<wc?i.value=[...i.value,wu(e,!0)]:(setTimeout(()=>{let{tool:e}=t;e.value instanceof wd&&e.value.deactivate()},0),ai.showTemporaryMessage(`Maximum of ${wc} simultanous merges allowed.`))})),this.registerDisposer(a.source.childCommitted.add(e=>{let t=a.source.getReference(e),n=t.value;if(n){let e=n.relatedSegments[0],r=e.map(e=>o.has(e));e.length<4&&(a.source.delete(t),ai.showTemporaryMessage("Cannot merge segment with itself.")),!1===r[2]&&(a.source.delete(t),ai.showTemporaryMessage("Cannot merge a hidden segment."));let l=i.value.find(e=>e.id===t.id);if(l&&!l?.locked){let e=wu(n,!1);l.sink=e.sink,l.source=e.source,i.changed.dispatch(),s.value&&this.bulkMerge([l])}}t.dispose()})),this.registerDisposer(a.source.childDeleted.add(e=>{let t=!1,n=i.value.filter(i=>{let n=i.id!==e||i.locked;return!n&&(t=!0),n});t&&(i.value=n)}))}let p=SE(t,u,"findpath",Su);this.findPathAnnotationState=p,p.source.childDeleted.add(e=>{l.source.value?.annotationReference?.id===e&&(l.source.value=void 0),l.target.value?.annotationReference?.id===e&&(l.target.value=void 0)});let g=()=>{let{path:e,source:t,target:i}=l,n=p.source;for(let e of(t.value&&!t.value.annotationReference&&we(n,t.value,"find path source"),i.value&&!i.value.annotationReference&&we(n,i.value,"find path target"),n))e.id!==t.value?.annotationReference?.id&&e.id!==i.value?.annotationReference?.id&&n.delete(n.getReference(e.id));for(let t of e)n.add(t)};this.registerDisposer(l.changed.add(g)),this.registerDisposer(l.triggerPathUpdate.add(()=>{let e=Sx(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(e=>e/1e-9);this.submitFindPath(l.precisionMode.value,e).then(e=>{})})),g(),this.registerDisposer(n.changed.add(()=>{void 0===r.timestamp.value&&(a.focusSegment.value||o.merges.value.length>0?r.timestampOwner.add(t.managedLayer.name):r.timestampOwner.delete(t.managedLayer.name))}))}createRenderLayers(e,t,i){return[new S6(e,this.chunkSource.getChunkedGraphSource(),t,i,this.graph.info.graph.nBitsForLayerId)]}lastDeselectionMessage;lastDeselectionMessageExists;previousVisibleSegmentCount;visibleSegmentsChanged(e,t){let{segmentsState:i}=this,{state:n}=this.graph,{focusSegment:{value:r}}=n.multicutState,{timestamp:s}=i;if(void 0===s.value&&r&&!i.visibleSegments.has(r)&&(i.selectedSegments.has(r)?ai.showTemporaryMessage("Can't hide active multicut segment.",3e3):ai.showTemporaryMessage("Can't deselect active multicut segment.",3e3),i.visibleSegments.add(r),e&&(e=e.filter(e=>!eC.E.equal(e,r)))),null===e){this.segmentsState.segmentEquivalences.clear(),ai.showTemporaryMessage(`Hid all ${this.previousVisibleSegmentCount} segment(s).`,3e3);return}for(let n of e)if(!t&&!b6(n,this.graph.info.graph.nBitsForLayerId)){let e=[...i.segmentEquivalences.setElements(n)].length;i.segmentEquivalences.deleteSet(n),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=ai.showMessage(`Hid ${e} segment(s).`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}this.previousVisibleSegmentCount=i.visibleSegments.size}selectedSegmentsChanged(e,t){let{segmentsState:i}=this;if(null===e){let e=this.segmentsState.selectedSegments.size;ai.showTemporaryMessage(`Deselected all ${e} segment(s).`,3e3);return}for(let n of e){let e=b6(n,this.graph.info.graph.nBitsForLayerId),r=n.clone();t&&e&&this.graph.getRoot(r,i.timestamp.value).then(e=>{i.visibleSegments.has(r)&&i.visibleSegments.add(e),i.selectedSegments.delete(r),i.selectedSegments.add(e)})}}computeSplit(e,t){}getMeshSource(){let{layer:e}=this;for(let t of e.dataSources){let{loadState:e}=t;if(e instanceof dh){let{subsources:t}=e.dataSource,i=t.filter(e=>"graph"===e.id)[0];if(i&&i.subsource.segmentationGraph&&i.subsource.segmentationGraph!==this.graph)continue;let n=t.filter(e=>"mesh"===e.id)[0];if(n)return n.subsource.mesh}}}meshAddNewSegments(e){let t=this.getMeshSource();if(t)for(let i of e)t.rpc.invoke("GrapheneMeshSource:NewSegment",{rpcId:t.rpcId,segment:i.toString()})}async submitMulticut(e){let{state:{multicutState:t}}=this,{sinks:i,sources:n}=t;if(0===i.size||0===n.size)return ai.showTemporaryMessage("Must select both red and blue groups to perform a multi-cut.",7e3),!1;{let r=await this.graph.graphServer.splitSegments([...i].map(t=>SQ(t,e)),[...n].map(t=>SQ(t,e)));if(0===r.length)return ai.showTemporaryMessage("No split found.",3e3),!1;{let e=t.focusSegment.value;t.reset();let{segmentsState:s}=this;for(let t of(s.selectedSegments.delete(e),[...i,...n]))s.selectedSegments.delete(t.rootId);this.meshAddNewSegments(r),s.selectedSegments.add(r),s.visibleSegments.add(r);let a=new m0;a.add(e);let o=new m0;return o.add(r),this.state.replaceSegments(a,o),!0}}}deleteMergeSubmission;submitMerge;async bulkMerge(e){let t,{merges:i}=this.state.mergeState;e=e.filter(e=>!e.locked&&e.source);let n=await (t=e,new Promise(e=>{if(0===t.length){e([]);return}let n=[],r=0,s=0,a=(o,l)=>{if(r===t.length||0===l.length)return;s++;let d=[],u=()=>{++c===l.length&&(s-=1),0===s&&e(n)},c=0;for(let e of l){e.locked=!0,e.status="trying...",i.changed.dispatch();let t=[e.source.rootId,e.sink.rootId];this.submitMerge(e,3).then(s=>{n.push(...t),e.status="done",e.mergedRoot=s,i.changed.dispatch(),a(r+=1,d),d=[],u(),wl(5e3).then(()=>{this.deleteMergeSubmission(e)})}).catch(()=>{i.changed.dispatch(),d.push(e),r>o&&(a(r,d),d=[]),u()})}};a(r,t)})),r=[];for(let t of e){t.error?(t.locked=!1,t.status=t.error):t.mergedRoot&&r.push(t.mergedRoot);let e=await this.graph.graphServer.filterLatestRoots(r),{visibleSegments:s,selectedSegments:a}=this.layer.displayState.segmentationGroupState.value;a.delete(n),this.meshAddNewSegments(e),a.add(e),s.add(e),i.changed.dispatch()}let{visibleSegments:s,selectedSegments:a}=this.layer.displayState.segmentationGroupState.value;a.delete(n);let o=await this.graph.graphServer.filterLatestRoots(r);a.add(o),s.add(o),i.changed.dispatch()}async submitFindPath(e,t){let{state:{findPathState:i}}=this,{source:n,target:r}=i;if(!n.value||!r.value)return!1;let s=await this.graph.findPath(n.value,r.value,e,t);return ai.showTemporaryMessage("Path found!",5e3),i.centroids.value=s,!0}}async function SY(e){if(e.response){let t;return t="application/json"===e.response.headers.get("content-type")?(await e.response.json()).message:await e.response.text()}}async function SX(e,t){let i;let n=()=>{};t.initialMessage&&((i=new ai(!0)).setText(t.initialMessage),n=i.dispose.bind(i));try{let t=await e;return n(),t}catch(e){if(e instanceof vT&&e.response){let{errorPrefix:n=""}=t,r=await SY(e)||"unknown error";throw!i&&(i=new ai(!0)),i.setErrorMessage(n+r),i.setVisible(!0),Error(`[${e.response.status}] ${n}${r}`)}throw e}}let SQ=(e,t)=>{let{rootId:i,segmentId:n,position:r}=e;return{rootId:i,segmentId:n,position:r.map((e,i)=>e*t[i])}},S0=Symbol("Graph Server Not Specified.");class S1{url;credentialsProvider;constructor(e,t){this.url=e,this.credentialsProvider=t}async getTimestampLimit(){let e=await v_(this.credentialsProvider,`${this.url}/oldest_timestamp`,{}).then(e=>e.json());return new Date((0,eb.uq)(e,"iso",eb.ZE)).valueOf()}async getRoot(e,t=0){let i=`${this.url}/node/${String(e)}/root?int64_as_str=1${t>0?`&timestamp=${t/1e3}`:""}`,n=v_(this.credentialsProvider,i,{}),r=await SX(n,{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "}),s=await r.json();return eC.E.parseString(s.root_id)}async mergeSegments(e,t){let{url:i}=this;if(""===i)return Promise.reject(S0);let n=v_(this.credentialsProvider,`${i}/merge?int64_as_str=1`,{method:"POST",body:JSON.stringify([[String(e.segmentId),...e.position],[String(t.segmentId),...t.position]])});try{let e=await n,t=await e.json();return eC.E.parseString(t.new_root_ids[0])}catch(e){if(e instanceof vT)throw Error(await SY(e));throw e}}async splitSegments(e,t){let{url:i}=this;if(""===i)return Promise.reject(S0);let n=v_(this.credentialsProvider,`${i}/split?int64_as_str=1`,{method:"POST",body:JSON.stringify({sources:e.map(e=>[String(e.segmentId),...e.position]),sinks:t.map(e=>[String(e.segmentId),...e.position])})}),r=await SX(n,{initialMessage:`Splitting ${e.length} sources from ${t.length} sinks`,errorPrefix:"Split failed: "}),s=await r.json(),a=Array(s.new_root_ids.length);for(let e=0;e<a.length;++e)a[e]=eC.E.parseString(s.new_root_ids[e]);return a}async filterLatestRoots(e,t=0,i=!1){let n=`${this.url}/is_latest_roots${t>0?`?timestamp=${t/1e3}`:""}`,r=v_(this.credentialsProvider,n,{method:"POST",body:JSON.stringify({node_ids:e.map(e=>e.toJSON())})}),s=await SX(r,{errorPrefix:"Could not check latest: "}),a=await s.json(),o=[];for(let[t,n]of a.is_latest.entries())n!==i&&o.push(e[t]);return o}async findPath(e,t,i){let{url:n}=this;if(""===n)return Promise.reject(S0);let r=v_(this.credentialsProvider,`${n}/graph/find_path?int64_as_str=1&precision_mode=${Number(i)}`,{method:"POST",body:JSON.stringify([[String(e.rootId),...e.position],[String(t.rootId),...t.position]])}),s=await SX(r,{initialMessage:`Finding path between ${e.segmentId} and ${t.segmentId}`,errorPrefix:"Path finding failed: "}),a=await s.json(),o=(0,eb.uq)(a,"centroids_list",e=>(0,eb.m7)(e,eb.bW)),l=a.failed_l2_ids;return l&&l.length>0&&ai.showTemporaryMessage("Some level 2 meshes are missing, so the path shown may have a poor level of detail."),{centroids:o,l2_path:(0,eb.Kh)(a,"l2_path",eb.zE)}}}class S2 extends hX{info;credentialsProvider;chunkSource;state;graphServer;l2CacheAvailable;timestampLimit;constructor(e,t,i,n){super(),this.info=e,this.credentialsProvider=t,this.chunkSource=i,this.state=n,this.l2CacheAvailable=void 0,this.timestampLimit=new Z.TU(0,e=>e),this.graphServer=new S1(e.app.segmentationUrl,t),this.graphServer.getTimestampLimit().then(e=>{this.timestampLimit.value=e})}connect(e){return new SZ(this,e,this.chunkSource,this.state)}get visibleSegmentEquivalencePolicy(){return lS.BA.MAX_REPRESENTATIVE|lS.BA.NONREPRESENTATIVE_EXCLUDED}async isL2CacheUrlAvailable(){if(void 0!==this.l2CacheAvailable)return this.l2CacheAvailable;try{let{l2CacheUrl:e,table:t}=this.info.app,i=await v_(void 0,`${e}/table_mapping`,{}).then(e=>e.json());return this.l2CacheAvailable=!!(i&&i[t]),this.l2CacheAvailable}catch(e){return console.error("e",e),!1}}getRoot(e,t){return this.graphServer.getRoot(e,t)}async findPath(e,t,i,n){let{l2CacheUrl:r,table:s}=this.info.app,a=i&&await this.isL2CacheUrlAvailable(),{centroids:o,l2_path:l}=await this.graphServer.findPath(SQ(e,n),SQ(t,n),i&&!a);if(i&&a&&l){let e=`${r}/table/${s}/attributes`;try{let t=await v_(this.credentialsProvider,e,{method:"POST",body:JSON.stringify({l2_ids:l})}).then(e=>e.json());o=l.map(e=>(0,eb.Kh)(t,e,e=>(0,eb.Qu)(e.rep_coord_nm))).filter(e=>void 0!==e)}catch(e){console.log("e",e)}}return o.map(e=>e.map((e,t)=>e/n[t]))}tabContents(e,t,i){let n=document.createElement("div");n.style.display="contents";let r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",n.appendChild(uR(i,e,i.visibility,wn)),r.appendChild(a_(t,e.toolBinder,{toolJson:S5,label:"Multicut",title:"Multicut segments"})),r.appendChild(a_(t,e.toolBinder,{toolJson:S8,label:"Merge",title:"Merge segments"})),r.appendChild(a_(t,e.toolBinder,{toolJson:S7,label:"Find Path",title:"Find Path"})),n.appendChild(r),n.appendChild(t.registerDisposer(new S9(e,e.annotationDisplayState)).element);let s=i.element;return s.classList.add("neuroglancer-annotations-tab"),s.classList.add("neuroglancer-graphene-tab"),n}async merge(e,t){return new eC.E}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}}class S3 extends lV{constructor(e,t){super(e,t)}}class S4 extends ly(vx()(S3),b3){}class S6 extends lL{chunkManager;source;displayState;localPosition;layerChunkProgressInfo;sharedObject;chunkTransform;leafRequestsActive;leafRequestsStatusMessage;constructor(e,t,i,n,r){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.localPosition=n,this.layerChunkProgressInfo=new ib,this.leafRequestsActive=this.registerDisposer(i3.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer((0,Z.og)(e=>na(()=>io(no(e))),this.displayState.transform));let s=this.sharedObject=this.backend=this.registerDisposer(new hm(e,i,this.layerChunkProgressInfo));s.RPC_TYPE_ID="ChunkedGraphLayer",s.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(i3.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(i3.make(e.rpc,r)).rpcId}),this.registerDisposer(s.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);let t=this.chunkTransform.value,i=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:i},e.state.source=e.registerDisposer((0,Z.Uw)((t,i,n)=>{let r=lB(n,i,e=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke("ChunkedGraphLayer:updateSources",{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:n,sources:lA(r)}),r[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,ai.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):!this.leafRequestsStatusMessage&&!e&&(this.leafRequestsStatusMessage=ai.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}}let S5="grapheneMulticutSegments",S8="grapheneMergeSegments",S7="grapheneFindPath";class S9 extends gG{layer;displayState;constructor(e,t){super(e,t,new g_),this.layer=e,this.displayState=t;let{graphConnection:{value:i}}=e;if(i instanceof SZ)for(let e of i.annotationLayerStates)this.annotationStates.add(e)}}let we=(e,t,i)=>{let n={id:"",point:t.position,type:eW.POINT,properties:[],relatedSegments:[[t.segmentId,t.rootId]],description:i},r=e.add(n);t.annotationReference=r},wt=(e,t)=>{let i=t.source;for(let t of(i.childDeleted.add(t=>{let i=[...e].find(e=>e.annotationReference?.id===t);i&&e.delete(i)}),e.changed.add((e,t)=>{if(null===e){for(let e of i)i.delete(i.getReference(e.id));return}t?we(i,e):e.annotationReference&&i.delete(e.annotationReference)}),e))we(i,t)},wi=(e,t)=>{if(t.updateUnconditionally())return function(e,t){let i=Sx(t).getRenderLayerTransform(),n=na(()=>io(no(i.value)));if(void 0!==n.error)return;let r=new Float32Array(n.modelTransform.unpaddedRank);if(!!iu(r,e,t.localPosition.value,n.layerRank,n.combinedGlobalLocalToChunkTransform))return r}(t.unsnappedPosition,e)},wn={label:"Time",title:"View segmentation at earlier point of time",toolJson:"grapheneTime",...function(){return{makeControl:(e,t)=>{let i=e.displayState.segmentationGroupState.value,{graph:{value:n}}=i,r=n instanceof S2?i.timestamp:new Z.SN(void 0),s=n instanceof S2?n.timestampLimit:new Z.SN(0),a=n instanceof S2?i.timestampOwner:new Z.GF,o=document.createElement("div");o.classList.add("neuroglancer-time-control");let l=new Z.SN(r.value);l.changed.add(async()=>{if(l.value!==r.value){if(void 0===l.value&&i.canSetTimestamp(e.managedLayer.name)){r.value=l.value,a.delete(e.managedLayer.name);return}if(n instanceof S2){let t=i.timestampOwner.has(e.managedLayer.name);if(i.canSetTimestamp(e.managedLayer.name)&&(!t||void 0!==r.value)){let t=await n.graphServer.filterLatestRoots([...i.selectedSegments],r.value,!0);if(!t.length||confirm(`Changing graphene time will clear ${t.length} segment(s).`)){r.value=l.value,a.add(e.managedLayer.name);return}}l.value=r.value,ai.showTemporaryMessage("Timestamp is locked.")}}});let d=t.registerDisposer(new b8(l,new Date(s.value),new Date));return s.changed.add(()=>{d.setMin(new Date(s.value))}),r.changed.add(()=>{r.value!==l.value&&(l.value=r.value)}),o.appendChild(d.element),{controlElement:o,control:d}},activateTool:e=>{}}}()};uA(m5,wn);let wr=(e,t)=>void 0!==e.value&&(ai.showTemporaryMessage("Editing can not be performed with a segmentation at an older state."),t.cancel(),!0),ws=sh.fromObject({"at:shift?+control+mousedown0":{action:"set-anchor"},"at:shift?+keyg":{action:"swap-group"},"at:shift?+enter":{action:"submit"}});class wa extends ax{toJSON(){return S5}activate(e){let{layer:t}=this,{graphConnection:{value:i}}=t;if(!i||!(i instanceof SZ))return;let{state:{multicutState:n},segmentsState:r}=i;if(void 0===n)return;let{body:s,header:a}=aB(e);a.textContent="Multicut segments",s.classList.add("graphene-tool-status","graphene-multicut"),s.appendChild(sV({text:"Swap",title:"Swap group",onClick:()=>{n.swapGroup()}})),s.appendChild(sV({text:"Clear",title:"Clear multicut",onClick:()=>{n.reset()}}));let o=async()=>{l.classList.toggle("disabled",!0);let t=Sx(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(e=>e/1e-9);i.submitMulticut(t).then(t=>{l.classList.toggle("disabled",!1),t&&e.cancel()})},l=sV({text:"Submit",title:"Submit multicut",onClick:()=>{o()}});s.appendChild(l);let d=document.createElement("div");d.className="activeGroupIndicator",d.innerHTML="Active Group: ",s.appendChild(d);let{displayState:u}=this.layer,c=u.segmentationGroupState.value,h=u.baseSegmentHighlighting.value,p=u.highlightColor.value,g=u.hideSegmentZero.value;e.bindInputEventMap(ws),e.registerDisposer(()=>{m(),u.baseSegmentHighlighting.value=h,u.highlightColor.value=p,u.hideSegmentZero.value=g});let m=()=>{c3(c),u.useTempSegmentStatedColors2d.value=!1,u.tempSegmentStatedColors2d.value.clear(),u.tempSegmentDefaultColor2d.value=void 0,u.highlightColor.value=void 0},f=()=>{m(),d.classList.toggle("blueGroup",n.blueGroup.value);let e=n.focusSegment.value;if(void 0!==e){for(let t of(u.baseSegmentHighlighting.value=!0,u.highlightColor.value=n.blueGroup.value?Sr:Sn,u.hideSegmentZero.value=!1,r.useTemporaryVisibleSegments.value=!0,r.useTemporarySegmentEquivalences.value=!0,r.temporaryVisibleSegments.add(e),n.segments))r.temporaryVisibleSegments.add(t);for(let t of r.segmentEquivalences.setElements(e))!r.temporaryVisibleSegments.has(t)&&r.temporarySegmentEquivalences.link(e,t);for(let t of(u.tempSegmentDefaultColor2d.value=Sd,u.tempSegmentStatedColors2d.value.set(e,Sl),n.redSegments))u.tempSegmentStatedColors2d.value.set(t,Sa);for(let e of n.blueSegments)u.tempSegmentStatedColors2d.value.set(e,So);u.useTempSegmentStatedColors2d.value=!0}};f(),e.registerDisposer(n.changed.add(f)),e.registerDisposer(c.segmentEquivalences.changed.add((0,ic.Z)(()=>f(),0))),e.bindAction("swap-group",e=>{e.stopPropagation(),n.swapGroup()}),e.bindAction("set-anchor",e=>{e.stopPropagation();let t=wo(this,c.visibleSegments);if(!t)return;let{rootId:i,segmentId:r}=t,{focusSegment:s,segments:a}=n;if(void 0===s.value&&(s.value=i.clone()),!eC.E.equal(s.value,i)){ai.showTemporaryMessage(`The selected supervoxel has root segment ${i.toString()}, but the supervoxels already selected have root ${s.value.toString()}`,12e3);return}if(!eC.E.equal(i,r)){for(let e of a)if(eC.E.equal(e,r)){ai.showTemporaryMessage(`Supervoxel ${r.toString()} has already been selected`,7e3);return}}n.activeGroup.add(t)}),e.bindAction("submit",e=>{e.stopPropagation(),o()})}get description(){return"multicut"}}let wo=(e,t)=>{let{layer:i,mouseState:n}=e,{segmentSelectionState:{value:r,baseValue:s}}=i.displayState;if(!s||!r)return;if(!t.has(r)){ai.showTemporaryMessage("The selected supervoxel is of an unselected segment",7e3);return}let a=wi(i,n);if(void 0!==a)return{rootId:r.clone(),segmentId:s.clone(),position:a}},wl=e=>new Promise((t,i)=>{setTimeout(t,e)});class wd extends g1{annotationState;getBaseSegment;constructor(e,t){super(e,{}),this.annotationState=t,this.getBaseSegment=!0;let{inProgressAnnotation:i}=this,{displayState:n}=t;if(!n)return;let{disablePicking:r}=n;this.registerDisposer(i.changed.add(()=>{r.value=void 0!==i.value}))}get annotationLayer(){return this.annotationState}get description(){return"merge line"}toJSON(){return wf}}function wu(e,t){let i=e.relatedSegments[0],n={id:e.id,locked:!1,sink:{position:e.pointA.slice(),rootId:i[0].clone(),segmentId:i[1].clone()}};return!t&&(n.source={position:e.pointB.slice(),rootId:i[2].clone(),segmentId:i[3].clone()}),n}let wc=20,wh=sh.fromObject({"at:shift?+enter":{action:"submit"}});class wp extends ax{activate(e){let{graphConnection:{value:t},tool:i}=this.layer;if(!t||!(t instanceof SZ)){e.cancel();return}let{state:{mergeState:n},segmentsState:{timestamp:r},mergeAnnotationState:s}=t;if(wr(r,e))return;let{merges:a,autoSubmit:o}=n,l=new wd(this.layer,s);i.value=l,e.registerDisposer(()=>{i.value=void 0});let{body:d,header:u}=aB(e);u.textContent="Merge segments",d.classList.add("graphene-tool-status","graphene-merge-segments"),e.bindInputEventMap(wh);let c=async()=>{!a.value.filter(e=>e.locked).length&&(h.classList.toggle("disabled",!0),await t.bulkMerge(a.value),h.classList.toggle("disabled",!1))},h=sV({text:"Submit",title:"Submit merge",onClick:async()=>{c()}});d.appendChild(h),e.bindAction("submit",async e=>{e.stopPropagation(),c()}),d.appendChild(sV({text:"Clear",title:"Clear pending merges",onClick:()=>{for(let e of(l.deactivate(),a.value))!e.locked&&t.deleteMergeSubmission(e)}}));let p=e.registerDisposer(new nr(o)),g=document.createElement("label");g.appendChild(document.createTextNode("auto-submit")),g.title="auto-submit merges",g.appendChild(p.element),d.appendChild(g);let m=document.createElement("div");m.classList.add("graphene-merge-segments-merges"),d.appendChild(m);let f=ht.make(this.layer.displayState,!0),v=e=>{let t=f.getWithNormalizedId(e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t},y=e=>{let t=document.createElement("div");t.classList.add("graphene-merge-segments-point");let i=v(c6(this.layer.displayState,e));return t.appendChild(i),t},b=e=>{let i=document.createElement("div");if(i.classList.add("graphene-merge-segments-submission"),i.appendChild(y(e.sink.rootId)),e.source&&(i.appendChild(document.createElement("div")).textContent="ꕹ",i.appendChild(y(e.source.rootId))),!e.locked&&i.appendChild(gA({title:"Delete merge",onClick:i=>{i.stopPropagation(),i.preventDefault(),t.deleteMergeSubmission(e)}})),e.status){let t=document.createElement("div");t.classList.add("graphene-merge-segments-submission-status"),t.textContent=e.status,i.appendChild(t)}return i},S=()=>{for(;m.firstChild;)m.removeChild(m.firstChild);for(let e of a.value)m.appendChild(b(e))};e.registerDisposer(a.changed.add(S)),S()}toJSON(){return S8}get description(){return"merge segments"}}let wg=sh.fromObject({"at:shift?+enter":{action:"submit"},"at:shift?+control+mousedown0":{action:"add-point"}});class wm extends ax{activate(e){let{layer:t}=this,{graphConnection:{value:i}}=t;if(!i||!(i instanceof SZ))return;let{state:{findPathState:n},findPathAnnotationState:r}=i,{source:s,target:a,precisionMode:o}=n,l=this.layer.displayState.segmentationGroupState.value,{body:d,header:u}=aB(e);u.textContent="Find Path",d.classList.add("graphene-tool-status","graphene-find-path");let c=()=>{n.triggerPathUpdate.dispatch()};d.appendChild(sV({text:"Submit",title:"Submit Find Path",onClick:()=>{c()}})),d.appendChild(sV({text:"Clear",title:"Clear Find Path",onClick:()=>{n.source.reset(),n.target.reset(),n.centroids.reset()}}));let h=e.registerDisposer(new nr(o)),p=document.createElement("label"),g=document.createElement("span");g.textContent="Precision mode: ",p.appendChild(g),p.title="Precision mode returns a more accurate path, but takes longer.",p.appendChild(h.element),d.appendChild(p);let m=document.createElement("div");m.classList.add("find-path-annotations"),d.appendChild(m);let f=cM();this.registerDisposer(new sy(m,f));let v=()=>{sI(m);let e=[0,0,0],t=[0,1,2],i=[];for(let n of[s,a].map(e=>e.value?.annotationReference?.value).filter(e=>e)){let[s,a]=g5(this.layer,n,r,"[symbol] 2ch [dim] var(--neuroglancer-column-0-width) [dim] var(--neuroglancer-column-1-width) [dim] var(--neuroglancer-column-2-width) [delete] min-content",t,i);for(let[t,i]of a.entries())e[t]=i;m.appendChild(s)}for(let[t,i]of e.entries())m.style.setProperty(`--neuroglancer-column-${t}-width`,`${i+2}ch`)};n.changed.add(v),v(),e.bindInputEventMap(wg),e.bindAction("submit",e=>{e.stopPropagation(),c()}),e.bindAction("add-point",e=>{e.stopPropagation(),(async()=>{if(s.value){if(!a.value){let e=wo(this,l.visibleSegments);e&&(a.value=e)}}else{let e=wo(this,l.visibleSegments);e&&(s.value=e)}})()})}toJSON(){return S7}get description(){return"find path"}}aL(m5,S5,e=>new wa(e,!0)),aL(m5,S8,e=>new wp(e,!0)),aL(m5,S7,e=>new wm(e,!0));let wf="annotateMergeLine";function wv(e,t,i){let n=window.outerHeight-window.innerHeight+window.innerHeight/2-i/2,r=window.innerWidth/2-t/2;return window.open(e,void 0,`toolbar=no, menubar=no, width=${t}, height=${i}, top=${n}, left=${r}`)}aP(wf,(e,t)=>new wd(e,t)),ym("graphene",()=>new SC);async function wy(e,t,i,n,r){let s=new ai(!1,!0),a=new Promise(a=>{!function t(i,o){s.element.textContent=i+" ";let l=document.createElement("button");l.textContent=o,s.element.appendChild(l),l.addEventListener("click",()=>{t(n,"Retry");let i=wv(e,400,650),s=()=>{i?.close()};window.addEventListener("beforeunload",s);let o=setInterval(()=>{i?.closed&&(clearInterval(o),t(r,"Retry"))},1e3),l=async e=>{e.source===i&&(clearInterval(o),window.removeEventListener("message",l),window.removeEventListener("beforeunload",s),s(),a(e.data))};window.addEventListener("message",l)})}(t,i)});try{return await a}finally{s.dispose()}}async function wb(e,t){return"success"===await wy(e,`Before you can access ${t}, you need to accept its Terms of Service.`,"Open","Waiting for Terms of Service agreement...",`Terms of Service closed for ${t}.`)}async function wS(e,t){let i=new AbortController;t=AbortSignal.any([i.signal,t]);try{var n,r;let s=wv(`${e}/api/v1/authorize`,400,650);if(null===s)throw Error("Failed to create authentication popup window");return yT(s,i),await iU((n=s,r=i.signal,new Promise(e=>{window.addEventListener("message",t=>{t.source===n&&e(t.data)},{signal:r})})).then(async t=>{try{let i=(0,eb.PT)(t),n=(0,eb.uq)(i,"token",eb.ZE),r=(0,eb.uq)(i,"app_urls",eb.zE);return{tokenType:"Bearer",accessToken:n,url:e,appUrls:r}}catch(e){throw Error(`Received unexpected authentication response: ${e.message}`)}}),t)}finally{i.abort()}}let ww="auth_token_v2";class wC extends yf{serverUrl;alreadyTriedLocalStorage;constructor(e){super(),this.serverUrl=e,this.alreadyTriedLocalStorage=!1,this.get=yy(async e=>{let t;if(!this.alreadyTriedLocalStorage&&(this.alreadyTriedLocalStorage=!0,t=function(e){let t=localStorage.getItem(`${ww}_${e}`);return t?JSON.parse(t):null}(this.serverUrl)),!t){var i,n;t=await yx({description:`middleauth server ${this.serverUrl}`,requestDescription:"login",get:e=>wS(this.serverUrl,e)},e),i=this.serverUrl,n=t,localStorage.setItem(`${ww}_${i}`,JSON.stringify(n))}return t})}get}class wx extends Error{url;constructor(e){super(),this.url=e}}class wE extends yf{serverUrl;credentialsManager;credentials;agreedToTos;constructor(e,t){super(),this.serverUrl=e,this.credentialsManager=t,this.credentials=void 0,this.agreedToTos=!1,this.get=yy(async e=>{if(this.credentials&&this.agreedToTos)return this.credentials.credentials;this.agreedToTos=!1;let t=await fetch(`${this.serverUrl}/auth_info`).then(e=>e.json()),i=this.credentialsManager.getCredentialsProvider("middleauth",t.login_url);if(this.credentials=await i.get(this.credentials,e),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new ai(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new wx(this.serverUrl)}),this.errorHandler=async(e,t)=>{let{status:i}=e;if(401===i)return"refresh";if(403===i){let{response:i}=e;if(i){let{headers:e}=i;if("application/json"===e.get("content-type")){let e=await i.json();if(e.error&&"missing_tos"===e.error){let t=new URL(e.data.tos_form_url);if(t.searchParams.set("client","ng"),await wb(t.toString(),e.data.tos_name))return this.agreedToTos=!0,"refresh"}}}if(!t.accessToken)return"refresh"}throw e}}get;errorHandler}yC.register("middleauth",e=>new wC(e)),yC.register("middleauthapp",(e,t)=>new wE(e,t));var wT=i("835");class wk extends ly(vx()(pR),wT.Y){}class wD extends pM{credentialsProvider;multiscaleMetadata;scales;dataType;volumeType;baseScaleIndex;modelSpace;get rank(){return this.modelSpace.rank}constructor(e,t,i,n){let r,s;if(super(e),this.credentialsProvider=t,this.multiscaleMetadata=i,this.scales=n,n.forEach((e,t)=>{if(void 0!==e){if(void 0===s&&(s=t),void 0!==r&&e.dataType!==r)throw Error(`Scale s${t} has data type ${ec[e.dataType]} but expected ${ec[r]}.`);r=e.dataType}}),void 0===r)throw Error("At least one scale must be specified.");let a=i.scales[s],o=n[s];this.dataType=r,this.volumeType=pE.IMAGE,this.baseScaleIndex=s;let l=i.modelSpace,{rank:d}=l;this.modelSpace=tR({names:l.names,scales:l.scales,units:l.units,boundingBoxes:[{transform:(0,to.Kt)(Float64Array,a.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(d),upperBounds:new Float64Array(o.size)}}],coordinateArrays:l.coordinateArrays})}getSources(e){let{scales:t,rank:i}=this,n=this.multiscaleMetadata.scales;return(0,Y.PK)(t.filter(e=>void 0!==e).map((t,r)=>{let s=n[r],a=(0,to.Kt)(Float32Array,s.downsamplingFactor);return pD({rank:i,chunkToMultiscaleTransform:a,dataType:t.dataType,upperVoxelBound:t.size,volumeType:this.volumeType,chunkDataSizes:[t.chunkSize],volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(wk,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:s.url,encoding:t.encoding}}),chunkToMultiscaleTransform:a}))}))}}class wP{dataType;encoding;size;chunkSize;constructor(e){let t;(0,eb.PT)(e),this.dataType=(0,eb.uq)(e,"dataType",e=>(0,eb.CT)(e,ec)),this.size=Float32Array.from((0,eb.uq)(e,"dimensions",e=>(0,eb.m7)(e,eb.Sc))),this.chunkSize=(0,eb.uq)(e,"blockSize",e=>(0,eb.Iw)(new Uint32Array(this.size.length),e,eb.Sc)),(0,eb.Kh)(e,"compression",e=>{(t=(0,eb.uq)(e,"type",e=>(0,eb.CT)(e,wT.k)))===wT.k.GZIP&&!0===(0,eb.Kh)(e,"useZlib",eb.JG,!1)&&(t=wT.k.ZLIB)}),void 0===t&&(t=(0,eb.uq)(e,"compressionType",e=>(0,eb.CT)(e,wT.k))),this.encoding=t}}async function wL(e,t,i,n){let r=function(e){let{protocol:t,host:i,path:n}=vP(e);n.endsWith("/")&&(n=n.substring(0,n.length-1));let r=[];for(;;){r.push(`${t}://${i}${n}/attributes.json`);let e=n.lastIndexOf("/");if(-1===e)break;n=n.substring(0,e)}return r}(i),s=await Promise.all(r.map((i,s)=>{var a,o,l,d;return a=e,o=t,l=i,d=n&&s===r.length-1,a.memoize.getUncounted({type:"n5:attributes.json",url:l,credentialsProvider:(0,nd.M)(o)},()=>v_(o,l,{}).then(e=>e.json()).then(e=>{try{return(0,eb.PT)(e)}catch(e){throw Error(`Error reading attributes from ${l}: ${e.message}`)}}).catch(e=>{if(vL(e)){if(d)return;return{}}throw e}))}));if(-1===s.indexOf(void 0))return s.reverse(),Object.assign({},...s)}function wI(e,t){if(-1!==e&&t!==e)throw Error(`Rank mismatch, received ${t} but expected ${e}`);return t}function wR(e){return Float64Array.from((0,eb.m7)(e,eb.o7))}function wA(e){let t=(0,eb.f6)(e);if(0===t.length)throw Error("Expected non-empty array");let i=-1;return{all:(0,eb.m7)(t,e=>{let t=wR(e);return i=wI(i,t.length),t}),single:void 0,rank:i}}let wM=["x","y","z","t","c"];class wN extends de{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{var i,n;let{url:r,credentialsProvider:s}=vO(t,e.credentialsManager),a=await wL(e.chunkManager,s,r,!1),o=function(e,t){let i,n;(0,eb.PT)(t);let r=-1,s=(0,eb.Kh)(t,"resolution",e=>{let t=Float64Array.from((0,eb.m7)(e,eb.o7));return r=wI(r,t.length),t}),a=(0,eb.Kh)(t,"axes",e=>{let t=(0,eb.m7)(e,eb.ZE);return r=wI(r,t.length),t}),o=(0,eb.Kh)(t,"units",e=>{let t=(0,eb.m7)(e,tv);return r=wI(r,t.length),t}),l={unit:"m",exponent:-9};(0,eb.Kh)(t,"downsamplingFactors",e=>{let{single:t,all:s,rank:a}=function(e){let t=(0,eb.f6)(e);if(0===t.length)throw Error("Expected non-empty array");if(Array.isArray(t[0]))return wA(t);let i=wR(e);return{all:void 0,single:i,rank:i.length}}(e);r=wI(r,a),void 0!==t&&(i=t),void 0!==s&&(n=s)}),(0,eb.Kh)(t,"pixelResolution",e=>{l=(0,eb.uq)(e,"unit",tv),(0,eb.Kh)(e,"dimensions",e=>{s=Float64Array.from((0,eb.m7)(e,eb.o7)),r=wI(r,s.length)})}),(0,eb.Kh)(t,"scales",e=>{let{all:t,rank:i}=wA(e);r=wI(r,i),n=t});let d=(0,eb.Kh)(t,"dimensions",e=>{let t=(0,eb.m7)(e,eb.Sc);return r=wI(r,t.length),t});if(-1===r)throw Error("Unable to determine rank of dataset");void 0===o&&(o=Array(r)).fill(l),void 0===s&&(s=new Float64Array(r)).fill(1);for(let e=0;e<r;++e)s[e]=ty(s[e],o[e].exponent);let u=Array(r);void 0!==a&&(0,eb.Kh)(t,"coordinateArrays",e=>{(0,eb.PT)(e);for(let t=0;t<r;++t){let i=a[t];if(Object.prototype.hasOwnProperty.call(e,i)){let n=(0,eb.zE)(e[i]);u[t]={explicit:!1,labels:n,coordinates:Array.from(n,(e,t)=>t)},o[t]={unit:"",exponent:0},s[t]=1}}}),void 0===a&&(a=function(e){let t=wM.slice(0,e);for(;t.length<e;)t.push(`d${t.length+1}`);return t}(r));let c=tR({rank:r,valid:!0,names:a,scales:s,units:o.map(e=>e.unit),coordinateArrays:u});if(void 0===d){if(void 0===n)throw Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:c,url:e,attributes:t,scales:n.map((t,i)=>({url:`${e}/s${i}`,downsamplingFactor:t}))}}return void 0===i&&(i=new Float64Array(r)).fill(1),{modelSpace:c,url:e,attributes:t,scales:[{url:e,downsamplingFactor:i}]}}(r,a);let l=await (i=e.chunkManager,n=s,Promise.all(o.scales.map(async e=>{let t=await wL(i,n,e.url,!0);if(void 0!==t)return new wP(t)}))),d=new wD(e.chunkManager,s,o,l);return{modelTransform:tj(d.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:d}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:tr(d.modelSpace.bounds)}}]}})}completeUrl(e){return y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}function wV(e){return Error(`ngauth server ${e} does not allow requests from Neuroglancer instance ${self.origin}`)}async function wO(e,t){let i=new AbortController;t=AbortSignal.any([i.signal,t]);try{let n=window.open(`${e}/login?origin=${encodeURIComponent(self.origin)}`);if(null===n)throw Error("Failed to create authentication popup window");return yT(n,i),await iU(function(e,t,i){return new Promise((n,r)=>{window.addEventListener("message",i=>{if(i.source!==t||(i.origin||i.originalEvent.origin)!==e)return;let{data:s}=i;if("badorigin"===i.data){r(wV(e));return}try{(0,eb.PT)(s);let e=(0,eb.uq)(s,"token",eb.ZE);n({token:e})}catch(e){r(Error(`Received unexpected authentication response: ${e.message}`)),console.error("ngauth: Received unexpected message from ${serverUrl}",i)}},{signal:i})})}(e,n,i.signal),t)}finally{i.abort()}}ym("n5",()=>new wN);class w_ extends yf{serverUrl;constructor(e){super(),this.serverUrl=e,this.get=yy(async e=>{let t=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include",signal:e});switch(t.status){case 200:return{token:await t.text()};case 401:return await yx({description:`ngauth server ${this.serverUrl}`,requestDescription:"login",get:e=>wO(this.serverUrl,e)},e);case 403:throw wV(this.serverUrl);default:throw vT.fromResponse(t)}})}get}class wF extends yf{ngauthCredentialsProvider;serverUrl;bucket;constructor(e,t,i){super(),this.ngauthCredentialsProvider=e,this.serverUrl=t,this.bucket=i,this.get=yy(async()=>{let e=await vI(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST"},(e,t)=>({...t,body:JSON.stringify({token:e.token,bucket:this.bucket})}),e=>{let{status:t}=e;if(401===t)return"refresh";throw e});return{tokenType:"Bearer",accessToken:(await e.json()).token}})}get}function wB(e){return Error(`Nggraph server ${e} does not allow requests from Neuroglancer instance ${self.origin}`)}async function wU(e){let t=new ai(!1),i=new Promise((t,i)=>{window.addEventListener("message",function n(r){if((r.origin||r.originalEvent.origin)!==e||"string"!=typeof r.data)return;let s=()=>{window.removeEventListener("message",n,!1)};"badorigin"===r.data?(s(),i(wB(e))):(s(),t(r.data))},!1)});!function i(n,r){t.element.textContent=n+" ";let s=document.createElement("button");s.textContent=r,t.element.appendChild(s),s.addEventListener("click",()=>{window.open(`${e}/login?origin=${encodeURIComponent(self.origin)}`),i(`Waiting for login to nggraph server ${e}...`,"Retry")})}(`Nggraph server ${e} login required.`,"Login");try{return{token:await i}}finally{t.dispose()}}yC.register("ngauth",e=>new w_(e)),yC.register("ngauth_gcs",(e,t)=>new wF(t.getCredentialsProvider("ngauth",e.authServer),e.authServer,e.bucket));class w$ extends yf{serverUrl;constructor(e){super(),this.serverUrl=e,this.get=yy(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await wU(this.serverUrl);case 403:throw wB(this.serverUrl);default:throw vT.fromResponse(e)}})}get}function wG(e){return(0,eb.PT)(e),{id:(0,eb.uq)(e,"id",e=>eC.E.parseString((0,eb.ZE)(e))),baseSegments:(0,eb.uq)(e,"base_segment_ids",e=>(0,eb.m7)(e,e=>eC.E.parseString((0,eb.ZE)(e)))),baseSegmentParents:(0,eb.uq)(e,"base_segment_parent_ids",e=>(0,eb.m7)(e,e=>eC.E.parseString((0,eb.ZE)(e)))),name:(0,eb.uq)(e,"name",eb.ZE),tags:(0,eb.uq)(e,"tags",eb.zE),numVoxels:(0,eb.uq)(e,"num_voxels",eb.C$),bounds:(0,eb.uq)(e,"bounds",e=>(0,eb.m7)(e,e=>(0,eb.jz)(e))),lastLogId:(0,eb.uq)(e,"last_log_id",e=>null==e?null:eC.E.parseString((0,eb.ZE)(e)))}}let wz=0;class wj extends hQ{constructor(e,t){super(e,t);let i=()=>{!this.ignoreVisibleSegmentsChanged&&this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(i)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(i)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:i}=this.segmentsState,n=i.get(e);if((0,lS.Lr)(n)||!eC.E.equal(i.get(t),n))return;let r=this.segmentQueries.get(n.toString());if(void 0===r)return;let{current:s}=r;if(void 0===s)return;let{baseSegments:a,baseSegmentParents:o}=s,l=o.length,d=new h0.D;for(let i=0;i<l;++i){let n=a[i],r=o[i];!(eC.E.equal(n,t)||eC.E.equal(r,t))&&(d.link(n,r),console.log(`Linking ${n} - ${r} == ${e}? ${eC.E.equal(e,n)} ${eC.E.equal(e,r)} :: unioned with include = ${eC.E.equal(e,d.get(n))}, with exclude = ${eC.E.equal(t,d.get(n))}`))}let u=[],c=[],h=d.get(e);for(let e of a)eC.E.equal(d.get(e),h)?u.push(e):c.push(e);return console.log("include = "+u.map(e=>e.toString()).join(",")),console.log("exclude = "+c.map(e=>e.toString()).join(",")),{includeRepresentative:n,includeBaseSegments:u,excludeRepresentative:lS.tr,excludeBaseSegments:c}}debouncedVisibleSegmentsChanged=this.registerCancellable((0,ic.Z)(()=>this.visibleSegmentsChanged(),0));segmentQueries=new Map;ignoreVisibleSegmentsChanged=!1;segmentEquivalencesChanged=this.registerCancellable((0,ic.Z)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;for(let[i,n]of(t.clear(),e)){if(void 0===n.current||(0,lS.Lr)(n.id))continue;let{id:e,baseSegments:i}=n.current;if(i.length>0){for(let n of i)t.link(n,e);n.addedEquivalences=!0}else n.addedEquivalences=!1}},0));registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:wz,disposer:this.graph.watchSegment(e,e=>this.handleSegmentUpdate(t.id.toString(),e))},i=e.toString();this.segmentQueries.set(i,t),console.log(`adding to segmentQueries: ${i}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let i=this.segmentQueries.get(e);if("invalid"===t){i.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(i.id),this.segmentsState.temporaryVisibleSegments.delete(i.id)}finally{this.ignoreVisibleSegmentsChanged=!1}i.addedEquivalences&&this.segmentEquivalencesChanged();return}if("error"===t){i.current=void 0,i.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}i.current=t;let n=i.id,r=t.id;if(eC.E.equal(r,n))i.current=t,!(0,lS.Lr)(i.id)&&this.segmentEquivalencesChanged();else{i.id=r;let s=r.toString(),a=this.segmentQueries.get(s);console.log(`removing from segmentQueries: ${e} due to rename -> ${r}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(n)&&this.segmentsState.visibleSegments.add(r),this.segmentsState.selectedSegments.has(n)&&(this.segmentsState.selectedSegments.delete(n),this.segmentsState.selectedSegments.add(r)),this.segmentsState.temporaryVisibleSegments.has(n)&&(this.segmentsState.temporaryVisibleSegments.delete(n),this.segmentsState.temporaryVisibleSegments.add(r))}finally{this.ignoreVisibleSegmentsChanged=!1}void 0===a?(console.log(`adding to segmentQueries due to rename -> ${r}`),this.segmentQueries.set(s,i),this.segmentEquivalencesChanged()):(null!==t.lastLogId&&("object"!=typeof a.current||null===a.current.lastLogId||eC.E.less(a.current.lastLogId,t.lastLogId))&&(a.current=t,this.segmentEquivalencesChanged()),i.disposer())}}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,i=++wz,n=e=>{for(let n of e.unsafeKeys()){if(eC.E.equal(n,lS.tr))continue;let e=n.toString(),r=t.get(e);if(void 0!==r){r.seenGeneration=i;continue}this.registerVisibleSegment(n.clone())}};for(let[r,s]of(n(e.visibleSegments),n(e.temporaryVisibleSegments),t))s.seenGeneration!==i&&(console.log(`removing from segmentQueries due to seenGeneration: ${r}`),t.delete(r),s.disposer(),s.addedEquivalences&&this.segmentEquivalencesChanged())}}class wW extends hX{chunkManager;serverUrl;entityName;startingWebsocket;websocket;watchesById;watches;nextWatchId;numOpenFailures;constructor(e,t,i){super(),this.chunkManager=e,this.serverUrl=t,this.entityName=i,this.startingWebsocket=!1,this.websocket=void 0,this.watchesById=new Map,this.watches=new Set,this.nextWatchId=0,this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return lS.BA.MAX_REPRESENTATIVE|lS.BA.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||0===this.watches.size)return;this.startingWebsocket=!0;let e=new ai(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let e=1e3*Math.min(16,2**t);await new Promise(t=>setTimeout(t,e))}let i=new URL("/graph/watch/"+encodeURIComponent((await wZ(this.chunkManager,this.serverUrl,this.entityName).get()).credentials.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let n=new WebSocket(i.href);n.onclose=()=>{void 0!==e&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},n.onopen=()=>{void 0!==e&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=n,this.nextWatchId=0;try{for(let e of this.watches){n.send(JSON.stringify({watch:{segment_id:e.segment.toString()}}));let t=this.nextWatchId++;e.watchId=t,this.watchesById.set(t,e)}}catch{}},n.onmessage=e=>{let t,i;try{let n=JSON.parse(e.data);(0,eb.PT)(n);let r=(0,eb.uq)(n,"watch_id",eb.C$),s=this.watchesById.get(r);if(void 0===s)return;i=s;let a=(0,eb.uq)(n,"state",eb.ZE);t="invalid"===a||"error"===a?a:(0,eb.uq)(n,"info",wG)}catch(t){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,e.data,t);return}console.log("got update",t),i.callback(t)}})()}connect(e){return new wj(this,e.displayState.segmentationGroupState.value)}trackSegment(e,t){return this.watchSegment(e,e=>{if("invalid"===e)t(null);else{if("error"===e)return;t(e.id)}})}watchSegment(e,t){let i={callback:t,segment:e,watchId:-1};this.watches.add(i);let{websocket:n}=this;if(void 0!==n)try{n.send(JSON.stringify({watch:{segment_id:e.toString()}}));let t=this.nextWatchId++;i.watchId=t,this.watchesById.set(t,i)}catch{}else this.startWebsocket();return()=>{let{websocket:e}=this;if(void 0!==e&&e.readyState===WebSocket.OPEN){let t=i.watchId;this.watchesById.delete(t);try{e.send(JSON.stringify({unwatch:{watch_id:t}}))}catch{}}this.watches.delete(i)}}async merge(e,t){let i=await wY(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return(0,eb.PT)(i),(0,eb.uq)(i,"merged",e=>eC.E.parseString(e))}async split(e,t){let i=await wY(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return(0,eb.PT)(i),{include:(0,eb.uq)(i,"include",e=>eC.E.parseString(e)),exclude:(0,eb.uq)(i,"exclude",e=>eC.E.parseString(e))}}}function wq(e){let t=e.match("^(https?://[^/]+)/(.*)$");if(null===t)throw Error(`Invalid nggraph url: ${JSON.stringify(e)}`);return{serverUrl:t[1],id:t[2]}}function wH(e,t,i,n){return vI(e,`${t}${i}`,n,(e,t)=>{let i=new Headers(t.headers);return i.set("Authorization",e.token),{...t,headers:i}},e=>{let{status:t}=e;if(401===t)return"refresh";throw e}).then(e=>e.json())}class wJ extends yf{parentCredentialsProvider;serverUrl;entityName;constructor(e,t,i){super(),this.parentCredentialsProvider=e,this.serverUrl=t,this.entityName=i,this.get=yy(async()=>{let e=await wH(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}get}function wK(e,t){return e.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:t},()=>new w$(t))}function wZ(e,t,i){return e.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:t,entityName:i},()=>new wJ(wK(e,t),t,i))}function wY(e,t,i,n,r){return wH(wZ(e,t,i),t,n,r)}class wX extends de{get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:i}=wq(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:i},async()=>{let n=wZ(e.chunkManager,t,i),{entityType:r}=(await n.get()).credentials;if("graph"!==r)throw Error(`Unsupported entity type: ${JSON.stringify(r)}`);let{datasource_url:s}=await wY(e.chunkManager,t,i,"/graph/config",{method:"POST"}),a=await e.registry.get({...e,url:s}),o=new wW(e.chunkManager,t,i),l=[...a.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:o}}];return{modelTransform:a.modelTransform,subsources:l}})}async completeUrl(e){let{serverUrl:t,id:i}=wq(e.providerUrl),n=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>{var i,n,r,s,a;return a=await (i=e.chunkManager,r="/list",s={method:"POST"},wH(wK(i,n=t),n,r,s)),(0,eb.PT)(a),(0,eb.uq)(a,"entities",e=>(0,eb.m7)(e,e=>{(0,eb.PT)(e);let t=(0,eb.uq)(e,"entity",eb.ZE),i=(0,eb.uq)(e,"entity_type",eb.ZE);return{id:t,entityType:i,accessRole:(0,eb.uq)(e,"access_role",eb.ZE)}}))});return{offset:t.length+1,completions:l3(i,n,e=>e.id,e=>`${e.entityType} (${e.accessRole})`)}}}ym("nggraph",()=>new wX);var wQ=i("2147");class w0 extends ly(vx()(pR),wQ.L){}class w1 extends pM{credentialsProvider;url;info;constructor(e,t,i,n){super(e),this.credentialsProvider=t,this.url=i,this.info=n}get dataType(){return this.info.dataType}get volumeType(){return pE.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,i=to.XD(Float32Array,t.rank+1),n=pk({rank:t.rank,volumeType:pE.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:i,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(w0,{credentialsProvider:this.credentialsProvider,spec:n,parameters:{url:this.url}}),chunkToMultiscaleTransform:i}]]}}class w2 extends de{get description(){return"Single NIfTI file"}get(e){var t,i,n;return t=e.chunkManager,i=e.credentialsManager,n=e.providerUrl,t.memoize.getUncounted({type:"nifti/getVolume",url:n},async()=>{var e,r,s,a;let{url:o,credentialsProvider:l}=vO(n,i);let d=await (e=t,r=l,s=o,e.rpc.promiseInvoke(wQ._,{chunkManager:e.addCounterpartRef(),credentialsProvider:vC(e,r),url:s},void 0)),u=new w1(t,l,o,d),c={lowerBounds:new Float64Array(d.rank),upperBounds:Float64Array.from(d.volumeSize)},h=tR({rank:d.rank,names:d.sourceNames,scales:d.sourceScales,units:d.units,boundingBoxes:[tU(c)]}),p=tR({rank:d.rank,names:d.viewNames,scales:d.viewScales,units:d.units});return{subsources:[{id:"default",default:!0,subsource:{volume:u}},{id:"bounds",default:!0,subsource:{staticAnnotations:tr(c)}}],modelTransform:{sourceRank:d.rank,rank:d.rank,inputSpace:h,outputSpace:p,transform:d.transform}}})}completeUrl(e){return y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}ym("nifti",()=>new w2);class w3 extends de{get description(){return"Wavefront OBJ mesh file"}async get(e){let t=await v0(e.chunkManager,e.credentialsManager,e.url);return{modelTransform:tj(tR({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}ym("obj",()=>new w3),ym("precomputed",()=>new bA);var w4=i("3074");let w6=new Set(["jpg","raw16"]),w5=ly(pR,w4.xd);class w8 extends w5{}let w7=new Set(["COMPLETE","READ_ONLY"]),w9=new Set(["LOADING"]);function Ce(e){let t=(0,eb.m7)(e,eb.PT);if(t.length<1)throw Error("No stacks found for owner object.");let i=new Map,n=(0,eb.uq)(t[0],"stackId",Ci);for(let e of t){let t=(0,eb.uq)(e,"stackId",Ct),n=function(e){(0,eb.PT)(e);let t=(0,eb.uq)(e,"state",eb.ZE),i=[],n=Q.R3.create(),r=Q.R3.create();if(w7.has(t)){let t=(0,eb.uq)(e,"stats",eb.PT);n=function(e){(0,eb.PT)(e);let t=(0,eb.uq)(e,"stackBounds",eb.PT),i=Q.R3.create();return i[0]=(0,eb.uq)(t,"minX",eb.nH),i[1]=(0,eb.uq)(t,"minY",eb.nH),i[2]=(0,eb.uq)(t,"minZ",eb.nH),i}(t),r=function(e){(0,eb.PT)(e);let t=(0,eb.uq)(e,"stackBounds",eb.PT),i=Q.R3.create();return i[0]=(0,eb.uq)(t,"maxX",eb.nH)+1,i[1]=(0,eb.uq)(t,"maxY",eb.nH)+1,i[2]=(0,eb.uq)(t,"maxZ",eb.nH)+1,i}(t),Object.prototype.hasOwnProperty.call(t,"channelNames")&&(i=function(e){return(0,eb.PT)(e),(0,eb.uq)(e,"channelNames",e=>(0,eb.m7)(e,eb.ZE))}(t))}else if(!w9.has(t))return;let s=(0,eb.uq)(e,"currentVersion",Cn);return{lowerVoxelBound:n,upperVoxelBound:r,voxelResolution:s,project:(0,eb.uq)(e,"stackId",Cr),channels:i}}(e);if(void 0!==n){let e=n.project,r=i.get(e);if(void 0===r){let t=new Map;i.set(e,{stacks:t}),r=i.get(e)}r.stacks.set(t,n)}}return{owner:n,projects:i}}function Ct(e){return(0,eb.PT)(e),(0,eb.uq)(e,"stack",eb.ZE)}function Ci(e){return(0,eb.PT)(e),(0,eb.uq)(e,"owner",eb.ZE)}function Cn(e){(0,eb.PT)(e);let t=Q.R3.create();try{t[0]=(0,eb.uq)(e,"stackResolutionX",eb.nH),t[1]=(0,eb.uq)(e,"stackResolutionY",eb.nH),t[2]=(0,eb.uq)(e,"stackResolutionZ",eb.nH)}catch{t[0]=1,t[1]=1,t[2]=1}return t}function Cr(e){return(0,eb.PT)(e),(0,eb.uq)(e,"project",eb.ZE)}class Cs extends pM{baseUrl;ownerInfo;project;parameters;get dataType(){return"raw16"===this.parameters.encoding?ec.UINT16:ec.UINT8}get volumeType(){return pE.IMAGE}channel;stack;stackInfo;dims;encoding;numLevels;minIntensity;maxIntensity;minX;minY;minZ;maxX;maxY;maxZ;maxTileSpecsToRender;filter;get rank(){return 3}constructor(e,t,i,n,r,s,a){super(e),this.baseUrl=t,this.ownerInfo=i,this.project=r,this.parameters=a;let o=i.projects.get(r);if(void 0===o)throw Error(`Specified project ${JSON.stringify(r)} does not exist for specified owner ${JSON.stringify(i.owner)}`);if(void 0===n){let e=Array.from(o.stacks.keys());if(1!==e.length)throw Error(`Dataset contains multiple stacks: ${JSON.stringify(e)}`);n=e[0]}let l=o.stacks.get(n);if(void 0===l)throw Error(`Specified stack ${JSON.stringify(n)} is not one of the supported stacks: `+JSON.stringify(Array.from(o.stacks.keys())));this.stack=n,this.stackInfo=l,void 0!==s&&s.length>0&&(this.channel=s),this.minIntensity=(0,eb.a6)(a.minIntensity),this.maxIntensity=(0,eb.a6)(a.maxIntensity),this.maxTileSpecsToRender=(0,eb.a6)(a.maxTileSpecsToRender),this.filter=(0,eb.ds)(a.filter),this.minX=(0,eb.a6)(a.minX),this.minY=(0,eb.a6)(a.minY),this.minZ=(0,eb.a6)(a.minZ),this.maxX=(0,eb.a6)(a.maxX),this.maxY=(0,eb.a6)(a.maxY),this.maxZ=(0,eb.a6)(a.maxZ),void 0!==this.minX&&(l.lowerVoxelBound[0]=this.minX),void 0!==this.minY&&(l.lowerVoxelBound[1]=this.minY),void 0!==this.minZ&&(l.lowerVoxelBound[2]=this.minZ),void 0!==this.maxX&&(l.upperVoxelBound[0]=this.maxX),void 0!==this.maxY&&(l.upperVoxelBound[1]=this.maxY),void 0!==this.maxZ&&(l.upperVoxelBound[2]=this.maxZ);let d=(0,eb.kt)(a.encoding);if(void 0===d)d="jpg";else if(!w6.has(d))throw Error(`Invalid encoding: ${JSON.stringify(d)}.`);this.encoding=d,this.numLevels=(0,eb.a6)(a.numlevels),this.dims=Q.R3.create();let u=(0,eb.a6)(a.tilesize);void 0===u&&(u=1024),this.dims[0]=u,this.dims[1]=u,this.dims[2]=1}getSources(e){let t=[],i=this.numLevels;void 0===i&&(i=function(e,t){let i=0;for(let t=0;t<2;t++)i=Math.max(i,e.upperVoxelBound[t]);if(t>=i)return 1;let n=0;for(;i>t;)i/=2,n++;return n}(this.stackInfo,this.dims[0]));let{lowerVoxelBound:n,upperVoxelBound:r}=this.stackInfo;for(let e=0;e<i;e++){let i=Q._E.create(),s=Uint32Array.of(1,1,1);for(let t=0;t<2;++t)i[5*t]=2**e,s[t]=this.dims[t];let a=Q.R3.create(),o=Q.R3.create(),l=Q.R3.create(),d=Q.R3.create();for(let e=0;e<3;e++){let t=i[5*e],s=l[e]=n[e]/t,u=d[e]=r[e]/t;a[e]=Math.floor(s),o[e]=Math.ceil(u)}let u=pT({rank:3,chunkDataSize:s,dataType:this.dataType,lowerVoxelBound:a,upperVoxelBound:o}),c=this.chunkManager.getChunkSource(w8,{spec:u,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:e,encoding:this.encoding}});t.push([{chunkSource:c,chunkToMultiscaleTransform:i,lowerClipBound:l,upperClipBound:d}])}return(0,Y.PK)(t)}}function Ca(e,t,i){return e.memoize.getUncounted({type:"render:getOwnerInfo",hostname:t,owner:i},()=>vD(`${t}/render-ws/v1/owner/${i}/stacks`).then(e=>e.json()).then(Ce))}let Co=/^([^/?]+)(?:\/([^/?]+))?(?:\/([^/?]+))(?:\/([^/?]*))?(?:\?(.*))?$/,Cl=/^((?:(?:(?:http|https):\/\/[^,/]+)[^/?]))\/(.*)$/;async function Cd(e,t,i){let n=i.match(/^(?:([^/]+)(?:\/([^/]*))?(?:\/([^/]*))?(\/.*?)?)?$/);if(null===n||void 0===n[2])throw null;if(void 0===n[3]){let i=n[2]||"",r=l3(i,(await Ca(e,t,n[1])).projects,e=>e[0]+"/",()=>void 0);return{offset:n[1].length+1,completions:r}}if(void 0===n[4]){let i=n[3]||"",r=(await Ca(e,t,n[1])).projects.get(n[2]);if(void 0===r)throw null;let s=l3(i,r.stacks,e=>e[0]+"/",e=>e[1].project);return{offset:n[1].length+n[2].length+2,completions:s}}let r=n[4].substr(1)||"",s=(await Ca(e,t,n[1])).projects.get(n[2]);if(void 0===s)throw null;let a=s.stacks.get(n[3]);if(void 0===a)throw null;let o=a.channels;if(0===o.length)throw null;let l=l3(r,o,e=>e,()=>void 0);return{offset:n[1].length+n[2].length+n[3].length+3,completions:l}}async function Cu(e,t){let i=e.match(Cl);if(null===i)throw null;let n=i[1],r=i[2],s=await Cd(t,n,r);return l1(i[1].length+1,s)}class Cc extends de{get description(){return"Render"}get(e){return function(e,t){let i,n;{let e=t.match(Cl);if(null===e)throw Error(`Invalid render volume path: ${JSON.stringify(t)}`);i=e[1],n=e[2]}let r=n.match(Co);if(null===r)throw Error(`Invalid volume path ${JSON.stringify(n)}`);let s=r[1],a=r[2],o=r[3],l=r[4],d=(0,eb.Re)(r[5]||"");return e.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:i,path:n},async()=>{let t=await Ca(e,i,s),n=new Cs(e,i,t,o,a,l,d),r=tR({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(n.stackInfo.voxelResolution,e=>e/1e9),boundingBoxes:[tU({lowerBounds:new Float64Array(n.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(n.stackInfo.upperVoxelBound)})]});return{modelTransform:tj(r),subsources:[{id:"default",default:!0,subsource:{volume:n}},{id:"bounds",default:!0,subsource:{staticAnnotations:tr(r.bounds)}}]}})}(e.chunkManager,e.providerUrl)}completeUrl(e){return Cu(e.providerUrl,e.chunkManager)}}ym("render",()=>new Cc);class Ch extends de{get description(){return"VTK mesh file"}async get(e){let t=await v0(e.chunkManager,e.credentialsManager,e.url);return{modelTransform:tj(tR({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}ym("vtk",()=>new Ch);var Cp=i("6363");function Cg(e,t,i){(0,eb.PT)(e);let n=(0,eb.uq)(e,"name",e=>t((0,eb.ZE)(e))),r=(0,eb.uq)(e,"configuration",e=>(void 0===e?e={}:(0,eb.PT)(e),i(e,n)));return{name:n,configuration:r}}function Cm(e){let{name:t,configuration:i}=Cg(e,e=>{let t=Cf.get(e);if(void 0===t)throw Error(`Unknown codec: ${JSON.stringify(e)}`);return t},e=>e);return{resolver:t,configuration:i}}let Cf=new Map;function Cv(e){Cf.set(e.name,e)}function Cy(e,t){let i=[],n=[],r=[],s=[];n.push(t);let a=(0,eb.m7)(e,Cm),o=a.length,l=0;for(;l<o;++l){let{resolver:e,configuration:r}=a[l];if(e.kind!==Cp.i.arrayToArray)break;let{configuration:s,encodedArrayInfo:o}=e.resolve(r,t);n.push(o),t=o,i.push({kind:Cp.i.arrayToArray,name:e.name,configuration:s})}if(l===o||a[l].resolver.kind!==Cp.i.arrayToBytes)throw Error("Missing array -> bytes codec");let{codecSpec:d,layoutInfo:u,encodedSize:c,shardingInfo:h}=(()=>{let{resolver:e,configuration:i}=a[l],{configuration:n,shardingInfo:r,encodedSize:s}=e.resolve(i,t);if(void 0!==r&&l+1!==o)throw Error("bytes -> bytes codecs not supported following sharding codec");let d=e.getDecodedArrayLayoutInfo(n,t);return{codecSpec:{name:e.name,kind:Cp.i.arrayToBytes,configuration:n},layoutInfo:d,encodedSize:s,shardingInfo:r}})();r[l]=u,s.push(c);let p=[];for(++l;l<o;){let{resolver:e,configuration:t}=a[l];if(e.kind!==Cp.i.bytesToBytes)throw Error(`Expected bytes -> bytes codec, but received ${JSON.stringify(e.name)} of kind ${Cp.i[e.kind]}`);let{configuration:i,encodedSize:n}=e.resolve(t,c);p.push({name:e.name,kind:e.kind,configuration:i}),s.push(n),++l}for(let e=i.length-1;e>=0;--e)r[e]=a[e].resolver.getDecodedArrayLayoutInfo(i[e].configuration,n[e],r[e+1]);return{[Cp.i.arrayToArray]:i,[Cp.i.arrayToBytes]:d,[Cp.i.bytesToBytes]:p,arrayInfo:n,layoutInfo:r,shardingInfo:h,encodedSize:s}}Cv({name:"blosc",kind:Cp.i.bytesToBytes,resolve:e=>((0,eb.PT)(e),{configuration:{}})}),Cv({name:"zstd",kind:Cp.i.bytesToBytes,resolve:e=>((0,eb.PT)(e),{configuration:{}})});var Cb=i("6758");for(let e of(Cv({name:"bytes",kind:Cp.i.arrayToBytes,resolve(e,t){(0,eb.PT)(e);let i=(0,eb.uq)(e,"endian",e=>{switch(e){case"little":return ev.LITTLE;case"big":return ev.BIG;case void 0:if(1===ep[t.dataType])return ey}throw Error(`Invalid endian value: ${JSON.stringify(e)}`)}),n=t.chunkShape.reduce((e,t)=>e*t,1);return{configuration:{endian:i},encodedSize:ep[t.dataType]*n}},getDecodedArrayLayoutInfo:(e,t)=>({physicalToLogicalDimension:Array.from(t.chunkShape,(e,t)=>t),readChunkShape:t.chunkShape})}),Cv({name:"crc32c",kind:Cp.i.bytesToBytes,resolve(e,t){let i;return void 0!==t&&(i=t+4),{configuration:{},encodedSize:i}}}),["gzip","zlib"]))Cv({name:e,kind:Cp.i.bytesToBytes,resolve:e=>((0,eb.PT)(e),{configuration:{level:(0,eb.uq)(e,"level",eb.C$)}})});var CS=i("6252");let Cw=new Map;for(let[e,t]of(Cw.set("|u1",{endianness:ev.LITTLE,dataType:ec.UINT8}),Cw.set("|i1",{endianness:ev.LITTLE,dataType:ec.INT8}),[["<",ev.LITTLE],[">",ev.BIG]])){for(let i of["u","i"])Cw.set(`${e}${i}8`,{endianness:t,dataType:ec.UINT64});Cw.set(`${e}u2`,{endianness:t,dataType:ec.UINT16}),Cw.set(`${e}i2`,{endianness:t,dataType:ec.INT16}),Cw.set(`${e}u4`,{endianness:t,dataType:ec.UINT32}),Cw.set(`${e}i4`,{endianness:t,dataType:ec.INT32}),Cw.set(`${e}f4`,{endianness:t,dataType:ec.FLOAT32})}function CC(e){return(0,eb.m7)(e,e=>{if("number"!=typeof e||!Number.isInteger(e)||e<0)throw Error(`Expected non-negative integer, but received: ${JSON.stringify(e)}`);return e})}function Cx(e,t){return(0,eb.Iw)(Array(t),e,e=>{if("number"!=typeof e||!Number.isInteger(e)||e<=0)throw Error(`Expected positive integer, but received: ${JSON.stringify(e)}`);return e})}function CE(e){if("."!==e&&"/"!==e)throw Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e}let CT=new Map([["",{unit:"",scale:1}],["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:3600}],["day",{unit:"s",scale:86400}]]);for(let e of["meter","second"])for(let t of td){let{longPrefix:i,prefix:n}=t;if(void 0===i)continue;let r={unit:e[0],scale:10**t.exponent};CT.set(`${i}${e}`,r),CT.set(`${n}${e[0]}`,r)}function Ck(e){let t,i;if(null===e)return{scale:1,unit:""};if("string"!=typeof e)throw Error(`Expected string but received: ${JSON.stringify(e)}`);let n=e.trim(),r=n.match(/^([-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)(?:[eE][-+]?\d+)?)\s*(.*)/);null===r?(t=1,i=n):(t=Number(r[1]),i=r[2]);let s=CT.get(i);if(void 0===s)throw Error(`Unsupported unit: ${JSON.stringify(i)}`);return{unit:s.unit,scale:t*s.scale}}function CD(e,t){switch(e){case ec.UINT8:case ec.INT8:case ec.UINT16:case ec.INT16:case ec.UINT32:case ec.INT32:case ec.UINT64:if("number"!=typeof t||!Number.isInteger(t))throw Error(`Expected integer but received: ${JSON.stringify(t)}`);return t;case ec.FLOAT32:if("number"==typeof t)return t;if("string"==typeof t){if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if("NaN"===t)return new Float32Array(Uint32Array.of(0x7fc00000).buffer)[0];if(t.match(/^0x[a-fA-F0-9]+$/))return new Float32Array(Uint32Array.of(Number(t)).buffer)[0]}throw Error(`Expected number, "Infinity", "-Infinity", "NaN", or hex string but received: ${JSON.stringify(t)}`)}}var CP=((H={})[H.START=0]="START",H[H.END=1]="END",H);Cv({name:"sharding_indexed",kind:Cp.i.arrayToBytes,resolve(e,t){(0,eb.PT)(e);let i=(0,eb.uq)(e,"chunk_shape",e=>Cx(e,t.chunkShape.length)),n=(0,eb.Kh)(e,"index_location",e=>(0,eb.CT)(e,CP,/^[a-z]+$/),1),r=Array.from(t.chunkShape,(e,n)=>{let r=i[n];if(e%r!=0)throw Error(`sub-chunk shape of ${JSON.stringify(r)} does not evenly divide outer chunk shape of ${JSON.stringify(t.chunkShape)}`);return e/r}),s=Array.from(r);s.push(2);let a=(0,eb.uq)(e,"index_codecs",e=>Cy(e,{dataType:ec.UINT64,chunkShape:s}));if(void 0===a.encodedSize[a.encodedSize.length-1])throw Error("index_codecs must specify fixed-size encoding");let o=(0,eb.uq)(e,"codecs",e=>Cy(e,{dataType:t.dataType,chunkShape:i}));return{configuration:{indexCodecs:a,subChunkCodecs:o,subChunkShape:i,subChunkGridShape:r,indexLocation:n},shardingInfo:{subChunkShape:i,subChunkGridShape:r,subChunkCodecs:o}}},getDecodedArrayLayoutInfo:(e,t)=>e.subChunkCodecs.layoutInfo[0]}),Cv({name:"transpose",kind:Cp.i.arrayToArray,resolve(e,t){(0,eb.PT)(e);let{order:i,inverseOrder:n}=(0,eb.uq)(e,"order",e=>{let i=t.chunkShape.length,n=Array(i),r=Array(i);if("C"===e)for(let e=0;e<i;++e)n[e]=e,r[e]=e;else if("F"===e)for(let e=0;e<i;++e)n[e]=i-e-1,r[e]=i-e-1;else(0,eb.Iw)(n,e,(t,n)=>{if("number"!=typeof t||!Number.isInteger(t)||t<0||t>=i)throw Error(`Expected integer in range [0, ${i}) but received: ${JSON.stringify(t)}`);if(void 0!==r[t])throw Error(`Invalid permutation: ${JSON.stringify(e)}`);return r[t]=n,t});return{order:n,inverseOrder:r}}),r={dataType:t.dataType,chunkShape:Array.from(i,e=>t.chunkShape[e])};return{configuration:{encodedToDecoded:i,decodedToEncoded:n},encodedArrayInfo:r}},getDecodedArrayLayoutInfo:(e,t,i)=>({physicalToLogicalDimension:Array.from(i.physicalToLogicalDimension,t=>e.encodedToDecoded[t]),readChunkShape:Array.from(e.decodedToEncoded,e=>i.readChunkShape[e])})});let CL=new Set(["0.4","0.5-dev","0.5"]),CI=new Map([["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:3600}],["day",{unit:"s",scale:86400}]]);for(let e of["meter","second"])for(let t of td){let{longPrefix:i}=t;void 0!==i&&CI.set(`${i}${e}`,{unit:e[0],scale:10**t.exponent})}function CR(e){(0,eb.PT)(e);let t=(0,eb.uq)(e,"name",eb.ZE),i=(0,eb.Kh)(e,"type",eb.ZE),n=(0,eb.Kh)(e,"unit",e=>{let t=CI.get(e);if(void 0===t)throw Error(`Unsupported unit: ${JSON.stringify(e)}`);return t},{unit:"",scale:1});return{name:t,unit:n.unit,scale:n.scale,type:i}}function CA(e){let t=(0,eb.m7)(e,CR);return tR({names:t.map(e=>{let{name:t,type:i}=e;return"channel"===i?`${t}'`:t}),scales:Float64Array.from(t,e=>e.scale),units:t.map(e=>e.unit)})}let CM=new Map([["scale",function(e,t){let i=(0,eb.uq)(t,"scale",t=>(0,eb.Iw)(new Float64Array(e),t,eb.o7));return to.Kt(Float64Array,i)}],["identity",function(e,t){return to.XD(Float64Array,e+1)}],["translation",function(e,t){let i=(0,eb.uq)(t,"translation",t=>(0,eb.Iw)(new Float64Array(e),t,eb.jz));return to.Z4(Float64Array,i)}]]);function CN(e,t){let i=to.XD(Float64Array,e+1);return void 0===t?i:((0,eb.m7)(t,t=>{let n=function(e,t){(0,eb.PT)(t);let i=(0,eb.uq)(t,"type",eb.ZE),n=CM.get(i);if(void 0===n)throw Error(`Unsupported coordinate transform type: ${JSON.stringify(i)}`);return n(e,t)}(e,t);i=to.Jp(new Float64Array(i.length),e+1,n,e+1,i,e+1,e+1,e+1,e+1)}),i)}class CV extends ly(vx()(pR),Cb.Y){}class CO extends pM{credentialsProvider;multiscale;volumeType;get dataType(){return this.multiscale.dataType}get modelSpace(){return this.multiscale.coordinateSpace}get rank(){return this.multiscale.coordinateSpace.rank}constructor(e,t,i){super(e),this.credentialsProvider=t,this.multiscale=i,this.volumeType=pE.IMAGE}getSources(e){return(0,Y.PK)(this.multiscale.scales.map(t=>{let{metadata:i}=t,{rank:n,codecs:r,shape:s}=i,a=r.layoutInfo[0].readChunkShape,{physicalToLogicalDimension:o}=i.codecs.layoutInfo[0],l=new Uint32Array(n),d=new Float32Array(n),u=new Float32Array((n+1)**2);u[(n+1)**2-1]=1;for(let e=0;e<n;++e){let t=o[n-1-e];l[e]=a[t],d[e]=s[t],u[e+t*(n+1)]=1}let c=new Float32Array((n+1)**2);return to.Jp(c,n+1,t.transform,n+1,u,n+1,n+1,n+1,n+1),pD({rank:n,chunkToMultiscaleTransform:c,dataType:i.dataType,upperVoxelBound:d,volumeType:this.volumeType,chunkDataSizes:[l],volumeSourceOptions:e,fillValue:i.fillValue}).map(e=>({chunkSource:this.chunkManager.getChunkSource(CV,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:t.url,metadata:i}}),chunkToMultiscaleTransform:c}))}))}}function C_(e,t,i){return e.memoize.getUncounted({type:"zarr:json",url:i,credentialsProvider:(0,nd.M)(t)},async()=>{try{return await v_(t,i,{}).then(e=>e.json())}catch(e){if(vL(e))return;throw e}})}let CF=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];async function CB(e,t,i,n){let r=await Promise.all(i.scales.map(async i=>{let r=await CU(e,t,i.url,{zarrVersion:n.zarrVersion,expectedNodeType:"array",explicitDimensionSeparator:n.explicitDimensionSeparator});if(void 0===r)throw Error(`zarr v{zarrVersion} array metadata not found at ${i.url}`);return r})),s=r[0].dataType,a=r.length,o=i.coordinateSpace.rank;for(let e=0;e<a;++e){let t=i.scales[e],n=r[e];if(n.rank!==o)throw Error(`Expected zarr array at ${JSON.stringify(t.url)} to have rank ${o}, but received: ${n.rank}`);if(n.dataType!==s)throw Error(`Expected zarr array at ${JSON.stringify(t.url)} to have data type ${ec[s]}, but received: ${ec[n.dataType]}`)}let l=new Float64Array(o),d=new Float64Array(o),u=i.scales[0],c=r[0];for(let e=0;e<o;++e){let t=l[e]=u.transform[(o+1)*o+e];d[e]=t+c.shape[e]}let h=tU({lowerBounds:l,upperBounds:d}),{coordinateSpace:p}=i;return{coordinateSpace:tR({names:p.names,units:p.units,scales:p.scales,boundingBoxes:[h]}),dataType:s,scales:i.scales.map((e,t)=>{let i=r[t];return{url:e.url,transform:e.transform,metadata:i}})}}async function CU(e,t,i,n){if(2===n.zarrVersion){let[r,s]=await Promise.all([C_(e,t,`${i}/.zarray`),C_(e,t,`${i}/.zattrs`)]);if(void 0===r){if(void 0===s||"array"===n.expectedNodeType)return;return{zarrVersion:2,nodeType:"group",userAttributes:(0,eb.PT)(s)}}if("group"===n.expectedNodeType)return;return function(e,t,i){try{(0,eb.PT)(e),(0,eb.uq)(e,"zarr_format",e=>{(0,eb.j5)(e,2)});let n=(0,eb.uq)(e,"shape",CC),r=n.length,s=(0,eb.uq)(e,"chunks",e=>Cx(e,r)),a=(0,eb.uq)(e,"order",e=>{if("C"!==e&&"F"!==e)throw Error(`Expected "C" or "F", but received: ${JSON.stringify(e)}`);return e}),o=(0,eb.Kh)(e,"dimension_separator",void 0===i?CE:e=>(0,eb.j5)(e,i),i??"."),l=(0,eb.uq)(e,"dtype",e=>(function(e){let t=Cw.get(e);if(void 0===t)throw Error(`Unsupported numpy data type: ${JSON.stringify(e)}`);return t})((0,eb.ZE)(e))),d=l.dataType,u=(0,eb.uq)(e,"fill_value",e=>null===e?0:CD(d,e)),c=[];"F"===a&&c.push({name:"transpose",configuration:{order:Array.from(n,(e,t)=>r-t-1)}}),c.push({name:"bytes",configuration:{endian:l.endianness===ev.LITTLE?"little":"big"}}),(0,eb.uq)(e,"compressor",e=>{if(null===e)return;(0,eb.PT)(e);let t=(0,eb.uq)(e,"id",eb.ZE);switch(t){case"blosc":c.push({name:"blosc",configuration:{cname:(0,eb.uq)(e,"cname",eb.ZE),clevel:(0,eb.uq)(e,"clevel",eb.C$),typesize:ep[d],shuffle:(0,eb.uq)(e,"shuffle",e=>{switch(e){case -1:return 1===ep[d]?"bitshuffle":"shuffle";case 0:return"noshuffle";case 1:return"shuffle";case 2:return"bitshuffle"}throw Error(`Invalid value: ${JSON.stringify(e)}`)}),blocksize:(0,eb.Kh)(e,"blocksize",eb.C$,0)}});break;case"zlib":case"gzip":case"zstd":c.push({name:t,configuration:{level:(0,eb.uq)(e,"level",eb.C$)}});break;default:throw Error(`Unsupported compressor: ${JSON.stringify(t)}`)}});let h=Cy(c,{dataType:d,chunkShape:s});return{zarrVersion:2,nodeType:"array",rank:r,shape:n,chunkShape:s,dataType:d,fillValue:u,dimensionNames:(0,eb.uq)(t,"_ARRAY_DIMENSIONS",e=>(0,eb.ah)(e,r)),dimensionUnits:(0,eb.uq)(t,"dimension_units",e=>(0,eb.ah)(e,r)),userAttributes:t,dimensionSeparator:o,chunkKeyEncoding:CS.$.V2,codecs:h}}catch(e){throw Error(`Error parsing zarr v2 metadata: ${e.message}`)}}(r,s??{},n.explicitDimensionSeparator)}if(3===n.zarrVersion){let r=await C_(e,t,`${i}/zarr.json`);if(void 0===r)return;if(void 0!==n.explicitDimensionSeparator)throw Error("dimension_separator query parameter not supported for zarr v3");return function(e,t){try{(0,eb.PT)(e),(0,eb.uq)(e,"zarr_format",e=>{(0,eb.j5)(e,3)});let i=(0,eb.uq)(e,"node_type",e=>{if(void 0!==t&&(0,eb.j5)(e,t),"array"!==e&&"group"!==e)throw Error(`Expected "array" or "group" but received: ${JSON.stringify(e)}`);return e});if(t=i,"group"===i)return{zarrVersion:3,nodeType:"group",userAttributes:(0,eb.Kh)(e,"attributes",eb.PT,{})};let n=(0,eb.uq)(e,"shape",CC),r=n.length,s=(0,eb.uq)(e,"dimension_names",e=>(0,eb.ah)(e??void 0,r)),a=(0,eb.uq)(e,"data_type",e=>(0,eb.CT)(e,ec,/^[a-z0-9]+$/)),{configuration:o}=(0,eb.uq)(e,"chunk_grid",e=>Cg(e,e=>(0,eb.j5)(e,"regular"),e=>(0,eb.uq)(e,"chunk_shape",e=>Cx(e,r)))),{userAttributes:l,dimensionUnits:d}=(0,eb.uq)(e,"attributes",e=>{void 0===e&&(e={}),(0,eb.PT)(e);let t=(0,eb.uq)(e,"dimension_units",e=>(0,eb.ah)(e,r));return{userAttributes:e,dimensionUnits:t}}),{configuration:u,name:c}=(0,eb.uq)(e,"chunk_key_encoding",e=>Cg(e,e=>(0,eb.CT)(e,CS.$,/^(v2|default)$/),(e,t)=>(0,eb.Kh)(e,"separator",CE,t===CS.$.DEFAULT?"/":"."))),h=(0,eb.uq)(e,"fill_value",e=>CD(a,e)),p=(0,eb.uq)(e,"codecs",e=>Cy(e,{dataType:a,chunkShape:o}));return{zarrVersion:3,nodeType:i,rank:r,shape:n,chunkShape:o,dataType:a,fillValue:h,dimensionNames:s,dimensionUnits:d,chunkKeyEncoding:c,dimensionSeparator:u,userAttributes:l,codecs:p}}catch(i){let e=void 0===t?"":`${t} `;throw Error(`Error parsing zarr v3 ${e}metadata: ${i.message}`)}}(r,n.expectedNodeType)}let[r,s]=await Promise.all([CU(e,t,i,{...n,zarrVersion:2}),CU(e,t,i,{...n,zarrVersion:3})]);if(void 0!==r&&void 0!==s)throw Error("Both zarr v2 and v3 metadata found");return r??s}class C$ extends de{zarrVersion;constructor(e){super(),this.zarrVersion=e}get description(){let e=void 0===this.zarrVersion?"":` v${this.zarrVersion}`;return`Zarr${e} data source`}get(e){let[,t,i]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),n=(0,eb.Re)(i||"");(0,eb.PT)(n);let r=(0,eb.Kh)(n,"dimension_separator",CE);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:r},async()=>{let i;let{url:n,credentialsProvider:s}=vO(t,e.credentialsManager),a=await CU(e.chunkManager,s,n,{zarrVersion:this.zarrVersion,explicitDimensionSeparator:r});if(void 0===a)throw Error("No zarr metadata found");if("group"===a.nodeType){let t=function(e,t,i){let n=t.ome,r=void 0==n?t.multiscales:n.multiscales;if(!Array.isArray(r))return;let s=[];for(let t of r){if("object"!=typeof t||null==t||Array.isArray(t))return;let r=void 0==n?t.version:n.version;if(void 0===r)return;if(!CL.has(r)){s.push(`OME multiscale metadata version ${JSON.stringify(r)} is not supported`);continue}if("0.5"===r&&3!==i){s.push(`OME multiscale metadata version ${JSON.stringify(r)} is not supported for zarr v${i}`);continue}return function(e,t){let i=(0,eb.uq)(t,"axes",CA),n=i.rank,r=(0,eb.uq)(t,"coordinateTransformations",e=>CN(n,e)),s=(0,eb.uq)(t,"datasets",t=>(0,eb.m7)(t,t=>{let i=function(e,t,i){let n=(0,eb.uq)(i,"path",eb.ZE),r=(0,eb.uq)(i,"coordinateTransformations",t=>CN(e,t));return{url:`${t}/${n}`,transform:r}}(n,e,t);return i.transform=to.Jp(new Float64Array((n+1)**2),n+1,r,n+1,i.transform,n+1,n+1,n+1,n+1),i}));if(0===s.length)throw Error("At least one scale must be specified");let a=s[0].transform,o=new Float64Array(n);for(let e=0;e<n;++e){let t=o[e]=a[e*(n+1)+e];i.scales[e]*=t}for(let e of s){let t=e.transform;for(let e=0;e<n;++e){let i=0;for(let r=0;r<n;++r)i+=.5*t[r*(n+1)+e];t[n*(n+1)+e]-=i}for(let e=0;e<n;++e)for(let i=0;i<=n;++i)t[i*(n+1)+e]/=o[e]}return{coordinateSpace:i,scales:s}}(e,t)}if(0!==s.length)throw Error(s[0])}(n,a.userAttributes,a.zarrVersion);if(void 0===t)throw Error("Neithre array nor OME multiscale metadata found");i=await CB(e.chunkManager,s,t,{zarrVersion:a.zarrVersion,explicitDimensionSeparator:r})}else i=function(e,t){let i=function(e,t){let i=new Set,n=2===t?"d":"dim_";return e.map((e,t)=>{if(null===e){let r=t;for(;;){if(e=`${n}${r}`,!i.has(e))return i.add(e),e;++r}}if(!i.has(e))return i.add(e),e;let r=1;for(;;){let t=`${e}${r}`;if(!i.has(t))return i.add(t),t;++r}})}(t.dimensionNames,t.zarrVersion),n=t.dimensionUnits.map(Ck),r=tR({names:i,scales:Float64Array.from(Array.from(n,e=>e.scale)),units:Array.from(n,e=>e.unit),boundingBoxes:[tU({lowerBounds:new Float64Array(t.rank),upperBounds:Float64Array.from(t.shape)})]}),s=to.XD(Float64Array,t.rank+1);return{coordinateSpace:r,dataType:t.dataType,scales:[{url:e,transform:s,metadata:t}]}}(n,a);let o=new CO(e.chunkManager,s,i);return{modelTransform:tj(o.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:o}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:tr(o.modelSpace.bounds)}}]}})}async completeUrl(e){let[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return void 0!==t?l1(e.providerUrl.length-t.length,await l6(t,CF)):await y7(e.credentialsManager,e.providerUrl,e.abortSignal)}}ym("zarr",()=>new C$),ym("zarr2",()=>new C$(2)),ym("zarr3",()=>new C$(3));i("2950");let CG=Symbol("SingleTextureVolumeChunk.textureUnit"),Cz=Symbol("SingleTextureVolumeChunk.textureLayout");class Cj extends ef.gj{shaderKey;dataType;constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",CG)}beginDrawing(e,t){let i=t.textureUnit(CG);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),t[Cz]=null}endDrawing(e,t){e.bindTexture(nf[this.shaderSamplerType],null),t[Cz]=null}bindChunk(e,t,i,n,r,s,a){let o=i.textureLayout;(t[Cz]!==o||a)&&(t[Cz]=o,this.setupTextureLayout(e,t,o,n,r,s)),e.bindTexture(nf[this.shaderSamplerType],i.texture)}beginSource(e,t){}}class CW extends pA{texture=null;data;textureLayout;constructor(e,t){super(e,t),this.data=t.data}copyToGPU(e){if(super.copyToGPU(e),null===this.data)return;let t=this.texture=e.createTexture(),i=nf[this.chunkFormat.shaderSamplerType];e.bindTexture(i,t),this.setTextureData(e),e.bindTexture(i,null)}freeGPUMemory(e){super.freeGPUMemory(e),null!==this.data&&(e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null)}}class Cq extends ef.gj{chunkDataSize;textureDims;strides;textureShape;constructor(e,t,i){super(),this.chunkDataSize=t,this.textureDims=i;let n=t.length,r=0;for(let e of t)1!==e&&++r;let s=this.strides=new Uint32Array(n*i),a=3===i?e.max3dTextureSize:e.maxTextureSize,o=0,l=1,d=this.textureShape=new Uint32Array(this.textureDims);d.fill(1);for(let e=0;e<n;++e){let n;let u=t[e];if(1===u)continue;let c=u*l;c>a||1!==l&&o+r<i?(++o,l=u,n=1):(n=l,l=c),s[i*e+o]=n,d[o]=l}}static get(e,t,i){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${i}`,()=>new Cq(e,t,i))}}let CH=new Uint32Array(15);class CJ extends Cj{textureDims;texelsPerElement;textureInternalFormat;textureFormat;texelType;arrayElementsPerTexel;arrayConstructor;samplerPrefix;shaderSamplerType;textureAccessHelper;static get(e,t,i){let n=`sliceview.UncompressedChunkFormat:${t}:${i}`;return e.memoize.get(n,()=>new CJ(e,t,n,i))}constructor(e,t,i,n){super(i,t),this.textureDims=n,cv(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${n}D`,this.textureAccessHelper=new cw("chunkData",n)}defineShader(e,t,i=!1){super.defineShader(e,t);let{textureDims:n}=this,r=`ivec${this.textureDims}`,{textureAccessHelper:s}=this,a=(4+t)*n;CH.length<a&&(CH=new Uint32Array(a)),e.addUniform(`highp ${r}`,"uVolumeChunkStrides",4+t);let o=s.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType),l=rn(this.dataType),d=`
${l} getDataValueAt(highp ivec3 p`;for(let e=0;e<t;++e)d+=`, highp int channelIndex${e}`;d+=`) {
  highp ${r} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let e=0;e<t;++e)d+=`
  offset += channelIndex${e} * uVolumeChunkStrides[${4+e}];
`;d+=`
  return readVolumeData(offset);
}
`,i?(e.addVertexCode(o),e.addVertexCode(d)):(e.addFragmentCode(o),e.addFragmentCode(d))}setupTextureLayout(e,t,i,n,r,s){let a=CH,o=s.length,{strides:l}=i,d=n.length,{textureDims:u}=this;for(let e=0;e<u;++e){let t=0;for(let i=0;i<d;++i)t+=n[i]*l[i*u+e];a[e]=t}for(let e=0;e<3;++e){let t=r[e];if(!(t>=d))for(let i=0;i<u;++i)a[(e+1)*u+i]=l[t*u+i]}for(let e=0;e<o;++e){let t=s[e];if(-1===t)a.fill(0,(4+e)*u,(4+e+1)*u);else for(let i=0;i<u;++i)a[(4+e)*u+i]=l[t*u+i]}let c=(4+o)*u;3===u?e.uniform3iv(t.uniform("uVolumeChunkStrides"),a,0,c):e.uniform2iv(t.uniform("uVolumeChunkStrides"),a,0,c)}getTextureLayout(e,t){return Cq.get(e,t,this.textureDims)}setTextureData(e,t,i){let{textureShape:n}=t;(3===this.textureDims?function(e,t,i,n,r,s){var a;let{arrayConstructor:o,textureInternalFormat:l,textureFormat:d,texelsPerElement:u}=t;i.constructor!==o&&(i=new o(i.buffer,i.byteOffset,i.byteLength/o.BYTES_PER_ELEMENT)),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),(a=e).texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),a.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),a.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),a.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),a.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,n*u,r,s,0,d,t.texelType,i)}:function(e,t,i,n,r){let{arrayConstructor:s,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=t;i.constructor!==s&&(i=new s(i.buffer,i.byteOffset,i.byteLength/s.BYTES_PER_ELEMENT)),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),nP(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,n*l,r,0,o,t.texelType,i)})(e,this,i,n[0],n[1],n[2])}}class CK extends CW{setTextureData(e){let t;let{source:i}=this,{chunkFormatHandler:n}=i,{chunkFormat:r}=n;this.chunkDataSize===i.spec.chunkDataSize?this.textureLayout=t=n.textureLayout.addRef():this.textureLayout=t=r.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,t,this.data)}getValueAt(e){let{data:t}=this;if(null===t)return this.source.spec.fillValue;let{chunkFormat:i}=this,{chunkDataSize:n}=this,r=0,s=1,a=e.length;for(let t=0;t<a;++t)r+=s*e[t],s*=n[t];switch(i.dataType){case ec.UINT8:case ec.INT8:case ec.FLOAT32:case ec.UINT16:case ec.INT16:case ec.UINT32:case ec.INT32:return t[r];case ec.UINT64:{let e=2*r;return new eC.E(t[e],t[e+1])}}}}class CZ extends ef.gj{textureLayout;texture}class CY extends ef.gj{chunkFormat;textureLayout;fillValueChunk;constructor(e,t){super();let i=0;for(let e of t.chunkDataSize)e>1&&++i;let n=i>=3?3:2;this.chunkFormat=this.registerDisposer(CJ.get(e,t.dataType,n)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.UncompressedChunkFormat.fillValue:${t.chunkDataSize.length}:${t.dataType}:${t.fillValue}:${n}`,()=>(function(e,t,i,n,r){let{dataType:s}=t,a=function(e,t){let i=new eg[e](em[e]);return e===ec.UINT64?(i[0]=t.low,i[1]=t.high):i[0]=t,i}(s,i),o=new Uint32Array(n);o.fill(1);let l=new Cq(e,o,r);l.strides.fill(0);let d=e.createTexture(),u=nf[t.shaderSamplerType];e.bindTexture(u,d),t.setTextureData(e,l,a),e.bindTexture(u,null);let c=new CZ;return c.textureLayout=l,c.texture=d,c})(e,this.chunkFormat,t.fillValue,t.chunkDataSize.length,n)))}getChunk(e,t){let i=new CK(e,t);return null===i.data&&(i.texture=this.fillValueChunk.texture,i.textureLayout=this.fillValueChunk.textureLayout),i}}function CX(e,t,i,n,r,s){let a=0,o=0,l=1,d=1;for(let e=0;e<3;++e){let t=r[e],s=n[e],u=Math.floor(t/s),c=t%s;a+=u*l,l*=Math.ceil(i[e]/s),o+=c*d,d*=s}let u=t+2*a,c=e[u],h=e[u+1],p=0xffffff&c,g=c>>24&255;if(g>0){let i=e[(t+h&0xffffff)+Math.floor(o*g/32)],n=o*g%32;p+=s*(i>>n&(1<<g)-1)}return p}J=(e,t)=>null==t.compressedSegmentationBlockSize?new CY(e,t):null,pL.push(J);class CQ extends ef.gj{subchunkGridSize;singleton;constructor(e,t){super();let i=this.subchunkGridSize=Q.R3.create();for(let n=0;n<3;++n)i[n]=Math.ceil(e[n]/t[n]);this.singleton=!1}static get(e,t,i){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${(0,Q.m0)(t)},${(0,Q.m0)(i)}`,()=>new CQ(t,i))}}let C0=cv(new cs,ec.UINT32),C1=new Uint32Array(16);class C2 extends Cj{subchunkSize;numChannels;static get(e,t,i,n){let r=`sliceview.CompressedSegmentationChunkFormat:${t}:${n}`,s=`${r}:${(0,Q.m0)(i)}`;return e.memoize.get(s,()=>new C2(t,i,n,r))}textureAccessHelper;get shaderSamplerType(){return"usampler2D"}constructor(e,t,i,n){super(n,e),this.subchunkSize=t,this.numChannels=i,this.textureAccessHelper=new cS("chunkData")}defineShader(e,t){super.defineShader(e,t);let i=4*(4+t);C1.length<i&&(C1=new Uint32Array(i));let{textureAccessHelper:n}=this;n.defineShader(e);e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(n4);let{dataType:r}=this,s=rn(r);r===ec.UINT64?e.addFragmentCode(nG):e.addFragmentCode(n2),e.addFragmentCode(n.getAccessor("compressedSegmentationChunkFormat_readTextureValue","uVolumeChunkSampler",ec.UINT32,1));let a=`
uint compressedSegmentationChunkFormat_getChannelOffset(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return compressedSegmentationChunkFormat_readTextureValue(uint(channelIndex)).value;
}
${s} getDataValueAt(highp ivec3 p`;for(let e=0;e<t;++e)a+=`, highp int channelIndex${e}`;a+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let e=0;e<t;++e)a+=`
  chunkPositionFull += channelIndex${e} * uVolumeChunkStrides[${4+e}];
`;a+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(compressedSegmentationChunkFormat_getChannelOffset(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = compressedSegmentationChunkFormat_readTextureValue(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = compressedSegmentationChunkFormat_readTextureValue(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = compressedSegmentationChunkFormat_readTextureValue(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===ec.UINT64?"2u":"1u"};
  }
  ${s} result;
`,r===ec.UINT64?a+=`
  result.value[0] = compressedSegmentationChunkFormat_readTextureValue(outputValueOffset).value;
  result.value[1] = compressedSegmentationChunkFormat_readTextureValue(outputValueOffset+1u).value;
`:a+=`
  result.value = compressedSegmentationChunkFormat_readTextureValue(outputValueOffset).value;
`,a+=`
  return result;
}
`,e.addFragmentCode(a)}setupTextureLayout(e,t,i,n,r,s){let{subchunkGridSize:a}=i;e.uniform3i(t.uniform("uSubchunkGridSize"),a[0],a[1],a[2]);let o=C1,l=s.length;if(o.fill(0),!i.singleton){for(let e=0;e<3;++e){o[e]=n[e];let t=r[e];-1!==t&&(o[4*(e+1)+t]=1)}for(let e=0;e<l;++e){let t=s[e];-1!==t&&(o[4*(4+e)+t]=1)}}e.uniform4iv(t.uniform("uVolumeChunkStrides"),o,0,(l+4)*4)}setTextureData(e,t,i){cy(e,C0,i)}getTextureLayout(e,t){return CQ.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:i}=this;e.uniform3i(t.uniform("uSubchunkSize"),i[0],i[1],i[2])}}class C3 extends CW{setTextureData(e){let{data:t}=this,{chunkFormat:i}=this,n=this.textureLayout=i.getTextureLayout(e,this.chunkDataSize);i.setTextureData(e,n,t)}getValueAt(e){let{chunkDataSize:t,chunkFormat:i}=this,{data:n}=this;if(null===n)return this.source.spec.fillValue;let r=n[e[3]||0];if(i.dataType===ec.UINT64){let s=new eC.E;return!function(e,t,i,n,r,s){let a=CX(t,i,n,r,s,2)+i;e.low=t[a],e.high=t[a+1]}(s,n,r,t,i.subchunkSize,e),s}return function(e,t,i,n,r){let s=CX(e,t,i,n,r,1)+t;return e[s]}(n,r,t,i.subchunkSize,e)}}class C4 extends ef.gj{textureLayout;texture}class C6 extends ef.gj{chunkFormat;fillValueChunk;constructor(e,t){super();let{dataType:i}=t;if(i!==ec.UINT64&&i!==ec.UINT32)throw Error(`Unsupported compressed segmentation data type: ${ec[i]}`);this.chunkFormat=this.registerDisposer(C2.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.CompressedSegmentationChunkFormat.fillValue:${t.dataType}:${t.fillValue}:${this.chunkFormat.numChannels}`,()=>(function(e,t,i){let{dataType:n,numChannels:r}=t,s=new Uint32Array(r+2+(n===ec.UINT64?2:1));s[0]=r,s[r]=2,n===ec.UINT64?(s[r+2]=i.low,s[r+3]=i.high):s[r+2]=i;let a=new CQ(Uint32Array.of(1,1,1),Q.R3.fromValues(1,1,1));a.singleton=!0;let o=e.createTexture(),l=nf[t.shaderSamplerType];e.bindTexture(l,o),t.setTextureData(e,a,s),e.bindTexture(l,null);let d=new C4;return d.textureLayout=a,d.texture=o,d})(e,this.chunkFormat,t.fillValue)))}getChunk(e,t){let i=new C3(e,t);return null===i.data&&(i.texture=this.fillValueChunk.texture,i.textureLayout=this.fillValueChunk.textureLayout),i}}K=(e,t)=>null!=t.compressedSegmentationBlockSize?new C6(e,t):null,pL.push(K),i("4636"),i("7550");var C5=i("9158"),C8=i("7317"),C7=i("4345"),C9=i("754");function xe(e,t){return i=>{i.style.flex=e,t(i)}}function xt(e,t){return i=>{for(let n of(i.style.display="flex",i.style.flexDirection=e,t)){let e=i.ownerDocument.createElement("div");i.appendChild(e),n(e)}}}i("1167"),i("5125");let xi=Q._E.create();function xn(e,t){let i=Q._E.identity(xi),{globalPosition:n,displayDimensionRenderInfo:{canonicalVoxelFactors:r,displayDimensionIndices:s}}=e;for(let e=0;e<3;++e){let a=s[e];i[12+e]=-1===a?0:n[a],i[5*e]=t/r[e]}return Q._E.multiply(i,e.viewProjectionMat,i),i}class xr extends ef.gj{gl;vertexBuffer;colorBuffer;trivialColorShader;constructor(e){var t;super(),this.gl=e,this.vertexBuffer=this.registerDisposer(nE.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));this.colorBuffer=this.registerDisposer(nE.fromData(e,new Float32Array([1,0,0,.5,1,0,0,.5,0,1,0,.5,0,1,0,.5,0,0,1,.5,0,0,1,.5]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer((t=e).memoize.get("trivialColorShader",()=>{let e=new ny(t);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()}))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new xr(e))}draw(e,t=!0){let i=this.trivialColorShader,n=this.gl;i.bind(),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,e);let r=i.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(r,4);let s=i.attribute("aColor");this.colorBuffer.bindToVertexAttrib(s,4),t&&(n.colorMask(!1,!1,!1,!0),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.colorMask(!0,!0,!0,!0),n.enable(n.BLEND),n.blendFunc(n.ONE_MINUS_DST_ALPHA,n.DST_ALPHA)),n.lineWidth(1),n.drawArrays(n.LINES,0,6),t&&n.disable(n.BLEND),n.disableVertexAttribArray(r),n.disableVertexAttribArray(s)}}var xs=i("9443");i("444");class xa{renderLayers=[null];pickData=[null];values=[0,0,0];nextPickID=1;clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,i=1,n=null){return this.register(e,i,t.low,t.high,n)}register(e,t=1,i=0,n=0,r=null){let{renderLayers:s,values:a}=this,o=this.nextPickID;this.nextPickID+=t;let l=s.length;s[l]=e;let d=3*l;return a[d]=o,a[d+1]=i,a[d+2]=n,this.pickData[l]=r,o}setMouseState(e,t){let{renderLayers:i,values:n}=this,r=0,s=i.length-1;for(;r<s;){let e=Math.ceil(r+(s-r)/2);n[3*e]>t?s=e-1:r=e}let a=e.pickedRenderLayer=i[r],o=3*r,l=e.pickedOffset=t-n[o],{pickedValue:d}=e;d.low=n[o+1],d.high=n[o+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;let u=this.pickData[r];null!==a&&a.updateMouseState(e,d,l,u)}}let xo=Math.PI/20;function xl(e,t){return Math.sqrt(e*e+t*t)}function xd(e){let[t,i]=e;t.identifier>i.identifier&&([i,t]=[t,i]);let n=t.clientX-i.clientX,r=t.clientY-i.clientY,s=xl(n,r);return{distance:s,angle:Math.atan2(n,r)}}class xu extends ef.gj{target;eventMap;dispatch(e,t,i,n=t.eventPhase){sm(e,t,n,i,this.eventMap)}prevTouches;prevEvent;moved;prevAngle;rotated;prevDistance;pinched;prevCenterX;prevCenterY;translated;startHold;numPriorTaps;priorTapNumTouches;tapStartTime;tapEndTime;curTapNumTouches;handleTouchEvent(e){if(e.target!==this.target)return;e.preventDefault();let t=new Map,{prevTouches:i,prevEvent:n}=this,r=0,s=0;for(let i of e.targetTouches)t.set(i.identifier,i),r+=i.clientX,s+=i.clientY;for(let[e,n]of(r/=t.size,s/=t.size,i.entries())){let r=t.get(e);if(void 0===r)i.delete(e);else{let e=r.clientX-n.clientX,t=r.clientY-n.clientY;(Math.abs(e)>=10||Math.abs(t)>=10)&&(this.moved=!0)}}if(void 0===n||n.targetTouches.length!==t.size||0===t.size){if(this.moved=!1,"touchstart"===e.type)this.startHold(e,e.eventPhase,r,s),(void 0===n||0===n.targetTouches.length)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if("touchend"===e.type){let t=Date.now();if(0===e.targetTouches.length&&t-this.tapStartTime<400){(this.curTapNumTouches!==this.priorTapNumTouches||t-this.tapEndTime>=500)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=t,this.priorTapNumTouches=this.curTapNumTouches;let i={event:e,centerX:r,centerY:s};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,i)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=r,this.prevCenterY=s,this.translated=!1,2===t.size){let{distance:e,angle:i}=xd(t.values());this.prevDistance=e,this.prevAngle=i,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:a,prevCenterY:o,translated:l}=this,d=r-a,u=s-o;if(!1===l&&xl(d,u)>=10&&(l=this.translated=!0),!0===l&&(0!==d||0!==u)){this.prevCenterX=r,this.prevCenterY=s;let i={event:e,deltaX:d,deltaY:u,centerX:r,centerY:s};this.dispatch(`touchtranslate${t.size}`,e,i)}if(2===t.size){let{distance:i,angle:n}=xd(t.values()),{pinched:a,rotated:o,prevDistance:l,prevAngle:d}=this;!1===a&&Math.abs(i-l)>=20&&(this.pinched=a=!0);let u=function(e,t){let i=2*Math.PI,n=Math.abs(e-t)%i;return Math.min(n,i-n)}(n,d);if(!1===o&&u>=xo&&(this.rotated=o=!0),!0===a&&i!==l){this.prevDistance=i;let t={event:e,distance:i,prevDistance:l,centerX:r,centerY:s};this.dispatch("touchpinch",e,t)}!0===o&&n!==d&&(this.prevAngle=n,this.dispatch("touchrotate",e,{event:e,centerX:r,centerY:s,angle:n,prevAngle:d}))}}constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new Map,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable((0,da.Z)((e,t,i,n)=>{this.dispatch(`touchhold${e.targetTouches.length}`,e,{event:e,centerX:i,centerY:n},t)},1e3,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",e=>{this.handleTouchEvent(e)}),this.registerEventListener(e,"touchmove",e=>{this.handleTouchEvent(e)}),this.registerEventListener(e,"touchend",e=>{this.handleTouchEvent(e)})}}let xc=Q.R3.create();class xh{pickIDs=new xa;viewportWidth=0;viewportHeight=0;invTransform=Q._E.create();frameNumber=-1}class xp{buffer=null;glWindowX=0;glWindowY=0;frameNumber;sync}let xg=11,xm=(()=>{let e=(e,t)=>(e-5)**2+(t-5)**2,t=new Uint32Array(xg*xg),i=0;for(let n=0;n<xg;++n)for(let r=0;r<xg;++r)!(e(n,r)>25)&&(t[i++]=r*xg+n);return(t=t.subarray(0,i)).sort((t,i)=>{let n=t%xg,r=(t-n)/xg,s=i%xg,a=(i-s)/xg;return e(n,r)-e(s,a)}),t})();function xf(e,t,i,n,r,s,a){let o=n-5,l=r-5;if(!(o>=0)||!(l>=0)||!(o+xg<=s)||!(l+xg<=a))for(let n=0;n<xg;++n)for(let r=0;r<xg;++r){let d=o+r,u=l+n;(d<0||u<0||d>=s||u>=a)&&(e[t+(u*xg+d)*i]=0)}}class xv extends iP{viewer;mouseX;mouseY;pickRequestPending;mouseStateForcer;isMovingToMousePosition;inputEventMap;pickingData;pickRequests;pickBufferContents;pickTimerId;cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:i}=t;null!==i&&e.deleteSync(i),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:i}=e;null===i?(i=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,i),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,32*xg*xg,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,i);let{renderViewport:n}=this,r=this.mouseX-n.visibleLeftFraction*n.logicalWidth,s=n.height-(this.mouseY-n.visibleTopFraction*n.logicalHeight);this.issuePickRequest(r,s),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=r,e.glWindowY=s,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),-1===this.pickTimerId&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:a}=this;e!==a[0]&&(a[1]=a[0],a[0]=e),this.nextPickRequestTime=Date.now()+30}completePickInternal(e){let{gl:t}=this,{pickBufferContents:i}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,i),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:n}=this,{frameNumber:r}=e;this.completePickRequest(e.glWindowX,e.glWindowY,i,n[0].frameNumber===r?n[0]:n[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let i,n=this.context.frameNumber,r=-1;e&&(r=--n-1);let{pickRequests:s}=this,{gl:a}=this,o=!1,l=!1;for(let e of s){let{sync:s}=e;if(null===s)continue;let{frameNumber:d}=e;if(!l&&d>=n-1){if(t||a.getSyncParameter(s,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(e),l=!0;else if(d!==r){o=!0;continue}}a.deleteSync(s),e.sync=null,i=e}let{pickTimerId:d}=this;o&&-1===d?this.scheduleCheckForPickRequestCompletion():!o&&-1!==d&&(window.clearTimeout(d),this.pickTimerId=-1),!e&&void 0!==i&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(i)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:i}=this;i[0]=i[1];let n=this.context.frameNumber,r=i[1];if(r.frameNumber=n,r.viewportWidth=e,r.viewportHeight=t,r.pickIDs.clear(),!this.drawWithPicking(r)){r.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}nextPickRequestTime;pendingPickRequestTimerId;pendingPickRequestTimerExpired;canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:i}=this;return!(e<t)||(-1===i&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1)}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:i}=this;for(let n of i){let{sync:i}=n;if(null!==i){if(!(n.frameNumber<e-1))continue;t.deleteSync(i)}this.issuePickRequestInternal(n);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let i=this.context.frameNumber,n=this.pickingData[1];if(n.frameNumber===i&&this.renderViewport.width===n.viewportWidth&&this.renderViewport.height===n.viewportHeight)this.pickRequestPending=!0,this.attemptToIssuePickRequest()}isMovingToMousePositionOnPick;constructor(e,t,i){super(e,t,i.visibility),this.viewer=i,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.isMovingToMousePosition=!1,this.pickingData=[new xh,new xh],this.pickRequests=[new xp,new xp],this.pickBufferContents=new Float32Array(8*xg*xg),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.isMovingToMousePositionOnPick=!1,this.inputEventMap=i.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),"undefined"!=typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP&&!0===NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new mT(t)),this.registerDisposer(new aq(t,this.inputEventMap)),this.registerDisposer(new sy(t,this.inputEventMap,e=>{this.onMousemove(e)})),this.registerDisposer(new xu(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",e=>{e.target!==t&&this.onMouseout()},!0),sv(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),sv(t,"snap",()=>{this.navigationState.pose.snap()}),sv(t,"zoom-in",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.zoomBy(.5)}),sv(t,"zoom-out",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.zoomBy(2)}),sv(t,"depth-range-decrease",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.depthRange.value*=.5}),sv(t,"depth-range-increase",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.depthRange.value*=2});for(let e=0;e<3;++e){let i=Q.lA[e];for(let n of[-1,1]){let r=n<0?"-":"+";sv(t,`rotate-relative-${i}${r}`,()=>{this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateRelative(Q.nn[e],.1*n)});let s=Q.R3.create();sv(t,`${i}${r}`,()=>{this.context.flagContinuousCameraMotion();let{navigationState:t}=this;s[0]=0,s[1]=0,s[2]=0,s[e]=n,t.pose.translateVoxelsRelative(s)})}}for(let e of(sv(t,"zoom-via-wheel",e=>{this.context.flagContinuousCameraMotion();let t=e.detail;this.onMousemove(t,!1),this.zoomByMouse(sS(t))}),sv(t,"adjust-depth-range-via-wheel",e=>{this.context.flagContinuousCameraMotion();let t=e.detail;this.navigationState.depthRange.value*=sS(t)}),sv(t,"translate-via-mouse-drag",e=>{sb(e.detail,(e,t,i)=>{this.context.flagContinuousCameraMotion(),this.translateByViewportPixels(t,i)})}),sv(t,"translate-in-plane-via-touchtranslate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.translateByViewportPixels(t.deltaX,t.deltaY)}),sv(t,"translate-z-via-touchtranslate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e,{navigationState:i}=this;xc[0]=0,xc[1]=0,xc[2]=t.deltaY+t.deltaX,i.pose.translateVoxelsRelative(xc)}),[1,10]))sv(t,`z+${e}-via-wheel`,t=>{this.context.flagContinuousCameraMotion();let i=t.detail,{navigationState:n}=this,r=0!==i.deltaY?i.deltaY:i.deltaX;xc[0]=0,xc[1]=0,xc[2]=(r>0?-1:1)*e,n.pose.translateVoxelsRelative(xc)});sv(t,"move-to-mouse-position",()=>{let{mouseState:e}=this.viewer;e.updateUnconditionally()&&(this.navigationState.position.value=e.position)}),sv(t,"snap",()=>this.navigationState.pose.snap()),sv(t,"move-annotation",e=>{let{mouseState:t}=this.viewer,i=t.pickedAnnotationId,n=t.pickedAnnotationLayer;if(void 0!==n&&void 0!==i){e.stopPropagation();let r=n.source.getReference(i),s=r.value,a=ll(s.type),o=t.pickedOffset,{chunkTransform:{value:l}}=n;if(void 0!==l.error)return;let{layerRank:d}=l,u=new Float32Array(d);a.getRepresentativePoint(u,s,t.pickedOffset);let c=Q.K4.set(Q.K4.create(),0,0);t.updateUnconditionally()&&sb(e.detail,(e,t,i)=>{Q.K4.add(c,c,[t,i]);let h=new Float32Array(d);to.DC(h,l.chunkToLayerTransform,d+1,u,d);let{displayDimensionIndices:p}=this.navigationState.pose.displayDimensions.value;!function(e,t,i,n){let{globalToRenderLayerDimensions:r}=i;for(let i=0;i<3;++i){let s=0,a=n[i];if(-1!==a){let e=r[a];-1!==e&&(s=t[e])}e[i]=s}}(xc,h,l.modelTransform,p),this.translateDataPointByViewportPixels(xc,xc,c[0],c[1]),!function(e,t,i,n){let{globalToRenderLayerDimensions:r}=i;for(let i=0;i<3;++i){let s=n[i];if(-1!==s){let n=r[s];-1!==n&&(e[n]=t[i])}}}(h,xc,l.modelTransform,p);let g=new Float32Array(d);to.DC(g,l.layerToChunkTransform,d+1,h,d);let m=a.updateViaRepresentativePoint(s,g,o);n.source.update(r,m)},e=>{n.source.commit(r),r.dispose()})}}),sv(t,"delete-annotation",()=>{let{mouseState:e}=this.viewer,t=e.pickedAnnotationId,i=e.pickedAnnotationLayer;if(void 0!==i&&!i.source.readonly&&void 0!==t){let e=i.source.getReference(t);try{i.source.delete(e)}finally{e.dispose()}}}),sv(t,"zoom-via-touchpinch",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.handleMouseMove(t.centerX,t.centerY);let i=t.prevDistance/t.distance;i>.1&&i<10&&this.zoomByMouse(i)})}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:i}=this,n=i.getBoundingClientRect(),r=e-(n.left+i.clientLeft),s=t-(n.top+i.clientTop),{mouseState:a}=this.viewer;a.pageX=e+window.scrollX,a.pageY=t+window.scrollY,a.setForcer(this.mouseStateForcer),this.updateMousePosition(r,s)}onMousemove(e,t=!0){let{element:i}=this;if(!t||e.target===i)this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||1!==e.targetTouches.length)return;let{clientX:i,clientY:n}=e.targetTouches[0];this.handleMouseMove(i,n)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:i}=this;for(let e of(-1!==i&&window.clearTimeout(i),this.pickRequests))t.deleteBuffer(e.buffer);super.disposed()}}let xy=[1.5,2,3,5,7.5,10];class xb{allowedSignificands=xy;targetLengthInPixels=0;physicalSizePerPixel=0;physicalBaseUnit;lengthInPixels;physicalLength;physicalUnit;prevPhysicalSizePerPixel=0;prevTargetLengthInPixels=0;prevPhysicalUnit="\0";update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let i=t*e,n=Math.floor(Math.log10(i)),r=10**n,s=i/r,a=1;for(let e of this.allowedSignificands)if(Math.abs(e-s)<Math.abs(a-s))a=e;else break;let o=a*r,l=tp(o);return this.lengthInPixels=Math.round(o/e),this.physicalUnit=`${l.prefix}${this.physicalBaseUnit}`,this.physicalLength=a*10**(n-l.exponent),!0}}class xS extends ef.gj{gl;dimensions;texture;width;height;label;factor;priorOptions;prevLabel;constructor(e,t=new xb){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){let{dimensions:t,label:i}=this,{texture:n}=this;if(!t.update()&&null!==n&&e===this.priorOptions&&i===this.prevLabel)return;null===n&&(n=this.texture=this.gl.createTexture());let{width:r,height:s}=function(e,t,i,n,r){var s,a,o;let l=document.createElement("canvas"),d=l.getContext("2d"),u=r.textHeightInPixels*r.scaleFactor,c=`bold ${u}px ${r.fontName}`;d.font=c,d.fillStyle="white";let h=`${n}${e.physicalLength} ${e.physicalUnit}`,p=d.measureText(h),g=Math.max(e.lengthInPixels,p.width),m=r.barHeightInPixels*r.scaleFactor,f=r.barTopMarginInPixels*r.scaleFactor,v=m+f+u,y=r.paddingInPixels*r.scaleFactor,b=v+2*y,S=g+2*y;return l.width=S,l.height=b,d.font=c,d.textAlign="center",d.fillStyle="rgba(0, 0, 0, 0.3)",d.fillRect(0,0,S,b),d.fillStyle="white",d.fillText(h,S/2,b-y-m-f),d.fillRect(y,b-y-m,e.lengthInPixels,m),s=t,a=i,o=l,s.activeTexture(WebGL2RenderingContext.TEXTURE0+s.tempTextureUnit),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,a),s.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),s.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),s.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),s.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),s.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),s.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),s.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,o),s.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),{width:S,height:b}}(t,this.gl,n,i,e);this.priorOptions=e,this.prevLabel=i,this.width=r,this.height=s}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class xw extends ef.gj{gl;scaleBarCopyHelper;scaleBars;constructor(e){super(),this.gl=e,this.scaleBars=[],this.scaleBarCopyHelper=this.registerDisposer(nB.get(this.gl));for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new xS(e)))}draw(e,t,i,n,r){let{scaleBars:s}=this,{displayRank:a,displayDimensionIndices:o,canonicalVoxelFactors:l,globalDimensionNames:d,displayDimensionUnits:u,displayDimensionScales:c}=t,{factors:h}=i,p=Math.min(r.maxWidthFraction*e.logicalWidth,r.maxWidthInPixels*r.scaleFactor),g=0;for(let e=0;e<a;++e){let t,i,r;let a=o[e],m=u[e],f=h[a];for(t=0;t<g&&((r=(i=s[t]).dimensions).physicalBaseUnit!==m||i.factor!==f);++t);t===g&&(++g,(i=s[t]).label="",r=i.dimensions,i.factor=f,r.physicalBaseUnit=m,r.targetLengthInPixels=p,r.physicalSizePerPixel=c[e]*n/l[e]),i.label+=`${d[a]} `}let{gl:m,scaleBarCopyHelper:f}=this,v=r.bottomPixelOffset*r.scaleFactor;for(let t=g-1;t>=0;--t){let i=s[t];1===g?i.label="":i.label+=": ",i.update(r),m.viewport(r.leftPixelOffset*r.scaleFactor-e.visibleLeftFraction*e.logicalWidth,v-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,i.width,i.height),f.draw(i.texture),v+=i.height+r.marginPixelsBetweenScaleBars*r.scaleFactor}}}let xC={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function xx(e){let t={...xC};for(let i of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])(0,eb.uq)(e,i,e=>{void 0!==e&&(t[i]=(0,eb.nH)(e))});return(0,eb.uq)(e,"fontName",e=>{void 0!==e&&(t.fontName=(0,eb.ZE)(e))}),t}class xE extends Z.TU{constructor(){super(xC,xx)}}let xT=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,xk=[`
float computeOITWeight(float alpha, float depth) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -depth * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,`
void emitAccumAndRevealage(vec4 accum, float revealage, highp uint pickId) {
  v4f_fragData0 = vec4(accum.rgb, revealage);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a, gl_FragCoord.z);
  vec4 accum = color * weight;
  emitAccumAndRevealage(accum, color.a, pickId);
}
`];function xD(e){e.addOutputBuffer("vec4","out_color",0),e.addOutputBuffer("highp vec4","out_z",1),e.addOutputBuffer("highp vec4","out_pickId",2),e.addFragmentCode(xT)}function xP(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(xk)}function xL(e){e.addOutputBuffer("vec4","out_color",0),e.addOutputBuffer("highp vec4","out_z",1),e.addOutputBuffer("highp vec4","out_intensity",2),e.addOutputBuffer("highp vec4","out_pickId",3),e.addFragmentCode(`
void emit(vec4 color, float depth, float intensity, highp uint pickId) {
  float pickIdFloat = float(pickId);
  float bufferDepth = 1.0 - depth;
  out_color = color;
  out_z = vec4(bufferDepth, bufferDepth, bufferDepth, 1.0);
  out_intensity = vec4(intensity, intensity, intensity, 1.0);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}`)}let xI=Q.R3.create(),xR=Q.vh.create(),xA=Q._E.create();function xM(e){e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}function xN(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(xk),e.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

emitAccumAndRevealage(accum, 1.0 - revealage, 0u);
`)}function xV(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(xk),e.setFragmentMain(`
vec4 color = getValue0();
float bufferDepth = getValue1().r;
float weight = computeOITWeight(color.a, 1.0 - bufferDepth);
vec4 accum = color * weight;
float revealage = color.a;

emitAccumAndRevealage(accum, revealage, 0u);
`)}function xO(e){e.addOutputBuffer("vec4","out_color",0),e.addOutputBuffer("highp vec4","out_z",1),e.addOutputBuffer("highp vec4","out_pickId",2),e.setFragmentMain(`
out_color = vec4(0.0);
out_z = getValue0();
out_pickId = getValue1();
`)}function x_(e){e.addOutputBuffer("highp vec4","out_z",0),e.addOutputBuffer("highp vec4","out_pickId",1),e.setFragmentMain(`
out_z = getValue0();
out_pickId = getValue2();
gl_FragDepth = getValue1().r;
`)}let xF=i5(iY);class xB extends xF{panel;sharedProjectionParameters;constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new ni(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class xU extends xv{projectionParameters;visibleLayerTracker;hasVolumeRendering=!1;get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}frameRateCalculator=new ix(6,8,8,60);isContinuousCameraMotionInProgress=!1;get shouldDownsample(){return this.viewer.enableAdaptiveDownsampling.value&&this.isContinuousCameraMotionInProgress&&this.hasVolumeRendering}sliceViews=this.registerDisposer(new nl((e,t,i)=>{e.registerDisposer(i),e.registerDisposer(i.visibility.add(this.visibility))}));axesLineHelper=this.registerDisposer(xr.get(this.gl));sliceViewRenderHelper=this.registerDisposer(l_.get(this.gl,xD));offscreenFramebuffer=this.registerDisposer(new nF(this.gl,{colorBuffers:[new nV(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new nV(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new nV(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new nM(this.gl)}));transparentConfiguration_;volumeRenderingConfiguration_;maxProjectionConfiguration_;maxProjectionPickConfiguration_;offscreenCopyHelper=this.registerDisposer(nB.get(this.gl));transparencyCopyHelper=this.registerDisposer(nB.get(this.gl,xM,2));transparentToTransparentCopyHelper=this.registerDisposer(nB.get(this.gl,xN,2));maxProjectionColorCopyHelper=this.registerDisposer(nB.get(this.gl,xV,2));maxProjectionPickCopyHelper=this.registerDisposer(nB.get(this.gl,xO,2));maxProjectionToPickCopyHelper=this.registerDisposer(nB.get(this.gl,x_,3));sharedObject;scaleBars=this.registerDisposer(new xw(this.gl));flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}constructor(e,t,i){super(e,t,i),this.projectionParameters=this.registerDisposer(new nt({navigationState:this.navigationState,update:(e,t)=>{let{invViewMatrix:i,projectionMat:n,logicalWidth:r,logicalHeight:s}=e,a=r/s,o=Math.PI/4,{relativeDepthRange:l}=t,d=t.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let e=Math.max(.1,1-l),t=1+l;Q._E.ortho(n,-a,a,-1,1,e,t)}else{let e=1/Math.tan(o/2),t=Math.max(.1,1-(l/=e)),i=1+l;d*=e,Q._E.perspective(n,o,a,t,i)}ik(e,n),t.pose.toMat4(i,d),Q._E.scale(i,i,Q.R3.set(xI,1,-1,-1)),Q._E.translate(i,i,Q.nn["2"]),iN(e)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let n=this.sharedObject=this.registerDisposer(new xB(this));if(n.RPC_TYPE_ID=xs.w,n.initializeCounterpart(i.rpc,{}),n.visibility.add(this.visibility),this.visibleLayerTracker=dj(this.viewer.layerManager,u2,this.viewer.visibleLayerRoles,this),this.registerDisposer(this.context.continuousCameraMotionFinished.add(()=>{this.isContinuousCameraMotionInProgress=!1,this.hasVolumeRendering&&(this.scheduleRedraw(),this.frameRateCalculator.resetForNewFrameSet())})),this.registerDisposer(this.context.continuousCameraMotionStarted.add(()=>{this.isContinuousCameraMotionInProgress=!0})),sv(t,"rotate-via-mouse-drag",e=>{sb(e.detail,(e,t,i)=>{this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateRelative(Q.nn["1"],t/4*Math.PI/180),this.navigationState.pose.rotateRelative(Q.nn["0"],-i/4*Math.PI/180)})}),sv(t,"rotate-in-plane-via-touchrotate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.navigationState.pose.rotateRelative(Q.nn["2"],t.angle-t.prevAngle)}),sv(t,"rotate-out-of-plane-via-touchtranslate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.navigationState.pose.rotateRelative(Q.nn["1"],t.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Q.nn["0"],-t.deltaY/4*Math.PI/180)}),i.showSliceViewsCheckbox){let e=this.registerDisposer(new nr(i.showSliceViews));e.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let t=document.createElement("label");t.className="perspective-panel-show-slice-views neuroglancer-noselect",t.appendChild(document.createTextNode("Sections")),t.appendChild(e.element),this.element.appendChild(t)}this.registerDisposer(i.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}translateByViewportPixels(e,t){let{viewProjectionMat:i,invViewProjectionMat:n,logicalWidth:r,logicalHeight:s}=this.projectionParameters.value,{pose:a}=this.viewer.navigationState;a.updateDisplayPosition(a=>{Q.R3.transformMat4(xI,a,i),xI[0]+=-2*e/r,xI[1]+=2*t/s,Q.R3.transformMat4(a,xI,n)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[e,t]of this.sliceViews)if((t||this.viewer.showSliceViews.value)&&!e.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(0===e||0===t)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:n}=this.visibleLayerTracker;for(let[e,t]of n)if(!e.isReady(i,t))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:i}}=this,n=t*i,r=new Float32Array(4*n);try{e.bindSingle(1),this.gl.readPixels(0,0,t,i,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,r)}finally{e.framebuffer.unbind()}let s=new Float32Array(n);for(let e=0;e<n;++e)s[e]=r[4*e];return s}issuePickRequest(e,t){let{offscreenFramebuffer:i}=this;i.readPixelFloat32IntoBuffer(1,e-5,t-5,0,xg,xg),i.readPixelFloat32IntoBuffer(2,e-5,t-5,16*xg*xg,xg,xg)}completePickRequest(e,t,i,n){let{mouseState:r}=this.viewer;r.pickedRenderLayer=null,xf(i,0,4,e,t,n.viewportWidth,n.viewportHeight);let s=xm.length;for(let a=0;a<s;++a){let s=xm[a],o=i[4*s];if(0===o)continue;let l=s%xg,d=(s-l)/xg,u=1-o;xI[0]=2*(e+l-5)/n.viewportWidth-1,xI[1]=2*(t+d-5)/n.viewportHeight-1,xI[2]=2*u-1,Q.R3.transformMat4(xI,xI,n.invTransform);let{position:c,unsnappedPosition:h}=r,{value:p}=this.navigationState.position,g=p.length;c.length!==g&&(c=r.position=new Float32Array(g)),h.length!==g&&(h=r.unsnappedPosition=new Float32Array(g)),c.set(p),r.coordinateSpace=this.navigationState.coordinateSpace.value;let m=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:f}=m;for(let e=0,t=f.length;e<t;++e)c[f[e]]=xI[e];h.set(c);let v=i[4*xg*xg+4*s];n.pickIDs.setMouseState(r,v),r.displayDimensions=m,r.setActive(!0);return}r.setActive(!1)}translateDataPointByViewportPixels(e,t,i,n){let{viewProjectionMat:r,invViewProjectionMat:s,width:a,height:o}=this.projectionParameters.value;return Q.R3.transformMat4(xI,t,r),xI[0]+=2*i/a,xI[1]+=-2*n/o,Q.R3.transformMat4(e,xI,s)}get transparentConfiguration(){let e=this.transparentConfiguration_;return void 0===e&&(e=this.transparentConfiguration_=this.registerDisposer(new nF(this.gl,{colorBuffers:n_(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}get volumeRenderingConfiguration(){let e=this.volumeRenderingConfiguration_;return void 0===e&&(e=this.volumeRenderingConfiguration_=this.registerDisposer(new nF(this.gl,{colorBuffers:n_(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:new nM(this.gl)}))),e}get maxProjectionConfiguration(){let e=this.maxProjectionConfiguration_;return void 0===e&&(e=this.maxProjectionConfiguration_=this.registerDisposer(new nF(this.gl,{colorBuffers:[new nV(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new nV(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new nV(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new nV(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new nM(this.gl)}))),e}get maxProjectionPickConfiguration(){let e=this.maxProjectionPickConfiguration_;return void 0===e&&(e=this.maxProjectionPickConfiguration_=this.registerDisposer(new nF(this.gl,{colorBuffers:n_(this.gl,2,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),depthBuffer:new nM(this.gl)}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:i}=this.renderViewport,n=this.viewer.showSliceViews.value;for(let[e,t]of this.sliceViews)(t||n)&&e.updateRendering();let r=this.gl,s=()=>{r.drawBuffers(this.offscreenFramebuffer.singleAttachmentList)},a=()=>{this.offscreenFramebuffer.bind(t,i)};a(),r.disable(r.SCISSOR_TEST),r.enable(WebGL2RenderingContext.STENCIL_TEST),r.stencilMask(0xffffffff),r.clearStencil(0),r.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),r.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let o=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(o[0],o[1],o[2],0),r.clear(r.DEPTH_BUFFER_BIT),r.clearBufferfv(WebGL2RenderingContext.COLOR,0,[o[0],o[1],o[2],0]),r.clearBufferfv(WebGL2RenderingContext.COLOR,1,Q.Dv),r.clearBufferfv(WebGL2RenderingContext.COLOR,2,Q.Dv),r.enable(r.DEPTH_TEST);let l=this.projectionParameters.value,d=Q.R3.create();Q.R3.transformQuat(d,Q.nn["2"],this.navigationState.pose.orientation.orientation),Q.R3.scale(d,d,-1);let u={wireFrame:this.viewer.wireFrame.value,projectionParameters:l,lightDirection:d,ambientLighting:.2,directionalLighting:.8,pickIDs:e.pickIDs,emitter:xD,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1,bindFramebuffer:a,frameNumber:this.context.frameNumber,sliceViewsPresent:this.sliceViews.size>0,isContinuousCameraMotionInProgress:this.isContinuousCameraMotionInProgress,force3DHistogramForAutoRange:this.context.force3DHistogramForAutoRange};Q._E.copy(e.invTransform,l.invViewProjectionMat);let{visibleLayers:c}=this.visibleLayerTracker,h=!1,p=!1,g=!1,m=!1;for(let[e,t]of c)e.isTransparent?(h=!0,e.isVolumeRendering&&(m=!0,p=p||!this.isContinuousCameraMotionInProgress||f0(e))):e.isAnnotation?g=!0:e.draw(u,t);if(this.hasVolumeRendering=m,this.drawSliceViews(u),g){for(let[e,t]of(r.enable(WebGL2RenderingContext.BLEND),r.depthFunc(WebGL2RenderingContext.LEQUAL),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),c))e.isAnnotation&&(e.base.state.displayState.disablePicking.value?(s(),e.draw(u,t),u.bindFramebuffer()):e.draw(u,t));r.depthFunc(WebGL2RenderingContext.LESS),r.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),h){let e=t,n=i;if(this.shouldDownsample){this.frameRateCalculator.setFrameDeltas(this.context.getLastFrameTimesInMs(this.frameRateCalculator.numberOfStoredFrameDeltas));let r=this.frameRateCalculator.calculateDownsamplingRate(iw.MEAN);if(r>1){let s=t/i;n=Math.round((e=Math.round(t/r))/s)}}let s=()=>{},o=()=>{},l=()=>{};if(this.hasVolumeRendering){u.maxProjectionEmit=xL;let{maxProjectionConfiguration:t}=this;s=()=>{t.bind(e,n)},r.depthMask(!0),s(),u.bindMaxProjectionBuffer=s,r.clearColor(0,0,0,0),r.clearDepth(0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT);let{maxProjectionPickConfiguration:i}=this;(o=()=>{i.bind(e,n)})(),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT),(l=()=>{this.volumeRenderingConfiguration.bind(e,n)})(),u.bindVolumeRenderingBuffer=l,r.clearDepth(1),r.clearColor(0,0,0,1),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT)}let{transparentConfiguration:d}=this;u.bindFramebuffer=()=>{d.bind(t,i)},u.bindFramebuffer(),r.depthMask(!1),r.enable(WebGL2RenderingContext.BLEND),r.clearColor(0,0,0,1),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),u.emitter=xP,r.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),u.emitPickID=!1;let h=0;for(let[e,t]of c)if(e.isVolumeRendering){u.depthBufferTexture=this.offscreenFramebuffer.colorBuffers[1].texture;let i=f0(e),n=!i&&!this.isContinuousCameraMotionInProgress&&!u.wireFrame;if(i?(r.depthMask(!0),r.disable(WebGL2RenderingContext.BLEND),r.depthFunc(WebGL2RenderingContext.GREATER),2!==h&&(u.emitter=xL,s())):(1!==h&&(u.emitter=xP,l()),r.disable(WebGL2RenderingContext.DEPTH_TEST),h=1),e.draw(u,t),r.enable(WebGL2RenderingContext.DEPTH_TEST),!n&&!i)continue;o(),this.maxProjectionToPickCopyHelper.draw(this.maxProjectionConfiguration.colorBuffers[1].texture,this.maxProjectionConfiguration.colorBuffers[2].texture,this.maxProjectionConfiguration.colorBuffers[3].texture),r.enable(WebGL2RenderingContext.BLEND),r.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),i&&(l(),r.depthMask(!1),r.disable(WebGL2RenderingContext.DEPTH_TEST),this.maxProjectionColorCopyHelper.draw(this.maxProjectionConfiguration.colorBuffers[0].texture,this.maxProjectionConfiguration.colorBuffers[1].texture)),s(),u.emitter=xL,r.depthMask(!0),r.clearColor(0,0,0,0),r.clearDepth(0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT),r.clearDepth(1),r.clearColor(0,0,0,1),r.depthMask(!1),r.enable(WebGL2RenderingContext.DEPTH_TEST),r.depthFunc(WebGL2RenderingContext.LESS),h=2}else e.isTransparent&&(0!==h&&(u.emitter=xP,u.bindFramebuffer()),h=0,e.draw(u,t));for(let[e,t]of(r.disable(WebGL2RenderingContext.DEPTH_TEST),m&&(u.bindFramebuffer(),this.transparentToTransparentCopyHelper.draw(this.volumeRenderingConfiguration.colorBuffers[0].texture,this.volumeRenderingConfiguration.colorBuffers[1].texture)),r.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.offscreenFramebuffer.bindSingle(0),this.transparencyCopyHelper.draw(d.colorBuffers[0].texture,d.colorBuffers[1].texture),r.depthMask(!0),r.disable(WebGL2RenderingContext.BLEND),r.enable(WebGL2RenderingContext.DEPTH_TEST),u.bindFramebuffer=a,a(),r.enable(WebGL2RenderingContext.STENCIL_TEST),r.drawBuffers([r.NONE,r.COLOR_ATTACHMENT1,r.COLOR_ATTACHMENT2]),u.emitter=xD,u.emitPickID=!0,u.emitColor=!1,r.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),r.stencilMask(2),p&&this.maxProjectionPickCopyHelper.draw(this.maxProjectionPickConfiguration.colorBuffers[0].texture,this.maxProjectionPickConfiguration.colorBuffers[1].texture),c)){if(!!e.isTransparent&&!!e.transparentPickEnabled&&!e.isVolumeRendering)e.draw(u,t)}for(let[e,t]of(r.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),r.stencilMask(0),c)){if(!!e.isTransparent&&!e.transparentPickEnabled)e.draw(u,t)}}if(r.stencilMask(0xffffffff),r.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){r.drawBuffers([r.COLOR_ATTACHMENT0]),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.enable(WebGL2RenderingContext.BLEND),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:e}=this,t=this.viewer.scaleBarOptions.value;e.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,t),r.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:i,ambientLighting:n,directionalLighting:r,projectionParameters:{viewProjectionMat:s}}=e,a=this.viewer.showSliceViews.value;for(let[e,o]of this.sliceViews){if(!o&&!a)continue;let{width:l,height:d,invViewMatrix:u,viewportNormalInCanonicalCoordinates:c}=e.projectionParameters.value;if(0===l||0===d||!e.valid)continue;let h=n+Math.abs(Q.R3.dot(i,c))*r;Q._E.identity(xA),xA[0]=l/2,xA[5]=-d/2,Q._E.multiply(xA,u,xA),Q._E.multiply(xA,s,xA);let p=this.viewer.crossSectionBackgroundColor.value;xR[0]=p[0],xR[1]=p[1],xR[2]=p[2],xR[3]=1,t.draw(e.offscreenFramebuffer.colorBuffers[0].texture,xA,Q.vh.fromValues(h,h,h,1),xR,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,i=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,{gl:n}=this;n.drawBuffers([n.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(xn(t,e*i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}function x$(e){e.addOutputBuffer("vec4","out_fragColor",0),e.addOutputBuffer("highp vec4","out_pickId",1),e.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function xG(e){e.addOutputBuffer("vec4","out_fragColor",null),e.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}let xz=Q.R3.create(),xj=Q.R3.create(),xW=Q.vh.create();class xq extends xv{sliceView;axesLineHelper;sliceViewRenderHelper;colorFactor;pickIDs;flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}visibleLayerTracker;get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}offscreenFramebuffer;offscreenCopyHelper;scaleBars;get navigationState(){return this.sliceView.navigationState}constructor(e,t,i,n){super(e,t,n),this.sliceView=i,this.axesLineHelper=this.registerDisposer(xr.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(l_.get(this.gl,xG)),this.colorFactor=Q.vh.fromValues(1,1,1,1),this.pickIDs=new xa,this.offscreenFramebuffer=this.registerDisposer(new nF(this.gl,{colorBuffers:[new nV(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new nV(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(nB.get(this.gl)),this.scaleBars=this.registerDisposer(new xw(this.gl)),n.wireFrame.changed.add(()=>this.scheduleRedraw()),sv(t,"rotate-via-mouse-drag",e=>{let{mouseState:t}=this.viewer;if(t.updateUnconditionally()){let i=Float32Array.from(t.position);sb(e.detail,(e,t,n)=>{this.context.flagContinuousCameraMotion();let{pose:r}=this.navigationState,s=Q.R3.transformQuat(xz,Q.nn["0"],r.orientation.orientation),a=Q.R3.transformQuat(xj,Q.nn["1"],r.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(a,-t/4*Math.PI/180,i),this.viewer.navigationState.pose.rotateAbsolute(s,-n/4*Math.PI/180,i)})}}),sv(t,"rotate-in-plane-via-touchrotate",e=>{let{detail:t}=e,{mouseState:i}=this.viewer;this.handleMouseMove(t.centerX,t.centerY),i.updateUnconditionally()&&(this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,t.angle-t.prevAngle,i.position))}),this.registerDisposer(i),this.visibleLayerTracker=dj(this.viewer.layerManager,lL,this.viewer.visibleLayerRoles,this),this.registerDisposer(n.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.visibility.add(this.visibility)),this.registerDisposer(i.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(n.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(n.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(n.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}translateByViewportPixels(e,t){let{pose:i}=this.viewer.navigationState;i.updateDisplayPosition(i=>{Q.R3.set(i,-e,-t,0),Q.R3.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,i,n){let r=this.sliceView.projectionParameters.value;return Q.R3.transformMat4(e,t,r.viewMatrix),Q.R3.set(e,e[0]+i,e[1]+n,e[2]),Q.R3.transformMat4(e,e,r.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[e,i]of this.visibleLayerTracker.visibleLayers)if(!e.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let i=t.projectionParameters.value,{width:n,height:r,invViewProjectionMat:s}=i;Q._E.copy(e.invTransform,s);let{gl:a}=this;this.offscreenFramebuffer.bind(n,r),a.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=this.viewer.crossSectionBackgroundColor.value;xW[0]=o[0],xW[1]=o[1],xW[2]=o[2],xW[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,Q.TL,this.colorFactor,xW,0,0,1,1);let{visibleLayers:l}=this.visibleLayerTracker,{pickIDs:d}=this;d.clear();let u=()=>{a.disable(WebGL2RenderingContext.SCISSOR_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.offscreenFramebuffer.bind(n,r)};u();let c={wireFrame:this.viewer.wireFrame.value,projectionParameters:i,pickIDs:d,emitter:x$,emitColor:!0,emitPickID:!0,sliceView:t,bindFramebuffer:u,frameNumber:this.context.frameNumber};for(let[e,t]of l)e.draw(c,t);if(a.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let e=Math.min(i.logicalWidth,i.logicalHeight)/4*1.5,{zoomFactor:{value:t}}=this.viewer.navigationState;this.axesLineHelper.draw((0,Q.ad)(xn(i,e*t)))}this.viewer.showScaleBar.value&&(a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(i,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),a.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:i}=this;i.readPixelFloat32IntoBuffer(1,e-5,t-5,0,xg,xg)}completePickRequest(e,t,i,n){let{mouseState:r}=this.viewer;r.pickedRenderLayer=null,xf(i,0,4,e,t,n.viewportWidth,n.viewportHeight);let{viewportWidth:s,viewportHeight:a}=n,o=xm.length,{value:l}=this.navigationState.position,d=l.length,u=this.navigationState.pose.displayDimensions.value,{displayRank:c,displayDimensionIndices:h}=u,p=(i,r,o)=>{let d=e+i,u=t+r;xz[0]=2*d/s-1,xz[1]=2*u/a-1,xz[2]=0,Q.R3.transformMat4(xz,xz,n.invTransform),o.set(l);for(let e=0;e<c;++e)o[h[e]]=xz[e]},{unsnappedPosition:g}=r;g.length!==d&&(g=r.unsnappedPosition=new Float32Array(d)),r.coordinateSpace=this.navigationState.coordinateSpace.value,r.displayDimensions=u,p(0,0,g);let m=(e,t,i)=>{let{position:n}=r;n.length!==d&&(n=r.position=new Float32Array(d)),p(e-5,t-5,n),this.pickIDs.setMouseState(r,i),r.setActive(!0)};for(let e=0;e<o;++e){let t=xm[e],n=i[4*e];if(0===n)continue;let r=t%xg,s=(t-r)/xg;m(r,s,n);return}m(5,5,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:i}=this,{width:n,height:r,invViewMatrix:s,displayDimensionRenderInfo:{displayDimensionIndices:a,displayRank:o}}=i.projectionParameters.value,{mouseX:l,mouseY:d}=this;l-=n/2,d-=r/2;let u=this.navigationState.position.value;for(let t=0;t<o;++t){let i=a[t],n=s[t]*l+s[4+t]*d;u[i]+=n*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}i("4226");let xH=["#f00","#0f0","#99f"],xJ=sh.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}}),xK=[e=>e.name,e=>e.scaleFactor];class xZ extends ef.gj{displayDimensionRenderInfo;zoom;depthRange;displayUnit;element;dimensionGridContainer;depthGridContainer;defaultCheckbox;dimensionElements;zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:i}=this,{relativeDisplayScales:n}=this,{displayDimensionIndices:r}=i.value,s=r[e];if(-1===s)return;let{factors:a}=n.value,o=new Float64Array(a);o[s]*=2**-t,n.setFactors(o)}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,i=e.map(e=>e.name.value),n=tK(i),{names:r}=this.displayDimensions.coordinateSpace.value,s=i.length;for(let a=0;a<s;++a){let s=n[a],o=i[a],l=-1;0===o.length?s=!0:-1===(l=r.indexOf(o))&&(s=!1);let d=e[a];d.name.dataset.isValid=s.toString(),d.container.dataset.isModified=(l!==t[a]).toString()}}scheduleUpdateView;get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}constructor(e,t,i,n="px"){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=i,this.displayUnit=n,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=Array.from([,,,],(e,t)=>{let i=document.createElement("div");i.classList.add("neuroglancer-display-dimensions-widget-dimension"),i.style.display="contents",sv(i,"adjust-via-wheel",e=>{let{deltaY:i}=e.detail;if(0!==i)this.zoomDimension(t,Math.sign(i))});let n=document.createElement("input");n.classList.add("neuroglancer-display-dimensions-widget-name"),n.title="Change display dimensions",n.spellcheck=!1,n.autocomplete="off",n.style.color=xH[t],n.style.gridColumn="1",n.style.gridRow=`${t+1}`,n.addEventListener("focus",()=>{n.select()}),i.appendChild(n);let r=document.createElement("span");r.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let s=document.createElement("input");s.spellcheck=!1,s.title="Change relative scale at which dimension is displayed",s.autocomplete="off",r.style.gridColumn="2",r.style.gridRow=`${t+1}`,s.addEventListener("focus",()=>{s.select()}),r.appendChild(s),i.appendChild(r);let a=document.createElement("span");a.classList.add("neuroglancer-display-dimensions-widget-scale"),a.style.gridColumn="3",a.style.gridRow=`${t+1}`,i.appendChild(a),this.dimensionGridContainer.appendChild(i);let o={name:n,container:i,scaleFactor:s,scale:a,scaleFactorModified:!1};for(let e of(n.addEventListener("input",()=>{sA(n),this.updateNameValidity()}),sv(n,"commit",()=>{this.updateNames()}),n.addEventListener("blur",e=>{let{relatedTarget:t}=e;if(!this.dimensionElements.some(e=>e.name===t))!this.updateNames()&&this.updateView()}),r.addEventListener("click",e=>{let{target:t}=e;t!==s&&(s.focus(),e.preventDefault())}),s.addEventListener("input",()=>{sA(s),o.scaleFactorModified=!0}),sv(s,"commit",()=>{this.updateScaleFactors()}),s.addEventListener("blur",()=>{!this.updateScaleFactors()&&this.updateView()}),xK))sv(e(o),"move-up",()=>{0!==t&&e(this.dimensionElements[t-1]).focus()}),sv(e(o),"move-down",()=>{2!==t&&e(this.dimensionElements[t+1]).focus()});return o}),this.scheduleUpdateView=(0,iS.H)(()=>this.updateView());let{element:r,dimensionGridContainer:s,defaultCheckbox:a}=this,o=document.createElement("label"),l=this.registerCancellable((0,ic.Z)(()=>{r.dataset.active="false"},2e3)),d=()=>{r.dataset.active="true",l()};this.registerDisposer(t.changed.add(d)),this.registerDisposer(e.relativeDisplayScales.changed.add(d)),this.registerDisposer(i.changed.add(d)),r.classList.add("neuroglancer-display-dimensions-widget"),r.appendChild(s),s.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),r.addEventListener("pointerleave",()=>{let e=document.activeElement;e instanceof HTMLElement&&r.contains(e)&&e.blur()}),a.type="checkbox",o.appendChild(a),o.appendChild(document.createTextNode("Default")),o.title="Display first 3 dimensions",o.classList.add("neuroglancer-display-dimensions-widget-default"),a.addEventListener("change",()=>{this.updateDefault()}),s.appendChild(o),this.registerDisposer(e),this.registerDisposer(i),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView)),this.registerDisposer(new aq(r,xJ)).allShortcutsAreGlobal=!0,this.registerDisposer(new sy(r,xJ)),sv(s,"cancel",()=>{this.updateView();let e=document.activeElement;e instanceof HTMLElement&&r.contains(e)&&e.blur()});let{depthGridContainer:u}=this;u.classList.add("neuroglancer-depth-range-widget-grid"),r.appendChild(u);let c=document.createElement("label"),h=document.createElement("input");h.type="checkbox",c.classList.add("neuroglancer-depth-range-relative-checkbox-label"),h.classList.add("neuroglancer-depth-range-relative-checkbox"),c.appendChild(h),c.appendChild(document.createTextNode("Zoom-relative")),h.addEventListener("change",()=>{let e=h.checked,t=this.depthRange.value;e!==t<0&&(t=e?-t/this.zoom.value:-t*this.zoom.value,this.depthRange.value=t)}),c.title="Depth range is multiplied by scale",r.appendChild(c),sv(u,"adjust-via-wheel",e=>{let{deltaY:t}=e.detail;if(0===t)return;let i=this.depthRange.value;this.depthRange.value=i*2**Math.sign(t)}),this.registerDisposer((0,Z.Uw)((e,t,{factors:i})=>{sI(u);let{displayRank:n,globalDimensionNames:r,displayDimensionIndices:s,displayDimensionUnits:a,displayDimensionScales:o,canonicalVoxelFactors:l}=t,d=[],c=()=>{h.checked=this.depthRange.value<0;let e=this.depthRange.value;for(let t of(e<0&&(e*=-this.zoom.value),d)){let{input:i}=t;i.value=tm(e*t.scale,t.unit,{precision:2,elide1:!1}),sA(i)}},p=e=>{let t=tf(e.input.value);if(void 0===t||t.unit!==e.unit)return!1;let i=t.scale/e.scale;return this.depthRange.value<0&&(i=-i/this.zoom.value),this.depthRange.value=i,!0};for(let e=0;e<n;++e){let t=s[e],n=r[t],h=a[e],g=i[t],m=d.find(e=>e.unit===h&&e.factor===g);if(void 0===m){let t=document.createElement("div");t.title="Visible depth range",t.style.display="contents",u.appendChild(t);let i=document.createElement("span");i.textContent="\xb1",t.appendChild(i);let n=document.createElement("input");n.spellcheck=!1,n.autocomplete="off",n.addEventListener("focus",()=>{n.select()}),sv(n,"commit",()=>{p(m)}),n.addEventListener("change",()=>{!p(m)&&c()}),n.addEventListener("input",()=>{sA(n)}),t.appendChild(n);let r=document.createElement("span");r.classList.add("neuroglancer-depth-range-widget-dimension-names"),t.appendChild(r),m={unit:h,factor:g,dimensionNames:[],input:n,label:r,scale:o[e]/l[e]},d.push(m)}m.dimensionNames.push(n)}for(let e of d)e.dimensionNames.length!==n&&(e.label.textContent=e.dimensionNames.join(" "));e.registerDisposer(sv(u,"cancel",()=>{c();let e=document.activeElement;e instanceof HTMLElement&&u.contains(e)&&e.blur()}));let g=e.registerCancellable((0,iS.H)(c));e.registerDisposer(this.depthRange.changed.add(g)),e.registerDisposer(this.zoom.changed.add(g)),c()},e,this.relativeDisplayScales)),this.updateView()}updateNames(){let e=this.dimensionElements.map(e=>e.name.value).filter(e=>e.length>0);if(!tJ(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(0===e.length)return t.reset(),!0;let i=new Int32Array(3);i.fill(-1);let{names:n}=t.coordinateSpace.value,r=e.length;for(let t=0;t<r;++t){let r=n.indexOf(e[t]);if(-1===r)return!1;i[t]=r}return!!(0,Y.cO)(i,t.value.displayDimensionIndices)||(t.setDimensionIndices(r,i),!0)}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:i,displayRank:n}=e.value,{factors:r}=t.value,{dimensionElements:s}=this,a=new Float64Array(r);for(let e=0;e<n;++e){let t=s[e];if(!t.scaleFactorModified)continue;let n=Number(t.scaleFactor.value),r=i[e];Number.isFinite(n)&&!(n<=0)&&(a[r]=n)}return!(0,Y.cO)(a,r)&&t.setFactors(a),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:i,canonicalVoxelFactors:n,displayDimensionUnits:r,displayDimensionScales:s,globalDimensionNames:a}=this.displayDimensionRenderInfo.value,{factors:o}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let l=this.zoom.value,d=i[0],u=!0;if(-1!==d){let e=r[0],t=o[d];for(let n=1;n<3;++n){let s=i[n];if(-1!==s&&(r[n]!==e||o[s]!==t)){u=!1;break}}}for(let t=0;t<3;++t){let d=i[t],c=e[t];if(c.name.dataset.isValid=void 0,c.container.dataset.isModified=(-1===d).toString(),-1===d)c.name.value="",c.scale.textContent="",c.scaleFactor.value="";else{c.name.value=a[d];let e=s[t]*l/n[t];if(0!==t&&u)c.scale.textContent="";else{let i=tm(e,r[t],{precision:2,elide1:!1});c.scale.textContent=`${i}/${this.displayUnit}`}c.scaleFactor.value=function(e){if(e<1||e>1024){let t=0|Math.log2(e),i=e/2**t;return`${uB(i,1)}p${t}`}return e.toString()}(o[d])}sA(c.name),sA(c.scaleFactor)}}disposed(){sR(this.element),super.disposed()}}let xY=new Map([["xy",void 0],["xz",Q.gf.rotateX(Q.gf.create(),Q.gf.create(),Math.PI/2)],["yz",Q.gf.rotateY(Q.gf.create(),Q.gf.create(),Math.PI/2)]]),xX=new Map([["4panel","◱"],["3d","◻"]]);function xQ(e,t){var i,n;let r;return i=e,r=void 0===(n=xY.get(t))?i.navigationState.addRef():new st(new r3(i.navigationState.pose.position.addRef(),i.navigationState.pose.displayDimensionRenderInfo.addRef(),rH.makeRelative(i.navigationState.pose.orientation,n)),i.navigationState.zoomFactor.addRef(),i.navigationState.depthRange.addRef()),new lN(i.chunkManager,i.layerManager,r,i.wireFrame)}function x0(e){return{crossSectionBackgroundColor:e.crossSectionBackgroundColor,perspectiveViewBackgroundColor:e.perspectiveViewBackgroundColor,selectionDetailsState:e.selectionDetailsState,mouseState:e.mouseState,layerManager:e.layerManager,showAxisLines:e.showAxisLines,wireFrame:e.wireFrame,enableAdaptiveDownsampling:e.enableAdaptiveDownsampling,visibleLayerRoles:e.visibleLayerRoles,selectedLayer:e.selectedLayer,visibility:e.visibility,scaleBarOptions:e.scaleBarOptions}}function x1(e){let{viewer:t}=e;return{...x0(t),navigationState:t.perspectiveNavigationState,inputEventMap:t.inputEventBindings.perspectiveView,orthographicProjection:e.specification.orthographicProjection,showScaleBar:t.showScaleBar,rpc:t.chunkManager.rpc}}function x2(e){return{...x0(e),navigationState:e.navigationState,inputEventMap:e.inputEventBindings.sliceView}}function x3(e,t){let{navigationState:i}=t;t.element.appendChild(e.registerDisposer(new xZ(i.pose.displayDimensionRenderInfo.addRef(),i.zoomFactor,i.depthRange.addRef(),t instanceof xq?"px":"vh")).element)}function x4(e,t,i){let n=document.createElement("div");n.className="neuroglancer-data-panel-layout-controls",e.registerDisposer(()=>sR(n));for(let n=0;n<2;++n){let r=i[Math.min(i.length-1,n)];e.registerDisposer(sv(t.element,0===n?"toggle-layout":"toggle-layout-alternative",t=>{e.container.name=r,t.stopPropagation()}))}for(let t of i){let i=document.createElement("button"),r=document.createElement("div");i.appendChild(r),r.textContent=xX.get(t),i.title=`Switch to ${t} layout.`,i.addEventListener("click",()=>{e.container.name=t}),n.appendChild(i)}t.element.appendChild(n)}function x6(e,t,i){let n=new Map;(()=>{let r=new Set;for(let s of i.values()){if(r.add(s),n.has(s))continue;let i=function(e,t){let i=new lN(e.chunkManager,e.layerManager,t.navigationState.addRef(),e.wireFrame),n=()=>{let{width:{value:e},height:{value:n}}=t;i.projectionParameters.setViewport({width:e,height:n,logicalWidth:e,logicalHeight:n,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return i.registerDisposer(t.width.changed.add(n)),i.registerDisposer(t.height.changed.add(n)),n(),i}(e,s);t.sliceViews.set(i,!0),n.set(s,i)}for(let[e,i]of n){if(!r.has(e))t.sliceViews.delete(i)}})()}class x5 extends ef.gj{container;rootElement;viewer;constructor(e,t,i,n){var r;super(),this.container=e,this.rootElement=t,this.viewer=i;let s=new Map([["xy",xQ(r=i,"xy")],["xz",xQ(r,"xz")],["yz",xQ(r,"yz")]]),{display:a}=i,o={...x1(e),showSliceViews:i.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},l={...x2(i),showScaleBar:i.showScaleBar},d={...x2(i),showScaleBar:new nn(!1,!1)},u=(e,t,i,n)=>{let r=this.registerDisposer(new xq(a,t,s.get(e),i));return n&&x3(this,r),x4(this,r,[e,`${e}-3d`]),r},c=[xe(1,xt("column",[xe(1,xt("row",[xe(1,e=>{u("xy",e,l,!0)}),xe(1,e=>{u("xz",e,d,!1)})])),xe(1,xt("row",[xe(1,e=>{let t=this.registerDisposer(new xU(a,e,o));for(let e of s.values())t.sliceViews.set(e.addRef(),!1);x3(this,t),x6(i,t,n),x4(this,t,["3d"])}),xe(1,e=>{u("yz",e,d,!1)})]))]))];xt("row",c)(t)}disposed(){sI(this.rootElement),super.disposed()}}class x8 extends ef.gj{container;rootElement;viewer;direction;constructor(e,t,i,n,r,s){super(),this.container=e,this.rootElement=t,this.viewer=i,this.direction=n;let a=xQ(i,r),{display:o}=i,l={...x1(e),showSliceViews:i.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},d={...x2(i),showScaleBar:i.showScaleBar};xe(1,xt(n,[xe(1,e=>{let t=this.registerDisposer(new xq(o,e,a,d));x3(this,t),x4(this,t,[r,"4panel"])}),xe(1,e=>{let t=this.registerDisposer(new xU(o,e,l));t.sliceViews.set(a.addRef(),!1),x6(i,t,s),x3(this,t),x4(this,t,["3d","4panel"])})]))(t)}disposed(){sI(this.rootElement),super.disposed()}}class x7 extends ef.gj{container;rootElement;viewer;constructor(e,t,i,n){super(),this.container=e,this.rootElement=t,this.viewer=i;let r=xQ(i,n),s={...x2(i),showScaleBar:i.showScaleBar};xt("row",[xe(1,e=>{let t=this.registerDisposer(new xq(i.display,e,r,s));x3(this,t),x4(this,t,["4panel",`${n}-3d`])})])(t)}disposed(){sI(this.rootElement),super.disposed()}}class x9 extends ef.gj{container;rootElement;viewer;constructor(e,t,i,n){super(),this.container=e,this.rootElement=t,this.viewer=i;let r={...x1(e),showSliceViews:new nn(!1,!1)};xt("row",[xe(1,e=>{let t=this.registerDisposer(new xU(i.display,e,r));x6(i,t,n),x3(this,t),x4(this,t,["4panel"])})])(t)}disposed(){sI(this.rootElement),super.disposed()}}let Ee=new Map([["4panel",{factory:(e,t,i,n)=>new x5(e,t,i,n)}],["3d",{factory:(e,t,i,n)=>new x9(e,t,i,n)}]]);for(let e of xY.keys()){Ee.set(e,{factory:(t,i,n)=>new x7(t,i,n,e)});let t=`${e}-3d`;xX.set(e,"◻"),xX.set(t,"◫"),Ee.set(t,{factory:(t,i,n,r)=>new x8(t,i,n,"row",e,r)})}function Et(e){let t=Ee.get(e);if(void 0===t)throw Error(`Invalid layout name: ${JSON.stringify(e)}.`);return t}function Ei(e){return Et(e),e}class En extends ef.gj{width=new Z.TU(1e3,eb.Sc);height=new Z.TU(1e3,eb.Sc);position;orientation;scale;navigationState;changed=new ez.K_;constructor(e){super(),this.position=new rq(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new rJ(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new r4(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new st(new r3(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){(0,eb.PT)(e),rT(e,"width",this.width),rT(e,"height",this.height),rT(e,"position",r6(this.position)),rT(e,"orientation",this.orientation),rT(e,"scale",this.scale),rT(e,"zoom",r6(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class Er extends nl{parentNavigationState;constructor(e){super((e,t)=>e.registerDisposer(e.registerDisposer(t).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){for(let t of((0,eb.PT)(e),Object.keys(e))){let i=new En(this.parentNavigationState);try{this.set(t,i.addRef()),i.restoreState(e[t])}finally{i.dispose()}}}reset(){this.clear()}toJSON(){if(0===this.size)return;let e={};for(let[t,i]of this)e[t]=i.toJSON();return e}}class Es extends ef.gj{changed=new ez.K_;type;crossSections;orthographicProjection=new nn(!1);constructor(e,t){super(),this.type=new Z.TU(t,Ei),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new Er(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),"string"==typeof e?this.type.restoreState(e):((0,eb.PT)(e),(0,eb.uq)(e,"type",e=>this.type.restoreState(e)),(0,eb.uq)(e,"orthographicProjection",e=>this.orthographicProjection.restoreState(e)),(0,eb.uq)(e,"crossSections",e=>void 0!==e&&this.crossSections.restoreState(e)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:i}=this,n=i.toJSON();return 0===t.size&&void 0===n?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:n}}}class Ea extends ef.gj{viewer;element;specification;layout;get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new Es(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let i=this.registerCancellable((0,ic.Z)(()=>this.updateLayout(),0));this.specification.type.changed.add(i),sv(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>i.flush())),i()}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;void 0!==e&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=Et(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}let Eo="undefined"!=typeof STATE_SERVERS&&Object.keys(STATE_SERVERS).length>0;class El extends ef.gj{element=document.createElement("div");button=sV({text:"Share",title:"Share State"});selectStateServerElement;constructor(e){if(super(),"undefined"==typeof STATE_SERVERS)throw Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");for(let[i,n]of(t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let i=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(e=>e.url).includes(i)&&(t.value=i)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value}),Object.entries(STATE_SERVERS))){let e=document.createElement("option");e.textContent=i,e.value=n.url,e.selected=!!n.default,t.appendChild(e)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,i=new URL(t).protocol,{url:n,credentialsProvider:r}=vO(t,yC);ai.forPromise(v_(r,n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())}).then(e=>e.json()).then(e=>{let t=new URL(e).protocol,n=e.substring(t.length),r=`${window.location.origin}/#!${i}${n}`;navigator.clipboard.writeText(r).then(()=>{ai.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{ai.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}function Ed(e){return e.startsWith("key")?e.substring(3):e.startsWith("digit")||e.startsWith("arrow")?e.substring(5):e}i("5941");let Eu={...dg,side:"left",row:1};class Ec{location=new dm(Eu);get changed(){return this.location.changed}toJSON(){return(0,eb.$Z)(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class Eh extends cW{bindings;toolBinder;scroll;constructor(e,t,i,n,r){super(e,t.location),this.bindings=i,this.toolBinder=r,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});let s=document.createElement("div");s.classList.add("neuroglancer-help-body");let{scroll:a}=this;a.classList.add("neuroglancer-help-scroll-container"),s.appendChild(a),this.addBody(s);let o=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(r.changed.add(o)),this.registerDisposer(n.layersChanged.add(o)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:i}=this;if(sI(e),"undefined"!=typeof NEUROGLANCER_BUILD_INFO){let t=document.createElement("h2");t.textContent="Build info";let i=document.createElement("div");i.classList.add("neuroglancer-build-info");let n=document.createElement("a"),{tag:r,url:s,timestamp:a}=NEUROGLANCER_BUILD_INFO;if(n.textContent=r,n.target="_blank",void 0!==s&&(n.href=s),e.appendChild(t),i.appendChild(n),void 0!==a){let e=document.createElement("div");e.classList.add("neuroglancer-build-timestamp");let t=Intl.DateTimeFormat("en",{hour12:!1,dateStyle:"medium",timeStyle:"long"}).format(new Date(a));e.textContent=`Built at ${t}`,i.append(e)}e.appendChild(i)}let n=new Map;function r(e,t){if(n.has(t))return;let i={label:e,entries:new Map};!function e(t,i){for(let n of t.parents)void 0!==n.label?r(n.label,n):e(n,i);for(let[e,n]of t.bindings.entries()){let t=e.indexOf(":"),r=e.substring(t+1);i.set(r,n.action)}}(t,i.entries),n.set(t,i)}for(let[e,i]of t)r(e,i);let s=(t,i)=>{let n=document.createElement("h2");for(let[r,s]of(n.textContent=t,e.appendChild(n),i)){let t=document.createElement("div");t.className="dt",t.textContent=r.split("+").map(Ed).join("+");let i=document.createElement("div");i.className="dd",i.textContent=s,e.appendChild(t),e.appendChild(i)}},a=new Map;for(let[e,t]of i.bindings)if(t.context instanceof dM){let i=a.get(t.context);void 0===i&&(i=[],a.set(t.context,i)),i.push([`shift+key${e.toLowerCase()}`,t.description])}let o=Array.from(a.entries());for(let[e,t]of(o.length>0&&(o[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),o.sort((e,t)=>e[0].managedLayer.nonArchivedLayerIndex-t[0].managedLayer.nonArchivedLayerIndex)),o))t.sort(),s(`Tool bindings for layer ${e.managedLayer.nonArchivedLayerIndex+1}: ${e.managedLayer.name}`,t);for(let e of n.values())s(e.label,e.entries)}}i("5256"),i("6866");class Ep extends ef.gj{element=document.createElement("div");menuDisposer;parentDisposers=new Map;disabledValue=!1;opened=new ez.K_;closed=new ez.K_;get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}constructor(e){super();let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),void 0!==e&&this.registerParent(e)}get open(){return void 0!==this.menuDisposer}registerParent(e){let{parentDisposers:t}=this;if(!t.has(e))t.set(e,(0,ef.H0)(e,"contextmenu",e=>{this.show(e),e.stopPropagation(),e.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,i=(0,ef.H0)(document,"mousedown",e=>{e.target instanceof Node&&!t.contains(e.target)&&this.hide()},!0),n=(0,ef.H0)(document,"keydown",e=>{"Escape"===e.code&&this.hide()},!0);this.opened.dispatch(),!function(e,t){e.style.display="block";let{offsetWidth:i,offsetHeight:n}=e,r=document.documentElement.clientWidth,s=document.documentElement.clientHeight,a=document.documentElement.scrollLeft+Math.min(r-i,t.clientX),o=document.documentElement.scrollTop+Math.min(s-n,t.clientY);e.style.left=a+"px",e.style.top=o+"px"}(t,e),this.menuDisposer=()=>{n(),i(),t.style.display="none"}}unregisterParent(e){let{parentDisposers:t}=this,i=t.get(e);void 0!==i&&(i(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),sR(this.element)}hide(){void 0!==this.menuDisposer&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}i("6549");let Eg="neuroglancer-layer\0";function Em(e,t){var i,n;let r;e.dataTransfer.setData(Eg+(i=JSON.stringify(t.layers.map(e=>({name:e.name,visible:e.visible}))),n=new TextEncoder().encode(i),Array.prototype.map.call(n,ee).join("")),JSON.stringify({layers:t.layers.map(e=>e.toJSON()),layout:t.layoutSpec})),void 0!==g&&g.disposer();let s=()=>{for(let e of(t.manager.unregisterDisposer(s),t.layers))e.dispose();t.manager.dispose(),g===r&&(g=void 0)};g=r={manager:t.manager.addRef(),layers:t.layers.map(e=>e.addRef()),layoutSpec:t.layoutSpec,isLayerListPanel:t.isLayerListPanel??!1,disposer:s}}function Ef(e="none"){if(void 0!==g){if("move"===e){let e=new Set(g.layers);g.manager.layerManager.filter(t=>!e.has(t))}g.disposer()}}function Ev(e){return function(e,t){for(let i of e){let e=function(e,t){if(!!e.startsWith(t))try{var i;let n=(i=e.substring(t.length),new TextDecoder().decode(function(e){if(!/^(?:[0-9a-fA-F]{2})*$/.test(e))throw Error("Invalid hex-encoded string");let t=e.length/2,i=new Uint8Array(t);for(let n=0;n<t;++n)i[n]=parseInt(e.substr(2*n,2),16);return i}(i)));return JSON.parse(n)}catch{return}}(i,t);if(void 0!==e)return{parameters:e,dragType:i}}}(e.dataTransfer.types,Eg)}function Ey(e){if(void 0!==g&&g.manager.rootLayers===e.rootLayers)return g}class Eb{dragType;targetIsLayerListPanel;sourceManager;sourceIsLayerListPanel;moveSupported;forceCopy;manager;layers;numSourceLayers;layoutSpec;initializeExternalLayers(e){let{dragType:t}=this;if(void 0!==t)try{let{layers:i,layout:n}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(i)||this.numSourceLayers!==i.length)throw Error("Invalid layer drop data");for(let[e,t]of(this.layoutSpec=n,this.layers))!function(e,t){try{dZ(e,t)}catch(e){new ai().setErrorMessage(e instanceof Error?e.message:""+e)}}(e,i[t])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,i=e.dataTransfer.dropEffect;for(let e of this.layers.keys()){let n=t;t&&!e.archived&&"copy"!==i&&this.sourceIsLayerListPanel&&(n=!1),(e.archived!==n||n&&e.visible)&&(e.archived=n,n&&(e.visible=!1),e.layerChanged.dispatch())}}get method(){if(void 0!==this.sourceManager)return this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link";return"copy"}compatibleWithMethod(e){return this.method===e||(!this.forceCopy||"copy"===e)&&!this.moveSupported&&"move"===e&&!0}}function ES(e,t,i,n){let r;let s=Ey(t),a=!1;return void 0===s?r="copy":n?(!s.isLayerListPanel&&(a=!0),r="link"):s.manager===t&&s.isLayerListPanel===i?(r="move",a=!0):i?r="none":(s.isLayerListPanel||(a=!0),r="link"),ab(e,r,a)}function Ew(e,t,i){let{forceCopy:n,newTarget:r,isLayerListPanel:s=!1}=i,a=Ey(t);if(!n&&void 0!==a){let e=!r&&a.manager===t&&(a.isLayerListPanel===s||a.isLayerListPanel),i=new Eb;return i.manager=t,i.numSourceLayers=a.layers.length,i.sourceManager=a.manager,i.targetIsLayerListPanel=s,i.sourceIsLayerListPanel=a.isLayerListPanel,i.moveSupported=e,i.layers=new Map,i.forceCopy=!1,i.layoutSpec=a.layoutSpec,e?a.layers.forEach((e,t)=>{i.layers.set(e,t)}):a.layers.forEach((e,n)=>{(r||!t.layerManager.has(e))&&i.layers.set(e.addRef(),n)}),i}let o=Ev(e);if(void 0!==o)try{let e=(0,eb.m7)(o.parameters,(e,i)=>{let n=(0,eb.uq)(e,"name",eb.ZE),r=(0,eb.uq)(e,"visible",eb.JG),a=new dN(n,t);return s&&(r=!1),a.visible=r,a.archived=s,[a,i]}),i=new Eb;return i.numSourceLayers=e.length,i.targetIsLayerListPanel=s,i.sourceIsLayerListPanel=!1,i.sourceManager=void 0,i.moveSupported=!1,i.forceCopy=void 0!==a,i.manager=t,i.dragType=o.dragType,i.layers=new Map(e),i}catch{}}function EC(e,t){return!e.moveSupported&&(e.manager.layerManager.filter(t=>!e.layers.has(t)),void 0!==t&&e.layers.has(t))}function Ex(e,t,i,n=!1){function r(t,r){let s=e.dropLayers,{dropEffect:a,dropEffectMessage:l}=r?ES(t,e.manager,n,!1):{dropEffect:o,dropEffectMessage:""};if(void 0===a)return;av(t,a);let d=!0;if(!(void 0!==s&&!s.compatibleWithMethod(a)&&(e.dropLayers=void 0,EC(s,i)))){if(void 0===s){if(void 0===(s=e.dropLayers=Ew(t,e.manager,{forceCopy:"copy"===a,newTarget:!1,isLayerListPanel:n})))return;d="move"===s.method}if(void 0!==i&&s.layers.has(i))return{dropLayers:s,dropEffect:a,dropEffectMessage:l};if(d){let t;let{layerManager:n}=e.manager,r=new Set,a=Number.POSITIVE_INFINITY,o=n.managedLayers=n.managedLayers.filter((e,t)=>!s.layers.has(e)||(a===Number.POSITIVE_INFINITY&&(a=t),r.add(e),!1));for(let e of(void 0!==i?(t=o.indexOf(i),a<=t&&++t):t=o.length,s.layers.keys()))!r.has(e)&&s.layers.delete(e);o.splice(t,0,...s.layers.keys()),n.layersChanged.dispatch()}else{let t;for(let n of(void 0!==i&&(t=e.manager.layerManager.managedLayers.indexOf(i)),s.layers.keys()))e.manager.add(n,t)}return{dropLayers:s,dropEffect:a,dropEffectMessage:l}}}t.addEventListener("dragenter",t=>{void 0!==r(t,!0)?t.preventDefault():ao(t,e.element,"drop")}),t.addEventListener("drop",t=>{t.preventDefault(),e.dragEnterCount=0,ao(t,e.element,"drop");let i=r(t,!1)?.dropLayers;if(e.dropLayers=void 0,void 0!==i){if(!i.initializeExternalLayers(t)){EC(i);return}i.updateArchiveStates(t),Ef("move"===i.method?void 0:t.dataTransfer.dropEffect)}}),t.addEventListener("dragover",t=>{let i=r(t,!0);if(void 0===i){ao(t,e.element,"drop");return}let{dropLayers:n,dropEffect:s,dropEffectMessage:a}=i,o=n.layers.size,l="",d=1===n.numSourceLayers?"":"s",u=n.numSourceLayers;if("none"===s)l=`Cannot link dragged layer${d} here`;else{let e=u===o?`${u}`:`${o}/${u}`;l=`Drop to ${s} ${e} layer${d}`}a&&(l+=` (${a})`),aa(t,e.element,"drop",l),t.preventDefault(),t.stopPropagation()})}function EE(e,t,i,n){t.draggable=!0,t.addEventListener("dragstart",r=>{aa(r,t,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),Em(r,{manager:e.manager,layers:[i],layoutSpec:n.getLayoutSpec(),isLayerListPanel:n.isLayerListPanel}),r.stopPropagation()}),t.addEventListener("dragend",e=>{ao(e,t,"drag"),Ef()})}function ET(e){e.element.addEventListener("dragenter",()=>{++e.dragEnterCount}),e.element.addEventListener("dragleave",t=>{if(0!=--e.dragEnterCount)return;ao(t,e.element,"drop");let{dropLayers:i}=e;void 0!==i&&(EC(i),e.manager.layerManager.layersChanged.dispatch(),e.dropLayers=void 0)})}class Ek extends ef.gj{layer;panel;element;layerNumberElement;labelElement;visibleProgress;prefetchProgress;labelElementText;valueElement;maxLength;prevValueText;constructor(e,t){super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";let{element:i,labelElement:n,layerNumberElement:r,valueElement:s,visibleProgress:a,prefetchProgress:o,labelElementText:l}=this;i.className="neuroglancer-layer-item neuroglancer-noselect",i.appendChild(a),i.appendChild(o),n.className="neuroglancer-layer-item-label",n.appendChild(l),this.registerDisposer(e.readyStateChanged.add(()=>{if(e.isReady()&&e.layer instanceof m5){let t=sV({text:"\uD83D\uDD58"});i.appendChild(t);let{segmentationGroupState:n}=e.layer.displayState,{timestamp:r,timestampOwner:s}=n.value,a=()=>{let i=[...s].filter(t=>t!==e.name);r.value&&(i.length?t.title=`${new Date(r.value)}.
Bound to layer(s): ${i.join(", ")}`:t.title=`${new Date(r.value)}.
Click to return to current form.`,t.classList.toggle("locked",i.length>0)),t.style.display=void 0===r.value?"none":"inherit"};a(),s.changed.add(()=>{a();let t=e.manager.layerManager.managedLayers.map(e=>e.name);for(let e of[...s].filter(e=>!t.includes(e)))s.delete(e)}),r.changed.add(()=>{a()}),t.addEventListener("click",t=>{if(t.stopPropagation(),n.value.canSetTimestamp(e.name))r.reset(),s.clear();else{let t=[...s].filter(t=>t!==e.name);ai.showTemporaryMessage(`Segmentation time bound to layer(s): ${t.join(", ")}`)}})}})),a.className="neuroglancer-layer-item-visible-progress",o.className="neuroglancer-layer-item-prefetch-progress",r.className="neuroglancer-layer-item-number",s.className="neuroglancer-layer-item-value";let d=document.createElement("div");d.className="neuroglancer-layer-item-value-container";let u=document.createElement("div");u.className="neuroglancer-layer-item-button-container";let c=ae();c.title="Remove layer from this layer group",c.addEventListener("click",e=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),e.stopPropagation()});let h=gA();h.title="Delete this layer",h.addEventListener("click",e=>{d9(this.layer),e.stopPropagation()}),i.appendChild(r),d.appendChild(s),d.appendChild(u),u.appendChild(c),u.appendChild(h),i.appendChild(n),i.appendChild(d);let p=this.registerDisposer(new a9(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1,velocity:e.localVelocity,getToolBinder:()=>e.layer?.toolBinder}));i.appendChild(p.element),p.element.addEventListener("click",e=>{e.stopPropagation()}),p.element.addEventListener("dblclick",e=>{e.stopPropagation()}),i.addEventListener("click",i=>{i.ctrlKey?t.selectedLayer.toggle(e):i.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),i.addEventListener("contextmenu",i=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,i.stopPropagation(),i.preventDefault()}),EE(t,i,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),Ex(this.panel,i,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let i=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(i+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),i+=", drag to move, shift+drag to copy",t.title=i}disposed(){this.element.remove(),super.disposed()}}class ED extends ef.gj{layerGroupViewer;getLayoutSpecForDrag;showLayerHoverValues;layerWidgets;element;layerUpdateNeeded;valueUpdateNeeded;dropZone;layerWidgetInsertionPoint;positionWidget;dropLayers;dragEnterCount;get layerManager(){return this.manager.layerManager}get manager(){return this.layerGroupViewer.layerSpecification}get display(){return this.layerGroupViewer.display}get selectedLayer(){return this.layerGroupViewer.selectedLayer}get viewerNavigationState(){return this.layerGroupViewer.viewerNavigationState}constructor(e,t,i){var n;super(),this.layerGroupViewer=e,this.getLayoutSpecForDrag=t,this.showLayerHoverValues=i,this.layerWidgets=new Map,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable((0,iS.H)(()=>this.update())),this.positionWidget=this.registerDisposer(new a9(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner,{velocity:this.viewerNavigationState.velocity.velocity,getToolBinder:()=>this.layerGroupViewer.toolBinder}));let{element:r,manager:s,selectedLayer:a}=this;r.className="neuroglancer-layer-panel",this.registerDisposer(s.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(s.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(a.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let o=sV({svg:gL,title:"Click to add layer, control+click/right click/⌘+click to add local annotation layer."});o.classList.add("neuroglancer-layer-add-button");let l=this.dropZone=document.createElement("div");l.className="neuroglancer-layer-panel-drop-zone";let d=e=>{if(e.ctrlKey||e.metaKey||"contextmenu"===e.type){let e=dY(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(e),this.selectedLayer.layer=e,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(o,"click",d),this.registerEventListener(o,"contextmenu",d),r.appendChild(o),r.appendChild(l),this.registerDisposer(((n=o).draggable=!0,(0,ef.H0)(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()}))),r.appendChild(this.positionWidget.element);let u=()=>{let e=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=e===rI.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(u)),u(),this.update(),this.updateChunkStatistics(),ET(this),Ex(this,l,void 0),this.registerDisposer(this.display.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(s.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable((0,iS.H)(()=>this.updateChunkStatistics()))))}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,sR(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){!this.valueUpdateNeeded&&(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}scheduleUpdate;update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),!1===this.showLayerHoverValues.value)return;let e=this.manager.layerSelectedValues;for(let[t,i]of this.layerWidgets){let n=t.layer,r="";if(null!==n){let t=e.get(n);if(void 0!==t){let{value:e}=t;void 0!==e&&(r=""+e)}}if(r!==i.prevValueText){if(i.prevValueText=r,r.length>i.maxLength){let e=i.maxLength=r.length;i.valueElement.style.width=`${e}ch`}i.valueElement.textContent=r}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let i=0,n=0,r=0,s=0,a=e.layer;if(null!==a)for(let{layerChunkProgressInfo:e}of a.renderLayers)i+=e.numVisibleChunksNeeded,n+=e.numVisibleChunksAvailable,r+=e.numPrefetchChunksNeeded,s+=e.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${n/Math.max(1,i)*100}%`,t.prefetchProgress.style.width=`${s/Math.max(1,r)*100}%`}}updateLayers(){if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,i=this.layerWidgetInsertionPoint.nextElementSibling;for(let n of(this.manager.rootLayers.updateNonArchivedLayerIndices(),this.manager.layerManager.managedLayers)){if(n.archived&&!this.dropLayers?.layers.has(n))continue;t.add(n);let r=this.layerWidgets.get(n),s=n.nonArchivedLayerIndex;void 0===r&&(r=new Ek(n,this),this.layerWidgets.set(n,r)),r.layerNumberElement.textContent=""+(1+s),r.update();let{element:a}=r;a!==i&&e.insertBefore(r.element,i),i=a.nextElementSibling}for(let[e,i]of this.layerWidgets)!t.has(e)&&(this.layerWidgets.delete(e),i.dispose())}addLayerMenu(){un(this.manager,this.selectedLayer)}}function EP(e,t){let i=(0,ef.H0)(e,"drop",e=>{if(e.preventDefault(),-1!==e.dataTransfer.types.indexOf(a2)){e.stopPropagation();let i=(0,eb.PT)(JSON.parse(e.dataTransfer.getData(a2))),n=(0,eb.uq)(i,"dimensions",t3),r=(0,eb.uq)(i,"position",e=>(0,eb.m7)(e,eb.jz));if(r.length!==n.length)throw Error("length mismatch between position and dimensions");let s=r.length,{coordinateSpace:{value:{names:a}},value:o}=t;for(let e=0;e<s;++e){let t=a.indexOf(n[e]);-1!==t&&(o[t]=r[e])}t.changed.dispatch()}}),n=e=>{-1!==e.dataTransfer.types.indexOf(a2)&&(e.dataTransfer.dropEffect="link",e.preventDefault(),e.stopPropagation())},r=(0,ef.H0)(e,"dragenter",n),s=(0,ef.H0)(e,"dragover",n);return()=>{r(),s(),i()}}let EL="neuroglancer-layer-group-viewer";function EI(e){return -1!==e.dataTransfer.types.indexOf(EL)}class ER extends ef.gj{position;velocity;relativeDisplayScales;displayDimensions;displayDimensionRenderInfo;crossSectionOrientation;crossSectionScale;projectionOrientation;projectionScale;crossSectionDepthRange;projectionDepthRange;navigationState;projectionNavigationState;constructor(e){super(),this.relativeDisplayScales=new rY(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new r2(e.navigationState.pose.displayDimensions.addRef()),this.position=new rq(e.navigationState.position.addRef()),this.velocity=this.registerDisposer(new r$(e.velocity,this.position.link)),this.crossSectionOrientation=new rJ(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new r0(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new r4(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new se(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new se(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new st(new r3(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new rJ(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new r4(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new st(new r3(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.velocity,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",r6(this.position)),e.add("velocity",this.velocity),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}class EA extends ef.gj{element;viewerState;layerSpecification;viewerNavigationState;get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get enableAdaptiveDownsampling(){return this.viewerState.enableAdaptiveDownsampling}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}layerPanel;layout;toolBinder;options;state;get changed(){return this.state.changed}constructor(e,t,i={}){super(),this.element=e,this.viewerState=t,this.state=new rk,this.options={showLayerPanel:new nn(!0),showViewerMenu:!1,showLayerHoverValues:new nn(!0),...i},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.toolBinder=this.registerDisposer(new aA(this,this.layerSpecification.root.toolBinder)),this.viewerNavigationState=this.registerDisposer(new ER(t)),this.viewerNavigationState.register(this.state),this.registerDisposer((0,Z.Uw)((e,t)=>{t===rI.UNLINKED&&e.registerDisposer(new rG(this.layerSpecification.root.display,this.viewerNavigationState.position.value,this.viewerNavigationState.velocity.velocity))},this.viewerNavigationState.position.link)),this.layerSpecification instanceof d0?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(e=>e.name),reset:()=>{throw Error("not implemented")},restoreState:()=>{throw Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new mT(e)),this.layout=this.registerDisposer(new Ea(this,"xy")),this.state.add("layout",this.layout),this.state.add("toolBindings",this.toolBinder),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(EP(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,ic.Z)(()=>this.updateUI(),0)))),this.makeUI()}bindAction(e,t){this.registerDisposer(sv(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),rT(e,"crossSectionZoom",r6(this.viewerNavigationState.crossSectionScale)),rT(e,"perspectiveZoom",r6(this.viewerNavigationState.projectionScale)),rT(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(void 0!==this.layerPanel&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&void 0===this.layerPanel){let t=this.layerPanel=new ED(this,()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(t.registerDisposer(function(e,t){let i=new Ep(e),n=i.element;n.classList.add("neuroglancer-layer-group-viewer-context-menu");let r=document.createElement("button");r.textContent="Remove layer group",n.appendChild(r),i.registerEventListener(r,"click",()=>{t.layerSpecification.layerManager.clear()});let{viewerNavigationState:s}=t;for(let[e,t]of[["Render scale factors",s.relativeDisplayScales.link],["Render dimensions",s.displayDimensions.link],["Position",s.position.link],["Cross-section orientation",s.crossSectionOrientation.link],["Cross-section zoom",s.crossSectionScale.link],["Cross-section depth range",s.crossSectionDepthRange.link],["3-D projection orientation",s.projectionOrientation.link],["3-D projection zoom",s.projectionScale.link],["3-D projection depth range",s.projectionDepthRange.link]]){let r=i.registerDisposer(new aX(t)),s=document.createElement("label");s.style.display="flex",s.style.flexDirection="row",s.style.whiteSpace="nowrap",s.textContent=e,s.appendChild(r.element),n.appendChild(s)}return i}(t.element,this)),t.element.title="Right click for options, drag to move/copy layer group."):t.element.title="Drag to move/copy layer group.","undefined"!=typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS&&!0===NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS){{let e=document.createElement("button");e.textContent="Clear segments",e.title='De-select all objects ("x")',e.addEventListener("click",e=>{sp(e,e,{action:"clear-segments"})}),t.element.appendChild(e)}for(let e of["3d","xy","xz","yz"]){let i=document.createElement("button");i.textContent=e,i.title=`Switch to ${e} layout`,i.addEventListener("click",()=>{let t;t=this.layout.name===e?"3d"!==e?`${e}-3d`:"4panel":e,this.layout.name=t}),t.element.appendChild(i)}}t.element.draggable=!0;let i=t.element;i.addEventListener("dragstart",e=>{aa(e,t.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),Em(e,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let i=()=>{m&&m.viewer===this&&(m=void 0),this.unregisterDisposer(i)};m={viewer:this,disposer:i},this.registerDisposer(i);let n=this.toJSON();n.layers=void 0,e.dataTransfer.setData(EL,JSON.stringify(n)),t.element.style.backgroundColor="black",setTimeout(()=>{t.element.style.backgroundColor=""},0)}),t.element.addEventListener("dragend",e=>{ao(e,i,"drag"),Ef(),void 0!==m&&m.viewer===this&&m.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){sI(this.element);let{layerPanel:e}=this;void 0!==e&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}i("4003");let EM=Symbol("layoutComponentContainer");class EN extends ef.gj{viewer;parent;changed;componentValue;unsetComponent(){let e=this.componentValue;void 0!==e&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}flex;setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof EA){let{layerManager:t}=e,i=e.registerCancellable((0,ic.Z)(()=>{0===t.managedLayers.length&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{0===t.managedLayers.length&&i()})),i()}else if(e instanceof EF){let t=e.registerCancellable((0,ic.Z)(()=>{let{length:t}=e;if(0===t&&void 0!==this.parent)this.dispose();else if(1===t){let t;let i=e.get(0).component;if(void 0===this.parent&&i instanceof EA){t=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let e=i.layerManager.managedLayers,n=new Set(e),{layerSpecification:r}=i;r.rootLayers.filter(e=>n.has(e)||e.archived);let s=[],{managedLayers:a}=r.rootLayers;for(let e=0,t=a.length;e<t;++e)n.has(a[e])&&s.push(e);for(let t=0,i=e.length;t<i;++t)a[s[t]]=e[t];r.rootLayers.layersChanged.dispatch()}else t=i.toJSON();this.setSpecification(t)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}element;constructor(e,t,i){super(),this.viewer=e,this.parent=i,this.changed=new ez.K_,this.flex=new Z.TU(1,eb.o7),this.element=document.createElement("div");let{element:n}=this;n.style.display="flex",n.style.flex="1",n.style.position="relative",n.style.alignItems="stretch",n[EM]=this,this.flex.changed.add(()=>{n.style.flexGrow=""+this.flex.value,this.changed.dispatch()}),this.setSpecification(t);let r=[],s=e=>{let t;let i=document.createElement("div");switch(i.className="neuroglancer-layout-split-drop-zone",i.style[e]="0",e){case"left":case"right":t="row",i.style.width="10px",i.style.height="100%";break;case"top":case"bottom":t="column",i.style.height="10px",i.style.width="100%"}i.style.display="none",r.push({element:i,direction:t,orientation:e}),n.appendChild(i),E_(i,this.viewer.layerSpecification,()=>this.split(e).newContainer.component,"row"===t?"column":"row")};s("left"),s("right"),s("top"),s("bottom");let a=!1;n.addEventListener("dragenter",e=>{if(!a&&void 0!==Ev(e))for(let{element:e,direction:t,orientation:n}of(a=!0,r)){if(void 0!==i&&t===i.direction&&(("left"===n||"top"===n)&&i.get(0)!==this||("bottom"===n||"right"===n)&&i.get(i.length-1)!==this))continue;let{component:r}=this;if(!(r instanceof EF)||r.direction!==t)e.style.display="block"}},!0),n.addEventListener("drop",e=>{if(!!a)for(let{element:e}of(a=!1,r))e.style.display="none"},!0),n.addEventListener("dragleave",e=>{let{relatedTarget:t}=e;if(!(!a||t instanceof HTMLElement&&this.element.contains(t)))for(let{element:e}of(a=!1,r))e.style.display="none"},!0)}toJSON(){let e=this.component.toJSON();return this.parent instanceof EF&&(e.flex=this.flex.toJSON()),e}setSpecification(e){this.setComponent(function(e,t){let i=document.createElement("div");if(i.style.flex="1",i.style.width="0px","string"==typeof t){if(void 0!==e.parent)throw Error(`Invalid layout component specification: ${JSON.stringify(t)}`);return new EO(i,t,e.viewer)}(0,eb.PT)(t);let n=(0,eb.uq)(t,"type",eb.ZE);switch(n){case"row":case"column":return new EF(i,n,(0,eb.uq)(t,"children",t=>{let i=(0,eb.m7)(t,e=>e);if(void 0===e.parent&&0===i.length)throw Error("Stack layout requires at least one child.");return i}),e);case"viewer":{let n=e.viewer,r=new d0(n.layerSpecification.addRef()),s=new EA(i,{display:n.display,layerSpecification:r,...EV(n)},{showLayerPanel:n.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:n.uiControlVisibility.showLayerHoverValues});try{s.restoreState(t)}catch(e){throw s.dispose(),e}return s}default:return new EO(i,t,e.viewer)}}(this,e)),this.flex.value=(0,eb.Kh)(e,"flex",eb.o7,1)}static getFromElement(e){return e[EM]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t,i,n;let r={type:"viewer"},{parent:s}=this;if(void 0!==s){if("left"===e&&"row"===s.direction||"top"===e&&"column"===s.direction)return{newContainer:s.insertChild(r,this),existingContainer:this};if("right"===e&&"row"===s.direction||"bottom"===e&&"column"===s.direction)return{newContainer:s.insertChild(r),existingContainer:this}}let a=this.component;t=a instanceof EO?a.layerGroupViewer.toJSON():a.toJSON();let o="left"===e||"right"===e?"row":"column";switch(e){case"left":case"top":i={type:o,children:[r,t]},n=0;break;case"right":case"bottom":i={type:o,children:[t,r]},n=1}this.setSpecification(i);let l=this.component;return{newContainer:l.get(n),existingContainer:l.get(1-n)}}}function EV(e){return{mouseState:e.mouseState,showAxisLines:e.showAxisLines,wireFrame:e.wireFrame,enableAdaptiveDownsampling:e.enableAdaptiveDownsampling,showScaleBar:e.showScaleBar,scaleBarOptions:e.scaleBarOptions,showPerspectiveSliceViews:e.showPerspectiveSliceViews,inputEventBindings:e.inputEventBindings,visibility:e.visibility,selectedLayer:e.selectedLayer,visibleLayerRoles:e.visibleLayerRoles,navigationState:e.navigationState.addRef(),perspectiveNavigationState:e.perspectiveNavigationState.addRef(),velocity:e.velocity.addRef(),crossSectionBackgroundColor:e.crossSectionBackgroundColor,perspectiveViewBackgroundColor:e.perspectiveViewBackgroundColor}}class EO extends ef.gj{element;layerGroupViewer;constructor(e,t,i){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new EA(e,{display:i.display,layerSpecification:i.layerSpecification.addRef(),...EV(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function E_(e,t,i,n){e.addEventListener("dragenter",t=>{if(void 0!==Ev(t))e.classList.add("neuroglancer-drag-over")}),e.addEventListener("dragleave",t=>{ao(t,e,"drop"),e.classList.remove("neuroglancer-drag-over")}),e.addEventListener("dragover",i=>{let r=(t,n)=>{t.dropEffectMessage&&(n+=` (${t.dropEffectMessage})`),aa(i,e,"drop",n),i.stopPropagation(),i.preventDefault()};if(EI(i)){let e=function(e,t){let i;let n=function(e){if(m&&m.viewer.layerSpecification.rootLayers===e.rootLayers)return m.viewer}(t),r=!1;return void 0===n||n.layerSpecification===n.layerSpecification.root?i="copy":(r=!0,i="move"),ab(e,i,r)}(i,t);av(i,e.dropEffect),r(e,`Drop to ${e.dropEffect} layer group as new ${n}`);return}if(void 0!==Ev(i)){let e=function(e,t,i,n){let r=ES(e,t,i,n);return av(e,r.dropEffect),r}(i,t,!1,!0);r(e,`Drop to ${e.dropEffect} layer as new ${n}`);return}}),e.addEventListener("drop",n=>{let r,s;if(e.classList.remove("neuroglancer-drag-over"),ao(n,e,"drop"),EI(n)){n.stopPropagation();try{s=JSON.parse(n.dataTransfer.getData(EL))}catch{return}if(void 0===(r=Ew(n,t,{forceCopy:!1,newTarget:!0})))return}else{if(void 0===(r=Ew(n,t,{forceCopy:"copy"===o,newTarget:!0})))return;s=r.layoutSpec}if(!r.initializeExternalLayers(n)){if(!r.moveSupported)for(let e of r.layers.keys())e.dispose();return}n.preventDefault(),Ef(n.dataTransfer.dropEffect=o);let a=i();for(let e of(r.updateArchiveStates(n),r.layers.keys()))a.layerSpecification.add(e);try{a.restoreState(s)}catch{a.layout.reset()}})}class EF extends ef.gj{element;direction;container;changed;get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",E_(t,this.viewer.layerSpecification,()=>{let e;let i=t.nextElementSibling;return null!==i&&(e=EN.getFromElement(i)),this.insertChild({type:"viewer",layers:[]},e).component},"row"===this.direction?"column":"row"),e.registerDisposer(()=>{sR(t)}),t.addEventListener("pointerdown",e=>{if("button"in e&&0!==e.button)return;let i=t.nextElementSibling;if(null===i)return;let n=EN.getFromElement(i),r=t.previousElementSibling;if(null===r)return;let s=EN.getFromElement(r);e.preventDefault();let a=()=>{aa(e,t,"drag",`Drag to resize, current ${cU[this.direction]} ratio is ${s.flex.value} : ${n.flex.value}`)};a(),sb(e,e=>{let t=s.element.getBoundingClientRect(),i=n.element.getBoundingClientRect(),r=Math.max(.1,Math.min(.9,"column"===this.direction?(e.clientY-t.top)/(i.bottom-t.top):(e.clientX-t.left)/(i.right-t.left))),o=Number(s.flex.value)+Number(n.flex.value);s.flex.value=Math.round(r*o*100)/100,n.flex.value=Math.round((1-r)*o*100)/100,a()},e=>{ao(e,t,"drag")})}),t}get viewer(){return this.container.viewer}constructor(e,t,i,n){for(let r of(super(),this.element=e,this.direction=t,this.container=n,this.changed=new ez.K_,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this)),i))this.insertChild(r)}get(e){return EN.getFromElement(this.element.children[2*e+1])}insertChild(e,t){let i=new EN(this.viewer,e,this),n=this.makeDropPlaceholder(i);i.element.classList.add("neuroglancer-stack-layout-child"),i.registerDisposer(i.changed.add(this.changed.dispatch)),i.registerDisposer(()=>{this.element.removeChild(i.element),this.changed.dispatch()});let r=void 0!==t?t.element:null;return this.element.insertBefore(i.element,r),this.element.insertBefore(n,r),this.changed.dispatch(),i}disposed(){this.clear(),super.disposed()}clear(){for(;0!==this.length;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}}class EB extends ef.gj{viewer;defaultSpecification;container;get changed(){return this.container.changed}get element(){return this.container.element}constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new EN(e,t,void 0))}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}i("7422");var EU=i("7597");i("8263");var E$=i("2491");let EG=sh.fromObject({escape:{action:"cancel"}});class Ez extends ef.gj{layer;element;constructor(e){super(),this.layer=e,this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off",this.registerDisposer(new aq(t,EG)).allShortcutsAreGlobal=!0,sv(t,"cancel",e=>{this.updateView(),t.blur(),e.stopPropagation(),e.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){d7(this.layer,this.element.value)}}class Ej extends ef.gj{layer;element;measureElement;constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");let{element:t,measureElement:i}=this;for(let[e,n]of(t.classList.add("neuroglancer-layer-side-panel-type"),i.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(i),d1)){if(n.type!==e)continue;let i=document.createElement("option");i.textContent=n.typeAbbreviation,i.value=e,t.appendChild(i)}t.addEventListener("change",()=>{let e=t.value,i=d1.get(e);d8(this.layer.managedLayer,i)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:i}=this;i.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${i.offsetWidth}px`}disposed(){this.measureElement.remove()}}class EW extends cW{panelState;tabView;layer;constructor(e,t){super(e,t.location),this.panelState=t;let i=this.layer=t.layer,{element:n}=this,{titleBar:r}=this.addTitleBar({});r.classList.add("neuroglancer-layer-side-panel-title"),r.appendChild(this.registerDisposer(new Ej(i)).element),r.appendChild(this.registerDisposer(new Ez(i.managedLayer)).element),this.registerDisposer((0,Z.Jk)(e=>{n.dataset.neuroglancerLayerVisible=e.toString()},{get value(){return i.managedLayer.visible},changed:i.managedLayer.layerChanged}));let s=this.registerDisposer(new aH({get value(){return i.managedLayer.pickEnabled},set value(value){i.managedLayer.pickEnabled=value},changed:i.managedLayer.layerChanged},{svg:E$,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new ns({get value(){return i.managedLayer.supportsPickOption},changed:i.managedLayer.layerChanged},s.element)),r.appendChild(s.element);let a={get value(){return t!==i.panels.panels[0]},set value(value){value?t.pin():t.unpin()},changed:i.manager.root.layerManager.layersChanged};r.appendChild(this.registerDisposer(new aH(a,{text:"\uD83D\uDCCC︎",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer((0,Z.Jk)(e=>{n.dataset.neuroglancerLayerPanelPinned=e.toString()},a)),r.appendChild(gA({title:"Delete layer",onClick:()=>{d9(this.layer.managedLayer)}})),this.tabView=new s$({makeTab:e=>i.tabs.options.get(e).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new Z.mJ({get value(){return t.tabs.map(e=>{let{label:t,hidden:n}=i.tabs.options.get(e);return{id:e,label:t,hidden:n?.value||!1}})},changed:t.tabsChanged})),handleTabElement:(e,n)=>{n.draggable=!0,n.addEventListener("dragstart",r=>{let s="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(e=>e!==t&&e.location.visible)&&(s+=`, or move tab to other ${JSON.stringify(i.managedLayer.name)} panel`),aa(r,n,"drag",s),this.sidePanelManager.startDrag({dropAsNewPanel:t=>{this.panelState.splitOffTab(e,{...db,...t})},getNewPanelDropEffect:()=>({description:"tab",dropEffect:"move"}),canDropAsTabs:e=>e instanceof EW&&e.layer===this.layer&&e!==this?1:0,dropAsTab:t=>{this.panelState.moveTabTo(e,t.panelState)}},r)}),n.addEventListener("dragend",e=>{ao(e,n,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{0===t.tabs.length&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof EW&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{let{dragSource:i}=this.sidePanelManager,n=i?.canDropAsTabs?.(this);n&&(e.classList.add(cV),aa(t,e,"drop",`Move ${n} ${1===n?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",t=>{ao(t,e,"drop"),e.classList.remove(cV)}),e.addEventListener("dragover",e=>{let{dragSource:t}=this.sidePanelManager;t?.canDropAsTabs?.(this)&&e.preventDefault()}),e.addEventListener("drop",t=>{ao(t,e,"drop");let{dragSource:i}=this.sidePanelManager;i?.canDropAsTabs?.(this)&&(e.classList.remove(cV),i.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class Eq extends ef.gj{sidePanelManager;selectedLayerState;placeholderSelectedLayerPanel;layerSidePanels;generation;layersNeedUpdate;constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new Map,this.generation=0,this.layersNeedUpdate=!0;let i=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(i)),this.registerDisposer(t.layerManager.layersChanged.add(i)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){return this.selectedLayerState.layer?.layer??void 0}update(){if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:i}=this,n=e=>{let n=i.get(e);void 0===n?(n={generation:t,unregister:this.sidePanelManager.registerPanel({location:e.location,makePanel:()=>new EW(this.sidePanelManager,e)})},i.set(e,n)):n.generation=t};{let e=this.getSelectedUserLayer(),{location:t}=this.selectedLayerState;if(void 0!==e&&t.visible){this.placeholderSelectedLayerPanel?.(),this.placeholderSelectedLayerPanel=void 0;let i=e.panels.panels[0];i.location.value=t.value,n(i)}else void 0===this.placeholderSelectedLayerPanel&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:t,makePanel:()=>new cW(this.sidePanelManager,t)}))}for(let t of e.managedLayers){let e=t.layer;if(null===e)continue;let{panels:i}=e.panels;for(let e=1,t=i.length;e<t;++e)n(i[e])}for(let[e,n]of i)n.generation!==t&&(n.unregister(),i.delete(e))}disposed(){for(let{unregister:e}of(this.placeholderSelectedLayerPanel?.(),this.layerSidePanels.values()))e()}}let EH={...dg,side:"left",row:0};class EJ{location=new dm(EH);get changed(){return this.location.changed}restoreState(e){void 0!==e&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return(0,eb.$Z)(this.location.toJSON())}}class EK extends ef.gj{layer;element;constructor(e){super(),this.layer=e,this.element=document.createElement("div");let{element:t}=this,i=sV({svg:EU,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),n=sV({svg:cZ,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(n),t.appendChild(i);let r=()=>{let e=this.layer.visible;i.style.display=e?"":"none",n.style.display=e?"none":""};r(),this.registerDisposer(e.layerChanged.add(r))}}class EZ extends ef.gj{panel;layer;element;numberElement;generation;constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;let{element:i,numberElement:n}=this;i.classList.add("neuroglancer-layer-list-panel-item"),n.classList.add("neuroglancer-layer-list-panel-item-number"),i.appendChild(this.registerDisposer(new nr({get value(){return!t.archived},set value(value){t.setArchived(!value)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),i.appendChild(n),i.appendChild(this.registerDisposer(new EK(t)).element),i.appendChild(this.registerDisposer(new Ez(t)).element),i.appendChild(this.registerDisposer(function(e){let{selectedLayer:t}=e.manager.root,i=new aH({get value(){return t.layer===e&&t.visible},set value(value){value?(t.layer=e,t.visible=!0):t.visible=!1},changed:t.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:C5});return i.element.classList.add("neuroglancer-layer-list-panel-item-controls"),i}(t)).element);let r=gA({title:"Delete layer",onClick:()=>{d9(this.layer)}});r.classList.add("neuroglancer-layer-list-panel-item-delete"),i.appendChild(r),EE(e,i,t,{isLayerListPanel:!0,getLayoutSpec:()=>void 0}),Ex(e,i,t,!0),i.addEventListener("click",i=>{i.ctrlKey?(e.selectedLayer.toggle(t),i.preventDefault()):i.altKey&&(t.pickEnabled=!t.pickEnabled,i.preventDefault())}),i.addEventListener("contextmenu",i=>{e.selectedLayer.toggle(t),i.stopPropagation(),i.preventDefault()})}}class EY extends cW{manager;state;items;itemContainer;layerDropZone;titleElement;get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}dropLayers;dragEnterCount;generation;constructor(e,t,i){super(e,i.location),this.manager=t,this.state=i,this.items=new Map,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;let{itemContainer:n,layerDropZone:r}=this,{titleElement:s}=this.addTitleBar({title:""});this.titleElement=s,n.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(n),r.style.flex="1";let a=this.registerCancellable((0,iS.H)(()=>this.render()));this.visibility.changed.add(a),this.registerDisposer(this.layerManager.layersChanged.add(a)),this.registerDisposer(this.selectedLayer.changed.add(a)),ET(this),Ex(this,r,void 0,!0),this.render()}render(){let e=this,t=this.selectedLayer.layer,i=++this.generation,n=0,r=0,s=0;this.layerManager.updateNonArchivedLayerIndices();sM(this.itemContainer,function*(){let{items:a}=e,o=0;for(let t of e.layerManager.managedLayers)!t.archived&&++o;let l=`${(o+1).toString().length}ch`;for(let o of e.layerManager.managedLayers){o.visible?++n:o.archived?++s:++r;let d=a.get(o);void 0===d&&(d=e.registerDisposer(new EZ(e,o)),a.set(o,d)),d.generation=i;let{nonArchivedLayerIndex:u}=o;d.numberElement.style.width=l,-1===u?d.numberElement.style.visibility="hidden":(d.numberElement.style.visibility="",d.numberElement.textContent=`${u+1}`),d.element.dataset.selected=(o===t).toString(),d.element.dataset.archived=o.archived.toString(),yield d.element}for(let[t,n]of a)i!==n.generation&&(a.delete(t),e.unregisterDisposer(n),n.dispose());yield e.layerDropZone}());let a="Layers";if(n||r||s){a+=" (";let e="";n+r&&(a+=`${n}/${r+n} visible`,e=", "),s&&(a+=`${e}${s} archived`),a+=")"}this.titleElement.textContent=a}}class EX extends ef.gj{layerManager;element;constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");let t=this.registerCancellable((0,iS.H)(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:i}=this;if(0!==e){let n=t.length;i.textContent=`${n-e}/${n}`}else i.textContent=""}}i("6876"),i("8657"),i("3195"),i("5688"),i("4886"),i("7980");class EQ extends mP{viewer;textEditor;applyButton;downloadButton;closeButton;constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=(0,ic.Z)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(r){this.parsedValue=null,this.applyButton.disabled=!0;let t=0,i=0,n="Unknown parse error";if(r instanceof Error){let s=r.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(null!==s){n=s[1];let r=parseInt(s[2],10),a=e.substring(0,r).split("\n");t=a.length-1,i=a[a.length-1].length}else n=r.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:n,severity:"error",from:mN().Pos(t,i)}]})}},100),this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;let i=this.closeButton=document.createElement("button");i.classList.add("close-button"),i.textContent="Close",this.content.appendChild(i),i.addEventListener("click",()=>this.dispose());let n=this.downloadButton=document.createElement("button");n.textContent="Download",n.title="Download state as a JSON file",this.content.appendChild(n),n.addEventListener("click",()=>this.downloadState()),this.textEditor=mN()(e=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){let e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),i=URL.createObjectURL(t);e.href=i,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){null!==this.parsedValue&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}parsedValue;debouncedValueUpdater;getJson(){return JSON.stringify(rP(this.viewer.state).value,null,"  ")}}i("3938");let E0={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class E1{get changed(){return this.location.changed}location=new dm(E0);sortBy;restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return(0,eb.$Z)(this.location.toJSON())}}function E2(e){let t=new Map;return!function e(i,n){if(null==i||"object"!=typeof i){t.set(n,""+i);return}for(let t of Object.keys(i))e(i[t],n+"."+t)}(e,""),t}let E3=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:e=>{let t=0;for(let i=0;i<8;++i)t+=e[(3*i+ip.VISIBLE)*3+im.numChunks];return t}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:e=>{var t;return e[t=ih.DOWNLOADING,(3*t+ip.VISIBLE)*3+im.numChunks]}},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:e=>{var t,i;return e[t=ih.SYSTEM_MEMORY,(3*t+ip.VISIBLE)*3+im.numChunks]+e[i=ih.SYSTEM_MEMORY_WORKER,(3*i+ip.VISIBLE)*3+im.numChunks]}},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:e=>{var t;return e[t=ih.GPU_MEMORY,(3*t+ip.VISIBLE)*3+im.numChunks]}},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:e=>{var t;return e[t=ih.FAILED,(3*t+ip.VISIBLE)*3+im.numChunks]}},{label:"Visible memory",key:"visibleGpuMemory",getter:e=>{var t;return e[t=ih.GPU_MEMORY,(3*t+ip.VISIBLE)*3+im.gpuMemoryBytes]}},{label:"Download latency",key:"downloadLatency",getter:e=>e[72+ig.totalTime]/e[72+ig.totalChunks]}];class E4 extends cW{chunkQueueManager;displayState;data;requestDataTimerId;dataRequested;body;constructor(e,t,i){super(e,i.location),this.chunkQueueManager=t,this.displayState=i,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable((0,ic.Z)(()=>this.updateView(),0));let{body:n}=this;n.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(n),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(e=>{this.dataRequested=!1,this.data=e,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},1e3)})}debouncedUpdateView;updateView(){let{data:e}=this;if(void 0===e)return;let t=document.createElement("table"),i=[];for(let[t,n]of e){let e=[t];for(let{getter:t}of E3)e.push(t(n));i.push(e)}let n=function(e){let t=e.map(E2),i=function(e){let t=new Set;t.add(".type");let i=new Set;for(let n=0,r=e.length;n<r;++n){for(let t of e[n].keys())i.add(t);let r=[];for(let i=0;i<n;++i)!function(i,n){for(let r of t)if(e[i].get(r)!==e[n].get(r))return!0;return!1}(n,i)&&r.push(i);for(;r.length>0;){let s,a=r;for(let o of i){if(t.has(o))continue;let i=[];for(let t of r)e[t].get(o)===e[n].get(o)&&i.push(t);if(i.length<a.length&&(a=i,s=o),0===i.length)break}if(void 0===s)break;r=a,t.add(s)}}return Array.from(t)}(t);return t.map(e=>(function(e,t){let i={};for(let n of t){let t=e.get(n);if(void 0!==t){if(""===n)return t;i[n]=t}}return JSON.stringify(i)})(e,i))}(i.map(e=>{var t;return Object.assign({type:(t=e[0]).RPC_TYPE_ID},t.key||{})})),r=new Map;n.forEach((e,t)=>{r.set(i[t][0],e)});{let e,i=document.createElement("thead"),n=document.createElement("tr");i.appendChild(n);let r=e=>{let t=document.createElement("td");t.textContent=e,n.appendChild(t)};r("Name");for(let{label:t}of E3){let i=t.indexOf("/"),s=t;if(-1!==i){if((s=t.substring(0,i))===e){++n.lastElementChild.colSpan;continue}e=s}r(s)}n=document.createElement("tr"),i.appendChild(n);{let e=document.createElement("td");n.appendChild(e)}for(let{label:e}of E3){let t=e.indexOf("/"),i="";-1!==t&&(i=e.substring(t+1));let r=document.createElement("td");r.textContent=i,n.appendChild(r)}t.appendChild(i)}let s=document.createElement("tbody");for(let[e,...t]of i){let i=document.createElement("tr"),n=e=>{let t=document.createElement("td");t.textContent=e,i.appendChild(t)};for(let i of(n(r.get(e)),t))n(""+i);s.appendChild(i)}t.appendChild(s),sI(this.body),this.body.appendChild(t)}}i("3278");var E6=i("2384"),E5=i("9045");let E8={...dg,side:"right",row:0,visible:!0};function E7(e,t){(0,eb.PT)(t);let i=(0,eb.Kh)(t,"layer",eb.ZE);if(void 0===i)return aT(e,t);{let{layer:n,...r}=t,s=e.layerManager.getLayerByName(i);if(void 0===s)return;let a=s.layer;if(null===a)return;return aT(a,r)}}class E9 extends ef.gj{viewer;tools;changed;constructor(e){super(),this.viewer=e,this.tools=[],this.changed=new ez.K_}get value(){return this.tools}reset(){let{tools:e}=this;if(0!==e.length){for(let t of e)t.dispose();e.length=0,this.changed.dispatch()}}makeTool(e){let t=E7(this.viewer,e);if(void 0!==t)return this.initializeTool(t),t}initializeTool(e){e.unbound.add(()=>{this.remove(e)})}restoreState(e){let t=[];this.tools=t,(0,eb.m7)(e,e=>{let i=this.makeTool(e);void 0!==i&&t.push(i)}),this.changed.dispatch()}insert(e,t){let i;let{tools:n}=this;i=void 0===t?n.length:n.indexOf(t);let r=this.makeTool(e);if(void 0!==r)return n.splice(i,0,r),this.changed.dispatch(),r}move(e,t){let i;let{tools:n}=this,r=n.indexOf(e);if(-1===r)return!1;if(void 0===t)i=n.length;else if(-1===(i=n.indexOf(t)))return!1;return i===r||(n.splice(r,1),i>r&&--i,n.splice(i,0,e),this.changed.dispatch(),!0)}remove(e){let{tools:t}=this,i=t.indexOf(e);return -1!==i&&(t.splice(i,1),e.dispose(),this.changed.dispatch(),!0)}toJSON(){let{tools:e}=this;if(0!==e.length)return Array.from(e,e=>e.localBinder.convertLocalJSONToPaletteJSON(e.toJSON()))}addTools(e){for(let t of e)this.initializeTool(t);this.tools.push(...e),this.changed.dispatch()}disposed(){for(let e of(super.disposed(),this.tools))e.dispose()}}class Te extends ef.gj{viewer;location;name;tools;query;parsedQuery;queryDefined;trackable;get changed(){return this.trackable.changed}constructor(e){super(),this.viewer=e,this.location=new dm(E8),this.name=new Z.TU("",eb.ZE),this.query=new Z.TU("",eb.ZE),this.parsedQuery=this.registerDisposer((0,Z.og)(e=>(function(e){let t=ap(e);return(t.endOffset!==e.length&&t.errors.push({range:{begin:t.endOffset,end:e.length},message:"Invalid clause/term"}),t.errors.length>0)?{errors:t.errors}:{query:t.query}})(e),this.query)),this.trackable=new rk,this.tools=this.registerDisposer(new E9(e)),this.location.changed.add(this.changed.dispatch),this.name.changed.add(this.changed.dispatch),this.trackable.add("tools",this.tools),this.trackable.add("query",this.query),this.queryDefined=this.registerDisposer((0,Z.mo)(e=>0===e.length,[this.tools]))}restoreState(e){this.location.restoreState(e),this.trackable.restoreState(e),""!==this.query.value&&this.tools.reset()}reset(){this.location.reset(),this.trackable.reset()}toJSON(){return{...this.location.toJSON(),...this.trackable.toJSON()}}}class Tt extends ef.gj{layer;element;header;content;firstTool;constructor(e){super(),this.layer=e,this.element=document.createElement("div"),this.header=document.createElement("div"),this.content=document.createElement("div");let{element:t,header:i,content:n}=this;t.classList.add("neuroglancer-tool-palette-layer-group"),t.appendChild(i),t.appendChild(n),i.classList.add("neuroglancer-tool-palette-layer-group-header"),n.classList.add("neuroglancer-tool-palette-layer-group-content"),i.appendChild(this.registerDisposer(new EK(e.managedLayer)).element),i.appendChild(this.registerDisposer(new Ez(e.managedLayer)).element)}}class Ti extends ef.gj{state;changed;results;jsonToTool;constructor(e){super(),this.state=e,this.changed=new ez.K_,this.results=[],this.jsonToTool=new Map,this.debouncedUpdateResults=this.registerCancellable((0,ic.Z)(()=>{this.updateResults()})),this.registerDisposer(e.query.changed.add(this.debouncedUpdateResults)),this.registerDisposer(e.viewer.globalToolBinder.localBindersChanged.add(this.debouncedUpdateResults)),this.updateResults()}disposed(){for(let e of this.jsonToTool.values())e.dispose();super.dispose()}debouncedUpdateResults;getMatches(){let e=!1,t=this.state.parsedQuery.value;if(void 0!==t&&"query"in t)return a$(this.state.viewer.globalToolBinder,t.query,()=>{!e&&(e=!0,this.debouncedUpdateResults())})}updateResults(){let e=this.getMatches()??new Map,{results:t,jsonToTool:i}=this,n=[];for(let[t,r]of e){let e=i.get(t);if(void 0===e){if(void 0===(e=E7(this.state.viewer,r)))continue;i.set(t,e)}n.push(e)}for(let[t,n]of i)!e.has(t)&&(n.dispose(),i.delete(t));!(0,Y.cO)(t,n)&&(this.results=n,this.changed.dispatch())}convertToExplicitPalette(){this.debouncedUpdateResults.flush(),this.state.query.value="",this.state.tools.addTools(this.results),this.results.length=0,this.jsonToTool.clear()}get value(){return this.results}}class Tn extends ef.gj{tool;palette;layerGroup;element;context;constructor(e,t){super(),this.tool=e,this.palette=t,this.element=document.createElement("label"),this.context=void 0,this.debouncedUpdateView=this.registerCancellable((0,iS.H)(()=>this.updateView())),this.debouncedUpdateTooltip=this.registerCancellable((0,iS.H)(()=>this.updateTooltip()));let{element:i}=this;i.classList.add("neuroglancer-tool-palette-tool-container"),i.addEventListener("dblclick",()=>{this.tool.unbind()}),i.append(this.registerDisposer(new aV(e.localBinder,e.toJSON(),i,{tool:e,palette:t})).element),this.updateView(),this.updateTooltip(),this.registerDisposer(e.changed.add(this.debouncedUpdateTooltip)),this.registerDisposer(t.state.queryDefined.changed.add(this.debouncedUpdateTooltip))}debouncedUpdateView;debouncedUpdateTooltip;updateTooltip(){let e=this.tool.toJSON();"string"==typeof e&&(e={type:e});let t=Object.entries(e).map(([e,t])=>`${e}:${t}`).join(" ");this.palette.state.queryDefined.value?t+="\nDrag to copy to another palette":t+="\nDrag to move/copy, dblclick to remove",this.element.title=t}updateView(){let{context:e}=this,{element:t}=this;void 0!==e&&(e.dispose(),t.removeChild(t.lastElementChild)),this.context=e=new ef.gj;let{tool:i}=this,n=this.tool.renderInPalette(e);void 0===n&&((n=document.createElement("div")).textContent="Loading...",i.localBinder instanceof aM&&e.registerDisposer(i.localBinder.context.managedLayer.layerChanged.add(this.debouncedUpdateView))),n.classList.add("neuroglancer-tool-palette-tool-content"),t.appendChild(n)}disposed(){this.context?.dispose(),this.layerGroup?.dispose(),super.disposed()}}class Tr extends cW{manager;state;itemContainer;dropZone;renderedTools;dragState;dragEnterCount;queryResults;clearDragState(){let{dragState:e}=this;void 0!==e&&(this.dragState=void 0,this.state.tools.remove(e.ephemeralTool))}get hasQuery(){return""!==this.state.query.value}registerDropHandlers(e,t){let i=()=>f?.localBinder.globalBinder===this.manager.state.viewer.globalToolBinder,n=(e,n)=>{let r;if(!i())return;if(this.hasQuery){this.clearDragState();let t=f?.paletteState?.palette;return n&&void 0!==t&&t!==this&&aa(e,this.itemContainer,"drop","Tools cannot be dropped into a query-defined palette.  To allow dropping tools into this palette, first click the magnifying glass icon in the panel titlebar to convert it to a manually-defined palette."),aN(f,"none",!1),"none"}this.dragState?.dragSource!==f&&this.clearDragState();let s="";if(n){let t=f.paletteState?.palette.state.queryDefined.value===!1,i=ab(e,t?"move":"copy",t);av(e,r=i.dropEffect),s=`Drop to ${r} the tool`,i.dropEffectMessage&&(s+=` (${i.dropEffectMessage})`)}else r=o;let a=t(),l=f.paletteState?.palette===this;if("copy"!==r&&l)this.clearDragState(),this.state.tools.move(f.paletteState.tool,a);else{let{dragState:e}=this;if(void 0===e){let e=f.localBinder.convertLocalJSONToPaletteJSON(f.toolJson),t=this.state.tools.insert(e,a);if(void 0===t){console.error("Failed to create tool: ",f.toolJson);return}this.dragState={dragSource:f,ephemeralTool:t}}else this.state.tools.move(e.ephemeralTool,a)}if(n){let t=f;aa(e,this.itemContainer,"drop",s,()=>{aN(t)}),aN(t,r,l)}return r},r=e=>{if(void 0===n(e,!0)){ao(e,this.itemContainer,"drop");return}e.preventDefault(),e.stopPropagation()};e.addEventListener("dragover",r),e.addEventListener("dragenter",e=>{++this.dragEnterCount,r(e)}),e.addEventListener("dragleave",e=>{0==--this.dragEnterCount&&(ao(e,this.itemContainer,"drop"),this.clearDragState(),e.stopPropagation())}),e.addEventListener("drop",e=>{e.preventDefault(),this.dragEnterCount=0,ao(e,this.itemContainer,"drop");let t=n(e,!1);if(void 0===t){this.clearDragState();return}if(e.stopPropagation(),this.dragState=void 0,"move"===t){let{paletteState:e}=f;void 0!==e&&e.palette!==this&&e.palette.state.tools.remove(e.tool)}})}constructor(e,t,i){super(t,i.location),this.manager=e,this.state=i,this.itemContainer=document.createElement("div"),this.dropZone=document.createElement("div"),this.renderedTools=new Map,this.dragState=void 0,this.dragEnterCount=0;let{titleBar:n}=this.addTitleBar({});n.appendChild(this.registerDisposer(new Tl(i.name)).element),this.queryResults=this.registerDisposer(new Ti(i));let r=this.registerDisposer((0,Z.mo)(e=>""!==e,[i.query])),s=this,a=this.registerDisposer(new aH({changed:r.changed,get value(){return r.value},set value(newValue){!1===newValue&&!1!==r.value&&s.queryResults.convertToExplicitPalette()}},{svg:E6,disableTitle:"Convert query results to an explicit tool palette"}));n.appendChild(a.element),this.registerDisposer(new ns(r,a.element));let o=gA({title:"Delete tool palette"});o.addEventListener("click",()=>{i.dispose()}),n.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-tool-palette-body");let{itemContainer:d}=this;d.classList.add("neuroglancer-tool-palette-items"),l.appendChild(this.registerDisposer(new aY(s.state.queryDefined,(e,t,n)=>{e&&t.appendChild(n.registerDisposer(new Ts(i)).element)})).element),l.appendChild(d),this.addBody(l);let{dropZone:u}=this;u.classList.add("neuroglancer-tool-palette-drop-zone"),this.registerDropHandlers(u,()=>void 0);let c=this.registerCancellable((0,iS.H)(()=>this.render()));this.registerDisposer(this.state.tools.changed.add(c)),this.registerDisposer(this.queryResults.changed.add(c)),this.visibility.changed.add(c),this.render()}getRenderedTool(e){let{renderedTools:t}=this,i=t.get(e);return void 0===i&&(i=new Tn(e,this),this.registerDropHandlers(i.element,()=>e),t.set(e,i)),i}getDragDropDescription(){return"tool palette"}canCopy(){return!0}copyToNewLocation(e){let t=this.manager.state.addNew({location:{...this.state.location.value,...e},name:this.state.name.value});t.tools.restoreState(this.state.tools.toJSON()??[]),t.query.value=this.state.query.value}render(){let e=this;sM(this.itemContainer,function*(){let t=e.state.queryDefined.value?e.queryResults.value:e.state.tools.tools,{renderedTools:i}=e,n=new Set(t),r=t.length,s=new Set;for(let i=0;i<r;){let n=t[i],{localBinder:a}=n;if(a instanceof aM){let o=a.context,l=e.getRenderedTool(n),{layerGroup:d}=l;s.has(d)||void 0===d?(d=new Tt(o),e.registerDropHandlers(d.header,()=>d.firstTool),d.firstTool=n):d.addRef(),s.add(d);sM(d.content,function*(){for(;l.layerGroup?.dispose(),l.layerGroup=d.addRef(),yield l.element,++i!==r&&(n=t[i]).localBinder===a;){;l=e.getRenderedTool(n)}}()),yield d.element,d.dispose()}else{let t=e.getRenderedTool(n);yield t.element,++i}}for(let[e,t]of i)!n.has(e)&&(t.dispose(),i.delete(e));yield e.dropZone}())}disposed(){}}class Ts extends ef.gj{state;element;errorsElement;constructor(e){super(),this.state=e,this.element=document.createElement("div"),this.errorsElement=document.createElement("ul");let t=this.registerDisposer(new fp({completer:this.completeQuery.bind(this)}));t.placeholder="Enter tool query or drag in tools",t.element.classList.add("neuroglancer-tool-palette-query"),t.value=e.query.value??"",this.registerDisposer(e.parsedQuery.changed.add(this.registerCancellable((0,ic.Z)(()=>this.updateErrors(),200)))),this.updateErrors(),t.onCommit.add(()=>{e.query.value=t.value}),e.query.changed.add(()=>{t.value=e.query.value??""});let{element:i,errorsElement:n}=this;i.appendChild(t.element),i.appendChild(n),n.classList.add("neuroglancer-tool-palette-query-errors")}updateErrors(){let{errorsElement:e}=this;sI(e);let t=this.state.parsedQuery.value;if(void 0!==t&&"errors"in t)for(let i of t.errors){let t=document.createElement("li");t.textContent=i.message,e.appendChild(t)}}async completeQuery({value:e}){let t;let i=ap(e),n=function(e){let t,i;let n=function(e){let{clauses:t}=e.query;if(e.endOffset===e.raw.length&&0!==t.length){let{range:i,terms:n}=t[t.length-1];if(i.end===e.endOffset&&0!==n.length){let e=n[n.length-1];return n.length=n.length-1,e.range.begin}}return e.endOffset}(e),r=e.raw.substring(n),s=r.match(am),a=0==e.query.clauses.length||e.query.clauses[e.query.clauses.length-1].include;null===s?i=n:(i=n+s[1].length+1,t=s[1],r=r.substring(s[1].length+1));let o={clauses:[]},{clauses:l}=e.query,d=[];if(0!==l.length&&d.push(...l[l.length-1].terms),void 0!==t&&d.push({property:t,predicate:{regexp:RegExp("^"+(0,au.Z)(r))},range:{begin:-1,end:-1}}),a){o.clauses.push({include:!0,terms:d,range:{begin:-1,end:-1}});for(let e=0,t=l.length-1;e<t;++e){let t=l[e];o.clauses.push({include:!t.include,terms:t.terms,range:t.range})}}else for(let e=0,t=l.length-1;e<t;++e){let t=l[e],i=t.terms;t.include&&(i=[...i,...d]),o.clauses.push({include:t.include,terms:i,range:t.range})}return{offset:i,prefix:r,property:t,include:a,completionQuery:o}}(i),r=a$(this.state.viewer.globalToolBinder,n.completionQuery);t=void 0===n.property?function(e,t,i){let n=new Set(Array.from(e.clauses[0].terms,e=>e.property)),r=new Map;for(let e of t.values())for(let t in e){if(!t.startsWith(i)||n.has(t))continue;let e=t+":",s=r.get(e)??0;r.set(e,s+1)}return af(r)}(n.completionQuery,r,n.prefix):function(e,t){let i=new Map;for(let n of e.values()){let e=""+n[t],r=i.get(e)??0;i.set(e,r+1)}return af(i)}(r,n.property);let s=[];for(let[e,r]of(void 0===n.property&&""===n.prefix&&i.query.clauses.length>0&&0!==i.query.clauses[i.query.clauses.length-1].terms.length&&(s.push({value:"+",description:"New inclusion clause"}),s.push({value:"-",description:"New exclusion clause"})),t))s.push({value:e,description:`${r} tool${r>0?"s":""}`});return{offset:n.offset,completions:s,makeElement:fc}}}class Ta{viewer;changed;changedShallow;visibleStateChanged;palettes;constructor(e){this.viewer=e,this.changed=new ez.K_,this.changedShallow=new ez.K_,this.visibleStateChanged=new ez.K_,this.palettes=new Set,this.checkingTitles=!1}add(e){this.palettes.add(e),e.registerDisposer(e.changed.add(this.changed.dispatch)),e.registerDisposer(e.location.watchableVisible.changed.add(this.visibleStateChanged.dispatch)),e.registerDisposer(e.name.changed.add(()=>this.checkTitles(e))),e.registerDisposer(()=>{this.palettes.delete(e),this.changedShallow.dispatch(),this.visibleStateChanged.dispatch(),this.changed.dispatch()}),this.changedShallow.dispatch(),this.changed.dispatch()}toJSON(){let{palettes:e}=this;if(0===e.size)return;let t={};for(let i of e)t[i.name.value]=rP(i).value;return t}reset(){let{palettes:e}=this;if(0!==e.size)for(let t of e)t.dispose()}restoreState(e){if(void 0===e)return;(0,eb.PT)(e);let{viewer:t}=this,i=new Map;for(let e of this.palettes)i.set(e.name.value,e);for(let[n,r]of Object.entries(e)){let e=i.get(n);if(void 0!==e){e.restoreState(r);continue}let s=new Te(t);s.name.value=n,s.restoreState(r),i.set(n,s),this.add(s)}}addNew(e={}){let t=new Te(this.viewer),{location:i,name:n="Palette"}=e;return t.name.value=n,this.checkTitles(t),t.location.value={...E8,...i??{}},t.location.locationChanged.dispatch(),this.add(t),t}checkingTitles;checkTitles(e){if(!this.checkingTitles)try{this.checkingTitles=!0;let t=new Set;for(let i of this.palettes)i!==e&&t.add(i.name.value);let i=e.name.value;if(!t.has(i))return;let n=0;for(;;){let r=i+ ++n;if(!t.has(r)){e.name.value=r;return}}}finally{this.checkingTitles=!1}}}class To extends ef.gj{sidePanelManager;state;panels;constructor(e,t){super(),this.sidePanelManager=e,this.state=t,this.panels=new Map;let i=this.registerCancellable((0,iS.H)(()=>this.updatePanels()));this.registerDisposer(this.state.changedShallow.add(i)),this.updatePanels()}updatePanels(){let{panels:e}=this,{palettes:t}=this.state;for(let[i,n]of e)!t.has(i)&&(this.sidePanelManager.unregisterPanel(n),e.delete(i));for(let i of t)if(!e.has(i)){let t={location:i.location,makePanel:()=>new Tr(this,this.sidePanelManager,i)};e.set(i,t),this.sidePanelManager.registerPanel(t)}}disposed(){for(let e of(super.disposed(),this.panels.values()))this.sidePanelManager.unregisterPanel(e)}}class Tl extends uJ{name;constructor(e){super(e),this.name=e;let{element:t}=this;t.classList.add("neuroglancer-tool-palette-name"),t.title="Rename tool palette"}}class Td extends ef.gj{state;element;constructor(e){super(),this.state=e,this.element=document.createElement("li");let{element:t}=this;t.appendChild(this.registerDisposer(new nr(e.location.watchableVisible,{enableTitle:"Show tool palette",disableTitle:"Hide tool palette"})).element),t.appendChild(this.registerDisposer(new Tl(e.name)).element);let i=gA({title:"Delete tool palette"});i.addEventListener("click",()=>{e.dispose()}),t.appendChild(i)}}class Tu{state;palette;element;constructor(e,t){this.state=e,this.palette=t,this.element=document.createElement("li");let{element:i}=this;i.classList.add("neuroglancer-tool-palette-dropdown-canned-item"),i.textContent=t.description??t.name,i.addEventListener("click",()=>{e.addNew({name:t.name}).query.value=t.query})}}let Tc=[{name:"Palette",description:"New empty palette",query:""},{name:"All controls",query:"+"},{name:"Shader controls",query:"type:shaderControl"}];class Th extends ef.gj{state;element;itemContainer;items;cannedItems;cannedItemSeparator;constructor(e){super(),this.state=e,this.element=document.createElement("div"),this.itemContainer=document.createElement("ul"),this.items=new Map,this.cannedItems=new Map,this.cannedItemSeparator=document.createElement("li");let{element:t,itemContainer:i,cannedItemSeparator:n}=this;t.classList.add("neuroglancer-tool-palette-dropdown"),n.classList.add("neuroglancer-tool-palette-dropdown-separator"),t.appendChild(i);let r=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(this.state.changedShallow.add(r)),this.updateView()}updateView(){let e=this;sM(this.itemContainer,function*(){let{palettes:t}=e.state,i=new Set,{items:n}=e;for(let e of t){let t=n.get(e);void 0===t&&(t=new Td(e),n.set(e,t)),i.add(e.query.value),yield t.element}let r=!0,{cannedItems:s}=e;for(let n of Tc){if(""!==n.query&&i.has(n.query))continue;let a=s.get(n);void 0===a&&(a=new Tu(e.state,n),s.set(n,a)),r&&(r=!1,0!==t.size&&(yield e.cannedItemSeparator)),yield a.element}for(let[e,i]of n)!t.has(e)&&(n.delete(e),i.dispose())}())}disposed(){super.disposed(),sR(this.element)}}class Tp extends ef.gj{state;countElement;dropdownVisible;dropdown;element;constructor(e){super(),this.state=e,this.countElement=document.createElement("div"),this.dropdownVisible=new Z.SN(!1),this.element=document.createElement("div");let{element:t,countElement:i}=this,n=this.registerDisposer(new aH(this.dropdownVisible,{svg:E5,enableTitle:"Show tool palette list (control+click to create new)",disableTitle:"Hide tool palette list",backgroundScheme:"dark"})).element;t.appendChild(n),t.classList.add("neuroglancer-tool-palette-button"),t.classList.add("neuroglancer-sticky-focus"),t.tabIndex=-1;let r=this.registerCancellable((0,iS.H)(()=>this.updateView()));this.registerDisposer(e.changedShallow.add(r)),this.registerDisposer(e.visibleStateChanged.add(r)),t.addEventListener("focusout",e=>{let{relatedTarget:i}=e;i instanceof Node&&!t.contains(i)&&(this.dropdownVisible.value=!1)}),n.insertAdjacentElement("afterbegin",i),this.dropdownVisible.changed.add(()=>{this.dropdownVisible.value?void 0===this.dropdown&&(this.dropdown=new Th(this.state),this.element.appendChild(this.dropdown.element),!function(e,t){let i=t.getBoundingClientRect(),{clientHeight:n,clientWidth:r}=e.ownerDocument.documentElement,s=i.top-6,a=r-i.bottom-6;i.left<n-i.right?(e.style.left="0px",e.style.right=""):(e.style.right="0px",e.style.left=""),e.style.maxWidth=`${i.width}px`,s>3*a?(e.style.top="",e.style.bottom=`${r-i.top}px`,e.style.maxHeight=s+"px"):(e.style.top=`${i.bottom}px`,e.style.bottom="",e.style.maxHeight=a+"px")}(this.dropdown.element,this.element)):(this.dropdown?.dispose(),this.dropdown=void 0)}),this.updateView()}updateView(){let e=this.state.palettes.size,t=0;for(let e of this.state.palettes)e.location.visible&&++t;this.countElement.textContent=t<e?`${t}/${e}`:""}disposed(){this.dropdown?.dispose()}}i("1808");let Tg={...dg,side:"left",row:2};class Tm{location=new dm(Tg);get changed(){return this.location.changed}toJSON(){return(0,eb.$Z)(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class Tf extends cW{constructor(e,t,i){super(e,t.location),this.addTitleBar({title:"Settings"});let n=document.createElement("div");n.classList.add("neuroglancer-settings-body");let r=document.createElement("div");r.classList.add("neuroglancer-settings-scroll-container"),n.appendChild(r),this.addBody(n);{let e=this.registerDisposer(new uJ(i.title));e.element.placeholder="Title",e.element.classList.add("neuroglancer-settings-title"),r.appendChild(e.element)}let s=(e,t)=>{let i=this.registerDisposer(new aQ(t,{label:e}));i.element.classList.add("neuroglancer-settings-limit-widget"),r.appendChild(i.element)};s("GPU memory limit",i.chunkQueueManager.capacities.gpuMemory.sizeLimit),s("System memory limit",i.chunkQueueManager.capacities.systemMemory.sizeLimit),s("Concurrent chunk requests",i.chunkQueueManager.capacities.download.itemLimit);let a=(e,t)=>{let i=document.createElement("label");i.textContent=e;let n=this.registerDisposer(new nr(t));i.appendChild(n.element),r.appendChild(i)};a("Show axis lines",i.showAxisLines),a("Show scale bar",i.showScaleBar),a("Show cross sections in 3-d",i.showPerspectiveSliceViews),a("Show default annotations",i.showDefaultAnnotations),a("Show chunk statistics",i.statisticsDisplayState.location.watchableVisible),a("Wire frame rendering",i.wireFrame),a("Enable prefetching",i.chunkQueueManager.enablePrefetch),a("Enable adaptive downsampling",i.enableAdaptiveDownsampling);let o=(e,t)=>{let i=document.createElement("label");i.textContent=e;let n=this.registerDisposer(new sD(t));i.appendChild(n.element),r.appendChild(i)};o("Cross-section background",i.crossSectionBackgroundColor),o("Projection background",i.perspectiveViewBackgroundColor)}}i("5584");class Tv extends ef.gj{selectedLayer;toolBinder;element;unbindPreviousLayer;get selectedTool(){let e=this.selectedLayer.layer;if(void 0===e)return;let t=e.layer;if(null!==t)return t.tool.value}constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable((0,iS.H)(()=>{let{viewContext:e}=this;void 0!==e&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new ef.gj),sI(this.element);let{selectedTool:t}=this;void 0!==t&&this.element.appendChild(this.makeWidget(e,t));let i=Array.from(this.toolBinder.bindings);for(let[,t]of(i.sort(([e],[t])=>(0,ac.B)(e,t)),i))this.element.appendChild(this.makeWidget(e,t))}));let{element:i}=this;i.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;void 0!==e&&e();let t=this.selectedLayer.layer;void 0!==t&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;void 0!==e&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let i=document.createElement("div");i.title="dblclick → unbind",t instanceof aC&&(i.title+=", click → bind key"),i.className="neuroglancer-annotation-tool-status-widget";let n=document.createElement("div");n.className="neuroglancer-annotation-tool-status-widget-layer-number";let r=document.createElement("div");if(r.className="neuroglancer-annotation-tool-status-widget-description",r.textContent=t.description,i.addEventListener("dblclick",()=>{t instanceof aE?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof aC){let n=document.createElement("div");n.className="neuroglancer-annotation-tool-status-widget-key",n.textContent=t.keyBinding,i.appendChild(n),aO(e,i,e=>t.localBinder.set(e,t.addRef()))}let s=t.context;if(s instanceof dM){let{managedLayer:e}=s;e.manager.rootLayers.updateNonArchivedLayerIndices();let t=e.nonArchivedLayerIndex;n.textContent=(t+1).toString(),i.appendChild(n)}return i.appendChild(r),i}viewContext;updateView}class Ty extends ef.gj{gl;frameNumberCounter;worker;chunkQueueManager;chunkManager;get rpc(){return this.chunkQueueManager.rpc}constructor(e,t){super(),this.gl=e,this.frameNumberCounter=t,this.worker=new Worker(new URL(i.p+i.u("525"),i.b),Object.assign({},{type:"module"},{type:void 0})),this.chunkQueueManager=this.registerDisposer(new lg(new iZ(this.worker,!0),this.gl,this.frameNumberCounter,{gpuMemory:new lp({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new lp({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new lp({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new lp({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new lf(this.chunkQueueManager))}}let Tb=["showHelpButton","showSettingsButton","showEditStateButton","showToolPaletteButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],TS=[...Tb,"showLayerPanel","showLayerHoverValues"],Tw=[...TS,"showUIControls","showPanelBorders"],TC="undefined"!=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class Tx extends rk{viewer;constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("velocity",e.velocity),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("enableAdaptiveDownsampling",e.enableAdaptiveDownsampling),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer),this.add("toolBindings",e.toolBinder),this.add("toolPalettes",e.toolPalettes)}restoreState(e){let{viewer:t}=this;super.restoreState(e),(0,eb.Kh)(e,"navigation",e=>{(0,eb.PT)(e),(0,eb.Kh)(e,"pose",e=>{(0,eb.PT)(e),(0,eb.Kh)(e,"position",e=>{(0,eb.PT)(e),rT(e,"voxelCoordinates",t.position),(0,eb.Kh)(e,"voxelSize",e=>{let i=(0,eb.Iw)(new Float64Array(3),e,eb.o7);for(let e=0;e<3;++e)i[e]*=1e-9;t.coordinateSpace.value=tR({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:i})})}),rT(e,"orientation",t.crossSectionOrientation)}),rT(e,"zoomFactor",t.crossSectionScale.legacyJsonView)}),rT(e,"perspectiveOrientation",t.projectionOrientation),rT(e,"perspectiveZoom",t.projectionScale.legacyJsonView),rT(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}class TE extends ef.gj{display;title;coordinateSpace;position;velocity;relativeDisplayScales;displayDimensions;displayDimensionRenderInfo;crossSectionOrientation;crossSectionScale;projectionOrientation;crossSectionDepthRange;projectionDepthRange;projectionScale;navigationState;perspectiveNavigationState;mouseState;layerManager;selectedLayer;showAxisLines;wireFrame;enableAdaptiveDownsampling;showScaleBar;showPerspectiveSliceViews;visibleLayerRoles;showDefaultAnnotations;crossSectionBackgroundColor;perspectiveViewBackgroundColor;scaleBarOptions;partialViewport;statisticsDisplayState;helpPanelState;settingsPanelState;layerSelectedValues;selectionDetailsState;selectedStateServer;layerListPanelState;resetInitiated;get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}layerSpecification;layout;sidePanelManager;state;dataContext;visibility;inputEventBindings;element;dataSourceProvider;uiConfiguration;makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,i=this.uiConfiguration[e];return this.registerDisposer((0,Z.S_)((e,t)=>e&&t,t,i))}uiControlVisibility;showLayerDialog;resetStateWhenEmpty;get inputEventMap(){return this.inputEventBindings.global}visible;constructor(e,t={}){super(),this.display=e,this.title=new Z.TU(void 0,eb.ZE),this.coordinateSpace=new tO,this.position=this.registerDisposer(new rO(this.coordinateSpace)),this.velocity=this.registerDisposer(new rU(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new rK(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new r1(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new r0(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new rH),this.crossSectionScale=this.registerDisposer(new r8(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new rH),this.crossSectionDepthRange=this.registerDisposer(new r9(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new r9(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new r7(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new st(new r3(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new st(new r3(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new dO,this.layerManager=this.registerDisposer(new dV),this.selectedLayer=this.registerDisposer(new dW(this.layerManager.addRef())),this.showAxisLines=new nn(!0,!0),this.wireFrame=new nn(!1,!1),this.enableAdaptiveDownsampling=new nn(!0,!0),this.showScaleBar=new nn(!0,!0),this.showPerspectiveSliceViews=new nn(!0,!0),this.visibleLayerRoles=new Z.GF([0,1,2]),this.showDefaultAnnotations=new nn(!0,!0),this.crossSectionBackgroundColor=new ed(Q.R3.fromValues(.5,.5,.5)),this.perspectiveViewBackgroundColor=new ed(Q.R3.fromValues(0,0,0)),this.scaleBarOptions=new xE,this.partialViewport=new iI,this.statisticsDisplayState=new E1,this.helpPanelState=new Ec,this.settingsPanelState=new Tm,this.layerSelectedValues=this.registerDisposer(new d_(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new dU(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new Z.TU("",eb.ZE),this.layerListPanelState=new EJ,this.resetInitiated=new ez.K_,this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))},this.toolPalettes=new Ta(this),this.globalToolBinder=this.registerDisposer(new aR(this.toolInputEventMapBinder,this.toolPalettes)),this.toolBinder=this.registerDisposer(new aA(this,this.globalToolBinder));let{dataContext:i=new Ty(e.gl,e),visibility:n=new i4(i4.VISIBLE),inputEventBindings:r={global:new sh,sliceView:new sh,perspectiveView:new sh},element:s=e.makeCanvasOverlayElement(),dataSourceProvider:a=function(e){let t=new ds(e.credentialsManager);for(let[i,n]of yg)try{t.register(i,n(e))}catch(e){console.warn(`Skipping ${i} data source: ${e}`)}return t}({credentialsManager:yC}),uiConfiguration:o=Object.fromEntries(Tw.map(e=>[e,new nn(!0)]))}=t;this.visibility=n,this.inputEventBindings=r,this.element=s,this.dataSourceProvider=a,this.uiConfiguration=o,this.registerDisposer((0,Z.Jk)(e=>{this.display.applyWindowedViewportToElement(s,e)},this.partialViewport)),this.registerDisposer(()=>sR(this.element)),this.dataContext=this.registerDisposer(i),!function(e,t){for(let i of Tw){let n=t[i];void 0!==n&&(e[i].value=n)}}(o,t);let{resetStateWhenEmpty:l,showLayerDialog:d}={...TC,...t};for(let e of TS)this.uiControlVisibility[e]=this.makeUiControlVisibilityState(e);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=d,this.resetStateWhenEmpty=l,this.layerSpecification=new dQ(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.globalToolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(i8.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(i8.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let u=this.registerCancellable((0,ic.Z)(()=>{!this.wasDisposed&&0===this.layerManager.managedLayers.length&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!mk&&this.showLayerDialog&&this.visibility.visible&&un(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(u),u(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(EP(s,this.navigationState.position)),this.state=new Tx(this),this.registerDisposer(new rG(this.display,this.position,this.velocity))}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let i=this.registerDisposer(new a9(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner,{velocity:this.velocity,getToolBinder:()=>this.toolBinder}));this.registerDisposer(new ns(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element);let n=this.registerDisposer(new oe(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(n.element.style.flex="1",n.element.style.alignSelf="center",this.registerDisposer(new ns(this.uiControlVisibility.showLocation,n.element)),t.appendChild(n.element),"undefined"!=typeof NEUROGLANCER_CREDIT_LINK){let e=NEUROGLANCER_CREDIT_LINK;for(let{url:i,text:n}of(!Array.isArray(e)&&(e=[e]),e)){let e=document.createElement("a");e.style.marginRight="5px",e.href=i,e.textContent=n,e.style.fontFamily="sans-serif",e.style.color="yellow",e.target="_blank",t.appendChild(e)}}let r=this.registerDisposer(new Tv(this.selectedLayer,this.globalToolBinder));if(t.appendChild(r.element),this.registerDisposer(new ns(this.uiControlVisibility.showAnnotationToolStatus,r.element)),Eo){let e=this.registerDisposer(new El(this));t.appendChild(e.element)}{let e=this.registerDisposer(new Tp(this.toolPalettes)).element;this.registerDisposer(new ns(this.uiControlVisibility.showToolPaletteButton,e)),t.appendChild(e)}{let{layerListPanelState:e}=this,i=this.registerDisposer(new aH(e.location.watchableVisible,{svg:C8,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));i.element.insertAdjacentElement("afterbegin",this.registerDisposer(new EX(this.layerManager)).element),this.registerDisposer(new ns(this.uiControlVisibility.showLayerListPanelButton,i.element)),t.appendChild(i.element)}{let{selectionDetailsState:e}=this,i=this.registerDisposer(new aH(e.location.watchableVisible,{svg:C7,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new ns(this.uiControlVisibility.showSelectionPanelButton,i.element)),t.appendChild(i.element)}{let{selectedLayer:e}=this,i=this.registerDisposer(new aH({get value(){return e.visible},set value(visible){e.visible=visible},changed:e.location.locationChanged},{svg:C5,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new ns(this.uiControlVisibility.showLayerSidePanelButton,i.element)),t.appendChild(i.element)}{let e=sV({text:"{}",title:"Edit JSON state"});this.registerEventListener(e,"click",()=>{this.editJsonState()}),this.registerDisposer(new ns(this.uiControlVisibility.showEditStateButton,e)),t.appendChild(e)}{let{helpPanelState:e}=this,i=this.registerDisposer(new aH(e.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new ns(this.uiControlVisibility.showHelpButton,i.element)),t.appendChild(i.element)}{let{settingsPanelState:e}=this,i=this.registerDisposer(new aH(e.location.watchableVisible,{svg:C9,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new ns(this.uiControlVisibility.showSettingsButton,i.element)),t.appendChild(i.element)}this.registerDisposer(new ns((0,Z.S_)((...e)=>e.reduce((e,t)=>e||t,!1),...Tb.map(e=>this.uiControlVisibility[e])),t)),e.appendChild(t),this.layout=this.registerDisposer(new EB(this,"4panel")),this.sidePanelManager=this.registerDisposer(new cq(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new EY(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new Eq(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new cK(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new E4(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:e}=this;return new Eh(this.sidePanelManager,this.helpPanelState,[["Global",e.global],["Cross section view",e.sliceView],["3-D projection view",e.perspectiveView]],this.layerManager,this.globalToolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new Tf(this.sidePanelManager,this.settingsPanelState,this)})),this.registerDisposer(new To(this.sidePanelManager,this.toolPalettes));let s=()=>{let t=this.visibility.visible;t!==this.visible&&(e.style.visibility=t?"inherit":"hidden",this.visible=t)};s(),this.registerDisposer(this.visibility.changed.add(s))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new aq(e,this.inputEventMap)),this.registerDisposer(new mT(e))}bindAction(e,t){this.registerDisposer(sv(this.element,e,t))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});let e=e=>{let t=this.selectedLayer.layer?.layer;t&&t.dispatchLayerEvent(e)};for(let t of(this.bindAction("select-previous",()=>{e("select-previous")}),this.bindAction("select-next",()=>{e("select-next")}),["select","star"]))this.bindAction(t,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(t)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(void 0===e){ai.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(null===t||void 0===t.tool.value){ai.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}toolInputEventMapBinder;toolPalettes;globalToolBinder;toolBinder;activateTool(e,t){this.globalToolBinder.activate(e,t)}editJsonState(){new EQ(this)}showStatistics(e){void 0===e&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;null===e.chunkUpdateDeadline&&(e.chunkUpdateDeadline=Date.now()+10)}}isReady(){if(this.chunkQueueManager.flushPendingChunkUpdates(),!this.display.isReady())return!1;for(let e of this.layerManager.managedLayers)if(!e.isReady())return!1;return!0}}aL(TE,ot,(e,t)=>or({position:e.position,velocity:e.velocity,coordinateSpaceCombiner:e.layerSpecification.coordinateSpaceCombiner,toolBinder:e.toolBinder},t),(e,t)=>os(e.coordinateSpace,t)),aL(EA,ot,(e,t)=>or({position:e.viewerNavigationState.position.value,velocity:e.viewerNavigationState.velocity.velocity,coordinateSpaceCombiner:e.layerSpecification.root.coordinateSpaceCombiner,toolBinder:e.toolBinder},t)),aL(dM,ot,(e,t)=>or({position:e.localPosition,velocity:e.localVelocity,coordinateSpaceCombiner:e.localCoordinateSpaceCombiner,toolBinder:e.toolBinder},t),(e,t)=>os(e.localCoordinateSpace,t));class TT extends ef.gj{root;credentialsManager;prevStateString;prevStateGeneration;parseError;defaultFragment;constructor(e,t,i={}){super(),this.root=e,this.credentialsManager=t,this.parseError=new Z.SN(void 0);let{updateDelayMilliseconds:n=200,defaultFragment:r="{}"}=i;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let s=(0,ic.Z)(()=>this.setUrlHash(),n,{maxWait:2*n});this.registerDisposer(e.changed.add(s)),this.registerDisposer(()=>s.cancel()),this.defaultFragment=r}setUrlHash(){let e=rP(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let t=encodeURI(JSON.stringify(e.value)).replace(/[!'()*;,]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase());t!==this.prevStateString&&(this.prevStateString=t,"{}"===decodeURIComponent(t)?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+t))}}updateFromUrlHash(e=e=>e){try{let t=location.href.replace(/^[^#]+/,"");if((""===t||"#"===t||"#!"===t)&&(t="#!"+this.defaultFragment),t.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let e=t.substring(2),{url:i,credentialsProvider:n}=vO(e,this.credentialsManager);ai.forPromise(v_(n,i,{}).then(e=>e.json()).then(e=>{(0,eb.PT)(e),this.root.reset(),this.root.restoreState(e)}),{initialMessage:`Loading state from ${e}`,errorPrefix:"Error loading state:"})}else if(t.startsWith("#!+")){t=t.slice(3),t=decodeURIComponent(t);let e=(0,eb.OD)(t);(0,eb.PT)(e),this.root.restoreState(e),this.prevStateString=void 0}else if(t.startsWith("#!")){if(t=t.slice(2),(t=decodeURIComponent(t))===this.prevStateString)return;this.prevStateString=t,this.root.reset();let i=(0,eb.OD)(t);(0,eb.PT)(i),this.root.restoreState(e(i))}else throw Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}}let Tk="undefined"!=typeof CUSTOM_BINDINGS&&Object.keys(CUSTOM_BINDINGS).length>0;i("4465"),!function(){var e,t;let i=window.viewer=((0,ef.H0)(document,"contextmenu",e=>{e.preventDefault()}),(0,ef.H0)(document,"wheel",e=>{e.ctrlKey&&e.preventDefault()},{passive:!1}),function(e={}){try{let{target:t=document.getElementById("neuroglancer-container")}=e;null===t&&((t=document.createElement("div")).id="neuroglancer-container",document.body.appendChild(t));let i=new iR(t);return new TE(i,e)}catch(e){throw ai.showMessage(`Error: ${e.message}`),e}}(void 0));(t=i.inputEventBindings).global.addParent(function(){if(void 0===l){let e=new sh;e.set("keyl","recolor"),e.set("keyx","clear-segments"),e.set("keys","toggle-show-slices"),e.set("keyb","toggle-scale-bar"),e.set("keyv","toggle-default-annotations"),e.set("keya","toggle-axis-lines"),e.set("keyo","toggle-orthographic-projection");for(let t=1;t<=9;++t)e.set("digit"+t,"toggle-layer-"+t),e.set("control+digit"+t,"select-layer-"+t),e.set("alt+digit"+t,"toggle-pick-layer-"+t);for(let t=0;t<26;++t){let i=String.fromCharCode(97+t),n=String.fromCharCode(65+t);e.set(`alt?+control?+shift+key${i}`,`tool-${n}`)}e.set("keyn","add-layer"),e.set("keyh","help"),e.set("space","toggle-layout"),e.set("shift+space","toggle-layout-alternative"),e.set("backslash","toggle-show-statistics"),e.set("alt+arrowup","select-previous"),e.set("alt+arrowdown","select-next"),l=e}return l}(),Number.NEGATIVE_INFINITY),t.sliceView.addParent((void 0===p&&(p=sh.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[cN(),Number.NEGATIVE_INFINITY]]})),p),Number.NEGATIVE_INFINITY),t.perspectiveView.addParent((void 0===h&&(h=sh.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[cN(),Number.NEGATIVE_INFINITY]]})),h),Number.NEGATIVE_INFINITY);let n=(e,t,n,r)=>{let s,a;"string"==typeof e&&(e={type:e}),(0,eb.PT)(e);let o=(0,eb.uq)(e,"type",eb.ZE);i.bindAction(`tool-${o}`,()=>{let o=i.layerManager.managedLayers.filter(e=>{let t=e.layer instanceof n;if(!r||!t)return t;for(let t of e.layer?.dataSources||[])if(i.dataSourceProvider.getProvider(t.spec.url)[2]===r)return!0;return!1});if(o.length>0){let n=o[0].layer;n&&(n!==a&&(s=aT(n,e),a=n),s&&i.activateTool(t,s))}})};if(Tk){let e=(t,i)=>{for(let n of(t.delete(i),t.parents))e(n,i)};for(let[t,r]of Object.entries(CUSTOM_BINDINGS))if(e(i.inputEventBindings.global,t),e(i.inputEventBindings.perspectiveView,t),e(i.inputEventBindings.sliceView,t),"string"==typeof r)i.inputEventBindings.global.set(t,r);else if("boolean"==typeof r);else{i.inputEventBindings.global.set(t,`tool-${r.tool}`);let e=d1.get(r.layer);if(e){let i=t.charAt(t.length-1).toUpperCase();n(r.tool,i,e,r.provider)}}}let r=i.registerDisposer(new TT(i.state,i.dataSourceProvider.credentialsManager,{defaultFragment:"undefined"!=typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));i.registerDisposer(r.parseError.changed.add(()=>{let{value:e}=r.parseError;void 0!==e&&(new ai().setErrorMessage(`Error parsing state: ${e.message}`),console.log("Error parsing state",e)),r.parseError})),r.updateFromUrlHash(e=>(e.layers&&(Array.isArray(e.layers)?e.layers:Object.values(e.layers)).map(e=>{e.source?.state?.timestamp&&(e.timestamp=e.source.state.timestamp,e.source.state.timestamp=void 0)}),e)),i.registerDisposer(function(e){let t=(0,iS.H)(()=>{let t=e.value?.trim();t?document.title=`${t} - neuroglancer`:document.title="neuroglancer"}),i=e.changed.add(t);return t(),t.flush(),()=>{i(),t.cancel()}}(i.title)),!function(e){e.registerEventListener(document,"copy",t=>{if(sN(t.target))return;let i=document.getSelection();if(null!==i&&"Range"===i.type)return;let n=rP(e.state).value,{clipboardData:r}=t;null!==r&&r.setData("text/plain",JSON.stringify(n,void 0,"  ")),t.preventDefault()})}(i),!function(e){e.registerEventListener(document,"paste",t=>{if(sN(t.target))return;let{clipboardData:i}=t;if(null!==i){let t=function(e,t){let i=String.raw`^[\[\]{}()\s,]*`;for(let e=0;e<t;++e)0!==e&&(i+=String.raw`[,\s]+`),i+=String.raw`(\d+(?:\.\d+)?)`;i+=String.raw`[\[\]{}()\s,]*$`;let n=e.match(i);if(null===n)return;let r=new Float32Array(t);for(let e=0;e<t;++e){let t=Number(n[e+1]);if(!Number.isFinite(t))return;r[e]=t}return r}(i.getData("text/plain"),e.coordinateSpace.value.rank);void 0!==t&&(e.navigationState.position.value=t)}t.preventDefault()})}(i)}()}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}i.m=e,i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.k=function(e){return""+e+".css"},i.u=function(e){return""+e+".js"},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e=[];i.O=function(t,n,r,s){if(n){s=s||0;for(var a=e.length;a>0&&e[a-1][2]>s;a--)e[a]=e[a-1];e[a]=[n,r,s];return}for(var o=1/0,a=0;a<e.length;a++){for(var n=e[a][0],r=e[a][1],s=e[a][2],l=!0,d=0;d<n.length;d++)(!1&s||o>=s)&&Object.keys(i.O).every(function(e){return i.O[e](n[d])})?n.splice(d--,1):(l=!1,s<o&&(o=s));if(l){e.splice(a--,1);var u=r();void 0!==u&&(t=u)}}return t}})(),i.rv=function(){return"1.1.6"},(()=>{i.g.importScripts&&(e=i.g.location+"");var e,t=i.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length){for(var r=n.length-1;r>-1&&(!e||!/^http(s?):/.test(e));)e=n[r--].src}}if(!e)throw Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),(()=>{i.b=document.baseURI||self.location.href;var e={909:0};i.O.j=function(t){return 0===e[t]};var t=function(t,n){var r=n[0],s=n[1],a=n[2],o,l,d=0;if(r.some(function(t){return 0!==e[t]})){for(o in s)i.o(s,o)&&(i.m[o]=s[o]);if(a)var u=a(i)}for(t&&t(n);d<r.length;d++)l=r[d],i.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return i.O(u)},n=globalThis.webpackChunkneuroglancer=globalThis.webpackChunkneuroglancer||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),i.ruid="bundler=rspack@1.1.6";var n=i.O(void 0,["822","213","588","103"],function(){return i("1146")});n=i.O(n)})();
//# sourceMappingURL=main.js.map