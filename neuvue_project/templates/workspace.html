{% extends "base.html" %}
{% load static %}

{% block content %}
<! Information Hidden Menu >

{% if is_open %}
<div class="basic workspace">
{% else %}
<div class="basic interTask">
{% endif %}
    <div id="neuVue-sidemenu" class="sidemenu">
        <div id="neuVue-sidebar" class="sidebar">
            <a id = "sidebarActivate" class="fill-div" onclick="sidemenu_content()">
                <i class="glyphicon glyphicon-list"></i>
            </a>  
        </div>
        <div id="neuVue-sidecontent" class="sidecontent">
            
            <! Instructions >
            <div id = "instruction-container" class ="sideContentBox" style="max-height:30%;">
                <div class="sideContentTitle">
                    Instructions
                </div>
                <div class="sideContentInfo">
                    {{ instructions.prompt }}
                </div>
            </div>
            
            <! Task Information >
            <div id = "instruction-container" class ="sideContentBox" style="max-height:70%;">
                <div class="sideContentTitle">
                    Task Information
                </div>
                <div class="sideContentInfo">
                    Namespace <br> 
                    <span class ="code"> <button class="clipboard" onclick="copyToClipboard('{{display_name}}')"><i class="fa fa-copy"></i></button> {{display_name}} </span> <br>
                    Task ID <br> 
                    <span class ="code"> <button class="clipboard" onclick="copyToClipboard('{{task_id}}')"><i class="fa fa-copy"></i></button> {{task_id}} </span> <br>
                    Segmentation ID  <br>
                    <span class ="code"> <button class="clipboard" onclick="copyToClipboard('{{seg_id}}')"><i class="fa fa-copy"></i></button> {{seg_id}} </span> <br>
                    PCG Endpoint  <br> 
                    <span class ="code"> <button class="clipboard" onclick="copyToClipboard('{{pcg_url}}')"><i class="fa fa-copy"></i></button> {{pcg_url}}  </span>  <br>
                    
                </div>
            </div>
            <div class="sideContentBox memo">
                <div class="sideContentInfo memo">
                    Pro Tip: Use Chrome and turn off toolbar in full screen! <br>
                    Apple: CMD+SHIFT+F <br>
                    PC: F11
                </div>
            </div>
        </div>
    </div> 

    <! Neuroglancer >
    <div id="neuroglancer" class="leftFormatting">
        
        <div class="left">
            {% if is_open %}
                {% if submission_method == "forced_choice" %}
                <form id="mainForm" action="" method="post" class="bottomBar" style="order: 0;">
                    {% csrf_token %}

                    <! Submission Options>
                    <button 
                        id="btnYes" 
                        type="button" 
                        class="mainButton submit quad" 
                    >
                        Yes
                    </button>

                    <button 
                        id="btnYesBut" 
                        type="button" 
                        class="mainButton yesBut" 
                    >
                        Yes, but requires refinement
                    </button>

                    <button 
                        id="btnNo" 
                        type="button" 
                        class="mainButton flag quad" 
                    >
                        No
                    </button>

                    <button 
                        id="btnUnsure" 
                        type="button" 
                        class="mainButton pause quad" 
                    >
                        Unsure
                    </button>
                    
                </form>
                {% endif %}

            <iframe src="{{ng_url}}"
                    class="neuroGlancer"
                    id="neuroGlancerFrame">
            </iframe>
            {% endif %}
            
            <! Buttons >
                
                <form id="mainForm" action="" method="post" class="bottomBar">
                    {% csrf_token %}

                    <! Save/Reload >
                    {% if is_open %}
                    <button
                        id="btnSave" 
                        type="button" 
                        class="mainButton" 
                    >
                        Save Checkpoint
                    </button>
                    
                    <button
                        id="btnReload" 
                        type="button" 
                        class="mainButton"
                    {% if submission_method == "forced_choice" %}
                        style="margin-right: 15vw;"
                    {% endif %}
                    >
                        Reload Checkpoint
                    </button>

                    <! Submit >
                    {% if submission_method == "submit" %}
                    <button 
                        name="btnSubmit"
                        id="btnSubmit" 
                        type="button" 
                        class="mainButton submit" 
                    >
                        Submit Task
                    </button>
                    {% endif %}

                    <! Flag/Stop >
                    <button
                        id="btnFlag" 
                        type="button" 
                        class="mainButton flag"
                    {% if submission_method == "forced_choice" %}
                        style="margin-left: 15vw;"
                    {% endif %}
                        data-bs-toggle="modal" 
                        data-bs-target="#flagModal">
                        Flag Task
                    </button>
                
                    <button 
                        id="btnStop"
                        type="button"
                        class="mainButton pause"
                    >
                        Exit Task
                    </button>

                    {% else %}
                    <! In-between Tasks >
                    <div class="interTaskBox">
                        {%if tasks_available %}
                        <button type="button" class="mainButton submit duo" id="btnStart">
                            Start New  Task
                        </button>

                        {% else %}
                        <button type="button" class="mainButton submit duo" disabled >
                            No Pending Tasks
                        </button> 
                        
                        {% endif%}
                        
                        <button type="button" class="mainButton flag duo" onclick= "document.location='{% url 'tasks' %}'">
                            Exit Workspace
                        </button>
                        {% endif %}
                    </div>
                </form>
        </div>
    </div>
</div>

<form id="flagForm" method="post">
    {% csrf_token %}
    <!-- Modal -->
    <div id="flagModal" class="modal" name="flag" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Flagging Task #{{task_id}}</h5>
                    <button type="button" class="btn-close" id="btnFlagClose" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="" method="post" role="form">
                        <div class="form-group">
                            <label class="custom-select-label" for="flag">Please select a reason for flagging this task:</label>
                            <select class="custom-select" name="flag" id="select-flag" onchange=toggleTextbox()>
                                <option value="unknown">Select reason</option>
                                <option value="artifact in the data">Artifact in the data</option>
                                <option value="wrong location">Wrong location</option>
                                <option value="data unable to load">Data unable to load</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: none;" id="text">
                            <label for="flag-other">Other reason*</label>
                            <textarea class="form-control" name="flag-other" rows="2" maxlength="100" placeholder="Enter reason" validate></textarea>
                            <small class="form-text text-muted">*100 character limit.</small>
                            <div class="invalid-feedback">Please enter a reason.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btnFlagClose" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnFlagSubmit">Submit</button>
                </div>
            </div>
        </div>
    </div> 
</form>

<div id="timeoutModal" class="modal" name="flag" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Are you still Proofreading?</h5>
                <button type="button" class="btn-close" id="btnTimeoutClose" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label class="custom-select-label" for="flag">This is simply for time keeping purposes, please press yes or no</label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="timeoutModalNo" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="timeoutModalYes" data-bs-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div> 

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script type="text/javascript" src="{% static "js/utils.js" %}"></script>
<script type="text/javascript" src="{% static "js/state.js" %}"></script>

<script type="text/javascript"> 

    // Side Bar Interaction
    if ({{ request.session.num_visits }} === 0) {
       openSideMenu();
    } else if ({{ request.session.sidebar }} === 0) {
       closeSideMenu();
    } else {
       openSideMenu();
    }

    /* Function for getting the current Neuroglancer state */
    
    addStateEventListener('{{ng_url}}');
    
    function submitForm(value) {
        getCurrentNeuroglancerState('{{ng_url}}', function (data){
            $('<input>').attr('type', 'hidden').attr('name', 'ngState').attr('value', data).appendTo('#mainForm');
            $('<input>').attr('type', 'hidden').attr('name', 'button').attr('value', value).appendTo('#mainForm');
            $('#mainForm').submit()
        });
    }


    $(document).ready(function() {
        // HACK. Reset the window storage so it doesnt reload previous tasks
        window.localStorage.removeItem('ngState');

        $('#btnSave').click(function() {
            getCurrentNeuroglancerState('{{ng_url}}');
        })

        $('#btnReload').click(function() {
            if (window.localStorage.getItem('ngState') !== null){
                let state = JSON.parse(window.localStorage['ngState'])['value'];
                let prefix = new URL('{{ng_url}}').origin + '/#!';
                $('#neuroGlancerFrame').attr('src', prefix + JSON.stringify(state));
            }
            else {
                $('#neuroGlancerFrame').attr('src', function (i, val) { return val; });
            } 
        })

        if ('{{submission_method}}' == "submit"){
            $('#btnSubmit').click(function(){
                submitForm('submit');
            });

        } else if ('{{submission_method}}' == "forced_choice") {
            $('#btnYes').click(function(){
                submitForm('yes');
            });

            $('#btnYesBut').click(function(){
                submitForm('yesConditional');
            });

            $('#btnNo').click(function(){
                submitForm('no');
            });

            $('#btnUnsure').click(function(){
                submitForm('unsure');
            });
        }


        $('#btnFlag').click(function() {
            getCurrentNeuroglancerState('{{ng_url}}', function (data){
                $('#neuroGlancerFrame').detach();
            });   
        })
        
        $('#btnFlagSubmit').click(function() {
            $('<input>').attr('type', 'hidden').attr('name', 'ngState').attr('value', window.localStorage.getItem('ngState')).appendTo('#flagForm');
            $('<input>').attr('type', 'hidden').attr('name', 'button').attr('value', 'flag').appendTo('#flagForm');
            $('#flagForm').submit()
        })

        $('#btnFlagClose').click(function() {
            window.location.reload()
        })

        $('#timeoutModalYes').click(function() {
            isTimeout('true');
            //dont take to task page
        })

        $('#timeoutModalNo').click(function() {
            isTimeout('true');
            //take to task page
            getCurrentNeuroglancerState('{{ng_url}}', function (data){
                $('<input>').attr('type', 'hidden').attr('name', 'ngState').attr('value', data).appendTo('#mainForm');
                $('<input>').attr('type', 'hidden').attr('name', 'button').attr('value', 'stop').appendTo('#mainForm');
                $('#mainForm').submit()
            });
        })

        $('#btnTimeoutClose').click(function() {
            //window.location.reload()
        })

        $('#btnStop').click(function() {
            getCurrentNeuroglancerState('{{ng_url}}', function (data){
                $('<input>').attr('type', 'hidden').attr('name', 'ngState').attr('value', data).appendTo('#mainForm');
                $('<input>').attr('type', 'hidden').attr('name', 'button').attr('value', 'stop').appendTo('#mainForm');
                $('#mainForm').submit()
            });
        })

        $('#btnStart').click(function() {
            $('<input>').attr('type', 'hidden').attr('name', 'button').attr('value', 'start').appendTo('#mainForm');
            $('#mainForm').submit();
        })



        //Netflix are you still there script v
        var idleTime = 0;
        // Increment the idle time counter every minute.
        var idleInterval = setInterval(timerIncrement, 60000); // 1 minute

        // Zero the idle timer on mouse movement.
        $(this).mousemove(function (e) {
            idleTime = 0;
        });
        $(this).keypress(function (e) {
            idleTime = 0;
        });
        //Netflix are you still there script ^

        //Netflix are you still there script 
        function timerIncrement() {
            idleTime++;
            if (idleTime >= 1) { 
                console.log("in modal");
                $('#timeoutModal').modal('show');
                isModalOpen('true', (1 * 60)); //second parameter should be in seconds
            }
        }



    })



    window.addEventListener('beforeunload', function (e) {
        //automatically saves
        getCurrentNeuroglancerState('{{ng_url}}');
        e.preventDefault(); 
        e.returnValue = '';
    });



</script>
{% endblock %}