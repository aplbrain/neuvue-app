{% extends "base.html" %}
{% load static %}


{% block content %}
<div class="basic pref">
<div class="pref_main_container">
    <form id="configForm" action="" method="post" >
    {% csrf_token %}
    <div class="navbar-text" style='font-size:1vw;'> <h2> Neuroglancer Preferences </h2>
        Neuroglancer preferences will overwrite all task states to the specified configuration. Only settings that are enabled 
        (checked) are actually used. 
        <hr class="row-divider">
        <div class="form-check form-switch">
            <label class="form-check-label" for="configSwitch"> Enable/Disable Preferences </label>
            <input class="form-check-input" type="checkbox" id="configSwitch">
        </div>
    </div>
    <div id="neuroglancerConfig">
        <!--
        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="annotationColorSwitch"> </div>
            <div>Annotation Color</div>
            <input id="annotationColor" class="form-control form-control-color" type="color" value={{annotationColor}}>
        </div>-->
        
        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="annotationColorPaletteSwitch"> </div>
            <div> Annotation Color Palette </div>
            <select name='colorSelect' id="annotationColorPalette" class="form-select" style="width:200px;">
                <option value="palette1">Rainbow</option>
                <option value="palette2">Reds</option>
                <option value="palette3">Oranges</option>
                <option value="palette4">Greens</option>
                <option value="palette5">Blues</option>
                <option value="palette6">Purples</option>
            </select> 
        </div>


        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="alphaSelectedSwitch"> </div>
            <div> 2D Segmentation Data Opacity </div>
            <input id="alphaSelected" type="range" class="form-range" min="0" 
                max="1" step="0.01" value="{{ alphaSelected }}" />
            
            <div id="alphaSelectedDisplay" class="form-label">"{{ alphaSelected }}"</div>
        </div>

        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="alpha3DSwitch"> </div>
            <div> 3D Segmentation Data Opacity </div>
            
            <input id="alpha3D" type="range" class="form-range" min="0" 
                max="1" step="0.01" value="{{alpha3D}}" />

            <div id="alpha3DDisplay" class="form-label">"{{alpha3D}}"</div>
        </div>

        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="layoutSwitch"> </div>
            <div> Panel Layout </div>
            <select name="layout" class="form-select" id="layoutSelect" >
                <option>xy-3d</option>
                <option>yz-3d</option>
                <option>xz-3d</option>
                <option>4panel</option>
                <option>3d</option>
            </select> 
        </div>
        
        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="gpuLimitSwitch"> </div>
            <div> GPU Memory Limit (GB) </div>
            
            <input id="gpuLimit" type="range" class="form-range" min="0.5" 
                max="4.0" step="0.1" value="{{gpuLimit}}" />

            <div id="gpuLimitDisplay" class="form-label">"{{gpuLimit}}"</div>
        </div>

        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="sysLimitSwitch"> </div>
            <div> System Memory Limit (GB) </div>
            
            <input id="sysLimit" type="range" class="form-range" min="0.5" 
                max="4.0" step="0.1" value="{{sysLimit}}" />

            <div id="sysLimitDisplay" class="form-label">"{{sysLimit}}"</div>
        </div>

        <hr class="row-divider">
        <div class="row-container">
            <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="chunkReqSwitch"> </div>
            <div> Concurrent Chunk Requests </div>
            
            <input id="chunkReq" type="range" class="form-range" min="8" 
                max="64" step="1" value="{{chunkReq}}" />

            <div id="chunkReqDisplay" class="form-label">"{{chunkReq}}"</div>
        </div>

        <hr class="row-divider">
    </div>
    <div style="flex-direction:column;">
        <button id="saveConfig" type="button" class="btn btn-primary" style="width:10vw;">Save</button>
        <button id="resetConfig" type="button" class="btn btn-secondary" style="width:10vw;">Reset To Default</button>
    </div>
    </form>
</br>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script>
    const preferenceFields = {
        "annotationColor": "{{annotationColorSwitch}}", 
        "annotationColorPalette": "{{annotationColorPaletteSwitch}}",
        "alphaSelected": "{{alphaSelectedSwitch}}", 
        "alpha3D": "{{alpha3DSwitch}}", 
        "gpuLimit": "{{gpuLimitSwitch}}", 
        "sysLimit": "{{sysLimitSwitch}}", 
        "chunkReq": "{{chunkReqSwitch}}",
        "layout": "{{layoutSwitch}}"
    };
    function submitConfig() {
        let form = '#configForm'
        let enabled = $('#configSwitch').is(":checked");
        $('<input>').attr('type', 'hidden').attr('name', 'enabled').attr('value', enabled).appendTo(form);

        for (field in preferenceFields){          
            let fieldSwitch = $(`#${field}Switch`).is(":checked");
            let fieldValue = $(`#${field}`).val();
            if ((field != "layout") && (field != "colorSelect")) {
                $('<input>').attr('type', 'hidden').attr('name', field).attr('value', fieldValue).appendTo(form);
            }
            $('<input>').attr('type', 'hidden').attr('name', `${field}Switch`).attr('value', fieldSwitch).appendTo(form);
        }
        $(form).submit();
    }
    $(document).ready(function() {
        $("#configSwitch").change(function() {
            if ($("#configSwitch").is(':checked')) {

                $("#neuroglancerConfig").show(100);
            } else {
                $("#neuroglancerConfig").hide(100);
            }
        });
        
        if ("{{enabled}}" == "True") {
            $("#neuroglancerConfig").show();
            $("#configSwitch").prop( "checked", true );
        } else {
            $("#neuroglancerConfig").hide();
            $("#configSwitch").prop( "checked", false );
        }

        // Update switches 
        for (field in preferenceFields){
            if (preferenceFields[field] == "True") {
                $(`#${field}Switch`).prop( "checked", true );
            } else {
                $(`#${field}Switch`).prop( "checked", false );
            }
        }

        // Display value on sliders
        $("#alphaSelectedDisplay").html($("#alphaSelected").val() );
        $("#alpha3DDisplay").html($("#alpha3D").val() );
        $("#gpuLimitDisplay").html($("#gpuLimit").val() );
        $("#sysLimitDisplay").html($("#sysLimit").val() );
        $("#chunkReqDisplay").html($("#chunkReq").val() );

        // Update value on sliders
        $("#alphaSelected").change(function( ){
            $("#alphaSelectedDisplay").html($("#alphaSelected").val());
        });
        
        $("#alpha3D").change(function( ){
            $("#alpha3DDisplay").html($("#alpha3D").val());
        });

        $("#gpuLimit").change(function( ){
            $("#gpuLimitDisplay").html($("#gpuLimit").val());
        });

        $("#sysLimit").change(function( ){
            $("#sysLimitDisplay").html($("#sysLimit").val());
        });

        $("#chunkReq").change(function( ){
            $("#chunkReqDisplay").html($("#chunkReq").val());
        });

        // Select correct layout 
        $('#layoutSelect option:contains("{{layout}}")').prop('selected', true)

        // Select correct color palette option
        $('#annotationColorPalette option[value*="{{annotationColorPalette}}"]').prop('selected', true)

        console.log("{{annotationColorPalette}}");
        
        // Submit Button
        $('#saveConfig').click(function() {
            submitConfig();
        })

    });

</script>
{% endblock %}